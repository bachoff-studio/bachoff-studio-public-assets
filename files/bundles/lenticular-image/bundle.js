import*as e from"react";import t,{useReducer as n,useRef as r,useDebugValue as i,useEffect as s,useLayoutEffect as a,useState as o,useMemo as l}from"react";import{jsx as u}from"react/jsx-runtime";function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},c.apply(null,arguments)}function d(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}const h="172",f={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},p={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},m=0,g=1,v=2,y=100,b=101,_=102,x=200,S=201,T=202,E=203,A=204,w=205,M=206,R=207,C=208,I=209,L=210,P=211,N=212,D=213,k=214,O=0,F=1,U=2,B=3,V=4,z=5,G=6,H=7,$="attached",W="detached",j=300,q=301,X=302,Y=303,K=304,Q=306,Z=1e3,J=1001,ee=1002,te=1003,ne=1004,re=1005,ie=1006,se=1007,ae=1008,oe=1009,le=1010,ue=1011,ce=1012,de=1013,he=1014,fe=1015,pe=1016,me=1017,ge=1018,ve=1020,ye=35902,be=1021,_e=1022,xe=1023,Se=1024,Te=1025,Ee=1026,Ae=1027,we=1028,Me=1029,Re=1030,Ce=1031,Ie=1033,Le=33776,Pe=33777,Ne=33778,De=33779,ke=35840,Oe=35841,Fe=35842,Ue=35843,Be=36196,Ve=37492,ze=37496,Ge=37808,He=37809,$e=37810,We=37811,je=37812,qe=37813,Xe=37814,Ye=37815,Ke=37816,Qe=37817,Ze=37818,Je=37819,et=37820,tt=37821,nt=36492,rt=36494,it=36495,st=36283,at=36284,ot=36285,lt=36286,ut=2300,ct=2301,dt=2302,ht=2400,ft=2401,pt=2402,mt=2500,gt=2501,vt="",yt="srgb",bt="srgb-linear",_t="linear",xt="srgb",St=7680,Tt=519,Et=512,At=513,wt=514,Mt=515,Rt=516,Ct=517,It=518,Lt=519,Pt=35044,Nt=35048,Dt="300 es",kt=2e3,Ot=2001;class Ft{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;const n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const n=this._listeners[e];if(void 0!==n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const n=t.slice(0);for(let t=0,r=n.length;t<r;t++)n[t].call(this,e);e.target=null}}}const Ut=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let Bt=1234567;const Vt=Math.PI/180,zt=180/Math.PI;function Gt(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return(Ut[255&e]+Ut[e>>8&255]+Ut[e>>16&255]+Ut[e>>24&255]+"-"+Ut[255&t]+Ut[t>>8&255]+"-"+Ut[t>>16&15|64]+Ut[t>>24&255]+"-"+Ut[63&n|128]+Ut[n>>8&255]+"-"+Ut[n>>16&255]+Ut[n>>24&255]+Ut[255&r]+Ut[r>>8&255]+Ut[r>>16&255]+Ut[r>>24&255]).toLowerCase()}function Ht(e,t,n){return Math.max(t,Math.min(n,e))}function $t(e,t){return(e%t+t)%t}function Wt(e,t,n){return(1-n)*e+n*t}function jt(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function qt(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const Xt={DEG2RAD:Vt,RAD2DEG:zt,generateUUID:Gt,clamp:Ht,euclideanModulo:$t,mapLinear:function(e,t,n,r,i){return r+(e-t)*(i-r)/(n-t)},inverseLerp:function(e,t,n){return e!==t?(n-e)/(t-e):0},lerp:Wt,damp:function(e,t,n,r){return Wt(e,t,1-Math.exp(-n*r))},pingpong:function(e,t=1){return t-Math.abs($t(e,2*t)-t)},smoothstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*(3-2*e)},smootherstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(Bt=e);let t=Bt+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296},degToRad:function(e){return e*Vt},radToDeg:function(e){return e*zt},isPowerOfTwo:function(e){return!(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,n,r,i){const s=Math.cos,a=Math.sin,o=s(n/2),l=a(n/2),u=s((t+r)/2),c=a((t+r)/2),d=s((t-r)/2),h=a((t-r)/2),f=s((r-t)/2),p=a((r-t)/2);switch(i){case"XYX":e.set(o*c,l*d,l*h,o*u);break;case"YZY":e.set(l*h,o*c,l*d,o*u);break;case"ZXZ":e.set(l*d,l*h,o*c,o*u);break;case"XZX":e.set(o*c,l*p,l*f,o*u);break;case"YXY":e.set(l*f,o*c,l*p,o*u);break;case"ZYZ":e.set(l*p,l*f,o*c,o*u)}},normalize:qt,denormalize:jt};class Yt{constructor(e=0,t=0){Yt.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,n=this.y,r=e.elements;return this.x=r[0]*t+r[3]*n+r[6],this.y=r[1]*t+r[4]*n+r[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Ht(this.x,e.x,t.x),this.y=Ht(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=Ht(this.x,e,t),this.y=Ht(this.y,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Ht(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Ht(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const n=Math.cos(t),r=Math.sin(t),i=this.x-e.x,s=this.y-e.y;return this.x=i*n-s*r+e.x,this.y=i*r+s*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Kt{constructor(e,t,n,r,i,s,a,o,l){Kt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,n,r,i,s,a,o,l)}set(e,t,n,r,i,s,a,o,l){const u=this.elements;return u[0]=e,u[1]=r,u[2]=a,u[3]=t,u[4]=i,u[5]=o,u[6]=n,u[7]=s,u[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this}extractBasis(e,t,n){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,r=t.elements,i=this.elements,s=n[0],a=n[3],o=n[6],l=n[1],u=n[4],c=n[7],d=n[2],h=n[5],f=n[8],p=r[0],m=r[3],g=r[6],v=r[1],y=r[4],b=r[7],_=r[2],x=r[5],S=r[8];return i[0]=s*p+a*v+o*_,i[3]=s*m+a*y+o*x,i[6]=s*g+a*b+o*S,i[1]=l*p+u*v+c*_,i[4]=l*m+u*y+c*x,i[7]=l*g+u*b+c*S,i[2]=d*p+h*v+f*_,i[5]=d*m+h*y+f*x,i[8]=d*g+h*b+f*S,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],a=e[5],o=e[6],l=e[7],u=e[8];return t*s*u-t*a*l-n*i*u+n*a*o+r*i*l-r*s*o}invert(){const e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],a=e[5],o=e[6],l=e[7],u=e[8],c=u*s-a*l,d=a*o-u*i,h=l*i-s*o,f=t*c+n*d+r*h;if(0===f)return this.set(0,0,0,0,0,0,0,0,0);const p=1/f;return e[0]=c*p,e[1]=(r*l-u*n)*p,e[2]=(a*n-r*s)*p,e[3]=d*p,e[4]=(u*t-r*o)*p,e[5]=(r*i-a*t)*p,e[6]=h*p,e[7]=(n*o-l*t)*p,e[8]=(s*t-n*i)*p,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,n,r,i,s,a){const o=Math.cos(i),l=Math.sin(i);return this.set(n*o,n*l,-n*(o*s+l*a)+s+e,-r*l,r*o,-r*(-l*s+o*a)+a+t,0,0,1),this}scale(e,t){return this.premultiply(Qt.makeScale(e,t)),this}rotate(e){return this.premultiply(Qt.makeRotation(-e)),this}translate(e,t){return this.premultiply(Qt.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,n,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,n=e.elements;for(let e=0;e<9;e++)if(t[e]!==n[e])return!1;return!0}fromArray(e,t=0){for(let n=0;n<9;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const Qt=new Kt;function Zt(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}const Jt={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function en(e,t){return new Jt[e](t)}function tn(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function nn(){const e=tn("canvas");return e.style.display="block",e}const rn={};function sn(e){e in rn||(rn[e]=!0)}const an=(new Kt).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),on=(new Kt).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function ln(){const e={enabled:!0,workingColorSpace:bt,spaces:{},convert:function(e,t,n){return!1!==this.enabled&&t!==n&&t&&n?(this.spaces[t].transfer===xt&&(e.r=cn(e.r),e.g=cn(e.g),e.b=cn(e.b)),this.spaces[t].primaries!==this.spaces[n].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[n].fromXYZ)),this.spaces[n].transfer===xt&&(e.r=dn(e.r),e.g=dn(e.g),e.b=dn(e.b)),e):e},fromWorkingColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},toWorkingColorSpace:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===vt?_t:this.spaces[e].transfer},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,n){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[n].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace}},t=[.64,.33,.3,.6,.15,.06],n=[.2126,.7152,.0722],r=[.3127,.329];return e.define({[bt]:{primaries:t,whitePoint:r,transfer:_t,toXYZ:an,fromXYZ:on,luminanceCoefficients:n,workingColorSpaceConfig:{unpackColorSpace:yt},outputColorSpaceConfig:{drawingBufferColorSpace:yt}},[yt]:{primaries:t,whitePoint:r,transfer:xt,toXYZ:an,fromXYZ:on,luminanceCoefficients:n,outputColorSpaceConfig:{drawingBufferColorSpace:yt}}}),e}const un=ln();function cn(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function dn(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let hn;class fn{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===hn&&(hn=tn("canvas")),hn.width=e.width,hn.height=e.height;const n=hn.getContext("2d");e instanceof ImageData?n.putImageData(e,0,0):n.drawImage(e,0,0,e.width,e.height),t=hn}return t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=tn("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height);const r=n.getImageData(0,0,e.width,e.height),i=r.data;for(let e=0;e<i.length;e++)i[e]=255*cn(i[e]/255);return n.putImageData(r,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*cn(t[e]/255)):t[e]=cn(t[e]);return{data:t,width:e.width,height:e.height}}return e}}let pn=0;class mn{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:pn++}),this.uuid=Gt(),this.data=e,this.dataReady=!0,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const n={uuid:this.uuid,url:""},r=this.data;if(null!==r){let e;if(Array.isArray(r)){e=[];for(let t=0,n=r.length;t<n;t++)r[t].isDataTexture?e.push(gn(r[t].image)):e.push(gn(r[t]))}else e=gn(r);n.url=e}return t||(e.images[this.uuid]=n),n}}function gn(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?fn.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:{}}let vn=0;class yn extends Ft{constructor(e=yn.DEFAULT_IMAGE,t=yn.DEFAULT_MAPPING,n=1001,r=1001,i=1006,s=1008,a=1023,o=1009,l=yn.DEFAULT_ANISOTROPY,u=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:vn++}),this.uuid=Gt(),this.name="",this.source=new mn(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=n,this.wrapT=r,this.magFilter=i,this.minFilter=s,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=o,this.offset=new Yt(0,0),this.repeat=new Yt(1,1),this.center=new Yt(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Kt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=u,this.userData={},this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const n={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==j)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case Z:e.x=e.x-Math.floor(e.x);break;case J:e.x=e.x<0?0:1;break;case ee:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case Z:e.y=e.y-Math.floor(e.y);break;case J:e.y=e.y<0?0:1;break;case ee:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}yn.DEFAULT_IMAGE=null,yn.DEFAULT_MAPPING=j,yn.DEFAULT_ANISOTROPY=1;class bn{constructor(e=0,t=0,n=0,r=1){bn.prototype.isVector4=!0,this.x=e,this.y=t,this.z=n,this.w=r}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,n=this.y,r=this.z,i=this.w,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*r+s[12]*i,this.y=s[1]*t+s[5]*n+s[9]*r+s[13]*i,this.z=s[2]*t+s[6]*n+s[10]*r+s[14]*i,this.w=s[3]*t+s[7]*n+s[11]*r+s[15]*i,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,n,r,i;const s=.01,a=.1,o=e.elements,l=o[0],u=o[4],c=o[8],d=o[1],h=o[5],f=o[9],p=o[2],m=o[6],g=o[10];if(Math.abs(u-d)<s&&Math.abs(c-p)<s&&Math.abs(f-m)<s){if(Math.abs(u+d)<a&&Math.abs(c+p)<a&&Math.abs(f+m)<a&&Math.abs(l+h+g-3)<a)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(h+1)/2,v=(g+1)/2,y=(u+d)/4,b=(c+p)/4,_=(f+m)/4;return e>o&&e>v?e<s?(n=0,r=.707106781,i=.707106781):(n=Math.sqrt(e),r=y/n,i=b/n):o>v?o<s?(n=.707106781,r=0,i=.707106781):(r=Math.sqrt(o),n=y/r,i=_/r):v<s?(n=.707106781,r=.707106781,i=0):(i=Math.sqrt(v),n=b/i,r=_/i),this.set(n,r,i,t),this}let v=Math.sqrt((m-f)*(m-f)+(c-p)*(c-p)+(d-u)*(d-u));return Math.abs(v)<.001&&(v=1),this.x=(m-f)/v,this.y=(c-p)/v,this.z=(d-u)/v,this.w=Math.acos((l+h+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Ht(this.x,e.x,t.x),this.y=Ht(this.y,e.y,t.y),this.z=Ht(this.z,e.z,t.z),this.w=Ht(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=Ht(this.x,e,t),this.y=Ht(this.y,e,t),this.z=Ht(this.z,e,t),this.w=Ht(this.w,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Ht(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this.w=e.w+(t.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class _n extends Ft{constructor(e=1,t=1,n={}){super(),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=1,this.scissor=new bn(0,0,e,t),this.scissorTest=!1,this.viewport=new bn(0,0,e,t);const r={width:e,height:t,depth:1};n=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:ie,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1},n);const i=new yn(r,n.mapping,n.wrapS,n.wrapT,n.magFilter,n.minFilter,n.format,n.type,n.anisotropy,n.colorSpace);i.flipY=!1,i.generateMipmaps=n.generateMipmaps,i.internalFormat=n.internalFormat,this.textures=[];const s=n.count;for(let e=0;e<s;e++)this.textures[e]=i.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this.depthBuffer=n.depthBuffer,this.stencilBuffer=n.stencilBuffer,this.resolveDepthBuffer=n.resolveDepthBuffer,this.resolveStencilBuffer=n.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=n.depthTexture,this.samples=n.samples}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,n=1){if(this.width!==e||this.height!==t||this.depth!==n){this.width=e,this.height=t,this.depth=n;for(let r=0,i=this.textures.length;r<i;r++)this.textures[r].image.width=e,this.textures[r].image.height=t,this.textures[r].image.depth=n;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,n=e.textures.length;t<n;t++)this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const t=Object.assign({},e.texture.image);return this.texture.source=new mn(t),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class xn extends _n{constructor(e=1,t=1,n={}){super(e,t,n),this.isWebGLRenderTarget=!0}}class Sn extends yn{constructor(e=null,t=1,n=1,r=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:n,depth:r},this.magFilter=te,this.minFilter=te,this.wrapR=J,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class Tn extends yn{constructor(e=null,t=1,n=1,r=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:n,depth:r},this.magFilter=te,this.minFilter=te,this.wrapR=J,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class En{constructor(e=0,t=0,n=0,r=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=n,this._w=r}static slerpFlat(e,t,n,r,i,s,a){let o=n[r+0],l=n[r+1],u=n[r+2],c=n[r+3];const d=i[s+0],h=i[s+1],f=i[s+2],p=i[s+3];if(0===a)return e[t+0]=o,e[t+1]=l,e[t+2]=u,void(e[t+3]=c);if(1===a)return e[t+0]=d,e[t+1]=h,e[t+2]=f,void(e[t+3]=p);if(c!==p||o!==d||l!==h||u!==f){let e=1-a;const t=o*d+l*h+u*f+c*p,n=t>=0?1:-1,r=1-t*t;if(r>Number.EPSILON){const i=Math.sqrt(r),s=Math.atan2(i,t*n);e=Math.sin(e*s)/i,a=Math.sin(a*s)/i}const i=a*n;if(o=o*e+d*i,l=l*e+h*i,u=u*e+f*i,c=c*e+p*i,e===1-a){const e=1/Math.sqrt(o*o+l*l+u*u+c*c);o*=e,l*=e,u*=e,c*=e}}e[t]=o,e[t+1]=l,e[t+2]=u,e[t+3]=c}static multiplyQuaternionsFlat(e,t,n,r,i,s){const a=n[r],o=n[r+1],l=n[r+2],u=n[r+3],c=i[s],d=i[s+1],h=i[s+2],f=i[s+3];return e[t]=a*f+u*c+o*h-l*d,e[t+1]=o*f+u*d+l*c-a*h,e[t+2]=l*f+u*h+a*d-o*c,e[t+3]=u*f-a*c-o*d-l*h,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,n,r){return this._x=e,this._y=t,this._z=n,this._w=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const n=e._x,r=e._y,i=e._z,s=e._order,a=Math.cos,o=Math.sin,l=a(n/2),u=a(r/2),c=a(i/2),d=o(n/2),h=o(r/2),f=o(i/2);switch(s){case"XYZ":this._x=d*u*c+l*h*f,this._y=l*h*c-d*u*f,this._z=l*u*f+d*h*c,this._w=l*u*c-d*h*f;break;case"YXZ":this._x=d*u*c+l*h*f,this._y=l*h*c-d*u*f,this._z=l*u*f-d*h*c,this._w=l*u*c+d*h*f;break;case"ZXY":this._x=d*u*c-l*h*f,this._y=l*h*c+d*u*f,this._z=l*u*f+d*h*c,this._w=l*u*c-d*h*f;break;case"ZYX":this._x=d*u*c-l*h*f,this._y=l*h*c+d*u*f,this._z=l*u*f-d*h*c,this._w=l*u*c+d*h*f;break;case"YZX":this._x=d*u*c+l*h*f,this._y=l*h*c+d*u*f,this._z=l*u*f-d*h*c,this._w=l*u*c-d*h*f;break;case"XZY":this._x=d*u*c-l*h*f,this._y=l*h*c-d*u*f,this._z=l*u*f+d*h*c,this._w=l*u*c+d*h*f}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const n=t/2,r=Math.sin(n);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,n=t[0],r=t[4],i=t[8],s=t[1],a=t[5],o=t[9],l=t[2],u=t[6],c=t[10],d=n+a+c;if(d>0){const e=.5/Math.sqrt(d+1);this._w=.25/e,this._x=(u-o)*e,this._y=(i-l)*e,this._z=(s-r)*e}else if(n>a&&n>c){const e=2*Math.sqrt(1+n-a-c);this._w=(u-o)/e,this._x=.25*e,this._y=(r+s)/e,this._z=(i+l)/e}else if(a>c){const e=2*Math.sqrt(1+a-n-c);this._w=(i-l)/e,this._x=(r+s)/e,this._y=.25*e,this._z=(o+u)/e}else{const e=2*Math.sqrt(1+c-n-a);this._w=(s-r)/e,this._x=(i+l)/e,this._y=(o+u)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let n=e.dot(t)+1;return n<Number.EPSILON?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Ht(this.dot(e),-1,1)))}rotateTowards(e,t){const n=this.angleTo(e);if(0===n)return this;const r=Math.min(1,t/n);return this.slerp(e,r),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const n=e._x,r=e._y,i=e._z,s=e._w,a=t._x,o=t._y,l=t._z,u=t._w;return this._x=n*u+s*a+r*l-i*o,this._y=r*u+s*o+i*a-n*l,this._z=i*u+s*l+n*o-r*a,this._w=s*u-n*a-r*o-i*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const n=this._x,r=this._y,i=this._z,s=this._w;let a=s*e._w+n*e._x+r*e._y+i*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=s,this._x=n,this._y=r,this._z=i,this;const o=1-a*a;if(o<=Number.EPSILON){const e=1-t;return this._w=e*s+t*this._w,this._x=e*n+t*this._x,this._y=e*r+t*this._y,this._z=e*i+t*this._z,this.normalize(),this}const l=Math.sqrt(o),u=Math.atan2(l,a),c=Math.sin((1-t)*u)/l,d=Math.sin(t*u)/l;return this._w=s*c+this._w*d,this._x=n*c+this._x*d,this._y=r*c+this._y*d,this._z=i*c+this._z*d,this._onChangeCallback(),this}slerpQuaternions(e,t,n){return this.copy(e).slerp(t,n)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),n=Math.random(),r=Math.sqrt(1-n),i=Math.sqrt(n);return this.set(r*Math.sin(e),r*Math.cos(e),i*Math.sin(t),i*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class An{constructor(e=0,t=0,n=0){An.prototype.isVector3=!0,this.x=e,this.y=t,this.z=n}set(e,t,n){return void 0===n&&(n=this.z),this.x=e,this.y=t,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(Mn.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Mn.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6]*r,this.y=i[1]*t+i[4]*n+i[7]*r,this.z=i[2]*t+i[5]*n+i[8]*r,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,n=this.y,r=this.z,i=e.elements,s=1/(i[3]*t+i[7]*n+i[11]*r+i[15]);return this.x=(i[0]*t+i[4]*n+i[8]*r+i[12])*s,this.y=(i[1]*t+i[5]*n+i[9]*r+i[13])*s,this.z=(i[2]*t+i[6]*n+i[10]*r+i[14])*s,this}applyQuaternion(e){const t=this.x,n=this.y,r=this.z,i=e.x,s=e.y,a=e.z,o=e.w,l=2*(s*r-a*n),u=2*(a*t-i*r),c=2*(i*n-s*t);return this.x=t+o*l+s*c-a*u,this.y=n+o*u+a*l-i*c,this.z=r+o*c+i*u-s*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[4]*n+i[8]*r,this.y=i[1]*t+i[5]*n+i[9]*r,this.z=i[2]*t+i[6]*n+i[10]*r,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Ht(this.x,e.x,t.x),this.y=Ht(this.y,e.y,t.y),this.z=Ht(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=Ht(this.x,e,t),this.y=Ht(this.y,e,t),this.z=Ht(this.z,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Ht(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,r=e.y,i=e.z,s=t.x,a=t.y,o=t.z;return this.x=r*o-i*a,this.y=i*s-n*o,this.z=n*a-r*s,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const n=e.dot(this)/t;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return wn.copy(this).projectOnVector(e),this.sub(wn)}reflect(e){return this.sub(wn.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Ht(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,r=this.z-e.z;return t*t+n*n+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,n){const r=Math.sin(t)*e;return this.x=r*Math.sin(n),this.y=Math.cos(t)*e,this.z=r*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,n){return this.x=e*Math.sin(t),this.y=n,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),r=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=r,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,n=Math.sqrt(1-t*t);return this.x=n*Math.cos(e),this.y=t,this.z=n*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const wn=new An,Mn=new En;class Rn{constructor(e=new An(1/0,1/0,1/0),t=new An(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t+=3)this.expandByPoint(In.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,n=e.count;t<n;t++)this.expandByPoint(In.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=In.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const n=e.geometry;if(void 0!==n){const r=n.getAttribute("position");if(!0===t&&void 0!==r&&!0!==e.isInstancedMesh)for(let t=0,n=r.count;t<n;t++)!0===e.isMesh?e.getVertexPosition(t,In):In.fromBufferAttribute(r,t),In.applyMatrix4(e.matrixWorld),this.expandByPoint(In);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),Ln.copy(e.boundingBox)):(null===n.boundingBox&&n.computeBoundingBox(),Ln.copy(n.boundingBox)),Ln.applyMatrix4(e.matrixWorld),this.union(Ln)}const r=e.children;for(let e=0,n=r.length;e<n;e++)this.expandByObject(r[e],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,In),In.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Un),Bn.subVectors(this.max,Un),Pn.subVectors(e.a,Un),Nn.subVectors(e.b,Un),Dn.subVectors(e.c,Un),kn.subVectors(Nn,Pn),On.subVectors(Dn,Nn),Fn.subVectors(Pn,Dn);let t=[0,-kn.z,kn.y,0,-On.z,On.y,0,-Fn.z,Fn.y,kn.z,0,-kn.x,On.z,0,-On.x,Fn.z,0,-Fn.x,-kn.y,kn.x,0,-On.y,On.x,0,-Fn.y,Fn.x,0];return!!Gn(t,Pn,Nn,Dn,Bn)&&(t=[1,0,0,0,1,0,0,0,1],!!Gn(t,Pn,Nn,Dn,Bn)&&(Vn.crossVectors(kn,On),t=[Vn.x,Vn.y,Vn.z],Gn(t,Pn,Nn,Dn,Bn)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,In).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(In).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Cn[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Cn[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Cn[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Cn[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Cn[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Cn[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Cn[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Cn[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Cn)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const Cn=[new An,new An,new An,new An,new An,new An,new An,new An],In=new An,Ln=new Rn,Pn=new An,Nn=new An,Dn=new An,kn=new An,On=new An,Fn=new An,Un=new An,Bn=new An,Vn=new An,zn=new An;function Gn(e,t,n,r,i){for(let s=0,a=e.length-3;s<=a;s+=3){zn.fromArray(e,s);const a=i.x*Math.abs(zn.x)+i.y*Math.abs(zn.y)+i.z*Math.abs(zn.z),o=t.dot(zn),l=n.dot(zn),u=r.dot(zn);if(Math.max(-Math.max(o,l,u),Math.min(o,l,u))>a)return!1}return!0}const Hn=new Rn,$n=new An,Wn=new An;class jn{constructor(e=new An,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const n=this.center;void 0!==t?n.copy(t):Hn.setFromPoints(e).getCenter(n);let r=0;for(let t=0,i=e.length;t<i;t++)r=Math.max(r,n.distanceToSquared(e[t]));return this.radius=Math.sqrt(r),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const n=this.center.distanceToSquared(e);return t.copy(e),n>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;$n.subVectors(e,this.center);const t=$n.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),n=.5*(e-this.radius);this.center.addScaledVector($n,n/e),this.radius+=n}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(Wn.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint($n.copy(e.center).add(Wn)),this.expandByPoint($n.copy(e.center).sub(Wn))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const qn=new An,Xn=new An,Yn=new An,Kn=new An,Qn=new An,Zn=new An,Jn=new An;class er{constructor(e=new An,t=new An(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,qn)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const n=t.dot(this.direction);return n<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,n)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=qn.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(qn.copy(this.origin).addScaledVector(this.direction,t),qn.distanceToSquared(e))}distanceSqToSegment(e,t,n,r){Xn.copy(e).add(t).multiplyScalar(.5),Yn.copy(t).sub(e).normalize(),Kn.copy(this.origin).sub(Xn);const i=.5*e.distanceTo(t),s=-this.direction.dot(Yn),a=Kn.dot(this.direction),o=-Kn.dot(Yn),l=Kn.lengthSq(),u=Math.abs(1-s*s);let c,d,h,f;if(u>0)if(c=s*o-a,d=s*a-o,f=i*u,c>=0)if(d>=-f)if(d<=f){const e=1/u;c*=e,d*=e,h=c*(c+s*d+2*a)+d*(s*c+d+2*o)+l}else d=i,c=Math.max(0,-(s*d+a)),h=-c*c+d*(d+2*o)+l;else d=-i,c=Math.max(0,-(s*d+a)),h=-c*c+d*(d+2*o)+l;else d<=-f?(c=Math.max(0,-(-s*i+a)),d=c>0?-i:Math.min(Math.max(-i,-o),i),h=-c*c+d*(d+2*o)+l):d<=f?(c=0,d=Math.min(Math.max(-i,-o),i),h=d*(d+2*o)+l):(c=Math.max(0,-(s*i+a)),d=c>0?i:Math.min(Math.max(-i,-o),i),h=-c*c+d*(d+2*o)+l);else d=s>0?-i:i,c=Math.max(0,-(s*d+a)),h=-c*c+d*(d+2*o)+l;return n&&n.copy(this.origin).addScaledVector(this.direction,c),r&&r.copy(Xn).addScaledVector(Yn,d),h}intersectSphere(e,t){qn.subVectors(e.center,this.origin);const n=qn.dot(this.direction),r=qn.dot(qn)-n*n,i=e.radius*e.radius;if(r>i)return null;const s=Math.sqrt(i-r),a=n-s,o=n+s;return o<0?null:a<0?this.at(o,t):this.at(a,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null}intersectPlane(e,t){const n=this.distanceToPlane(e);return null===n?null:this.at(n,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let n,r,i,s,a,o;const l=1/this.direction.x,u=1/this.direction.y,c=1/this.direction.z,d=this.origin;return l>=0?(n=(e.min.x-d.x)*l,r=(e.max.x-d.x)*l):(n=(e.max.x-d.x)*l,r=(e.min.x-d.x)*l),u>=0?(i=(e.min.y-d.y)*u,s=(e.max.y-d.y)*u):(i=(e.max.y-d.y)*u,s=(e.min.y-d.y)*u),n>s||i>r?null:((i>n||isNaN(n))&&(n=i),(s<r||isNaN(r))&&(r=s),c>=0?(a=(e.min.z-d.z)*c,o=(e.max.z-d.z)*c):(a=(e.max.z-d.z)*c,o=(e.min.z-d.z)*c),n>o||a>r?null:((a>n||n!=n)&&(n=a),(o<r||r!=r)&&(r=o),r<0?null:this.at(n>=0?n:r,t)))}intersectsBox(e){return null!==this.intersectBox(e,qn)}intersectTriangle(e,t,n,r,i){Qn.subVectors(t,e),Zn.subVectors(n,e),Jn.crossVectors(Qn,Zn);let s,a=this.direction.dot(Jn);if(a>0){if(r)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}Kn.subVectors(this.origin,e);const o=s*this.direction.dot(Zn.crossVectors(Kn,Zn));if(o<0)return null;const l=s*this.direction.dot(Qn.cross(Kn));if(l<0)return null;if(o+l>a)return null;const u=-s*Kn.dot(Jn);return u<0?null:this.at(u/a,i)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class tr{constructor(e,t,n,r,i,s,a,o,l,u,c,d,h,f,p,m){tr.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,n,r,i,s,a,o,l,u,c,d,h,f,p,m)}set(e,t,n,r,i,s,a,o,l,u,c,d,h,f,p,m){const g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=r,g[1]=i,g[5]=s,g[9]=a,g[13]=o,g[2]=l,g[6]=u,g[10]=c,g[14]=d,g[3]=h,g[7]=f,g[11]=p,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new tr).fromArray(this.elements)}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this}copyPosition(e){const t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,n=e.elements,r=1/nr.setFromMatrixColumn(e,0).length(),i=1/nr.setFromMatrixColumn(e,1).length(),s=1/nr.setFromMatrixColumn(e,2).length();return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=0,t[4]=n[4]*i,t[5]=n[5]*i,t[6]=n[6]*i,t[7]=0,t[8]=n[8]*s,t[9]=n[9]*s,t[10]=n[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,n=e.x,r=e.y,i=e.z,s=Math.cos(n),a=Math.sin(n),o=Math.cos(r),l=Math.sin(r),u=Math.cos(i),c=Math.sin(i);if("XYZ"===e.order){const e=s*u,n=s*c,r=a*u,i=a*c;t[0]=o*u,t[4]=-o*c,t[8]=l,t[1]=n+r*l,t[5]=e-i*l,t[9]=-a*o,t[2]=i-e*l,t[6]=r+n*l,t[10]=s*o}else if("YXZ"===e.order){const e=o*u,n=o*c,r=l*u,i=l*c;t[0]=e+i*a,t[4]=r*a-n,t[8]=s*l,t[1]=s*c,t[5]=s*u,t[9]=-a,t[2]=n*a-r,t[6]=i+e*a,t[10]=s*o}else if("ZXY"===e.order){const e=o*u,n=o*c,r=l*u,i=l*c;t[0]=e-i*a,t[4]=-s*c,t[8]=r+n*a,t[1]=n+r*a,t[5]=s*u,t[9]=i-e*a,t[2]=-s*l,t[6]=a,t[10]=s*o}else if("ZYX"===e.order){const e=s*u,n=s*c,r=a*u,i=a*c;t[0]=o*u,t[4]=r*l-n,t[8]=e*l+i,t[1]=o*c,t[5]=i*l+e,t[9]=n*l-r,t[2]=-l,t[6]=a*o,t[10]=s*o}else if("YZX"===e.order){const e=s*o,n=s*l,r=a*o,i=a*l;t[0]=o*u,t[4]=i-e*c,t[8]=r*c+n,t[1]=c,t[5]=s*u,t[9]=-a*u,t[2]=-l*u,t[6]=n*c+r,t[10]=e-i*c}else if("XZY"===e.order){const e=s*o,n=s*l,r=a*o,i=a*l;t[0]=o*u,t[4]=-c,t[8]=l*u,t[1]=e*c+i,t[5]=s*u,t[9]=n*c-r,t[2]=r*c-n,t[6]=a*u,t[10]=i*c+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(ir,e,sr)}lookAt(e,t,n){const r=this.elements;return lr.subVectors(e,t),0===lr.lengthSq()&&(lr.z=1),lr.normalize(),ar.crossVectors(n,lr),0===ar.lengthSq()&&(1===Math.abs(n.z)?lr.x+=1e-4:lr.z+=1e-4,lr.normalize(),ar.crossVectors(n,lr)),ar.normalize(),or.crossVectors(lr,ar),r[0]=ar.x,r[4]=or.x,r[8]=lr.x,r[1]=ar.y,r[5]=or.y,r[9]=lr.y,r[2]=ar.z,r[6]=or.z,r[10]=lr.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,r=t.elements,i=this.elements,s=n[0],a=n[4],o=n[8],l=n[12],u=n[1],c=n[5],d=n[9],h=n[13],f=n[2],p=n[6],m=n[10],g=n[14],v=n[3],y=n[7],b=n[11],_=n[15],x=r[0],S=r[4],T=r[8],E=r[12],A=r[1],w=r[5],M=r[9],R=r[13],C=r[2],I=r[6],L=r[10],P=r[14],N=r[3],D=r[7],k=r[11],O=r[15];return i[0]=s*x+a*A+o*C+l*N,i[4]=s*S+a*w+o*I+l*D,i[8]=s*T+a*M+o*L+l*k,i[12]=s*E+a*R+o*P+l*O,i[1]=u*x+c*A+d*C+h*N,i[5]=u*S+c*w+d*I+h*D,i[9]=u*T+c*M+d*L+h*k,i[13]=u*E+c*R+d*P+h*O,i[2]=f*x+p*A+m*C+g*N,i[6]=f*S+p*w+m*I+g*D,i[10]=f*T+p*M+m*L+g*k,i[14]=f*E+p*R+m*P+g*O,i[3]=v*x+y*A+b*C+_*N,i[7]=v*S+y*w+b*I+_*D,i[11]=v*T+y*M+b*L+_*k,i[15]=v*E+y*R+b*P+_*O,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[4],r=e[8],i=e[12],s=e[1],a=e[5],o=e[9],l=e[13],u=e[2],c=e[6],d=e[10],h=e[14];return e[3]*(+i*o*c-r*l*c-i*a*d+n*l*d+r*a*h-n*o*h)+e[7]*(+t*o*h-t*l*d+i*s*d-r*s*h+r*l*u-i*o*u)+e[11]*(+t*l*c-t*a*h-i*s*c+n*s*h+i*a*u-n*l*u)+e[15]*(-r*a*u-t*o*c+t*a*d+r*s*c-n*s*d+n*o*u)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,n){const r=this.elements;return e.isVector3?(r[12]=e.x,r[13]=e.y,r[14]=e.z):(r[12]=e,r[13]=t,r[14]=n),this}invert(){const e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],a=e[5],o=e[6],l=e[7],u=e[8],c=e[9],d=e[10],h=e[11],f=e[12],p=e[13],m=e[14],g=e[15],v=c*m*l-p*d*l+p*o*h-a*m*h-c*o*g+a*d*g,y=f*d*l-u*m*l-f*o*h+s*m*h+u*o*g-s*d*g,b=u*p*l-f*c*l+f*a*h-s*p*h-u*a*g+s*c*g,_=f*c*o-u*p*o-f*a*d+s*p*d+u*a*m-s*c*m,x=t*v+n*y+r*b+i*_;if(0===x)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const S=1/x;return e[0]=v*S,e[1]=(p*d*i-c*m*i-p*r*h+n*m*h+c*r*g-n*d*g)*S,e[2]=(a*m*i-p*o*i+p*r*l-n*m*l-a*r*g+n*o*g)*S,e[3]=(c*o*i-a*d*i-c*r*l+n*d*l+a*r*h-n*o*h)*S,e[4]=y*S,e[5]=(u*m*i-f*d*i+f*r*h-t*m*h-u*r*g+t*d*g)*S,e[6]=(f*o*i-s*m*i-f*r*l+t*m*l+s*r*g-t*o*g)*S,e[7]=(s*d*i-u*o*i+u*r*l-t*d*l-s*r*h+t*o*h)*S,e[8]=b*S,e[9]=(f*c*i-u*p*i-f*n*h+t*p*h+u*n*g-t*c*g)*S,e[10]=(s*p*i-f*a*i+f*n*l-t*p*l-s*n*g+t*a*g)*S,e[11]=(u*a*i-s*c*i-u*n*l+t*c*l+s*n*h-t*a*h)*S,e[12]=_*S,e[13]=(u*p*r-f*c*r+f*n*d-t*p*d-u*n*m+t*c*m)*S,e[14]=(f*a*r-s*p*r-f*n*o+t*p*o+s*n*m-t*a*m)*S,e[15]=(s*c*r-u*a*r+u*n*o-t*c*o-s*n*d+t*a*d)*S,this}scale(e){const t=this.elements,n=e.x,r=e.y,i=e.z;return t[0]*=n,t[4]*=r,t[8]*=i,t[1]*=n,t[5]*=r,t[9]*=i,t[2]*=n,t[6]*=r,t[10]*=i,t[3]*=n,t[7]*=r,t[11]*=i,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,r))}makeTranslation(e,t,n){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const n=Math.cos(t),r=Math.sin(t),i=1-n,s=e.x,a=e.y,o=e.z,l=i*s,u=i*a;return this.set(l*s+n,l*a-r*o,l*o+r*a,0,l*a+r*o,u*a+n,u*o-r*s,0,l*o-r*a,u*o+r*s,i*o*o+n,0,0,0,0,1),this}makeScale(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,t,n,r,i,s){return this.set(1,n,i,0,e,1,s,0,t,r,1,0,0,0,0,1),this}compose(e,t,n){const r=this.elements,i=t._x,s=t._y,a=t._z,o=t._w,l=i+i,u=s+s,c=a+a,d=i*l,h=i*u,f=i*c,p=s*u,m=s*c,g=a*c,v=o*l,y=o*u,b=o*c,_=n.x,x=n.y,S=n.z;return r[0]=(1-(p+g))*_,r[1]=(h+b)*_,r[2]=(f-y)*_,r[3]=0,r[4]=(h-b)*x,r[5]=(1-(d+g))*x,r[6]=(m+v)*x,r[7]=0,r[8]=(f+y)*S,r[9]=(m-v)*S,r[10]=(1-(d+p))*S,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1,this}decompose(e,t,n){const r=this.elements;let i=nr.set(r[0],r[1],r[2]).length();const s=nr.set(r[4],r[5],r[6]).length(),a=nr.set(r[8],r[9],r[10]).length();this.determinant()<0&&(i=-i),e.x=r[12],e.y=r[13],e.z=r[14],rr.copy(this);const o=1/i,l=1/s,u=1/a;return rr.elements[0]*=o,rr.elements[1]*=o,rr.elements[2]*=o,rr.elements[4]*=l,rr.elements[5]*=l,rr.elements[6]*=l,rr.elements[8]*=u,rr.elements[9]*=u,rr.elements[10]*=u,t.setFromRotationMatrix(rr),n.x=i,n.y=s,n.z=a,this}makePerspective(e,t,n,r,i,s,a=2e3){const o=this.elements,l=2*i/(t-e),u=2*i/(n-r),c=(t+e)/(t-e),d=(n+r)/(n-r);let h,f;if(a===kt)h=-(s+i)/(s-i),f=-2*s*i/(s-i);else{if(a!==Ot)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);h=-s/(s-i),f=-s*i/(s-i)}return o[0]=l,o[4]=0,o[8]=c,o[12]=0,o[1]=0,o[5]=u,o[9]=d,o[13]=0,o[2]=0,o[6]=0,o[10]=h,o[14]=f,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,n,r,i,s,a=2e3){const o=this.elements,l=1/(t-e),u=1/(n-r),c=1/(s-i),d=(t+e)*l,h=(n+r)*u;let f,p;if(a===kt)f=(s+i)*c,p=-2*c;else{if(a!==Ot)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);f=i*c,p=-1*c}return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-d,o[1]=0,o[5]=2*u,o[9]=0,o[13]=-h,o[2]=0,o[6]=0,o[10]=p,o[14]=-f,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,n=e.elements;for(let e=0;e<16;e++)if(t[e]!==n[e])return!1;return!0}fromArray(e,t=0){for(let n=0;n<16;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}}const nr=new An,rr=new tr,ir=new An(0,0,0),sr=new An(1,1,1),ar=new An,or=new An,lr=new An,ur=new tr,cr=new En;class dr{constructor(e=0,t=0,n=0,r=dr.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=n,this._order=r}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,n,r=this._order){return this._x=e,this._y=t,this._z=n,this._order=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,n=!0){const r=e.elements,i=r[0],s=r[4],a=r[8],o=r[1],l=r[5],u=r[9],c=r[2],d=r[6],h=r[10];switch(t){case"XYZ":this._y=Math.asin(Ht(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-u,h),this._z=Math.atan2(-s,i)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-Ht(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(a,h),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-c,i),this._z=0);break;case"ZXY":this._x=Math.asin(Ht(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-c,h),this._z=Math.atan2(-s,l)):(this._y=0,this._z=Math.atan2(o,i));break;case"ZYX":this._y=Math.asin(-Ht(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(d,h),this._z=Math.atan2(o,i)):(this._x=0,this._z=Math.atan2(-s,l));break;case"YZX":this._z=Math.asin(Ht(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-u,l),this._y=Math.atan2(-c,i)):(this._x=0,this._y=Math.atan2(a,h));break;case"XZY":this._z=Math.asin(-Ht(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(a,i)):(this._x=Math.atan2(-u,h),this._y=0)}return this._order=t,!0===n&&this._onChangeCallback(),this}setFromQuaternion(e,t,n){return ur.makeRotationFromQuaternion(e),this.setFromRotationMatrix(ur,t,n)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return cr.setFromEuler(this),this.setFromQuaternion(cr,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}dr.DEFAULT_ORDER="XYZ";class hr{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}}let fr=0;const pr=new An,mr=new En,gr=new tr,vr=new An,yr=new An,br=new An,_r=new En,xr=new An(1,0,0),Sr=new An(0,1,0),Tr=new An(0,0,1),Er={type:"added"},Ar={type:"removed"},wr={type:"childadded",child:null},Mr={type:"childremoved",child:null};class Rr extends Ft{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:fr++}),this.uuid=Gt(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Rr.DEFAULT_UP.clone();const e=new An,t=new dr,n=new En,r=new An(1,1,1);t._onChange(function(){n.setFromEuler(t,!1)}),n._onChange(function(){t.setFromQuaternion(n,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new tr},normalMatrix:{value:new Kt}}),this.matrix=new tr,this.matrixWorld=new tr,this.matrixAutoUpdate=Rr.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Rr.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new hr,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return mr.setFromAxisAngle(e,t),this.quaternion.multiply(mr),this}rotateOnWorldAxis(e,t){return mr.setFromAxisAngle(e,t),this.quaternion.premultiply(mr),this}rotateX(e){return this.rotateOnAxis(xr,e)}rotateY(e){return this.rotateOnAxis(Sr,e)}rotateZ(e){return this.rotateOnAxis(Tr,e)}translateOnAxis(e,t){return pr.copy(e).applyQuaternion(this.quaternion),this.position.add(pr.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(xr,e)}translateY(e){return this.translateOnAxis(Sr,e)}translateZ(e){return this.translateOnAxis(Tr,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(gr.copy(this.matrixWorld).invert())}lookAt(e,t,n){e.isVector3?vr.copy(e):vr.set(e,t,n);const r=this.parent;this.updateWorldMatrix(!0,!1),yr.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?gr.lookAt(yr,vr,this.up):gr.lookAt(vr,yr,this.up),this.quaternion.setFromRotationMatrix(gr),r&&(gr.extractRotation(r.matrixWorld),mr.setFromRotationMatrix(gr),this.quaternion.premultiply(mr.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this||e&&e.isObject3D&&(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(Er),wr.child=e,this.dispatchEvent(wr),wr.child=null),this}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Ar),Mr.child=e,this.dispatchEvent(Mr),Mr.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),gr.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),gr.multiply(e.parent.matrixWorld)),e.applyMatrix4(gr),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(Er),wr.child=e,this.dispatchEvent(wr),wr.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let n=0,r=this.children.length;n<r;n++){const r=this.children[n].getObjectByProperty(e,t);if(void 0!==r)return r}}getObjectsByProperty(e,t,n=[]){this[e]===t&&n.push(this);const r=this.children;for(let i=0,s=r.length;i<s;i++)r[i].getObjectsByProperty(e,t,n);return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(yr,e,br),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(yr,_r,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let n=0,r=t.length;n<r;n++)t[n].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let n=0,r=t.length;n<r;n++)t[n].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let n=0,r=t.length;n<r;n++){t[n].updateMatrixWorld(e)}}updateWorldMatrix(e,t){const n=this.parent;if(!0===e&&null!==n&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,n=e.length;t<n;t++){e[t].updateWorldMatrix(!1,!0)}}}toJSON(e){const t=void 0===e||"string"==typeof e,n={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const r={};function i(t,n){return void 0===t[n.uuid]&&(t[n.uuid]=n.toJSON(e)),n.uuid}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),!0===this.castShadow&&(r.castShadow=!0),!0===this.receiveShadow&&(r.receiveShadow=!0),!1===this.visible&&(r.visible=!1),!1===this.frustumCulled&&(r.frustumCulled=!1),0!==this.renderOrder&&(r.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),r.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(r.matrixAutoUpdate=!1),this.isInstancedMesh&&(r.type="InstancedMesh",r.count=this.count,r.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(r.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(r.type="BatchedMesh",r.perObjectFrustumCulled=this.perObjectFrustumCulled,r.sortObjects=this.sortObjects,r.drawRanges=this._drawRanges,r.reservedRanges=this._reservedRanges,r.visibility=this._visibility,r.active=this._active,r.bounds=this._bounds.map(e=>({boxInitialized:e.boxInitialized,boxMin:e.box.min.toArray(),boxMax:e.box.max.toArray(),sphereInitialized:e.sphereInitialized,sphereRadius:e.sphere.radius,sphereCenter:e.sphere.center.toArray()})),r.maxInstanceCount=this._maxInstanceCount,r.maxVertexCount=this._maxVertexCount,r.maxIndexCount=this._maxIndexCount,r.geometryInitialized=this._geometryInitialized,r.geometryCount=this._geometryCount,r.matricesTexture=this._matricesTexture.toJSON(e),null!==this._colorsTexture&&(r.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(r.boundingSphere={center:r.boundingSphere.center.toArray(),radius:r.boundingSphere.radius}),null!==this.boundingBox&&(r.boundingBox={min:r.boundingBox.min.toArray(),max:r.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?r.background=this.background.toJSON():this.background.isTexture&&(r.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(r.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){r.geometry=i(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const n=t.shapes;if(Array.isArray(n))for(let t=0,r=n.length;t<r;t++){const r=n[t];i(e.shapes,r)}else i(e.shapes,n)}}if(this.isSkinnedMesh&&(r.bindMode=this.bindMode,r.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(i(e.skeletons,this.skeleton),r.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let n=0,r=this.material.length;n<r;n++)t.push(i(e.materials,this.material[n]));r.material=t}else r.material=i(e.materials,this.material);if(this.children.length>0){r.children=[];for(let t=0;t<this.children.length;t++)r.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){r.animations=[];for(let t=0;t<this.animations.length;t++){const n=this.animations[t];r.animations.push(i(e.animations,n))}}if(t){const t=s(e.geometries),r=s(e.materials),i=s(e.textures),a=s(e.images),o=s(e.shapes),l=s(e.skeletons),u=s(e.animations),c=s(e.nodes);t.length>0&&(n.geometries=t),r.length>0&&(n.materials=r),i.length>0&&(n.textures=i),a.length>0&&(n.images=a),o.length>0&&(n.shapes=o),l.length>0&&(n.skeletons=l),u.length>0&&(n.animations=u),c.length>0&&(n.nodes=c)}return n.object=r,n;function s(e){const t=[];for(const n in e){const r=e[n];delete r.metadata,t.push(r)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const n=e.children[t];this.add(n.clone())}return this}}Rr.DEFAULT_UP=new An(0,1,0),Rr.DEFAULT_MATRIX_AUTO_UPDATE=!0,Rr.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Cr=new An,Ir=new An,Lr=new An,Pr=new An,Nr=new An,Dr=new An,kr=new An,Or=new An,Fr=new An,Ur=new An,Br=new bn,Vr=new bn,zr=new bn;class Gr{constructor(e=new An,t=new An,n=new An){this.a=e,this.b=t,this.c=n}static getNormal(e,t,n,r){r.subVectors(n,t),Cr.subVectors(e,t),r.cross(Cr);const i=r.lengthSq();return i>0?r.multiplyScalar(1/Math.sqrt(i)):r.set(0,0,0)}static getBarycoord(e,t,n,r,i){Cr.subVectors(r,t),Ir.subVectors(n,t),Lr.subVectors(e,t);const s=Cr.dot(Cr),a=Cr.dot(Ir),o=Cr.dot(Lr),l=Ir.dot(Ir),u=Ir.dot(Lr),c=s*l-a*a;if(0===c)return i.set(0,0,0),null;const d=1/c,h=(l*o-a*u)*d,f=(s*u-a*o)*d;return i.set(1-h-f,f,h)}static containsPoint(e,t,n,r){return null!==this.getBarycoord(e,t,n,r,Pr)&&(Pr.x>=0&&Pr.y>=0&&Pr.x+Pr.y<=1)}static getInterpolation(e,t,n,r,i,s,a,o){return null===this.getBarycoord(e,t,n,r,Pr)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(i,Pr.x),o.addScaledVector(s,Pr.y),o.addScaledVector(a,Pr.z),o)}static getInterpolatedAttribute(e,t,n,r,i,s){return Br.setScalar(0),Vr.setScalar(0),zr.setScalar(0),Br.fromBufferAttribute(e,t),Vr.fromBufferAttribute(e,n),zr.fromBufferAttribute(e,r),s.setScalar(0),s.addScaledVector(Br,i.x),s.addScaledVector(Vr,i.y),s.addScaledVector(zr,i.z),s}static isFrontFacing(e,t,n,r){return Cr.subVectors(n,t),Ir.subVectors(e,t),Cr.cross(Ir).dot(r)<0}set(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this}setFromPointsAndIndices(e,t,n,r){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[r]),this}setFromAttributeAndIndices(e,t,n,r){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,n),this.c.fromBufferAttribute(e,r),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return Cr.subVectors(this.c,this.b),Ir.subVectors(this.a,this.b),.5*Cr.cross(Ir).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Gr.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Gr.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,n,r,i){return Gr.getInterpolation(e,this.a,this.b,this.c,t,n,r,i)}containsPoint(e){return Gr.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Gr.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const n=this.a,r=this.b,i=this.c;let s,a;Nr.subVectors(r,n),Dr.subVectors(i,n),Or.subVectors(e,n);const o=Nr.dot(Or),l=Dr.dot(Or);if(o<=0&&l<=0)return t.copy(n);Fr.subVectors(e,r);const u=Nr.dot(Fr),c=Dr.dot(Fr);if(u>=0&&c<=u)return t.copy(r);const d=o*c-u*l;if(d<=0&&o>=0&&u<=0)return s=o/(o-u),t.copy(n).addScaledVector(Nr,s);Ur.subVectors(e,i);const h=Nr.dot(Ur),f=Dr.dot(Ur);if(f>=0&&h<=f)return t.copy(i);const p=h*l-o*f;if(p<=0&&l>=0&&f<=0)return a=l/(l-f),t.copy(n).addScaledVector(Dr,a);const m=u*f-h*c;if(m<=0&&c-u>=0&&h-f>=0)return kr.subVectors(i,r),a=(c-u)/(c-u+(h-f)),t.copy(r).addScaledVector(kr,a);const g=1/(m+p+d);return s=p*g,a=d*g,t.copy(n).addScaledVector(Nr,s).addScaledVector(Dr,a)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const Hr={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},$r={h:0,s:0,l:0},Wr={h:0,s:0,l:0};function jr(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+6*(t-e)*(2/3-n):e}class qr{constructor(e,t,n){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,n)}set(e,t,n){if(void 0===t&&void 0===n){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,n);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=yt){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,un.toWorkingColorSpace(this,t),this}setRGB(e,t,n,r=un.workingColorSpace){return this.r=e,this.g=t,this.b=n,un.toWorkingColorSpace(this,r),this}setHSL(e,t,n,r=un.workingColorSpace){if(e=$t(e,1),t=Ht(t,0,1),n=Ht(n,0,1),0===t)this.r=this.g=this.b=n;else{const r=n<=.5?n*(1+t):n+t-n*t,i=2*n-r;this.r=jr(i,r,e+1/3),this.g=jr(i,r,e),this.b=jr(i,r,e-1/3)}return un.toWorkingColorSpace(this,r),this}setStyle(e,t=yt){function n(e){void 0!==e&&parseFloat(e)}let r;if(r=/^(\w+)\(([^\)]*)\)/.exec(e)){let e;const i=r[1],s=r[2];switch(i){case"rgb":case"rgba":if(e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return n(e[4]),this.setRGB(Math.min(255,parseInt(e[1],10))/255,Math.min(255,parseInt(e[2],10))/255,Math.min(255,parseInt(e[3],10))/255,t);if(e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return n(e[4]),this.setRGB(Math.min(100,parseInt(e[1],10))/100,Math.min(100,parseInt(e[2],10))/100,Math.min(100,parseInt(e[3],10))/100,t);break;case"hsl":case"hsla":if(e=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return n(e[4]),this.setHSL(parseFloat(e[1])/360,parseFloat(e[2])/100,parseFloat(e[3])/100,t)}}else if(r=/^\#([A-Fa-f\d]+)$/.exec(e)){const e=r[1],n=e.length;if(3===n)return this.setRGB(parseInt(e.charAt(0),16)/15,parseInt(e.charAt(1),16)/15,parseInt(e.charAt(2),16)/15,t);if(6===n)return this.setHex(parseInt(e,16),t)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=yt){const n=Hr[e.toLowerCase()];return void 0!==n&&this.setHex(n,t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=cn(e.r),this.g=cn(e.g),this.b=cn(e.b),this}copyLinearToSRGB(e){return this.r=dn(e.r),this.g=dn(e.g),this.b=dn(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=yt){return un.fromWorkingColorSpace(Xr.copy(this),e),65536*Math.round(Ht(255*Xr.r,0,255))+256*Math.round(Ht(255*Xr.g,0,255))+Math.round(Ht(255*Xr.b,0,255))}getHexString(e=yt){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=un.workingColorSpace){un.fromWorkingColorSpace(Xr.copy(this),t);const n=Xr.r,r=Xr.g,i=Xr.b,s=Math.max(n,r,i),a=Math.min(n,r,i);let o,l;const u=(a+s)/2;if(a===s)o=0,l=0;else{const e=s-a;switch(l=u<=.5?e/(s+a):e/(2-s-a),s){case n:o=(r-i)/e+(r<i?6:0);break;case r:o=(i-n)/e+2;break;case i:o=(n-r)/e+4}o/=6}return e.h=o,e.s=l,e.l=u,e}getRGB(e,t=un.workingColorSpace){return un.fromWorkingColorSpace(Xr.copy(this),t),e.r=Xr.r,e.g=Xr.g,e.b=Xr.b,e}getStyle(e=yt){un.fromWorkingColorSpace(Xr.copy(this),e);const t=Xr.r,n=Xr.g,r=Xr.b;return e!==yt?`color(${e} ${t.toFixed(3)} ${n.toFixed(3)} ${r.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*n)},${Math.round(255*r)})`}offsetHSL(e,t,n){return this.getHSL($r),this.setHSL($r.h+e,$r.s+t,$r.l+n)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,n){return this.r=e.r+(t.r-e.r)*n,this.g=e.g+(t.g-e.g)*n,this.b=e.b+(t.b-e.b)*n,this}lerpHSL(e,t){this.getHSL($r),e.getHSL(Wr);const n=Wt($r.h,Wr.h,t),r=Wt($r.s,Wr.s,t),i=Wt($r.l,Wr.l,t);return this.setHSL(n,r,i),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,n=this.g,r=this.b,i=e.elements;return this.r=i[0]*t+i[3]*n+i[6]*r,this.g=i[1]*t+i[4]*n+i[7]*r,this.b=i[2]*t+i[5]*n+i[8]*r,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Xr=new qr;qr.NAMES=Hr;let Yr=0;class Kr extends Ft{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Yr++}),this.uuid=Gt(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=A,this.blendDst=w,this.blendEquation=y,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new qr(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=Tt,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=St,this.stencilZFail=St,this.stencilZPass=St,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const n=e[t];if(void 0===n)continue;const r=this[t];void 0!==r&&(r&&r.isColor?r.set(n):r&&r.isVector3&&n&&n.isVector3?r.copy(n):this[t]=n)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const n={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function r(e){const t=[];for(const n in e){const r=e[n];delete r.metadata,t.push(r)}return t}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),void 0!==this.sheen&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearcoat&&(n.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(n.dispersion=this.dispersion),void 0!==this.iridescence&&(n.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(n.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(n.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(n.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(n.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(n.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(n.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(n.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(n.combine=this.combine)),void 0!==this.envMapRotation&&(n.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(n.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(n.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(n.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(n.size=this.size),null!==this.shadowSide&&(n.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(n.blending=this.blending),0!==this.side&&(n.side=this.side),!0===this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=!0),this.blendSrc!==A&&(n.blendSrc=this.blendSrc),this.blendDst!==w&&(n.blendDst=this.blendDst),this.blendEquation!==y&&(n.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(n.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(n.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(n.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(n.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(n.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(n.depthFunc=this.depthFunc),!1===this.depthTest&&(n.depthTest=this.depthTest),!1===this.depthWrite&&(n.depthWrite=this.depthWrite),!1===this.colorWrite&&(n.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(n.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==Tt&&(n.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(n.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(n.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==St&&(n.stencilFail=this.stencilFail),this.stencilZFail!==St&&(n.stencilZFail=this.stencilZFail),this.stencilZPass!==St&&(n.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(n.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.alphaHash&&(n.alphaHash=!0),!0===this.alphaToCoverage&&(n.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=!0),!0===this.forceSinglePass&&(n.forceSinglePass=!0),!0===this.wireframe&&(n.wireframe=!0),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(n.flatShading=!0),!1===this.visible&&(n.visible=!1),!1===this.toneMapped&&(n.toneMapped=!1),!1===this.fog&&(n.fog=!1),Object.keys(this.userData).length>0&&(n.userData=this.userData),t){const t=r(e.textures),i=r(e.images);t.length>0&&(n.textures=t),i.length>0&&(n.images=i)}return n}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let n=null;if(null!==t){const e=t.length;n=new Array(e);for(let r=0;r!==e;++r)n[r]=t[r].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}onBuild(){}}class Qr extends Kr{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new qr(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new dr,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const Zr=Jr();function Jr(){const e=new ArrayBuffer(4),t=new Float32Array(e),n=new Uint32Array(e),r=new Uint32Array(512),i=new Uint32Array(512);for(let e=0;e<256;++e){const t=e-127;t<-27?(r[e]=0,r[256|e]=32768,i[e]=24,i[256|e]=24):t<-14?(r[e]=1024>>-t-14,r[256|e]=1024>>-t-14|32768,i[e]=-t-1,i[256|e]=-t-1):t<=15?(r[e]=t+15<<10,r[256|e]=t+15<<10|32768,i[e]=13,i[256|e]=13):t<128?(r[e]=31744,r[256|e]=64512,i[e]=24,i[256|e]=24):(r[e]=31744,r[256|e]=64512,i[e]=13,i[256|e]=13)}const s=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let e=1;e<1024;++e){let t=e<<13,n=0;for(;!(8388608&t);)t<<=1,n-=8388608;t&=-8388609,n+=947912704,s[e]=t|n}for(let e=1024;e<2048;++e)s[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)a[e]=e<<23;a[31]=1199570944,a[32]=2147483648;for(let e=33;e<63;++e)a[e]=2147483648+(e-32<<23);a[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(o[e]=1024);return{floatView:t,uint32View:n,baseTable:r,shiftTable:i,mantissaTable:s,exponentTable:a,offsetTable:o}}function ei(e){Math.abs(e),e=Ht(e,-65504,65504),Zr.floatView[0]=e;const t=Zr.uint32View[0],n=t>>23&511;return Zr.baseTable[n]+((8388607&t)>>Zr.shiftTable[n])}function ti(e){const t=e>>10;return Zr.uint32View[0]=Zr.mantissaTable[Zr.offsetTable[t]+(1023&e)]+Zr.exponentTable[t],Zr.floatView[0]}const ni={toHalfFloat:ei,fromHalfFloat:ti},ri=new An,ii=new Yt;class si{constructor(e,t,n=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=n,this.usage=Pt,this.updateRanges=[],this.gpuType=fe,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,n){e*=this.itemSize,n*=t.itemSize;for(let r=0,i=this.itemSize;r<i;r++)this.array[e+r]=t.array[n+r];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,n=this.count;t<n;t++)ii.fromBufferAttribute(this,t),ii.applyMatrix3(e),this.setXY(t,ii.x,ii.y);else if(3===this.itemSize)for(let t=0,n=this.count;t<n;t++)ri.fromBufferAttribute(this,t),ri.applyMatrix3(e),this.setXYZ(t,ri.x,ri.y,ri.z);return this}applyMatrix4(e){for(let t=0,n=this.count;t<n;t++)ri.fromBufferAttribute(this,t),ri.applyMatrix4(e),this.setXYZ(t,ri.x,ri.y,ri.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)ri.fromBufferAttribute(this,t),ri.applyNormalMatrix(e),this.setXYZ(t,ri.x,ri.y,ri.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)ri.fromBufferAttribute(this,t),ri.transformDirection(e),this.setXYZ(t,ri.x,ri.y,ri.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let n=this.array[e*this.itemSize+t];return this.normalized&&(n=jt(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=qt(n,this.array)),this.array[e*this.itemSize+t]=n,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=jt(t,this.array)),t}setX(e,t){return this.normalized&&(t=qt(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=jt(t,this.array)),t}setY(e,t){return this.normalized&&(t=qt(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=jt(t,this.array)),t}setZ(e,t){return this.normalized&&(t=qt(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=jt(t,this.array)),t}setW(e,t){return this.normalized&&(t=qt(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array)),this.array[e+0]=t,this.array[e+1]=n,this}setXYZ(e,t,n,r){return e*=this.itemSize,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array),r=qt(r,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=r,this}setXYZW(e,t,n,r,i){return e*=this.itemSize,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array),r=qt(r,this.array),i=qt(i,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=r,this.array[e+3]=i,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==Pt&&(e.usage=this.usage),e}}class ai extends si{constructor(e,t,n){super(new Uint16Array(e),t,n)}}class oi extends si{constructor(e,t,n){super(new Uint32Array(e),t,n)}}class li extends si{constructor(e,t,n){super(new Uint16Array(e),t,n),this.isFloat16BufferAttribute=!0}getX(e){let t=ti(this.array[e*this.itemSize]);return this.normalized&&(t=jt(t,this.array)),t}setX(e,t){return this.normalized&&(t=qt(t,this.array)),this.array[e*this.itemSize]=ei(t),this}getY(e){let t=ti(this.array[e*this.itemSize+1]);return this.normalized&&(t=jt(t,this.array)),t}setY(e,t){return this.normalized&&(t=qt(t,this.array)),this.array[e*this.itemSize+1]=ei(t),this}getZ(e){let t=ti(this.array[e*this.itemSize+2]);return this.normalized&&(t=jt(t,this.array)),t}setZ(e,t){return this.normalized&&(t=qt(t,this.array)),this.array[e*this.itemSize+2]=ei(t),this}getW(e){let t=ti(this.array[e*this.itemSize+3]);return this.normalized&&(t=jt(t,this.array)),t}setW(e,t){return this.normalized&&(t=qt(t,this.array)),this.array[e*this.itemSize+3]=ei(t),this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array)),this.array[e+0]=ei(t),this.array[e+1]=ei(n),this}setXYZ(e,t,n,r){return e*=this.itemSize,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array),r=qt(r,this.array)),this.array[e+0]=ei(t),this.array[e+1]=ei(n),this.array[e+2]=ei(r),this}setXYZW(e,t,n,r,i){return e*=this.itemSize,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array),r=qt(r,this.array),i=qt(i,this.array)),this.array[e+0]=ei(t),this.array[e+1]=ei(n),this.array[e+2]=ei(r),this.array[e+3]=ei(i),this}}class ui extends si{constructor(e,t,n){super(new Float32Array(e),t,n)}}let ci=0;const di=new tr,hi=new Rr,fi=new An,pi=new Rn,mi=new Rn,gi=new An;class vi extends Ft{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:ci++}),this.uuid=Gt(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(Zt(e)?oi:ai)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,n=0){this.groups.push({start:e,count:t,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const n=this.attributes.normal;if(void 0!==n){const t=(new Kt).getNormalMatrix(e);n.applyNormalMatrix(t),n.needsUpdate=!0}const r=this.attributes.tangent;return void 0!==r&&(r.transformDirection(e),r.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return di.makeRotationFromQuaternion(e),this.applyMatrix4(di),this}rotateX(e){return di.makeRotationX(e),this.applyMatrix4(di),this}rotateY(e){return di.makeRotationY(e),this.applyMatrix4(di),this}rotateZ(e){return di.makeRotationZ(e),this.applyMatrix4(di),this}translate(e,t,n){return di.makeTranslation(e,t,n),this.applyMatrix4(di),this}scale(e,t,n){return di.makeScale(e,t,n),this.applyMatrix4(di),this}lookAt(e){return hi.lookAt(e),hi.updateMatrix(),this.applyMatrix4(hi.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(fi).negate(),this.translate(fi.x,fi.y,fi.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let n=0,r=e.length;n<r;n++){const r=e[n];t.push(r.x,r.y,r.z||0)}this.setAttribute("position",new ui(t,3))}else{const n=Math.min(e.length,t.count);for(let r=0;r<n;r++){const n=e[r];t.setXYZ(r,n.x,n.y,n.z||0)}e.length,t.count,t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Rn);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)this.boundingBox.set(new An(-1/0,-1/0,-1/0),new An(1/0,1/0,1/0));else{if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];pi.setFromBufferAttribute(n),this.morphTargetsRelative?(gi.addVectors(this.boundingBox.min,pi.min),this.boundingBox.expandByPoint(gi),gi.addVectors(this.boundingBox.max,pi.max),this.boundingBox.expandByPoint(gi)):(this.boundingBox.expandByPoint(pi.min),this.boundingBox.expandByPoint(pi.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new jn);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)this.boundingSphere.set(new An,1/0);else if(e){const n=this.boundingSphere.center;if(pi.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];mi.setFromBufferAttribute(n),this.morphTargetsRelative?(gi.addVectors(pi.min,mi.min),pi.expandByPoint(gi),gi.addVectors(pi.max,mi.max),pi.expandByPoint(gi)):(pi.expandByPoint(mi.min),pi.expandByPoint(mi.max))}pi.getCenter(n);let r=0;for(let t=0,i=e.count;t<i;t++)gi.fromBufferAttribute(e,t),r=Math.max(r,n.distanceToSquared(gi));if(t)for(let i=0,s=t.length;i<s;i++){const s=t[i],a=this.morphTargetsRelative;for(let t=0,i=s.count;t<i;t++)gi.fromBufferAttribute(s,t),a&&(fi.fromBufferAttribute(e,t),gi.add(fi)),r=Math.max(r,n.distanceToSquared(gi))}this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return;const n=t.position,r=t.normal,i=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new si(new Float32Array(4*n.count),4));const s=this.getAttribute("tangent"),a=[],o=[];for(let e=0;e<n.count;e++)a[e]=new An,o[e]=new An;const l=new An,u=new An,c=new An,d=new Yt,h=new Yt,f=new Yt,p=new An,m=new An;function g(e,t,r){l.fromBufferAttribute(n,e),u.fromBufferAttribute(n,t),c.fromBufferAttribute(n,r),d.fromBufferAttribute(i,e),h.fromBufferAttribute(i,t),f.fromBufferAttribute(i,r),u.sub(l),c.sub(l),h.sub(d),f.sub(d);const s=1/(h.x*f.y-f.x*h.y);isFinite(s)&&(p.copy(u).multiplyScalar(f.y).addScaledVector(c,-h.y).multiplyScalar(s),m.copy(c).multiplyScalar(h.x).addScaledVector(u,-f.x).multiplyScalar(s),a[e].add(p),a[t].add(p),a[r].add(p),o[e].add(m),o[t].add(m),o[r].add(m))}let v=this.groups;0===v.length&&(v=[{start:0,count:e.count}]);for(let t=0,n=v.length;t<n;++t){const n=v[t],r=n.start;for(let t=r,i=r+n.count;t<i;t+=3)g(e.getX(t+0),e.getX(t+1),e.getX(t+2))}const y=new An,b=new An,_=new An,x=new An;function S(e){_.fromBufferAttribute(r,e),x.copy(_);const t=a[e];y.copy(t),y.sub(_.multiplyScalar(_.dot(t))).normalize(),b.crossVectors(x,t);const n=b.dot(o[e])<0?-1:1;s.setXYZW(e,y.x,y.y,y.z,n)}for(let t=0,n=v.length;t<n;++t){const n=v[t],r=n.start;for(let t=r,i=r+n.count;t<i;t+=3)S(e.getX(t+0)),S(e.getX(t+1)),S(e.getX(t+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let n=this.getAttribute("normal");if(void 0===n)n=new si(new Float32Array(3*t.count),3),this.setAttribute("normal",n);else for(let e=0,t=n.count;e<t;e++)n.setXYZ(e,0,0,0);const r=new An,i=new An,s=new An,a=new An,o=new An,l=new An,u=new An,c=new An;if(e)for(let d=0,h=e.count;d<h;d+=3){const h=e.getX(d+0),f=e.getX(d+1),p=e.getX(d+2);r.fromBufferAttribute(t,h),i.fromBufferAttribute(t,f),s.fromBufferAttribute(t,p),u.subVectors(s,i),c.subVectors(r,i),u.cross(c),a.fromBufferAttribute(n,h),o.fromBufferAttribute(n,f),l.fromBufferAttribute(n,p),a.add(u),o.add(u),l.add(u),n.setXYZ(h,a.x,a.y,a.z),n.setXYZ(f,o.x,o.y,o.z),n.setXYZ(p,l.x,l.y,l.z)}else for(let e=0,a=t.count;e<a;e+=3)r.fromBufferAttribute(t,e+0),i.fromBufferAttribute(t,e+1),s.fromBufferAttribute(t,e+2),u.subVectors(s,i),c.subVectors(r,i),u.cross(c),n.setXYZ(e+0,u.x,u.y,u.z),n.setXYZ(e+1,u.x,u.y,u.z),n.setXYZ(e+2,u.x,u.y,u.z);this.normalizeNormals(),n.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,n=e.count;t<n;t++)gi.fromBufferAttribute(e,t),gi.normalize(),e.setXYZ(t,gi.x,gi.y,gi.z)}toNonIndexed(){function e(e,t){const n=e.array,r=e.itemSize,i=e.normalized,s=new n.constructor(t.length*r);let a=0,o=0;for(let i=0,l=t.length;i<l;i++){a=e.isInterleavedBufferAttribute?t[i]*e.data.stride+e.offset:t[i]*r;for(let e=0;e<r;e++)s[o++]=n[a++]}return new si(s,r,i)}if(null===this.index)return this;const t=new vi,n=this.index.array,r=this.attributes;for(const i in r){const s=e(r[i],n);t.setAttribute(i,s)}const i=this.morphAttributes;for(const r in i){const s=[],a=i[r];for(let t=0,r=a.length;t<r;t++){const r=e(a[t],n);s.push(r)}t.morphAttributes[r]=s}t.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let e=0,n=s.length;e<n;e++){const n=s[e];t.addGroup(n.start,n.count,n.materialIndex)}return t}toJSON(){const e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const n=this.attributes;for(const t in n){const r=n[t];e.data.attributes[t]=r.toJSON(e.data)}const r={};let i=!1;for(const t in this.morphAttributes){const n=this.morphAttributes[t],s=[];for(let t=0,r=n.length;t<r;t++){const r=n[t];s.push(r.toJSON(e.data))}s.length>0&&(r[t]=s,i=!0)}i&&(e.data.morphAttributes=r,e.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));const a=this.boundingSphere;return null!==a&&(e.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const n=e.index;null!==n&&this.setIndex(n.clone(t));const r=e.attributes;for(const e in r){const n=r[e];this.setAttribute(e,n.clone(t))}const i=e.morphAttributes;for(const e in i){const n=[],r=i[e];for(let e=0,i=r.length;e<i;e++)n.push(r[e].clone(t));this.morphAttributes[e]=n}this.morphTargetsRelative=e.morphTargetsRelative;const s=e.groups;for(let e=0,t=s.length;e<t;e++){const t=s[e];this.addGroup(t.start,t.count,t.materialIndex)}const a=e.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const yi=new tr,bi=new er,_i=new jn,xi=new An,Si=new An,Ti=new An,Ei=new An,Ai=new An,wi=new An,Mi=new An,Ri=new An;class Ci extends Rr{constructor(e=new vi,t=new Qr){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const n=this.geometry,r=n.attributes.position,i=n.morphAttributes.position,s=n.morphTargetsRelative;t.fromBufferAttribute(r,e);const a=this.morphTargetInfluences;if(i&&a){wi.set(0,0,0);for(let n=0,r=i.length;n<r;n++){const r=a[n],o=i[n];0!==r&&(Ai.fromBufferAttribute(o,e),s?wi.addScaledVector(Ai,r):wi.addScaledVector(Ai.sub(t),r))}t.add(wi)}return t}raycast(e,t){const n=this.geometry,r=this.material,i=this.matrixWorld;if(void 0!==r){if(null===n.boundingSphere&&n.computeBoundingSphere(),_i.copy(n.boundingSphere),_i.applyMatrix4(i),bi.copy(e.ray).recast(e.near),!1===_i.containsPoint(bi.origin)){if(null===bi.intersectSphere(_i,xi))return;if(bi.origin.distanceToSquared(xi)>(e.far-e.near)**2)return}yi.copy(i).invert(),bi.copy(e.ray).applyMatrix4(yi),null!==n.boundingBox&&!1===bi.intersectsBox(n.boundingBox)||this._computeIntersections(e,t,bi)}}_computeIntersections(e,t,n){let r;const i=this.geometry,s=this.material,a=i.index,o=i.attributes.position,l=i.attributes.uv,u=i.attributes.uv1,c=i.attributes.normal,d=i.groups,h=i.drawRange;if(null!==a)if(Array.isArray(s))for(let i=0,o=d.length;i<o;i++){const o=d[i],f=s[o.materialIndex];for(let i=Math.max(o.start,h.start),s=Math.min(a.count,Math.min(o.start+o.count,h.start+h.count));i<s;i+=3){r=Ii(this,f,e,n,l,u,c,a.getX(i),a.getX(i+1),a.getX(i+2)),r&&(r.faceIndex=Math.floor(i/3),r.face.materialIndex=o.materialIndex,t.push(r))}}else{for(let i=Math.max(0,h.start),o=Math.min(a.count,h.start+h.count);i<o;i+=3){r=Ii(this,s,e,n,l,u,c,a.getX(i),a.getX(i+1),a.getX(i+2)),r&&(r.faceIndex=Math.floor(i/3),t.push(r))}}else if(void 0!==o)if(Array.isArray(s))for(let i=0,a=d.length;i<a;i++){const a=d[i],f=s[a.materialIndex];for(let i=Math.max(a.start,h.start),s=Math.min(o.count,Math.min(a.start+a.count,h.start+h.count));i<s;i+=3){r=Ii(this,f,e,n,l,u,c,i,i+1,i+2),r&&(r.faceIndex=Math.floor(i/3),r.face.materialIndex=a.materialIndex,t.push(r))}}else{for(let i=Math.max(0,h.start),a=Math.min(o.count,h.start+h.count);i<a;i+=3){r=Ii(this,s,e,n,l,u,c,i,i+1,i+2),r&&(r.faceIndex=Math.floor(i/3),t.push(r))}}}}function Ii(e,t,n,r,i,s,a,o,l,u){e.getVertexPosition(o,Si),e.getVertexPosition(l,Ti),e.getVertexPosition(u,Ei);const c=function(e,t,n,r,i,s,a,o){let l;if(l=1===t.side?r.intersectTriangle(a,s,i,!0,o):r.intersectTriangle(i,s,a,0===t.side,o),null===l)return null;Ri.copy(o),Ri.applyMatrix4(e.matrixWorld);const u=n.ray.origin.distanceTo(Ri);return u<n.near||u>n.far?null:{distance:u,point:Ri.clone(),object:e}}(e,t,n,r,Si,Ti,Ei,Mi);if(c){const e=new An;Gr.getBarycoord(Mi,Si,Ti,Ei,e),i&&(c.uv=Gr.getInterpolatedAttribute(i,o,l,u,e,new Yt)),s&&(c.uv1=Gr.getInterpolatedAttribute(s,o,l,u,e,new Yt)),a&&(c.normal=Gr.getInterpolatedAttribute(a,o,l,u,e,new An),c.normal.dot(r.direction)>0&&c.normal.multiplyScalar(-1));const t={a:o,b:l,c:u,normal:new An,materialIndex:0};Gr.getNormal(Si,Ti,Ei,t.normal),c.face=t,c.barycoord=e}return c}class Li extends vi{constructor(e=1,t=1,n=1,r=1,i=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:r,heightSegments:i,depthSegments:s};const a=this;r=Math.floor(r),i=Math.floor(i),s=Math.floor(s);const o=[],l=[],u=[],c=[];let d=0,h=0;function f(e,t,n,r,i,s,f,p,m,g,v){const y=s/m,b=f/g,_=s/2,x=f/2,S=p/2,T=m+1,E=g+1;let A=0,w=0;const M=new An;for(let s=0;s<E;s++){const a=s*b-x;for(let o=0;o<T;o++){const d=o*y-_;M[e]=d*r,M[t]=a*i,M[n]=S,l.push(M.x,M.y,M.z),M[e]=0,M[t]=0,M[n]=p>0?1:-1,u.push(M.x,M.y,M.z),c.push(o/m),c.push(1-s/g),A+=1}}for(let e=0;e<g;e++)for(let t=0;t<m;t++){const n=d+t+T*e,r=d+t+T*(e+1),i=d+(t+1)+T*(e+1),s=d+(t+1)+T*e;o.push(n,r,s),o.push(r,i,s),w+=6}a.addGroup(h,w,v),h+=w,d+=A}f("z","y","x",-1,-1,n,t,e,s,i,0),f("z","y","x",1,-1,n,t,-e,s,i,1),f("x","z","y",1,1,e,n,t,r,s,2),f("x","z","y",1,-1,e,n,-t,r,s,3),f("x","y","z",1,-1,e,t,n,r,i,4),f("x","y","z",-1,-1,e,t,-n,r,i,5),this.setIndex(o),this.setAttribute("position",new ui(l,3)),this.setAttribute("normal",new ui(u,3)),this.setAttribute("uv",new ui(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Li(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function Pi(e){const t={};for(const n in e){t[n]={};for(const r in e[n]){const i=e[n][r];i&&(i.isColor||i.isMatrix3||i.isMatrix4||i.isVector2||i.isVector3||i.isVector4||i.isTexture||i.isQuaternion)?i.isRenderTargetTexture?t[n][r]=null:t[n][r]=i.clone():Array.isArray(i)?t[n][r]=i.slice():t[n][r]=i}}return t}function Ni(e){const t={};for(let n=0;n<e.length;n++){const r=Pi(e[n]);for(const e in r)t[e]=r[e]}return t}function Di(e){const t=e.getRenderTarget();return null===t?e.outputColorSpace:!0===t.isXRRenderTarget?t.texture.colorSpace:un.workingColorSpace}const ki={clone:Pi,merge:Ni};class Oi extends Kr{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Pi(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const n in this.uniforms){const r=this.uniforms[n].value;r&&r.isTexture?t.uniforms[n]={type:"t",value:r.toJSON(e).uuid}:r&&r.isColor?t.uniforms[n]={type:"c",value:r.getHex()}:r&&r.isVector2?t.uniforms[n]={type:"v2",value:r.toArray()}:r&&r.isVector3?t.uniforms[n]={type:"v3",value:r.toArray()}:r&&r.isVector4?t.uniforms[n]={type:"v4",value:r.toArray()}:r&&r.isMatrix3?t.uniforms[n]={type:"m3",value:r.toArray()}:r&&r.isMatrix4?t.uniforms[n]={type:"m4",value:r.toArray()}:t.uniforms[n]={value:r}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const n={};for(const e in this.extensions)!0===this.extensions[e]&&(n[e]=!0);return Object.keys(n).length>0&&(t.extensions=n),t}}class Fi extends Rr{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new tr,this.projectionMatrix=new tr,this.projectionMatrixInverse=new tr,this.coordinateSystem=kt}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const Ui=new An,Bi=new Yt,Vi=new Yt;class zi extends Fi{constructor(e=50,t=1,n=.1,r=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=r,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*zt*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*Vt*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*zt*Math.atan(Math.tan(.5*Vt*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,n){Ui.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(Ui.x,Ui.y).multiplyScalar(-e/Ui.z),Ui.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),n.set(Ui.x,Ui.y).multiplyScalar(-e/Ui.z)}getViewSize(e,t){return this.getViewBounds(e,Bi,Vi),t.subVectors(Vi,Bi)}setViewOffset(e,t,n,r,i,s){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=r,this.view.width=i,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*Vt*this.fov)/this.zoom,n=2*t,r=this.aspect*n,i=-.5*r;const s=this.view;if(null!==this.view&&this.view.enabled){const e=s.fullWidth,a=s.fullHeight;i+=s.offsetX*r/e,t-=s.offsetY*n/a,r*=s.width/e,n*=s.height/a}const a=this.filmOffset;0!==a&&(i+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(i,i+r,t,t-n,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const Gi=-90;class Hi extends Rr{constructor(e,t,n){super(),this.type="CubeCamera",this.renderTarget=n,this.coordinateSystem=null,this.activeMipmapLevel=0;const r=new zi(Gi,1,e,t);r.layers=this.layers,this.add(r);const i=new zi(Gi,1,e,t);i.layers=this.layers,this.add(i);const s=new zi(Gi,1,e,t);s.layers=this.layers,this.add(s);const a=new zi(Gi,1,e,t);a.layers=this.layers,this.add(a);const o=new zi(Gi,1,e,t);o.layers=this.layers,this.add(o);const l=new zi(Gi,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[n,r,i,s,a,o]=t;for(const e of t)this.remove(e);if(e===kt)n.up.set(0,1,0),n.lookAt(1,0,0),r.up.set(0,1,0),r.lookAt(-1,0,0),i.up.set(0,0,-1),i.lookAt(0,1,0),s.up.set(0,0,1),s.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==Ot)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);n.up.set(0,-1,0),n.lookAt(-1,0,0),r.up.set(0,-1,0),r.lookAt(1,0,0),i.up.set(0,0,1),i.lookAt(0,1,0),s.up.set(0,0,-1),s.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const e of t)this.add(e),e.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:n,activeMipmapLevel:r}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[i,s,a,o,l,u]=this.children,c=e.getRenderTarget(),d=e.getActiveCubeFace(),h=e.getActiveMipmapLevel(),f=e.xr.enabled;e.xr.enabled=!1;const p=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0,r),e.render(t,i),e.setRenderTarget(n,1,r),e.render(t,s),e.setRenderTarget(n,2,r),e.render(t,a),e.setRenderTarget(n,3,r),e.render(t,o),e.setRenderTarget(n,4,r),e.render(t,l),n.texture.generateMipmaps=p,e.setRenderTarget(n,5,r),e.render(t,u),e.setRenderTarget(c,d,h),e.xr.enabled=f,n.texture.needsPMREMUpdate=!0}}class $i extends yn{constructor(e,t,n,r,i,s,a,o,l,u){super(e=void 0!==e?e:[],t=void 0!==t?t:q,n,r,i,s,a,o,l,u),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class Wi extends xn{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const n={width:e,height:e,depth:1},r=[n,n,n,n,n,n];this.texture=new $i(r,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:ie}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const n={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},r=new Li(5,5,5),i=new Oi({name:"CubemapFromEquirect",uniforms:Pi(n.uniforms),vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:1,blending:0});i.uniforms.tEquirect.value=t;const s=new Ci(r,i),a=t.minFilter;t.minFilter===ae&&(t.minFilter=ie);return new Hi(1,10,this).update(e,s),t.minFilter=a,s.geometry.dispose(),s.material.dispose(),this}clear(e,t,n,r){const i=e.getRenderTarget();for(let i=0;i<6;i++)e.setRenderTarget(this,i),e.clear(t,n,r);e.setRenderTarget(i)}}class ji{constructor(e,t=25e-5){this.isFogExp2=!0,this.name="",this.color=new qr(e),this.density=t}clone(){return new ji(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class qi{constructor(e,t=1,n=1e3){this.isFog=!0,this.name="",this.color=new qr(e),this.near=t,this.far=n}clone(){return new qi(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class Xi extends Rr{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new dr,this.environmentIntensity=1,this.environmentRotation=new dr,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class Yi{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=Pt,this.updateRanges=[],this.version=0,this.uuid=Gt()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,n){e*=this.stride,n*=t.stride;for(let r=0,i=this.stride;r<i;r++)this.array[e+r]=t.array[n+r];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Gt()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),n=new this.constructor(t,this.stride);return n.setUsage(this.usage),n}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Gt()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const Ki=new An;class Qi{constructor(e,t,n,r=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=n,this.normalized=r}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,n=this.data.count;t<n;t++)Ki.fromBufferAttribute(this,t),Ki.applyMatrix4(e),this.setXYZ(t,Ki.x,Ki.y,Ki.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)Ki.fromBufferAttribute(this,t),Ki.applyNormalMatrix(e),this.setXYZ(t,Ki.x,Ki.y,Ki.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)Ki.fromBufferAttribute(this,t),Ki.transformDirection(e),this.setXYZ(t,Ki.x,Ki.y,Ki.z);return this}getComponent(e,t){let n=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(n=jt(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=qt(n,this.array)),this.data.array[e*this.data.stride+this.offset+t]=n,this}setX(e,t){return this.normalized&&(t=qt(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=qt(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=qt(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=qt(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=jt(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=jt(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=jt(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=jt(t,this.array)),t}setXY(e,t,n){return e=e*this.data.stride+this.offset,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this}setXYZ(e,t,n,r){return e=e*this.data.stride+this.offset,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array),r=qt(r,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=r,this}setXYZW(e,t,n,r,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=qt(t,this.array),n=qt(n,this.array),r=qt(r,this.array),i=qt(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=r,this.data.array[e+3]=i,this}clone(e){if(void 0===e){const e=[];for(let t=0;t<this.count;t++){const n=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[n+t])}return new si(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new Qi(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){const e=[];for(let t=0;t<this.count;t++){const n=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[n+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class Zi extends Kr{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new qr(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}let Ji;const es=new An,ts=new An,ns=new An,rs=new Yt,is=new Yt,ss=new tr,as=new An,os=new An,ls=new An,us=new Yt,cs=new Yt,ds=new Yt;class hs extends Rr{constructor(e=new Zi){if(super(),this.isSprite=!0,this.type="Sprite",void 0===Ji){Ji=new vi;const e=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),t=new Yi(e,5);Ji.setIndex([0,1,2,0,2,3]),Ji.setAttribute("position",new Qi(t,3,0,!1)),Ji.setAttribute("uv",new Qi(t,2,3,!1))}this.geometry=Ji,this.material=e,this.center=new Yt(.5,.5)}raycast(e,t){e.camera,ts.setFromMatrixScale(this.matrixWorld),ss.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),ns.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&ts.multiplyScalar(-ns.z);const n=this.material.rotation;let r,i;0!==n&&(i=Math.cos(n),r=Math.sin(n));const s=this.center;fs(as.set(-.5,-.5,0),ns,s,ts,r,i),fs(os.set(.5,-.5,0),ns,s,ts,r,i),fs(ls.set(.5,.5,0),ns,s,ts,r,i),us.set(0,0),cs.set(1,0),ds.set(1,1);let a=e.ray.intersectTriangle(as,os,ls,!1,es);if(null===a&&(fs(os.set(-.5,.5,0),ns,s,ts,r,i),cs.set(0,1),a=e.ray.intersectTriangle(as,ls,os,!1,es),null===a))return;const o=e.ray.origin.distanceTo(es);o<e.near||o>e.far||t.push({distance:o,point:es.clone(),uv:Gr.getInterpolation(es,as,os,ls,us,cs,ds,new Yt),face:null,object:this})}copy(e,t){return super.copy(e,t),void 0!==e.center&&this.center.copy(e.center),this.material=e.material,this}}function fs(e,t,n,r,i,s){rs.subVectors(e,n).addScalar(.5).multiply(r),void 0!==i?(is.x=s*rs.x-i*rs.y,is.y=i*rs.x+s*rs.y):is.copy(rs),e.copy(t),e.x+=is.x,e.y+=is.y,e.applyMatrix4(ss)}const ps=new An,ms=new An;class gs extends Rr{constructor(){super(),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},isLOD:{value:!0}}),this.autoUpdate=!0}copy(e){super.copy(e,!1);const t=e.levels;for(let e=0,n=t.length;e<n;e++){const n=t[e];this.addLevel(n.object.clone(),n.distance,n.hysteresis)}return this.autoUpdate=e.autoUpdate,this}addLevel(e,t=0,n=0){t=Math.abs(t);const r=this.levels;let i;for(i=0;i<r.length&&!(t<r[i].distance);i++);return r.splice(i,0,{distance:t,hysteresis:n,object:e}),this.add(e),this}removeLevel(e){const t=this.levels;for(let n=0;n<t.length;n++)if(t[n].distance===e){const e=t.splice(n,1);return this.remove(e[0].object),!0}return!1}getCurrentLevel(){return this._currentLevel}getObjectForDistance(e){const t=this.levels;if(t.length>0){let n,r;for(n=1,r=t.length;n<r;n++){let r=t[n].distance;if(t[n].object.visible&&(r-=r*t[n].hysteresis),e<r)break}return t[n-1].object}return null}raycast(e,t){if(this.levels.length>0){ps.setFromMatrixPosition(this.matrixWorld);const n=e.ray.origin.distanceTo(ps);this.getObjectForDistance(n).raycast(e,t)}}update(e){const t=this.levels;if(t.length>1){ps.setFromMatrixPosition(e.matrixWorld),ms.setFromMatrixPosition(this.matrixWorld);const n=ps.distanceTo(ms)/e.zoom;let r,i;for(t[0].object.visible=!0,r=1,i=t.length;r<i;r++){let e=t[r].distance;if(t[r].object.visible&&(e-=e*t[r].hysteresis),!(n>=e))break;t[r-1].object.visible=!1,t[r].object.visible=!0}for(this._currentLevel=r-1;r<i;r++)t[r].object.visible=!1}}toJSON(e){const t=super.toJSON(e);!1===this.autoUpdate&&(t.object.autoUpdate=!1),t.object.levels=[];const n=this.levels;for(let e=0,r=n.length;e<r;e++){const r=n[e];t.object.levels.push({object:r.object.uuid,distance:r.distance,hysteresis:r.hysteresis})}return t}}const vs=new An,ys=new bn,bs=new bn,_s=new An,xs=new tr,Ss=new An,Ts=new jn,Es=new tr,As=new er;class ws extends Ci{constructor(e,t){super(e,t),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=$,this.bindMatrix=new tr,this.bindMatrixInverse=new tr,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const e=this.geometry;null===this.boundingBox&&(this.boundingBox=new Rn),this.boundingBox.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,Ss),this.boundingBox.expandByPoint(Ss)}computeBoundingSphere(){const e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new jn),this.boundingSphere.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,Ss),this.boundingSphere.expandByPoint(Ss)}copy(e,t){return super.copy(e,t),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,t){const n=this.material,r=this.matrixWorld;void 0!==n&&(null===this.boundingSphere&&this.computeBoundingSphere(),Ts.copy(this.boundingSphere),Ts.applyMatrix4(r),!1!==e.ray.intersectsSphere(Ts)&&(Es.copy(r).invert(),As.copy(e.ray).applyMatrix4(Es),null!==this.boundingBox&&!1===As.intersectsBox(this.boundingBox)||this._computeIntersections(e,t,As)))}getVertexPosition(e,t){return super.getVertexPosition(e,t),this.applyBoneTransform(e,t),t}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new bn,t=this.geometry.attributes.skinWeight;for(let n=0,r=t.count;n<r;n++){e.fromBufferAttribute(t,n);const r=1/e.manhattanLength();r!==1/0?e.multiplyScalar(r):e.set(1,0,0,0),t.setXYZW(n,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===$?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode===W&&this.bindMatrixInverse.copy(this.bindMatrix).invert()}applyBoneTransform(e,t){const n=this.skeleton,r=this.geometry;ys.fromBufferAttribute(r.attributes.skinIndex,e),bs.fromBufferAttribute(r.attributes.skinWeight,e),vs.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let e=0;e<4;e++){const r=bs.getComponent(e);if(0!==r){const i=ys.getComponent(e);xs.multiplyMatrices(n.bones[i].matrixWorld,n.boneInverses[i]),t.addScaledVector(_s.copy(vs).applyMatrix4(xs),r)}}return t.applyMatrix4(this.bindMatrixInverse)}}class Ms extends Rr{constructor(){super(),this.isBone=!0,this.type="Bone"}}class Rs extends yn{constructor(e=null,t=1,n=1,r,i,s,a,o,l=1003,u=1003,c,d){super(null,s,a,o,l,u,r,i,c,d),this.isDataTexture=!0,this.image={data:e,width:t,height:n},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const Cs=new tr,Is=new tr;class Ls{constructor(e=[],t=[]){this.uuid=Gt(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new tr)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new tr;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,n=this.boneMatrices,r=this.boneTexture;for(let r=0,i=e.length;r<i;r++){const i=e[r]?e[r].matrixWorld:Is;Cs.multiplyMatrices(i,t[r]),Cs.toArray(n,16*r)}null!==r&&(r.needsUpdate=!0)}clone(){return new Ls(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length);e=4*Math.ceil(e/4),e=Math.max(e,4);const t=new Float32Array(e*e*4);t.set(this.boneMatrices);const n=new Rs(t,e,e,xe,fe);return n.needsUpdate=!0,this.boneMatrices=t,this.boneTexture=n,this}getBoneByName(e){for(let t=0,n=this.bones.length;t<n;t++){const n=this.bones[t];if(n.name===e)return n}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let n=0,r=e.bones.length;n<r;n++){let r=t[e.bones[n]];void 0===r&&(r=new Ms),this.bones.push(r),this.boneInverses.push((new tr).fromArray(e.boneInverses[n]))}return this.init(),this}toJSON(){const e={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,n=this.boneInverses;for(let r=0,i=t.length;r<i;r++){const i=t[r];e.bones.push(i.uuid);const s=n[r];e.boneInverses.push(s.toArray())}return e}}class Ps extends si{constructor(e,t,n,r=1){super(e,t,n),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=r}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const Ns=new tr,Ds=new tr,ks=[],Os=new Rn,Fs=new tr,Us=new Ci,Bs=new jn;class Vs extends Ci{constructor(e,t,n){super(e,t),this.isInstancedMesh=!0,this.instanceMatrix=new Ps(new Float32Array(16*n),16),this.instanceColor=null,this.morphTexture=null,this.count=n,this.boundingBox=null,this.boundingSphere=null;for(let e=0;e<n;e++)this.setMatrixAt(e,Fs)}computeBoundingBox(){const e=this.geometry,t=this.count;null===this.boundingBox&&(this.boundingBox=new Rn),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let n=0;n<t;n++)this.getMatrixAt(n,Ns),Os.copy(e.boundingBox).applyMatrix4(Ns),this.boundingBox.union(Os)}computeBoundingSphere(){const e=this.geometry,t=this.count;null===this.boundingSphere&&(this.boundingSphere=new jn),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let n=0;n<t;n++)this.getMatrixAt(n,Ns),Bs.copy(e.boundingSphere).applyMatrix4(Ns),this.boundingSphere.union(Bs)}copy(e,t){return super.copy(e,t),this.instanceMatrix.copy(e.instanceMatrix),null!==e.morphTexture&&(this.morphTexture=e.morphTexture.clone()),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,t){t.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,16*e)}getMorphAt(e,t){const n=t.morphTargetInfluences,r=this.morphTexture.source.data.data,i=e*(n.length+1)+1;for(let e=0;e<n.length;e++)n[e]=r[i+e]}raycast(e,t){const n=this.matrixWorld,r=this.count;if(Us.geometry=this.geometry,Us.material=this.material,void 0!==Us.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),Bs.copy(this.boundingSphere),Bs.applyMatrix4(n),!1!==e.ray.intersectsSphere(Bs)))for(let i=0;i<r;i++){this.getMatrixAt(i,Ns),Ds.multiplyMatrices(n,Ns),Us.matrixWorld=Ds,Us.raycast(e,ks);for(let e=0,n=ks.length;e<n;e++){const n=ks[e];n.instanceId=i,n.object=this,t.push(n)}ks.length=0}}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new Ps(new Float32Array(3*this.instanceMatrix.count).fill(1),3)),t.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,16*e)}setMorphAt(e,t){const n=t.morphTargetInfluences,r=n.length+1;null===this.morphTexture&&(this.morphTexture=new Rs(new Float32Array(r*this.count),r,this.count,we,fe));const i=this.morphTexture.source.data.data;let s=0;for(let e=0;e<n.length;e++)s+=n[e];const a=this.geometry.morphTargetsRelative?1:1-s,o=r*e;i[o]=a,i.set(n,o+1)}updateMorphTargets(){}dispose(){return this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null),this}}const zs=new An,Gs=new An,Hs=new Kt;class $s{constructor(e=new An(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,n,r){return this.normal.set(e,t,n),this.constant=r,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,n){const r=zs.subVectors(n,t).cross(Gs.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(r,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const n=e.delta(zs),r=this.normal.dot(n);if(0===r)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const i=-(e.start.dot(this.normal)+this.constant)/r;return i<0||i>1?null:t.copy(e.start).addScaledVector(n,i)}intersectsLine(e){const t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const n=t||Hs.getNormalMatrix(e),r=this.coplanarPoint(zs).applyMatrix4(e),i=this.normal.applyMatrix3(n).normalize();return this.constant=-r.dot(i),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const Ws=new jn,js=new An;class qs{constructor(e=new $s,t=new $s,n=new $s,r=new $s,i=new $s,s=new $s){this.planes=[e,t,n,r,i,s]}set(e,t,n,r,i,s){const a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(n),a[3].copy(r),a[4].copy(i),a[5].copy(s),this}copy(e){const t=this.planes;for(let n=0;n<6;n++)t[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e,t=2e3){const n=this.planes,r=e.elements,i=r[0],s=r[1],a=r[2],o=r[3],l=r[4],u=r[5],c=r[6],d=r[7],h=r[8],f=r[9],p=r[10],m=r[11],g=r[12],v=r[13],y=r[14],b=r[15];if(n[0].setComponents(o-i,d-l,m-h,b-g).normalize(),n[1].setComponents(o+i,d+l,m+h,b+g).normalize(),n[2].setComponents(o+s,d+u,m+f,b+v).normalize(),n[3].setComponents(o-s,d-u,m-f,b-v).normalize(),n[4].setComponents(o-a,d-c,m-p,b-y).normalize(),t===kt)n[5].setComponents(o+a,d+c,m+p,b+y).normalize();else{if(t!==Ot)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);n[5].setComponents(a,c,p,y).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),Ws.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),Ws.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(Ws)}intersectsSprite(e){return Ws.center.set(0,0,0),Ws.radius=.7071067811865476,Ws.applyMatrix4(e.matrixWorld),this.intersectsSphere(Ws)}intersectsSphere(e){const t=this.planes,n=e.center,r=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(n)<r)return!1}return!0}intersectsBox(e){const t=this.planes;for(let n=0;n<6;n++){const r=t[n];if(js.x=r.normal.x>0?e.max.x:e.min.x,js.y=r.normal.y>0?e.max.y:e.min.y,js.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(js)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function Xs(e,t){return e-t}function Ys(e,t){return e.z-t.z}function Ks(e,t){return t.z-e.z}class Qs{constructor(){this.index=0,this.pool=[],this.list=[]}push(e,t,n,r){const i=this.pool,s=this.list;this.index>=i.length&&i.push({start:-1,count:-1,z:-1,index:-1});const a=i[this.index];s.push(a),this.index++,a.start=e,a.count=t,a.z=n,a.index=r}reset(){this.list.length=0,this.index=0}}const Zs=new tr,Js=new qr(1,1,1),ea=new qs,ta=new Rn,na=new jn,ra=new An,ia=new An,sa=new An,aa=new Qs,oa=new Ci,la=[];function ua(e,t,n=0){const r=t.itemSize;if(e.isInterleavedBufferAttribute||e.array.constructor!==t.array.constructor){const i=e.count;for(let s=0;s<i;s++)for(let i=0;i<r;i++)t.setComponent(s+n,i,e.getComponent(s,i))}else t.array.set(e.array,n*r);t.needsUpdate=!0}function ca(e,t){if(e.constructor!==t.constructor){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++)t[r]=e[r]}else{const n=Math.min(e.length,t.length);t.set(new e.constructor(e.buffer,0,n))}}class da extends Ci{get maxInstanceCount(){return this._maxInstanceCount}get instanceCount(){return this._instanceInfo.length-this._availableInstanceIds.length}get unusedVertexCount(){return this._maxVertexCount-this._nextVertexStart}get unusedIndexCount(){return this._maxIndexCount-this._nextIndexStart}constructor(e,t,n=2*t,r){super(new vi,r),this.isBatchedMesh=!0,this.perObjectFrustumCulled=!0,this.sortObjects=!0,this.boundingBox=null,this.boundingSphere=null,this.customSort=null,this._instanceInfo=[],this._geometryInfo=[],this._availableInstanceIds=[],this._availableGeometryIds=[],this._nextIndexStart=0,this._nextVertexStart=0,this._geometryCount=0,this._visibilityChanged=!0,this._geometryInitialized=!1,this._maxInstanceCount=e,this._maxVertexCount=t,this._maxIndexCount=n,this._multiDrawCounts=new Int32Array(e),this._multiDrawStarts=new Int32Array(e),this._multiDrawCount=0,this._multiDrawInstances=null,this._matricesTexture=null,this._indirectTexture=null,this._colorsTexture=null,this._initMatricesTexture(),this._initIndirectTexture()}_initMatricesTexture(){let e=Math.sqrt(4*this._maxInstanceCount);e=4*Math.ceil(e/4),e=Math.max(e,4);const t=new Float32Array(e*e*4),n=new Rs(t,e,e,xe,fe);this._matricesTexture=n}_initIndirectTexture(){let e=Math.sqrt(this._maxInstanceCount);e=Math.ceil(e);const t=new Uint32Array(e*e),n=new Rs(t,e,e,Me,he);this._indirectTexture=n}_initColorsTexture(){let e=Math.sqrt(this._maxInstanceCount);e=Math.ceil(e);const t=new Float32Array(e*e*4).fill(1),n=new Rs(t,e,e,xe,fe);n.colorSpace=un.workingColorSpace,this._colorsTexture=n}_initializeGeometry(e){const t=this.geometry,n=this._maxVertexCount,r=this._maxIndexCount;if(!1===this._geometryInitialized){for(const r in e.attributes){const i=e.getAttribute(r),{array:s,itemSize:a,normalized:o}=i,l=new s.constructor(n*a),u=new si(l,a,o);t.setAttribute(r,u)}if(null!==e.getIndex()){const e=n>65535?new Uint32Array(r):new Uint16Array(r);t.setIndex(new si(e,1))}this._geometryInitialized=!0}}_validateGeometry(e){const t=this.geometry;if(Boolean(e.getIndex())!==Boolean(t.getIndex()))throw new Error('THREE.BatchedMesh: All geometries must consistently have "index".');for(const n in t.attributes){if(!e.hasAttribute(n))throw new Error(`THREE.BatchedMesh: Added geometry missing "${n}". All geometries must have consistent attributes.`);const r=e.getAttribute(n),i=t.getAttribute(n);if(r.itemSize!==i.itemSize||r.normalized!==i.normalized)throw new Error("THREE.BatchedMesh: All attributes must have a consistent itemSize and normalized value.")}}validateInstanceId(e){const t=this._instanceInfo;if(e<0||e>=t.length||!1===t[e].active)throw new Error(`THREE.BatchedMesh: Invalid instanceId ${e}. Instance is either out of range or has been deleted.`)}validateGeometryId(e){const t=this._geometryInfo;if(e<0||e>=t.length||!1===t[e].active)throw new Error(`THREE.BatchedMesh: Invalid geometryId ${e}. Geometry is either out of range or has been deleted.`)}setCustomSort(e){return this.customSort=e,this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Rn);const e=this.boundingBox,t=this._instanceInfo;e.makeEmpty();for(let n=0,r=t.length;n<r;n++){if(!1===t[n].active)continue;const r=t[n].geometryIndex;this.getMatrixAt(n,Zs),this.getBoundingBoxAt(r,ta).applyMatrix4(Zs),e.union(ta)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new jn);const e=this.boundingSphere,t=this._instanceInfo;e.makeEmpty();for(let n=0,r=t.length;n<r;n++){if(!1===t[n].active)continue;const r=t[n].geometryIndex;this.getMatrixAt(n,Zs),this.getBoundingSphereAt(r,na).applyMatrix4(Zs),e.union(na)}}addInstance(e){if(this._instanceInfo.length>=this.maxInstanceCount&&0===this._availableInstanceIds.length)throw new Error("THREE.BatchedMesh: Maximum item count reached.");const t={visible:!0,active:!0,geometryIndex:e};let n=null;this._availableInstanceIds.length>0?(this._availableInstanceIds.sort(Xs),n=this._availableInstanceIds.shift(),this._instanceInfo[n]=t):(n=this._instanceInfo.length,this._instanceInfo.push(t));const r=this._matricesTexture;Zs.identity().toArray(r.image.data,16*n),r.needsUpdate=!0;const i=this._colorsTexture;return i&&(Js.toArray(i.image.data,4*n),i.needsUpdate=!0),this._visibilityChanged=!0,n}addGeometry(e,t=-1,n=-1){this._initializeGeometry(e),this._validateGeometry(e);const r={vertexStart:-1,vertexCount:-1,reservedVertexCount:-1,indexStart:-1,indexCount:-1,reservedIndexCount:-1,start:-1,count:-1,boundingBox:null,boundingSphere:null,active:!0},i=this._geometryInfo;r.vertexStart=this._nextVertexStart,r.reservedVertexCount=-1===t?e.getAttribute("position").count:t;const s=e.getIndex();if(null!==s&&(r.indexStart=this._nextIndexStart,r.reservedIndexCount=-1===n?s.count:n),-1!==r.indexStart&&r.indexStart+r.reservedIndexCount>this._maxIndexCount||r.vertexStart+r.reservedVertexCount>this._maxVertexCount)throw new Error("THREE.BatchedMesh: Reserved space request exceeds the maximum buffer size.");let a;return this._availableGeometryIds.length>0?(this._availableGeometryIds.sort(Xs),a=this._availableGeometryIds.shift(),i[a]=r):(a=this._geometryCount,this._geometryCount++,i.push(r)),this.setGeometryAt(a,e),this._nextIndexStart=r.indexStart+r.reservedIndexCount,this._nextVertexStart=r.vertexStart+r.reservedVertexCount,a}setGeometryAt(e,t){if(e>=this._geometryCount)throw new Error("THREE.BatchedMesh: Maximum geometry count reached.");this._validateGeometry(t);const n=this.geometry,r=null!==n.getIndex(),i=n.getIndex(),s=t.getIndex(),a=this._geometryInfo[e];if(r&&s.count>a.reservedIndexCount||t.attributes.position.count>a.reservedVertexCount)throw new Error("THREE.BatchedMesh: Reserved space not large enough for provided geometry.");const o=a.vertexStart,l=a.reservedVertexCount;a.vertexCount=t.getAttribute("position").count;for(const e in n.attributes){const r=t.getAttribute(e),i=n.getAttribute(e);ua(r,i,o);const s=r.itemSize;for(let e=r.count,t=l;e<t;e++){const t=o+e;for(let e=0;e<s;e++)i.setComponent(t,e,0)}i.needsUpdate=!0,i.addUpdateRange(o*s,l*s)}if(r){const e=a.indexStart,n=a.reservedIndexCount;a.indexCount=t.getIndex().count;for(let t=0;t<s.count;t++)i.setX(e+t,o+s.getX(t));for(let t=s.count,r=n;t<r;t++)i.setX(e+t,o);i.needsUpdate=!0,i.addUpdateRange(e,a.reservedIndexCount)}return a.start=r?a.indexStart:a.vertexStart,a.count=r?a.indexCount:a.vertexCount,a.boundingBox=null,null!==t.boundingBox&&(a.boundingBox=t.boundingBox.clone()),a.boundingSphere=null,null!==t.boundingSphere&&(a.boundingSphere=t.boundingSphere.clone()),this._visibilityChanged=!0,e}deleteGeometry(e){const t=this._geometryInfo;if(e>=t.length||!1===t[e].active)return this;const n=this._instanceInfo;for(let t=0,r=n.length;t<r;t++)n[t].geometryIndex===e&&this.deleteInstance(t);return t[e].active=!1,this._availableGeometryIds.push(e),this._visibilityChanged=!0,this}deleteInstance(e){return this.validateInstanceId(e),this._instanceInfo[e].active=!1,this._availableInstanceIds.push(e),this._visibilityChanged=!0,this}optimize(){let e=0,t=0;const n=this._geometryInfo,r=n.map((e,t)=>t).sort((e,t)=>n[e].vertexStart-n[t].vertexStart),i=this.geometry;for(let s=0,a=n.length;s<a;s++){const a=r[s],o=n[a];if(!1!==o.active){if(null!==i.index){if(o.indexStart!==t){const{indexStart:n,vertexStart:r,reservedIndexCount:s}=o,a=i.index,l=a.array,u=e-r;for(let e=n;e<n+s;e++)l[e]=l[e]+u;a.array.copyWithin(t,n,n+s),a.addUpdateRange(t,s),o.indexStart=t}t+=o.reservedIndexCount}if(o.vertexStart!==e){const{vertexStart:t,reservedVertexCount:n}=o,r=i.attributes;for(const i in r){const s=r[i],{array:a,itemSize:o}=s;a.copyWithin(e*o,t*o,(t+n)*o),s.addUpdateRange(e*o,n*o)}o.vertexStart=e}e+=o.reservedVertexCount,o.start=i.index?o.indexStart:o.vertexStart,this._nextIndexStart=i.index?o.indexStart+o.reservedIndexCount:0,this._nextVertexStart=o.vertexStart+o.reservedVertexCount}}return this}getBoundingBoxAt(e,t){if(e>=this._geometryCount)return null;const n=this.geometry,r=this._geometryInfo[e];if(null===r.boundingBox){const e=new Rn,t=n.index,i=n.attributes.position;for(let n=r.start,s=r.start+r.count;n<s;n++){let r=n;t&&(r=t.getX(r)),e.expandByPoint(ra.fromBufferAttribute(i,r))}r.boundingBox=e}return t.copy(r.boundingBox),t}getBoundingSphereAt(e,t){if(e>=this._geometryCount)return null;const n=this.geometry,r=this._geometryInfo[e];if(null===r.boundingSphere){const t=new jn;this.getBoundingBoxAt(e,ta),ta.getCenter(t.center);const i=n.index,s=n.attributes.position;let a=0;for(let e=r.start,n=r.start+r.count;e<n;e++){let n=e;i&&(n=i.getX(n)),ra.fromBufferAttribute(s,n),a=Math.max(a,t.center.distanceToSquared(ra))}t.radius=Math.sqrt(a),r.boundingSphere=t}return t.copy(r.boundingSphere),t}setMatrixAt(e,t){this.validateInstanceId(e);const n=this._matricesTexture,r=this._matricesTexture.image.data;return t.toArray(r,16*e),n.needsUpdate=!0,this}getMatrixAt(e,t){return this.validateInstanceId(e),t.fromArray(this._matricesTexture.image.data,16*e)}setColorAt(e,t){return this.validateInstanceId(e),null===this._colorsTexture&&this._initColorsTexture(),t.toArray(this._colorsTexture.image.data,4*e),this._colorsTexture.needsUpdate=!0,this}getColorAt(e,t){return this.validateInstanceId(e),t.fromArray(this._colorsTexture.image.data,4*e)}setVisibleAt(e,t){return this.validateInstanceId(e),this._instanceInfo[e].visible===t||(this._instanceInfo[e].visible=t,this._visibilityChanged=!0),this}getVisibleAt(e){return this.validateInstanceId(e),this._instanceInfo[e].visible}setGeometryIdAt(e,t){return this.validateInstanceId(e),this.validateGeometryId(t),this._instanceInfo[e].geometryIndex=t,this}getGeometryIdAt(e){return this.validateInstanceId(e),this._instanceInfo[e].geometryIndex}getGeometryRangeAt(e,t={}){this.validateGeometryId(e);const n=this._geometryInfo[e];return t.vertexStart=n.vertexStart,t.vertexCount=n.vertexCount,t.reservedVertexCount=n.reservedVertexCount,t.indexStart=n.indexStart,t.indexCount=n.indexCount,t.reservedIndexCount=n.reservedIndexCount,t.start=n.start,t.count=n.count,t}setInstanceCount(e){const t=this._availableInstanceIds,n=this._instanceInfo;for(t.sort(Xs);t[t.length-1]===n.length;)n.pop(),t.pop();if(e<n.length)throw new Error(`BatchedMesh: Instance ids outside the range ${e} are being used. Cannot shrink instance count.`);const r=new Int32Array(e),i=new Int32Array(e);ca(this._multiDrawCounts,r),ca(this._multiDrawStarts,i),this._multiDrawCounts=r,this._multiDrawStarts=i,this._maxInstanceCount=e;const s=this._indirectTexture,a=this._matricesTexture,o=this._colorsTexture;s.dispose(),this._initIndirectTexture(),ca(s.image.data,this._indirectTexture.image.data),a.dispose(),this._initMatricesTexture(),ca(a.image.data,this._matricesTexture.image.data),o&&(o.dispose(),this._initColorsTexture(),ca(o.image.data,this._colorsTexture.image.data))}setGeometrySize(e,t){const n=[...this._geometryInfo].filter(e=>e.active),r=Math.max(...n.map(e=>e.vertexStart+e.reservedVertexCount));if(r>e)throw new Error(`BatchedMesh: Geometry vertex values are being used outside the range ${t}. Cannot shrink further.`);if(this.geometry.index){const e=Math.max(...n.map(e=>e.indexStart+e.reservedIndexCount));if(e>t)throw new Error(`BatchedMesh: Geometry index values are being used outside the range ${t}. Cannot shrink further.`)}const i=this.geometry;i.dispose(),this._maxVertexCount=e,this._maxIndexCount=t,this._geometryInitialized&&(this._geometryInitialized=!1,this.geometry=new vi,this._initializeGeometry(i));const s=this.geometry;i.index&&ca(i.index.array,s.index.array);for(const e in i.attributes)ca(i.attributes[e].array,s.attributes[e].array)}raycast(e,t){const n=this._instanceInfo,r=this._geometryInfo,i=this.matrixWorld,s=this.geometry;oa.material=this.material,oa.geometry.index=s.index,oa.geometry.attributes=s.attributes,null===oa.geometry.boundingBox&&(oa.geometry.boundingBox=new Rn),null===oa.geometry.boundingSphere&&(oa.geometry.boundingSphere=new jn);for(let s=0,a=n.length;s<a;s++){if(!n[s].visible||!n[s].active)continue;const a=n[s].geometryIndex,o=r[a];oa.geometry.setDrawRange(o.start,o.count),this.getMatrixAt(s,oa.matrixWorld).premultiply(i),this.getBoundingBoxAt(a,oa.geometry.boundingBox),this.getBoundingSphereAt(a,oa.geometry.boundingSphere),oa.raycast(e,la);for(let e=0,n=la.length;e<n;e++){const n=la[e];n.object=this,n.batchId=s,t.push(n)}la.length=0}oa.material=null,oa.geometry.index=null,oa.geometry.attributes={},oa.geometry.setDrawRange(0,1/0)}copy(e){return super.copy(e),this.geometry=e.geometry.clone(),this.perObjectFrustumCulled=e.perObjectFrustumCulled,this.sortObjects=e.sortObjects,this.boundingBox=null!==e.boundingBox?e.boundingBox.clone():null,this.boundingSphere=null!==e.boundingSphere?e.boundingSphere.clone():null,this._geometryInfo=e._geometryInfo.map(e=>({...e,boundingBox:null!==e.boundingBox?e.boundingBox.clone():null,boundingSphere:null!==e.boundingSphere?e.boundingSphere.clone():null})),this._instanceInfo=e._instanceInfo.map(e=>({...e})),this._maxInstanceCount=e._maxInstanceCount,this._maxVertexCount=e._maxVertexCount,this._maxIndexCount=e._maxIndexCount,this._geometryInitialized=e._geometryInitialized,this._geometryCount=e._geometryCount,this._multiDrawCounts=e._multiDrawCounts.slice(),this._multiDrawStarts=e._multiDrawStarts.slice(),this._matricesTexture=e._matricesTexture.clone(),this._matricesTexture.image.data=this._matricesTexture.image.data.slice(),null!==this._colorsTexture&&(this._colorsTexture=e._colorsTexture.clone(),this._colorsTexture.image.data=this._colorsTexture.image.data.slice()),this}dispose(){return this.geometry.dispose(),this._matricesTexture.dispose(),this._matricesTexture=null,this._indirectTexture.dispose(),this._indirectTexture=null,null!==this._colorsTexture&&(this._colorsTexture.dispose(),this._colorsTexture=null),this}onBeforeRender(e,t,n,r,i){if(!this._visibilityChanged&&!this.perObjectFrustumCulled&&!this.sortObjects)return;const s=r.getIndex(),a=null===s?1:s.array.BYTES_PER_ELEMENT,o=this._instanceInfo,l=this._multiDrawStarts,u=this._multiDrawCounts,c=this._geometryInfo,d=this.perObjectFrustumCulled,h=this._indirectTexture,f=h.image.data;d&&(Zs.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse).multiply(this.matrixWorld),ea.setFromProjectionMatrix(Zs,e.coordinateSystem));let p=0;if(this.sortObjects){Zs.copy(this.matrixWorld).invert(),ra.setFromMatrixPosition(n.matrixWorld).applyMatrix4(Zs),ia.set(0,0,-1).transformDirection(n.matrixWorld).transformDirection(Zs);for(let e=0,t=o.length;e<t;e++)if(o[e].visible&&o[e].active){const t=o[e].geometryIndex;this.getMatrixAt(e,Zs),this.getBoundingSphereAt(t,na).applyMatrix4(Zs);let n=!1;if(d&&(n=!ea.intersectsSphere(na)),!n){const n=c[t],r=sa.subVectors(na.center,ra).dot(ia);aa.push(n.start,n.count,r,e)}}const e=aa.list,t=this.customSort;null===t?e.sort(i.transparent?Ks:Ys):t.call(this,e,n);for(let t=0,n=e.length;t<n;t++){const n=e[t];l[p]=n.start*a,u[p]=n.count,f[p]=n.index,p++}aa.reset()}else for(let e=0,t=o.length;e<t;e++)if(o[e].visible&&o[e].active){const t=o[e].geometryIndex;let n=!1;if(d&&(this.getMatrixAt(e,Zs),this.getBoundingSphereAt(t,na).applyMatrix4(Zs),n=!ea.intersectsSphere(na)),!n){const n=c[t];l[p]=n.start*a,u[p]=n.count,f[p]=e,p++}}h.needsUpdate=!0,this._multiDrawCount=p,this._visibilityChanged=!1}onBeforeShadow(e,t,n,r,i,s){this.onBeforeRender(e,null,r,i,s)}}class ha extends Kr{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new qr(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const fa=new An,pa=new An,ma=new tr,ga=new er,va=new jn,ya=new An,ba=new An;class _a extends Rr{constructor(e=new vi,t=new ha){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[0];for(let e=1,r=t.count;e<r;e++)fa.fromBufferAttribute(t,e-1),pa.fromBufferAttribute(t,e),n[e]=n[e-1],n[e]+=fa.distanceTo(pa);e.setAttribute("lineDistance",new ui(n,1))}return this}raycast(e,t){const n=this.geometry,r=this.matrixWorld,i=e.params.Line.threshold,s=n.drawRange;if(null===n.boundingSphere&&n.computeBoundingSphere(),va.copy(n.boundingSphere),va.applyMatrix4(r),va.radius+=i,!1===e.ray.intersectsSphere(va))return;ma.copy(r).invert(),ga.copy(e.ray).applyMatrix4(ma);const a=i/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=this.isLineSegments?2:1,u=n.index,c=n.attributes.position;if(null!==u){const n=Math.max(0,s.start),r=Math.min(u.count,s.start+s.count);for(let i=n,s=r-1;i<s;i+=l){const n=u.getX(i),r=u.getX(i+1),s=xa(this,e,ga,o,n,r);s&&t.push(s)}if(this.isLineLoop){const i=u.getX(r-1),s=u.getX(n),a=xa(this,e,ga,o,i,s);a&&t.push(a)}}else{const n=Math.max(0,s.start),r=Math.min(c.count,s.start+s.count);for(let i=n,s=r-1;i<s;i+=l){const n=xa(this,e,ga,o,i,i+1);n&&t.push(n)}if(this.isLineLoop){const i=xa(this,e,ga,o,r-1,n);i&&t.push(i)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function xa(e,t,n,r,i,s){const a=e.geometry.attributes.position;fa.fromBufferAttribute(a,i),pa.fromBufferAttribute(a,s);if(n.distanceSqToSegment(fa,pa,ya,ba)>r)return;ya.applyMatrix4(e.matrixWorld);const o=t.ray.origin.distanceTo(ya);return o<t.near||o>t.far?void 0:{distance:o,point:ba.clone().applyMatrix4(e.matrixWorld),index:i,face:null,faceIndex:null,barycoord:null,object:e}}const Sa=new An,Ta=new An;class Ea extends _a{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[];for(let e=0,r=t.count;e<r;e+=2)Sa.fromBufferAttribute(t,e),Ta.fromBufferAttribute(t,e+1),n[e]=0===e?0:n[e-1],n[e+1]=n[e]+Sa.distanceTo(Ta);e.setAttribute("lineDistance",new ui(n,1))}return this}}class Aa extends _a{constructor(e,t){super(e,t),this.isLineLoop=!0,this.type="LineLoop"}}class wa extends Kr{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new qr(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}const Ma=new tr,Ra=new er,Ca=new jn,Ia=new An;class La extends Rr{constructor(e=new vi,t=new wa){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,t){const n=this.geometry,r=this.matrixWorld,i=e.params.Points.threshold,s=n.drawRange;if(null===n.boundingSphere&&n.computeBoundingSphere(),Ca.copy(n.boundingSphere),Ca.applyMatrix4(r),Ca.radius+=i,!1===e.ray.intersectsSphere(Ca))return;Ma.copy(r).invert(),Ra.copy(e.ray).applyMatrix4(Ma);const a=i/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=n.index,u=n.attributes.position;if(null!==l){for(let n=Math.max(0,s.start),i=Math.min(l.count,s.start+s.count);n<i;n++){const i=l.getX(n);Ia.fromBufferAttribute(u,i),Pa(Ia,i,o,r,e,t,this)}}else{for(let n=Math.max(0,s.start),i=Math.min(u.count,s.start+s.count);n<i;n++)Ia.fromBufferAttribute(u,n),Pa(Ia,n,o,r,e,t,this)}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function Pa(e,t,n,r,i,s,a){const o=Ra.distanceSqToPoint(e);if(o<n){const n=new An;Ra.closestPointToPoint(e,n),n.applyMatrix4(r);const l=i.ray.origin.distanceTo(n);if(l<i.near||l>i.far)return;s.push({distance:l,distanceToRay:Math.sqrt(o),point:n,index:t,face:null,faceIndex:null,barycoord:null,object:a})}}class Na extends Rr{constructor(){super(),this.isGroup=!0,this.type="Group"}}class Da extends yn{constructor(e,t,n,r,i,s,a,o,l){super(e,t,n,r,i,s,a,o,l),this.isVideoTexture=!0,this.minFilter=void 0!==s?s:ie,this.magFilter=void 0!==i?i:ie,this.generateMipmaps=!1;const u=this;"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback(function t(){u.needsUpdate=!0,e.requestVideoFrameCallback(t)})}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;!1==="requestVideoFrameCallback"in e&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}class ka extends yn{constructor(e,t){super({width:e,height:t}),this.isFramebufferTexture=!0,this.magFilter=te,this.minFilter=te,this.generateMipmaps=!1,this.needsUpdate=!0}}class Oa extends yn{constructor(e,t,n,r,i,s,a,o,l,u,c,d){super(null,s,a,o,l,u,r,i,c,d),this.isCompressedTexture=!0,this.image={width:t,height:n},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}class Fa extends yn{constructor(e,t,n,r,i,s,a,o,l,u=1026){if(u!==Ee&&u!==Ae)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===n&&u===Ee&&(n=he),void 0===n&&u===Ae&&(n=ve),super(null,r,i,s,a,o,u,n,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=void 0!==a?a:te,this.minFilter=void 0!==o?o:te,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}class Ua{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return null}getPointAt(e,t){const n=this.getUtoTmapping(e);return this.getPoint(n,t)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}getSpacedPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPointAt(n/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let n,r=this.getPoint(0),i=0;t.push(0);for(let s=1;s<=e;s++)n=this.getPoint(s/e),i+=n.distanceTo(r),t.push(i),r=n;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t){const n=this.getLengths();let r=0;const i=n.length;let s;s=t||e*n[i-1];let a,o=0,l=i-1;for(;o<=l;)if(r=Math.floor(o+(l-o)/2),a=n[r]-s,a<0)o=r+1;else{if(!(a>0)){l=r;break}l=r-1}if(r=l,n[r]===s)return r/(i-1);const u=n[r];return(r+(s-u)/(n[r+1]-u))/(i-1)}getTangent(e,t){const n=1e-4;let r=e-n,i=e+n;r<0&&(r=0),i>1&&(i=1);const s=this.getPoint(r),a=this.getPoint(i),o=t||(s.isVector2?new Yt:new An);return o.copy(a).sub(s).normalize(),o}getTangentAt(e,t){const n=this.getUtoTmapping(e);return this.getTangent(n,t)}computeFrenetFrames(e,t){const n=new An,r=[],i=[],s=[],a=new An,o=new tr;for(let t=0;t<=e;t++){const n=t/e;r[t]=this.getTangentAt(n,new An)}i[0]=new An,s[0]=new An;let l=Number.MAX_VALUE;const u=Math.abs(r[0].x),c=Math.abs(r[0].y),d=Math.abs(r[0].z);u<=l&&(l=u,n.set(1,0,0)),c<=l&&(l=c,n.set(0,1,0)),d<=l&&n.set(0,0,1),a.crossVectors(r[0],n).normalize(),i[0].crossVectors(r[0],a),s[0].crossVectors(r[0],i[0]);for(let t=1;t<=e;t++){if(i[t]=i[t-1].clone(),s[t]=s[t-1].clone(),a.crossVectors(r[t-1],r[t]),a.length()>Number.EPSILON){a.normalize();const e=Math.acos(Ht(r[t-1].dot(r[t]),-1,1));i[t].applyMatrix4(o.makeRotationAxis(a,e))}s[t].crossVectors(r[t],i[t])}if(!0===t){let t=Math.acos(Ht(i[0].dot(i[e]),-1,1));t/=e,r[0].dot(a.crossVectors(i[0],i[e]))>0&&(t=-t);for(let n=1;n<=e;n++)i[n].applyMatrix4(o.makeRotationAxis(r[n],t*n)),s[n].crossVectors(r[n],i[n])}return{tangents:r,normals:i,binormals:s}}clone(){return(new this.constructor).copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class Ba extends Ua{constructor(e=0,t=0,n=1,r=1,i=0,s=2*Math.PI,a=!1,o=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=r,this.aStartAngle=i,this.aEndAngle=s,this.aClockwise=a,this.aRotation=o}getPoint(e,t=new Yt){const n=t,r=2*Math.PI;let i=this.aEndAngle-this.aStartAngle;const s=Math.abs(i)<Number.EPSILON;for(;i<0;)i+=r;for(;i>r;)i-=r;i<Number.EPSILON&&(i=s?0:r),!0!==this.aClockwise||s||(i===r?i=-r:i-=r);const a=this.aStartAngle+e*i;let o=this.aX+this.xRadius*Math.cos(a),l=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),n=o-this.aX,r=l-this.aY;o=n*e-r*t+this.aX,l=n*t+r*e+this.aY}return n.set(o,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}class Va extends Ba{constructor(e,t,n,r,i,s){super(e,t,n,n,r,i,s),this.isArcCurve=!0,this.type="ArcCurve"}}function za(){let e=0,t=0,n=0,r=0;function i(i,s,a,o){e=i,t=a,n=-3*i+3*s-2*a-o,r=2*i-2*s+a+o}return{initCatmullRom:function(e,t,n,r,s){i(t,n,s*(n-e),s*(r-t))},initNonuniformCatmullRom:function(e,t,n,r,s,a,o){let l=(t-e)/s-(n-e)/(s+a)+(n-t)/a,u=(n-t)/a-(r-t)/(a+o)+(r-n)/o;l*=a,u*=a,i(t,n,l,u)},calc:function(i){const s=i*i;return e+t*i+n*s+r*(s*i)}}}const Ga=new An,Ha=new za,$a=new za,Wa=new za;class ja extends Ua{constructor(e=[],t=!1,n="centripetal",r=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=n,this.tension=r}getPoint(e,t=new An){const n=t,r=this.points,i=r.length,s=(i-(this.closed?0:1))*e;let a,o,l=Math.floor(s),u=s-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/i)+1)*i:0===u&&l===i-1&&(l=i-2,u=1),this.closed||l>0?a=r[(l-1)%i]:(Ga.subVectors(r[0],r[1]).add(r[0]),a=Ga);const c=r[l%i],d=r[(l+1)%i];if(this.closed||l+2<i?o=r[(l+2)%i]:(Ga.subVectors(r[i-1],r[i-2]).add(r[i-1]),o=Ga),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let t=Math.pow(a.distanceToSquared(c),e),n=Math.pow(c.distanceToSquared(d),e),r=Math.pow(d.distanceToSquared(o),e);n<1e-4&&(n=1),t<1e-4&&(t=n),r<1e-4&&(r=n),Ha.initNonuniformCatmullRom(a.x,c.x,d.x,o.x,t,n,r),$a.initNonuniformCatmullRom(a.y,c.y,d.y,o.y,t,n,r),Wa.initNonuniformCatmullRom(a.z,c.z,d.z,o.z,t,n,r)}else"catmullrom"===this.curveType&&(Ha.initCatmullRom(a.x,c.x,d.x,o.x,this.tension),$a.initCatmullRom(a.y,c.y,d.y,o.y,this.tension),Wa.initCatmullRom(a.z,c.z,d.z,o.z,this.tension));return n.set(Ha.calc(u),$a.calc(u),Wa.calc(u)),n}copy(e){super.copy(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const n=e.points[t];this.points.push(n.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,n=this.points.length;t<n;t++){const n=this.points[t];e.points.push(n.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const n=e.points[t];this.points.push((new An).fromArray(n))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function qa(e,t,n,r,i){const s=.5*(r-t),a=.5*(i-n),o=e*e;return(2*n-2*r+s+a)*(e*o)+(-3*n+3*r-2*s-a)*o+s*e+n}function Xa(e,t,n,r){return function(e,t){const n=1-e;return n*n*t}(e,t)+function(e,t){return 2*(1-e)*e*t}(e,n)+function(e,t){return e*e*t}(e,r)}function Ya(e,t,n,r,i){return function(e,t){const n=1-e;return n*n*n*t}(e,t)+function(e,t){const n=1-e;return 3*n*n*e*t}(e,n)+function(e,t){return 3*(1-e)*e*e*t}(e,r)+function(e,t){return e*e*e*t}(e,i)}class Ka extends Ua{constructor(e=new Yt,t=new Yt,n=new Yt,r=new Yt){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=n,this.v3=r}getPoint(e,t=new Yt){const n=t,r=this.v0,i=this.v1,s=this.v2,a=this.v3;return n.set(Ya(e,r.x,i.x,s.x,a.x),Ya(e,r.y,i.y,s.y,a.y)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class Qa extends Ua{constructor(e=new An,t=new An,n=new An,r=new An){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=n,this.v3=r}getPoint(e,t=new An){const n=t,r=this.v0,i=this.v1,s=this.v2,a=this.v3;return n.set(Ya(e,r.x,i.x,s.x,a.x),Ya(e,r.y,i.y,s.y,a.y),Ya(e,r.z,i.z,s.z,a.z)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class Za extends Ua{constructor(e=new Yt,t=new Yt){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new Yt){const n=t;return 1===e?n.copy(this.v2):(n.copy(this.v2).sub(this.v1),n.multiplyScalar(e).add(this.v1)),n}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new Yt){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class Ja extends Ua{constructor(e=new An,t=new An){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=t}getPoint(e,t=new An){const n=t;return 1===e?n.copy(this.v2):(n.copy(this.v2).sub(this.v1),n.multiplyScalar(e).add(this.v1)),n}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new An){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class eo extends Ua{constructor(e=new Yt,t=new Yt,n=new Yt){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=n}getPoint(e,t=new Yt){const n=t,r=this.v0,i=this.v1,s=this.v2;return n.set(Xa(e,r.x,i.x,s.x),Xa(e,r.y,i.y,s.y)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class to extends Ua{constructor(e=new An,t=new An,n=new An){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=n}getPoint(e,t=new An){const n=t,r=this.v0,i=this.v1,s=this.v2;return n.set(Xa(e,r.x,i.x,s.x),Xa(e,r.y,i.y,s.y),Xa(e,r.z,i.z,s.z)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class no extends Ua{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,t=new Yt){const n=t,r=this.points,i=(r.length-1)*e,s=Math.floor(i),a=i-s,o=r[0===s?s:s-1],l=r[s],u=r[s>r.length-2?r.length-1:s+1],c=r[s>r.length-3?r.length-1:s+2];return n.set(qa(a,o.x,l.x,u.x,c.x),qa(a,o.y,l.y,u.y,c.y)),n}copy(e){super.copy(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const n=e.points[t];this.points.push(n.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,n=this.points.length;t<n;t++){const n=this.points[t];e.points.push(n.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const n=e.points[t];this.points.push((new Yt).fromArray(n))}return this}}var ro=Object.freeze({__proto__:null,ArcCurve:Va,CatmullRomCurve3:ja,CubicBezierCurve:Ka,CubicBezierCurve3:Qa,EllipseCurve:Ba,LineCurve:Za,LineCurve3:Ja,QuadraticBezierCurve:eo,QuadraticBezierCurve3:to,SplineCurve:no});class io extends Ua{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);if(!e.equals(t)){const n=!0===e.isVector2?"LineCurve":"LineCurve3";this.curves.push(new ro[n](t,e))}return this}getPoint(e,t){const n=e*this.getLength(),r=this.getCurveLengths();let i=0;for(;i<r.length;){if(r[i]>=n){const e=r[i]-n,s=this.curves[i],a=s.getLength(),o=0===a?0:1-e/a;return s.getPointAt(o,t)}i++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let n=0,r=this.curves.length;n<r;n++)t+=this.curves[n].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let n;for(let r=0,i=this.curves;r<i.length;r++){const s=i[r],a=s.isEllipseCurve?2*e:s.isLineCurve||s.isLineCurve3?1:s.isSplineCurve?e*s.points.length:e,o=s.getPoints(a);for(let e=0;e<o.length;e++){const r=o[e];n&&n.equals(r)||(t.push(r),n=r)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,n=e.curves.length;t<n;t++){const n=e.curves[t];this.curves.push(n.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,n=this.curves.length;t<n;t++){const n=this.curves[t];e.curves.push(n.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,n=e.curves.length;t<n;t++){const n=e.curves[t];this.curves.push((new ro[n.type]).fromJSON(n))}return this}}class so extends io{constructor(e){super(),this.type="Path",this.currentPoint=new Yt,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,n=e.length;t<n;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const n=new Za(this.currentPoint.clone(),new Yt(e,t));return this.curves.push(n),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,n,r){const i=new eo(this.currentPoint.clone(),new Yt(e,t),new Yt(n,r));return this.curves.push(i),this.currentPoint.set(n,r),this}bezierCurveTo(e,t,n,r,i,s){const a=new Ka(this.currentPoint.clone(),new Yt(e,t),new Yt(n,r),new Yt(i,s));return this.curves.push(a),this.currentPoint.set(i,s),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),n=new no(t);return this.curves.push(n),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,n,r,i,s){const a=this.currentPoint.x,o=this.currentPoint.y;return this.absarc(e+a,t+o,n,r,i,s),this}absarc(e,t,n,r,i,s){return this.absellipse(e,t,n,n,r,i,s),this}ellipse(e,t,n,r,i,s,a,o){const l=this.currentPoint.x,u=this.currentPoint.y;return this.absellipse(e+l,t+u,n,r,i,s,a,o),this}absellipse(e,t,n,r,i,s,a,o){const l=new Ba(e,t,n,r,i,s,a,o);if(this.curves.length>0){const e=l.getPoint(0);e.equals(this.currentPoint)||this.lineTo(e.x,e.y)}this.curves.push(l);const u=l.getPoint(1);return this.currentPoint.copy(u),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class ao extends vi{constructor(e=[new Yt(0,-.5),new Yt(.5,0),new Yt(0,.5)],t=12,n=0,r=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:n,phiLength:r},t=Math.floor(t),r=Ht(r,0,2*Math.PI);const i=[],s=[],a=[],o=[],l=[],u=1/t,c=new An,d=new Yt,h=new An,f=new An,p=new An;let m=0,g=0;for(let t=0;t<=e.length-1;t++)switch(t){case 0:m=e[t+1].x-e[t].x,g=e[t+1].y-e[t].y,h.x=1*g,h.y=-m,h.z=0*g,p.copy(h),h.normalize(),o.push(h.x,h.y,h.z);break;case e.length-1:o.push(p.x,p.y,p.z);break;default:m=e[t+1].x-e[t].x,g=e[t+1].y-e[t].y,h.x=1*g,h.y=-m,h.z=0*g,f.copy(h),h.x+=p.x,h.y+=p.y,h.z+=p.z,h.normalize(),o.push(h.x,h.y,h.z),p.copy(f)}for(let i=0;i<=t;i++){const h=n+i*u*r,f=Math.sin(h),p=Math.cos(h);for(let n=0;n<=e.length-1;n++){c.x=e[n].x*f,c.y=e[n].y,c.z=e[n].x*p,s.push(c.x,c.y,c.z),d.x=i/t,d.y=n/(e.length-1),a.push(d.x,d.y);const r=o[3*n+0]*f,u=o[3*n+1],h=o[3*n+0]*p;l.push(r,u,h)}}for(let n=0;n<t;n++)for(let t=0;t<e.length-1;t++){const r=t+n*e.length,s=r,a=r+e.length,o=r+e.length+1,l=r+1;i.push(s,a,l),i.push(o,l,a)}this.setIndex(i),this.setAttribute("position",new ui(s,3)),this.setAttribute("uv",new ui(a,2)),this.setAttribute("normal",new ui(l,3))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ao(e.points,e.segments,e.phiStart,e.phiLength)}}class oo extends ao{constructor(e=1,t=1,n=4,r=8){const i=new so;i.absarc(0,-t/2,e,1.5*Math.PI,0),i.absarc(0,t/2,e,0,.5*Math.PI),super(i.getPoints(n),r),this.type="CapsuleGeometry",this.parameters={radius:e,length:t,capSegments:n,radialSegments:r}}static fromJSON(e){return new oo(e.radius,e.length,e.capSegments,e.radialSegments)}}class lo extends vi{constructor(e=1,t=32,n=0,r=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:n,thetaLength:r},t=Math.max(3,t);const i=[],s=[],a=[],o=[],l=new An,u=new Yt;s.push(0,0,0),a.push(0,0,1),o.push(.5,.5);for(let i=0,c=3;i<=t;i++,c+=3){const d=n+i/t*r;l.x=e*Math.cos(d),l.y=e*Math.sin(d),s.push(l.x,l.y,l.z),a.push(0,0,1),u.x=(s[c]/e+1)/2,u.y=(s[c+1]/e+1)/2,o.push(u.x,u.y)}for(let e=1;e<=t;e++)i.push(e,e+1,0);this.setIndex(i),this.setAttribute("position",new ui(s,3)),this.setAttribute("normal",new ui(a,3)),this.setAttribute("uv",new ui(o,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new lo(e.radius,e.segments,e.thetaStart,e.thetaLength)}}class uo extends vi{constructor(e=1,t=1,n=1,r=32,i=1,s=!1,a=0,o=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:n,radialSegments:r,heightSegments:i,openEnded:s,thetaStart:a,thetaLength:o};const l=this;r=Math.floor(r),i=Math.floor(i);const u=[],c=[],d=[],h=[];let f=0;const p=[],m=n/2;let g=0;function v(n){const i=f,s=new Yt,p=new An;let v=0;const y=!0===n?e:t,b=!0===n?1:-1;for(let e=1;e<=r;e++)c.push(0,m*b,0),d.push(0,b,0),h.push(.5,.5),f++;const _=f;for(let e=0;e<=r;e++){const t=e/r*o+a,n=Math.cos(t),i=Math.sin(t);p.x=y*i,p.y=m*b,p.z=y*n,c.push(p.x,p.y,p.z),d.push(0,b,0),s.x=.5*n+.5,s.y=.5*i*b+.5,h.push(s.x,s.y),f++}for(let e=0;e<r;e++){const t=i+e,r=_+e;!0===n?u.push(r,r+1,t):u.push(r+1,r,t),v+=3}l.addGroup(g,v,!0===n?1:2),g+=v}!function(){const s=new An,v=new An;let y=0;const b=(t-e)/n;for(let l=0;l<=i;l++){const u=[],g=l/i,y=g*(t-e)+e;for(let e=0;e<=r;e++){const t=e/r,i=t*o+a,l=Math.sin(i),p=Math.cos(i);v.x=y*l,v.y=-g*n+m,v.z=y*p,c.push(v.x,v.y,v.z),s.set(l,b,p).normalize(),d.push(s.x,s.y,s.z),h.push(t,1-g),u.push(f++)}p.push(u)}for(let n=0;n<r;n++)for(let r=0;r<i;r++){const s=p[r][n],a=p[r+1][n],o=p[r+1][n+1],l=p[r][n+1];(e>0||0!==r)&&(u.push(s,a,l),y+=3),(t>0||r!==i-1)&&(u.push(a,o,l),y+=3)}l.addGroup(g,y,0),g+=y}(),!1===s&&(e>0&&v(!0),t>0&&v(!1)),this.setIndex(u),this.setAttribute("position",new ui(c,3)),this.setAttribute("normal",new ui(d,3)),this.setAttribute("uv",new ui(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new uo(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class co extends uo{constructor(e=1,t=1,n=32,r=1,i=!1,s=0,a=2*Math.PI){super(0,e,t,n,r,i,s,a),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:n,heightSegments:r,openEnded:i,thetaStart:s,thetaLength:a}}static fromJSON(e){return new co(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class ho extends vi{constructor(e=[],t=[],n=1,r=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:n,detail:r};const i=[],s=[];function a(e,t,n,r){const i=r+1,s=[];for(let r=0;r<=i;r++){s[r]=[];const a=e.clone().lerp(n,r/i),o=t.clone().lerp(n,r/i),l=i-r;for(let e=0;e<=l;e++)s[r][e]=0===e&&r===i?a:a.clone().lerp(o,e/l)}for(let e=0;e<i;e++)for(let t=0;t<2*(i-e)-1;t++){const n=Math.floor(t/2);t%2==0?(o(s[e][n+1]),o(s[e+1][n]),o(s[e][n])):(o(s[e][n+1]),o(s[e+1][n+1]),o(s[e+1][n]))}}function o(e){i.push(e.x,e.y,e.z)}function l(t,n){const r=3*t;n.x=e[r+0],n.y=e[r+1],n.z=e[r+2]}function u(e,t,n,r){r<0&&1===e.x&&(s[t]=e.x-1),0===n.x&&0===n.z&&(s[t]=r/2/Math.PI+.5)}function c(e){return Math.atan2(e.z,-e.x)}function d(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}!function(e){const n=new An,r=new An,i=new An;for(let s=0;s<t.length;s+=3)l(t[s+0],n),l(t[s+1],r),l(t[s+2],i),a(n,r,i,e)}(r),function(e){const t=new An;for(let n=0;n<i.length;n+=3)t.x=i[n+0],t.y=i[n+1],t.z=i[n+2],t.normalize().multiplyScalar(e),i[n+0]=t.x,i[n+1]=t.y,i[n+2]=t.z}(n),function(){const e=new An;for(let t=0;t<i.length;t+=3){e.x=i[t+0],e.y=i[t+1],e.z=i[t+2];const n=c(e)/2/Math.PI+.5,r=d(e)/Math.PI+.5;s.push(n,1-r)}(function(){const e=new An,t=new An,n=new An,r=new An,a=new Yt,o=new Yt,l=new Yt;for(let d=0,h=0;d<i.length;d+=9,h+=6){e.set(i[d+0],i[d+1],i[d+2]),t.set(i[d+3],i[d+4],i[d+5]),n.set(i[d+6],i[d+7],i[d+8]),a.set(s[h+0],s[h+1]),o.set(s[h+2],s[h+3]),l.set(s[h+4],s[h+5]),r.copy(e).add(t).add(n).divideScalar(3);const f=c(r);u(a,h+0,e,f),u(o,h+2,t,f),u(l,h+4,n,f)}})(),function(){for(let e=0;e<s.length;e+=6){const t=s[e+0],n=s[e+2],r=s[e+4],i=Math.max(t,n,r),a=Math.min(t,n,r);i>.9&&a<.1&&(t<.2&&(s[e+0]+=1),n<.2&&(s[e+2]+=1),r<.2&&(s[e+4]+=1))}}()}(),this.setAttribute("position",new ui(i,3)),this.setAttribute("normal",new ui(i.slice(),3)),this.setAttribute("uv",new ui(s,2)),0===r?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ho(e.vertices,e.indices,e.radius,e.details)}}class fo extends ho{constructor(e=1,t=0){const n=(1+Math.sqrt(5))/2,r=1/n;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-r,-n,0,-r,n,0,r,-n,0,r,n,-r,-n,0,-r,n,0,r,-n,0,r,n,0,-n,0,-r,n,0,-r,-n,0,r,n,0,r],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new fo(e.radius,e.detail)}}const po=new An,mo=new An,go=new An,vo=new Gr;class yo extends vi{constructor(e=null,t=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:e,thresholdAngle:t},null!==e){const n=4,r=Math.pow(10,n),i=Math.cos(Vt*t),s=e.getIndex(),a=e.getAttribute("position"),o=s?s.count:a.count,l=[0,0,0],u=["a","b","c"],c=new Array(3),d={},h=[];for(let e=0;e<o;e+=3){s?(l[0]=s.getX(e),l[1]=s.getX(e+1),l[2]=s.getX(e+2)):(l[0]=e,l[1]=e+1,l[2]=e+2);const{a:t,b:n,c:o}=vo;if(t.fromBufferAttribute(a,l[0]),n.fromBufferAttribute(a,l[1]),o.fromBufferAttribute(a,l[2]),vo.getNormal(go),c[0]=`${Math.round(t.x*r)},${Math.round(t.y*r)},${Math.round(t.z*r)}`,c[1]=`${Math.round(n.x*r)},${Math.round(n.y*r)},${Math.round(n.z*r)}`,c[2]=`${Math.round(o.x*r)},${Math.round(o.y*r)},${Math.round(o.z*r)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let e=0;e<3;e++){const t=(e+1)%3,n=c[e],r=c[t],s=vo[u[e]],a=vo[u[t]],o=`${n}_${r}`,f=`${r}_${n}`;f in d&&d[f]?(go.dot(d[f].normal)<=i&&(h.push(s.x,s.y,s.z),h.push(a.x,a.y,a.z)),d[f]=null):o in d||(d[o]={index0:l[e],index1:l[t],normal:go.clone()})}}for(const e in d)if(d[e]){const{index0:t,index1:n}=d[e];po.fromBufferAttribute(a,t),mo.fromBufferAttribute(a,n),h.push(po.x,po.y,po.z),h.push(mo.x,mo.y,mo.z)}this.setAttribute("position",new ui(h,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}}class bo extends so{constructor(e){super(e),this.uuid=Gt(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let n=0,r=this.holes.length;n<r;n++)t[n]=this.holes[n].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,n=e.holes.length;t<n;t++){const n=e.holes[t];this.holes.push(n.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,n=this.holes.length;t<n;t++){const n=this.holes[t];e.holes.push(n.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,n=e.holes.length;t<n;t++){const n=e.holes[t];this.holes.push((new so).fromJSON(n))}return this}}const _o=function(e,t,n=2){const r=t&&t.length,i=r?t[0]*n:e.length;let s=xo(e,0,i,n,!0);const a=[];if(!s||s.next===s.prev)return a;let o,l,u,c,d,h,f;if(r&&(s=function(e,t,n,r){const i=[];let s,a,o,l,u;for(s=0,a=t.length;s<a;s++)o=t[s]*r,l=s<a-1?t[s+1]*r:e.length,u=xo(e,o,l,r,!1),u===u.next&&(u.steiner=!0),i.push(Po(u));for(i.sort(Ro),s=0;s<i.length;s++)n=Co(i[s],n);return n}(e,t,s,n)),e.length>80*n){o=u=e[0],l=c=e[1];for(let t=n;t<i;t+=n)d=e[t],h=e[t+1],d<o&&(o=d),h<l&&(l=h),d>u&&(u=d),h>c&&(c=h);f=Math.max(u-o,c-l),f=0!==f?32767/f:0}return To(s,a,n,o,l,f,0),a};function xo(e,t,n,r,i){let s,a;if(i===function(e,t,n,r){let i=0;for(let s=t,a=n-r;s<n;s+=r)i+=(e[a]-e[s])*(e[s+1]+e[a+1]),a=s;return i}(e,t,n,r)>0)for(s=t;s<n;s+=r)a=Go(s,e[s],e[s+1],a);else for(s=n-r;s>=t;s-=r)a=Go(s,e[s],e[s+1],a);return a&&Oo(a,a.next)&&(Ho(a),a=a.next),a}function So(e,t){if(!e)return e;t||(t=e);let n,r=e;do{if(n=!1,r.steiner||!Oo(r,r.next)&&0!==ko(r.prev,r,r.next))r=r.next;else{if(Ho(r),r=t=r.prev,r===r.next)break;n=!0}}while(n||r!==t);return t}function To(e,t,n,r,i,s,a){if(!e)return;!a&&s&&function(e,t,n,r){let i=e;do{0===i.z&&(i.z=Lo(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){let t,n,r,i,s,a,o,l,u=1;do{for(n=e,e=null,s=null,a=0;n;){for(a++,r=n,o=0,t=0;t<u&&(o++,r=r.nextZ,r);t++);for(l=u;o>0||l>0&&r;)0!==o&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,o--):(i=r,r=r.nextZ,l--),s?s.nextZ=i:e=i,i.prevZ=s,s=i;n=r}s.nextZ=null,u*=2}while(a>1)}(i)}(e,r,i,s);let o,l,u=e;for(;e.prev!==e.next;)if(o=e.prev,l=e.next,s?Ao(e,r,i,s):Eo(e))t.push(o.i/n|0),t.push(e.i/n|0),t.push(l.i/n|0),Ho(e),e=l.next,u=l.next;else if((e=l)===u){a?1===a?To(e=wo(So(e),t,n),t,n,r,i,s,2):2===a&&Mo(e,t,n,r,i,s):To(So(e),t,n,r,i,s,1);break}}function Eo(e){const t=e.prev,n=e,r=e.next;if(ko(t,n,r)>=0)return!1;const i=t.x,s=n.x,a=r.x,o=t.y,l=n.y,u=r.y,c=i<s?i<a?i:a:s<a?s:a,d=o<l?o<u?o:u:l<u?l:u,h=i>s?i>a?i:a:s>a?s:a,f=o>l?o>u?o:u:l>u?l:u;let p=r.next;for(;p!==t;){if(p.x>=c&&p.x<=h&&p.y>=d&&p.y<=f&&No(i,o,s,l,a,u,p.x,p.y)&&ko(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function Ao(e,t,n,r){const i=e.prev,s=e,a=e.next;if(ko(i,s,a)>=0)return!1;const o=i.x,l=s.x,u=a.x,c=i.y,d=s.y,h=a.y,f=o<l?o<u?o:u:l<u?l:u,p=c<d?c<h?c:h:d<h?d:h,m=o>l?o>u?o:u:l>u?l:u,g=c>d?c>h?c:h:d>h?d:h,v=Lo(f,p,t,n,r),y=Lo(m,g,t,n,r);let b=e.prevZ,_=e.nextZ;for(;b&&b.z>=v&&_&&_.z<=y;){if(b.x>=f&&b.x<=m&&b.y>=p&&b.y<=g&&b!==i&&b!==a&&No(o,c,l,d,u,h,b.x,b.y)&&ko(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,_.x>=f&&_.x<=m&&_.y>=p&&_.y<=g&&_!==i&&_!==a&&No(o,c,l,d,u,h,_.x,_.y)&&ko(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(;b&&b.z>=v;){if(b.x>=f&&b.x<=m&&b.y>=p&&b.y<=g&&b!==i&&b!==a&&No(o,c,l,d,u,h,b.x,b.y)&&ko(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;_&&_.z<=y;){if(_.x>=f&&_.x<=m&&_.y>=p&&_.y<=g&&_!==i&&_!==a&&No(o,c,l,d,u,h,_.x,_.y)&&ko(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function wo(e,t,n){let r=e;do{const i=r.prev,s=r.next.next;!Oo(i,s)&&Fo(i,r,r.next,s)&&Vo(i,s)&&Vo(s,i)&&(t.push(i.i/n|0),t.push(r.i/n|0),t.push(s.i/n|0),Ho(r),Ho(r.next),r=e=s),r=r.next}while(r!==e);return So(r)}function Mo(e,t,n,r,i,s){let a=e;do{let e=a.next.next;for(;e!==a.prev;){if(a.i!==e.i&&Do(a,e)){let o=zo(a,e);return a=So(a,a.next),o=So(o,o.next),To(a,t,n,r,i,s,0),void To(o,t,n,r,i,s,0)}e=e.next}a=a.next}while(a!==e)}function Ro(e,t){return e.x-t.x}function Co(e,t){const n=function(e,t){let n,r=t,i=-1/0;const s=e.x,a=e.y;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){const e=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(e<=s&&e>i&&(i=e,n=r.x<r.next.x?r:r.next,e===s))return n}r=r.next}while(r!==t);if(!n)return null;const o=n,l=n.x,u=n.y;let c,d=1/0;r=n;do{s>=r.x&&r.x>=l&&s!==r.x&&No(a<u?s:i,a,l,u,a<u?i:s,a,r.x,r.y)&&(c=Math.abs(a-r.y)/(s-r.x),Vo(r,e)&&(c<d||c===d&&(r.x>n.x||r.x===n.x&&Io(n,r)))&&(n=r,d=c)),r=r.next}while(r!==o);return n}(e,t);if(!n)return t;const r=zo(n,e);return So(r,r.next),So(n,n.next)}function Io(e,t){return ko(e.prev,e,t.prev)<0&&ko(t.next,e,e.next)<0}function Lo(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Po(e){let t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function No(e,t,n,r,i,s,a,o){return(i-a)*(t-o)>=(e-a)*(s-o)&&(e-a)*(r-o)>=(n-a)*(t-o)&&(n-a)*(s-o)>=(i-a)*(r-o)}function Do(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&Fo(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(Vo(e,t)&&Vo(t,e)&&function(e,t){let n=e,r=!1;const i=(e.x+t.x)/2,s=(e.y+t.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&i<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)&&(ko(e.prev,e,t.prev)||ko(e,t.prev,t))||Oo(e,t)&&ko(e.prev,e,e.next)>0&&ko(t.prev,t,t.next)>0)}function ko(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function Oo(e,t){return e.x===t.x&&e.y===t.y}function Fo(e,t,n,r){const i=Bo(ko(e,t,n)),s=Bo(ko(e,t,r)),a=Bo(ko(n,r,e)),o=Bo(ko(n,r,t));return i!==s&&a!==o||(!(0!==i||!Uo(e,n,t))||(!(0!==s||!Uo(e,r,t))||(!(0!==a||!Uo(n,e,r))||!(0!==o||!Uo(n,t,r)))))}function Uo(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function Bo(e){return e>0?1:e<0?-1:0}function Vo(e,t){return ko(e.prev,e,e.next)<0?ko(e,t,e.next)>=0&&ko(e,e.prev,t)>=0:ko(e,t,e.prev)<0||ko(e,e.next,t)<0}function zo(e,t){const n=new $o(e.i,e.x,e.y),r=new $o(t.i,t.x,t.y),i=e.next,s=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function Go(e,t,n,r){const i=new $o(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function Ho(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function $o(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}class Wo{static area(e){const t=e.length;let n=0;for(let r=t-1,i=0;i<t;r=i++)n+=e[r].x*e[i].y-e[i].x*e[r].y;return.5*n}static isClockWise(e){return Wo.area(e)<0}static triangulateShape(e,t){const n=[],r=[],i=[];jo(e),qo(n,e);let s=e.length;t.forEach(jo);for(let e=0;e<t.length;e++)r.push(s),s+=t[e].length,qo(n,t[e]);const a=_o(n,r);for(let e=0;e<a.length;e+=3)i.push(a.slice(e,e+3));return i}}function jo(e){const t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function qo(e,t){for(let n=0;n<t.length;n++)e.push(t[n].x),e.push(t[n].y)}class Xo extends vi{constructor(e=new bo([new Yt(.5,.5),new Yt(-.5,.5),new Yt(-.5,-.5),new Yt(.5,-.5)]),t={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const n=this,r=[],i=[];for(let t=0,n=e.length;t<n;t++){s(e[t])}function s(e){const s=[],a=void 0!==t.curveSegments?t.curveSegments:12,o=void 0!==t.steps?t.steps:1,l=void 0!==t.depth?t.depth:1;let u=void 0===t.bevelEnabled||t.bevelEnabled,c=void 0!==t.bevelThickness?t.bevelThickness:.2,d=void 0!==t.bevelSize?t.bevelSize:c-.1,h=void 0!==t.bevelOffset?t.bevelOffset:0,f=void 0!==t.bevelSegments?t.bevelSegments:3;const p=t.extrudePath,m=void 0!==t.UVGenerator?t.UVGenerator:Yo;let g,v,y,b,_,x=!1;p&&(g=p.getSpacedPoints(o),x=!0,u=!1,v=p.computeFrenetFrames(o,!1),y=new An,b=new An,_=new An),u||(f=0,c=0,d=0,h=0);const S=e.extractPoints(a);let T=S.shape;const E=S.holes;if(!Wo.isClockWise(T)){T=T.reverse();for(let e=0,t=E.length;e<t;e++){const t=E[e];Wo.isClockWise(t)&&(E[e]=t.reverse())}}const A=Wo.triangulateShape(T,E),w=T;for(let e=0,t=E.length;e<t;e++){const t=E[e];T=T.concat(t)}function M(e,t,n){return e.clone().addScaledVector(t,n)}const R=T.length,C=A.length;function I(e,t,n){let r,i,s;const a=e.x-t.x,o=e.y-t.y,l=n.x-e.x,u=n.y-e.y,c=a*a+o*o,d=a*u-o*l;if(Math.abs(d)>Number.EPSILON){const d=Math.sqrt(c),h=Math.sqrt(l*l+u*u),f=t.x-o/d,p=t.y+a/d,m=((n.x-u/h-f)*u-(n.y+l/h-p)*l)/(a*u-o*l);r=f+a*m-e.x,i=p+o*m-e.y;const g=r*r+i*i;if(g<=2)return new Yt(r,i);s=Math.sqrt(g/2)}else{let e=!1;a>Number.EPSILON?l>Number.EPSILON&&(e=!0):a<-Number.EPSILON?l<-Number.EPSILON&&(e=!0):Math.sign(o)===Math.sign(u)&&(e=!0),e?(r=-o,i=a,s=Math.sqrt(c)):(r=a,i=o,s=Math.sqrt(c/2))}return new Yt(r/s,i/s)}const L=[];for(let e=0,t=w.length,n=t-1,r=e+1;e<t;e++,n++,r++)n===t&&(n=0),r===t&&(r=0),L[e]=I(w[e],w[n],w[r]);const P=[];let N,D=L.concat();for(let e=0,t=E.length;e<t;e++){const t=E[e];N=[];for(let e=0,n=t.length,r=n-1,i=e+1;e<n;e++,r++,i++)r===n&&(r=0),i===n&&(i=0),N[e]=I(t[e],t[r],t[i]);P.push(N),D=D.concat(N)}for(let e=0;e<f;e++){const t=e/f,n=c*Math.cos(t*Math.PI/2),r=d*Math.sin(t*Math.PI/2)+h;for(let e=0,t=w.length;e<t;e++){const t=M(w[e],L[e],r);F(t.x,t.y,-n)}for(let e=0,t=E.length;e<t;e++){const t=E[e];N=P[e];for(let e=0,i=t.length;e<i;e++){const i=M(t[e],N[e],r);F(i.x,i.y,-n)}}}const k=d+h;for(let e=0;e<R;e++){const t=u?M(T[e],D[e],k):T[e];x?(b.copy(v.normals[0]).multiplyScalar(t.x),y.copy(v.binormals[0]).multiplyScalar(t.y),_.copy(g[0]).add(b).add(y),F(_.x,_.y,_.z)):F(t.x,t.y,0)}for(let e=1;e<=o;e++)for(let t=0;t<R;t++){const n=u?M(T[t],D[t],k):T[t];x?(b.copy(v.normals[e]).multiplyScalar(n.x),y.copy(v.binormals[e]).multiplyScalar(n.y),_.copy(g[e]).add(b).add(y),F(_.x,_.y,_.z)):F(n.x,n.y,l/o*e)}for(let e=f-1;e>=0;e--){const t=e/f,n=c*Math.cos(t*Math.PI/2),r=d*Math.sin(t*Math.PI/2)+h;for(let e=0,t=w.length;e<t;e++){const t=M(w[e],L[e],r);F(t.x,t.y,l+n)}for(let e=0,t=E.length;e<t;e++){const t=E[e];N=P[e];for(let e=0,i=t.length;e<i;e++){const i=M(t[e],N[e],r);x?F(i.x,i.y+g[o-1].y,g[o-1].x+n):F(i.x,i.y,l+n)}}}function O(e,t){let n=e.length;for(;--n>=0;){const r=n;let i=n-1;i<0&&(i=e.length-1);for(let e=0,n=o+2*f;e<n;e++){const n=R*e,s=R*(e+1);B(t+r+n,t+i+n,t+i+s,t+r+s)}}}function F(e,t,n){s.push(e),s.push(t),s.push(n)}function U(e,t,i){V(e),V(t),V(i);const s=r.length/3,a=m.generateTopUV(n,r,s-3,s-2,s-1);z(a[0]),z(a[1]),z(a[2])}function B(e,t,i,s){V(e),V(t),V(s),V(t),V(i),V(s);const a=r.length/3,o=m.generateSideWallUV(n,r,a-6,a-3,a-2,a-1);z(o[0]),z(o[1]),z(o[3]),z(o[1]),z(o[2]),z(o[3])}function V(e){r.push(s[3*e+0]),r.push(s[3*e+1]),r.push(s[3*e+2])}function z(e){i.push(e.x),i.push(e.y)}!function(){const e=r.length/3;if(u){let e=0,t=R*e;for(let e=0;e<C;e++){const n=A[e];U(n[2]+t,n[1]+t,n[0]+t)}e=o+2*f,t=R*e;for(let e=0;e<C;e++){const n=A[e];U(n[0]+t,n[1]+t,n[2]+t)}}else{for(let e=0;e<C;e++){const t=A[e];U(t[2],t[1],t[0])}for(let e=0;e<C;e++){const t=A[e];U(t[0]+R*o,t[1]+R*o,t[2]+R*o)}}n.addGroup(e,r.length/3-e,0)}(),function(){const e=r.length/3;let t=0;O(w,t),t+=w.length;for(let e=0,n=E.length;e<n;e++){const n=E[e];O(n,t),t+=n.length}n.addGroup(e,r.length/3-e,1)}()}this.setAttribute("position",new ui(r,3)),this.setAttribute("uv",new ui(i,2)),this.computeVertexNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return function(e,t,n){if(n.shapes=[],Array.isArray(e))for(let t=0,r=e.length;t<r;t++){const r=e[t];n.shapes.push(r.uuid)}else n.shapes.push(e.uuid);n.options=Object.assign({},t),void 0!==t.extrudePath&&(n.options.extrudePath=t.extrudePath.toJSON());return n}(this.parameters.shapes,this.parameters.options,e)}static fromJSON(e,t){const n=[];for(let r=0,i=e.shapes.length;r<i;r++){const i=t[e.shapes[r]];n.push(i)}const r=e.options.extrudePath;return void 0!==r&&(e.options.extrudePath=(new ro[r.type]).fromJSON(r)),new Xo(n,e.options)}}const Yo={generateTopUV:function(e,t,n,r,i){const s=t[3*n],a=t[3*n+1],o=t[3*r],l=t[3*r+1],u=t[3*i],c=t[3*i+1];return[new Yt(s,a),new Yt(o,l),new Yt(u,c)]},generateSideWallUV:function(e,t,n,r,i,s){const a=t[3*n],o=t[3*n+1],l=t[3*n+2],u=t[3*r],c=t[3*r+1],d=t[3*r+2],h=t[3*i],f=t[3*i+1],p=t[3*i+2],m=t[3*s],g=t[3*s+1],v=t[3*s+2];return Math.abs(o-c)<Math.abs(a-u)?[new Yt(a,1-l),new Yt(u,1-d),new Yt(h,1-p),new Yt(m,1-v)]:[new Yt(o,1-l),new Yt(c,1-d),new Yt(f,1-p),new Yt(g,1-v)]}};class Ko extends ho{constructor(e=1,t=0){const n=(1+Math.sqrt(5))/2;super([-1,n,0,1,n,0,-1,-n,0,1,-n,0,0,-1,n,0,1,n,0,-1,-n,0,1,-n,n,0,-1,n,0,1,-n,0,-1,-n,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new Ko(e.radius,e.detail)}}class Qo extends ho{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new Qo(e.radius,e.detail)}}class Zo extends vi{constructor(e=1,t=1,n=1,r=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:r};const i=e/2,s=t/2,a=Math.floor(n),o=Math.floor(r),l=a+1,u=o+1,c=e/a,d=t/o,h=[],f=[],p=[],m=[];for(let e=0;e<u;e++){const t=e*d-s;for(let n=0;n<l;n++){const r=n*c-i;f.push(r,-t,0),p.push(0,0,1),m.push(n/a),m.push(1-e/o)}}for(let e=0;e<o;e++)for(let t=0;t<a;t++){const n=t+l*e,r=t+l*(e+1),i=t+1+l*(e+1),s=t+1+l*e;h.push(n,r,s),h.push(r,i,s)}this.setIndex(h),this.setAttribute("position",new ui(f,3)),this.setAttribute("normal",new ui(p,3)),this.setAttribute("uv",new ui(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Zo(e.width,e.height,e.widthSegments,e.heightSegments)}}class Jo extends vi{constructor(e=.5,t=1,n=32,r=1,i=0,s=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:n,phiSegments:r,thetaStart:i,thetaLength:s},n=Math.max(3,n);const a=[],o=[],l=[],u=[];let c=e;const d=(t-e)/(r=Math.max(1,r)),h=new An,f=new Yt;for(let e=0;e<=r;e++){for(let e=0;e<=n;e++){const r=i+e/n*s;h.x=c*Math.cos(r),h.y=c*Math.sin(r),o.push(h.x,h.y,h.z),l.push(0,0,1),f.x=(h.x/t+1)/2,f.y=(h.y/t+1)/2,u.push(f.x,f.y)}c+=d}for(let e=0;e<r;e++){const t=e*(n+1);for(let e=0;e<n;e++){const r=e+t,i=r,s=r+n+1,o=r+n+2,l=r+1;a.push(i,s,l),a.push(s,o,l)}}this.setIndex(a),this.setAttribute("position",new ui(o,3)),this.setAttribute("normal",new ui(l,3)),this.setAttribute("uv",new ui(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Jo(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength)}}class el extends vi{constructor(e=new bo([new Yt(0,.5),new Yt(-.5,-.5),new Yt(.5,-.5)]),t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const n=[],r=[],i=[],s=[];let a=0,o=0;if(!1===Array.isArray(e))l(e);else for(let t=0;t<e.length;t++)l(e[t]),this.addGroup(a,o,t),a+=o,o=0;function l(e){const a=r.length/3,l=e.extractPoints(t);let u=l.shape;const c=l.holes;!1===Wo.isClockWise(u)&&(u=u.reverse());for(let e=0,t=c.length;e<t;e++){const t=c[e];!0===Wo.isClockWise(t)&&(c[e]=t.reverse())}const d=Wo.triangulateShape(u,c);for(let e=0,t=c.length;e<t;e++){const t=c[e];u=u.concat(t)}for(let e=0,t=u.length;e<t;e++){const t=u[e];r.push(t.x,t.y,0),i.push(0,0,1),s.push(t.x,t.y)}for(let e=0,t=d.length;e<t;e++){const t=d[e],r=t[0]+a,i=t[1]+a,s=t[2]+a;n.push(r,i,s),o+=3}}this.setIndex(n),this.setAttribute("position",new ui(r,3)),this.setAttribute("normal",new ui(i,3)),this.setAttribute("uv",new ui(s,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return function(e,t){if(t.shapes=[],Array.isArray(e))for(let n=0,r=e.length;n<r;n++){const r=e[n];t.shapes.push(r.uuid)}else t.shapes.push(e.uuid);return t}(this.parameters.shapes,e)}static fromJSON(e,t){const n=[];for(let r=0,i=e.shapes.length;r<i;r++){const i=t[e.shapes[r]];n.push(i)}return new el(n,e.curveSegments)}}class tl extends vi{constructor(e=1,t=32,n=16,r=0,i=2*Math.PI,s=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:n,phiStart:r,phiLength:i,thetaStart:s,thetaLength:a},t=Math.max(3,Math.floor(t)),n=Math.max(2,Math.floor(n));const o=Math.min(s+a,Math.PI);let l=0;const u=[],c=new An,d=new An,h=[],f=[],p=[],m=[];for(let h=0;h<=n;h++){const g=[],v=h/n;let y=0;0===h&&0===s?y=.5/t:h===n&&o===Math.PI&&(y=-.5/t);for(let n=0;n<=t;n++){const o=n/t;c.x=-e*Math.cos(r+o*i)*Math.sin(s+v*a),c.y=e*Math.cos(s+v*a),c.z=e*Math.sin(r+o*i)*Math.sin(s+v*a),f.push(c.x,c.y,c.z),d.copy(c).normalize(),p.push(d.x,d.y,d.z),m.push(o+y,1-v),g.push(l++)}u.push(g)}for(let e=0;e<n;e++)for(let r=0;r<t;r++){const t=u[e][r+1],i=u[e][r],a=u[e+1][r],l=u[e+1][r+1];(0!==e||s>0)&&h.push(t,i,l),(e!==n-1||o<Math.PI)&&h.push(i,a,l)}this.setIndex(h),this.setAttribute("position",new ui(f,3)),this.setAttribute("normal",new ui(p,3)),this.setAttribute("uv",new ui(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new tl(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class nl extends ho{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new nl(e.radius,e.detail)}}class rl extends vi{constructor(e=1,t=.4,n=12,r=48,i=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:n,tubularSegments:r,arc:i},n=Math.floor(n),r=Math.floor(r);const s=[],a=[],o=[],l=[],u=new An,c=new An,d=new An;for(let s=0;s<=n;s++)for(let h=0;h<=r;h++){const f=h/r*i,p=s/n*Math.PI*2;c.x=(e+t*Math.cos(p))*Math.cos(f),c.y=(e+t*Math.cos(p))*Math.sin(f),c.z=t*Math.sin(p),a.push(c.x,c.y,c.z),u.x=e*Math.cos(f),u.y=e*Math.sin(f),d.subVectors(c,u).normalize(),o.push(d.x,d.y,d.z),l.push(h/r),l.push(s/n)}for(let e=1;e<=n;e++)for(let t=1;t<=r;t++){const n=(r+1)*e+t-1,i=(r+1)*(e-1)+t-1,a=(r+1)*(e-1)+t,o=(r+1)*e+t;s.push(n,i,o),s.push(i,a,o)}this.setIndex(s),this.setAttribute("position",new ui(a,3)),this.setAttribute("normal",new ui(o,3)),this.setAttribute("uv",new ui(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new rl(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc)}}class il extends vi{constructor(e=1,t=.4,n=64,r=8,i=2,s=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:n,radialSegments:r,p:i,q:s},n=Math.floor(n),r=Math.floor(r);const a=[],o=[],l=[],u=[],c=new An,d=new An,h=new An,f=new An,p=new An,m=new An,g=new An;for(let a=0;a<=n;++a){const y=a/n*i*Math.PI*2;v(y,i,s,e,h),v(y+.01,i,s,e,f),m.subVectors(f,h),g.addVectors(f,h),p.crossVectors(m,g),g.crossVectors(p,m),p.normalize(),g.normalize();for(let e=0;e<=r;++e){const i=e/r*Math.PI*2,s=-t*Math.cos(i),f=t*Math.sin(i);c.x=h.x+(s*g.x+f*p.x),c.y=h.y+(s*g.y+f*p.y),c.z=h.z+(s*g.z+f*p.z),o.push(c.x,c.y,c.z),d.subVectors(c,h).normalize(),l.push(d.x,d.y,d.z),u.push(a/n),u.push(e/r)}}for(let e=1;e<=n;e++)for(let t=1;t<=r;t++){const n=(r+1)*(e-1)+(t-1),i=(r+1)*e+(t-1),s=(r+1)*e+t,o=(r+1)*(e-1)+t;a.push(n,i,o),a.push(i,s,o)}function v(e,t,n,r,i){const s=Math.cos(e),a=Math.sin(e),o=n/t*e,l=Math.cos(o);i.x=r*(2+l)*.5*s,i.y=r*(2+l)*a*.5,i.z=r*Math.sin(o)*.5}this.setIndex(a),this.setAttribute("position",new ui(o,3)),this.setAttribute("normal",new ui(l,3)),this.setAttribute("uv",new ui(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new il(e.radius,e.tube,e.tubularSegments,e.radialSegments,e.p,e.q)}}class sl extends vi{constructor(e=new to(new An(-1,-1,0),new An(-1,1,0),new An(1,1,0)),t=64,n=1,r=8,i=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:n,radialSegments:r,closed:i};const s=e.computeFrenetFrames(t,i);this.tangents=s.tangents,this.normals=s.normals,this.binormals=s.binormals;const a=new An,o=new An,l=new Yt;let u=new An;const c=[],d=[],h=[],f=[];function p(i){u=e.getPointAt(i/t,u);const l=s.normals[i],h=s.binormals[i];for(let e=0;e<=r;e++){const t=e/r*Math.PI*2,i=Math.sin(t),s=-Math.cos(t);o.x=s*l.x+i*h.x,o.y=s*l.y+i*h.y,o.z=s*l.z+i*h.z,o.normalize(),d.push(o.x,o.y,o.z),a.x=u.x+n*o.x,a.y=u.y+n*o.y,a.z=u.z+n*o.z,c.push(a.x,a.y,a.z)}}!function(){for(let e=0;e<t;e++)p(e);p(!1===i?t:0),function(){for(let e=0;e<=t;e++)for(let n=0;n<=r;n++)l.x=e/t,l.y=n/r,h.push(l.x,l.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=r;t++){const n=(r+1)*(e-1)+(t-1),i=(r+1)*e+(t-1),s=(r+1)*e+t,a=(r+1)*(e-1)+t;f.push(n,i,a),f.push(i,s,a)}}()}(),this.setIndex(f),this.setAttribute("position",new ui(c,3)),this.setAttribute("normal",new ui(d,3)),this.setAttribute("uv",new ui(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return e.path=this.parameters.path.toJSON(),e}static fromJSON(e){return new sl((new ro[e.path.type]).fromJSON(e.path),e.tubularSegments,e.radius,e.radialSegments,e.closed)}}class al extends vi{constructor(e=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:e},null!==e){const t=[],n=new Set,r=new An,i=new An;if(null!==e.index){const s=e.attributes.position,a=e.index;let o=e.groups;0===o.length&&(o=[{start:0,count:a.count,materialIndex:0}]);for(let e=0,l=o.length;e<l;++e){const l=o[e],u=l.start;for(let e=u,o=u+l.count;e<o;e+=3)for(let o=0;o<3;o++){const l=a.getX(e+o),u=a.getX(e+(o+1)%3);r.fromBufferAttribute(s,l),i.fromBufferAttribute(s,u),!0===ol(r,i,n)&&(t.push(r.x,r.y,r.z),t.push(i.x,i.y,i.z))}}}else{const s=e.attributes.position;for(let e=0,a=s.count/3;e<a;e++)for(let a=0;a<3;a++){const o=3*e+a,l=3*e+(a+1)%3;r.fromBufferAttribute(s,o),i.fromBufferAttribute(s,l),!0===ol(r,i,n)&&(t.push(r.x,r.y,r.z),t.push(i.x,i.y,i.z))}}this.setAttribute("position",new ui(t,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}}function ol(e,t,n){const r=`${e.x},${e.y},${e.z}-${t.x},${t.y},${t.z}`,i=`${t.x},${t.y},${t.z}-${e.x},${e.y},${e.z}`;return!0!==n.has(r)&&!0!==n.has(i)&&(n.add(r),n.add(i),!0)}var ll=Object.freeze({__proto__:null,BoxGeometry:Li,CapsuleGeometry:oo,CircleGeometry:lo,ConeGeometry:co,CylinderGeometry:uo,DodecahedronGeometry:fo,EdgesGeometry:yo,ExtrudeGeometry:Xo,IcosahedronGeometry:Ko,LatheGeometry:ao,OctahedronGeometry:Qo,PlaneGeometry:Zo,PolyhedronGeometry:ho,RingGeometry:Jo,ShapeGeometry:el,SphereGeometry:tl,TetrahedronGeometry:nl,TorusGeometry:rl,TorusKnotGeometry:il,TubeGeometry:sl,WireframeGeometry:al});class ul extends Kr{constructor(e){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new qr(0),this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.fog=e.fog,this}}class cl extends Oi{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class dl extends Kr{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new qr(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new qr(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Yt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new dr,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class hl extends dl{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Yt(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return Ht(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new qr(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new qr(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new qr(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class fl extends Kr{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new qr(16777215),this.specular=new qr(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new qr(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Yt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new dr,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class pl extends Kr{constructor(e){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new qr(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new qr(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Yt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}class ml extends Kr{constructor(e){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Yt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}class gl extends Kr{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new qr(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new qr(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Yt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new dr,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class vl extends Kr{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class yl extends Kr{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}class bl extends Kr{constructor(e){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new qr(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Yt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this.fog=e.fog,this}}class _l extends ha{constructor(e){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}function xl(e,t,n){return!e||!n&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)}function Sl(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function Tl(e){const t=e.length,n=new Array(t);for(let e=0;e!==t;++e)n[e]=e;return n.sort(function(t,n){return e[t]-e[n]}),n}function El(e,t,n){const r=e.length,i=new e.constructor(r);for(let s=0,a=0;a!==r;++s){const r=n[s]*t;for(let n=0;n!==t;++n)i[a++]=e[r+n]}return i}function Al(e,t,n,r){let i=1,s=e[0];for(;void 0!==s&&void 0===s[r];)s=e[i++];if(void 0===s)return;let a=s[r];if(void 0!==a)if(Array.isArray(a))do{a=s[r],void 0!==a&&(t.push(s.time),n.push.apply(n,a)),s=e[i++]}while(void 0!==s);else if(void 0!==a.toArray)do{a=s[r],void 0!==a&&(t.push(s.time),a.toArray(n,n.length)),s=e[i++]}while(void 0!==s);else do{a=s[r],void 0!==a&&(t.push(s.time),n.push(a)),s=e[i++]}while(void 0!==s)}const wl={convertArray:xl,isTypedArray:Sl,getKeyframeOrder:Tl,sortedArray:El,flattenJSON:Al,subclip:function(e,t,n,r,i=30){const s=e.clone();s.name=t;const a=[];for(let e=0;e<s.tracks.length;++e){const t=s.tracks[e],o=t.getValueSize(),l=[],u=[];for(let e=0;e<t.times.length;++e){const s=t.times[e]*i;if(!(s<n||s>=r)){l.push(t.times[e]);for(let n=0;n<o;++n)u.push(t.values[e*o+n])}}0!==l.length&&(t.times=xl(l,t.times.constructor),t.values=xl(u,t.values.constructor),a.push(t))}s.tracks=a;let o=1/0;for(let e=0;e<s.tracks.length;++e)o>s.tracks[e].times[0]&&(o=s.tracks[e].times[0]);for(let e=0;e<s.tracks.length;++e)s.tracks[e].shift(-1*o);return s.resetDuration(),s},makeClipAdditive:function(e,t=0,n=e,r=30){r<=0&&(r=30);const i=n.tracks.length,s=t/r;for(let t=0;t<i;++t){const r=n.tracks[t],i=r.ValueTypeName;if("bool"===i||"string"===i)continue;const a=e.tracks.find(function(e){return e.name===r.name&&e.ValueTypeName===i});if(void 0===a)continue;let o=0;const l=r.getValueSize();r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(o=l/3);let u=0;const c=a.getValueSize();a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(u=c/3);const d=r.times.length-1;let h;if(s<=r.times[0]){const e=o,t=l-o;h=r.values.slice(e,t)}else if(s>=r.times[d]){const e=d*l+o,t=e+l-o;h=r.values.slice(e,t)}else{const e=r.createInterpolant(),t=o,n=l-o;e.evaluate(s),h=e.resultBuffer.slice(t,n)}if("quaternion"===i){(new En).fromArray(h).normalize().conjugate().toArray(h)}const f=a.times.length;for(let e=0;e<f;++e){const t=e*c+u;if("quaternion"===i)En.multiplyQuaternionsFlat(a.values,t,h,0,a.values,t);else{const e=c-2*u;for(let n=0;n<e;++n)a.values[t+n]-=h[n]}}}return e.blendMode=gt,e}};class Ml{constructor(e,t,n,r){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==r?r:new t.constructor(n),this.sampleValues=t,this.valueSize=n,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let n=this._cachedIndex,r=t[n],i=t[n-1];e:{t:{let s;n:{r:if(!(e<r)){for(let s=n+2;;){if(void 0===r){if(e<i)break r;return n=t.length,this._cachedIndex=n,this.copySampleValue_(n-1)}if(n===s)break;if(i=r,r=t[++n],e<r)break t}s=t.length;break n}if(!(e>=i)){const a=t[1];e<a&&(n=2,i=a);for(let s=n-2;;){if(void 0===i)return this._cachedIndex=0,this.copySampleValue_(0);if(n===s)break;if(r=i,i=t[--n-1],e>=i)break t}s=n,n=0;break n}break e}for(;n<s;){const r=n+s>>>1;e<t[r]?s=r:n=r+1}if(r=t[n],i=t[n-1],void 0===i)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===r)return n=t.length,this._cachedIndex=n,this.copySampleValue_(n-1)}this._cachedIndex=n,this.intervalChanged_(n,i,r)}return this.interpolate_(n,i,e,r)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r;for(let e=0;e!==r;++e)t[e]=n[i+e];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Rl extends Ml{constructor(e,t,n,r){super(e,t,n,r),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:ht,endingEnd:ht}}intervalChanged_(e,t,n){const r=this.parameterPositions;let i=e-2,s=e+1,a=r[i],o=r[s];if(void 0===a)switch(this.getSettings_().endingStart){case ft:i=e,a=2*t-n;break;case pt:i=r.length-2,a=t+r[i]-r[i+1];break;default:i=e,a=n}if(void 0===o)switch(this.getSettings_().endingEnd){case ft:s=e,o=2*n-t;break;case pt:s=1,o=n+r[1]-r[0];break;default:s=e-1,o=t}const l=.5*(n-t),u=this.valueSize;this._weightPrev=l/(t-a),this._weightNext=l/(o-n),this._offsetPrev=i*u,this._offsetNext=s*u}interpolate_(e,t,n,r){const i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,u=this._offsetPrev,c=this._offsetNext,d=this._weightPrev,h=this._weightNext,f=(n-t)/(r-t),p=f*f,m=p*f,g=-d*m+2*d*p-d*f,v=(1+d)*m+(-1.5-2*d)*p+(-.5+d)*f+1,y=(-1-h)*m+(1.5+h)*p+.5*f,b=h*m-h*p;for(let e=0;e!==a;++e)i[e]=g*s[u+e]+v*s[l+e]+y*s[o+e]+b*s[c+e];return i}}class Cl extends Ml{constructor(e,t,n,r){super(e,t,n,r)}interpolate_(e,t,n,r){const i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,u=(n-t)/(r-t),c=1-u;for(let e=0;e!==a;++e)i[e]=s[l+e]*c+s[o+e]*u;return i}}class Il extends Ml{constructor(e,t,n,r){super(e,t,n,r)}interpolate_(e){return this.copySampleValue_(e-1)}}class Ll{constructor(e,t,n,r){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=xl(t,this.TimeBufferType),this.values=xl(n,this.ValueBufferType),this.setInterpolation(r||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let n;if(t.toJSON!==this.toJSON)n=t.toJSON(e);else{n={name:e.name,times:xl(e.times,Array),values:xl(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(n.interpolation=t)}return n.type=e.ValueTypeName,n}InterpolantFactoryMethodDiscrete(e){return new Il(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new Cl(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new Rl(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case ut:t=this.InterpolantFactoryMethodDiscrete;break;case ct:t=this.InterpolantFactoryMethodLinear;break;case dt:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return ut;case this.InterpolantFactoryMethodLinear:return ct;case this.InterpolantFactoryMethodSmooth:return dt}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let n=0,r=t.length;n!==r;++n)t[n]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let n=0,r=t.length;n!==r;++n)t[n]*=e}return this}trim(e,t){const n=this.times,r=n.length;let i=0,s=r-1;for(;i!==r&&n[i]<e;)++i;for(;-1!==s&&n[s]>t;)--s;if(++s,0!==i||s!==r){i>=s&&(s=Math.max(s,1),i=s-1);const e=this.getValueSize();this.times=n.slice(i,s),this.values=this.values.slice(i*e,s*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!==0&&(e=!1);const n=this.times,r=this.values,i=n.length;0===i&&(e=!1);let s=null;for(let t=0;t!==i;t++){const r=n[t];if("number"==typeof r&&isNaN(r)){e=!1;break}if(null!==s&&s>r){e=!1;break}s=r}if(void 0!==r&&Sl(r))for(let t=0,n=r.length;t!==n;++t){const n=r[t];if(isNaN(n)){e=!1;break}}return e}optimize(){const e=this.times.slice(),t=this.values.slice(),n=this.getValueSize(),r=this.getInterpolation()===dt,i=e.length-1;let s=1;for(let a=1;a<i;++a){let i=!1;const o=e[a];if(o!==e[a+1]&&(1!==a||o!==e[0]))if(r)i=!0;else{const e=a*n,r=e-n,s=e+n;for(let a=0;a!==n;++a){const n=t[e+a];if(n!==t[r+a]||n!==t[s+a]){i=!0;break}}}if(i){if(a!==s){e[s]=e[a];const r=a*n,i=s*n;for(let e=0;e!==n;++e)t[i+e]=t[r+e]}++s}}if(i>0){e[s]=e[i];for(let e=i*n,r=s*n,a=0;a!==n;++a)t[r+a]=t[e+a];++s}return s!==e.length?(this.times=e.slice(0,s),this.values=t.slice(0,s*n)):(this.times=e,this.values=t),this}clone(){const e=this.times.slice(),t=this.values.slice(),n=new(0,this.constructor)(this.name,e,t);return n.createInterpolant=this.createInterpolant,n}}Ll.prototype.TimeBufferType=Float32Array,Ll.prototype.ValueBufferType=Float32Array,Ll.prototype.DefaultInterpolation=ct;class Pl extends Ll{constructor(e,t,n){super(e,t,n)}}Pl.prototype.ValueTypeName="bool",Pl.prototype.ValueBufferType=Array,Pl.prototype.DefaultInterpolation=ut,Pl.prototype.InterpolantFactoryMethodLinear=void 0,Pl.prototype.InterpolantFactoryMethodSmooth=void 0;class Nl extends Ll{}Nl.prototype.ValueTypeName="color";class Dl extends Ll{}Dl.prototype.ValueTypeName="number";class kl extends Ml{constructor(e,t,n,r){super(e,t,n,r)}interpolate_(e,t,n,r){const i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=(n-t)/(r-t);let l=e*a;for(let e=l+a;l!==e;l+=4)En.slerpFlat(i,0,s,l-a,s,l,o);return i}}class Ol extends Ll{InterpolantFactoryMethodLinear(e){return new kl(this.times,this.values,this.getValueSize(),e)}}Ol.prototype.ValueTypeName="quaternion",Ol.prototype.InterpolantFactoryMethodSmooth=void 0;class Fl extends Ll{constructor(e,t,n){super(e,t,n)}}Fl.prototype.ValueTypeName="string",Fl.prototype.ValueBufferType=Array,Fl.prototype.DefaultInterpolation=ut,Fl.prototype.InterpolantFactoryMethodLinear=void 0,Fl.prototype.InterpolantFactoryMethodSmooth=void 0;class Ul extends Ll{}Ul.prototype.ValueTypeName="vector";class Bl{constructor(e="",t=-1,n=[],r=2500){this.name=e,this.tracks=n,this.duration=t,this.blendMode=r,this.uuid=Gt(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],n=e.tracks,r=1/(e.fps||1);for(let e=0,i=n.length;e!==i;++e)t.push(Vl(n[e]).scale(r));const i=new this(e.name,e.duration,t,e.blendMode);return i.uuid=e.uuid,i}static toJSON(e){const t=[],n=e.tracks,r={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let e=0,r=n.length;e!==r;++e)t.push(Ll.toJSON(n[e]));return r}static CreateFromMorphTargetSequence(e,t,n,r){const i=t.length,s=[];for(let e=0;e<i;e++){let a=[],o=[];a.push((e+i-1)%i,e,(e+1)%i),o.push(0,1,0);const l=Tl(a);a=El(a,1,l),o=El(o,1,l),r||0!==a[0]||(a.push(i),o.push(o[0])),s.push(new Dl(".morphTargetInfluences["+t[e].name+"]",a,o).scale(1/n))}return new this(e,-1,s)}static findByName(e,t){let n=e;if(!Array.isArray(e)){const t=e;n=t.geometry&&t.geometry.animations||t.animations}for(let e=0;e<n.length;e++)if(n[e].name===t)return n[e];return null}static CreateClipsFromMorphTargetSequences(e,t,n){const r={},i=/^([\w-]*?)([\d]+)$/;for(let t=0,n=e.length;t<n;t++){const n=e[t],s=n.name.match(i);if(s&&s.length>1){const e=s[1];let t=r[e];t||(r[e]=t=[]),t.push(n)}}const s=[];for(const e in r)s.push(this.CreateFromMorphTargetSequence(e,r[e],t,n));return s}static parseAnimation(e,t){if(!e)return null;const n=function(e,t,n,r,i){if(0!==n.length){const s=[],a=[];Al(n,s,a,r),0!==s.length&&i.push(new e(t,s,a))}},r=[],i=e.name||"default",s=e.fps||30,a=e.blendMode;let o=e.length||-1;const l=e.hierarchy||[];for(let e=0;e<l.length;e++){const i=l[e].keys;if(i&&0!==i.length)if(i[0].morphTargets){const e={};let t;for(t=0;t<i.length;t++)if(i[t].morphTargets)for(let n=0;n<i[t].morphTargets.length;n++)e[i[t].morphTargets[n]]=-1;for(const n in e){const e=[],s=[];for(let r=0;r!==i[t].morphTargets.length;++r){const r=i[t];e.push(r.time),s.push(r.morphTarget===n?1:0)}r.push(new Dl(".morphTargetInfluence["+n+"]",e,s))}o=e.length*s}else{const s=".bones["+t[e].name+"]";n(Ul,s+".position",i,"pos",r),n(Ol,s+".quaternion",i,"rot",r),n(Ul,s+".scale",i,"scl",r)}}if(0===r.length)return null;return new this(i,o,r,a)}resetDuration(){let e=0;for(let t=0,n=this.tracks.length;t!==n;++t){const n=this.tracks[t];e=Math.max(e,n.times[n.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function Vl(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Dl;case"vector":case"vector2":case"vector3":case"vector4":return Ul;case"color":return Nl;case"quaternion":return Ol;case"bool":case"boolean":return Pl;case"string":return Fl}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){const t=[],n=[];Al(e.keys,t,n,"value"),e.times=t,e.values=n}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}const zl={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class Gl{constructor(e,t,n){const r=this;let i,s=!1,a=0,o=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=n,this.itemStart=function(e){o++,!1===s&&void 0!==r.onStart&&r.onStart(e,a,o),s=!0},this.itemEnd=function(e){a++,void 0!==r.onProgress&&r.onProgress(e,a,o),a===o&&(s=!1,void 0!==r.onLoad&&r.onLoad())},this.itemError=function(e){void 0!==r.onError&&r.onError(e)},this.resolveURL=function(e){return i?i(e):e},this.setURLModifier=function(e){return i=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,n=l.length;t<n;t+=2){const n=l[t],r=l[t+1];if(n.global&&(n.lastIndex=0),n.test(e))return r}return null}}}const Hl=new Gl;class $l{constructor(e){this.manager=void 0!==e?e:Hl,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const n=this;return new Promise(function(r,i){n.load(e,r,t,i)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}$l.DEFAULT_MATERIAL_NAME="__DEFAULT";const Wl={};class jl extends Error{constructor(e,t){super(e),this.response=t}}class ql extends $l{constructor(e){super(e)}load(e,t,n,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const i=zl.get(e);if(void 0!==i)return this.manager.itemStart(e),setTimeout(()=>{t&&t(i),this.manager.itemEnd(e)},0),i;if(void 0!==Wl[e])return void Wl[e].push({onLoad:t,onProgress:n,onError:r});Wl[e]=[],Wl[e].push({onLoad:t,onProgress:n,onError:r});const s=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,o=this.responseType;fetch(s).then(t=>{if(200===t.status||0===t.status){if(t.status,"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;const n=Wl[e],r=t.body.getReader(),i=t.headers.get("X-File-Size")||t.headers.get("Content-Length"),s=i?parseInt(i):0,a=0!==s;let o=0;const l=new ReadableStream({start(e){!function t(){r.read().then(({done:r,value:i})=>{if(r)e.close();else{o+=i.byteLength;const r=new ProgressEvent("progress",{lengthComputable:a,loaded:o,total:s});for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onProgress&&t.onProgress(r)}e.enqueue(i),t()}},t=>{e.error(t)})}()}});return new Response(l)}throw new jl(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)}).then(e=>{switch(o){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then(e=>(new DOMParser).parseFromString(e,a));case"json":return e.json();default:if(void 0===a)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(a),n=t&&t[1]?t[1].toLowerCase():void 0,r=new TextDecoder(n);return e.arrayBuffer().then(e=>r.decode(e))}}}).then(t=>{zl.add(e,t);const n=Wl[e];delete Wl[e];for(let e=0,r=n.length;e<r;e++){const r=n[e];r.onLoad&&r.onLoad(t)}}).catch(t=>{const n=Wl[e];if(void 0===n)throw this.manager.itemError(e),t;delete Wl[e];for(let e=0,r=n.length;e<r;e++){const r=n[e];r.onError&&r.onError(t)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class Xl extends $l{constructor(e){super(e)}load(e,t,n,r){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,s=zl.get(e);if(void 0!==s)return i.manager.itemStart(e),setTimeout(function(){t&&t(s),i.manager.itemEnd(e)},0),s;const a=tn("img");function o(){u(),zl.add(e,this),t&&t(this),i.manager.itemEnd(e)}function l(t){u(),r&&r(t),i.manager.itemError(e),i.manager.itemEnd(e)}function u(){a.removeEventListener("load",o,!1),a.removeEventListener("error",l,!1)}return a.addEventListener("load",o,!1),a.addEventListener("error",l,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),i.manager.itemStart(e),a.src=e,a}}class Yl extends $l{constructor(e){super(e)}load(e,t,n,r){const i=new yn,s=new Xl(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,function(e){i.image=e,i.needsUpdate=!0,void 0!==t&&t(i)},n,r),i}}class Kl extends Rr{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new qr(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}class Ql extends Kl{constructor(e,t,n){super(e,n),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(Rr.DEFAULT_UP),this.updateMatrix(),this.groundColor=new qr(t)}copy(e,t){return super.copy(e,t),this.groundColor.copy(e.groundColor),this}}const Zl=new tr,Jl=new An,eu=new An;class tu{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Yt(512,512),this.map=null,this.mapPass=null,this.matrix=new tr,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new qs,this._frameExtents=new Yt(1,1),this._viewportCount=1,this._viewports=[new bn(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,n=this.matrix;Jl.setFromMatrixPosition(e.matrixWorld),t.position.copy(Jl),eu.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(eu),t.updateMatrixWorld(),Zl.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Zl),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(Zl)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class nu extends tu{constructor(){super(new zi(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(e){const t=this.camera,n=2*zt*e.angle*this.focus,r=this.mapSize.width/this.mapSize.height,i=e.distance||t.far;n===t.fov&&r===t.aspect&&i===t.far||(t.fov=n,t.aspect=r,t.far=i,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class ru extends Kl{constructor(e,t,n=0,r=Math.PI/3,i=0,s=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Rr.DEFAULT_UP),this.updateMatrix(),this.target=new Rr,this.distance=n,this.angle=r,this.penumbra=i,this.decay=s,this.map=null,this.shadow=new nu}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}const iu=new tr,su=new An,au=new An;class ou extends tu{constructor(){super(new zi(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new Yt(4,2),this._viewportCount=6,this._viewports=[new bn(2,1,1,1),new bn(0,1,1,1),new bn(3,1,1,1),new bn(1,1,1,1),new bn(3,0,1,1),new bn(1,0,1,1)],this._cubeDirections=[new An(1,0,0),new An(-1,0,0),new An(0,0,1),new An(0,0,-1),new An(0,1,0),new An(0,-1,0)],this._cubeUps=[new An(0,1,0),new An(0,1,0),new An(0,1,0),new An(0,1,0),new An(0,0,1),new An(0,0,-1)]}updateMatrices(e,t=0){const n=this.camera,r=this.matrix,i=e.distance||n.far;i!==n.far&&(n.far=i,n.updateProjectionMatrix()),su.setFromMatrixPosition(e.matrixWorld),n.position.copy(su),au.copy(n.position),au.add(this._cubeDirections[t]),n.up.copy(this._cubeUps[t]),n.lookAt(au),n.updateMatrixWorld(),r.makeTranslation(-su.x,-su.y,-su.z),iu.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),this._frustum.setFromProjectionMatrix(iu)}}class lu extends Kl{constructor(e,t,n=0,r=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=n,this.decay=r,this.shadow=new ou}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}class uu extends Fi{constructor(e=-1,t=1,n=1,r=-1,i=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=r,this.near=i,this.far=s,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,n,r,i,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=r,this.view.width=i,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,r=(this.top+this.bottom)/2;let i=n-e,s=n+e,a=r+t,o=r-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;i+=e*this.view.offsetX,s=i+e*this.view.width,a-=t*this.view.offsetY,o=a-t*this.view.height}this.projectionMatrix.makeOrthographic(i,s,a,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}class cu extends tu{constructor(){super(new uu(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class du extends Kl{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Rr.DEFAULT_UP),this.updateMatrix(),this.target=new Rr,this.shadow=new cu}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class hu extends Kl{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class fu extends Kl{constructor(e,t,n=10,r=10){super(e,t),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=n,this.height=r}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}class pu{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new An)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){const n=e.x,r=e.y,i=e.z,s=this.coefficients;return t.copy(s[0]).multiplyScalar(.282095),t.addScaledVector(s[1],.488603*r),t.addScaledVector(s[2],.488603*i),t.addScaledVector(s[3],.488603*n),t.addScaledVector(s[4],n*r*1.092548),t.addScaledVector(s[5],r*i*1.092548),t.addScaledVector(s[6],.315392*(3*i*i-1)),t.addScaledVector(s[7],n*i*1.092548),t.addScaledVector(s[8],.546274*(n*n-r*r)),t}getIrradianceAt(e,t){const n=e.x,r=e.y,i=e.z,s=this.coefficients;return t.copy(s[0]).multiplyScalar(.886227),t.addScaledVector(s[1],1.023328*r),t.addScaledVector(s[2],1.023328*i),t.addScaledVector(s[3],1.023328*n),t.addScaledVector(s[4],.858086*n*r),t.addScaledVector(s[5],.858086*r*i),t.addScaledVector(s[6],.743125*i*i-.247708),t.addScaledVector(s[7],.858086*n*i),t.addScaledVector(s[8],.429043*(n*n-r*r)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let n=0;n<9;n++)this.coefficients[n].addScaledVector(e.coefficients[n],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let n=0;n<9;n++)this.coefficients[n].lerp(e.coefficients[n],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){const n=this.coefficients;for(let r=0;r<9;r++)n[r].fromArray(e,t+3*r);return this}toArray(e=[],t=0){const n=this.coefficients;for(let r=0;r<9;r++)n[r].toArray(e,t+3*r);return e}static getBasisAt(e,t){const n=e.x,r=e.y,i=e.z;t[0]=.282095,t[1]=.488603*r,t[2]=.488603*i,t[3]=.488603*n,t[4]=1.092548*n*r,t[5]=1.092548*r*i,t[6]=.315392*(3*i*i-1),t[7]=1.092548*n*i,t[8]=.546274*(n*n-r*r)}}class mu extends Kl{constructor(e=new pu,t=1){super(void 0,t),this.isLightProbe=!0,this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){const t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}}class gu extends $l{constructor(e){super(e),this.textures={}}load(e,t,n,r){const i=this,s=new ql(i.manager);s.setPath(i.path),s.setRequestHeader(i.requestHeader),s.setWithCredentials(i.withCredentials),s.load(e,function(n){try{t(i.parse(JSON.parse(n)))}catch(t){r&&r(t),i.manager.itemError(e)}},n,r)}parse(e){const t=this.textures;function n(e){return t[e],t[e]}const r=this.createMaterialFromType(e.type);if(void 0!==e.uuid&&(r.uuid=e.uuid),void 0!==e.name&&(r.name=e.name),void 0!==e.color&&void 0!==r.color&&r.color.setHex(e.color),void 0!==e.roughness&&(r.roughness=e.roughness),void 0!==e.metalness&&(r.metalness=e.metalness),void 0!==e.sheen&&(r.sheen=e.sheen),void 0!==e.sheenColor&&(r.sheenColor=(new qr).setHex(e.sheenColor)),void 0!==e.sheenRoughness&&(r.sheenRoughness=e.sheenRoughness),void 0!==e.emissive&&void 0!==r.emissive&&r.emissive.setHex(e.emissive),void 0!==e.specular&&void 0!==r.specular&&r.specular.setHex(e.specular),void 0!==e.specularIntensity&&(r.specularIntensity=e.specularIntensity),void 0!==e.specularColor&&void 0!==r.specularColor&&r.specularColor.setHex(e.specularColor),void 0!==e.shininess&&(r.shininess=e.shininess),void 0!==e.clearcoat&&(r.clearcoat=e.clearcoat),void 0!==e.clearcoatRoughness&&(r.clearcoatRoughness=e.clearcoatRoughness),void 0!==e.dispersion&&(r.dispersion=e.dispersion),void 0!==e.iridescence&&(r.iridescence=e.iridescence),void 0!==e.iridescenceIOR&&(r.iridescenceIOR=e.iridescenceIOR),void 0!==e.iridescenceThicknessRange&&(r.iridescenceThicknessRange=e.iridescenceThicknessRange),void 0!==e.transmission&&(r.transmission=e.transmission),void 0!==e.thickness&&(r.thickness=e.thickness),void 0!==e.attenuationDistance&&(r.attenuationDistance=e.attenuationDistance),void 0!==e.attenuationColor&&void 0!==r.attenuationColor&&r.attenuationColor.setHex(e.attenuationColor),void 0!==e.anisotropy&&(r.anisotropy=e.anisotropy),void 0!==e.anisotropyRotation&&(r.anisotropyRotation=e.anisotropyRotation),void 0!==e.fog&&(r.fog=e.fog),void 0!==e.flatShading&&(r.flatShading=e.flatShading),void 0!==e.blending&&(r.blending=e.blending),void 0!==e.combine&&(r.combine=e.combine),void 0!==e.side&&(r.side=e.side),void 0!==e.shadowSide&&(r.shadowSide=e.shadowSide),void 0!==e.opacity&&(r.opacity=e.opacity),void 0!==e.transparent&&(r.transparent=e.transparent),void 0!==e.alphaTest&&(r.alphaTest=e.alphaTest),void 0!==e.alphaHash&&(r.alphaHash=e.alphaHash),void 0!==e.depthFunc&&(r.depthFunc=e.depthFunc),void 0!==e.depthTest&&(r.depthTest=e.depthTest),void 0!==e.depthWrite&&(r.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(r.colorWrite=e.colorWrite),void 0!==e.blendSrc&&(r.blendSrc=e.blendSrc),void 0!==e.blendDst&&(r.blendDst=e.blendDst),void 0!==e.blendEquation&&(r.blendEquation=e.blendEquation),void 0!==e.blendSrcAlpha&&(r.blendSrcAlpha=e.blendSrcAlpha),void 0!==e.blendDstAlpha&&(r.blendDstAlpha=e.blendDstAlpha),void 0!==e.blendEquationAlpha&&(r.blendEquationAlpha=e.blendEquationAlpha),void 0!==e.blendColor&&void 0!==r.blendColor&&r.blendColor.setHex(e.blendColor),void 0!==e.blendAlpha&&(r.blendAlpha=e.blendAlpha),void 0!==e.stencilWriteMask&&(r.stencilWriteMask=e.stencilWriteMask),void 0!==e.stencilFunc&&(r.stencilFunc=e.stencilFunc),void 0!==e.stencilRef&&(r.stencilRef=e.stencilRef),void 0!==e.stencilFuncMask&&(r.stencilFuncMask=e.stencilFuncMask),void 0!==e.stencilFail&&(r.stencilFail=e.stencilFail),void 0!==e.stencilZFail&&(r.stencilZFail=e.stencilZFail),void 0!==e.stencilZPass&&(r.stencilZPass=e.stencilZPass),void 0!==e.stencilWrite&&(r.stencilWrite=e.stencilWrite),void 0!==e.wireframe&&(r.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(r.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(r.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(r.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(r.rotation=e.rotation),void 0!==e.linewidth&&(r.linewidth=e.linewidth),void 0!==e.dashSize&&(r.dashSize=e.dashSize),void 0!==e.gapSize&&(r.gapSize=e.gapSize),void 0!==e.scale&&(r.scale=e.scale),void 0!==e.polygonOffset&&(r.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(r.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(r.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.dithering&&(r.dithering=e.dithering),void 0!==e.alphaToCoverage&&(r.alphaToCoverage=e.alphaToCoverage),void 0!==e.premultipliedAlpha&&(r.premultipliedAlpha=e.premultipliedAlpha),void 0!==e.forceSinglePass&&(r.forceSinglePass=e.forceSinglePass),void 0!==e.visible&&(r.visible=e.visible),void 0!==e.toneMapped&&(r.toneMapped=e.toneMapped),void 0!==e.userData&&(r.userData=e.userData),void 0!==e.vertexColors&&("number"==typeof e.vertexColors?r.vertexColors=e.vertexColors>0:r.vertexColors=e.vertexColors),void 0!==e.uniforms)for(const t in e.uniforms){const i=e.uniforms[t];switch(r.uniforms[t]={},i.type){case"t":r.uniforms[t].value=n(i.value);break;case"c":r.uniforms[t].value=(new qr).setHex(i.value);break;case"v2":r.uniforms[t].value=(new Yt).fromArray(i.value);break;case"v3":r.uniforms[t].value=(new An).fromArray(i.value);break;case"v4":r.uniforms[t].value=(new bn).fromArray(i.value);break;case"m3":r.uniforms[t].value=(new Kt).fromArray(i.value);break;case"m4":r.uniforms[t].value=(new tr).fromArray(i.value);break;default:r.uniforms[t].value=i.value}}if(void 0!==e.defines&&(r.defines=e.defines),void 0!==e.vertexShader&&(r.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(r.fragmentShader=e.fragmentShader),void 0!==e.glslVersion&&(r.glslVersion=e.glslVersion),void 0!==e.extensions)for(const t in e.extensions)r.extensions[t]=e.extensions[t];if(void 0!==e.lights&&(r.lights=e.lights),void 0!==e.clipping&&(r.clipping=e.clipping),void 0!==e.size&&(r.size=e.size),void 0!==e.sizeAttenuation&&(r.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(r.map=n(e.map)),void 0!==e.matcap&&(r.matcap=n(e.matcap)),void 0!==e.alphaMap&&(r.alphaMap=n(e.alphaMap)),void 0!==e.bumpMap&&(r.bumpMap=n(e.bumpMap)),void 0!==e.bumpScale&&(r.bumpScale=e.bumpScale),void 0!==e.normalMap&&(r.normalMap=n(e.normalMap)),void 0!==e.normalMapType&&(r.normalMapType=e.normalMapType),void 0!==e.normalScale){let t=e.normalScale;!1===Array.isArray(t)&&(t=[t,t]),r.normalScale=(new Yt).fromArray(t)}return void 0!==e.displacementMap&&(r.displacementMap=n(e.displacementMap)),void 0!==e.displacementScale&&(r.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(r.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(r.roughnessMap=n(e.roughnessMap)),void 0!==e.metalnessMap&&(r.metalnessMap=n(e.metalnessMap)),void 0!==e.emissiveMap&&(r.emissiveMap=n(e.emissiveMap)),void 0!==e.emissiveIntensity&&(r.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(r.specularMap=n(e.specularMap)),void 0!==e.specularIntensityMap&&(r.specularIntensityMap=n(e.specularIntensityMap)),void 0!==e.specularColorMap&&(r.specularColorMap=n(e.specularColorMap)),void 0!==e.envMap&&(r.envMap=n(e.envMap)),void 0!==e.envMapRotation&&r.envMapRotation.fromArray(e.envMapRotation),void 0!==e.envMapIntensity&&(r.envMapIntensity=e.envMapIntensity),void 0!==e.reflectivity&&(r.reflectivity=e.reflectivity),void 0!==e.refractionRatio&&(r.refractionRatio=e.refractionRatio),void 0!==e.lightMap&&(r.lightMap=n(e.lightMap)),void 0!==e.lightMapIntensity&&(r.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(r.aoMap=n(e.aoMap)),void 0!==e.aoMapIntensity&&(r.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(r.gradientMap=n(e.gradientMap)),void 0!==e.clearcoatMap&&(r.clearcoatMap=n(e.clearcoatMap)),void 0!==e.clearcoatRoughnessMap&&(r.clearcoatRoughnessMap=n(e.clearcoatRoughnessMap)),void 0!==e.clearcoatNormalMap&&(r.clearcoatNormalMap=n(e.clearcoatNormalMap)),void 0!==e.clearcoatNormalScale&&(r.clearcoatNormalScale=(new Yt).fromArray(e.clearcoatNormalScale)),void 0!==e.iridescenceMap&&(r.iridescenceMap=n(e.iridescenceMap)),void 0!==e.iridescenceThicknessMap&&(r.iridescenceThicknessMap=n(e.iridescenceThicknessMap)),void 0!==e.transmissionMap&&(r.transmissionMap=n(e.transmissionMap)),void 0!==e.thicknessMap&&(r.thicknessMap=n(e.thicknessMap)),void 0!==e.anisotropyMap&&(r.anisotropyMap=n(e.anisotropyMap)),void 0!==e.sheenColorMap&&(r.sheenColorMap=n(e.sheenColorMap)),void 0!==e.sheenRoughnessMap&&(r.sheenRoughnessMap=n(e.sheenRoughnessMap)),r}setTextures(e){return this.textures=e,this}createMaterialFromType(e){return gu.createMaterialFromType(e)}static createMaterialFromType(e){return new{ShadowMaterial:ul,SpriteMaterial:Zi,RawShaderMaterial:cl,ShaderMaterial:Oi,PointsMaterial:wa,MeshPhysicalMaterial:hl,MeshStandardMaterial:dl,MeshPhongMaterial:fl,MeshToonMaterial:pl,MeshNormalMaterial:ml,MeshLambertMaterial:gl,MeshDepthMaterial:vl,MeshDistanceMaterial:yl,MeshBasicMaterial:Qr,MeshMatcapMaterial:bl,LineDashedMaterial:_l,LineBasicMaterial:ha,Material:Kr}[e]}}class vu{static decodeText(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let n=0,r=e.length;n<r;n++)t+=String.fromCharCode(e[n]);try{return decodeURIComponent(escape(t))}catch(e){return t}}static extractUrlBase(e){const t=e.lastIndexOf("/");return-1===t?"./":e.slice(0,t+1)}static resolveURL(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}}class yu extends vi{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(e){return super.copy(e),this.instanceCount=e.instanceCount,this}toJSON(){const e=super.toJSON();return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}class bu extends $l{constructor(e){super(e)}load(e,t,n,r){const i=this,s=new ql(i.manager);s.setPath(i.path),s.setRequestHeader(i.requestHeader),s.setWithCredentials(i.withCredentials),s.load(e,function(n){try{t(i.parse(JSON.parse(n)))}catch(t){r&&r(t),i.manager.itemError(e)}},n,r)}parse(e){const t={},n={};function r(e,r){if(void 0!==t[r])return t[r];const i=e.interleavedBuffers[r],s=function(e,t){if(void 0!==n[t])return n[t];const r=e.arrayBuffers,i=r[t],s=new Uint32Array(i).buffer;return n[t]=s,s}(e,i.buffer),a=en(i.type,s),o=new Yi(a,i.stride);return o.uuid=i.uuid,t[r]=o,o}const i=e.isInstancedBufferGeometry?new yu:new vi,s=e.data.index;if(void 0!==s){const e=en(s.type,s.array);i.setIndex(new si(e,1))}const a=e.data.attributes;for(const t in a){const n=a[t];let s;if(n.isInterleavedBufferAttribute){const t=r(e.data,n.data);s=new Qi(t,n.itemSize,n.offset,n.normalized)}else{const e=en(n.type,n.array);s=new(n.isInstancedBufferAttribute?Ps:si)(e,n.itemSize,n.normalized)}void 0!==n.name&&(s.name=n.name),void 0!==n.usage&&s.setUsage(n.usage),i.setAttribute(t,s)}const o=e.data.morphAttributes;if(o)for(const t in o){const n=o[t],s=[];for(let t=0,i=n.length;t<i;t++){const i=n[t];let a;if(i.isInterleavedBufferAttribute){const t=r(e.data,i.data);a=new Qi(t,i.itemSize,i.offset,i.normalized)}else{const e=en(i.type,i.array);a=new si(e,i.itemSize,i.normalized)}void 0!==i.name&&(a.name=i.name),s.push(a)}i.morphAttributes[t]=s}e.data.morphTargetsRelative&&(i.morphTargetsRelative=!0);const l=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==l)for(let e=0,t=l.length;e!==t;++e){const t=l[e];i.addGroup(t.start,t.count,t.materialIndex)}const u=e.data.boundingSphere;if(void 0!==u){const e=new An;void 0!==u.center&&e.fromArray(u.center),i.boundingSphere=new jn(e,u.radius)}return e.name&&(i.name=e.name),e.userData&&(i.userData=e.userData),i}}class _u extends $l{constructor(e){super(e)}load(e,t,n,r){const i=this,s=""===this.path?vu.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||s;const a=new ql(this.manager);a.setPath(this.path),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(n){let s=null;try{s=JSON.parse(n)}catch(e){return void(void 0!==r&&r(e))}const a=s.metadata;void 0!==a&&void 0!==a.type&&"geometry"!==a.type.toLowerCase()?i.parse(s,t):void 0!==r&&r(new Error("THREE.ObjectLoader: Can't load "+e))},n,r)}async loadAsync(e,t){const n=""===this.path?vu.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||n;const r=new ql(this.manager);r.setPath(this.path),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials);const i=await r.loadAsync(e,t),s=JSON.parse(i),a=s.metadata;if(void 0===a||void 0===a.type||"geometry"===a.type.toLowerCase())throw new Error("THREE.ObjectLoader: Can't load "+e);return await this.parseAsync(s)}parse(e,t){const n=this.parseAnimations(e.animations),r=this.parseShapes(e.shapes),i=this.parseGeometries(e.geometries,r),s=this.parseImages(e.images,function(){void 0!==t&&t(l)}),a=this.parseTextures(e.textures,s),o=this.parseMaterials(e.materials,a),l=this.parseObject(e.object,i,o,a,n),u=this.parseSkeletons(e.skeletons,l);if(this.bindSkeletons(l,u),this.bindLightTargets(l),void 0!==t){let e=!1;for(const t in s)if(s[t].data instanceof HTMLImageElement){e=!0;break}!1===e&&t(l)}return l}async parseAsync(e){const t=this.parseAnimations(e.animations),n=this.parseShapes(e.shapes),r=this.parseGeometries(e.geometries,n),i=await this.parseImagesAsync(e.images),s=this.parseTextures(e.textures,i),a=this.parseMaterials(e.materials,s),o=this.parseObject(e.object,r,a,s,t),l=this.parseSkeletons(e.skeletons,o);return this.bindSkeletons(o,l),this.bindLightTargets(o),o}parseShapes(e){const t={};if(void 0!==e)for(let n=0,r=e.length;n<r;n++){const r=(new bo).fromJSON(e[n]);t[r.uuid]=r}return t}parseSkeletons(e,t){const n={},r={};if(t.traverse(function(e){e.isBone&&(r[e.uuid]=e)}),void 0!==e)for(let t=0,i=e.length;t<i;t++){const i=(new Ls).fromJSON(e[t],r);n[i.uuid]=i}return n}parseGeometries(e,t){const n={};if(void 0!==e){const r=new bu;for(let i=0,s=e.length;i<s;i++){let s;const a=e[i];switch(a.type){case"BufferGeometry":case"InstancedBufferGeometry":s=r.parse(a);break;default:a.type in ll&&(s=ll[a.type].fromJSON(a,t))}s.uuid=a.uuid,void 0!==a.name&&(s.name=a.name),void 0!==a.userData&&(s.userData=a.userData),n[a.uuid]=s}}return n}parseMaterials(e,t){const n={},r={};if(void 0!==e){const i=new gu;i.setTextures(t);for(let t=0,s=e.length;t<s;t++){const s=e[t];void 0===n[s.uuid]&&(n[s.uuid]=i.parse(s)),r[s.uuid]=n[s.uuid]}}return r}parseAnimations(e){const t={};if(void 0!==e)for(let n=0;n<e.length;n++){const r=e[n],i=Bl.parse(r);t[i.uuid]=i}return t}parseImages(e,t){const n=this,r={};let i;function s(e){if("string"==typeof e){const t=e;return function(e){return n.manager.itemStart(e),i.load(e,function(){n.manager.itemEnd(e)},void 0,function(){n.manager.itemError(e),n.manager.itemEnd(e)})}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(t)?t:n.resourcePath+t)}return e.data?{data:en(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){const n=new Gl(t);i=new Xl(n),i.setCrossOrigin(this.crossOrigin);for(let t=0,n=e.length;t<n;t++){const n=e[t],i=n.url;if(Array.isArray(i)){const e=[];for(let t=0,n=i.length;t<n;t++){const n=s(i[t]);null!==n&&(n instanceof HTMLImageElement?e.push(n):e.push(new Rs(n.data,n.width,n.height)))}r[n.uuid]=new mn(e)}else{const e=s(n.url);r[n.uuid]=new mn(e)}}}return r}async parseImagesAsync(e){const t=this,n={};let r;async function i(e){if("string"==typeof e){const n=e,i=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(n)?n:t.resourcePath+n;return await r.loadAsync(i)}return e.data?{data:en(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){r=new Xl(this.manager),r.setCrossOrigin(this.crossOrigin);for(let t=0,r=e.length;t<r;t++){const r=e[t],s=r.url;if(Array.isArray(s)){const e=[];for(let t=0,n=s.length;t<n;t++){const n=s[t],r=await i(n);null!==r&&(r instanceof HTMLImageElement?e.push(r):e.push(new Rs(r.data,r.width,r.height)))}n[r.uuid]=new mn(e)}else{const e=await i(r.url);n[r.uuid]=new mn(e)}}}return n}parseTextures(e,t){function n(e,t){return"number"==typeof e?e:t[e]}const r={};if(void 0!==e)for(let i=0,s=e.length;i<s;i++){const s=e[i];s.image,t[s.image];const a=t[s.image],o=a.data;let l;Array.isArray(o)?(l=new $i,6===o.length&&(l.needsUpdate=!0)):(l=o&&o.data?new Rs:new yn,o&&(l.needsUpdate=!0)),l.source=a,l.uuid=s.uuid,void 0!==s.name&&(l.name=s.name),void 0!==s.mapping&&(l.mapping=n(s.mapping,xu)),void 0!==s.channel&&(l.channel=s.channel),void 0!==s.offset&&l.offset.fromArray(s.offset),void 0!==s.repeat&&l.repeat.fromArray(s.repeat),void 0!==s.center&&l.center.fromArray(s.center),void 0!==s.rotation&&(l.rotation=s.rotation),void 0!==s.wrap&&(l.wrapS=n(s.wrap[0],Su),l.wrapT=n(s.wrap[1],Su)),void 0!==s.format&&(l.format=s.format),void 0!==s.internalFormat&&(l.internalFormat=s.internalFormat),void 0!==s.type&&(l.type=s.type),void 0!==s.colorSpace&&(l.colorSpace=s.colorSpace),void 0!==s.minFilter&&(l.minFilter=n(s.minFilter,Tu)),void 0!==s.magFilter&&(l.magFilter=n(s.magFilter,Tu)),void 0!==s.anisotropy&&(l.anisotropy=s.anisotropy),void 0!==s.flipY&&(l.flipY=s.flipY),void 0!==s.generateMipmaps&&(l.generateMipmaps=s.generateMipmaps),void 0!==s.premultiplyAlpha&&(l.premultiplyAlpha=s.premultiplyAlpha),void 0!==s.unpackAlignment&&(l.unpackAlignment=s.unpackAlignment),void 0!==s.compareFunction&&(l.compareFunction=s.compareFunction),void 0!==s.userData&&(l.userData=s.userData),r[s.uuid]=l}return r}parseObject(e,t,n,r,i){let s,a,o;function l(e){return t[e],t[e]}function u(e){if(void 0!==e){if(Array.isArray(e)){const t=[];for(let r=0,i=e.length;r<i;r++){const i=e[r];n[i],t.push(n[i])}return t}return n[e],n[e]}}function c(e){return r[e],r[e]}switch(e.type){case"Scene":s=new Xi,void 0!==e.background&&(Number.isInteger(e.background)?s.background=new qr(e.background):s.background=c(e.background)),void 0!==e.environment&&(s.environment=c(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?s.fog=new qi(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(s.fog=new ji(e.fog.color,e.fog.density)),""!==e.fog.name&&(s.fog.name=e.fog.name)),void 0!==e.backgroundBlurriness&&(s.backgroundBlurriness=e.backgroundBlurriness),void 0!==e.backgroundIntensity&&(s.backgroundIntensity=e.backgroundIntensity),void 0!==e.backgroundRotation&&s.backgroundRotation.fromArray(e.backgroundRotation),void 0!==e.environmentIntensity&&(s.environmentIntensity=e.environmentIntensity),void 0!==e.environmentRotation&&s.environmentRotation.fromArray(e.environmentRotation);break;case"PerspectiveCamera":s=new zi(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(s.focus=e.focus),void 0!==e.zoom&&(s.zoom=e.zoom),void 0!==e.filmGauge&&(s.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(s.filmOffset=e.filmOffset),void 0!==e.view&&(s.view=Object.assign({},e.view));break;case"OrthographicCamera":s=new uu(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(s.zoom=e.zoom),void 0!==e.view&&(s.view=Object.assign({},e.view));break;case"AmbientLight":s=new hu(e.color,e.intensity);break;case"DirectionalLight":s=new du(e.color,e.intensity),s.target=e.target||"";break;case"PointLight":s=new lu(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":s=new fu(e.color,e.intensity,e.width,e.height);break;case"SpotLight":s=new ru(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay),s.target=e.target||"";break;case"HemisphereLight":s=new Ql(e.color,e.groundColor,e.intensity);break;case"LightProbe":s=(new mu).fromJSON(e);break;case"SkinnedMesh":a=l(e.geometry),o=u(e.material),s=new ws(a,o),void 0!==e.bindMode&&(s.bindMode=e.bindMode),void 0!==e.bindMatrix&&s.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(s.skeleton=e.skeleton);break;case"Mesh":a=l(e.geometry),o=u(e.material),s=new Ci(a,o);break;case"InstancedMesh":a=l(e.geometry),o=u(e.material);const t=e.count,n=e.instanceMatrix,r=e.instanceColor;s=new Vs(a,o,t),s.instanceMatrix=new Ps(new Float32Array(n.array),16),void 0!==r&&(s.instanceColor=new Ps(new Float32Array(r.array),r.itemSize));break;case"BatchedMesh":a=l(e.geometry),o=u(e.material),s=new da(e.maxInstanceCount,e.maxVertexCount,e.maxIndexCount,o),s.geometry=a,s.perObjectFrustumCulled=e.perObjectFrustumCulled,s.sortObjects=e.sortObjects,s._drawRanges=e.drawRanges,s._reservedRanges=e.reservedRanges,s._visibility=e.visibility,s._active=e.active,s._bounds=e.bounds.map(e=>{const t=new Rn;t.min.fromArray(e.boxMin),t.max.fromArray(e.boxMax);const n=new jn;return n.radius=e.sphereRadius,n.center.fromArray(e.sphereCenter),{boxInitialized:e.boxInitialized,box:t,sphereInitialized:e.sphereInitialized,sphere:n}}),s._maxInstanceCount=e.maxInstanceCount,s._maxVertexCount=e.maxVertexCount,s._maxIndexCount=e.maxIndexCount,s._geometryInitialized=e.geometryInitialized,s._geometryCount=e.geometryCount,s._matricesTexture=c(e.matricesTexture.uuid),void 0!==e.colorsTexture&&(s._colorsTexture=c(e.colorsTexture.uuid));break;case"LOD":s=new gs;break;case"Line":s=new _a(l(e.geometry),u(e.material));break;case"LineLoop":s=new Aa(l(e.geometry),u(e.material));break;case"LineSegments":s=new Ea(l(e.geometry),u(e.material));break;case"PointCloud":case"Points":s=new La(l(e.geometry),u(e.material));break;case"Sprite":s=new hs(u(e.material));break;case"Group":s=new Na;break;case"Bone":s=new Ms;break;default:s=new Rr}if(s.uuid=e.uuid,void 0!==e.name&&(s.name=e.name),void 0!==e.matrix?(s.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(s.matrixAutoUpdate=e.matrixAutoUpdate),s.matrixAutoUpdate&&s.matrix.decompose(s.position,s.quaternion,s.scale)):(void 0!==e.position&&s.position.fromArray(e.position),void 0!==e.rotation&&s.rotation.fromArray(e.rotation),void 0!==e.quaternion&&s.quaternion.fromArray(e.quaternion),void 0!==e.scale&&s.scale.fromArray(e.scale)),void 0!==e.up&&s.up.fromArray(e.up),void 0!==e.castShadow&&(s.castShadow=e.castShadow),void 0!==e.receiveShadow&&(s.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.intensity&&(s.shadow.intensity=e.shadow.intensity),void 0!==e.shadow.bias&&(s.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(s.shadow.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(s.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&s.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(s.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(s.visible=e.visible),void 0!==e.frustumCulled&&(s.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(s.renderOrder=e.renderOrder),void 0!==e.userData&&(s.userData=e.userData),void 0!==e.layers&&(s.layers.mask=e.layers),void 0!==e.children){const a=e.children;for(let e=0;e<a.length;e++)s.add(this.parseObject(a[e],t,n,r,i))}if(void 0!==e.animations){const t=e.animations;for(let e=0;e<t.length;e++){const n=t[e];s.animations.push(i[n])}}if("LOD"===e.type){void 0!==e.autoUpdate&&(s.autoUpdate=e.autoUpdate);const t=e.levels;for(let e=0;e<t.length;e++){const n=t[e],r=s.getObjectByProperty("uuid",n.object);void 0!==r&&s.addLevel(r,n.distance,n.hysteresis)}}return s}bindSkeletons(e,t){0!==Object.keys(t).length&&e.traverse(function(e){if(!0===e.isSkinnedMesh&&void 0!==e.skeleton){const n=t[e.skeleton];void 0===n||e.bind(n,e.bindMatrix)}})}bindLightTargets(e){e.traverse(function(t){if(t.isDirectionalLight||t.isSpotLight){const n=t.target,r=e.getObjectByProperty("uuid",n);t.target=void 0!==r?r:new Rr}})}}const xu={UVMapping:j,CubeReflectionMapping:q,CubeRefractionMapping:X,EquirectangularReflectionMapping:Y,EquirectangularRefractionMapping:K,CubeUVReflectionMapping:Q},Su={RepeatWrapping:Z,ClampToEdgeWrapping:J,MirroredRepeatWrapping:ee},Tu={NearestFilter:te,NearestMipmapNearestFilter:ne,NearestMipmapLinearFilter:re,LinearFilter:ie,LinearMipmapNearestFilter:se,LinearMipmapLinearFilter:ae};let Eu;class Au{static getContext(){return void 0===Eu&&(Eu=new(window.AudioContext||window.webkitAudioContext)),Eu}static setContext(e){Eu=e}}const wu=new tr,Mu=new tr,Ru=new tr;class Cu extends zi{constructor(e=[]){super(),this.isArrayCamera=!0,this.cameras=e}}class Iu{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=Lu(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=Lu();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}function Lu(){return performance.now()}const Pu=new An,Nu=new En,Du=new An,ku=new An;class Ou extends Rr{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(!0===this.isPlaying)return;if(!1===this.hasPlaybackControl)return;this._startedAt=this.context.currentTime+e;const t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.onended=this.onEnded.bind(this),t.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=t,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this}stop(e=0){if(!1!==this.hasPlaybackControl)return this._progress=0,null!==this.source&&(this.source.stop(this.context.currentTime+e),this.source.onended=null),this.isPlaying=!1,this}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(!1!==this._connected){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}}getFilters(){return this.filters}setFilters(e){return e||(e=[]),!0===this._connected?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){return this.detune=e,!0===this.isPlaying&&void 0!==this.source.detune&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1,this._progress=0}getLoop(){return!1!==this.hasPlaybackControl&&this.loop}setLoop(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}copy(e,t){return super.copy(e,t),"buffer"!==e.sourceType||(this.autoplay=e.autoplay,this.buffer=e.buffer,this.detune=e.detune,this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.offset=e.offset,this.duration=e.duration,this.playbackRate=e.playbackRate,this.hasPlaybackControl=e.hasPlaybackControl,this.sourceType=e.sourceType,this.filters=e.filters.slice()),this}clone(e){return new this.constructor(this.listener).copy(this,e)}}const Fu=new An,Uu=new En,Bu=new An,Vu=new An;class zu{constructor(e,t,n){let r,i,s;switch(this.binding=e,this.valueSize=n,t){case"quaternion":r=this._slerp,i=this._slerpAdditive,s=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*n),this._workIndex=5;break;case"string":case"bool":r=this._select,i=this._select,s=this._setAdditiveIdentityOther,this.buffer=new Array(5*n);break;default:r=this._lerp,i=this._lerpAdditive,s=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*n)}this._mixBufferRegion=r,this._mixBufferRegionAdditive=i,this._setIdentity=s,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,t){const n=this.buffer,r=this.valueSize,i=e*r+r;let s=this.cumulativeWeight;if(0===s){for(let e=0;e!==r;++e)n[i+e]=n[e];s=t}else{s+=t;const e=t/s;this._mixBufferRegion(n,i,0,e,r)}this.cumulativeWeight=s}accumulateAdditive(e){const t=this.buffer,n=this.valueSize,r=n*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(t,r,0,e,n),this.cumulativeWeightAdditive+=e}apply(e){const t=this.valueSize,n=this.buffer,r=e*t+t,i=this.cumulativeWeight,s=this.cumulativeWeightAdditive,a=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,i<1){const e=t*this._origIndex;this._mixBufferRegion(n,r,e,1-i,t)}s>0&&this._mixBufferRegionAdditive(n,r,this._addIndex*t,1,t);for(let e=t,i=t+t;e!==i;++e)if(n[e]!==n[e+t]){a.setValue(n,r);break}}saveOriginalState(){const e=this.binding,t=this.buffer,n=this.valueSize,r=n*this._origIndex;e.getValue(t,r);for(let e=n,i=r;e!==i;++e)t[e]=t[r+e%n];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const e=3*this.valueSize;this.binding.setValue(this.buffer,e)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,t=e+this.valueSize;for(let n=e;n<t;n++)this.buffer[n]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,t=this._addIndex*this.valueSize;for(let n=0;n<this.valueSize;n++)this.buffer[t+n]=this.buffer[e+n]}_select(e,t,n,r,i){if(r>=.5)for(let r=0;r!==i;++r)e[t+r]=e[n+r]}_slerp(e,t,n,r){En.slerpFlat(e,t,e,t,e,n,r)}_slerpAdditive(e,t,n,r,i){const s=this._workIndex*i;En.multiplyQuaternionsFlat(e,s,e,t,e,n),En.slerpFlat(e,t,e,t,e,s,r)}_lerp(e,t,n,r,i){const s=1-r;for(let a=0;a!==i;++a){const i=t+a;e[i]=e[i]*s+e[n+a]*r}}_lerpAdditive(e,t,n,r,i){for(let s=0;s!==i;++s){const i=t+s;e[i]=e[i]+e[n+s]*r}}}const Gu="\\[\\]\\.:\\/",Hu=new RegExp("["+Gu+"]","g"),$u="[^"+Gu+"]",Wu="[^"+Gu.replace("\\.","")+"]",ju=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",$u)+/(WCOD+)?/.source.replace("WCOD",Wu)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",$u)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",$u)+"$"),qu=["material","materials","bones","map"];class Xu{constructor(e,t,n){this.path=t,this.parsedPath=n||Xu.parseTrackName(t),this.node=Xu.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,n){return e&&e.isAnimationObjectGroup?new Xu.Composite(e,t,n):new Xu(e,t,n)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(Hu,"")}static parseTrackName(e){const t=ju.exec(e);if(null===t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const n={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},r=n.nodeName&&n.nodeName.lastIndexOf(".");if(void 0!==r&&-1!==r){const e=n.nodeName.substring(r+1);-1!==qu.indexOf(e)&&(n.nodeName=n.nodeName.substring(0,r),n.objectName=e)}if(null===n.propertyName||0===n.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return n}static findNode(e,t){if(void 0===t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const n=e.skeleton.getBoneByName(t);if(void 0!==n)return n}if(e.children){const n=function(e){for(let r=0;r<e.length;r++){const i=e[r];if(i.name===t||i.uuid===t)return i;const s=n(i.children);if(s)return s}return null},r=n(e.children);if(r)return r}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const n=this.resolvedProperty;for(let r=0,i=n.length;r!==i;++r)e[t++]=n[r]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const n=this.resolvedProperty;for(let r=0,i=n.length;r!==i;++r)n[r]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const n=this.resolvedProperty;for(let r=0,i=n.length;r!==i;++r)n[r]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const n=this.resolvedProperty;for(let r=0,i=n.length;r!==i;++r)n[r]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,n=t.objectName,r=t.propertyName;let i=t.propertyIndex;if(e||(e=Xu.findNode(this.rootNode,t.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return;if(n){let r=t.objectIndex;switch(n){case"materials":if(!e.material)return;if(!e.material.materials)return;e=e.material.materials;break;case"bones":if(!e.skeleton)return;e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===r){r=t;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material)return;if(!e.material.map)return;e=e.material.map;break;default:if(void 0===e[n])return;e=e[n]}if(void 0!==r){if(void 0===e[r])return;e=e[r]}}const s=e[r];if(void 0===s){t.nodeName;return}let a=this.Versioning.None;this.targetObject=e,!0===e.isMaterial?a=this.Versioning.NeedsUpdate:!0===e.isObject3D&&(a=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==i){if("morphTargetInfluences"===r){if(!e.geometry)return;if(!e.geometry.morphAttributes)return;void 0!==e.morphTargetDictionary[i]&&(i=e.morphTargetDictionary[i])}o=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=i}else void 0!==s.fromArray&&void 0!==s.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(o=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=r;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][a]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}Xu.Composite=class{constructor(e,t,n){const r=n||Xu.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,r)}getValue(e,t){this.bind();const n=this._targetGroup.nCachedObjects_,r=this._bindings[n];void 0!==r&&r.getValue(e,t)}setValue(e,t){const n=this._bindings;for(let r=this._targetGroup.nCachedObjects_,i=n.length;r!==i;++r)n[r].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].unbind()}},Xu.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Xu.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},Xu.prototype.GetterByBindingType=[Xu.prototype._getValue_direct,Xu.prototype._getValue_array,Xu.prototype._getValue_arrayElement,Xu.prototype._getValue_toArray],Xu.prototype.SetterByBindingTypeAndVersioning=[[Xu.prototype._setValue_direct,Xu.prototype._setValue_direct_setNeedsUpdate,Xu.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[Xu.prototype._setValue_array,Xu.prototype._setValue_array_setNeedsUpdate,Xu.prototype._setValue_array_setMatrixWorldNeedsUpdate],[Xu.prototype._setValue_arrayElement,Xu.prototype._setValue_arrayElement_setNeedsUpdate,Xu.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[Xu.prototype._setValue_fromArray,Xu.prototype._setValue_fromArray_setNeedsUpdate,Xu.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class Yu{constructor(e,t,n=null,r=t.blendMode){this._mixer=e,this._clip=t,this._localRoot=n,this.blendMode=r;const i=t.tracks,s=i.length,a=new Array(s),o={endingStart:ht,endingEnd:ht};for(let e=0;e!==s;++e){const t=i[e].createInterpolant(null);a[e]=t,t.settings=o}this._interpolantSettings=o,this._interpolants=a,this._propertyBindings=new Array(s),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=2201,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,t){return this.loop=e,this.repetitions=t,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,t,n){if(e.fadeOut(t),this.fadeIn(t),n){const n=this._clip.duration,r=e._clip.duration,i=r/n,s=n/r;e.warp(1,i,t),this.warp(s,1,t)}return this}crossFadeTo(e,t,n){return e.crossFadeFrom(this,t,n)}stopFading(){const e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,t,n){const r=this._mixer,i=r.time,s=this.timeScale;let a=this._timeScaleInterpolant;null===a&&(a=r._lendControlInterpolant(),this._timeScaleInterpolant=a);const o=a.parameterPositions,l=a.sampleValues;return o[0]=i,o[1]=i+n,l[0]=e/s,l[1]=t/s,this}stopWarping(){const e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,t,n,r){if(!this.enabled)return void this._updateWeight(e);const i=this._startTime;if(null!==i){const r=(e-i)*n;r<0||0===n?t=0:(this._startTime=null,t=n*r)}t*=this._updateTimeScale(e);const s=this._updateTime(t),a=this._updateWeight(e);if(a>0){const e=this._interpolants,t=this._propertyBindings;if(this.blendMode===gt)for(let n=0,r=e.length;n!==r;++n)e[n].evaluate(s),t[n].accumulateAdditive(a);else for(let n=0,i=e.length;n!==i;++n)e[n].evaluate(s),t[n].accumulate(r,a)}}_updateWeight(e){let t=0;if(this.enabled){t=this.weight;const n=this._weightInterpolant;if(null!==n){const r=n.evaluate(e)[0];t*=r,e>n.parameterPositions[1]&&(this.stopFading(),0===r&&(this.enabled=!1))}}return this._effectiveWeight=t,t}_updateTimeScale(e){let t=0;if(!this.paused){t=this.timeScale;const n=this._timeScaleInterpolant;if(null!==n){t*=n.evaluate(e)[0],e>n.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t}_updateTime(e){const t=this._clip.duration,n=this.loop;let r=this.time+e,i=this._loopCount;const s=2202===n;if(0===e)return-1===i||!s||1&~i?r:t-r;if(2200===n){-1===i&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(r>=t)r=t;else{if(!(r<0)){this.time=r;break e}r=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=r,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(-1===i&&(e>=0?(i=0,this._setEndings(!0,0===this.repetitions,s)):this._setEndings(0===this.repetitions,!0,s)),r>=t||r<0){const n=Math.floor(r/t);r-=t*n,i+=Math.abs(n);const a=this.repetitions-i;if(a<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,r=e>0?t:0,this.time=r,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(1===a){const t=e<0;this._setEndings(t,!t,s)}else this._setEndings(!1,!1,s);this._loopCount=i,this.time=r,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:n})}}else this.time=r;if(s&&!(1&~i))return t-r}return r}_setEndings(e,t,n){const r=this._interpolantSettings;n?(r.endingStart=ft,r.endingEnd=ft):(r.endingStart=e?this.zeroSlopeAtStart?ft:ht:pt,r.endingEnd=t?this.zeroSlopeAtEnd?ft:ht:pt)}_scheduleFading(e,t,n){const r=this._mixer,i=r.time;let s=this._weightInterpolant;null===s&&(s=r._lendControlInterpolant(),this._weightInterpolant=s);const a=s.parameterPositions,o=s.sampleValues;return a[0]=i,o[0]=t,a[1]=i+e,o[1]=n,this}}const Ku=new Float32Array(1);class Qu{constructor(e){this.value=e}clone(){return new Qu(void 0===this.value.clone?this.value:this.value.clone())}}let Zu=0;class Ju extends Yi{constructor(e,t,n=1){super(e,t),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){const t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}const ec=new tr;class tc{constructor(e,t,n=0,r=1/0){this.ray=new er(e,t),this.near=n,this.far=r,this.camera=null,this.layers=new hr,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera&&(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t)}setFromXRController(e){return ec.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(ec),this}intersectObject(e,t=!0,n=[]){return rc(e,this,n,t),n.sort(nc),n}intersectObjects(e,t=!0,n=[]){for(let r=0,i=e.length;r<i;r++)rc(e[r],this,n,t);return n.sort(nc),n}}function nc(e,t){return e.distance-t.distance}function rc(e,t,n,r){let i=!0;if(e.layers.test(t.layers)){!1===e.raycast(t,n)&&(i=!1)}if(!0===i&&!0===r){const r=e.children;for(let e=0,i=r.length;e<i;e++)rc(r[e],t,n,!0)}}class ic{constructor(e=1,t=0,n=0){return this.radius=e,this.phi=t,this.theta=n,this}set(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=Ht(this.phi,e,Math.PI-e),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,n){return this.radius=Math.sqrt(e*e+t*t+n*n),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,n),this.phi=Math.acos(Ht(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class sc{constructor(e,t,n,r){sc.prototype.isMatrix2=!0,this.elements=[1,0,0,1],void 0!==e&&this.set(e,t,n,r)}identity(){return this.set(1,0,0,1),this}fromArray(e,t=0){for(let n=0;n<4;n++)this.elements[n]=e[n+t];return this}set(e,t,n,r){const i=this.elements;return i[0]=e,i[2]=t,i[1]=n,i[3]=r,this}}const ac=new Yt;const oc=new An,lc=new An;const uc=new An;const cc=new An,dc=new tr,hc=new tr;function fc(e){const t=[];!0===e.isBone&&t.push(e);for(let n=0;n<e.children.length;n++)t.push.apply(t,fc(e.children[n]));return t}const pc=new An,mc=new qr,gc=new qr;const vc=new An,yc=new An,bc=new An;const _c=new An,xc=new Fi;function Sc(e,t,n,r,i,s,a){_c.set(i,s,a).unproject(r);const o=t[e];if(void 0!==o){const e=n.getAttribute("position");for(let t=0,n=o.length;t<n;t++)e.setXYZ(o[t],_c.x,_c.y,_c.z)}}const Tc=new Rn;const Ec=new An;let Ac,wc;function Mc(e,t,n,r){const i=function(e){switch(e){case oe:case le:return{byteLength:1,components:1};case ce:case ue:case pe:return{byteLength:2,components:1};case me:case ge:return{byteLength:2,components:4};case he:case de:case fe:return{byteLength:4,components:1};case ye:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${e}.`)}(r);switch(n){case be:case Se:return e*t;case Te:return e*t*2;case we:case Me:return e*t/i.components*i.byteLength;case Re:case Ce:return e*t*2/i.components*i.byteLength;case _e:return e*t*3/i.components*i.byteLength;case xe:case Ie:return e*t*4/i.components*i.byteLength;case Le:case Pe:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Ne:case De:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case Oe:case Ue:return Math.max(e,16)*Math.max(t,8)/4;case ke:case Fe:return Math.max(e,8)*Math.max(t,8)/2;case Be:case Ve:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case ze:case Ge:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case He:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case $e:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case We:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case je:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case qe:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case Xe:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case Ye:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case Ke:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case Qe:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case Ze:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case Je:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case et:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case tt:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case nt:case rt:case it:return Math.ceil(e/4)*Math.ceil(t/4)*16;case st:case at:return Math.ceil(e/4)*Math.ceil(t/4)*8;case ot:case lt:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${n} format.`)}const Rc={contain:function(e,t){const n=e.image&&e.image.width?e.image.width/e.image.height:1;return n>t?(e.repeat.x=1,e.repeat.y=n/t,e.offset.x=0,e.offset.y=(1-e.repeat.y)/2):(e.repeat.x=t/n,e.repeat.y=1,e.offset.x=(1-e.repeat.x)/2,e.offset.y=0),e},cover:function(e,t){const n=e.image&&e.image.width?e.image.width/e.image.height:1;return n>t?(e.repeat.x=t/n,e.repeat.y=1,e.offset.x=(1-e.repeat.x)/2,e.offset.y=0):(e.repeat.x=1,e.repeat.y=n/t,e.offset.x=0,e.offset.y=(1-e.repeat.y)/2),e},fill:function(e){return e.repeat.x=1,e.repeat.y=1,e.offset.x=0,e.offset.y=0,e},getByteLength:Mc};function Cc(){let e=null,t=!1,n=null,r=null;function i(t,s){n(t,s),r=e.requestAnimationFrame(i)}return{start:function(){!0!==t&&null!==n&&(r=e.requestAnimationFrame(i),t=!0)},stop:function(){e.cancelAnimationFrame(r),t=!1},setAnimationLoop:function(e){n=e},setContext:function(t){e=t}}}function Ic(e){const t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(n){n.isInterleavedBufferAttribute&&(n=n.data);const r=t.get(n);r&&(e.deleteBuffer(r.buffer),t.delete(n))},update:function(n,r){if(n.isInterleavedBufferAttribute&&(n=n.data),n.isGLBufferAttribute){const e=t.get(n);return void((!e||e.version<n.version)&&t.set(n,{buffer:n.buffer,type:n.type,bytesPerElement:n.elementSize,version:n.version}))}const i=t.get(n);if(void 0===i)t.set(n,function(t,n){const r=t.array,i=t.usage,s=r.byteLength,a=e.createBuffer();let o;if(e.bindBuffer(n,a),e.bufferData(n,r,i),t.onUploadCallback(),r instanceof Float32Array)o=e.FLOAT;else if(r instanceof Uint16Array)o=t.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(r instanceof Int16Array)o=e.SHORT;else if(r instanceof Uint32Array)o=e.UNSIGNED_INT;else if(r instanceof Int32Array)o=e.INT;else if(r instanceof Int8Array)o=e.BYTE;else if(r instanceof Uint8Array)o=e.UNSIGNED_BYTE;else{if(!(r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+r);o=e.UNSIGNED_BYTE}return{buffer:a,type:o,bytesPerElement:r.BYTES_PER_ELEMENT,version:t.version,size:s}}(n,r));else if(i.version<n.version){if(i.size!==n.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,n,r){const i=n.array,s=n.updateRanges;if(e.bindBuffer(r,t),0===s.length)e.bufferSubData(r,0,i);else{s.sort((e,t)=>e.start-t.start);let t=0;for(let e=1;e<s.length;e++){const n=s[t],r=s[e];r.start<=n.start+n.count+1?n.count=Math.max(n.count,r.start+r.count-n.start):(++t,s[t]=r)}s.length=t+1;for(let t=0,n=s.length;t<n;t++){const n=s[t];e.bufferSubData(r,n.start*i.BYTES_PER_ELEMENT,i,n.start,n.count)}n.clearUpdateRanges()}n.onUploadCallback()}(i.buffer,n,r),i.version=n.version}}}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:h}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__=h));const Lc={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\t#if ! defined( GL_ANGLE_multi_draw )\n\t#define gl_DrawID _gl_DrawID\n\tuniform int _gl_DrawID;\n\t#endif\n\tuniform highp sampler2D batchingTexture;\n\tuniform highp usampler2D batchingIdTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n\tfloat getIndirectIndex( const in int i ) {\n\t\tint size = textureSize( batchingIdTexture, 0 ).x;\n\t\tint x = i % size;\n\t\tint y = i / size;\n\t\treturn float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );\n\t}\n#endif\n#ifdef USE_BATCHING_COLOR\n\tuniform sampler2D batchingColorTexture;\n\tvec3 getBatchingColor( const in float i ) {\n\t\tint size = textureSize( batchingColorTexture, 0 ).x;\n\t\tint j = int( i );\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\treturn texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif\n#ifdef USE_BATCHING_COLOR\n\tvec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );\n\tvColor.xyz *= batchingColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE\n\t\temissiveColor = sRGBTransferEOTF( emissiveColor );\n\t#endif\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"vec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferEOTF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform mat3 envMapRotation;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif ( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_DISPERSION\n\tmaterial.dispersion = dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\tfloat dispersion;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tgl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvFragDepth = 1.0 + gl_Position.w;\n\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex:"#ifdef USE_INSTANCING_MORPH\n\tfloat morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\tfloat morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tmorphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;\n\t}\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_INSTANCING_MORPH\n\t\tuniform float morphTargetBaseInfluence;\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t#endif\n\tuniform sampler2DArray morphTargetsTexture;\n\tuniform ivec2 morphTargetsTextureSize;\n\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t}\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;\nconst float Inv255 = 1. / 255.;\nconst vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );\nconst vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );\nconst vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );\nconst vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );\nvec4 packDepthToRGBA( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec4( 0., 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec4( 1., 1., 1., 1. );\n\tfloat vuf;\n\tfloat af = modf( v * PackFactors.a, vuf );\n\tfloat bf = modf( vuf * ShiftRight8, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );\n}\nvec3 packDepthToRGB( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec3( 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec3( 1., 1., 1. );\n\tfloat vuf;\n\tfloat bf = modf( v * PackFactors.b, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec3( vuf * Inv255, gf * PackUpscale, bf );\n}\nvec2 packDepthToRG( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec2( 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec2( 1., 1. );\n\tfloat vuf;\n\tfloat gf = modf( v * 256., vuf );\n\treturn vec2( vuf * Inv255, gf );\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors4 );\n}\nfloat unpackRGBToDepth( const in vec3 v ) {\n\treturn dot( v, UnpackFactors3 );\n}\nfloat unpackRGToDepth( const in vec2 v ) {\n\treturn v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;\n}\nvec4 pack2HalfToRGBA( const in vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( const in vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tfloat shadow = 1.0;\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\t\n\t\tfloat lightToPositionLength = length( lightToPosition );\n\t\tif ( lightToPositionLength - shadowCameraFar <= 0.0 && lightToPositionLength - shadowCameraNear >= 0.0 ) {\n\t\t\tfloat dp = ( lightToPositionLength - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\t\tdp += shadowBias;\n\t\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t\t) * ( 1.0 / 9.0 );\n\t\t\t#else\n\t\t\t\tshadow = texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 CineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 NeutralToneMapping( vec3 color ) {\n\tconst float StartCompression = 0.8 - 0.04;\n\tconst float Desaturation = 0.15;\n\tcolor *= toneMappingExposure;\n\tfloat x = min( color.r, min( color.g, color.b ) );\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max( color.r, max( color.g, color.b ) );\n\tif ( peak < StartCompression ) return color;\n\tfloat d = 1. - StartCompression;\n\tfloat newPeak = 1. - d * d / ( peak + d - StartCompression );\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );\n\treturn mix( color, vec3( newPeak ), g );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec4 transmittedLight;\n\t\tvec3 transmittance;\n\t\t#ifdef USE_DISPERSION\n\t\t\tfloat halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;\n\t\t\tvec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );\n\t\t\tfor ( int i = 0; i < 3; i ++ ) {\n\t\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );\n\t\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\t\trefractionCoords += 1.0;\n\t\t\t\trefractionCoords /= 2.0;\n\t\t\t\tvec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );\n\t\t\t\ttransmittedLight[ i ] = transmissionSample[ i ];\n\t\t\t\ttransmittedLight.a += transmissionSample.a;\n\t\t\t\ttransmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];\n\t\t\t}\n\t\t\ttransmittedLight.a /= 3.0;\n\t\t#else\n\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\trefractionCoords += 1.0;\n\t\t\trefractionCoords /= 2.0;\n\t\t\ttransmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\t\ttransmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\t#endif\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#elif DEPTH_PACKING == 3202\n\t\tgl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );\n\t#elif DEPTH_PACKING == 3203\n\t\tgl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\n\tuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix[ 3 ];\n\tvec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},Pc={common:{diffuse:{value:new qr(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new Kt},alphaMap:{value:null},alphaMapTransform:{value:new Kt},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new Kt}},envmap:{envMap:{value:null},envMapRotation:{value:new Kt},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new Kt}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new Kt}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new Kt},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new Kt},normalScale:{value:new Yt(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new Kt},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new Kt}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new Kt}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new Kt}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new qr(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new qr(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new Kt},alphaTest:{value:0},uvTransform:{value:new Kt}},sprite:{diffuse:{value:new qr(16777215)},opacity:{value:1},center:{value:new Yt(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new Kt},alphaMap:{value:null},alphaMapTransform:{value:new Kt},alphaTest:{value:0}}},Nc={basic:{uniforms:Ni([Pc.common,Pc.specularmap,Pc.envmap,Pc.aomap,Pc.lightmap,Pc.fog]),vertexShader:Lc.meshbasic_vert,fragmentShader:Lc.meshbasic_frag},lambert:{uniforms:Ni([Pc.common,Pc.specularmap,Pc.envmap,Pc.aomap,Pc.lightmap,Pc.emissivemap,Pc.bumpmap,Pc.normalmap,Pc.displacementmap,Pc.fog,Pc.lights,{emissive:{value:new qr(0)}}]),vertexShader:Lc.meshlambert_vert,fragmentShader:Lc.meshlambert_frag},phong:{uniforms:Ni([Pc.common,Pc.specularmap,Pc.envmap,Pc.aomap,Pc.lightmap,Pc.emissivemap,Pc.bumpmap,Pc.normalmap,Pc.displacementmap,Pc.fog,Pc.lights,{emissive:{value:new qr(0)},specular:{value:new qr(1118481)},shininess:{value:30}}]),vertexShader:Lc.meshphong_vert,fragmentShader:Lc.meshphong_frag},standard:{uniforms:Ni([Pc.common,Pc.envmap,Pc.aomap,Pc.lightmap,Pc.emissivemap,Pc.bumpmap,Pc.normalmap,Pc.displacementmap,Pc.roughnessmap,Pc.metalnessmap,Pc.fog,Pc.lights,{emissive:{value:new qr(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Lc.meshphysical_vert,fragmentShader:Lc.meshphysical_frag},toon:{uniforms:Ni([Pc.common,Pc.aomap,Pc.lightmap,Pc.emissivemap,Pc.bumpmap,Pc.normalmap,Pc.displacementmap,Pc.gradientmap,Pc.fog,Pc.lights,{emissive:{value:new qr(0)}}]),vertexShader:Lc.meshtoon_vert,fragmentShader:Lc.meshtoon_frag},matcap:{uniforms:Ni([Pc.common,Pc.bumpmap,Pc.normalmap,Pc.displacementmap,Pc.fog,{matcap:{value:null}}]),vertexShader:Lc.meshmatcap_vert,fragmentShader:Lc.meshmatcap_frag},points:{uniforms:Ni([Pc.points,Pc.fog]),vertexShader:Lc.points_vert,fragmentShader:Lc.points_frag},dashed:{uniforms:Ni([Pc.common,Pc.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Lc.linedashed_vert,fragmentShader:Lc.linedashed_frag},depth:{uniforms:Ni([Pc.common,Pc.displacementmap]),vertexShader:Lc.depth_vert,fragmentShader:Lc.depth_frag},normal:{uniforms:Ni([Pc.common,Pc.bumpmap,Pc.normalmap,Pc.displacementmap,{opacity:{value:1}}]),vertexShader:Lc.meshnormal_vert,fragmentShader:Lc.meshnormal_frag},sprite:{uniforms:Ni([Pc.sprite,Pc.fog]),vertexShader:Lc.sprite_vert,fragmentShader:Lc.sprite_frag},background:{uniforms:{uvTransform:{value:new Kt},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:Lc.background_vert,fragmentShader:Lc.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new Kt}},vertexShader:Lc.backgroundCube_vert,fragmentShader:Lc.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Lc.cube_vert,fragmentShader:Lc.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Lc.equirect_vert,fragmentShader:Lc.equirect_frag},distanceRGBA:{uniforms:Ni([Pc.common,Pc.displacementmap,{referencePosition:{value:new An},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Lc.distanceRGBA_vert,fragmentShader:Lc.distanceRGBA_frag},shadow:{uniforms:Ni([Pc.lights,Pc.fog,{color:{value:new qr(0)},opacity:{value:1}}]),vertexShader:Lc.shadow_vert,fragmentShader:Lc.shadow_frag}};Nc.physical={uniforms:Ni([Nc.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new Kt},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new Kt},clearcoatNormalScale:{value:new Yt(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new Kt},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new Kt},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new Kt},sheen:{value:0},sheenColor:{value:new qr(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new Kt},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new Kt},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new Kt},transmissionSamplerSize:{value:new Yt},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new Kt},attenuationDistance:{value:0},attenuationColor:{value:new qr(0)},specularColor:{value:new qr(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new Kt},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new Kt},anisotropyVector:{value:new Yt},anisotropyMap:{value:null},anisotropyMapTransform:{value:new Kt}}]),vertexShader:Lc.meshphysical_vert,fragmentShader:Lc.meshphysical_frag};const Dc={r:0,b:0,g:0},kc=new dr,Oc=new tr;function Fc(e,t,n,r,i,s,a){const o=new qr(0);let l,u,c=!0===s?0:1,d=null,h=0,f=null;function p(e){let r=!0===e.isScene?e.background:null;if(r&&r.isTexture){r=(e.backgroundBlurriness>0?n:t).get(r)}return r}function m(t,n){t.getRGB(Dc,Di(e)),r.buffers.color.setClear(Dc.r,Dc.g,Dc.b,n,a)}return{getClearColor:function(){return o},setClearColor:function(e,t=1){o.set(e),c=t,m(o,c)},getClearAlpha:function(){return c},setClearAlpha:function(e){c=e,m(o,c)},render:function(t){let n=!1;const i=p(t);null===i?m(o,c):i&&i.isColor&&(m(i,1),n=!0);const s=e.xr.getEnvironmentBlendMode();"additive"===s?r.buffers.color.setClear(0,0,0,1,a):"alpha-blend"===s&&r.buffers.color.setClear(0,0,0,0,a),(e.autoClear||n)&&(r.buffers.depth.setTest(!0),r.buffers.depth.setMask(!0),r.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(t,n){const r=p(n);r&&(r.isCubeTexture||r.mapping===Q)?(void 0===u&&(u=new Ci(new Li(1,1,1),new Oi({name:"BackgroundCubeMaterial",uniforms:Pi(Nc.backgroundCube.uniforms),vertexShader:Nc.backgroundCube.vertexShader,fragmentShader:Nc.backgroundCube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),u.geometry.deleteAttribute("normal"),u.geometry.deleteAttribute("uv"),u.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)},Object.defineProperty(u.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),i.update(u)),kc.copy(n.backgroundRotation),kc.x*=-1,kc.y*=-1,kc.z*=-1,r.isCubeTexture&&!1===r.isRenderTargetTexture&&(kc.y*=-1,kc.z*=-1),u.material.uniforms.envMap.value=r,u.material.uniforms.flipEnvMap.value=r.isCubeTexture&&!1===r.isRenderTargetTexture?-1:1,u.material.uniforms.backgroundBlurriness.value=n.backgroundBlurriness,u.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,u.material.uniforms.backgroundRotation.value.setFromMatrix4(Oc.makeRotationFromEuler(kc)),u.material.toneMapped=un.getTransfer(r.colorSpace)!==xt,d===r&&h===r.version&&f===e.toneMapping||(u.material.needsUpdate=!0,d=r,h=r.version,f=e.toneMapping),u.layers.enableAll(),t.unshift(u,u.geometry,u.material,0,0,null)):r&&r.isTexture&&(void 0===l&&(l=new Ci(new Zo(2,2),new Oi({name:"BackgroundMaterial",uniforms:Pi(Nc.background.uniforms),vertexShader:Nc.background.vertexShader,fragmentShader:Nc.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),i.update(l)),l.material.uniforms.t2D.value=r,l.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,l.material.toneMapped=un.getTransfer(r.colorSpace)!==xt,!0===r.matrixAutoUpdate&&r.updateMatrix(),l.material.uniforms.uvTransform.value.copy(r.matrix),d===r&&h===r.version&&f===e.toneMapping||(l.material.needsUpdate=!0,d=r,h=r.version,f=e.toneMapping),l.layers.enableAll(),t.unshift(l,l.geometry,l.material,0,0,null))},dispose:function(){void 0!==u&&(u.geometry.dispose(),u.material.dispose()),void 0!==l&&(l.geometry.dispose(),l.material.dispose())}}}function Uc(e,t){const n=e.getParameter(e.MAX_VERTEX_ATTRIBS),r={},i=u(null);let s=i,a=!1;function o(t){return e.bindVertexArray(t)}function l(t){return e.deleteVertexArray(t)}function u(e){const t=[],r=[],i=[];for(let e=0;e<n;e++)t[e]=0,r[e]=0,i[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:r,attributeDivisors:i,object:e,attributes:{},index:null}}function c(){const e=s.newAttributes;for(let t=0,n=e.length;t<n;t++)e[t]=0}function d(e){h(e,0)}function h(t,n){const r=s.newAttributes,i=s.enabledAttributes,a=s.attributeDivisors;r[t]=1,0===i[t]&&(e.enableVertexAttribArray(t),i[t]=1),a[t]!==n&&(e.vertexAttribDivisor(t,n),a[t]=n)}function f(){const t=s.newAttributes,n=s.enabledAttributes;for(let r=0,i=n.length;r<i;r++)n[r]!==t[r]&&(e.disableVertexAttribArray(r),n[r]=0)}function p(t,n,r,i,s,a,o){!0===o?e.vertexAttribIPointer(t,n,r,s,a):e.vertexAttribPointer(t,n,r,i,s,a)}function m(){g(),a=!0,s!==i&&(s=i,o(s.object))}function g(){i.geometry=null,i.program=null,i.wireframe=!1}return{setup:function(n,i,l,m,g){let v=!1;const y=function(t,n,i){const s=!0===i.wireframe;let a=r[t.id];void 0===a&&(a={},r[t.id]=a);let o=a[n.id];void 0===o&&(o={},a[n.id]=o);let l=o[s];void 0===l&&(l=u(e.createVertexArray()),o[s]=l);return l}(m,l,i);s!==y&&(s=y,o(s.object)),v=function(e,t,n,r){const i=s.attributes,a=t.attributes;let o=0;const l=n.getAttributes();for(const t in l){if(l[t].location>=0){const n=i[t];let r=a[t];if(void 0===r&&("instanceMatrix"===t&&e.instanceMatrix&&(r=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(r=e.instanceColor)),void 0===n)return!0;if(n.attribute!==r)return!0;if(r&&n.data!==r.data)return!0;o++}}return s.attributesNum!==o||s.index!==r}(n,m,l,g),v&&function(e,t,n,r){const i={},a=t.attributes;let o=0;const l=n.getAttributes();for(const t in l){if(l[t].location>=0){let n=a[t];void 0===n&&("instanceMatrix"===t&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(n=e.instanceColor));const r={};r.attribute=n,n&&n.data&&(r.data=n.data),i[t]=r,o++}}s.attributes=i,s.attributesNum=o,s.index=r}(n,m,l,g),null!==g&&t.update(g,e.ELEMENT_ARRAY_BUFFER),(v||a)&&(a=!1,function(n,r,i,s){c();const a=s.attributes,o=i.getAttributes(),l=r.defaultAttributeValues;for(const r in o){const i=o[r];if(i.location>=0){let o=a[r];if(void 0===o&&("instanceMatrix"===r&&n.instanceMatrix&&(o=n.instanceMatrix),"instanceColor"===r&&n.instanceColor&&(o=n.instanceColor)),void 0!==o){const r=o.normalized,a=o.itemSize,l=t.get(o);if(void 0===l)continue;const u=l.buffer,c=l.type,f=l.bytesPerElement,m=c===e.INT||c===e.UNSIGNED_INT||o.gpuType===de;if(o.isInterleavedBufferAttribute){const t=o.data,l=t.stride,g=o.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<i.locationSize;e++)h(i.location+e,t.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===s._maxInstanceCount&&(s._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<i.locationSize;e++)d(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,u);for(let e=0;e<i.locationSize;e++)p(i.location+e,a/i.locationSize,c,r,l*f,(g+a/i.locationSize*e)*f,m)}else{if(o.isInstancedBufferAttribute){for(let e=0;e<i.locationSize;e++)h(i.location+e,o.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===s._maxInstanceCount&&(s._maxInstanceCount=o.meshPerAttribute*o.count)}else for(let e=0;e<i.locationSize;e++)d(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,u);for(let e=0;e<i.locationSize;e++)p(i.location+e,a/i.locationSize,c,r,a*f,a/i.locationSize*e*f,m)}}else if(void 0!==l){const t=l[r];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(i.location,t);break;case 3:e.vertexAttrib3fv(i.location,t);break;case 4:e.vertexAttrib4fv(i.location,t);break;default:e.vertexAttrib1fv(i.location,t)}}}}f()}(n,i,l,m),null!==g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.get(g).buffer))},reset:m,resetDefaultState:g,dispose:function(){m();for(const e in r){const t=r[e];for(const e in t){const n=t[e];for(const e in n)l(n[e].object),delete n[e];delete t[e]}delete r[e]}},releaseStatesOfGeometry:function(e){if(void 0===r[e.id])return;const t=r[e.id];for(const e in t){const n=t[e];for(const e in n)l(n[e].object),delete n[e];delete t[e]}delete r[e.id]},releaseStatesOfProgram:function(e){for(const t in r){const n=r[t];if(void 0===n[e.id])continue;const i=n[e.id];for(const e in i)l(i[e].object),delete i[e];delete n[e.id]}},initAttributes:c,enableAttribute:d,disableUnusedAttributes:f}}function Bc(e,t,n){let r;function i(t,i,s){0!==s&&(e.drawArraysInstanced(r,t,i,s),n.update(i,r,s))}this.setMode=function(e){r=e},this.render=function(t,i){e.drawArrays(r,t,i),n.update(i,r,1)},this.renderInstances=i,this.renderMultiDraw=function(e,i,s){if(0===s)return;t.get("WEBGL_multi_draw").multiDrawArraysWEBGL(r,e,0,i,0,s);let a=0;for(let e=0;e<s;e++)a+=i[e];n.update(a,r,1)},this.renderMultiDrawInstances=function(e,s,a,o){if(0===a)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<e.length;t++)i(e[t],s[t],o[t]);else{l.multiDrawArraysInstancedWEBGL(r,e,0,s,0,o,0,a);let t=0;for(let e=0;e<a;e++)t+=s[e]*o[e];n.update(t,r,1)}}}function Vc(e,t,n,r){let i;function s(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let a=void 0!==n.precision?n.precision:"highp";const o=s(a);o!==a&&(a=o);const l=!0===n.logarithmicDepthBuffer,u=!0===n.reverseDepthBuffer&&t.has("EXT_clip_control"),c=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),d=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);return{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==i)return i;if(!0===t.has("EXT_texture_filter_anisotropic")){const n=t.get("EXT_texture_filter_anisotropic");i=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else i=0;return i},getMaxPrecision:s,textureFormatReadable:function(t){return t===xe||r.convert(t)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(n){const i=n===pe&&(t.has("EXT_color_buffer_half_float")||t.has("EXT_color_buffer_float"));return!(n!==oe&&r.convert(n)!==e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)&&n!==fe&&!i)},precision:a,logarithmicDepthBuffer:l,reverseDepthBuffer:u,maxTextures:c,maxVertexTextures:d,maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),vertexTextures:d>0,maxSamples:e.getParameter(e.MAX_SAMPLES)}}function zc(e){const t=this;let n=null,r=0,i=!1,s=!1;const a=new $s,o=new Kt,l={value:null,needsUpdate:!1};function u(e,n,r,i){const s=null!==e?e.length:0;let u=null;if(0!==s){if(u=l.value,!0!==i||null===u){const t=r+4*s,i=n.matrixWorldInverse;o.getNormalMatrix(i),(null===u||u.length<t)&&(u=new Float32Array(t));for(let t=0,n=r;t!==s;++t,n+=4)a.copy(e[t]).applyMatrix4(i,o),a.normal.toArray(u,n),u[n+3]=a.constant}l.value=u,l.needsUpdate=!0}return t.numPlanes=s,t.numIntersection=0,u}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const n=0!==e.length||t||0!==r||i;return i=t,r=e.length,n},this.beginShadows=function(){s=!0,u(null)},this.endShadows=function(){s=!1},this.setGlobalState=function(e,t){n=u(e,t,0)},this.setState=function(a,o,c){const d=a.clippingPlanes,h=a.clipIntersection,f=a.clipShadows,p=e.get(a);if(!i||null===d||0===d.length||s&&!f)s?u(null):function(){l.value!==n&&(l.value=n,l.needsUpdate=r>0);t.numPlanes=r,t.numIntersection=0}();else{const e=s?0:r,t=4*e;let i=p.clippingState||null;l.value=i,i=u(d,o,t,c);for(let e=0;e!==t;++e)i[e]=n[e];p.clippingState=i,this.numIntersection=h?this.numPlanes:0,this.numPlanes+=e}}}function Gc(e){let t=new WeakMap;function n(e,t){return t===Y?e.mapping=q:t===K&&(e.mapping=X),e}function r(e){const n=e.target;n.removeEventListener("dispose",r);const i=t.get(n);void 0!==i&&(t.delete(n),i.dispose())}return{get:function(i){if(i&&i.isTexture){const s=i.mapping;if(s===Y||s===K){if(t.has(i)){return n(t.get(i).texture,i.mapping)}{const s=i.image;if(s&&s.height>0){const a=new Wi(s.height);return a.fromEquirectangularTexture(e,i),t.set(i,a),i.addEventListener("dispose",r),n(a.texture,i.mapping)}return null}}}return i},dispose:function(){t=new WeakMap}}}const Hc=[.125,.215,.35,.446,.526,.582],$c=20,Wc=new uu,jc=new qr;let qc=null,Xc=0,Yc=0,Kc=!1;const Qc=(1+Math.sqrt(5))/2,Zc=1/Qc,Jc=[new An(-Qc,Zc,0),new An(Qc,Zc,0),new An(-Zc,0,Qc),new An(Zc,0,Qc),new An(0,Qc,-Zc),new An(0,Qc,Zc),new An(-1,1,-1),new An(1,1,-1),new An(-1,1,1),new An(1,1,1)];class ed{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,n=.1,r=100){qc=this._renderer.getRenderTarget(),Xc=this._renderer.getActiveCubeFace(),Yc=this._renderer.getActiveMipmapLevel(),Kc=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(256);const i=this._allocateTargets();return i.depthBuffer=!0,this._sceneToCubeUV(e,n,r,i),t>0&&this._blur(i,0,0,t),this._applyPMREM(i),this._cleanup(i),i}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=id(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=rd(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(qc,Xc,Yc),this._renderer.xr.enabled=Kc,e.scissorTest=!1,nd(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===q||e.mapping===X?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),qc=this._renderer.getRenderTarget(),Xc=this._renderer.getActiveCubeFace(),Yc=this._renderer.getActiveMipmapLevel(),Kc=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const n=t||this._allocateTargets();return this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,n={magFilter:ie,minFilter:ie,generateMipmaps:!1,type:pe,format:xe,colorSpace:bt,depthBuffer:!1},r=td(e,t,n);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=td(e,t,n);const{_lodMax:r}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],n=[],r=[];let i=e;const s=e-4+1+Hc.length;for(let a=0;a<s;a++){const s=Math.pow(2,i);n.push(s);let o=1/s;a>e-4?o=Hc[a-e+4-1]:0===a&&(o=0),r.push(o);const l=1/(s-2),u=-l,c=1+l,d=[u,u,c,u,c,c,u,u,c,c,u,c],h=6,f=6,p=3,m=2,g=1,v=new Float32Array(p*f*h),y=new Float32Array(m*f*h),b=new Float32Array(g*f*h);for(let e=0;e<h;e++){const t=e%3*2/3-1,n=e>2?0:-1,r=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0];v.set(r,p*f*e),y.set(d,m*f*e);const i=[e,e,e,e,e,e];b.set(i,g*f*e)}const _=new vi;_.setAttribute("position",new si(v,p)),_.setAttribute("uv",new si(y,m)),_.setAttribute("faceIndex",new si(b,g)),t.push(_),i>4&&i--}return{lodPlanes:t,sizeLods:n,sigmas:r}}(r)),this._blurMaterial=function(e,t,n){const r=new Float32Array($c),i=new An(0,1,0),s=new Oi({name:"SphericalGaussianBlur",defines:{n:$c,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/n,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:r},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:i}},vertexShader:sd(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1});return s}(r,e,t)}return r}_compileMaterial(e){const t=new Ci(this._lodPlanes[0],e);this._renderer.compile(t,Wc)}_sceneToCubeUV(e,t,n,r){const i=new zi(90,1,t,n),s=[1,-1,1,1,1,1],a=[1,1,1,-1,-1,-1],o=this._renderer,l=o.autoClear,u=o.toneMapping;o.getClearColor(jc),o.toneMapping=0,o.autoClear=!1;const c=new Qr({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),d=new Ci(new Li,c);let h=!1;const f=e.background;f?f.isColor&&(c.color.copy(f),e.background=null,h=!0):(c.color.copy(jc),h=!0);for(let t=0;t<6;t++){const n=t%3;0===n?(i.up.set(0,s[t],0),i.lookAt(a[t],0,0)):1===n?(i.up.set(0,0,s[t]),i.lookAt(0,a[t],0)):(i.up.set(0,s[t],0),i.lookAt(0,0,a[t]));const l=this._cubeSize;nd(r,n*l,t>2?l:0,l,l),o.setRenderTarget(r),h&&o.render(d,i),o.render(e,i)}d.geometry.dispose(),d.material.dispose(),o.toneMapping=u,o.autoClear=l,e.background=f}_textureToCubeUV(e,t){const n=this._renderer,r=e.mapping===q||e.mapping===X;r?(null===this._cubemapMaterial&&(this._cubemapMaterial=id()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=rd());const i=r?this._cubemapMaterial:this._equirectMaterial,s=new Ci(this._lodPlanes[0],i);i.uniforms.envMap.value=e;const a=this._cubeSize;nd(t,0,0,3*a,2*a),n.setRenderTarget(t),n.render(s,Wc)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;const r=this._lodPlanes.length;for(let t=1;t<r;t++){const n=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),i=Jc[(r-t-1)%Jc.length];this._blur(e,t-1,t,n,i)}t.autoClear=n}_blur(e,t,n,r,i){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,n,r,"latitudinal",i),this._halfBlur(s,e,n,n,r,"longitudinal",i)}_halfBlur(e,t,n,r,i,s,a){const o=this._renderer,l=this._blurMaterial,u=new Ci(this._lodPlanes[r],l),c=l.uniforms,d=this._sizeLods[n]-1,h=isFinite(i)?Math.PI/(2*d):2*Math.PI/39,f=i/h,p=isFinite(i)?1+Math.floor(3*f):$c,m=[];let g=0;for(let e=0;e<$c;++e){const t=e/f,n=Math.exp(-t*t/2);m.push(n),0===e?g+=n:e<p&&(g+=2*n)}for(let e=0;e<m.length;e++)m[e]=m[e]/g;c.envMap.value=e.texture,c.samples.value=p,c.weights.value=m,c.latitudinal.value="latitudinal"===s,a&&(c.poleAxis.value=a);const{_lodMax:v}=this;c.dTheta.value=h,c.mipInt.value=v-n;const y=this._sizeLods[r];nd(t,3*y*(r>v-4?r-v+4:0),4*(this._cubeSize-y),3*y,2*y),o.setRenderTarget(t),o.render(u,Wc)}}function td(e,t,n){const r=new xn(e,t,n);return r.texture.mapping=Q,r.texture.name="PMREM.cubeUv",r.scissorTest=!0,r}function nd(e,t,n,r,i){e.viewport.set(t,n,r,i),e.scissor.set(t,n,r,i)}function rd(){return new Oi({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:sd(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function id(){return new Oi({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:sd(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function sd(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function ad(e){let t=new WeakMap,n=null;function r(e){const n=e.target;n.removeEventListener("dispose",r);const i=t.get(n);void 0!==i&&(t.delete(n),i.dispose())}return{get:function(i){if(i&&i.isTexture){const s=i.mapping,a=s===Y||s===K,o=s===q||s===X;if(a||o){let s=t.get(i);const l=void 0!==s?s.texture.pmremVersion:0;if(i.isRenderTargetTexture&&i.pmremVersion!==l)return null===n&&(n=new ed(e)),s=a?n.fromEquirectangular(i,s):n.fromCubemap(i,s),s.texture.pmremVersion=i.pmremVersion,t.set(i,s),s.texture;if(void 0!==s)return s.texture;{const l=i.image;return a&&l&&l.height>0||o&&l&&function(e){let t=0;const n=6;for(let r=0;r<n;r++)void 0!==e[r]&&t++;return t===n}(l)?(null===n&&(n=new ed(e)),s=a?n.fromEquirectangular(i):n.fromCubemap(i),s.texture.pmremVersion=i.pmremVersion,t.set(i,s),i.addEventListener("dispose",r),s.texture):null}}}return i},dispose:function(){t=new WeakMap,null!==n&&(n.dispose(),n=null)}}}function od(e){const t={};function n(n){if(void 0!==t[n])return t[n];let r;switch(n){case"WEBGL_depth_texture":r=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:r=e.getExtension(n)}return t[n]=r,r}return{has:function(e){return null!==n(e)},init:function(){n("EXT_color_buffer_float"),n("WEBGL_clip_cull_distance"),n("OES_texture_float_linear"),n("EXT_color_buffer_half_float"),n("WEBGL_multisampled_render_to_texture"),n("WEBGL_render_shared_exponent")},get:function(e){const t=n(e);return null===t&&sn("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function ld(e,t,n,r){const i={},s=new WeakMap;function a(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const e in o.attributes)t.remove(o.attributes[e]);o.removeEventListener("dispose",a),delete i[o.id];const l=s.get(o);l&&(t.remove(l),s.delete(o)),r.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,n.memory.geometries--}function o(e){const n=[],r=e.index,i=e.attributes.position;let a=0;if(null!==r){const e=r.array;a=r.version;for(let t=0,r=e.length;t<r;t+=3){const r=e[t+0],i=e[t+1],s=e[t+2];n.push(r,i,i,s,s,r)}}else{if(void 0===i)return;{const e=i.array;a=i.version;for(let t=0,r=e.length/3-1;t<r;t+=3){const e=t+0,r=t+1,i=t+2;n.push(e,r,r,i,i,e)}}}const o=new(Zt(n)?oi:ai)(n,1);o.version=a;const l=s.get(e);l&&t.remove(l),s.set(e,o)}return{get:function(e,t){return!0===i[t.id]||(t.addEventListener("dispose",a),i[t.id]=!0,n.memory.geometries++),t},update:function(n){const r=n.attributes;for(const n in r)t.update(r[n],e.ARRAY_BUFFER)},getWireframeAttribute:function(e){const t=s.get(e);if(t){const n=e.index;null!==n&&t.version<n.version&&o(e)}else o(e);return s.get(e)}}}function ud(e,t,n){let r,i,s;function a(t,a,o){0!==o&&(e.drawElementsInstanced(r,a,i,t*s,o),n.update(a,r,o))}this.setMode=function(e){r=e},this.setIndex=function(e){i=e.type,s=e.bytesPerElement},this.render=function(t,a){e.drawElements(r,a,i,t*s),n.update(a,r,1)},this.renderInstances=a,this.renderMultiDraw=function(e,s,a){if(0===a)return;t.get("WEBGL_multi_draw").multiDrawElementsWEBGL(r,s,0,i,e,0,a);let o=0;for(let e=0;e<a;e++)o+=s[e];n.update(o,r,1)},this.renderMultiDrawInstances=function(e,o,l,u){if(0===l)return;const c=t.get("WEBGL_multi_draw");if(null===c)for(let t=0;t<e.length;t++)a(e[t]/s,o[t],u[t]);else{c.multiDrawElementsInstancedWEBGL(r,o,0,i,e,0,u,0,l);let t=0;for(let e=0;e<l;e++)t+=o[e]*u[e];n.update(t,r,1)}}}function cd(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(n,r,i){switch(t.calls++,r){case e.TRIANGLES:t.triangles+=i*(n/3);break;case e.LINES:t.lines+=i*(n/2);break;case e.LINE_STRIP:t.lines+=i*(n-1);break;case e.LINE_LOOP:t.lines+=i*n;break;case e.POINTS:t.points+=i*n}}}}function dd(e,t,n){const r=new WeakMap,i=new bn;return{update:function(s,a,o){const l=s.morphTargetInfluences,u=a.morphAttributes.position||a.morphAttributes.normal||a.morphAttributes.color,c=void 0!==u?u.length:0;let d=r.get(a);if(void 0===d||d.count!==c){void 0!==d&&d.texture.dispose();const h=void 0!==a.morphAttributes.position,f=void 0!==a.morphAttributes.normal,p=void 0!==a.morphAttributes.color,m=a.morphAttributes.position||[],g=a.morphAttributes.normal||[],v=a.morphAttributes.color||[];let y=0;!0===h&&(y=1),!0===f&&(y=2),!0===p&&(y=3);let b=a.attributes.position.count*y,_=1;b>t.maxTextureSize&&(_=Math.ceil(b/t.maxTextureSize),b=t.maxTextureSize);const x=new Float32Array(b*_*4*c),S=new Sn(x,b,_,c);S.type=fe,S.needsUpdate=!0;const T=4*y;for(let A=0;A<c;A++){const w=m[A],M=g[A],R=v[A],C=b*_*4*A;for(let I=0;I<w.count;I++){const L=I*T;!0===h&&(i.fromBufferAttribute(w,I),x[C+L+0]=i.x,x[C+L+1]=i.y,x[C+L+2]=i.z,x[C+L+3]=0),!0===f&&(i.fromBufferAttribute(M,I),x[C+L+4]=i.x,x[C+L+5]=i.y,x[C+L+6]=i.z,x[C+L+7]=0),!0===p&&(i.fromBufferAttribute(R,I),x[C+L+8]=i.x,x[C+L+9]=i.y,x[C+L+10]=i.z,x[C+L+11]=4===R.itemSize?i.w:1)}}function E(){S.dispose(),r.delete(a),a.removeEventListener("dispose",E)}d={count:c,texture:S,size:new Yt(b,_)},r.set(a,d),a.addEventListener("dispose",E)}if(!0===s.isInstancedMesh&&null!==s.morphTexture)o.getUniforms().setValue(e,"morphTexture",s.morphTexture,n);else{let P=0;for(let D=0;D<l.length;D++)P+=l[D];const N=a.morphTargetsRelative?1:1-P;o.getUniforms().setValue(e,"morphTargetBaseInfluence",N),o.getUniforms().setValue(e,"morphTargetInfluences",l)}o.getUniforms().setValue(e,"morphTargetsTexture",d.texture,n),o.getUniforms().setValue(e,"morphTargetsTextureSize",d.size)}}}function hd(e,t,n,r){let i=new WeakMap;function s(e){const t=e.target;t.removeEventListener("dispose",s),n.remove(t.instanceMatrix),null!==t.instanceColor&&n.remove(t.instanceColor)}return{update:function(a){const o=r.render.frame,l=a.geometry,u=t.get(a,l);if(i.get(u)!==o&&(t.update(u),i.set(u,o)),a.isInstancedMesh&&(!1===a.hasEventListener("dispose",s)&&a.addEventListener("dispose",s),i.get(a)!==o&&(n.update(a.instanceMatrix,e.ARRAY_BUFFER),null!==a.instanceColor&&n.update(a.instanceColor,e.ARRAY_BUFFER),i.set(a,o))),a.isSkinnedMesh){const e=a.skeleton;i.get(e)!==o&&(e.update(),i.set(e,o))}return u},dispose:function(){i=new WeakMap}}}const fd=new yn,pd=new Fa(1,1),md=new Sn,gd=new Tn,vd=new $i,yd=[],bd=[],_d=new Float32Array(16),xd=new Float32Array(9),Sd=new Float32Array(4);function Td(e,t,n){const r=e[0];if(r<=0||r>0)return e;const i=t*n;let s=yd[i];if(void 0===s&&(s=new Float32Array(i),yd[i]=s),0!==t){r.toArray(s,0);for(let r=1,i=0;r!==t;++r)i+=n,e[r].toArray(s,i)}return s}function Ed(e,t){if(e.length!==t.length)return!1;for(let n=0,r=e.length;n<r;n++)if(e[n]!==t[n])return!1;return!0}function Ad(e,t){for(let n=0,r=t.length;n<r;n++)e[n]=t[n]}function wd(e,t){let n=bd[t];void 0===n&&(n=new Int32Array(t),bd[t]=n);for(let r=0;r!==t;++r)n[r]=e.allocateTextureUnit();return n}function Md(e,t){const n=this.cache;n[0]!==t&&(e.uniform1f(this.addr,t),n[0]=t)}function Rd(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Ed(n,t))return;e.uniform2fv(this.addr,t),Ad(n,t)}}function Cd(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else if(void 0!==t.r)n[0]===t.r&&n[1]===t.g&&n[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),n[0]=t.r,n[1]=t.g,n[2]=t.b);else{if(Ed(n,t))return;e.uniform3fv(this.addr,t),Ad(n,t)}}function Id(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Ed(n,t))return;e.uniform4fv(this.addr,t),Ad(n,t)}}function Ld(e,t){const n=this.cache,r=t.elements;if(void 0===r){if(Ed(n,t))return;e.uniformMatrix2fv(this.addr,!1,t),Ad(n,t)}else{if(Ed(n,r))return;Sd.set(r),e.uniformMatrix2fv(this.addr,!1,Sd),Ad(n,r)}}function Pd(e,t){const n=this.cache,r=t.elements;if(void 0===r){if(Ed(n,t))return;e.uniformMatrix3fv(this.addr,!1,t),Ad(n,t)}else{if(Ed(n,r))return;xd.set(r),e.uniformMatrix3fv(this.addr,!1,xd),Ad(n,r)}}function Nd(e,t){const n=this.cache,r=t.elements;if(void 0===r){if(Ed(n,t))return;e.uniformMatrix4fv(this.addr,!1,t),Ad(n,t)}else{if(Ed(n,r))return;_d.set(r),e.uniformMatrix4fv(this.addr,!1,_d),Ad(n,r)}}function Dd(e,t){const n=this.cache;n[0]!==t&&(e.uniform1i(this.addr,t),n[0]=t)}function kd(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Ed(n,t))return;e.uniform2iv(this.addr,t),Ad(n,t)}}function Od(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(Ed(n,t))return;e.uniform3iv(this.addr,t),Ad(n,t)}}function Fd(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Ed(n,t))return;e.uniform4iv(this.addr,t),Ad(n,t)}}function Ud(e,t){const n=this.cache;n[0]!==t&&(e.uniform1ui(this.addr,t),n[0]=t)}function Bd(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Ed(n,t))return;e.uniform2uiv(this.addr,t),Ad(n,t)}}function Vd(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(Ed(n,t))return;e.uniform3uiv(this.addr,t),Ad(n,t)}}function zd(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Ed(n,t))return;e.uniform4uiv(this.addr,t),Ad(n,t)}}function Gd(e,t,n){const r=this.cache,i=n.allocateTextureUnit();let s;r[0]!==i&&(e.uniform1i(this.addr,i),r[0]=i),this.type===e.SAMPLER_2D_SHADOW?(pd.compareFunction=Mt,s=pd):s=fd,n.setTexture2D(t||s,i)}function Hd(e,t,n){const r=this.cache,i=n.allocateTextureUnit();r[0]!==i&&(e.uniform1i(this.addr,i),r[0]=i),n.setTexture3D(t||gd,i)}function $d(e,t,n){const r=this.cache,i=n.allocateTextureUnit();r[0]!==i&&(e.uniform1i(this.addr,i),r[0]=i),n.setTextureCube(t||vd,i)}function Wd(e,t,n){const r=this.cache,i=n.allocateTextureUnit();r[0]!==i&&(e.uniform1i(this.addr,i),r[0]=i),n.setTexture2DArray(t||md,i)}function jd(e,t){e.uniform1fv(this.addr,t)}function qd(e,t){const n=Td(t,this.size,2);e.uniform2fv(this.addr,n)}function Xd(e,t){const n=Td(t,this.size,3);e.uniform3fv(this.addr,n)}function Yd(e,t){const n=Td(t,this.size,4);e.uniform4fv(this.addr,n)}function Kd(e,t){const n=Td(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,n)}function Qd(e,t){const n=Td(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,n)}function Zd(e,t){const n=Td(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,n)}function Jd(e,t){e.uniform1iv(this.addr,t)}function eh(e,t){e.uniform2iv(this.addr,t)}function th(e,t){e.uniform3iv(this.addr,t)}function nh(e,t){e.uniform4iv(this.addr,t)}function rh(e,t){e.uniform1uiv(this.addr,t)}function ih(e,t){e.uniform2uiv(this.addr,t)}function sh(e,t){e.uniform3uiv(this.addr,t)}function ah(e,t){e.uniform4uiv(this.addr,t)}function oh(e,t,n){const r=this.cache,i=t.length,s=wd(n,i);Ed(r,s)||(e.uniform1iv(this.addr,s),Ad(r,s));for(let e=0;e!==i;++e)n.setTexture2D(t[e]||fd,s[e])}function lh(e,t,n){const r=this.cache,i=t.length,s=wd(n,i);Ed(r,s)||(e.uniform1iv(this.addr,s),Ad(r,s));for(let e=0;e!==i;++e)n.setTexture3D(t[e]||gd,s[e])}function uh(e,t,n){const r=this.cache,i=t.length,s=wd(n,i);Ed(r,s)||(e.uniform1iv(this.addr,s),Ad(r,s));for(let e=0;e!==i;++e)n.setTextureCube(t[e]||vd,s[e])}function ch(e,t,n){const r=this.cache,i=t.length,s=wd(n,i);Ed(r,s)||(e.uniform1iv(this.addr,s),Ad(r,s));for(let e=0;e!==i;++e)n.setTexture2DArray(t[e]||md,s[e])}class dh{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.setValue=function(e){switch(e){case 5126:return Md;case 35664:return Rd;case 35665:return Cd;case 35666:return Id;case 35674:return Ld;case 35675:return Pd;case 35676:return Nd;case 5124:case 35670:return Dd;case 35667:case 35671:return kd;case 35668:case 35672:return Od;case 35669:case 35673:return Fd;case 5125:return Ud;case 36294:return Bd;case 36295:return Vd;case 36296:return zd;case 35678:case 36198:case 36298:case 36306:case 35682:return Gd;case 35679:case 36299:case 36307:return Hd;case 35680:case 36300:case 36308:case 36293:return $d;case 36289:case 36303:case 36311:case 36292:return Wd}}(t.type)}}class hh{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return jd;case 35664:return qd;case 35665:return Xd;case 35666:return Yd;case 35674:return Kd;case 35675:return Qd;case 35676:return Zd;case 5124:case 35670:return Jd;case 35667:case 35671:return eh;case 35668:case 35672:return th;case 35669:case 35673:return nh;case 5125:return rh;case 36294:return ih;case 36295:return sh;case 36296:return ah;case 35678:case 36198:case 36298:case 36306:case 35682:return oh;case 35679:case 36299:case 36307:return lh;case 35680:case 36300:case 36308:case 36293:return uh;case 36289:case 36303:case 36311:case 36292:return ch}}(t.type)}}class fh{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,n){const r=this.seq;for(let i=0,s=r.length;i!==s;++i){const s=r[i];s.setValue(e,t[s.id],n)}}}const ph=/(\w+)(\])?(\[|\.)?/g;function mh(e,t){e.seq.push(t),e.map[t.id]=t}function gh(e,t,n){const r=e.name,i=r.length;for(ph.lastIndex=0;;){const s=ph.exec(r),a=ph.lastIndex;let o=s[1];const l="]"===s[2],u=s[3];if(l&&(o|=0),void 0===u||"["===u&&a+2===i){mh(n,void 0===u?new dh(o,e,t):new hh(o,e,t));break}{let e=n.map[o];void 0===e&&(e=new fh(o),mh(n,e)),n=e}}}class vh{constructor(e,t){this.seq=[],this.map={};const n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let r=0;r<n;++r){const n=e.getActiveUniform(t,r);gh(n,e.getUniformLocation(t,n.name),this)}}setValue(e,t,n,r){const i=this.map[t];void 0!==i&&i.setValue(e,n,r)}setOptional(e,t,n){const r=t[n];void 0!==r&&this.setValue(e,n,r)}static upload(e,t,n,r){for(let i=0,s=t.length;i!==s;++i){const s=t[i],a=n[s.id];!1!==a.needsUpdate&&s.setValue(e,a.value,r)}}static seqWithValue(e,t){const n=[];for(let r=0,i=e.length;r!==i;++r){const i=e[r];i.id in t&&n.push(i)}return n}}function yh(e,t,n){const r=e.createShader(t);return e.shaderSource(r,n),e.compileShader(r),r}let bh=0;const _h=new Kt;function xh(e,t,n){const r=e.getShaderParameter(t,e.COMPILE_STATUS),i=e.getShaderInfoLog(t).trim();if(r&&""===i)return"";const s=/ERROR: 0:(\d+)/.exec(i);if(s){const r=parseInt(s[1]);return n.toUpperCase()+"\n\n"+i+"\n\n"+function(e,t){const n=e.split("\n"),r=[],i=Math.max(t-6,0),s=Math.min(t+6,n.length);for(let e=i;e<s;e++){const i=e+1;r.push(`${i===t?">":" "} ${i}: ${n[e]}`)}return r.join("\n")}(e.getShaderSource(t),r)}return i}function Sh(e,t){const n=function(e){un._getMatrix(_h,un.workingColorSpace,e);const t=`mat3( ${_h.elements.map(e=>e.toFixed(4))} )`;switch(un.getTransfer(e)){case _t:return[t,"LinearTransferOETF"];case xt:return[t,"sRGBTransferOETF"];default:return[t,"LinearTransferOETF"]}}(t);return[`vec4 ${e}( vec4 value ) {`,`\treturn ${n[1]}( vec4( value.rgb * ${n[0]}, value.a ) );`,"}"].join("\n")}function Th(e,t){let n;switch(t){case 1:default:n="Linear";break;case 2:n="Reinhard";break;case 3:n="Cineon";break;case 4:n="ACESFilmic";break;case 6:n="AgX";break;case 7:n="Neutral";break;case 5:n="Custom"}return"vec3 "+e+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}const Eh=new An;function Ah(){un.getLuminanceCoefficients(Eh);return["float luminance( const in vec3 rgb ) {",`\tconst vec3 weights = vec3( ${Eh.x.toFixed(4)}, ${Eh.y.toFixed(4)}, ${Eh.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")}function wh(e){return""!==e}function Mh(e,t){const n=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,n).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function Rh(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const Ch=/^[ \t]*#include +<([\w\d./]+)>/gm;function Ih(e){return e.replace(Ch,Ph)}const Lh=new Map;function Ph(e,t){let n=Lc[t];if(void 0===n){const e=Lh.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");n=Lc[e]}return Ih(n)}const Nh=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Dh(e){return e.replace(Nh,kh)}function kh(e,t,n,r){let i="";for(let e=parseInt(t);e<parseInt(n);e++)i+=r.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return i}function Oh(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\tprecision ${e.precision} sampler3D;\n\tprecision ${e.precision} sampler2DArray;\n\tprecision ${e.precision} sampler2DShadow;\n\tprecision ${e.precision} samplerCubeShadow;\n\tprecision ${e.precision} sampler2DArrayShadow;\n\tprecision ${e.precision} isampler2D;\n\tprecision ${e.precision} isampler3D;\n\tprecision ${e.precision} isamplerCube;\n\tprecision ${e.precision} isampler2DArray;\n\tprecision ${e.precision} usampler2D;\n\tprecision ${e.precision} usampler3D;\n\tprecision ${e.precision} usamplerCube;\n\tprecision ${e.precision} usampler2DArray;\n\t`;return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function Fh(e,t,n,r){const i=e.getContext(),s=n.defines;let a=n.vertexShader,o=n.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(n),u=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case q:case X:t="ENVMAP_TYPE_CUBE";break;case Q:t="ENVMAP_TYPE_CUBE_UV"}return t}(n),c=function(e){let t="ENVMAP_MODE_REFLECTION";e.envMap&&e.envMapMode===X&&(t="ENVMAP_MODE_REFRACTION");return t}(n),d=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(n),h=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const n=Math.log2(t)-2,r=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,n),112)),texelHeight:r,maxMip:n}}(n),f=function(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(wh).join("\n")}(n),p=function(e){const t=[];for(const n in e){const r=e[n];!1!==r&&t.push("#define "+n+" "+r)}return t.join("\n")}(s),m=i.createProgram();let g,v,y=n.glslVersion?"#version "+n.glslVersion+"\n":"";n.isRawShaderMaterial?(g=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,p].filter(wh).join("\n"),g.length>0&&(g+="\n"),v=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,p].filter(wh).join("\n"),v.length>0&&(v+="\n")):(g=[Oh(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,p,n.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",n.batching?"#define USE_BATCHING":"",n.batchingColor?"#define USE_BATCHING_COLOR":"",n.instancing?"#define USE_INSTANCING":"",n.instancingColor?"#define USE_INSTANCING_COLOR":"",n.instancingMorph?"#define USE_INSTANCING_MORPH":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+c:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.displacementMap?"#define USE_DISPLACEMENTMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.mapUv?"#define MAP_UV "+n.mapUv:"",n.alphaMapUv?"#define ALPHAMAP_UV "+n.alphaMapUv:"",n.lightMapUv?"#define LIGHTMAP_UV "+n.lightMapUv:"",n.aoMapUv?"#define AOMAP_UV "+n.aoMapUv:"",n.emissiveMapUv?"#define EMISSIVEMAP_UV "+n.emissiveMapUv:"",n.bumpMapUv?"#define BUMPMAP_UV "+n.bumpMapUv:"",n.normalMapUv?"#define NORMALMAP_UV "+n.normalMapUv:"",n.displacementMapUv?"#define DISPLACEMENTMAP_UV "+n.displacementMapUv:"",n.metalnessMapUv?"#define METALNESSMAP_UV "+n.metalnessMapUv:"",n.roughnessMapUv?"#define ROUGHNESSMAP_UV "+n.roughnessMapUv:"",n.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+n.anisotropyMapUv:"",n.clearcoatMapUv?"#define CLEARCOATMAP_UV "+n.clearcoatMapUv:"",n.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+n.clearcoatNormalMapUv:"",n.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+n.clearcoatRoughnessMapUv:"",n.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+n.iridescenceMapUv:"",n.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+n.iridescenceThicknessMapUv:"",n.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+n.sheenColorMapUv:"",n.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+n.sheenRoughnessMapUv:"",n.specularMapUv?"#define SPECULARMAP_UV "+n.specularMapUv:"",n.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+n.specularColorMapUv:"",n.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+n.specularIntensityMapUv:"",n.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+n.transmissionMapUv:"",n.thicknessMapUv?"#define THICKNESSMAP_UV "+n.thicknessMapUv:"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.morphColors?"#define USE_MORPHCOLORS":"",n.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+n.morphTextureStride:"",n.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+n.morphTargetsCount:"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(wh).join("\n"),v=[Oh(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,p,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",n.map?"#define USE_MAP":"",n.matcap?"#define USE_MATCAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+u:"",n.envMap?"#define "+c:"",n.envMap?"#define "+d:"",h?"#define CUBEUV_TEXEL_WIDTH "+h.texelWidth:"",h?"#define CUBEUV_TEXEL_HEIGHT "+h.texelHeight:"",h?"#define CUBEUV_MAX_MIP "+h.maxMip+".0":"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoat?"#define USE_CLEARCOAT":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.dispersion?"#define USE_DISPERSION":"",n.iridescence?"#define USE_IRIDESCENCE":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaTest?"#define USE_ALPHATEST":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.sheen?"#define USE_SHEEN":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors||n.instancingColor||n.batchingColor?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",n.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==n.toneMapping?"#define TONE_MAPPING":"",0!==n.toneMapping?Lc.tonemapping_pars_fragment:"",0!==n.toneMapping?Th("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",n.opaque?"#define OPAQUE":"",Lc.colorspace_pars_fragment,Sh("linearToOutputTexel",n.outputColorSpace),Ah(),n.useDepthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(wh).join("\n")),a=Ih(a),a=Mh(a,n),a=Rh(a,n),o=Ih(o),o=Mh(o,n),o=Rh(o,n),a=Dh(a),o=Dh(o),!0!==n.isRawShaderMaterial&&(y="#version 300 es\n",g=[f,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,v=["#define varying in",n.glslVersion===Dt?"":"layout(location = 0) out highp vec4 pc_fragColor;",n.glslVersion===Dt?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+v);const b=y+g+a,_=y+v+o,x=yh(i,i.VERTEX_SHADER,b),S=yh(i,i.FRAGMENT_SHADER,_);function T(t){if(e.debug.checkShaderErrors){const n=i.getProgramInfoLog(m).trim(),r=i.getShaderInfoLog(x).trim(),s=i.getShaderInfoLog(S).trim();let a=!0,o=!0;if(!1===i.getProgramParameter(m,i.LINK_STATUS))if(a=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(i,m,x,S);else{xh(i,x,"vertex"),xh(i,S,"fragment")}else""!==n||""!==r&&""!==s||(o=!1);o&&(t.diagnostics={runnable:a,programLog:n,vertexShader:{log:r,prefix:g},fragmentShader:{log:s,prefix:v}})}i.deleteShader(x),i.deleteShader(S),E=new vh(i,m),A=function(e,t){const n={},r=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let i=0;i<r;i++){const r=e.getActiveAttrib(t,i),s=r.name;let a=1;r.type===e.FLOAT_MAT2&&(a=2),r.type===e.FLOAT_MAT3&&(a=3),r.type===e.FLOAT_MAT4&&(a=4),n[s]={type:r.type,location:e.getAttribLocation(t,s),locationSize:a}}return n}(i,m)}let E,A;i.attachShader(m,x),i.attachShader(m,S),void 0!==n.index0AttributeName?i.bindAttribLocation(m,0,n.index0AttributeName):!0===n.morphTargets&&i.bindAttribLocation(m,0,"position"),i.linkProgram(m),this.getUniforms=function(){return void 0===E&&T(this),E},this.getAttributes=function(){return void 0===A&&T(this),A};let w=!1===n.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===w&&(w=i.getProgramParameter(m,37297)),w},this.destroy=function(){r.releaseStatesOfProgram(this),i.deleteProgram(m),this.program=void 0},this.type=n.shaderType,this.name=n.shaderName,this.id=bh++,this.cacheKey=t,this.usedTimes=1,this.program=m,this.vertexShader=x,this.fragmentShader=S,this}let Uh=0;class Bh{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,n=e.fragmentShader,r=this._getShaderStage(t),i=this._getShaderStage(n),s=this._getShaderCacheForMaterial(e);return!1===s.has(r)&&(s.add(r),r.usedTimes++),!1===s.has(i)&&(s.add(i),i.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const e of t)e.usedTimes--,0===e.usedTimes&&this.shaderCache.delete(e.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let n=t.get(e);return void 0===n&&(n=new Set,t.set(e,n)),n}_getShaderStage(e){const t=this.shaderCache;let n=t.get(e);return void 0===n&&(n=new Vh(e),t.set(e,n)),n}}class Vh{constructor(e){this.id=Uh++,this.code=e,this.usedTimes=0}}function zh(e,t,n,r,i,s,a){const o=new hr,l=new Bh,u=new Set,c=[],d=i.logarithmicDepthBuffer,h=i.vertexTextures;let f=i.precision;const p={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function m(e){return u.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(s,o,c,g,v){const y=g.fog,b=v.geometry,_=s.isMeshStandardMaterial?g.environment:null,x=(s.isMeshStandardMaterial?n:t).get(s.envMap||_),S=x&&x.mapping===Q?x.image.height:null,T=p[s.type];null!==s.precision&&(f=i.getMaxPrecision(s.precision),s.precision);const E=b.morphAttributes.position||b.morphAttributes.normal||b.morphAttributes.color,A=void 0!==E?E.length:0;let w,M,R,C,I=0;if(void 0!==b.morphAttributes.position&&(I=1),void 0!==b.morphAttributes.normal&&(I=2),void 0!==b.morphAttributes.color&&(I=3),T){const e=Nc[T];w=e.vertexShader,M=e.fragmentShader}else w=s.vertexShader,M=s.fragmentShader,l.update(s),R=l.getVertexShaderID(s),C=l.getFragmentShaderID(s);const L=e.getRenderTarget(),P=e.state.buffers.depth.getReversed(),N=!0===v.isInstancedMesh,D=!0===v.isBatchedMesh,k=!!s.map,O=!!s.matcap,F=!!x,U=!!s.aoMap,B=!!s.lightMap,V=!!s.bumpMap,z=!!s.normalMap,G=!!s.displacementMap,H=!!s.emissiveMap,$=!!s.metalnessMap,W=!!s.roughnessMap,j=s.anisotropy>0,q=s.clearcoat>0,X=s.dispersion>0,Y=s.iridescence>0,K=s.sheen>0,Z=s.transmission>0,J=j&&!!s.anisotropyMap,ee=q&&!!s.clearcoatMap,te=q&&!!s.clearcoatNormalMap,ne=q&&!!s.clearcoatRoughnessMap,re=Y&&!!s.iridescenceMap,ie=Y&&!!s.iridescenceThicknessMap,se=K&&!!s.sheenColorMap,ae=K&&!!s.sheenRoughnessMap,oe=!!s.specularMap,le=!!s.specularColorMap,ue=!!s.specularIntensityMap,ce=Z&&!!s.transmissionMap,de=Z&&!!s.thicknessMap,he=!!s.gradientMap,fe=!!s.alphaMap,pe=s.alphaTest>0,me=!!s.alphaHash,ge=!!s.extensions;let ve=0;s.toneMapped&&(null!==L&&!0!==L.isXRRenderTarget||(ve=e.toneMapping));const ye={shaderID:T,shaderType:s.type,shaderName:s.name,vertexShader:w,fragmentShader:M,defines:s.defines,customVertexShaderID:R,customFragmentShaderID:C,isRawShaderMaterial:!0===s.isRawShaderMaterial,glslVersion:s.glslVersion,precision:f,batching:D,batchingColor:D&&null!==v._colorsTexture,instancing:N,instancingColor:N&&null!==v.instanceColor,instancingMorph:N&&null!==v.morphTexture,supportsVertexTextures:h,outputColorSpace:null===L?e.outputColorSpace:!0===L.isXRRenderTarget?L.texture.colorSpace:bt,alphaToCoverage:!!s.alphaToCoverage,map:k,matcap:O,envMap:F,envMapMode:F&&x.mapping,envMapCubeUVHeight:S,aoMap:U,lightMap:B,bumpMap:V,normalMap:z,displacementMap:h&&G,emissiveMap:H,normalMapObjectSpace:z&&1===s.normalMapType,normalMapTangentSpace:z&&0===s.normalMapType,metalnessMap:$,roughnessMap:W,anisotropy:j,anisotropyMap:J,clearcoat:q,clearcoatMap:ee,clearcoatNormalMap:te,clearcoatRoughnessMap:ne,dispersion:X,iridescence:Y,iridescenceMap:re,iridescenceThicknessMap:ie,sheen:K,sheenColorMap:se,sheenRoughnessMap:ae,specularMap:oe,specularColorMap:le,specularIntensityMap:ue,transmission:Z,transmissionMap:ce,thicknessMap:de,gradientMap:he,opaque:!1===s.transparent&&1===s.blending&&!1===s.alphaToCoverage,alphaMap:fe,alphaTest:pe,alphaHash:me,combine:s.combine,mapUv:k&&m(s.map.channel),aoMapUv:U&&m(s.aoMap.channel),lightMapUv:B&&m(s.lightMap.channel),bumpMapUv:V&&m(s.bumpMap.channel),normalMapUv:z&&m(s.normalMap.channel),displacementMapUv:G&&m(s.displacementMap.channel),emissiveMapUv:H&&m(s.emissiveMap.channel),metalnessMapUv:$&&m(s.metalnessMap.channel),roughnessMapUv:W&&m(s.roughnessMap.channel),anisotropyMapUv:J&&m(s.anisotropyMap.channel),clearcoatMapUv:ee&&m(s.clearcoatMap.channel),clearcoatNormalMapUv:te&&m(s.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:ne&&m(s.clearcoatRoughnessMap.channel),iridescenceMapUv:re&&m(s.iridescenceMap.channel),iridescenceThicknessMapUv:ie&&m(s.iridescenceThicknessMap.channel),sheenColorMapUv:se&&m(s.sheenColorMap.channel),sheenRoughnessMapUv:ae&&m(s.sheenRoughnessMap.channel),specularMapUv:oe&&m(s.specularMap.channel),specularColorMapUv:le&&m(s.specularColorMap.channel),specularIntensityMapUv:ue&&m(s.specularIntensityMap.channel),transmissionMapUv:ce&&m(s.transmissionMap.channel),thicknessMapUv:de&&m(s.thicknessMap.channel),alphaMapUv:fe&&m(s.alphaMap.channel),vertexTangents:!!b.attributes.tangent&&(z||j),vertexColors:s.vertexColors,vertexAlphas:!0===s.vertexColors&&!!b.attributes.color&&4===b.attributes.color.itemSize,pointsUvs:!0===v.isPoints&&!!b.attributes.uv&&(k||fe),fog:!!y,useFog:!0===s.fog,fogExp2:!!y&&y.isFogExp2,flatShading:!0===s.flatShading,sizeAttenuation:!0===s.sizeAttenuation,logarithmicDepthBuffer:d,reverseDepthBuffer:P,skinning:!0===v.isSkinnedMesh,morphTargets:void 0!==b.morphAttributes.position,morphNormals:void 0!==b.morphAttributes.normal,morphColors:void 0!==b.morphAttributes.color,morphTargetsCount:A,morphTextureStride:I,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numSpotLightMaps:o.spotLightMap.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numSpotLightShadowsWithMaps:o.numSpotLightShadowsWithMaps,numLightProbes:o.numLightProbes,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,dithering:s.dithering,shadowMapEnabled:e.shadowMap.enabled&&c.length>0,shadowMapType:e.shadowMap.type,toneMapping:ve,decodeVideoTexture:k&&!0===s.map.isVideoTexture&&un.getTransfer(s.map.colorSpace)===xt,decodeVideoTextureEmissive:H&&!0===s.emissiveMap.isVideoTexture&&un.getTransfer(s.emissiveMap.colorSpace)===xt,premultipliedAlpha:s.premultipliedAlpha,doubleSided:2===s.side,flipSided:1===s.side,useDepthPacking:s.depthPacking>=0,depthPacking:s.depthPacking||0,index0AttributeName:s.index0AttributeName,extensionClipCullDistance:ge&&!0===s.extensions.clipCullDistance&&r.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(ge&&!0===s.extensions.multiDraw||D)&&r.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:r.has("KHR_parallel_shader_compile"),customProgramCacheKey:s.customProgramCacheKey()};return ye.vertexUv1s=u.has(1),ye.vertexUv2s=u.has(2),ye.vertexUv3s=u.has(3),u.clear(),ye},getProgramCacheKey:function(t){const n=[];if(t.shaderID?n.push(t.shaderID):(n.push(t.customVertexShaderID),n.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)n.push(e),n.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(!function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(n,t),function(e,t){o.disableAll(),t.supportsVertexTextures&&o.enable(0);t.instancing&&o.enable(1);t.instancingColor&&o.enable(2);t.instancingMorph&&o.enable(3);t.matcap&&o.enable(4);t.envMap&&o.enable(5);t.normalMapObjectSpace&&o.enable(6);t.normalMapTangentSpace&&o.enable(7);t.clearcoat&&o.enable(8);t.iridescence&&o.enable(9);t.alphaTest&&o.enable(10);t.vertexColors&&o.enable(11);t.vertexAlphas&&o.enable(12);t.vertexUv1s&&o.enable(13);t.vertexUv2s&&o.enable(14);t.vertexUv3s&&o.enable(15);t.vertexTangents&&o.enable(16);t.anisotropy&&o.enable(17);t.alphaHash&&o.enable(18);t.batching&&o.enable(19);t.dispersion&&o.enable(20);t.batchingColor&&o.enable(21);e.push(o.mask),o.disableAll(),t.fog&&o.enable(0);t.useFog&&o.enable(1);t.flatShading&&o.enable(2);t.logarithmicDepthBuffer&&o.enable(3);t.reverseDepthBuffer&&o.enable(4);t.skinning&&o.enable(5);t.morphTargets&&o.enable(6);t.morphNormals&&o.enable(7);t.morphColors&&o.enable(8);t.premultipliedAlpha&&o.enable(9);t.shadowMapEnabled&&o.enable(10);t.doubleSided&&o.enable(11);t.flipSided&&o.enable(12);t.useDepthPacking&&o.enable(13);t.dithering&&o.enable(14);t.transmission&&o.enable(15);t.sheen&&o.enable(16);t.opaque&&o.enable(17);t.pointsUvs&&o.enable(18);t.decodeVideoTexture&&o.enable(19);t.decodeVideoTextureEmissive&&o.enable(20);t.alphaToCoverage&&o.enable(21);e.push(o.mask)}(n,t),n.push(e.outputColorSpace)),n.push(t.customProgramCacheKey),n.join()},getUniforms:function(e){const t=p[e.type];let n;if(t){const e=Nc[t];n=ki.clone(e.uniforms)}else n=e.uniforms;return n},acquireProgram:function(t,n){let r;for(let e=0,t=c.length;e<t;e++){const t=c[e];if(t.cacheKey===n){r=t,++r.usedTimes;break}}return void 0===r&&(r=new Fh(e,n,t,s),c.push(r)),r},releaseProgram:function(e){if(0===--e.usedTimes){const t=c.indexOf(e);c[t]=c[c.length-1],c.pop(),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:c,dispose:function(){l.dispose()}}}function Gh(){let e=new WeakMap;return{has:function(t){return e.has(t)},get:function(t){let n=e.get(t);return void 0===n&&(n={},e.set(t,n)),n},remove:function(t){e.delete(t)},update:function(t,n,r){e.get(t)[n]=r},dispose:function(){e=new WeakMap}}}function Hh(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function $h(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Wh(){const e=[];let t=0;const n=[],r=[],i=[];function s(n,r,i,s,a,o){let l=e[t];return void 0===l?(l={id:n.id,object:n,geometry:r,material:i,groupOrder:s,renderOrder:n.renderOrder,z:a,group:o},e[t]=l):(l.id=n.id,l.object=n,l.geometry=r,l.material=i,l.groupOrder=s,l.renderOrder=n.renderOrder,l.z=a,l.group=o),t++,l}return{opaque:n,transmissive:r,transparent:i,init:function(){t=0,n.length=0,r.length=0,i.length=0},push:function(e,t,a,o,l,u){const c=s(e,t,a,o,l,u);a.transmission>0?r.push(c):!0===a.transparent?i.push(c):n.push(c)},unshift:function(e,t,a,o,l,u){const c=s(e,t,a,o,l,u);a.transmission>0?r.unshift(c):!0===a.transparent?i.unshift(c):n.unshift(c)},finish:function(){for(let n=t,r=e.length;n<r;n++){const t=e[n];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){n.length>1&&n.sort(e||Hh),r.length>1&&r.sort(t||$h),i.length>1&&i.sort(t||$h)}}}function jh(){let e=new WeakMap;return{get:function(t,n){const r=e.get(t);let i;return void 0===r?(i=new Wh,e.set(t,[i])):n>=r.length?(i=new Wh,r.push(i)):i=r[n],i},dispose:function(){e=new WeakMap}}}function qh(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":n={direction:new An,color:new qr};break;case"SpotLight":n={position:new An,direction:new An,color:new qr,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":n={position:new An,color:new qr,distance:0,decay:0};break;case"HemisphereLight":n={direction:new An,skyColor:new qr,groundColor:new qr};break;case"RectAreaLight":n={color:new qr,position:new An,halfWidth:new An,halfHeight:new An}}return e[t.id]=n,n}}}let Xh=0;function Yh(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function Kh(e){const t=new qh,n=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":case"SpotLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Yt};break;case"PointLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Yt,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=n,n}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)r.probe.push(new An);const i=new An,s=new tr,a=new tr;return{setup:function(i){let s=0,a=0,o=0;for(let e=0;e<9;e++)r.probe[e].set(0,0,0);let l=0,u=0,c=0,d=0,h=0,f=0,p=0,m=0,g=0,v=0,y=0;i.sort(Yh);for(let e=0,b=i.length;e<b;e++){const b=i[e],_=b.color,x=b.intensity,S=b.distance,T=b.shadow&&b.shadow.map?b.shadow.map.texture:null;if(b.isAmbientLight)s+=_.r*x,a+=_.g*x,o+=_.b*x;else if(b.isLightProbe){for(let e=0;e<9;e++)r.probe[e].addScaledVector(b.sh.coefficients[e],x);y++}else if(b.isDirectionalLight){const e=t.get(b);if(e.color.copy(b.color).multiplyScalar(b.intensity),b.castShadow){const e=b.shadow,t=n.get(b);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,r.directionalShadow[l]=t,r.directionalShadowMap[l]=T,r.directionalShadowMatrix[l]=b.shadow.matrix,f++}r.directional[l]=e,l++}else if(b.isSpotLight){const e=t.get(b);e.position.setFromMatrixPosition(b.matrixWorld),e.color.copy(_).multiplyScalar(x),e.distance=S,e.coneCos=Math.cos(b.angle),e.penumbraCos=Math.cos(b.angle*(1-b.penumbra)),e.decay=b.decay,r.spot[c]=e;const i=b.shadow;if(b.map&&(r.spotLightMap[g]=b.map,g++,i.updateMatrices(b),b.castShadow&&v++),r.spotLightMatrix[c]=i.matrix,b.castShadow){const e=n.get(b);e.shadowIntensity=i.intensity,e.shadowBias=i.bias,e.shadowNormalBias=i.normalBias,e.shadowRadius=i.radius,e.shadowMapSize=i.mapSize,r.spotShadow[c]=e,r.spotShadowMap[c]=T,m++}c++}else if(b.isRectAreaLight){const e=t.get(b);e.color.copy(_).multiplyScalar(x),e.halfWidth.set(.5*b.width,0,0),e.halfHeight.set(0,.5*b.height,0),r.rectArea[d]=e,d++}else if(b.isPointLight){const e=t.get(b);if(e.color.copy(b.color).multiplyScalar(b.intensity),e.distance=b.distance,e.decay=b.decay,b.castShadow){const e=b.shadow,t=n.get(b);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,r.pointShadow[u]=t,r.pointShadowMap[u]=T,r.pointShadowMatrix[u]=b.shadow.matrix,p++}r.point[u]=e,u++}else if(b.isHemisphereLight){const e=t.get(b);e.skyColor.copy(b.color).multiplyScalar(x),e.groundColor.copy(b.groundColor).multiplyScalar(x),r.hemi[h]=e,h++}}d>0&&(!0===e.has("OES_texture_float_linear")?(r.rectAreaLTC1=Pc.LTC_FLOAT_1,r.rectAreaLTC2=Pc.LTC_FLOAT_2):(r.rectAreaLTC1=Pc.LTC_HALF_1,r.rectAreaLTC2=Pc.LTC_HALF_2)),r.ambient[0]=s,r.ambient[1]=a,r.ambient[2]=o;const b=r.hash;b.directionalLength===l&&b.pointLength===u&&b.spotLength===c&&b.rectAreaLength===d&&b.hemiLength===h&&b.numDirectionalShadows===f&&b.numPointShadows===p&&b.numSpotShadows===m&&b.numSpotMaps===g&&b.numLightProbes===y||(r.directional.length=l,r.spot.length=c,r.rectArea.length=d,r.point.length=u,r.hemi.length=h,r.directionalShadow.length=f,r.directionalShadowMap.length=f,r.pointShadow.length=p,r.pointShadowMap.length=p,r.spotShadow.length=m,r.spotShadowMap.length=m,r.directionalShadowMatrix.length=f,r.pointShadowMatrix.length=p,r.spotLightMatrix.length=m+g-v,r.spotLightMap.length=g,r.numSpotLightShadowsWithMaps=v,r.numLightProbes=y,b.directionalLength=l,b.pointLength=u,b.spotLength=c,b.rectAreaLength=d,b.hemiLength=h,b.numDirectionalShadows=f,b.numPointShadows=p,b.numSpotShadows=m,b.numSpotMaps=g,b.numLightProbes=y,r.version=Xh++)},setupView:function(e,t){let n=0,o=0,l=0,u=0,c=0;const d=t.matrixWorldInverse;for(let t=0,h=e.length;t<h;t++){const h=e[t];if(h.isDirectionalLight){const e=r.directional[n];e.direction.setFromMatrixPosition(h.matrixWorld),i.setFromMatrixPosition(h.target.matrixWorld),e.direction.sub(i),e.direction.transformDirection(d),n++}else if(h.isSpotLight){const e=r.spot[l];e.position.setFromMatrixPosition(h.matrixWorld),e.position.applyMatrix4(d),e.direction.setFromMatrixPosition(h.matrixWorld),i.setFromMatrixPosition(h.target.matrixWorld),e.direction.sub(i),e.direction.transformDirection(d),l++}else if(h.isRectAreaLight){const e=r.rectArea[u];e.position.setFromMatrixPosition(h.matrixWorld),e.position.applyMatrix4(d),a.identity(),s.copy(h.matrixWorld),s.premultiply(d),a.extractRotation(s),e.halfWidth.set(.5*h.width,0,0),e.halfHeight.set(0,.5*h.height,0),e.halfWidth.applyMatrix4(a),e.halfHeight.applyMatrix4(a),u++}else if(h.isPointLight){const e=r.point[o];e.position.setFromMatrixPosition(h.matrixWorld),e.position.applyMatrix4(d),o++}else if(h.isHemisphereLight){const e=r.hemi[c];e.direction.setFromMatrixPosition(h.matrixWorld),e.direction.transformDirection(d),c++}}},state:r}}function Qh(e){const t=new Kh(e),n=[],r=[];const i={lightsArray:n,shadowsArray:r,camera:null,lights:t,transmissionRenderTarget:{}};return{init:function(e){i.camera=e,n.length=0,r.length=0},state:i,setupLights:function(){t.setup(n)},setupLightsView:function(e){t.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){r.push(e)}}}function Zh(e){let t=new WeakMap;return{get:function(n,r=0){const i=t.get(n);let s;return void 0===i?(s=new Qh(e),t.set(n,[s])):r>=i.length?(s=new Qh(e),i.push(s)):s=i[r],s},dispose:function(){t=new WeakMap}}}function Jh(e,t,n){let r=new qs;const i=new Yt,s=new Yt,a=new bn,o=new vl({depthPacking:3201}),l=new yl,u={},c=n.maxTextureSize,d={[m]:1,[g]:0,[v]:2},h=new Oi({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new Yt},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),f=h.clone();f.defines.HORIZONTAL_PASS=1;const p=new vi;p.setAttribute("position",new si(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const y=new Ci(p,h),b=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1;let _=this.type;function x(n,r){const s=t.update(y);h.defines.VSM_SAMPLES!==n.blurSamples&&(h.defines.VSM_SAMPLES=n.blurSamples,f.defines.VSM_SAMPLES=n.blurSamples,h.needsUpdate=!0,f.needsUpdate=!0),null===n.mapPass&&(n.mapPass=new xn(i.x,i.y)),h.uniforms.shadow_pass.value=n.map.texture,h.uniforms.resolution.value=n.mapSize,h.uniforms.radius.value=n.radius,e.setRenderTarget(n.mapPass),e.clear(),e.renderBufferDirect(r,null,s,h,y,null),f.uniforms.shadow_pass.value=n.mapPass.texture,f.uniforms.resolution.value=n.mapSize,f.uniforms.radius.value=n.radius,e.setRenderTarget(n.map),e.clear(),e.renderBufferDirect(r,null,s,f,y,null)}function S(t,n,r,i){let s=null;const a=!0===r.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==a)s=a;else if(s=!0===r.isPointLight?l:o,e.localClippingEnabled&&!0===n.clipShadows&&Array.isArray(n.clippingPlanes)&&0!==n.clippingPlanes.length||n.displacementMap&&0!==n.displacementScale||n.alphaMap&&n.alphaTest>0||n.map&&n.alphaTest>0){const e=s.uuid,t=n.uuid;let r=u[e];void 0===r&&(r={},u[e]=r);let i=r[t];void 0===i&&(i=s.clone(),r[t]=i,n.addEventListener("dispose",E)),s=i}if(s.visible=n.visible,s.wireframe=n.wireframe,s.side=3===i?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:d[n.side],s.alphaMap=n.alphaMap,s.alphaTest=n.alphaTest,s.map=n.map,s.clipShadows=n.clipShadows,s.clippingPlanes=n.clippingPlanes,s.clipIntersection=n.clipIntersection,s.displacementMap=n.displacementMap,s.displacementScale=n.displacementScale,s.displacementBias=n.displacementBias,s.wireframeLinewidth=n.wireframeLinewidth,s.linewidth=n.linewidth,!0===r.isPointLight&&!0===s.isMeshDistanceMaterial){e.properties.get(s).light=r}return s}function T(n,i,s,a,o){if(!1===n.visible)return;if(n.layers.test(i.layers)&&(n.isMesh||n.isLine||n.isPoints)&&(n.castShadow||n.receiveShadow&&3===o)&&(!n.frustumCulled||r.intersectsObject(n))){n.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,n.matrixWorld);const r=t.update(n),l=n.material;if(Array.isArray(l)){const t=r.groups;for(let u=0,c=t.length;u<c;u++){const c=t[u],d=l[c.materialIndex];if(d&&d.visible){const t=S(n,d,a,o);n.onBeforeShadow(e,n,i,s,r,t,c),e.renderBufferDirect(s,null,r,t,n,c),n.onAfterShadow(e,n,i,s,r,t,c)}}}else if(l.visible){const t=S(n,l,a,o);n.onBeforeShadow(e,n,i,s,r,t,null),e.renderBufferDirect(s,null,r,t,n,null),n.onAfterShadow(e,n,i,s,r,t,null)}}const l=n.children;for(let e=0,t=l.length;e<t;e++)T(l[e],i,s,a,o)}function E(e){e.target.removeEventListener("dispose",E);for(const t in u){const n=u[t],r=e.target.uuid;if(r in n){n[r].dispose(),delete n[r]}}}this.render=function(t,n,o){if(!1===b.enabled)return;if(!1===b.autoUpdate&&!1===b.needsUpdate)return;if(0===t.length)return;const l=e.getRenderTarget(),u=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),h=e.state;h.setBlending(0),h.buffers.color.setClear(1,1,1,1),h.buffers.depth.setTest(!0),h.setScissorTest(!1);const f=3!==_&&3===this.type,p=3===_&&3!==this.type;for(let l=0,u=t.length;l<u;l++){const u=t[l],d=u.shadow;if(void 0===d)continue;if(!1===d.autoUpdate&&!1===d.needsUpdate)continue;i.copy(d.mapSize);const m=d.getFrameExtents();if(i.multiply(m),s.copy(d.mapSize),(i.x>c||i.y>c)&&(i.x>c&&(s.x=Math.floor(c/m.x),i.x=s.x*m.x,d.mapSize.x=s.x),i.y>c&&(s.y=Math.floor(c/m.y),i.y=s.y*m.y,d.mapSize.y=s.y)),null===d.map||!0===f||!0===p){const e=3!==this.type?{minFilter:te,magFilter:te}:{};null!==d.map&&d.map.dispose(),d.map=new xn(i.x,i.y,e),d.map.texture.name=u.name+".shadowMap",d.camera.updateProjectionMatrix()}e.setRenderTarget(d.map),e.clear();const g=d.getViewportCount();for(let e=0;e<g;e++){const t=d.getViewport(e);a.set(s.x*t.x,s.y*t.y,s.x*t.z,s.y*t.w),h.viewport(a),d.updateMatrices(u,e),r=d.getFrustum(),T(n,o,d.camera,u,this.type)}!0!==d.isPointLightShadow&&3===this.type&&x(d,o),d.needsUpdate=!1}_=this.type,b.needsUpdate=!1,e.setRenderTarget(l,u,d)}}const ef={[O]:1,[U]:6,[V]:7,[B]:5,[F]:0,[G]:2,[H]:4,[z]:3};function tf(e,t){const n=new function(){let t=!1;const n=new bn;let r=null;const i=new bn(0,0,0,0);return{setMask:function(n){r===n||t||(e.colorMask(n,n,n,n),r=n)},setLocked:function(e){t=e},setClear:function(t,r,s,a,o){!0===o&&(t*=a,r*=a,s*=a),n.set(t,r,s,a),!1===i.equals(n)&&(e.clearColor(t,r,s,a),i.copy(n))},reset:function(){t=!1,r=null,i.set(-1,0,0,0)}}},r=new function(){let n=!1,r=!1,i=null,s=null,a=null;return{setReversed:function(e){if(r!==e){const e=t.get("EXT_clip_control");r?e.clipControlEXT(e.LOWER_LEFT_EXT,e.ZERO_TO_ONE_EXT):e.clipControlEXT(e.LOWER_LEFT_EXT,e.NEGATIVE_ONE_TO_ONE_EXT);const n=a;a=null,this.setClear(n)}r=e},getReversed:function(){return r},setTest:function(t){t?ie(e.DEPTH_TEST):se(e.DEPTH_TEST)},setMask:function(t){i===t||n||(e.depthMask(t),i=t)},setFunc:function(t){if(r&&(t=ef[t]),s!==t){switch(t){case 0:e.depthFunc(e.NEVER);break;case 1:e.depthFunc(e.ALWAYS);break;case 2:e.depthFunc(e.LESS);break;case 3:default:e.depthFunc(e.LEQUAL);break;case 4:e.depthFunc(e.EQUAL);break;case 5:e.depthFunc(e.GEQUAL);break;case 6:e.depthFunc(e.GREATER);break;case 7:e.depthFunc(e.NOTEQUAL)}s=t}},setLocked:function(e){n=e},setClear:function(t){a!==t&&(r&&(t=1-t),e.clearDepth(t),a=t)},reset:function(){n=!1,i=null,s=null,a=null,r=!1}}},i=new function(){let t=!1,n=null,r=null,i=null,s=null,a=null,o=null,l=null,u=null;return{setTest:function(n){t||(n?ie(e.STENCIL_TEST):se(e.STENCIL_TEST))},setMask:function(r){n===r||t||(e.stencilMask(r),n=r)},setFunc:function(t,n,a){r===t&&i===n&&s===a||(e.stencilFunc(t,n,a),r=t,i=n,s=a)},setOp:function(t,n,r){a===t&&o===n&&l===r||(e.stencilOp(t,n,r),a=t,o=n,l=r)},setLocked:function(e){t=e},setClear:function(t){u!==t&&(e.clearStencil(t),u=t)},reset:function(){t=!1,n=null,r=null,i=null,s=null,a=null,o=null,l=null,u=null}}},s=new WeakMap,a=new WeakMap;let o={},l={},u=new WeakMap,c=[],d=null,h=!1,f=null,p=null,m=null,g=null,v=null,O=null,F=null,U=new qr(0,0,0),B=0,V=!1,z=null,G=null,H=null,$=null,W=null;const j=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let q=!1,X=0;const Y=e.getParameter(e.VERSION);-1!==Y.indexOf("WebGL")?(X=parseFloat(/^WebGL (\d)/.exec(Y)[1]),q=X>=1):-1!==Y.indexOf("OpenGL ES")&&(X=parseFloat(/^OpenGL ES (\d)/.exec(Y)[1]),q=X>=2);let K=null,Q={};const Z=e.getParameter(e.SCISSOR_BOX),J=e.getParameter(e.VIEWPORT),ee=(new bn).fromArray(Z),te=(new bn).fromArray(J);function ne(t,n,r,i){const s=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let a=0;a<r;a++)t===e.TEXTURE_3D||t===e.TEXTURE_2D_ARRAY?e.texImage3D(n,0,e.RGBA,1,1,i,0,e.RGBA,e.UNSIGNED_BYTE,s):e.texImage2D(n+a,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,s);return a}const re={};function ie(t){!0!==o[t]&&(e.enable(t),o[t]=!0)}function se(t){!1!==o[t]&&(e.disable(t),o[t]=!1)}re[e.TEXTURE_2D]=ne(e.TEXTURE_2D,e.TEXTURE_2D,1),re[e.TEXTURE_CUBE_MAP]=ne(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),re[e.TEXTURE_2D_ARRAY]=ne(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),re[e.TEXTURE_3D]=ne(e.TEXTURE_3D,e.TEXTURE_3D,1,1),n.setClear(0,0,0,1),r.setClear(1),i.setClear(0),ie(e.DEPTH_TEST),r.setFunc(3),ue(!1),ce(1),ie(e.CULL_FACE),le(0);const ae={[y]:e.FUNC_ADD,[b]:e.FUNC_SUBTRACT,[_]:e.FUNC_REVERSE_SUBTRACT};ae[103]=e.MIN,ae[104]=e.MAX;const oe={[x]:e.ZERO,[S]:e.ONE,[T]:e.SRC_COLOR,[A]:e.SRC_ALPHA,[L]:e.SRC_ALPHA_SATURATE,[C]:e.DST_COLOR,[M]:e.DST_ALPHA,[E]:e.ONE_MINUS_SRC_COLOR,[w]:e.ONE_MINUS_SRC_ALPHA,[I]:e.ONE_MINUS_DST_COLOR,[R]:e.ONE_MINUS_DST_ALPHA,[P]:e.CONSTANT_COLOR,[N]:e.ONE_MINUS_CONSTANT_COLOR,[D]:e.CONSTANT_ALPHA,[k]:e.ONE_MINUS_CONSTANT_ALPHA};function le(t,n,r,i,s,a,o,l,u,c){if(0!==t){if(!1===h&&(ie(e.BLEND),h=!0),5===t)s=s||n,a=a||r,o=o||i,n===p&&s===v||(e.blendEquationSeparate(ae[n],ae[s]),p=n,v=s),r===m&&i===g&&a===O&&o===F||(e.blendFuncSeparate(oe[r],oe[i],oe[a],oe[o]),m=r,g=i,O=a,F=o),!1!==l.equals(U)&&u===B||(e.blendColor(l.r,l.g,l.b,u),U.copy(l),B=u),f=t,V=!1;else if(t!==f||c!==V){if(p===y&&v===y||(e.blendEquation(e.FUNC_ADD),p=y,v=y),c)switch(t){case 1:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.ONE,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA)}else switch(t){case 1:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFunc(e.ZERO,e.SRC_COLOR)}m=null,g=null,O=null,F=null,U.set(0,0,0),B=0,f=t,V=c}}else!0===h&&(se(e.BLEND),h=!1)}function ue(t){z!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),z=t)}function ce(t){0!==t?(ie(e.CULL_FACE),t!==G&&(1===t?e.cullFace(e.BACK):2===t?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):se(e.CULL_FACE),G=t}function de(t,n,r){t?(ie(e.POLYGON_OFFSET_FILL),$===n&&W===r||(e.polygonOffset(n,r),$=n,W=r)):se(e.POLYGON_OFFSET_FILL)}return{buffers:{color:n,depth:r,stencil:i},enable:ie,disable:se,bindFramebuffer:function(t,n){return l[t]!==n&&(e.bindFramebuffer(t,n),l[t]=n,t===e.DRAW_FRAMEBUFFER&&(l[e.FRAMEBUFFER]=n),t===e.FRAMEBUFFER&&(l[e.DRAW_FRAMEBUFFER]=n),!0)},drawBuffers:function(t,n){let r=c,i=!1;if(t){r=u.get(n),void 0===r&&(r=[],u.set(n,r));const s=t.textures;if(r.length!==s.length||r[0]!==e.COLOR_ATTACHMENT0){for(let t=0,n=s.length;t<n;t++)r[t]=e.COLOR_ATTACHMENT0+t;r.length=s.length,i=!0}}else r[0]!==e.BACK&&(r[0]=e.BACK,i=!0);i&&e.drawBuffers(r)},useProgram:function(t){return d!==t&&(e.useProgram(t),d=t,!0)},setBlending:le,setMaterial:function(t,s){2===t.side?se(e.CULL_FACE):ie(e.CULL_FACE);let a=1===t.side;s&&(a=!a),ue(a),1===t.blending&&!1===t.transparent?le(0):le(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),r.setFunc(t.depthFunc),r.setTest(t.depthTest),r.setMask(t.depthWrite),n.setMask(t.colorWrite);const o=t.stencilWrite;i.setTest(o),o&&(i.setMask(t.stencilWriteMask),i.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),i.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),de(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?ie(e.SAMPLE_ALPHA_TO_COVERAGE):se(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:ue,setCullFace:ce,setLineWidth:function(t){t!==H&&(q&&e.lineWidth(t),H=t)},setPolygonOffset:de,setScissorTest:function(t){t?ie(e.SCISSOR_TEST):se(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+j-1),K!==t&&(e.activeTexture(t),K=t)},bindTexture:function(t,n,r){void 0===r&&(r=null===K?e.TEXTURE0+j-1:K);let i=Q[r];void 0===i&&(i={type:void 0,texture:void 0},Q[r]=i),i.type===t&&i.texture===n||(K!==r&&(e.activeTexture(r),K=r),e.bindTexture(t,n||re[t]),i.type=t,i.texture=n)},unbindTexture:function(){const t=Q[K];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){}},compressedTexImage3D:function(){try{e.compressedTexImage3D.apply(e,arguments)}catch(e){}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(e){}},updateUBOMapping:function(t,n){let r=a.get(n);void 0===r&&(r=new WeakMap,a.set(n,r));let i=r.get(t);void 0===i&&(i=e.getUniformBlockIndex(n,t.name),r.set(t,i))},uniformBlockBinding:function(t,n){const r=a.get(n).get(t);s.get(n)!==r&&(e.uniformBlockBinding(n,r,t.__bindingPointIndex),s.set(n,r))},texStorage2D:function(){try{e.texStorage2D.apply(e,arguments)}catch(e){}},texStorage3D:function(){try{e.texStorage3D.apply(e,arguments)}catch(e){}},texSubImage2D:function(){try{e.texSubImage2D.apply(e,arguments)}catch(e){}},texSubImage3D:function(){try{e.texSubImage3D.apply(e,arguments)}catch(e){}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D.apply(e,arguments)}catch(e){}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D.apply(e,arguments)}catch(e){}},scissor:function(t){!1===ee.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),ee.copy(t))},viewport:function(t){!1===te.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),te.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),r.setReversed(!1),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),o={},K=null,Q={},l={},u=new WeakMap,c=[],d=null,h=!1,f=null,p=null,m=null,g=null,v=null,O=null,F=null,U=new qr(0,0,0),B=0,V=!1,z=null,G=null,H=null,$=null,W=null,ee.set(0,0,e.canvas.width,e.canvas.height),te.set(0,0,e.canvas.width,e.canvas.height),n.reset(),r.reset(),i.reset()}}}function nf(e,t,n,r,i,s,a){const o=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),u=new Yt,c=new WeakMap;let d;const h=new WeakMap;let f=!1;try{f="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function p(e,t){return f?new OffscreenCanvas(e,t):tn("canvas")}function m(e,t,n){let r=1;const i=z(e);if((i.width>n||i.height>n)&&(r=n/Math.max(i.width,i.height)),r<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const n=Math.floor(r*i.width),s=Math.floor(r*i.height);void 0===d&&(d=p(n,s));const a=t?p(n,s):d;a.width=n,a.height=s;return a.getContext("2d").drawImage(e,0,0,n,s),a}return e}return e}function g(e){return e.generateMipmaps}function v(t){e.generateMipmap(t)}function y(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function b(n,r,i,s,a=!1){if(null!==n&&void 0!==e[n])return e[n];let o=r;if(r===e.RED&&(i===e.FLOAT&&(o=e.R32F),i===e.HALF_FLOAT&&(o=e.R16F),i===e.UNSIGNED_BYTE&&(o=e.R8)),r===e.RED_INTEGER&&(i===e.UNSIGNED_BYTE&&(o=e.R8UI),i===e.UNSIGNED_SHORT&&(o=e.R16UI),i===e.UNSIGNED_INT&&(o=e.R32UI),i===e.BYTE&&(o=e.R8I),i===e.SHORT&&(o=e.R16I),i===e.INT&&(o=e.R32I)),r===e.RG&&(i===e.FLOAT&&(o=e.RG32F),i===e.HALF_FLOAT&&(o=e.RG16F),i===e.UNSIGNED_BYTE&&(o=e.RG8)),r===e.RG_INTEGER&&(i===e.UNSIGNED_BYTE&&(o=e.RG8UI),i===e.UNSIGNED_SHORT&&(o=e.RG16UI),i===e.UNSIGNED_INT&&(o=e.RG32UI),i===e.BYTE&&(o=e.RG8I),i===e.SHORT&&(o=e.RG16I),i===e.INT&&(o=e.RG32I)),r===e.RGB_INTEGER&&(i===e.UNSIGNED_BYTE&&(o=e.RGB8UI),i===e.UNSIGNED_SHORT&&(o=e.RGB16UI),i===e.UNSIGNED_INT&&(o=e.RGB32UI),i===e.BYTE&&(o=e.RGB8I),i===e.SHORT&&(o=e.RGB16I),i===e.INT&&(o=e.RGB32I)),r===e.RGBA_INTEGER&&(i===e.UNSIGNED_BYTE&&(o=e.RGBA8UI),i===e.UNSIGNED_SHORT&&(o=e.RGBA16UI),i===e.UNSIGNED_INT&&(o=e.RGBA32UI),i===e.BYTE&&(o=e.RGBA8I),i===e.SHORT&&(o=e.RGBA16I),i===e.INT&&(o=e.RGBA32I)),r===e.RGB&&i===e.UNSIGNED_INT_5_9_9_9_REV&&(o=e.RGB9_E5),r===e.RGBA){const t=a?_t:un.getTransfer(s);i===e.FLOAT&&(o=e.RGBA32F),i===e.HALF_FLOAT&&(o=e.RGBA16F),i===e.UNSIGNED_BYTE&&(o=t===xt?e.SRGB8_ALPHA8:e.RGBA8),i===e.UNSIGNED_SHORT_4_4_4_4&&(o=e.RGBA4),i===e.UNSIGNED_SHORT_5_5_5_1&&(o=e.RGB5_A1)}return o!==e.R16F&&o!==e.R32F&&o!==e.RG16F&&o!==e.RG32F&&o!==e.RGBA16F&&o!==e.RGBA32F||t.get("EXT_color_buffer_float"),o}function _(t,n){let r;return t?null===n||n===he||n===ve?r=e.DEPTH24_STENCIL8:n===fe?r=e.DEPTH32F_STENCIL8:n===ce&&(r=e.DEPTH24_STENCIL8):null===n||n===he||n===ve?r=e.DEPTH_COMPONENT24:n===fe?r=e.DEPTH_COMPONENT32F:n===ce&&(r=e.DEPTH_COMPONENT16),r}function x(e,t){return!0===g(e)||e.isFramebufferTexture&&e.minFilter!==te&&e.minFilter!==ie?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function S(e){const t=e.target;t.removeEventListener("dispose",S),function(e){const t=r.get(e);if(void 0===t.__webglInit)return;const n=e.source,i=h.get(n);if(i){const r=i[t.__cacheKey];r.usedTimes--,0===r.usedTimes&&E(e),0===Object.keys(i).length&&h.delete(n)}r.remove(e)}(t),t.isVideoTexture&&c.delete(t)}function T(t){const n=t.target;n.removeEventListener("dispose",T),function(t){const n=r.get(t);t.depthTexture&&(t.depthTexture.dispose(),r.remove(t.depthTexture));if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(n.__webglFramebuffer[t]))for(let r=0;r<n.__webglFramebuffer[t].length;r++)e.deleteFramebuffer(n.__webglFramebuffer[t][r]);else e.deleteFramebuffer(n.__webglFramebuffer[t]);n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer[t])}else{if(Array.isArray(n.__webglFramebuffer))for(let t=0;t<n.__webglFramebuffer.length;t++)e.deleteFramebuffer(n.__webglFramebuffer[t]);else e.deleteFramebuffer(n.__webglFramebuffer);if(n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer),n.__webglMultisampledFramebuffer&&e.deleteFramebuffer(n.__webglMultisampledFramebuffer),n.__webglColorRenderbuffer)for(let t=0;t<n.__webglColorRenderbuffer.length;t++)n.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(n.__webglColorRenderbuffer[t]);n.__webglDepthRenderbuffer&&e.deleteRenderbuffer(n.__webglDepthRenderbuffer)}const i=t.textures;for(let t=0,n=i.length;t<n;t++){const n=r.get(i[t]);n.__webglTexture&&(e.deleteTexture(n.__webglTexture),a.memory.textures--),r.remove(i[t])}r.remove(t)}(n)}function E(t){const n=r.get(t);e.deleteTexture(n.__webglTexture);const i=t.source;delete h.get(i)[n.__cacheKey],a.memory.textures--}let A=0;function w(t,i){const s=r.get(t);if(t.isVideoTexture&&function(e){const t=a.render.frame;c.get(e)!==t&&(c.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&s.__version!==t.version){const e=t.image;if(null===e);else if(!1!==e.complete)return void P(s,t,i)}n.bindTexture(e.TEXTURE_2D,s.__webglTexture,e.TEXTURE0+i)}const M={[Z]:e.REPEAT,[J]:e.CLAMP_TO_EDGE,[ee]:e.MIRRORED_REPEAT},R={[te]:e.NEAREST,[ne]:e.NEAREST_MIPMAP_NEAREST,[re]:e.NEAREST_MIPMAP_LINEAR,[ie]:e.LINEAR,[se]:e.LINEAR_MIPMAP_NEAREST,[ae]:e.LINEAR_MIPMAP_LINEAR},C={[Et]:e.NEVER,[Lt]:e.ALWAYS,[At]:e.LESS,[Mt]:e.LEQUAL,[wt]:e.EQUAL,[It]:e.GEQUAL,[Rt]:e.GREATER,[Ct]:e.NOTEQUAL};function I(n,s){if(s.type===fe&&!1===t.has("OES_texture_float_linear")&&(s.magFilter===ie||s.magFilter===se||s.magFilter===re||s.magFilter===ae||s.minFilter===ie||s.minFilter===se||s.minFilter===re||s.minFilter),e.texParameteri(n,e.TEXTURE_WRAP_S,M[s.wrapS]),e.texParameteri(n,e.TEXTURE_WRAP_T,M[s.wrapT]),n!==e.TEXTURE_3D&&n!==e.TEXTURE_2D_ARRAY||e.texParameteri(n,e.TEXTURE_WRAP_R,M[s.wrapR]),e.texParameteri(n,e.TEXTURE_MAG_FILTER,R[s.magFilter]),e.texParameteri(n,e.TEXTURE_MIN_FILTER,R[s.minFilter]),s.compareFunction&&(e.texParameteri(n,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(n,e.TEXTURE_COMPARE_FUNC,C[s.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(s.magFilter===te)return;if(s.minFilter!==re&&s.minFilter!==ae)return;if(s.type===fe&&!1===t.has("OES_texture_float_linear"))return;if(s.anisotropy>1||r.get(s).__currentAnisotropy){const a=t.get("EXT_texture_filter_anisotropic");e.texParameterf(n,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,i.getMaxAnisotropy())),r.get(s).__currentAnisotropy=s.anisotropy}}}function L(t,n){let r=!1;void 0===t.__webglInit&&(t.__webglInit=!0,n.addEventListener("dispose",S));const i=n.source;let s=h.get(i);void 0===s&&(s={},h.set(i,s));const o=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(n);if(o!==t.__cacheKey){void 0===s[o]&&(s[o]={texture:e.createTexture(),usedTimes:0},a.memory.textures++,r=!0),s[o].usedTimes++;const i=s[t.__cacheKey];void 0!==i&&(s[t.__cacheKey].usedTimes--,0===i.usedTimes&&E(n)),t.__cacheKey=o,t.__webglTexture=s[o].texture}return r}function P(t,a,o){let l=e.TEXTURE_2D;(a.isDataArrayTexture||a.isCompressedArrayTexture)&&(l=e.TEXTURE_2D_ARRAY),a.isData3DTexture&&(l=e.TEXTURE_3D);const u=L(t,a),c=a.source;n.bindTexture(l,t.__webglTexture,e.TEXTURE0+o);const d=r.get(c);if(c.version!==d.__version||!0===u){n.activeTexture(e.TEXTURE0+o);const t=un.getPrimaries(un.workingColorSpace),r=a.colorSpace===vt?null:un.getPrimaries(a.colorSpace),h=a.colorSpace===vt||t===r?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,a.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,h);let f=m(a.image,!1,i.maxTextureSize);f=V(a,f);const p=s.convert(a.format,a.colorSpace),y=s.convert(a.type);let S,T=b(a.internalFormat,p,y,a.colorSpace,a.isVideoTexture);I(l,a);const E=a.mipmaps,A=!0!==a.isVideoTexture,w=void 0===d.__version||!0===u,M=c.dataReady,R=x(a,f);if(a.isDepthTexture)T=_(a.format===Ae,a.type),w&&(A?n.texStorage2D(e.TEXTURE_2D,1,T,f.width,f.height):n.texImage2D(e.TEXTURE_2D,0,T,f.width,f.height,0,p,y,null));else if(a.isDataTexture)if(E.length>0){A&&w&&n.texStorage2D(e.TEXTURE_2D,R,T,E[0].width,E[0].height);for(let t=0,r=E.length;t<r;t++)S=E[t],A?M&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,S.width,S.height,p,y,S.data):n.texImage2D(e.TEXTURE_2D,t,T,S.width,S.height,0,p,y,S.data);a.generateMipmaps=!1}else A?(w&&n.texStorage2D(e.TEXTURE_2D,R,T,f.width,f.height),M&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,f.width,f.height,p,y,f.data)):n.texImage2D(e.TEXTURE_2D,0,T,f.width,f.height,0,p,y,f.data);else if(a.isCompressedTexture)if(a.isCompressedArrayTexture){A&&w&&n.texStorage3D(e.TEXTURE_2D_ARRAY,R,T,E[0].width,E[0].height,f.depth);for(let t=0,r=E.length;t<r;t++)if(S=E[t],a.format!==xe){if(null!==p)if(A){if(M)if(a.layerUpdates.size>0){const r=Mc(S.width,S.height,a.format,a.type);for(const i of a.layerUpdates){const s=S.data.subarray(i*r/S.data.BYTES_PER_ELEMENT,(i+1)*r/S.data.BYTES_PER_ELEMENT);n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,i,S.width,S.height,1,p,s)}a.clearLayerUpdates()}else n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,S.width,S.height,f.depth,p,S.data)}else n.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,T,S.width,S.height,f.depth,0,S.data,0,0)}else A?M&&n.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,S.width,S.height,f.depth,p,y,S.data):n.texImage3D(e.TEXTURE_2D_ARRAY,t,T,S.width,S.height,f.depth,0,p,y,S.data)}else{A&&w&&n.texStorage2D(e.TEXTURE_2D,R,T,E[0].width,E[0].height);for(let t=0,r=E.length;t<r;t++)S=E[t],a.format!==xe?null!==p&&(A?M&&n.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,S.width,S.height,p,S.data):n.compressedTexImage2D(e.TEXTURE_2D,t,T,S.width,S.height,0,S.data)):A?M&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,S.width,S.height,p,y,S.data):n.texImage2D(e.TEXTURE_2D,t,T,S.width,S.height,0,p,y,S.data)}else if(a.isDataArrayTexture)if(A){if(w&&n.texStorage3D(e.TEXTURE_2D_ARRAY,R,T,f.width,f.height,f.depth),M)if(a.layerUpdates.size>0){const t=Mc(f.width,f.height,a.format,a.type);for(const r of a.layerUpdates){const i=f.data.subarray(r*t/f.data.BYTES_PER_ELEMENT,(r+1)*t/f.data.BYTES_PER_ELEMENT);n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,r,f.width,f.height,1,p,y,i)}a.clearLayerUpdates()}else n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,f.width,f.height,f.depth,p,y,f.data)}else n.texImage3D(e.TEXTURE_2D_ARRAY,0,T,f.width,f.height,f.depth,0,p,y,f.data);else if(a.isData3DTexture)A?(w&&n.texStorage3D(e.TEXTURE_3D,R,T,f.width,f.height,f.depth),M&&n.texSubImage3D(e.TEXTURE_3D,0,0,0,0,f.width,f.height,f.depth,p,y,f.data)):n.texImage3D(e.TEXTURE_3D,0,T,f.width,f.height,f.depth,0,p,y,f.data);else if(a.isFramebufferTexture){if(w)if(A)n.texStorage2D(e.TEXTURE_2D,R,T,f.width,f.height);else{let t=f.width,r=f.height;for(let i=0;i<R;i++)n.texImage2D(e.TEXTURE_2D,i,T,t,r,0,p,y,null),t>>=1,r>>=1}}else if(E.length>0){if(A&&w){const t=z(E[0]);n.texStorage2D(e.TEXTURE_2D,R,T,t.width,t.height)}for(let t=0,r=E.length;t<r;t++)S=E[t],A?M&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,p,y,S):n.texImage2D(e.TEXTURE_2D,t,T,p,y,S);a.generateMipmaps=!1}else if(A){if(w){const t=z(f);n.texStorage2D(e.TEXTURE_2D,R,T,t.width,t.height)}M&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,p,y,f)}else n.texImage2D(e.TEXTURE_2D,0,T,p,y,f);g(a)&&v(l),d.__version=c.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}function N(t,i,a,l,u,c){const d=s.convert(a.format,a.colorSpace),h=s.convert(a.type),f=b(a.internalFormat,d,h,a.colorSpace),p=r.get(i),m=r.get(a);if(m.__renderTarget=i,!p.__hasExternalTextures){const t=Math.max(1,i.width>>c),r=Math.max(1,i.height>>c);u===e.TEXTURE_3D||u===e.TEXTURE_2D_ARRAY?n.texImage3D(u,c,f,t,r,i.depth,0,d,h,null):n.texImage2D(u,c,f,t,r,0,d,h,null)}n.bindFramebuffer(e.FRAMEBUFFER,t),B(i)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,u,m.__webglTexture,0,U(i)):(u===e.TEXTURE_2D||u>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&u<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,u,m.__webglTexture,c),n.bindFramebuffer(e.FRAMEBUFFER,null)}function D(t,n,r){if(e.bindRenderbuffer(e.RENDERBUFFER,t),n.depthBuffer){const i=n.depthTexture,s=i&&i.isDepthTexture?i.type:null,a=_(n.stencilBuffer,s),l=n.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,u=U(n);B(n)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,u,a,n.width,n.height):r?e.renderbufferStorageMultisample(e.RENDERBUFFER,u,a,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,a,n.width,n.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,t)}else{const t=n.textures;for(let i=0;i<t.length;i++){const a=t[i],l=s.convert(a.format,a.colorSpace),u=s.convert(a.type),c=b(a.internalFormat,l,u,a.colorSpace),d=U(n);r&&!1===B(n)?e.renderbufferStorageMultisample(e.RENDERBUFFER,d,c,n.width,n.height):B(n)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,d,c,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,c,n.width,n.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function k(t){const i=r.get(t),s=!0===t.isWebGLCubeRenderTarget;if(i.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(i.__depthDisposeCallback&&i.__depthDisposeCallback(),e){const t=()=>{delete i.__boundDepthTexture,delete i.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),i.__depthDisposeCallback=t}i.__boundDepthTexture=e}if(t.depthTexture&&!i.__autoAllocateDepthBuffer){if(s)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,i){if(i&&i.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(n.bindFramebuffer(e.FRAMEBUFFER,t),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const s=r.get(i.depthTexture);s.__renderTarget=i,s.__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),w(i.depthTexture,0);const a=s.__webglTexture,l=U(i);if(i.depthTexture.format===Ee)B(i)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,a,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,a,0);else{if(i.depthTexture.format!==Ae)throw new Error("Unknown depthTexture format");B(i)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,a,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,a,0)}}(i.__webglFramebuffer,t)}else if(s){i.__webglDepthbuffer=[];for(let r=0;r<6;r++)if(n.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer[r]),void 0===i.__webglDepthbuffer[r])i.__webglDepthbuffer[r]=e.createRenderbuffer(),D(i.__webglDepthbuffer[r],t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,s=i.__webglDepthbuffer[r];e.bindRenderbuffer(e.RENDERBUFFER,s),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,s)}}else if(n.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer),void 0===i.__webglDepthbuffer)i.__webglDepthbuffer=e.createRenderbuffer(),D(i.__webglDepthbuffer,t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,r=i.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,r),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,r)}n.bindFramebuffer(e.FRAMEBUFFER,null)}const O=[],F=[];function U(e){return Math.min(i.maxSamples,e.samples)}function B(e){const n=r.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==n.__useRenderToTexture}function V(e,t){const n=e.colorSpace;e.format,e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||n!==bt&&n!==vt&&un.getTransfer(n),t}function z(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(u.width=e.naturalWidth||e.width,u.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(u.width=e.displayWidth,u.height=e.displayHeight):(u.width=e.width,u.height=e.height),u}this.allocateTextureUnit=function(){const e=A;return i.maxTextures,A+=1,e},this.resetTextureUnits=function(){A=0},this.setTexture2D=w,this.setTexture2DArray=function(t,i){const s=r.get(t);t.version>0&&s.__version!==t.version?P(s,t,i):n.bindTexture(e.TEXTURE_2D_ARRAY,s.__webglTexture,e.TEXTURE0+i)},this.setTexture3D=function(t,i){const s=r.get(t);t.version>0&&s.__version!==t.version?P(s,t,i):n.bindTexture(e.TEXTURE_3D,s.__webglTexture,e.TEXTURE0+i)},this.setTextureCube=function(t,a){const o=r.get(t);t.version>0&&o.__version!==t.version?function(t,a,o){if(6!==a.image.length)return;const l=L(t,a),u=a.source;n.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+o);const c=r.get(u);if(u.version!==c.__version||!0===l){n.activeTexture(e.TEXTURE0+o);const t=un.getPrimaries(un.workingColorSpace),r=a.colorSpace===vt?null:un.getPrimaries(a.colorSpace),d=a.colorSpace===vt||t===r?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,a.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,d);const h=a.isCompressedTexture||a.image[0].isCompressedTexture,f=a.image[0]&&a.image[0].isDataTexture,p=[];for(let e=0;e<6;e++)p[e]=h||f?f?a.image[e].image:a.image[e]:m(a.image[e],!0,i.maxCubemapSize),p[e]=V(a,p[e]);const y=p[0],_=s.convert(a.format,a.colorSpace),S=s.convert(a.type),T=b(a.internalFormat,_,S,a.colorSpace),E=!0!==a.isVideoTexture,A=void 0===c.__version||!0===l,w=u.dataReady;let M,R=x(a,y);if(I(e.TEXTURE_CUBE_MAP,a),h){E&&A&&n.texStorage2D(e.TEXTURE_CUBE_MAP,R,T,y.width,y.height);for(let t=0;t<6;t++){M=p[t].mipmaps;for(let r=0;r<M.length;r++){const i=M[r];a.format!==xe?null!==_&&(E?w&&n.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,0,0,i.width,i.height,_,i.data):n.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,T,i.width,i.height,0,i.data)):E?w&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,0,0,i.width,i.height,_,S,i.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,T,i.width,i.height,0,_,S,i.data)}}}else{if(M=a.mipmaps,E&&A){M.length>0&&R++;const t=z(p[0]);n.texStorage2D(e.TEXTURE_CUBE_MAP,R,T,t.width,t.height)}for(let t=0;t<6;t++)if(f){E?w&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,p[t].width,p[t].height,_,S,p[t].data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,T,p[t].width,p[t].height,0,_,S,p[t].data);for(let r=0;r<M.length;r++){const i=M[r].image[t].image;E?w&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,r+1,0,0,i.width,i.height,_,S,i.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,r+1,T,i.width,i.height,0,_,S,i.data)}}else{E?w&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,_,S,p[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,T,_,S,p[t]);for(let r=0;r<M.length;r++){const i=M[r];E?w&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,r+1,0,0,_,S,i.image[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,r+1,T,_,S,i.image[t])}}}g(a)&&v(e.TEXTURE_CUBE_MAP),c.__version=u.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}(o,t,a):n.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture,e.TEXTURE0+a)},this.rebindTextures=function(t,n,i){const s=r.get(t);void 0!==n&&N(s.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==i&&k(t)},this.setupRenderTarget=function(t){const i=t.texture,o=r.get(t),l=r.get(i);t.addEventListener("dispose",T);const u=t.textures,c=!0===t.isWebGLCubeRenderTarget,d=u.length>1;if(d||(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=i.version,a.memory.textures++),c){o.__webglFramebuffer=[];for(let t=0;t<6;t++)if(i.mipmaps&&i.mipmaps.length>0){o.__webglFramebuffer[t]=[];for(let n=0;n<i.mipmaps.length;n++)o.__webglFramebuffer[t][n]=e.createFramebuffer()}else o.__webglFramebuffer[t]=e.createFramebuffer()}else{if(i.mipmaps&&i.mipmaps.length>0){o.__webglFramebuffer=[];for(let t=0;t<i.mipmaps.length;t++)o.__webglFramebuffer[t]=e.createFramebuffer()}else o.__webglFramebuffer=e.createFramebuffer();if(d)for(let t=0,n=u.length;t<n;t++){const n=r.get(u[t]);void 0===n.__webglTexture&&(n.__webglTexture=e.createTexture(),a.memory.textures++)}if(t.samples>0&&!1===B(t)){o.__webglMultisampledFramebuffer=e.createFramebuffer(),o.__webglColorRenderbuffer=[],n.bindFramebuffer(e.FRAMEBUFFER,o.__webglMultisampledFramebuffer);for(let n=0;n<u.length;n++){const r=u[n];o.__webglColorRenderbuffer[n]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,o.__webglColorRenderbuffer[n]);const i=s.convert(r.format,r.colorSpace),a=s.convert(r.type),l=b(r.internalFormat,i,a,r.colorSpace,!0===t.isXRRenderTarget),c=U(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,c,l,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n,e.RENDERBUFFER,o.__webglColorRenderbuffer[n])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(o.__webglDepthRenderbuffer=e.createRenderbuffer(),D(o.__webglDepthRenderbuffer,t,!0)),n.bindFramebuffer(e.FRAMEBUFFER,null)}}if(c){n.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),I(e.TEXTURE_CUBE_MAP,i);for(let n=0;n<6;n++)if(i.mipmaps&&i.mipmaps.length>0)for(let r=0;r<i.mipmaps.length;r++)N(o.__webglFramebuffer[n][r],t,i,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,r);else N(o.__webglFramebuffer[n],t,i,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0);g(i)&&v(e.TEXTURE_CUBE_MAP),n.unbindTexture()}else if(d){for(let i=0,s=u.length;i<s;i++){const s=u[i],a=r.get(s);n.bindTexture(e.TEXTURE_2D,a.__webglTexture),I(e.TEXTURE_2D,s),N(o.__webglFramebuffer,t,s,e.COLOR_ATTACHMENT0+i,e.TEXTURE_2D,0),g(s)&&v(e.TEXTURE_2D)}n.unbindTexture()}else{let r=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(r=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),n.bindTexture(r,l.__webglTexture),I(r,i),i.mipmaps&&i.mipmaps.length>0)for(let n=0;n<i.mipmaps.length;n++)N(o.__webglFramebuffer[n],t,i,e.COLOR_ATTACHMENT0,r,n);else N(o.__webglFramebuffer,t,i,e.COLOR_ATTACHMENT0,r,0);g(i)&&v(r),n.unbindTexture()}t.depthBuffer&&k(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let i=0,s=t.length;i<s;i++){const s=t[i];if(g(s)){const t=y(e),i=r.get(s).__webglTexture;n.bindTexture(t,i),v(t),n.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===B(t)){const i=t.textures,s=t.width,a=t.height;let o=e.COLOR_BUFFER_BIT;const u=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,c=r.get(t),d=i.length>1;if(d)for(let t=0;t<i.length;t++)n.bindFramebuffer(e.FRAMEBUFFER,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),n.bindFramebuffer(e.FRAMEBUFFER,c.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);n.bindFramebuffer(e.READ_FRAMEBUFFER,c.__webglMultisampledFramebuffer),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,c.__webglFramebuffer);for(let n=0;n<i.length;n++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(o|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(o|=e.STENCIL_BUFFER_BIT)),d){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,c.__webglColorRenderbuffer[n]);const t=r.get(i[n]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,s,a,0,0,s,a,o,e.NEAREST),!0===l&&(O.length=0,F.length=0,O.push(e.COLOR_ATTACHMENT0+n),t.depthBuffer&&!1===t.resolveDepthBuffer&&(O.push(u),F.push(u),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,F)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,O))}if(n.bindFramebuffer(e.READ_FRAMEBUFFER,null),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),d)for(let t=0;t<i.length;t++){n.bindFramebuffer(e.FRAMEBUFFER,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,c.__webglColorRenderbuffer[t]);const s=r.get(i[t]).__webglTexture;n.bindFramebuffer(e.FRAMEBUFFER,c.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,s,0)}n.bindFramebuffer(e.DRAW_FRAMEBUFFER,c.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&l){const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[n])}},this.setupDepthRenderbuffer=k,this.setupFrameBufferTexture=N,this.useMultisampledRTT=B}function rf(e,t){return{convert:function(n,r=""){let i;const s=un.getTransfer(r);if(n===oe)return e.UNSIGNED_BYTE;if(n===me)return e.UNSIGNED_SHORT_4_4_4_4;if(n===ge)return e.UNSIGNED_SHORT_5_5_5_1;if(n===ye)return e.UNSIGNED_INT_5_9_9_9_REV;if(n===le)return e.BYTE;if(n===ue)return e.SHORT;if(n===ce)return e.UNSIGNED_SHORT;if(n===de)return e.INT;if(n===he)return e.UNSIGNED_INT;if(n===fe)return e.FLOAT;if(n===pe)return e.HALF_FLOAT;if(n===be)return e.ALPHA;if(n===_e)return e.RGB;if(n===xe)return e.RGBA;if(n===Se)return e.LUMINANCE;if(n===Te)return e.LUMINANCE_ALPHA;if(n===Ee)return e.DEPTH_COMPONENT;if(n===Ae)return e.DEPTH_STENCIL;if(n===we)return e.RED;if(n===Me)return e.RED_INTEGER;if(n===Re)return e.RG;if(n===Ce)return e.RG_INTEGER;if(n===Ie)return e.RGBA_INTEGER;if(n===Le||n===Pe||n===Ne||n===De)if(s===xt){if(i=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===i)return null;if(n===Le)return i.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(n===Pe)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(n===Ne)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(n===De)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(i=t.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(n===Le)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===Pe)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===Ne)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===De)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(n===ke||n===Oe||n===Fe||n===Ue){if(i=t.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(n===ke)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(n===Oe)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(n===Fe)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(n===Ue)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(n===Be||n===Ve||n===ze){if(i=t.get("WEBGL_compressed_texture_etc"),null===i)return null;if(n===Be||n===Ve)return s===xt?i.COMPRESSED_SRGB8_ETC2:i.COMPRESSED_RGB8_ETC2;if(n===ze)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC}if(n===Ge||n===He||n===$e||n===We||n===je||n===qe||n===Xe||n===Ye||n===Ke||n===Qe||n===Ze||n===Je||n===et||n===tt){if(i=t.get("WEBGL_compressed_texture_astc"),null===i)return null;if(n===Ge)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:i.COMPRESSED_RGBA_ASTC_4x4_KHR;if(n===He)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:i.COMPRESSED_RGBA_ASTC_5x4_KHR;if(n===$e)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:i.COMPRESSED_RGBA_ASTC_5x5_KHR;if(n===We)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:i.COMPRESSED_RGBA_ASTC_6x5_KHR;if(n===je)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:i.COMPRESSED_RGBA_ASTC_6x6_KHR;if(n===qe)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:i.COMPRESSED_RGBA_ASTC_8x5_KHR;if(n===Xe)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:i.COMPRESSED_RGBA_ASTC_8x6_KHR;if(n===Ye)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:i.COMPRESSED_RGBA_ASTC_8x8_KHR;if(n===Ke)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:i.COMPRESSED_RGBA_ASTC_10x5_KHR;if(n===Qe)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:i.COMPRESSED_RGBA_ASTC_10x6_KHR;if(n===Ze)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:i.COMPRESSED_RGBA_ASTC_10x8_KHR;if(n===Je)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:i.COMPRESSED_RGBA_ASTC_10x10_KHR;if(n===et)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:i.COMPRESSED_RGBA_ASTC_12x10_KHR;if(n===tt)return s===xt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:i.COMPRESSED_RGBA_ASTC_12x12_KHR}if(n===nt||n===rt||n===it){if(i=t.get("EXT_texture_compression_bptc"),null===i)return null;if(n===nt)return s===xt?i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:i.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(n===rt)return i.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(n===it)return i.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(n===st||n===at||n===ot||n===lt){if(i=t.get("EXT_texture_compression_rgtc"),null===i)return null;if(n===nt)return i.COMPRESSED_RED_RGTC1_EXT;if(n===at)return i.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(n===ot)return i.COMPRESSED_RED_GREEN_RGTC2_EXT;if(n===lt)return i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return n===ve?e.UNSIGNED_INT_24_8:void 0!==e[n]?e[n]:null}}}const sf={type:"move"};class af{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new Na,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new Na,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new An,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new An),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new Na,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new An,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new An),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const n of e.hand.values())this._getHandJoint(t,n)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,n){let r=null,i=null,s=null;const a=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){s=!0;for(const r of e.hand.values()){const e=t.getJointPose(r,n),i=this._getHandJoint(l,r);null!==e&&(i.matrix.fromArray(e.transform.matrix),i.matrix.decompose(i.position,i.rotation,i.scale),i.matrixWorldNeedsUpdate=!0,i.jointRadius=e.radius),i.visible=null!==e}const r=l.joints["index-finger-tip"],i=l.joints["thumb-tip"],a=r.position.distanceTo(i.position),o=.02,u=.005;l.inputState.pinching&&a>o+u?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&a<=o-u&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(i=t.getPose(e.gripSpace,n),null!==i&&(o.matrix.fromArray(i.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,i.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(i.linearVelocity)):o.hasLinearVelocity=!1,i.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(i.angularVelocity)):o.hasAngularVelocity=!1));null!==a&&(r=t.getPose(e.targetRaySpace,n),null===r&&null!==i&&(r=i),null!==r&&(a.matrix.fromArray(r.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,r.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(r.linearVelocity)):a.hasLinearVelocity=!1,r.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(r.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(sf)))}return null!==a&&(a.visible=null!==r),null!==o&&(o.visible=null!==i),null!==l&&(l.visible=null!==s),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const n=new Na;n.matrixAutoUpdate=!1,n.visible=!1,e.joints[t.jointName]=n,e.add(n)}return e.joints[t.jointName]}}class of{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t,n){if(null===this.texture){const r=new yn;e.properties.get(r).__webglTexture=t.texture,t.depthNear===n.depthNear&&t.depthFar===n.depthFar||(this.depthNear=t.depthNear,this.depthFar=t.depthFar),this.texture=r}}getMesh(e){if(null!==this.texture&&null===this.mesh){const t=e.cameras[0].viewport,n=new Oi({vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new Ci(new Zo(20,20),n)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class lf extends Ft{constructor(e,t){super();const n=this;let r=null,i=1,s=null,a="local-floor",o=1,l=null,u=null,c=null,d=null,h=null,f=null;const p=new of,m=t.getContextAttributes();let g=null,v=null;const y=[],b=[],_=new Yt;let x=null;const S=new zi;S.viewport=new bn;const T=new zi;T.viewport=new bn;const E=[S,T],A=new Cu;let w=null,M=null;function R(e){const t=b.indexOf(e.inputSource);if(-1===t)return;const n=y[t];void 0!==n&&(n.update(e.inputSource,e.frame,l||s),n.dispatchEvent({type:e.type,data:e.inputSource}))}function C(){r.removeEventListener("select",R),r.removeEventListener("selectstart",R),r.removeEventListener("selectend",R),r.removeEventListener("squeeze",R),r.removeEventListener("squeezestart",R),r.removeEventListener("squeezeend",R),r.removeEventListener("end",C),r.removeEventListener("inputsourceschange",I);for(let e=0;e<y.length;e++){const t=b[e];null!==t&&(b[e]=null,y[e].disconnect(t))}w=null,M=null,p.reset(),e.setRenderTarget(g),h=null,d=null,c=null,r=null,v=null,k.stop(),n.isPresenting=!1,e.setPixelRatio(x),e.setSize(_.width,_.height,!1),n.dispatchEvent({type:"sessionend"})}function I(e){for(let t=0;t<e.removed.length;t++){const n=e.removed[t],r=b.indexOf(n);r>=0&&(b[r]=null,y[r].disconnect(n))}for(let t=0;t<e.added.length;t++){const n=e.added[t];let r=b.indexOf(n);if(-1===r){for(let e=0;e<y.length;e++){if(e>=b.length){b.push(n),r=e;break}if(null===b[e]){b[e]=n,r=e;break}}if(-1===r)break}const i=y[r];i&&i.connect(n)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=y[e];return void 0===t&&(t=new af,y[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=y[e];return void 0===t&&(t=new af,y[e]=t),t.getGripSpace()},this.getHand=function(e){let t=y[e];return void 0===t&&(t=new af,y[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){i=e,n.isPresenting},this.setReferenceSpaceType=function(e){a=e,n.isPresenting},this.getReferenceSpace=function(){return l||s},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==d?d:h},this.getBinding=function(){return c},this.getFrame=function(){return f},this.getSession=function(){return r},this.setSession=async function(u){if(r=u,null!==r){g=e.getRenderTarget(),r.addEventListener("select",R),r.addEventListener("selectstart",R),r.addEventListener("selectend",R),r.addEventListener("squeeze",R),r.addEventListener("squeezestart",R),r.addEventListener("squeezeend",R),r.addEventListener("end",C),r.addEventListener("inputsourceschange",I),!0!==m.xrCompatible&&await t.makeXRCompatible(),x=e.getPixelRatio(),e.getSize(_);if(void 0!==r.enabledFeatures&&r.enabledFeatures.includes("layers")){let n=null,s=null,a=null;m.depth&&(a=m.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,n=m.stencil?Ae:Ee,s=m.stencil?ve:he);const o={colorFormat:t.RGBA8,depthFormat:a,scaleFactor:i};c=new XRWebGLBinding(r,t),d=c.createProjectionLayer(o),r.updateRenderState({layers:[d]}),e.setPixelRatio(1),e.setSize(d.textureWidth,d.textureHeight,!1),v=new xn(d.textureWidth,d.textureHeight,{format:xe,type:oe,depthTexture:new Fa(d.textureWidth,d.textureHeight,s,void 0,void 0,void 0,void 0,void 0,void 0,n),stencilBuffer:m.stencil,colorSpace:e.outputColorSpace,samples:m.antialias?4:0,resolveDepthBuffer:!1===d.ignoreDepthValues})}else{const n={antialias:m.antialias,alpha:!0,depth:m.depth,stencil:m.stencil,framebufferScaleFactor:i};h=new XRWebGLLayer(r,t,n),r.updateRenderState({baseLayer:h}),e.setPixelRatio(1),e.setSize(h.framebufferWidth,h.framebufferHeight,!1),v=new xn(h.framebufferWidth,h.framebufferHeight,{format:xe,type:oe,colorSpace:e.outputColorSpace,stencilBuffer:m.stencil})}v.isXRRenderTarget=!0,this.setFoveation(o),l=null,s=await r.requestReferenceSpace(a),k.setContext(r),k.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==r)return r.environmentBlendMode},this.getDepthTexture=function(){return p.getDepthTexture()};const L=new An,P=new An;function N(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===r)return;let t=e.near,n=e.far;null!==p.texture&&(p.depthNear>0&&(t=p.depthNear),p.depthFar>0&&(n=p.depthFar)),A.near=T.near=S.near=t,A.far=T.far=S.far=n,w===A.near&&M===A.far||(r.updateRenderState({depthNear:A.near,depthFar:A.far}),w=A.near,M=A.far),S.layers.mask=2|e.layers.mask,T.layers.mask=4|e.layers.mask,A.layers.mask=S.layers.mask|T.layers.mask;const i=e.parent,s=A.cameras;N(A,i);for(let e=0;e<s.length;e++)N(s[e],i);2===s.length?function(e,t,n){L.setFromMatrixPosition(t.matrixWorld),P.setFromMatrixPosition(n.matrixWorld);const r=L.distanceTo(P),i=t.projectionMatrix.elements,s=n.projectionMatrix.elements,a=i[14]/(i[10]-1),o=i[14]/(i[10]+1),l=(i[9]+1)/i[5],u=(i[9]-1)/i[5],c=(i[8]-1)/i[0],d=(s[8]+1)/s[0],h=a*c,f=a*d,p=r/(-c+d),m=p*-c;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(p),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===i[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=a+p,n=o+p,i=h-m,s=f+(r-m),c=l*o/n*t,d=u*o/n*t;e.projectionMatrix.makePerspective(i,s,c,d,t,n),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(A,S,T):A.projectionMatrix.copy(S.projectionMatrix),function(e,t,n){null===n?e.matrix.copy(t.matrixWorld):(e.matrix.copy(n.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*zt*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,A,i)},this.getCamera=function(){return A},this.getFoveation=function(){if(null!==d||null!==h)return o},this.setFoveation=function(e){o=e,null!==d&&(d.fixedFoveation=e),null!==h&&void 0!==h.fixedFoveation&&(h.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==p.texture},this.getDepthSensingMesh=function(){return p.getMesh(A)};let D=null;const k=new Cc;k.setAnimationLoop(function(t,i){if(u=i.getViewerPose(l||s),f=i,null!==u){const t=u.views;null!==h&&(e.setRenderTargetFramebuffer(v,h.framebuffer),e.setRenderTarget(v));let n=!1;t.length!==A.cameras.length&&(A.cameras.length=0,n=!0);for(let r=0;r<t.length;r++){const i=t[r];let s=null;if(null!==h)s=h.getViewport(i);else{const t=c.getViewSubImage(d,i);s=t.viewport,0===r&&(e.setRenderTargetTextures(v,t.colorTexture,d.ignoreDepthValues?void 0:t.depthStencilTexture),e.setRenderTarget(v))}let a=E[r];void 0===a&&(a=new zi,a.layers.enable(r),a.viewport=new bn,E[r]=a),a.matrix.fromArray(i.transform.matrix),a.matrix.decompose(a.position,a.quaternion,a.scale),a.projectionMatrix.fromArray(i.projectionMatrix),a.projectionMatrixInverse.copy(a.projectionMatrix).invert(),a.viewport.set(s.x,s.y,s.width,s.height),0===r&&(A.matrix.copy(a.matrix),A.matrix.decompose(A.position,A.quaternion,A.scale)),!0===n&&A.cameras.push(a)}const i=r.enabledFeatures;if(i&&i.includes("depth-sensing")){const n=c.getDepthInformation(t[0]);n&&n.isValid&&n.texture&&p.init(e,n,r.renderState)}}for(let e=0;e<y.length;e++){const t=b[e],n=y[e];null!==t&&void 0!==n&&n.update(t,i,l||s)}D&&D(t,i),i.detectedPlanes&&n.dispatchEvent({type:"planesdetected",data:i}),f=null}),this.setAnimationLoop=function(e){D=e},this.dispose=function(){}}}const uf=new dr,cf=new tr;function df(e,t){function n(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function r(e,r){e.opacity.value=r.opacity,r.color&&e.diffuse.value.copy(r.color),r.emissive&&e.emissive.value.copy(r.emissive).multiplyScalar(r.emissiveIntensity),r.map&&(e.map.value=r.map,n(r.map,e.mapTransform)),r.alphaMap&&(e.alphaMap.value=r.alphaMap,n(r.alphaMap,e.alphaMapTransform)),r.bumpMap&&(e.bumpMap.value=r.bumpMap,n(r.bumpMap,e.bumpMapTransform),e.bumpScale.value=r.bumpScale,1===r.side&&(e.bumpScale.value*=-1)),r.normalMap&&(e.normalMap.value=r.normalMap,n(r.normalMap,e.normalMapTransform),e.normalScale.value.copy(r.normalScale),1===r.side&&e.normalScale.value.negate()),r.displacementMap&&(e.displacementMap.value=r.displacementMap,n(r.displacementMap,e.displacementMapTransform),e.displacementScale.value=r.displacementScale,e.displacementBias.value=r.displacementBias),r.emissiveMap&&(e.emissiveMap.value=r.emissiveMap,n(r.emissiveMap,e.emissiveMapTransform)),r.specularMap&&(e.specularMap.value=r.specularMap,n(r.specularMap,e.specularMapTransform)),r.alphaTest>0&&(e.alphaTest.value=r.alphaTest);const i=t.get(r),s=i.envMap,a=i.envMapRotation;s&&(e.envMap.value=s,uf.copy(a),uf.x*=-1,uf.y*=-1,uf.z*=-1,s.isCubeTexture&&!1===s.isRenderTargetTexture&&(uf.y*=-1,uf.z*=-1),e.envMapRotation.value.setFromMatrix4(cf.makeRotationFromEuler(uf)),e.flipEnvMap.value=s.isCubeTexture&&!1===s.isRenderTargetTexture?-1:1,e.reflectivity.value=r.reflectivity,e.ior.value=r.ior,e.refractionRatio.value=r.refractionRatio),r.lightMap&&(e.lightMap.value=r.lightMap,e.lightMapIntensity.value=r.lightMapIntensity,n(r.lightMap,e.lightMapTransform)),r.aoMap&&(e.aoMap.value=r.aoMap,e.aoMapIntensity.value=r.aoMapIntensity,n(r.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(t,n){n.color.getRGB(t.fogColor.value,Di(e)),n.isFog?(t.fogNear.value=n.near,t.fogFar.value=n.far):n.isFogExp2&&(t.fogDensity.value=n.density)},refreshMaterialUniforms:function(e,i,s,a,o){i.isMeshBasicMaterial||i.isMeshLambertMaterial?r(e,i):i.isMeshToonMaterial?(r(e,i),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,i)):i.isMeshPhongMaterial?(r(e,i),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,i)):i.isMeshStandardMaterial?(r(e,i),function(e,t){e.metalness.value=t.metalness,t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap,n(t.metalnessMap,e.metalnessMapTransform));e.roughness.value=t.roughness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap,n(t.roughnessMap,e.roughnessMapTransform));t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}(e,i),i.isMeshPhysicalMaterial&&function(e,t,r){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,n(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,n(t.sheenRoughnessMap,e.sheenRoughnessMapTransform)));t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,n(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,n(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,n(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),1===t.side&&e.clearcoatNormalScale.value.negate()));t.dispersion>0&&(e.dispersion.value=t.dispersion);t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,n(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,n(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform)));t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=r.texture,e.transmissionSamplerSize.value.set(r.width,r.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,n(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,n(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor));t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,n(t.anisotropyMap,e.anisotropyMapTransform)));e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,n(t.specularColorMap,e.specularColorMapTransform));t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,n(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,i,o)):i.isMeshMatcapMaterial?(r(e,i),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,i)):i.isMeshDepthMaterial?r(e,i):i.isMeshDistanceMaterial?(r(e,i),function(e,n){const r=t.get(n).light;e.referencePosition.value.setFromMatrixPosition(r.matrixWorld),e.nearDistance.value=r.shadow.camera.near,e.farDistance.value=r.shadow.camera.far}(e,i)):i.isMeshNormalMaterial?r(e,i):i.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform))}(e,i),i.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,i)):i.isPointsMaterial?function(e,t,r,i){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*r,e.scale.value=.5*i,t.map&&(e.map.value=t.map,n(t.map,e.uvTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,i,s,a):i.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,i):i.isShadowMaterial?(e.color.value.copy(i.color),e.opacity.value=i.opacity):i.isShaderMaterial&&(i.uniformsNeedUpdate=!1)}}}function hf(e,t,n,r){let i={},s={},a=[];const o=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function l(e,t,n,r){const i=e.value,s=t+"_"+n;if(void 0===r[s])return r[s]="number"==typeof i||"boolean"==typeof i?i:i.clone(),!0;{const e=r[s];if("number"==typeof i||"boolean"==typeof i){if(e!==i)return r[s]=i,!0}else if(!1===e.equals(i))return e.copy(i),!0}return!1}function u(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture,t}function c(t){const n=t.target;n.removeEventListener("dispose",c);const r=a.indexOf(n.__bindingPointIndex);a.splice(r,1),e.deleteBuffer(i[n.id]),delete i[n.id],delete s[n.id]}return{bind:function(e,t){const n=t.program;r.uniformBlockBinding(e,n)},update:function(n,d){let h=i[n.id];void 0===h&&(!function(e){const t=e.uniforms;let n=0;const r=16;for(let e=0,i=t.length;e<i;e++){const i=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0,t=i.length;e<t;e++){const t=i[e],s=Array.isArray(t.value)?t.value:[t.value];for(let e=0,i=s.length;e<i;e++){const i=u(s[e]),a=n%r,o=a%i.boundary,l=a+o;n+=o,0!==l&&r-l<i.storage&&(n+=r-l),t.__data=new Float32Array(i.storage/Float32Array.BYTES_PER_ELEMENT),t.__offset=n,n+=i.storage}}}const i=n%r;i>0&&(n+=r-i);e.__size=n,e.__cache={}}(n),h=function(t){const n=function(){for(let e=0;e<o;e++)if(-1===a.indexOf(e))return a.push(e),e;return 0}();t.__bindingPointIndex=n;const r=e.createBuffer(),i=t.__size,s=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,r),e.bufferData(e.UNIFORM_BUFFER,i,s),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,n,r),r}(n),i[n.id]=h,n.addEventListener("dispose",c));const f=d.program;r.updateUBOMapping(n,f);const p=t.render.frame;s[n.id]!==p&&(!function(t){const n=i[t.id],r=t.uniforms,s=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,n);for(let t=0,n=r.length;t<n;t++){const n=Array.isArray(r[t])?r[t]:[r[t]];for(let r=0,i=n.length;r<i;r++){const i=n[r];if(!0===l(i,t,r,s)){const t=i.__offset,n=Array.isArray(i.value)?i.value:[i.value];let r=0;for(let s=0;s<n.length;s++){const a=n[s],o=u(a);"number"==typeof a||"boolean"==typeof a?(i.__data[0]=a,e.bufferSubData(e.UNIFORM_BUFFER,t+r,i.__data)):a.isMatrix3?(i.__data[0]=a.elements[0],i.__data[1]=a.elements[1],i.__data[2]=a.elements[2],i.__data[3]=0,i.__data[4]=a.elements[3],i.__data[5]=a.elements[4],i.__data[6]=a.elements[5],i.__data[7]=0,i.__data[8]=a.elements[6],i.__data[9]=a.elements[7],i.__data[10]=a.elements[8],i.__data[11]=0):(a.toArray(i.__data,r),r+=o.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,i.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(n),s[n.id]=p)},dispose:function(){for(const t in i)e.deleteBuffer(i[t]);a=[],i={},s={}}}}class ff{constructor(e={}){const{canvas:t=nn(),context:n=null,depth:r=!0,stencil:i=!1,alpha:s=!1,antialias:a=!1,premultipliedAlpha:o=!0,preserveDrawingBuffer:l=!1,powerPreference:u="default",failIfMajorPerformanceCaveat:c=!1,reverseDepthBuffer:d=!1}=e;let f;if(this.isWebGLRenderer=!0,null!==n){if("undefined"!=typeof WebGLRenderingContext&&n instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");f=n.getContextAttributes().alpha}else f=s;const p=new Uint32Array(4),m=new Int32Array(4);let g=null,v=null;const y=[],b=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=yt,this.toneMapping=0,this.toneMappingExposure=1;const _=this;let x=!1,S=0,T=0,E=null,A=-1,w=null;const M=new bn,R=new bn;let C=null;const I=new qr(0);let L=0,P=t.width,N=t.height,D=1,k=null,O=null;const F=new bn(0,0,P,N),U=new bn(0,0,P,N);let B=!1;const V=new qs;let z=!1,G=!1;this.transmissionResolutionScale=1;const H=new tr,$=new tr,W=new An,j=new bn,q={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let X=!1;function Y(){return null===E?D:1}let K,Q,Z,J,ee,te,ne,re,ie,se,le,ue,de,fe,ye,be,_e,xe,Se,Te,Ee,Ae,we,Re,Le=n;function Pe(e,n){return t.getContext(e,n)}try{const e={alpha:!0,depth:r,stencil:i,antialias:a,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:u,failIfMajorPerformanceCaveat:c};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${h}`),t.addEventListener("webglcontextlost",ke,!1),t.addEventListener("webglcontextrestored",Oe,!1),t.addEventListener("webglcontextcreationerror",Fe,!1),null===Le){const t="webgl2";if(Le=Pe(t,e),null===Le)throw Pe(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(e){throw e}function Ne(){K=new od(Le),K.init(),Ae=new rf(Le,K),Q=new Vc(Le,K,e,Ae),Z=new tf(Le,K),Q.reverseDepthBuffer&&d&&Z.buffers.depth.setReversed(!0),J=new cd(Le),ee=new Gh,te=new nf(Le,K,Z,ee,Q,Ae,J),ne=new Gc(_),re=new ad(_),ie=new Ic(Le),we=new Uc(Le,ie),se=new ld(Le,ie,J,we),le=new hd(Le,se,ie,J),Se=new dd(Le,Q,te),be=new zc(ee),ue=new zh(_,ne,re,K,Q,we,be),de=new df(_,ee),fe=new jh,ye=new Zh(K),xe=new Fc(_,ne,re,Z,le,f,o),_e=new Jh(_,le,Q),Re=new hf(Le,J,Q,Z),Te=new Bc(Le,K,J),Ee=new ud(Le,K,J),J.programs=ue.programs,_.capabilities=Q,_.extensions=K,_.properties=ee,_.renderLists=fe,_.shadowMap=_e,_.state=Z,_.info=J}Ne();const De=new lf(_,Le);function ke(e){e.preventDefault(),x=!0}function Oe(){x=!1;const e=J.autoReset,t=_e.enabled,n=_e.autoUpdate,r=_e.needsUpdate,i=_e.type;Ne(),J.autoReset=e,_e.enabled=t,_e.autoUpdate=n,_e.needsUpdate=r,_e.type=i}function Fe(e){}function Ue(e){const t=e.target;t.removeEventListener("dispose",Ue),function(e){(function(e){const t=ee.get(e).programs;void 0!==t&&(t.forEach(function(e){ue.releaseProgram(e)}),e.isShaderMaterial&&ue.releaseShaderCache(e))})(e),ee.remove(e)}(t)}function Be(e,t,n){!0===e.transparent&&2===e.side&&!1===e.forceSinglePass?(e.side=1,e.needsUpdate=!0,Ye(e,t,n),e.side=0,e.needsUpdate=!0,Ye(e,t,n),e.side=2):Ye(e,t,n)}this.xr=De,this.getContext=function(){return Le},this.getContextAttributes=function(){return Le.getContextAttributes()},this.forceContextLoss=function(){const e=K.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=K.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return D},this.setPixelRatio=function(e){void 0!==e&&(D=e,this.setSize(P,N,!1))},this.getSize=function(e){return e.set(P,N)},this.setSize=function(e,n,r=!0){De.isPresenting||(P=e,N=n,t.width=Math.floor(e*D),t.height=Math.floor(n*D),!0===r&&(t.style.width=e+"px",t.style.height=n+"px"),this.setViewport(0,0,e,n))},this.getDrawingBufferSize=function(e){return e.set(P*D,N*D).floor()},this.setDrawingBufferSize=function(e,n,r){P=e,N=n,D=r,t.width=Math.floor(e*r),t.height=Math.floor(n*r),this.setViewport(0,0,e,n)},this.getCurrentViewport=function(e){return e.copy(M)},this.getViewport=function(e){return e.copy(F)},this.setViewport=function(e,t,n,r){e.isVector4?F.set(e.x,e.y,e.z,e.w):F.set(e,t,n,r),Z.viewport(M.copy(F).multiplyScalar(D).round())},this.getScissor=function(e){return e.copy(U)},this.setScissor=function(e,t,n,r){e.isVector4?U.set(e.x,e.y,e.z,e.w):U.set(e,t,n,r),Z.scissor(R.copy(U).multiplyScalar(D).round())},this.getScissorTest=function(){return B},this.setScissorTest=function(e){Z.setScissorTest(B=e)},this.setOpaqueSort=function(e){k=e},this.setTransparentSort=function(e){O=e},this.getClearColor=function(e){return e.copy(xe.getClearColor())},this.setClearColor=function(){xe.setClearColor.apply(xe,arguments)},this.getClearAlpha=function(){return xe.getClearAlpha()},this.setClearAlpha=function(){xe.setClearAlpha.apply(xe,arguments)},this.clear=function(e=!0,t=!0,n=!0){let r=0;if(e){let e=!1;if(null!==E){const t=E.texture.format;e=t===Ie||t===Ce||t===Me}if(e){const e=E.texture.type,t=e===oe||e===he||e===ce||e===ve||e===me||e===ge,n=xe.getClearColor(),r=xe.getClearAlpha(),i=n.r,s=n.g,a=n.b;t?(p[0]=i,p[1]=s,p[2]=a,p[3]=r,Le.clearBufferuiv(Le.COLOR,0,p)):(m[0]=i,m[1]=s,m[2]=a,m[3]=r,Le.clearBufferiv(Le.COLOR,0,m))}else r|=Le.COLOR_BUFFER_BIT}t&&(r|=Le.DEPTH_BUFFER_BIT),n&&(r|=Le.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),Le.clear(r)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",ke,!1),t.removeEventListener("webglcontextrestored",Oe,!1),t.removeEventListener("webglcontextcreationerror",Fe,!1),xe.dispose(),fe.dispose(),ye.dispose(),ee.dispose(),ne.dispose(),re.dispose(),le.dispose(),we.dispose(),Re.dispose(),ue.dispose(),De.dispose(),De.removeEventListener("sessionstart",ze),De.removeEventListener("sessionend",Ge),He.stop()},this.renderBufferDirect=function(e,t,n,r,i,s){null===t&&(t=q);const a=i.isMesh&&i.matrixWorld.determinant()<0,o=function(e,t,n,r,i){!0!==t.isScene&&(t=q);te.resetTextureUnits();const s=t.fog,a=r.isMeshStandardMaterial?t.environment:null,o=null===E?_.outputColorSpace:!0===E.isXRRenderTarget?E.texture.colorSpace:bt,l=(r.isMeshStandardMaterial?re:ne).get(r.envMap||a),u=!0===r.vertexColors&&!!n.attributes.color&&4===n.attributes.color.itemSize,c=!!n.attributes.tangent&&(!!r.normalMap||r.anisotropy>0),d=!!n.morphAttributes.position,h=!!n.morphAttributes.normal,f=!!n.morphAttributes.color;let p=0;r.toneMapped&&(null!==E&&!0!==E.isXRRenderTarget||(p=_.toneMapping));const m=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,g=void 0!==m?m.length:0,y=ee.get(r),b=v.state.lights;if(!0===z&&(!0===G||e!==w)){const t=e===w&&r.id===A;be.setState(r,e,t)}let x=!1;r.version===y.__version?y.needsLights&&y.lightsStateVersion!==b.state.version||y.outputColorSpace!==o||i.isBatchedMesh&&!1===y.batching?x=!0:i.isBatchedMesh||!0!==y.batching?i.isBatchedMesh&&!0===y.batchingColor&&null===i.colorTexture||i.isBatchedMesh&&!1===y.batchingColor&&null!==i.colorTexture||i.isInstancedMesh&&!1===y.instancing?x=!0:i.isInstancedMesh||!0!==y.instancing?i.isSkinnedMesh&&!1===y.skinning?x=!0:i.isSkinnedMesh||!0!==y.skinning?i.isInstancedMesh&&!0===y.instancingColor&&null===i.instanceColor||i.isInstancedMesh&&!1===y.instancingColor&&null!==i.instanceColor||i.isInstancedMesh&&!0===y.instancingMorph&&null===i.morphTexture||i.isInstancedMesh&&!1===y.instancingMorph&&null!==i.morphTexture||y.envMap!==l||!0===r.fog&&y.fog!==s?x=!0:void 0===y.numClippingPlanes||y.numClippingPlanes===be.numPlanes&&y.numIntersection===be.numIntersection?(y.vertexAlphas!==u||y.vertexTangents!==c||y.morphTargets!==d||y.morphNormals!==h||y.morphColors!==f||y.toneMapping!==p||y.morphTargetsCount!==g)&&(x=!0):x=!0:x=!0:x=!0:x=!0:(x=!0,y.__version=r.version);let S=y.currentProgram;!0===x&&(S=Ye(r,t,i));let T=!1,M=!1,R=!1;const C=S.getUniforms(),I=y.uniforms;Z.useProgram(S.program)&&(T=!0,M=!0,R=!0);r.id!==A&&(A=r.id,M=!0);if(T||w!==e){Z.buffers.depth.getReversed()?(H.copy(e.projectionMatrix),function(e){const t=e.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}(H),function(e){const t=e.elements;-1===t[11]?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=1-t[14])}(H),C.setValue(Le,"projectionMatrix",H)):C.setValue(Le,"projectionMatrix",e.projectionMatrix),C.setValue(Le,"viewMatrix",e.matrixWorldInverse);const t=C.map.cameraPosition;void 0!==t&&t.setValue(Le,W.setFromMatrixPosition(e.matrixWorld)),Q.logarithmicDepthBuffer&&C.setValue(Le,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial)&&C.setValue(Le,"isOrthographic",!0===e.isOrthographicCamera),w!==e&&(w=e,M=!0,R=!0)}if(i.isSkinnedMesh){C.setOptional(Le,i,"bindMatrix"),C.setOptional(Le,i,"bindMatrixInverse");const e=i.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),C.setValue(Le,"boneTexture",e.boneTexture,te))}i.isBatchedMesh&&(C.setOptional(Le,i,"batchingTexture"),C.setValue(Le,"batchingTexture",i._matricesTexture,te),C.setOptional(Le,i,"batchingIdTexture"),C.setValue(Le,"batchingIdTexture",i._indirectTexture,te),C.setOptional(Le,i,"batchingColorTexture"),null!==i._colorsTexture&&C.setValue(Le,"batchingColorTexture",i._colorsTexture,te));const L=n.morphAttributes;void 0===L.position&&void 0===L.normal&&void 0===L.color||Se.update(i,n,S);(M||y.receiveShadow!==i.receiveShadow)&&(y.receiveShadow=i.receiveShadow,C.setValue(Le,"receiveShadow",i.receiveShadow));r.isMeshGouraudMaterial&&null!==r.envMap&&(I.envMap.value=l,I.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);r.isMeshStandardMaterial&&null===r.envMap&&null!==t.environment&&(I.envMapIntensity.value=t.environmentIntensity);M&&(C.setValue(Le,"toneMappingExposure",_.toneMappingExposure),y.needsLights&&function(e,t){e.ambientLightColor.needsUpdate=t,e.lightProbe.needsUpdate=t,e.directionalLights.needsUpdate=t,e.directionalLightShadows.needsUpdate=t,e.pointLights.needsUpdate=t,e.pointLightShadows.needsUpdate=t,e.spotLights.needsUpdate=t,e.spotLightShadows.needsUpdate=t,e.rectAreaLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}(I,R),s&&!0===r.fog&&de.refreshFogUniforms(I,s),de.refreshMaterialUniforms(I,r,D,N,v.state.transmissionRenderTarget[e.id]),vh.upload(Le,Ke(y),I,te));r.isShaderMaterial&&!0===r.uniformsNeedUpdate&&(vh.upload(Le,Ke(y),I,te),r.uniformsNeedUpdate=!1);r.isSpriteMaterial&&C.setValue(Le,"center",i.center);if(C.setValue(Le,"modelViewMatrix",i.modelViewMatrix),C.setValue(Le,"normalMatrix",i.normalMatrix),C.setValue(Le,"modelMatrix",i.matrixWorld),r.isShaderMaterial||r.isRawShaderMaterial){const e=r.uniformsGroups;for(let t=0,n=e.length;t<n;t++){const n=e[t];Re.update(n,S),Re.bind(n,S)}}return S}(e,t,n,r,i);Z.setMaterial(r,a);let l=n.index,u=1;if(!0===r.wireframe){if(l=se.getWireframeAttribute(n),void 0===l)return;u=2}const c=n.drawRange,d=n.attributes.position;let h=c.start*u,f=(c.start+c.count)*u;null!==s&&(h=Math.max(h,s.start*u),f=Math.min(f,(s.start+s.count)*u)),null!==l?(h=Math.max(h,0),f=Math.min(f,l.count)):null!=d&&(h=Math.max(h,0),f=Math.min(f,d.count));const p=f-h;if(p<0||p===1/0)return;let m;we.setup(i,r,o,n,l);let g=Te;if(null!==l&&(m=ie.get(l),g=Ee,g.setIndex(m)),i.isMesh)!0===r.wireframe?(Z.setLineWidth(r.wireframeLinewidth*Y()),g.setMode(Le.LINES)):g.setMode(Le.TRIANGLES);else if(i.isLine){let e=r.linewidth;void 0===e&&(e=1),Z.setLineWidth(e*Y()),i.isLineSegments?g.setMode(Le.LINES):i.isLineLoop?g.setMode(Le.LINE_LOOP):g.setMode(Le.LINE_STRIP)}else i.isPoints?g.setMode(Le.POINTS):i.isSprite&&g.setMode(Le.TRIANGLES);if(i.isBatchedMesh)if(null!==i._multiDrawInstances)g.renderMultiDrawInstances(i._multiDrawStarts,i._multiDrawCounts,i._multiDrawCount,i._multiDrawInstances);else if(K.get("WEBGL_multi_draw"))g.renderMultiDraw(i._multiDrawStarts,i._multiDrawCounts,i._multiDrawCount);else{const e=i._multiDrawStarts,t=i._multiDrawCounts,n=i._multiDrawCount,s=l?ie.get(l).bytesPerElement:1,a=ee.get(r).currentProgram.getUniforms();for(let r=0;r<n;r++)a.setValue(Le,"_gl_DrawID",r),g.render(e[r]/s,t[r])}else if(i.isInstancedMesh)g.renderInstances(h,p,i.count);else if(n.isInstancedBufferGeometry){const e=void 0!==n._maxInstanceCount?n._maxInstanceCount:1/0,t=Math.min(n.instanceCount,e);g.renderInstances(h,p,t)}else g.render(h,p)},this.compile=function(e,t,n=null){null===n&&(n=e),v=ye.get(n),v.init(t),b.push(v),n.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(v.pushLight(e),e.castShadow&&v.pushShadow(e))}),e!==n&&e.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(v.pushLight(e),e.castShadow&&v.pushShadow(e))}),v.setupLights();const r=new Set;return e.traverse(function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let i=0;i<t.length;i++){const s=t[i];Be(s,n,e),r.add(s)}else Be(t,n,e),r.add(t)}),b.pop(),v=null,r},this.compileAsync=function(e,t,n=null){const r=this.compile(e,t,n);return new Promise(t=>{function n(){r.forEach(function(e){ee.get(e).currentProgram.isReady()&&r.delete(e)}),0!==r.size?setTimeout(n,10):t(e)}null!==K.get("KHR_parallel_shader_compile")?n():setTimeout(n,10)})};let Ve=null;function ze(){He.stop()}function Ge(){He.start()}const He=new Cc;function $e(e,t,n,r){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)n=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)v.pushLight(e),e.castShadow&&v.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||V.intersectsSprite(e)){r&&j.setFromMatrixPosition(e.matrixWorld).applyMatrix4($);const t=le.update(e),i=e.material;i.visible&&g.push(e,t,i,n,j.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||V.intersectsObject(e))){const t=le.update(e),i=e.material;if(r&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),j.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),j.copy(t.boundingSphere.center)),j.applyMatrix4(e.matrixWorld).applyMatrix4($)),Array.isArray(i)){const r=t.groups;for(let s=0,a=r.length;s<a;s++){const a=r[s],o=i[a.materialIndex];o&&o.visible&&g.push(e,t,o,n,j.z,a)}}else i.visible&&g.push(e,t,i,n,j.z,null)}const i=e.children;for(let e=0,s=i.length;e<s;e++)$e(i[e],t,n,r)}function We(e,t,n,r){const i=e.opaque,s=e.transmissive,a=e.transparent;v.setupLightsView(n),!0===z&&be.setGlobalState(_.clippingPlanes,n),r&&Z.viewport(M.copy(r)),i.length>0&&qe(i,t,n),s.length>0&&qe(s,t,n),a.length>0&&qe(a,t,n),Z.buffers.depth.setTest(!0),Z.buffers.depth.setMask(!0),Z.buffers.color.setMask(!0),Z.setPolygonOffset(!1)}function je(e,t,n,r){if(null!==(!0===n.isScene?n.overrideMaterial:null))return;void 0===v.state.transmissionRenderTarget[r.id]&&(v.state.transmissionRenderTarget[r.id]=new xn(1,1,{generateMipmaps:!0,type:K.has("EXT_color_buffer_half_float")||K.has("EXT_color_buffer_float")?pe:oe,minFilter:ae,samples:4,stencilBuffer:i,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:un.workingColorSpace}));const s=v.state.transmissionRenderTarget[r.id],a=r.viewport||M;s.setSize(a.z*_.transmissionResolutionScale,a.w*_.transmissionResolutionScale);const o=_.getRenderTarget();_.setRenderTarget(s),_.getClearColor(I),L=_.getClearAlpha(),L<1&&_.setClearColor(16777215,.5),_.clear(),X&&xe.render(n);const l=_.toneMapping;_.toneMapping=0;const u=r.viewport;if(void 0!==r.viewport&&(r.viewport=void 0),v.setupLightsView(r),!0===z&&be.setGlobalState(_.clippingPlanes,r),qe(e,n,r),te.updateMultisampleRenderTarget(s),te.updateRenderTargetMipmap(s),!1===K.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let i=0,s=t.length;i<s;i++){const s=t[i],a=s.object,o=s.geometry,l=s.material,u=s.group;if(2===l.side&&a.layers.test(r.layers)){const t=l.side;l.side=1,l.needsUpdate=!0,Xe(a,n,r,o,l,u),l.side=t,l.needsUpdate=!0,e=!0}}!0===e&&(te.updateMultisampleRenderTarget(s),te.updateRenderTargetMipmap(s))}_.setRenderTarget(o),_.setClearColor(I,L),void 0!==u&&(r.viewport=u),_.toneMapping=l}function qe(e,t,n){const r=!0===t.isScene?t.overrideMaterial:null;for(let i=0,s=e.length;i<s;i++){const s=e[i],a=s.object,o=s.geometry,l=null===r?s.material:r,u=s.group;a.layers.test(n.layers)&&Xe(a,t,n,o,l,u)}}function Xe(e,t,n,r,i,s){e.onBeforeRender(_,t,n,r,i,s),e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),i.onBeforeRender(_,t,n,r,e,s),!0===i.transparent&&2===i.side&&!1===i.forceSinglePass?(i.side=1,i.needsUpdate=!0,_.renderBufferDirect(n,t,r,i,e,s),i.side=0,i.needsUpdate=!0,_.renderBufferDirect(n,t,r,i,e,s),i.side=2):_.renderBufferDirect(n,t,r,i,e,s),e.onAfterRender(_,t,n,r,i,s)}function Ye(e,t,n){!0!==t.isScene&&(t=q);const r=ee.get(e),i=v.state.lights,s=v.state.shadowsArray,a=i.state.version,o=ue.getParameters(e,i.state,s,t,n),l=ue.getProgramCacheKey(o);let u=r.programs;r.environment=e.isMeshStandardMaterial?t.environment:null,r.fog=t.fog,r.envMap=(e.isMeshStandardMaterial?re:ne).get(e.envMap||r.environment),r.envMapRotation=null!==r.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===u&&(e.addEventListener("dispose",Ue),u=new Map,r.programs=u);let c=u.get(l);if(void 0!==c){if(r.currentProgram===c&&r.lightsStateVersion===a)return Qe(e,o),c}else o.uniforms=ue.getUniforms(e),e.onBeforeCompile(o,_),c=ue.acquireProgram(o,l),u.set(l,c),r.uniforms=o.uniforms;const d=r.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(d.clippingPlanes=be.uniform),Qe(e,o),r.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),r.lightsStateVersion=a,r.needsLights&&(d.ambientLightColor.value=i.state.ambient,d.lightProbe.value=i.state.probe,d.directionalLights.value=i.state.directional,d.directionalLightShadows.value=i.state.directionalShadow,d.spotLights.value=i.state.spot,d.spotLightShadows.value=i.state.spotShadow,d.rectAreaLights.value=i.state.rectArea,d.ltc_1.value=i.state.rectAreaLTC1,d.ltc_2.value=i.state.rectAreaLTC2,d.pointLights.value=i.state.point,d.pointLightShadows.value=i.state.pointShadow,d.hemisphereLights.value=i.state.hemi,d.directionalShadowMap.value=i.state.directionalShadowMap,d.directionalShadowMatrix.value=i.state.directionalShadowMatrix,d.spotShadowMap.value=i.state.spotShadowMap,d.spotLightMatrix.value=i.state.spotLightMatrix,d.spotLightMap.value=i.state.spotLightMap,d.pointShadowMap.value=i.state.pointShadowMap,d.pointShadowMatrix.value=i.state.pointShadowMatrix),r.currentProgram=c,r.uniformsList=null,c}function Ke(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=vh.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function Qe(e,t){const n=ee.get(e);n.outputColorSpace=t.outputColorSpace,n.batching=t.batching,n.batchingColor=t.batchingColor,n.instancing=t.instancing,n.instancingColor=t.instancingColor,n.instancingMorph=t.instancingMorph,n.skinning=t.skinning,n.morphTargets=t.morphTargets,n.morphNormals=t.morphNormals,n.morphColors=t.morphColors,n.morphTargetsCount=t.morphTargetsCount,n.numClippingPlanes=t.numClippingPlanes,n.numIntersection=t.numClipIntersection,n.vertexAlphas=t.vertexAlphas,n.vertexTangents=t.vertexTangents,n.toneMapping=t.toneMapping}He.setAnimationLoop(function(e){Ve&&Ve(e)}),"undefined"!=typeof self&&He.setContext(self),this.setAnimationLoop=function(e){Ve=e,De.setAnimationLoop(e),null===e?He.stop():He.start()},De.addEventListener("sessionstart",ze),De.addEventListener("sessionend",Ge),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return;if(!0===x)return;if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===De.enabled&&!0===De.isPresenting&&(!0===De.cameraAutoUpdate&&De.updateCamera(t),t=De.getCamera()),!0===e.isScene&&e.onBeforeRender(_,e,t,E),v=ye.get(e,b.length),v.init(t),b.push(v),$.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),V.setFromProjectionMatrix($),G=this.localClippingEnabled,z=be.init(this.clippingPlanes,G),g=fe.get(e,y.length),g.init(),y.push(g),!0===De.enabled&&!0===De.isPresenting){const e=_.xr.getDepthSensingMesh();null!==e&&$e(e,t,-1/0,_.sortObjects)}$e(e,t,0,_.sortObjects),g.finish(),!0===_.sortObjects&&g.sort(k,O),X=!1===De.enabled||!1===De.isPresenting||!1===De.hasDepthSensing(),X&&xe.addToRenderList(g,e),this.info.render.frame++,!0===z&&be.beginShadows();const n=v.state.shadowsArray;_e.render(n,e,t),!0===z&&be.endShadows(),!0===this.info.autoReset&&this.info.reset();const r=g.opaque,i=g.transmissive;if(v.setupLights(),t.isArrayCamera){const n=t.cameras;if(i.length>0)for(let t=0,s=n.length;t<s;t++){je(r,i,e,n[t])}X&&xe.render(e);for(let t=0,r=n.length;t<r;t++){const r=n[t];We(g,e,r,r.viewport)}}else i.length>0&&je(r,i,e,t),X&&xe.render(e),We(g,e,t);null!==E&&0===T&&(te.updateMultisampleRenderTarget(E),te.updateRenderTargetMipmap(E)),!0===e.isScene&&e.onAfterRender(_,e,t),we.resetDefaultState(),A=-1,w=null,b.pop(),b.length>0?(v=b[b.length-1],!0===z&&be.setGlobalState(_.clippingPlanes,v.state.camera)):v=null,y.pop(),g=y.length>0?y[y.length-1]:null},this.getActiveCubeFace=function(){return S},this.getActiveMipmapLevel=function(){return T},this.getRenderTarget=function(){return E},this.setRenderTargetTextures=function(e,t,n){ee.get(e.texture).__webglTexture=t,ee.get(e.depthTexture).__webglTexture=n;const r=ee.get(e);r.__hasExternalTextures=!0,r.__autoAllocateDepthBuffer=void 0===n,r.__autoAllocateDepthBuffer||!0===K.has("WEBGL_multisampled_render_to_texture")&&(r.__useRenderToTexture=!1)},this.setRenderTargetFramebuffer=function(e,t){const n=ee.get(e);n.__webglFramebuffer=t,n.__useDefaultFramebuffer=void 0===t};const Ze=Le.createFramebuffer();this.setRenderTarget=function(e,t=0,n=0){E=e,S=t,T=n;let r=!0,i=null,s=!1,a=!1;if(e){const o=ee.get(e);if(void 0!==o.__useDefaultFramebuffer)Z.bindFramebuffer(Le.FRAMEBUFFER,null),r=!1;else if(void 0===o.__webglFramebuffer)te.setupRenderTarget(e);else if(o.__hasExternalTextures)te.rebindTextures(e,ee.get(e.texture).__webglTexture,ee.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(o.__boundDepthTexture!==t){if(null!==t&&ee.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");te.setupDepthRenderbuffer(e)}}const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(a=!0);const u=ee.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(i=Array.isArray(u[t])?u[t][n]:u[t],s=!0):i=e.samples>0&&!1===te.useMultisampledRTT(e)?ee.get(e).__webglMultisampledFramebuffer:Array.isArray(u)?u[n]:u,M.copy(e.viewport),R.copy(e.scissor),C=e.scissorTest}else M.copy(F).multiplyScalar(D).floor(),R.copy(U).multiplyScalar(D).floor(),C=B;0!==n&&(i=Ze);if(Z.bindFramebuffer(Le.FRAMEBUFFER,i)&&r&&Z.drawBuffers(e,i),Z.viewport(M),Z.scissor(R),Z.setScissorTest(C),s){const r=ee.get(e.texture);Le.framebufferTexture2D(Le.FRAMEBUFFER,Le.COLOR_ATTACHMENT0,Le.TEXTURE_CUBE_MAP_POSITIVE_X+t,r.__webglTexture,n)}else if(a){const r=ee.get(e.texture),i=t;Le.framebufferTextureLayer(Le.FRAMEBUFFER,Le.COLOR_ATTACHMENT0,r.__webglTexture,n,i)}else if(null!==e&&0!==n){const t=ee.get(e.texture);Le.framebufferTexture2D(Le.FRAMEBUFFER,Le.COLOR_ATTACHMENT0,Le.TEXTURE_2D,t.__webglTexture,n)}A=-1},this.readRenderTargetPixels=function(e,t,n,r,i,s,a){if(!e||!e.isWebGLRenderTarget)return;let o=ee.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){Z.bindFramebuffer(Le.FRAMEBUFFER,o);try{const a=e.texture,o=a.format,l=a.type;if(!Q.textureFormatReadable(o))return;if(!Q.textureTypeReadable(l))return;t>=0&&t<=e.width-r&&n>=0&&n<=e.height-i&&Le.readPixels(t,n,r,i,Ae.convert(o),Ae.convert(l),s)}finally{const e=null!==E?ee.get(E).__webglFramebuffer:null;Z.bindFramebuffer(Le.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,n,r,i,s,a){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=ee.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){const a=e.texture,l=a.format,u=a.type;if(!Q.textureFormatReadable(l))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!Q.textureTypeReadable(u))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");if(t>=0&&t<=e.width-r&&n>=0&&n<=e.height-i){Z.bindFramebuffer(Le.FRAMEBUFFER,o);const e=Le.createBuffer();Le.bindBuffer(Le.PIXEL_PACK_BUFFER,e),Le.bufferData(Le.PIXEL_PACK_BUFFER,s.byteLength,Le.STREAM_READ),Le.readPixels(t,n,r,i,Ae.convert(l),Ae.convert(u),0);const a=null!==E?ee.get(E).__webglFramebuffer:null;Z.bindFramebuffer(Le.FRAMEBUFFER,a);const c=Le.fenceSync(Le.SYNC_GPU_COMMANDS_COMPLETE,0);return Le.flush(),await function(e,t,n){return new Promise(function(r,i){setTimeout(function s(){switch(e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:i();break;case e.TIMEOUT_EXPIRED:setTimeout(s,n);break;default:r()}},n)})}(Le,c,4),Le.bindBuffer(Le.PIXEL_PACK_BUFFER,e),Le.getBufferSubData(Le.PIXEL_PACK_BUFFER,0,s),Le.deleteBuffer(e),Le.deleteSync(c),s}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,n=0){!0!==e.isTexture&&(sn("WebGLRenderer: copyFramebufferToTexture function signature has changed."),t=arguments[0]||null,e=arguments[1]);const r=Math.pow(2,-n),i=Math.floor(e.image.width*r),s=Math.floor(e.image.height*r),a=null!==t?t.x:0,o=null!==t?t.y:0;te.setTexture2D(e,0),Le.copyTexSubImage2D(Le.TEXTURE_2D,n,0,0,a,o,i,s),Z.unbindTexture()};const Je=Le.createFramebuffer(),et=Le.createFramebuffer();this.copyTextureToTexture=function(e,t,n=null,r=null,i=0,s=null){let a,o,l,u,c,d,h,f,p;!0!==e.isTexture&&(sn("WebGLRenderer: copyTextureToTexture function signature has changed."),r=arguments[0]||null,e=arguments[1],t=arguments[2],s=arguments[3]||0,n=null),null===s&&(0!==i?(sn("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),s=i,i=0):s=0);const m=e.isCompressedTexture?e.mipmaps[s]:e.image;if(null!==n)a=n.max.x-n.min.x,o=n.max.y-n.min.y,l=n.isBox3?n.max.z-n.min.z:1,u=n.min.x,c=n.min.y,d=n.isBox3?n.min.z:0;else{const t=Math.pow(2,-i);a=Math.floor(m.width*t),o=Math.floor(m.height*t),l=e.isDataArrayTexture?m.depth:e.isData3DTexture?Math.floor(m.depth*t):1,u=0,c=0,d=0}null!==r?(h=r.x,f=r.y,p=r.z):(h=0,f=0,p=0);const g=Ae.convert(t.format),v=Ae.convert(t.type);let y;t.isData3DTexture?(te.setTexture3D(t,0),y=Le.TEXTURE_3D):t.isDataArrayTexture||t.isCompressedArrayTexture?(te.setTexture2DArray(t,0),y=Le.TEXTURE_2D_ARRAY):(te.setTexture2D(t,0),y=Le.TEXTURE_2D),Le.pixelStorei(Le.UNPACK_FLIP_Y_WEBGL,t.flipY),Le.pixelStorei(Le.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),Le.pixelStorei(Le.UNPACK_ALIGNMENT,t.unpackAlignment);const b=Le.getParameter(Le.UNPACK_ROW_LENGTH),_=Le.getParameter(Le.UNPACK_IMAGE_HEIGHT),x=Le.getParameter(Le.UNPACK_SKIP_PIXELS),S=Le.getParameter(Le.UNPACK_SKIP_ROWS),T=Le.getParameter(Le.UNPACK_SKIP_IMAGES);Le.pixelStorei(Le.UNPACK_ROW_LENGTH,m.width),Le.pixelStorei(Le.UNPACK_IMAGE_HEIGHT,m.height),Le.pixelStorei(Le.UNPACK_SKIP_PIXELS,u),Le.pixelStorei(Le.UNPACK_SKIP_ROWS,c),Le.pixelStorei(Le.UNPACK_SKIP_IMAGES,d);const E=e.isDataArrayTexture||e.isData3DTexture,A=t.isDataArrayTexture||t.isData3DTexture;if(e.isDepthTexture){const n=ee.get(e),r=ee.get(t),m=ee.get(n.__renderTarget),g=ee.get(r.__renderTarget);Z.bindFramebuffer(Le.READ_FRAMEBUFFER,m.__webglFramebuffer),Z.bindFramebuffer(Le.DRAW_FRAMEBUFFER,g.__webglFramebuffer);for(let n=0;n<l;n++)E&&(Le.framebufferTextureLayer(Le.READ_FRAMEBUFFER,Le.COLOR_ATTACHMENT0,ee.get(e).__webglTexture,i,d+n),Le.framebufferTextureLayer(Le.DRAW_FRAMEBUFFER,Le.COLOR_ATTACHMENT0,ee.get(t).__webglTexture,s,p+n)),Le.blitFramebuffer(u,c,a,o,h,f,a,o,Le.DEPTH_BUFFER_BIT,Le.NEAREST);Z.bindFramebuffer(Le.READ_FRAMEBUFFER,null),Z.bindFramebuffer(Le.DRAW_FRAMEBUFFER,null)}else if(0!==i||e.isRenderTargetTexture||ee.has(e)){const n=ee.get(e),r=ee.get(t);Z.bindFramebuffer(Le.READ_FRAMEBUFFER,Je),Z.bindFramebuffer(Le.DRAW_FRAMEBUFFER,et);for(let e=0;e<l;e++)E?Le.framebufferTextureLayer(Le.READ_FRAMEBUFFER,Le.COLOR_ATTACHMENT0,n.__webglTexture,i,d+e):Le.framebufferTexture2D(Le.READ_FRAMEBUFFER,Le.COLOR_ATTACHMENT0,Le.TEXTURE_2D,n.__webglTexture,i),A?Le.framebufferTextureLayer(Le.DRAW_FRAMEBUFFER,Le.COLOR_ATTACHMENT0,r.__webglTexture,s,p+e):Le.framebufferTexture2D(Le.DRAW_FRAMEBUFFER,Le.COLOR_ATTACHMENT0,Le.TEXTURE_2D,r.__webglTexture,s),0!==i?Le.blitFramebuffer(u,c,a,o,h,f,a,o,Le.COLOR_BUFFER_BIT,Le.NEAREST):A?Le.copyTexSubImage3D(y,s,h,f,p+e,u,c,a,o):Le.copyTexSubImage2D(y,s,h,f,u,c,a,o);Z.bindFramebuffer(Le.READ_FRAMEBUFFER,null),Z.bindFramebuffer(Le.DRAW_FRAMEBUFFER,null)}else A?e.isDataTexture||e.isData3DTexture?Le.texSubImage3D(y,s,h,f,p,a,o,l,g,v,m.data):t.isCompressedArrayTexture?Le.compressedTexSubImage3D(y,s,h,f,p,a,o,l,g,m.data):Le.texSubImage3D(y,s,h,f,p,a,o,l,g,v,m):e.isDataTexture?Le.texSubImage2D(Le.TEXTURE_2D,s,h,f,a,o,g,v,m.data):e.isCompressedTexture?Le.compressedTexSubImage2D(Le.TEXTURE_2D,s,h,f,m.width,m.height,g,m.data):Le.texSubImage2D(Le.TEXTURE_2D,s,h,f,a,o,g,v,m);Le.pixelStorei(Le.UNPACK_ROW_LENGTH,b),Le.pixelStorei(Le.UNPACK_IMAGE_HEIGHT,_),Le.pixelStorei(Le.UNPACK_SKIP_PIXELS,x),Le.pixelStorei(Le.UNPACK_SKIP_ROWS,S),Le.pixelStorei(Le.UNPACK_SKIP_IMAGES,T),0===s&&t.generateMipmaps&&Le.generateMipmap(y),Z.unbindTexture()},this.copyTextureToTexture3D=function(e,t,n=null,r=null,i=0){return!0!==e.isTexture&&(sn("WebGLRenderer: copyTextureToTexture3D function signature has changed."),n=arguments[0]||null,r=arguments[1]||null,e=arguments[2],t=arguments[3],i=arguments[4]||0),sn('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(e,t,n,r,i)},this.initRenderTarget=function(e){void 0===ee.get(e).__webglFramebuffer&&te.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?te.setTextureCube(e,0):e.isData3DTexture?te.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?te.setTexture2DArray(e,0):te.setTexture2D(e,0),Z.unbindTexture()},this.resetState=function(){S=0,T=0,E=null,Z.reset(),we.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return kt}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorspace=un._getDrawingBufferColorSpace(e),t.unpackColorSpace=un._getUnpackColorSpace()}}var pf,mf=Object.freeze({__proto__:null,ACESFilmicToneMapping:4,AddEquation:y,AddOperation:2,AdditiveBlending:2,AgXToneMapping:6,AlphaFormat:be,AlwaysCompare:Lt,AlwaysDepth:1,ArrayCamera:Cu,BackSide:1,BoxGeometry:Li,BufferAttribute:si,BufferGeometry:vi,ByteType:le,CineonToneMapping:3,ClampToEdgeWrapping:J,Color:qr,ColorManagement:un,ConstantAlphaFactor:213,ConstantColorFactor:211,CubeReflectionMapping:q,CubeRefractionMapping:X,CubeTexture:$i,CubeUVReflectionMapping:Q,CullFaceBack:1,CullFaceFront:2,CullFaceNone:0,CustomBlending:5,CustomToneMapping:5,Data3DTexture:Tn,DataArrayTexture:Sn,DepthFormat:Ee,DepthStencilFormat:Ae,DepthTexture:Fa,DoubleSide:2,DstAlphaFactor:M,DstColorFactor:C,EqualCompare:wt,EqualDepth:4,EquirectangularReflectionMapping:Y,EquirectangularRefractionMapping:K,Euler:dr,EventDispatcher:Ft,FloatType:fe,FrontSide:0,Frustum:qs,GLSL3:Dt,GreaterCompare:Rt,GreaterDepth:6,GreaterEqualCompare:It,GreaterEqualDepth:5,Group:Na,HalfFloatType:pe,IntType:de,Layers:hr,LessCompare:At,LessDepth:2,LessEqualCompare:Mt,LessEqualDepth:3,LinearFilter:ie,LinearMipmapLinearFilter:ae,LinearMipmapNearestFilter:se,LinearSRGBColorSpace:bt,LinearToneMapping:1,LinearTransfer:_t,LuminanceAlphaFormat:Te,LuminanceFormat:Se,Matrix3:Kt,Matrix4:tr,MaxEquation:104,Mesh:Ci,MeshBasicMaterial:Qr,MeshDepthMaterial:vl,MeshDistanceMaterial:yl,MinEquation:103,MirroredRepeatWrapping:ee,MixOperation:1,MultiplyBlending:4,MultiplyOperation:0,NearestFilter:te,NearestMipmapLinearFilter:re,NearestMipmapNearestFilter:ne,NeutralToneMapping:7,NeverCompare:Et,NeverDepth:0,NoBlending:0,NoColorSpace:vt,NoToneMapping:0,NormalBlending:1,NotEqualCompare:Ct,NotEqualDepth:7,ObjectSpaceNormalMap:1,OneFactor:S,OneMinusConstantAlphaFactor:214,OneMinusConstantColorFactor:212,OneMinusDstAlphaFactor:R,OneMinusDstColorFactor:I,OneMinusSrcAlphaFactor:w,OneMinusSrcColorFactor:E,OrthographicCamera:uu,PCFShadowMap:1,PCFSoftShadowMap:2,PMREMGenerator:ed,PerspectiveCamera:zi,Plane:$s,PlaneGeometry:Zo,RED_GREEN_RGTC2_Format:ot,RED_RGTC1_Format:st,REVISION:h,RGBADepthPacking:3201,RGBAFormat:xe,RGBAIntegerFormat:Ie,RGBA_ASTC_10x10_Format:Je,RGBA_ASTC_10x5_Format:Ke,RGBA_ASTC_10x6_Format:Qe,RGBA_ASTC_10x8_Format:Ze,RGBA_ASTC_12x10_Format:et,RGBA_ASTC_12x12_Format:tt,RGBA_ASTC_4x4_Format:Ge,RGBA_ASTC_5x4_Format:He,RGBA_ASTC_5x5_Format:$e,RGBA_ASTC_6x5_Format:We,RGBA_ASTC_6x6_Format:je,RGBA_ASTC_8x5_Format:qe,RGBA_ASTC_8x6_Format:Xe,RGBA_ASTC_8x8_Format:Ye,RGBA_BPTC_Format:nt,RGBA_ETC2_EAC_Format:ze,RGBA_PVRTC_2BPPV1_Format:Ue,RGBA_PVRTC_4BPPV1_Format:Fe,RGBA_S3TC_DXT1_Format:Pe,RGBA_S3TC_DXT3_Format:Ne,RGBA_S3TC_DXT5_Format:De,RGBFormat:_e,RGB_BPTC_SIGNED_Format:rt,RGB_BPTC_UNSIGNED_Format:it,RGB_ETC1_Format:Be,RGB_ETC2_Format:Ve,RGB_PVRTC_2BPPV1_Format:Oe,RGB_PVRTC_4BPPV1_Format:ke,RGB_S3TC_DXT1_Format:Le,RGFormat:Re,RGIntegerFormat:Ce,RedFormat:we,RedIntegerFormat:Me,ReinhardToneMapping:2,RepeatWrapping:Z,ReverseSubtractEquation:_,SIGNED_RED_GREEN_RGTC2_Format:lt,SIGNED_RED_RGTC1_Format:at,SRGBColorSpace:yt,SRGBTransfer:xt,ShaderChunk:Lc,ShaderLib:Nc,ShaderMaterial:Oi,ShortType:ue,SrcAlphaFactor:A,SrcAlphaSaturateFactor:L,SrcColorFactor:T,SubtractEquation:b,SubtractiveBlending:3,TangentSpaceNormalMap:0,Texture:yn,Uint16BufferAttribute:ai,Uint32BufferAttribute:oi,UniformsLib:Pc,UniformsUtils:ki,UnsignedByteType:oe,UnsignedInt248Type:ve,UnsignedInt5999Type:ye,UnsignedIntType:he,UnsignedShort4444Type:me,UnsignedShort5551Type:ge,UnsignedShortType:ce,VSMShadowMap:3,Vector2:Yt,Vector3:An,Vector4:bn,WebGLCoordinateSystem:kt,WebGLCubeRenderTarget:Wi,WebGLRenderTarget:xn,WebGLRenderer:ff,WebGLUtils:rf,ZeroFactor:x,createCanvasElement:nn,AdditiveAnimationBlendMode:gt,AlwaysStencilFunc:Tt,AmbientLight:hu,AnimationAction:Yu,AnimationClip:Bl,AnimationLoader:class extends $l{constructor(e){super(e)}load(e,t,n,r){const i=this,s=new ql(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,function(n){try{t(i.parse(JSON.parse(n)))}catch(t){r&&r(t),i.manager.itemError(e)}},n,r)}parse(e){const t=[];for(let n=0;n<e.length;n++){const r=Bl.parse(e[n]);t.push(r)}return t}},AnimationMixer:class extends Ft{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,t){const n=e._localRoot||this._root,r=e._clip.tracks,i=r.length,s=e._propertyBindings,a=e._interpolants,o=n.uuid,l=this._bindingsByRootAndName;let u=l[o];void 0===u&&(u={},l[o]=u);for(let e=0;e!==i;++e){const i=r[e],l=i.name;let c=u[l];if(void 0!==c)++c.referenceCount,s[e]=c;else{if(c=s[e],void 0!==c){null===c._cacheIndex&&(++c.referenceCount,this._addInactiveBinding(c,o,l));continue}const r=t&&t._propertyBindings[e].binding.parsedPath;c=new zu(Xu.create(n,l,r),i.ValueTypeName,i.getValueSize()),++c.referenceCount,this._addInactiveBinding(c,o,l),s[e]=c}a[e].resultBuffer=c.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){const t=(e._localRoot||this._root).uuid,n=e._clip.uuid,r=this._actionsByClip[n];this._bindAction(e,r&&r.knownActions[0]),this._addInactiveAction(e,n,t)}const t=e._propertyBindings;for(let e=0,n=t.length;e!==n;++e){const n=t[e];0===n.useCount++&&(this._lendBinding(n),n.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const t=e._propertyBindings;for(let e=0,n=t.length;e!==n;++e){const n=t[e];0===--n.useCount&&(n.restoreOriginalState(),this._takeBackBinding(n))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const t=e._cacheIndex;return null!==t&&t<this._nActiveActions}_addInactiveAction(e,t,n){const r=this._actions,i=this._actionsByClip;let s=i[t];if(void 0===s)s={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,i[t]=s;else{const t=s.knownActions;e._byClipCacheIndex=t.length,t.push(e)}e._cacheIndex=r.length,r.push(e),s.actionByRoot[n]=e}_removeInactiveAction(e){const t=this._actions,n=t[t.length-1],r=e._cacheIndex;n._cacheIndex=r,t[r]=n,t.pop(),e._cacheIndex=null;const i=e._clip.uuid,s=this._actionsByClip,a=s[i],o=a.knownActions,l=o[o.length-1],u=e._byClipCacheIndex;l._byClipCacheIndex=u,o[u]=l,o.pop(),e._byClipCacheIndex=null;delete a.actionByRoot[(e._localRoot||this._root).uuid],0===o.length&&delete s[i],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const t=e._propertyBindings;for(let e=0,n=t.length;e!==n;++e){const n=t[e];0===--n.referenceCount&&this._removeInactiveBinding(n)}}_lendAction(e){const t=this._actions,n=e._cacheIndex,r=this._nActiveActions++,i=t[r];e._cacheIndex=r,t[r]=e,i._cacheIndex=n,t[n]=i}_takeBackAction(e){const t=this._actions,n=e._cacheIndex,r=--this._nActiveActions,i=t[r];e._cacheIndex=r,t[r]=e,i._cacheIndex=n,t[n]=i}_addInactiveBinding(e,t,n){const r=this._bindingsByRootAndName,i=this._bindings;let s=r[t];void 0===s&&(s={},r[t]=s),s[n]=e,e._cacheIndex=i.length,i.push(e)}_removeInactiveBinding(e){const t=this._bindings,n=e.binding,r=n.rootNode.uuid,i=n.path,s=this._bindingsByRootAndName,a=s[r],o=t[t.length-1],l=e._cacheIndex;o._cacheIndex=l,t[l]=o,t.pop(),delete a[i],0===Object.keys(a).length&&delete s[r]}_lendBinding(e){const t=this._bindings,n=e._cacheIndex,r=this._nActiveBindings++,i=t[r];e._cacheIndex=r,t[r]=e,i._cacheIndex=n,t[n]=i}_takeBackBinding(e){const t=this._bindings,n=e._cacheIndex,r=--this._nActiveBindings,i=t[r];e._cacheIndex=r,t[r]=e,i._cacheIndex=n,t[n]=i}_lendControlInterpolant(){const e=this._controlInterpolants,t=this._nActiveControlInterpolants++;let n=e[t];return void 0===n&&(n=new Cl(new Float32Array(2),new Float32Array(2),1,Ku),n.__cacheIndex=t,e[t]=n),n}_takeBackControlInterpolant(e){const t=this._controlInterpolants,n=e.__cacheIndex,r=--this._nActiveControlInterpolants,i=t[r];e.__cacheIndex=r,t[r]=e,i.__cacheIndex=n,t[n]=i}clipAction(e,t,n){const r=t||this._root,i=r.uuid;let s="string"==typeof e?Bl.findByName(r,e):e;const a=null!==s?s.uuid:e,o=this._actionsByClip[a];let l=null;if(void 0===n&&(n=null!==s?s.blendMode:mt),void 0!==o){const e=o.actionByRoot[i];if(void 0!==e&&e.blendMode===n)return e;l=o.knownActions[0],null===s&&(s=l._clip)}if(null===s)return null;const u=new Yu(this,s,t,n);return this._bindAction(u,l),this._addInactiveAction(u,a,i),u}existingAction(e,t){const n=t||this._root,r=n.uuid,i="string"==typeof e?Bl.findByName(n,e):e,s=i?i.uuid:e,a=this._actionsByClip[s];return void 0!==a&&a.actionByRoot[r]||null}stopAllAction(){const e=this._actions;for(let t=this._nActiveActions-1;t>=0;--t)e[t].stop();return this}update(e){e*=this.timeScale;const t=this._actions,n=this._nActiveActions,r=this.time+=e,i=Math.sign(e),s=this._accuIndex^=1;for(let a=0;a!==n;++a){t[a]._update(r,e,i,s)}const a=this._bindings,o=this._nActiveBindings;for(let e=0;e!==o;++e)a[e].apply(s);return this}setTime(e){this.time=0;for(let e=0;e<this._actions.length;e++)this._actions[e].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const t=this._actions,n=e.uuid,r=this._actionsByClip,i=r[n];if(void 0!==i){const e=i.knownActions;for(let n=0,r=e.length;n!==r;++n){const r=e[n];this._deactivateAction(r);const i=r._cacheIndex,s=t[t.length-1];r._cacheIndex=null,r._byClipCacheIndex=null,s._cacheIndex=i,t[i]=s,t.pop(),this._removeInactiveBindingsForAction(r)}delete r[n]}}uncacheRoot(e){const t=e.uuid,n=this._actionsByClip;for(const e in n){const r=n[e].actionByRoot[t];void 0!==r&&(this._deactivateAction(r),this._removeInactiveAction(r))}const r=this._bindingsByRootAndName[t];if(void 0!==r)for(const e in r){const t=r[e];t.restoreOriginalState(),this._removeInactiveBinding(t)}}uncacheAction(e,t){const n=this.existingAction(e,t);null!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}},AnimationObjectGroup:class{constructor(){this.isAnimationObjectGroup=!0,this.uuid=Gt(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const e={};this._indicesByUUID=e;for(let t=0,n=arguments.length;t!==n;++t)e[arguments[t].uuid]=t;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const t=this;this.stats={objects:{get total(){return t._objects.length},get inUse(){return this.total-t.nCachedObjects_}},get bindingsPerObject(){return t._bindings.length}}}add(){const e=this._objects,t=this._indicesByUUID,n=this._paths,r=this._parsedPaths,i=this._bindings,s=i.length;let a,o=e.length,l=this.nCachedObjects_;for(let u=0,c=arguments.length;u!==c;++u){const c=arguments[u],d=c.uuid;let h=t[d];if(void 0===h){h=o++,t[d]=h,e.push(c);for(let e=0,t=s;e!==t;++e)i[e].push(new Xu(c,n[e],r[e]))}else if(h<l){a=e[h];const o=--l,u=e[o];t[u.uuid]=h,e[h]=u,t[d]=o,e[o]=c;for(let e=0,t=s;e!==t;++e){const t=i[e],s=t[o];let a=t[h];t[h]=s,void 0===a&&(a=new Xu(c,n[e],r[e])),t[o]=a}}else e[h]}this.nCachedObjects_=l}remove(){const e=this._objects,t=this._indicesByUUID,n=this._bindings,r=n.length;let i=this.nCachedObjects_;for(let s=0,a=arguments.length;s!==a;++s){const a=arguments[s],o=a.uuid,l=t[o];if(void 0!==l&&l>=i){const s=i++,u=e[s];t[u.uuid]=l,e[l]=u,t[o]=s,e[s]=a;for(let e=0,t=r;e!==t;++e){const t=n[e],r=t[s],i=t[l];t[l]=r,t[s]=i}}}this.nCachedObjects_=i}uncache(){const e=this._objects,t=this._indicesByUUID,n=this._bindings,r=n.length;let i=this.nCachedObjects_,s=e.length;for(let a=0,o=arguments.length;a!==o;++a){const o=arguments[a].uuid,l=t[o];if(void 0!==l)if(delete t[o],l<i){const a=--i,o=e[a],u=--s,c=e[u];t[o.uuid]=l,e[l]=o,t[c.uuid]=a,e[a]=c,e.pop();for(let e=0,t=r;e!==t;++e){const t=n[e],r=t[a],i=t[u];t[l]=r,t[a]=i,t.pop()}}else{const i=--s,a=e[i];i>0&&(t[a.uuid]=l),e[l]=a,e.pop();for(let e=0,t=r;e!==t;++e){const t=n[e];t[l]=t[i],t.pop()}}}this.nCachedObjects_=i}subscribe_(e,t){const n=this._bindingsIndicesByPath;let r=n[e];const i=this._bindings;if(void 0!==r)return i[r];const s=this._paths,a=this._parsedPaths,o=this._objects,l=o.length,u=this.nCachedObjects_,c=new Array(l);r=i.length,n[e]=r,s.push(e),a.push(t),i.push(c);for(let n=u,r=o.length;n!==r;++n){const r=o[n];c[n]=new Xu(r,e,t)}return c}unsubscribe_(e){const t=this._bindingsIndicesByPath,n=t[e];if(void 0!==n){const r=this._paths,i=this._parsedPaths,s=this._bindings,a=s.length-1,o=s[a];t[e[a]]=n,s[n]=o,s.pop(),i[n]=i[a],i.pop(),r[n]=r[a],r.pop()}}},AnimationUtils:wl,ArcCurve:Va,ArrowHelper:class extends Rr{constructor(e=new An(0,0,1),t=new An(0,0,0),n=1,r=16776960,i=.2*n,s=.2*i){super(),this.type="ArrowHelper",void 0===Ac&&(Ac=new vi,Ac.setAttribute("position",new ui([0,0,0,0,1,0],3)),wc=new uo(0,.5,1,5,1),wc.translate(0,-.5,0)),this.position.copy(t),this.line=new _a(Ac,new ha({color:r,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Ci(wc,new Qr({color:r,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(n,i,s)}setDirection(e){if(e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{Ec.set(e.z,0,-e.x).normalize();const t=Math.acos(e.y);this.quaternion.setFromAxisAngle(Ec,t)}}setLength(e,t=.2*e,n=.2*t){this.line.scale.set(1,Math.max(1e-4,e-t),1),this.line.updateMatrix(),this.cone.scale.set(n,t,n),this.cone.position.y=e,this.cone.updateMatrix()}setColor(e){this.line.material.color.set(e),this.cone.material.color.set(e)}copy(e){return super.copy(e,!1),this.line.copy(e.line),this.cone.copy(e.cone),this}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),this.cone.geometry.dispose(),this.cone.material.dispose()}},AttachedBindMode:$,Audio:Ou,AudioAnalyser:class{constructor(e,t=2048){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=t,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let e=0;const t=this.getFrequencyData();for(let n=0;n<t.length;n++)e+=t[n];return e/t.length}},AudioContext:Au,AudioListener:class extends Rr{constructor(){super(),this.type="AudioListener",this.context=Au.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new Iu}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(e){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}updateMatrixWorld(e){super.updateMatrixWorld(e);const t=this.context.listener,n=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(Pu,Nu,Du),ku.set(0,0,-1).applyQuaternion(Nu),t.positionX){const e=this.context.currentTime+this.timeDelta;t.positionX.linearRampToValueAtTime(Pu.x,e),t.positionY.linearRampToValueAtTime(Pu.y,e),t.positionZ.linearRampToValueAtTime(Pu.z,e),t.forwardX.linearRampToValueAtTime(ku.x,e),t.forwardY.linearRampToValueAtTime(ku.y,e),t.forwardZ.linearRampToValueAtTime(ku.z,e),t.upX.linearRampToValueAtTime(n.x,e),t.upY.linearRampToValueAtTime(n.y,e),t.upZ.linearRampToValueAtTime(n.z,e)}else t.setPosition(Pu.x,Pu.y,Pu.z),t.setOrientation(ku.x,ku.y,ku.z,n.x,n.y,n.z)}},AudioLoader:class extends $l{constructor(e){super(e)}load(e,t,n,r){const i=this,s=new ql(this.manager);function a(t){r&&r(t),i.manager.itemError(e)}s.setResponseType("arraybuffer"),s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,function(e){try{const n=e.slice(0);Au.getContext().decodeAudioData(n,function(e){t(e)}).catch(a)}catch(e){a(e)}},n,r)}},AxesHelper:class extends Ea{constructor(e=1){const t=[0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e],n=new vi;n.setAttribute("position",new ui(t,3)),n.setAttribute("color",new ui([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));super(n,new ha({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}setColors(e,t,n){const r=new qr,i=this.geometry.attributes.color.array;return r.set(e),r.toArray(i,0),r.toArray(i,3),r.set(t),r.toArray(i,6),r.toArray(i,9),r.set(n),r.toArray(i,12),r.toArray(i,15),this.geometry.attributes.color.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}},BasicDepthPacking:3200,BasicShadowMap:0,BatchedMesh:da,Bone:Ms,BooleanKeyframeTrack:Pl,Box2:class{constructor(e=new Yt(1/0,1/0),t=new Yt(-1/0,-1/0)){this.isBox2=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=ac.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(e){return this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,ac).distanceTo(e)}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}},Box3:Rn,Box3Helper:class extends Ea{constructor(e,t=16776960){const n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new vi;r.setIndex(new si(n,1)),r.setAttribute("position",new ui([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(r,new ha({color:t,toneMapped:!1})),this.box=e,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}dispose(){this.geometry.dispose(),this.material.dispose()}},BoxHelper:class extends Ea{constructor(e,t=16776960){const n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new Float32Array(24),i=new vi;i.setIndex(new si(n,1)),i.setAttribute("position",new si(r,3)),super(i,new ha({color:t,toneMapped:!1})),this.object=e,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(e){if(void 0!==this.object&&Tc.setFromObject(this.object),Tc.isEmpty())return;const t=Tc.min,n=Tc.max,r=this.geometry.attributes.position,i=r.array;i[0]=n.x,i[1]=n.y,i[2]=n.z,i[3]=t.x,i[4]=n.y,i[5]=n.z,i[6]=t.x,i[7]=t.y,i[8]=n.z,i[9]=n.x,i[10]=t.y,i[11]=n.z,i[12]=n.x,i[13]=n.y,i[14]=t.z,i[15]=t.x,i[16]=n.y,i[17]=t.z,i[18]=t.x,i[19]=t.y,i[20]=t.z,i[21]=n.x,i[22]=t.y,i[23]=t.z,r.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(e){return this.object=e,this.update(),this}copy(e,t){return super.copy(e,t),this.object=e.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}},BufferGeometryLoader:bu,Cache:zl,Camera:Fi,CameraHelper:class extends Ea{constructor(e){const t=new vi,n=new ha({color:16777215,vertexColors:!0,toneMapped:!1}),r=[],i=[],s={};function a(e,t){o(e),o(t)}function o(e){r.push(0,0,0),i.push(0,0,0),void 0===s[e]&&(s[e]=[]),s[e].push(r.length/3-1)}a("n1","n2"),a("n2","n4"),a("n4","n3"),a("n3","n1"),a("f1","f2"),a("f2","f4"),a("f4","f3"),a("f3","f1"),a("n1","f1"),a("n2","f2"),a("n3","f3"),a("n4","f4"),a("p","n1"),a("p","n2"),a("p","n3"),a("p","n4"),a("u1","u2"),a("u2","u3"),a("u3","u1"),a("c","t"),a("p","c"),a("cn1","cn2"),a("cn3","cn4"),a("cf1","cf2"),a("cf3","cf4"),t.setAttribute("position",new ui(r,3)),t.setAttribute("color",new ui(i,3)),super(t,n),this.type="CameraHelper",this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=s,this.update();const l=new qr(16755200),u=new qr(16711680),c=new qr(43775),d=new qr(16777215),h=new qr(3355443);this.setColors(l,u,c,d,h)}setColors(e,t,n,r,i){const s=this.geometry.getAttribute("color");s.setXYZ(0,e.r,e.g,e.b),s.setXYZ(1,e.r,e.g,e.b),s.setXYZ(2,e.r,e.g,e.b),s.setXYZ(3,e.r,e.g,e.b),s.setXYZ(4,e.r,e.g,e.b),s.setXYZ(5,e.r,e.g,e.b),s.setXYZ(6,e.r,e.g,e.b),s.setXYZ(7,e.r,e.g,e.b),s.setXYZ(8,e.r,e.g,e.b),s.setXYZ(9,e.r,e.g,e.b),s.setXYZ(10,e.r,e.g,e.b),s.setXYZ(11,e.r,e.g,e.b),s.setXYZ(12,e.r,e.g,e.b),s.setXYZ(13,e.r,e.g,e.b),s.setXYZ(14,e.r,e.g,e.b),s.setXYZ(15,e.r,e.g,e.b),s.setXYZ(16,e.r,e.g,e.b),s.setXYZ(17,e.r,e.g,e.b),s.setXYZ(18,e.r,e.g,e.b),s.setXYZ(19,e.r,e.g,e.b),s.setXYZ(20,e.r,e.g,e.b),s.setXYZ(21,e.r,e.g,e.b),s.setXYZ(22,e.r,e.g,e.b),s.setXYZ(23,e.r,e.g,e.b),s.setXYZ(24,t.r,t.g,t.b),s.setXYZ(25,t.r,t.g,t.b),s.setXYZ(26,t.r,t.g,t.b),s.setXYZ(27,t.r,t.g,t.b),s.setXYZ(28,t.r,t.g,t.b),s.setXYZ(29,t.r,t.g,t.b),s.setXYZ(30,t.r,t.g,t.b),s.setXYZ(31,t.r,t.g,t.b),s.setXYZ(32,n.r,n.g,n.b),s.setXYZ(33,n.r,n.g,n.b),s.setXYZ(34,n.r,n.g,n.b),s.setXYZ(35,n.r,n.g,n.b),s.setXYZ(36,n.r,n.g,n.b),s.setXYZ(37,n.r,n.g,n.b),s.setXYZ(38,r.r,r.g,r.b),s.setXYZ(39,r.r,r.g,r.b),s.setXYZ(40,i.r,i.g,i.b),s.setXYZ(41,i.r,i.g,i.b),s.setXYZ(42,i.r,i.g,i.b),s.setXYZ(43,i.r,i.g,i.b),s.setXYZ(44,i.r,i.g,i.b),s.setXYZ(45,i.r,i.g,i.b),s.setXYZ(46,i.r,i.g,i.b),s.setXYZ(47,i.r,i.g,i.b),s.setXYZ(48,i.r,i.g,i.b),s.setXYZ(49,i.r,i.g,i.b),s.needsUpdate=!0}update(){const e=this.geometry,t=this.pointMap;xc.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse);const n=this.camera.coordinateSystem===kt?-1:0;Sc("c",t,e,xc,0,0,n),Sc("t",t,e,xc,0,0,1),Sc("n1",t,e,xc,-1,-1,n),Sc("n2",t,e,xc,1,-1,n),Sc("n3",t,e,xc,-1,1,n),Sc("n4",t,e,xc,1,1,n),Sc("f1",t,e,xc,-1,-1,1),Sc("f2",t,e,xc,1,-1,1),Sc("f3",t,e,xc,-1,1,1),Sc("f4",t,e,xc,1,1,1),Sc("u1",t,e,xc,.7,1.1,n),Sc("u2",t,e,xc,-.7,1.1,n),Sc("u3",t,e,xc,0,2,n),Sc("cf1",t,e,xc,-1,0,1),Sc("cf2",t,e,xc,1,0,1),Sc("cf3",t,e,xc,0,-1,1),Sc("cf4",t,e,xc,0,1,1),Sc("cn1",t,e,xc,-1,0,n),Sc("cn2",t,e,xc,1,0,n),Sc("cn3",t,e,xc,0,-1,n),Sc("cn4",t,e,xc,0,1,n),e.getAttribute("position").needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}},CanvasTexture:class extends yn{constructor(e,t,n,r,i,s,a,o,l){super(e,t,n,r,i,s,a,o,l),this.isCanvasTexture=!0,this.needsUpdate=!0}},CapsuleGeometry:oo,CatmullRomCurve3:ja,CircleGeometry:lo,Clock:Iu,ColorKeyframeTrack:Nl,CompressedArrayTexture:class extends Oa{constructor(e,t,n,r,i,s){super(e,t,n,i,s),this.isCompressedArrayTexture=!0,this.image.depth=r,this.wrapR=J,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}},CompressedCubeTexture:class extends Oa{constructor(e,t,n){super(void 0,e[0].width,e[0].height,t,n,q),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}},CompressedTexture:Oa,CompressedTextureLoader:class extends $l{constructor(e){super(e)}load(e,t,n,r){const i=this,s=[],a=new Oa,o=new ql(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(i.withCredentials);let l=0;function u(u){o.load(e[u],function(e){const n=i.parse(e,!0);s[u]={width:n.width,height:n.height,format:n.format,mipmaps:n.mipmaps},l+=1,6===l&&(1===n.mipmapCount&&(a.minFilter=ie),a.image=s,a.format=n.format,a.needsUpdate=!0,t&&t(a))},n,r)}if(Array.isArray(e))for(let t=0,n=e.length;t<n;++t)u(t);else o.load(e,function(e){const n=i.parse(e,!0);if(n.isCubemap){const e=n.mipmaps.length/n.mipmapCount;for(let t=0;t<e;t++){s[t]={mipmaps:[]};for(let e=0;e<n.mipmapCount;e++)s[t].mipmaps.push(n.mipmaps[t*n.mipmapCount+e]),s[t].format=n.format,s[t].width=n.width,s[t].height=n.height}a.image=s}else a.image.width=n.width,a.image.height=n.height,a.mipmaps=n.mipmaps;1===n.mipmapCount&&(a.minFilter=ie),a.format=n.format,a.needsUpdate=!0,t&&t(a)},n,r);return a}},ConeGeometry:co,Controls:class extends Ft{constructor(e,t=null){super(),this.object=e,this.domElement=t,this.enabled=!0,this.state=-1,this.keys={},this.mouseButtons={LEFT:null,MIDDLE:null,RIGHT:null},this.touches={ONE:null,TWO:null}}connect(){}disconnect(){}dispose(){}update(){}},CubeCamera:Hi,CubeTextureLoader:class extends $l{constructor(e){super(e)}load(e,t,n,r){const i=new $i;i.colorSpace=yt;const s=new Xl(this.manager);s.setCrossOrigin(this.crossOrigin),s.setPath(this.path);let a=0;function o(n){s.load(e[n],function(e){i.images[n]=e,a++,6===a&&(i.needsUpdate=!0,t&&t(i))},void 0,r)}for(let t=0;t<e.length;++t)o(t);return i}},CubicBezierCurve:Ka,CubicBezierCurve3:Qa,CubicInterpolant:Rl,CullFaceFrontBack:3,Curve:Ua,CurvePath:io,CylinderGeometry:uo,Cylindrical:class{constructor(e=1,t=0,n=0){return this.radius=e,this.theta=t,this.y=n,this}set(e,t,n){return this.radius=e,this.theta=t,this.y=n,this}copy(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,n){return this.radius=Math.sqrt(e*e+n*n),this.theta=Math.atan2(e,n),this.y=t,this}clone(){return(new this.constructor).copy(this)}},DataTexture:Rs,DataTextureLoader:class extends $l{constructor(e){super(e)}load(e,t,n,r){const i=this,s=new Rs,a=new ql(this.manager);return a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setPath(this.path),a.setWithCredentials(i.withCredentials),a.load(e,function(e){let n;try{n=i.parse(e)}catch(e){if(void 0===r)return;r(e)}void 0!==n.image?s.image=n.image:void 0!==n.data&&(s.image.width=n.width,s.image.height=n.height,s.image.data=n.data),s.wrapS=void 0!==n.wrapS?n.wrapS:J,s.wrapT=void 0!==n.wrapT?n.wrapT:J,s.magFilter=void 0!==n.magFilter?n.magFilter:ie,s.minFilter=void 0!==n.minFilter?n.minFilter:ie,s.anisotropy=void 0!==n.anisotropy?n.anisotropy:1,void 0!==n.colorSpace&&(s.colorSpace=n.colorSpace),void 0!==n.flipY&&(s.flipY=n.flipY),void 0!==n.format&&(s.format=n.format),void 0!==n.type&&(s.type=n.type),void 0!==n.mipmaps&&(s.mipmaps=n.mipmaps,s.minFilter=ae),1===n.mipmapCount&&(s.minFilter=ie),void 0!==n.generateMipmaps&&(s.generateMipmaps=n.generateMipmaps),s.needsUpdate=!0,t&&t(s,n)},n,r),s}},DataUtils:ni,DecrementStencilOp:7683,DecrementWrapStencilOp:34056,DefaultLoadingManager:Hl,DetachedBindMode:W,DirectionalLight:du,DirectionalLightHelper:class extends Rr{constructor(e,t,n){super(),this.light=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=n,this.type="DirectionalLightHelper",void 0===t&&(t=1);let r=new vi;r.setAttribute("position",new ui([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));const i=new ha({fog:!1,toneMapped:!1});this.lightPlane=new _a(r,i),this.add(this.lightPlane),r=new vi,r.setAttribute("position",new ui([0,0,0,0,0,1],3)),this.targetLine=new _a(r,i),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1),vc.setFromMatrixPosition(this.light.matrixWorld),yc.setFromMatrixPosition(this.light.target.matrixWorld),bc.subVectors(yc,vc),this.lightPlane.lookAt(yc),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(yc),this.targetLine.scale.z=bc.length()}},DiscreteInterpolant:Il,DodecahedronGeometry:fo,DynamicCopyUsage:35050,DynamicDrawUsage:Nt,DynamicReadUsage:35049,EdgesGeometry:yo,EllipseCurve:Ba,EqualStencilFunc:514,ExtrudeGeometry:Xo,FileLoader:ql,Float16BufferAttribute:li,Float32BufferAttribute:ui,Fog:qi,FogExp2:ji,FramebufferTexture:ka,GLBufferAttribute:class{constructor(e,t,n,r,i){this.isGLBufferAttribute=!0,this.name="",this.buffer=e,this.type=t,this.itemSize=n,this.elementSize=r,this.count=i,this.version=0}set needsUpdate(e){!0===e&&this.version++}setBuffer(e){return this.buffer=e,this}setType(e,t){return this.type=e,this.elementSize=t,this}setItemSize(e){return this.itemSize=e,this}setCount(e){return this.count=e,this}},GLSL1:"100",GreaterEqualStencilFunc:518,GreaterStencilFunc:516,GridHelper:class extends Ea{constructor(e=10,t=10,n=4473924,r=8947848){n=new qr(n),r=new qr(r);const i=t/2,s=e/t,a=e/2,o=[],l=[];for(let e=0,u=0,c=-a;e<=t;e++,c+=s){o.push(-a,0,c,a,0,c),o.push(c,0,-a,c,0,a);const t=e===i?n:r;t.toArray(l,u),u+=3,t.toArray(l,u),u+=3,t.toArray(l,u),u+=3,t.toArray(l,u),u+=3}const u=new vi;u.setAttribute("position",new ui(o,3)),u.setAttribute("color",new ui(l,3));super(u,new ha({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}},HemisphereLight:Ql,HemisphereLightHelper:class extends Rr{constructor(e,t,n){super(),this.light=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=n,this.type="HemisphereLightHelper";const r=new Qo(t);r.rotateY(.5*Math.PI),this.material=new Qr({wireframe:!0,fog:!1,toneMapped:!1}),void 0===this.color&&(this.material.vertexColors=!0);const i=r.getAttribute("position"),s=new Float32Array(3*i.count);r.setAttribute("color",new si(s,3)),this.add(new Ci(r,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const e=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{const t=e.geometry.getAttribute("color");mc.copy(this.light.color),gc.copy(this.light.groundColor);for(let e=0,n=t.count;e<n;e++){const r=e<n/2?mc:gc;t.setXYZ(e,r.r,r.g,r.b)}t.needsUpdate=!0}this.light.updateWorldMatrix(!0,!1),e.lookAt(pc.setFromMatrixPosition(this.light.matrixWorld).negate())}},IcosahedronGeometry:Ko,ImageBitmapLoader:class extends $l{constructor(e){super(e),this.isImageBitmapLoader=!0,this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,t,n,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,s=zl.get(e);if(void 0!==s)return i.manager.itemStart(e),s.then?void s.then(n=>{t&&t(n),i.manager.itemEnd(e)}).catch(e=>{r&&r(e)}):(setTimeout(function(){t&&t(s),i.manager.itemEnd(e)},0),s);const a={};a.credentials="anonymous"===this.crossOrigin?"same-origin":"include",a.headers=this.requestHeader;const o=fetch(e,a).then(function(e){return e.blob()}).then(function(e){return createImageBitmap(e,Object.assign(i.options,{colorSpaceConversion:"none"}))}).then(function(n){return zl.add(e,n),t&&t(n),i.manager.itemEnd(e),n}).catch(function(t){r&&r(t),zl.remove(e),i.manager.itemError(e),i.manager.itemEnd(e)});zl.add(e,o),i.manager.itemStart(e)}},ImageLoader:Xl,ImageUtils:fn,IncrementStencilOp:7682,IncrementWrapStencilOp:34055,InstancedBufferAttribute:Ps,InstancedBufferGeometry:yu,InstancedInterleavedBuffer:Ju,InstancedMesh:Vs,Int16BufferAttribute:class extends si{constructor(e,t,n){super(new Int16Array(e),t,n)}},Int32BufferAttribute:class extends si{constructor(e,t,n){super(new Int32Array(e),t,n)}},Int8BufferAttribute:class extends si{constructor(e,t,n){super(new Int8Array(e),t,n)}},InterleavedBuffer:Yi,InterleavedBufferAttribute:Qi,Interpolant:Ml,InterpolateDiscrete:ut,InterpolateLinear:ct,InterpolateSmooth:dt,InvertStencilOp:5386,KeepStencilOp:St,KeyframeTrack:Ll,LOD:gs,LatheGeometry:ao,LessEqualStencilFunc:515,LessStencilFunc:513,Light:Kl,LightProbe:mu,Line:_a,Line3:class{constructor(e=new An,t=new An){this.start=e,this.end=t}set(e,t){return this.start.copy(e),this.end.copy(t),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t){return this.delta(t).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t){oc.subVectors(e,this.start),lc.subVectors(this.end,this.start);const n=lc.dot(lc);let r=lc.dot(oc)/n;return t&&(r=Ht(r,0,1)),r}closestPointToPoint(e,t,n){const r=this.closestPointToPointParameter(e,t);return this.delta(n).multiplyScalar(r).add(this.start)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}},LineBasicMaterial:ha,LineCurve:Za,LineCurve3:Ja,LineDashedMaterial:_l,LineLoop:Aa,LineSegments:Ea,LinearInterpolant:Cl,LinearMipMapLinearFilter:1008,LinearMipMapNearestFilter:1007,Loader:$l,LoaderUtils:vu,LoadingManager:Gl,LoopOnce:2200,LoopPingPong:2202,LoopRepeat:2201,MOUSE:f,Material:Kr,MaterialLoader:gu,MathUtils:Xt,Matrix2:sc,MeshLambertMaterial:gl,MeshMatcapMaterial:bl,MeshNormalMaterial:ml,MeshPhongMaterial:fl,MeshPhysicalMaterial:hl,MeshStandardMaterial:dl,MeshToonMaterial:pl,NearestMipMapLinearFilter:1005,NearestMipMapNearestFilter:1004,NeverStencilFunc:512,NormalAnimationBlendMode:mt,NotEqualStencilFunc:517,NumberKeyframeTrack:Dl,Object3D:Rr,ObjectLoader:_u,OctahedronGeometry:Qo,Path:so,PlaneHelper:class extends _a{constructor(e,t=1,n=16776960){const r=n,i=new vi;i.setAttribute("position",new ui([1,-1,0,-1,1,0,-1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,-1,0,1,1,0],3)),i.computeBoundingSphere(),super(i,new ha({color:r,toneMapped:!1})),this.type="PlaneHelper",this.plane=e,this.size=t;const s=new vi;s.setAttribute("position",new ui([1,1,0,-1,1,0,-1,-1,0,1,1,0,-1,-1,0,1,-1,0],3)),s.computeBoundingSphere(),this.add(new Ci(s,new Qr({color:r,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(e){this.position.set(0,0,0),this.scale.set(.5*this.size,.5*this.size,1),this.lookAt(this.plane.normal),this.translateZ(-this.plane.constant),super.updateMatrixWorld(e)}dispose(){this.geometry.dispose(),this.material.dispose(),this.children[0].geometry.dispose(),this.children[0].material.dispose()}},PointLight:lu,PointLightHelper:class extends Ci{constructor(e,t,n){super(new tl(t,4,2),new Qr({wireframe:!0,fog:!1,toneMapped:!1})),this.light=e,this.color=n,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)}},Points:La,PointsMaterial:wa,PolarGridHelper:class extends Ea{constructor(e=10,t=16,n=8,r=64,i=4473924,s=8947848){i=new qr(i),s=new qr(s);const a=[],o=[];if(t>1)for(let n=0;n<t;n++){const r=n/t*(2*Math.PI),l=Math.sin(r)*e,u=Math.cos(r)*e;a.push(0,0,0),a.push(l,0,u);const c=1&n?i:s;o.push(c.r,c.g,c.b),o.push(c.r,c.g,c.b)}for(let t=0;t<n;t++){const l=1&t?i:s,u=e-e/n*t;for(let e=0;e<r;e++){let t=e/r*(2*Math.PI),n=Math.sin(t)*u,i=Math.cos(t)*u;a.push(n,0,i),o.push(l.r,l.g,l.b),t=(e+1)/r*(2*Math.PI),n=Math.sin(t)*u,i=Math.cos(t)*u,a.push(n,0,i),o.push(l.r,l.g,l.b)}}const l=new vi;l.setAttribute("position",new ui(a,3)),l.setAttribute("color",new ui(o,3));super(l,new ha({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}},PolyhedronGeometry:ho,PositionalAudio:class extends Ou{constructor(e){super(e),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}connect(){super.connect(),this.panner.connect(this.gain)}disconnect(){super.disconnect(),this.panner.disconnect(this.gain)}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(e){return this.panner.refDistance=e,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(e){return this.panner.rolloffFactor=e,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){return this.panner.distanceModel=e,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){return this.panner.maxDistance=e,this}setDirectionalCone(e,t,n){return this.panner.coneInnerAngle=e,this.panner.coneOuterAngle=t,this.panner.coneOuterGain=n,this}updateMatrixWorld(e){if(super.updateMatrixWorld(e),!0===this.hasPlaybackControl&&!1===this.isPlaying)return;this.matrixWorld.decompose(Fu,Uu,Bu),Vu.set(0,0,1).applyQuaternion(Uu);const t=this.panner;if(t.positionX){const e=this.context.currentTime+this.listener.timeDelta;t.positionX.linearRampToValueAtTime(Fu.x,e),t.positionY.linearRampToValueAtTime(Fu.y,e),t.positionZ.linearRampToValueAtTime(Fu.z,e),t.orientationX.linearRampToValueAtTime(Vu.x,e),t.orientationY.linearRampToValueAtTime(Vu.y,e),t.orientationZ.linearRampToValueAtTime(Vu.z,e)}else t.setPosition(Fu.x,Fu.y,Fu.z),t.setOrientation(Vu.x,Vu.y,Vu.z)}},PropertyBinding:Xu,PropertyMixer:zu,QuadraticBezierCurve:eo,QuadraticBezierCurve3:to,Quaternion:En,QuaternionKeyframeTrack:Ol,QuaternionLinearInterpolant:kl,RGBDepthPacking:3202,RGBIntegerFormat:1032,RGDepthPacking:3203,RawShaderMaterial:cl,Ray:er,Raycaster:tc,RectAreaLight:fu,RenderTarget:_n,RenderTarget3D:class extends _n{constructor(e=1,t=1,n=1,r={}){super(e,t,r),this.isRenderTarget3D=!0,this.depth=n,this.texture=new Tn(null,e,t,n),this.texture.isRenderTargetTexture=!0}},RenderTargetArray:class extends _n{constructor(e=1,t=1,n=1,r={}){super(e,t,r),this.isRenderTargetArray=!0,this.depth=n,this.texture=new Sn(null,e,t,n),this.texture.isRenderTargetTexture=!0}},ReplaceStencilOp:7681,RingGeometry:Jo,Scene:Xi,ShadowMaterial:ul,Shape:bo,ShapeGeometry:el,ShapePath:class{constructor(){this.type="ShapePath",this.color=new qr,this.subPaths=[],this.currentPath=null}moveTo(e,t){return this.currentPath=new so,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t),this}lineTo(e,t){return this.currentPath.lineTo(e,t),this}quadraticCurveTo(e,t,n,r){return this.currentPath.quadraticCurveTo(e,t,n,r),this}bezierCurveTo(e,t,n,r,i,s){return this.currentPath.bezierCurveTo(e,t,n,r,i,s),this}splineThru(e){return this.currentPath.splineThru(e),this}toShapes(e){function t(e,t){const n=t.length;let r=!1;for(let i=n-1,s=0;s<n;i=s++){let n=t[i],a=t[s],o=a.x-n.x,l=a.y-n.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(n=t[s],o=-o,a=t[i],l=-l),e.y<n.y||e.y>a.y)continue;if(e.y===n.y){if(e.x===n.x)return!0}else{const t=l*(e.x-n.x)-o*(e.y-n.y);if(0===t)return!0;if(t<0)continue;r=!r}}else{if(e.y!==n.y)continue;if(a.x<=e.x&&e.x<=n.x||n.x<=e.x&&e.x<=a.x)return!0}}return r}const n=Wo.isClockWise,r=this.subPaths;if(0===r.length)return[];let i,s,a;const o=[];if(1===r.length)return s=r[0],a=new bo,a.curves=s.curves,o.push(a),o;let l=!n(r[0].getPoints());l=e?!l:l;const u=[],c=[];let d,h,f=[],p=0;c[p]=void 0,f[p]=[];for(let t=0,a=r.length;t<a;t++)s=r[t],d=s.getPoints(),i=n(d),i=e?!i:i,i?(!l&&c[p]&&p++,c[p]={s:new bo,p:d},c[p].s.curves=s.curves,l&&p++,f[p]=[]):f[p].push({h:s,p:d[0]});if(!c[0])return function(e){const t=[];for(let n=0,r=e.length;n<r;n++){const r=e[n],i=new bo;i.curves=r.curves,t.push(i)}return t}(r);if(c.length>1){let e=!1,n=0;for(let e=0,t=c.length;e<t;e++)u[e]=[];for(let r=0,i=c.length;r<i;r++){const i=f[r];for(let s=0;s<i.length;s++){const a=i[s];let o=!0;for(let i=0;i<c.length;i++)t(a.p,c[i].p)&&(r!==i&&n++,o?(o=!1,u[i].push(a)):e=!0);o&&u[r].push(a)}}n>0&&!1===e&&(f=u)}for(let e=0,t=c.length;e<t;e++){a=c[e].s,o.push(a),h=f[e];for(let e=0,t=h.length;e<t;e++)a.holes.push(h[e].h)}return o}},ShapeUtils:Wo,Skeleton:Ls,SkeletonHelper:class extends Ea{constructor(e){const t=fc(e),n=new vi,r=[],i=[],s=new qr(0,0,1),a=new qr(0,1,0);for(let e=0;e<t.length;e++){const n=t[e];n.parent&&n.parent.isBone&&(r.push(0,0,0),r.push(0,0,0),i.push(s.r,s.g,s.b),i.push(a.r,a.g,a.b))}n.setAttribute("position",new ui(r,3)),n.setAttribute("color",new ui(i,3));super(n,new ha({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.isSkeletonHelper=!0,this.type="SkeletonHelper",this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){const t=this.bones,n=this.geometry,r=n.getAttribute("position");hc.copy(this.root.matrixWorld).invert();for(let e=0,n=0;e<t.length;e++){const i=t[e];i.parent&&i.parent.isBone&&(dc.multiplyMatrices(hc,i.matrixWorld),cc.setFromMatrixPosition(dc),r.setXYZ(n,cc.x,cc.y,cc.z),dc.multiplyMatrices(hc,i.parent.matrixWorld),cc.setFromMatrixPosition(dc),r.setXYZ(n+1,cc.x,cc.y,cc.z),n+=2)}n.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(e)}dispose(){this.geometry.dispose(),this.material.dispose()}},SkinnedMesh:ws,Source:mn,Sphere:jn,SphereGeometry:tl,Spherical:ic,SphericalHarmonics3:pu,SplineCurve:no,SpotLight:ru,SpotLightHelper:class extends Rr{constructor(e,t){super(),this.light=e,this.matrixAutoUpdate=!1,this.color=t,this.type="SpotLightHelper";const n=new vi,r=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let e=0,t=1,n=32;e<n;e++,t++){const i=e/n*Math.PI*2,s=t/n*Math.PI*2;r.push(Math.cos(i),Math.sin(i),1,Math.cos(s),Math.sin(s),1)}n.setAttribute("position",new ui(r,3));const i=new ha({fog:!1,toneMapped:!1});this.cone=new Ea(n,i),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1),this.parent?(this.parent.updateWorldMatrix(!0),this.matrix.copy(this.parent.matrixWorld).invert().multiply(this.light.matrixWorld)):this.matrix.copy(this.light.matrixWorld),this.matrixWorld.copy(this.light.matrixWorld);const e=this.light.distance?this.light.distance:1e3,t=e*Math.tan(this.light.angle);this.cone.scale.set(t,t,e),uc.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(uc),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}},Sprite:hs,SpriteMaterial:Zi,StaticCopyUsage:35046,StaticDrawUsage:Pt,StaticReadUsage:35045,StereoCamera:class{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new zi,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new zi,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(e){const t=this._cache;if(t.focus!==e.focus||t.fov!==e.fov||t.aspect!==e.aspect*this.aspect||t.near!==e.near||t.far!==e.far||t.zoom!==e.zoom||t.eyeSep!==this.eyeSep){t.focus=e.focus,t.fov=e.fov,t.aspect=e.aspect*this.aspect,t.near=e.near,t.far=e.far,t.zoom=e.zoom,t.eyeSep=this.eyeSep,Ru.copy(e.projectionMatrix);const n=t.eyeSep/2,r=n*t.near/t.focus,i=t.near*Math.tan(Vt*t.fov*.5)/t.zoom;let s,a;Mu.elements[12]=-n,wu.elements[12]=n,s=-i*t.aspect+r,a=i*t.aspect+r,Ru.elements[0]=2*t.near/(a-s),Ru.elements[8]=(a+s)/(a-s),this.cameraL.projectionMatrix.copy(Ru),s=-i*t.aspect-r,a=i*t.aspect-r,Ru.elements[0]=2*t.near/(a-s),Ru.elements[8]=(a+s)/(a-s),this.cameraR.projectionMatrix.copy(Ru)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(Mu),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(wu)}},StreamCopyUsage:35042,StreamDrawUsage:35040,StreamReadUsage:35041,StringKeyframeTrack:Fl,TOUCH:p,TetrahedronGeometry:nl,TextureLoader:Yl,TextureUtils:Rc,TorusGeometry:rl,TorusKnotGeometry:il,Triangle:Gr,TriangleFanDrawMode:2,TriangleStripDrawMode:1,TrianglesDrawMode:0,TubeGeometry:sl,UVMapping:j,Uint8BufferAttribute:class extends si{constructor(e,t,n){super(new Uint8Array(e),t,n)}},Uint8ClampedBufferAttribute:class extends si{constructor(e,t,n){super(new Uint8ClampedArray(e),t,n)}},Uniform:Qu,UniformsGroup:class extends Ft{constructor(){super(),this.isUniformsGroup=!0,Object.defineProperty(this,"id",{value:Zu++}),this.name="",this.usage=Pt,this.uniforms=[]}add(e){return this.uniforms.push(e),this}remove(e){const t=this.uniforms.indexOf(e);return-1!==t&&this.uniforms.splice(t,1),this}setName(e){return this.name=e,this}setUsage(e){return this.usage=e,this}dispose(){return this.dispatchEvent({type:"dispose"}),this}copy(e){this.name=e.name,this.usage=e.usage;const t=e.uniforms;this.uniforms.length=0;for(let e=0,n=t.length;e<n;e++){const n=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0;e<n.length;e++)this.uniforms.push(n[e].clone())}return this}clone(){return(new this.constructor).copy(this)}},VectorKeyframeTrack:Ul,VideoTexture:Da,WebGL3DRenderTarget:class extends xn{constructor(e=1,t=1,n=1,r={}){super(e,t,r),this.isWebGL3DRenderTarget=!0,this.depth=n,this.texture=new Tn(null,e,t,n),this.texture.isRenderTargetTexture=!0}},WebGLArrayRenderTarget:class extends xn{constructor(e=1,t=1,n=1,r={}){super(e,t,r),this.isWebGLArrayRenderTarget=!0,this.depth=n,this.texture=new Sn(null,e,t,n),this.texture.isRenderTargetTexture=!0}},WebGPUCoordinateSystem:Ot,WireframeGeometry:al,WrapAroundEnding:pt,ZeroCurvatureEnding:ht,ZeroSlopeEnding:ft,ZeroStencilOp:0}),gf={exports:{}},vf={};var yf,bf,_f={};var xf=(bf||(bf=1,"production"===process.env.NODE_ENV?gf.exports=(pf||(pf=1,vf.ConcurrentRoot=1,vf.ContinuousEventPriority=4,vf.DefaultEventPriority=16,vf.DiscreteEventPriority=1,vf.IdleEventPriority=536870912,vf.LegacyRoot=0),vf):gf.exports=(yf||(yf=1,"production"!==process.env.NODE_ENV&&(_f.ConcurrentRoot=1,_f.ContinuousEventPriority=4,_f.DefaultEventPriority=16,_f.DiscreteEventPriority=1,_f.IdleEventPriority=536870912,_f.LegacyRoot=0)),_f)),gf.exports);function Sf(e){let t;const n=new Set,r=(e,r)=>{const i="function"==typeof e?e(t):e;if(i!==t){const e=t;t=r?i:Object.assign({},t,i),n.forEach(n=>n(t,e))}},i=()=>t,s={setState:r,getState:i,subscribe:(e,r,s)=>r||s?((e,r=i,s=Object.is)=>{let a=r(t);function o(){const n=r(t);if(!s(a,n)){const t=a;e(a=n,t)}}return n.add(o),()=>n.delete(o)})(e,r,s):(n.add(e),()=>n.delete(e)),destroy:()=>n.clear()};return t=e(r,i,s),s}const Tf="undefined"==typeof window||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent)?s:a;const Ef=[];function Af(e,t,n=(e,t)=>e===t){if(e===t)return!0;if(!e||!t)return!1;const r=e.length;if(t.length!==r)return!1;for(let i=0;i<r;i++)if(!n(e[i],t[i]))return!1;return!0}function wf(e,t=null,n=!1,r={}){null===t&&(t=[e]);for(const e of Ef)if(Af(t,e.keys,e.equal)){if(n)return;if(Object.prototype.hasOwnProperty.call(e,"error"))throw e.error;if(Object.prototype.hasOwnProperty.call(e,"response"))return r.lifespan&&r.lifespan>0&&(e.timeout&&clearTimeout(e.timeout),e.timeout=setTimeout(e.remove,r.lifespan)),e.response;if(!n)throw e.promise}const i={keys:t,equal:r.equal,remove:()=>{const e=Ef.indexOf(i);-1!==e&&Ef.splice(e,1)},promise:(s=e,"object"==typeof s&&"function"==typeof s.then?e:e(...t)).then(e=>{i.response=e,r.lifespan&&r.lifespan>0&&(i.timeout=setTimeout(i.remove,r.lifespan))}).catch(e=>i.error=e)};var s;if(Ef.push(i),!n)throw i.promise}const Mf=(e,t,n)=>wf(e,t,!1,n);var Rf,Cf={exports:{}},If={exports:{}},Lf={};var Pf,Nf,Df,kf,Of={};function Ff(){return Pf||(Pf=1,e=Of,"production"!==process.env.NODE_ENV&&function(){function t(e,t){var n=e.length;e.push(t),function(e,t,n){for(var r=n;r>0;){var s=r-1>>>1,a=e[s];if(!(i(a,t)>0))return;e[s]=t,e[r]=a,r=s}}(e,t,n)}function n(e){return 0===e.length?null:e[0]}function r(e){if(0===e.length)return null;var t=e[0],n=e.pop();return n!==t&&(e[0]=n,function(e,t,n){for(var r=n,s=e.length,a=s>>>1;r<a;){var o=2*(r+1)-1,l=e[o],u=o+1,c=e[u];if(i(l,t)<0)u<s&&i(c,l)<0?(e[r]=c,e[u]=t,r=u):(e[r]=l,e[o]=t,r=o);else{if(!(u<s&&i(c,t)<0))return;e[r]=c,e[u]=t,r=u}}}(e,n,0)),t}function i(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error),"object"==typeof performance&&"function"==typeof performance.now){var s=performance;e.unstable_now=function(){return s.now()}}else{var a=Date,o=a.now();e.unstable_now=function(){return a.now()-o}}var l=[],u=[],c=1,d=null,h=3,f=!1,p=!1,m=!1,g="function"==typeof setTimeout?setTimeout:null,v="function"==typeof clearTimeout?clearTimeout:null,y="undefined"!=typeof setImmediate?setImmediate:null;function b(e){for(var i=n(u);null!==i;){if(null===i.callback)r(u);else{if(!(i.startTime<=e))return;r(u),i.sortIndex=i.expirationTime,t(l,i)}i=n(u)}}function _(e){if(m=!1,b(e),!p)if(null!==n(l))p=!0,P(x);else{var t=n(u);null!==t&&N(_,t.startTime-e)}}function x(t,i){p=!1,m&&(m=!1,D()),f=!0;var s=h;try{return function(t,i){var s=i;for(b(s),d=n(l);null!==d&&(!(d.expirationTime>s)||t&&!M());){var a=d.callback;if("function"==typeof a){d.callback=null,h=d.priorityLevel;var o=a(d.expirationTime<=s);s=e.unstable_now(),"function"==typeof o?d.callback=o:d===n(l)&&r(l),b(s)}else r(l);d=n(l)}if(null!==d)return!0;var c=n(u);return null!==c&&N(_,c.startTime-s),!1}(t,i)}finally{d=null,h=s,f=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var S=!1,T=null,E=-1,A=5,w=-1;function M(){return!(e.unstable_now()-w<A)}var R,C=function(){if(null!==T){var t=e.unstable_now();w=t;var n=!0;try{n=T(!0,t)}finally{n?R():(S=!1,T=null)}}else S=!1};if("function"==typeof y)R=function(){y(C)};else if("undefined"!=typeof MessageChannel){var I=new MessageChannel,L=I.port2;I.port1.onmessage=C,R=function(){L.postMessage(null)}}else R=function(){g(C,0)};function P(e){T=e,S||(S=!0,R())}function N(t,n){E=g(function(){t(e.unstable_now())},n)}function D(){v(E),E=-1}var k=function(){};e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(e){e.callback=null},e.unstable_continueExecution=function(){p||f||(p=!0,P(x))},e.unstable_forceFrameRate=function(e){e<0||e>125||(A=e>0?Math.floor(1e3/e):5)},e.unstable_getCurrentPriorityLevel=function(){return h},e.unstable_getFirstCallbackNode=function(){return n(l)},e.unstable_next=function(e){var t;switch(h){case 1:case 2:case 3:t=3;break;default:t=h}var n=h;h=t;try{return e()}finally{h=n}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=k,e.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=h;h=e;try{return t()}finally{h=n}},e.unstable_scheduleCallback=function(r,i,s){var a,o,d=e.unstable_now();if("object"==typeof s&&null!==s){var h=s.delay;a="number"==typeof h&&h>0?d+h:d}else a=d;switch(r){case 1:o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}var g=a+o,v={id:c++,callback:i,priorityLevel:r,startTime:a,expirationTime:g,sortIndex:-1};return a>d?(v.sortIndex=a,t(u,v),null===n(l)&&v===n(u)&&(m?D():m=!0,N(_,a-d))):(v.sortIndex=g,t(l,v),p||f||(p=!0,P(x))),v},e.unstable_shouldYield=M,e.unstable_wrapCallback=function(e){var t=h;return function(){var n=h;h=t;try{return e.apply(this,arguments)}finally{h=n}}},"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error)}()),Of;var e}function Uf(){return Nf||(Nf=1,"production"===process.env.NODE_ENV?If.exports=(Rf||(Rf=1,function(e){function t(e,t){var n=e.length;e.push(t);e:for(;0<n;){var r=n-1>>>1,s=e[r];if(!(0<i(s,t)))break e;e[r]=t,e[n]=s,n=r}}function n(e){return 0===e.length?null:e[0]}function r(e){if(0===e.length)return null;var t=e[0],n=e.pop();if(n!==t){e[0]=n;e:for(var r=0,s=e.length,a=s>>>1;r<a;){var o=2*(r+1)-1,l=e[o],u=o+1,c=e[u];if(0>i(l,n))u<s&&0>i(c,l)?(e[r]=c,e[u]=n,r=u):(e[r]=l,e[o]=n,r=o);else{if(!(u<s&&0>i(c,n)))break e;e[r]=c,e[u]=n,r=u}}}return t}function i(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var s=performance;e.unstable_now=function(){return s.now()}}else{var a=Date,o=a.now();e.unstable_now=function(){return a.now()-o}}var l=[],u=[],c=1,d=null,h=3,f=!1,p=!1,m=!1,g="function"==typeof setTimeout?setTimeout:null,v="function"==typeof clearTimeout?clearTimeout:null,y="undefined"!=typeof setImmediate?setImmediate:null;function b(e){for(var i=n(u);null!==i;){if(null===i.callback)r(u);else{if(!(i.startTime<=e))break;r(u),i.sortIndex=i.expirationTime,t(l,i)}i=n(u)}}function _(e){if(m=!1,b(e),!p)if(null!==n(l))p=!0,P(x);else{var t=n(u);null!==t&&N(_,t.startTime-e)}}function x(t,i){p=!1,m&&(m=!1,v(A),A=-1),f=!0;var s=h;try{for(b(i),d=n(l);null!==d&&(!(d.expirationTime>i)||t&&!R());){var a=d.callback;if("function"==typeof a){d.callback=null,h=d.priorityLevel;var o=a(d.expirationTime<=i);i=e.unstable_now(),"function"==typeof o?d.callback=o:d===n(l)&&r(l),b(i)}else r(l);d=n(l)}if(null!==d)var c=!0;else{var g=n(u);null!==g&&N(_,g.startTime-i),c=!1}return c}finally{d=null,h=s,f=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var S,T=!1,E=null,A=-1,w=5,M=-1;function R(){return!(e.unstable_now()-M<w)}function C(){if(null!==E){var t=e.unstable_now();M=t;var n=!0;try{n=E(!0,t)}finally{n?S():(T=!1,E=null)}}else T=!1}if("function"==typeof y)S=function(){y(C)};else if("undefined"!=typeof MessageChannel){var I=new MessageChannel,L=I.port2;I.port1.onmessage=C,S=function(){L.postMessage(null)}}else S=function(){g(C,0)};function P(e){E=e,T||(T=!0,S())}function N(t,n){A=g(function(){t(e.unstable_now())},n)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(e){e.callback=null},e.unstable_continueExecution=function(){p||f||(p=!0,P(x))},e.unstable_forceFrameRate=function(e){0>e||125<e||(w=0<e?Math.floor(1e3/e):5)},e.unstable_getCurrentPriorityLevel=function(){return h},e.unstable_getFirstCallbackNode=function(){return n(l)},e.unstable_next=function(e){switch(h){case 1:case 2:case 3:var t=3;break;default:t=h}var n=h;h=t;try{return e()}finally{h=n}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=function(){},e.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=h;h=e;try{return t()}finally{h=n}},e.unstable_scheduleCallback=function(r,i,s){var a=e.unstable_now();switch(s="object"==typeof s&&null!==s&&"number"==typeof(s=s.delay)&&0<s?a+s:a,r){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return r={id:c++,callback:i,priorityLevel:r,startTime:s,expirationTime:o=s+o,sortIndex:-1},s>a?(r.sortIndex=s,t(u,r),null===n(l)&&r===n(u)&&(m?(v(A),A=-1):m=!0,N(_,s-a))):(r.sortIndex=o,t(l,r),p||f||(p=!0,P(x))),r},e.unstable_shouldYield=R,e.unstable_wrapCallback=function(e){var t=h;return function(){var n=h;h=t;try{return e.apply(this,arguments)}finally{h=n}}}}(Lf)),Lf):If.exports=Ff()),If.exports}function Bf(){return kf||(kf=1,Df=function(e){var n={},r=t,i=Uf(),s=Object.assign;function a(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var o=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,l=Symbol.for("react.element"),u=Symbol.for("react.portal"),c=Symbol.for("react.fragment"),d=Symbol.for("react.strict_mode"),h=Symbol.for("react.profiler"),f=Symbol.for("react.provider"),p=Symbol.for("react.context"),m=Symbol.for("react.forward_ref"),g=Symbol.for("react.suspense"),v=Symbol.for("react.suspense_list"),y=Symbol.for("react.memo"),b=Symbol.for("react.lazy"),_=Symbol.for("react.offscreen"),x=Symbol.iterator;function S(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=x&&e[x]||e["@@iterator"])?e:null}function T(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case c:return"Fragment";case u:return"Portal";case h:return"Profiler";case d:return"StrictMode";case g:return"Suspense";case v:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case p:return(e.displayName||"Context")+".Consumer";case f:return(e._context.displayName||"Context")+".Provider";case m:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case y:return null!==(t=e.displayName||null)?t:T(e.type)||"Memo";case b:t=e._payload,e=e._init;try{return T(e(t))}catch(e){}}return null}function E(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return T(t);case 8:return t===d?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof t)return t.displayName||t.name||null;if("string"==typeof t)return t}return null}function A(e){var t=e,n=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{!!(4098&(t=e).flags)&&(n=t.return),e=t.return}while(e)}return 3===t.tag?n:null}function w(e){if(A(e)!==e)throw Error(a(188))}function M(e){var t=e.alternate;if(!t){if(null===(t=A(e)))throw Error(a(188));return t!==e?null:e}for(var n=e,r=t;;){var i=n.return;if(null===i)break;var s=i.alternate;if(null===s){if(null!==(r=i.return)){n=r;continue}break}if(i.child===s.child){for(s=i.child;s;){if(s===n)return w(i),e;if(s===r)return w(i),t;s=s.sibling}throw Error(a(188))}if(n.return!==r.return)n=i,r=s;else{for(var o=!1,l=i.child;l;){if(l===n){o=!0,n=i,r=s;break}if(l===r){o=!0,r=i,n=s;break}l=l.sibling}if(!o){for(l=s.child;l;){if(l===n){o=!0,n=s,r=i;break}if(l===r){o=!0,r=s,n=i;break}l=l.sibling}if(!o)throw Error(a(189))}}if(n.alternate!==r)throw Error(a(190))}if(3!==n.tag)throw Error(a(188));return n.stateNode.current===n?e:t}function R(e){return null!==(e=M(e))?C(e):null}function C(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=C(e);if(null!==t)return t;e=e.sibling}return null}function I(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){if(4!==e.tag){var t=I(e);if(null!==t)return t}e=e.sibling}return null}var L,P=Array.isArray,N=e.getPublicInstance,D=e.getRootHostContext,k=e.getChildHostContext,O=e.prepareForCommit,F=e.resetAfterCommit,U=e.createInstance,B=e.appendInitialChild,V=e.finalizeInitialChildren,z=e.prepareUpdate,G=e.shouldSetTextContent,H=e.createTextInstance,$=e.scheduleTimeout,W=e.cancelTimeout,j=e.noTimeout,q=e.isPrimaryRenderer,X=e.supportsMutation,Y=e.supportsPersistence,K=e.supportsHydration,Q=e.getInstanceFromNode,Z=e.preparePortalMount,J=e.getCurrentEventPriority,ee=e.detachDeletedInstance,te=e.supportsMicrotasks,ne=e.scheduleMicrotask,re=e.supportsTestSelectors,ie=e.findFiberRoot,se=e.getBoundingRect,ae=e.getTextContent,oe=e.isHiddenSubtree,le=e.matchAccessibilityRole,ue=e.setFocusIfFocusable,ce=e.setupIntersectionObserver,de=e.appendChild,he=e.appendChildToContainer,fe=e.commitTextUpdate,pe=e.commitMount,me=e.commitUpdate,ge=e.insertBefore,ve=e.insertInContainerBefore,ye=e.removeChild,be=e.removeChildFromContainer,_e=e.resetTextContent,xe=e.hideInstance,Se=e.hideTextInstance,Te=e.unhideInstance,Ee=e.unhideTextInstance,Ae=e.clearContainer,we=e.cloneInstance,Me=e.createContainerChildSet,Re=e.appendChildToContainerChildSet,Ce=e.finalizeContainerChildren,Ie=e.replaceContainerChildren,Le=e.cloneHiddenInstance,Pe=e.cloneHiddenTextInstance,Ne=e.canHydrateInstance,De=e.canHydrateTextInstance,ke=e.canHydrateSuspenseInstance,Oe=e.isSuspenseInstancePending,Fe=e.isSuspenseInstanceFallback,Ue=e.registerSuspenseInstanceRetry,Be=e.getNextHydratableSibling,Ve=e.getFirstHydratableChild,ze=e.getFirstHydratableChildWithinContainer,Ge=e.getFirstHydratableChildWithinSuspenseInstance,He=e.hydrateInstance,$e=e.hydrateTextInstance,We=e.hydrateSuspenseInstance,je=e.getNextHydratableInstanceAfterSuspenseInstance,qe=e.commitHydratedContainer,Xe=e.commitHydratedSuspenseInstance,Ye=e.clearSuspenseBoundary,Ke=e.clearSuspenseBoundaryFromContainer,Qe=e.shouldDeleteUnhydratedTailInstances,Ze=e.didNotMatchHydratedContainerTextInstance,Je=e.didNotMatchHydratedTextInstance;function et(e){if(void 0===L)try{throw Error()}catch(e){var t=e.stack.trim().match(/\n( *(at )?)/);L=t&&t[1]||""}return"\n"+L+e}var tt=!1;function nt(e,t){if(!e||tt)return"";tt=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(e){var r=e}Reflect.construct(e,[],t)}else{try{t.call()}catch(e){r=e}e.call(t.prototype)}else{try{throw Error()}catch(e){r=e}e()}}catch(t){if(t&&r&&"string"==typeof t.stack){for(var i=t.stack.split("\n"),s=r.stack.split("\n"),a=i.length-1,o=s.length-1;1<=a&&0<=o&&i[a]!==s[o];)o--;for(;1<=a&&0<=o;a--,o--)if(i[a]!==s[o]){if(1!==a||1!==o)do{if(a--,0>--o||i[a]!==s[o]){var l="\n"+i[a].replace(" at new "," at ");return e.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",e.displayName)),l}}while(1<=a&&0<=o);break}}}finally{tt=!1,Error.prepareStackTrace=n}return(e=e?e.displayName||e.name:"")?et(e):""}var rt=Object.prototype.hasOwnProperty,it=[],st=-1;function at(e){return{current:e}}function ot(e){0>st||(e.current=it[st],it[st]=null,st--)}function lt(e,t){st++,it[st]=e.current,e.current=t}var ut={},ct=at(ut),dt=at(!1),ht=ut;function ft(e,t){var n=e.type.contextTypes;if(!n)return ut;var r=e.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===t)return r.__reactInternalMemoizedMaskedChildContext;var i,s={};for(i in n)s[i]=t[i];return r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=s),s}function pt(e){return null!=(e=e.childContextTypes)}function mt(){ot(dt),ot(ct)}function gt(e,t,n){if(ct.current!==ut)throw Error(a(168));lt(ct,t),lt(dt,n)}function vt(e,t,n){var r=e.stateNode;if(t=t.childContextTypes,"function"!=typeof r.getChildContext)return n;for(var i in r=r.getChildContext())if(!(i in t))throw Error(a(108,E(e)||"Unknown",i));return s({},n,r)}function yt(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||ut,ht=ct.current,lt(ct,e),lt(dt,dt.current),!0}function bt(e,t,n){var r=e.stateNode;if(!r)throw Error(a(169));n?(e=vt(e,t,ht),r.__reactInternalMemoizedMergedChildContext=e,ot(dt),ot(ct),lt(ct,e)):ot(dt),lt(dt,n)}var _t=Math.clz32?Math.clz32:function(e){return 0===(e>>>=0)?32:31-(xt(e)/St|0)|0},xt=Math.log,St=Math.LN2;var Tt=64,Et=4194304;function At(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function wt(e,t){var n=e.pendingLanes;if(0===n)return 0;var r=0,i=e.suspendedLanes,s=e.pingedLanes,a=268435455&n;if(0!==a){var o=a&~i;0!==o?r=At(o):0!==(s&=a)&&(r=At(s))}else 0!==(a=n&~i)?r=At(a):0!==s&&(r=At(s));if(0===r)return 0;if(0!==t&&t!==r&&0===(t&i)&&((i=r&-r)>=(s=t&-t)||16===i&&4194240&s))return t;if(4&r&&(r|=16&n),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=r;0<t;)i=1<<(n=31-_t(t)),r|=e[n],t&=~i;return r}function Mt(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function Rt(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function Ct(e){for(var t=[],n=0;31>n;n++)t.push(e);return t}function It(e,t,n){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-_t(t)]=n}function Lt(e,t){var n=e.entangledLanes|=t;for(e=e.entanglements;n;){var r=31-_t(n),i=1<<r;i&t|e[r]&t&&(e[r]|=t),n&=~i}}var Pt=0;function Nt(e){return 1<(e&=-e)?4<e?268435455&e?16:536870912:4:1}var Dt=i.unstable_scheduleCallback,kt=i.unstable_cancelCallback,Ot=i.unstable_shouldYield,Ft=i.unstable_requestPaint,Ut=i.unstable_now,Bt=i.unstable_ImmediatePriority,Vt=i.unstable_UserBlockingPriority,zt=i.unstable_NormalPriority,Gt=i.unstable_IdlePriority,Ht=null,$t=null;var Wt="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},jt=null,qt=!1,Xt=!1;function Yt(e){null===jt?jt=[e]:jt.push(e)}function Kt(){if(!Xt&&null!==jt){Xt=!0;var e=0,t=Pt;try{var n=jt;for(Pt=1;e<n.length;e++){var r=n[e];do{r=r(!0)}while(null!==r)}jt=null,qt=!1}catch(t){throw null!==jt&&(jt=jt.slice(e+1)),Dt(Bt,Kt),t}finally{Pt=t,Xt=!1}}return null}var Qt=o.ReactCurrentBatchConfig;function Zt(e,t){if(Wt(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(r=0;r<n.length;r++){var i=n[r];if(!rt.call(t,i)||!Wt(e[i],t[i]))return!1}return!0}function Jt(e){switch(e.tag){case 5:return et(e.type);case 16:return et("Lazy");case 13:return et("Suspense");case 19:return et("SuspenseList");case 0:case 2:case 15:return e=nt(e.type,!1);case 11:return e=nt(e.type.render,!1);case 1:return e=nt(e.type,!0);default:return""}}function en(e,t){if(e&&e.defaultProps){for(var n in t=s({},t),e=e.defaultProps)void 0===t[n]&&(t[n]=e[n]);return t}return t}var tn=at(null),nn=null,rn=null,sn=null;function an(){sn=rn=nn=null}function on(e,t,n){q?(lt(tn,t._currentValue),t._currentValue=n):(lt(tn,t._currentValue2),t._currentValue2=n)}function ln(e){var t=tn.current;ot(tn),q?e._currentValue=t:e._currentValue2=t}function un(e,t,n){for(;null!==e;){var r=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==r&&(r.childLanes|=t)):null!==r&&(r.childLanes&t)!==t&&(r.childLanes|=t),e===n)break;e=e.return}}function cn(e,t){nn=e,sn=rn=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!==(e.lanes&t)&&(ki=!0),e.firstContext=null)}function dn(e){var t=q?e._currentValue:e._currentValue2;if(sn!==e)if(e={context:e,memoizedValue:t,next:null},null===rn){if(null===nn)throw Error(a(308));rn=e,nn.dependencies={lanes:0,firstContext:e}}else rn=rn.next=e;return t}var hn=null,fn=!1;function pn(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function mn(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function gn(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function vn(e,t){var n=e.updateQueue;null!==n&&(n=n.shared,null!==qs&&1&e.mode&&!(2&js)?(null===(e=n.interleaved)?(t.next=t,null===hn?hn=[n]:hn.push(n)):(t.next=e.next,e.next=t),n.interleaved=t):(null===(e=n.pending)?t.next=t:(t.next=e.next,e.next=t),n.pending=t))}function yn(e,t,n){if(null!==(t=t.updateQueue)&&(t=t.shared,4194240&n)){var r=t.lanes;n|=r&=e.pendingLanes,t.lanes=n,Lt(e,n)}}function bn(e,t){var n=e.updateQueue,r=e.alternate;if(null!==r&&n===(r=r.updateQueue)){var i=null,s=null;if(null!==(n=n.firstBaseUpdate)){do{var a={eventTime:n.eventTime,lane:n.lane,tag:n.tag,payload:n.payload,callback:n.callback,next:null};null===s?i=s=a:s=s.next=a,n=n.next}while(null!==n);null===s?i=s=t:s=s.next=t}else i=s=t;return n={baseState:r.baseState,firstBaseUpdate:i,lastBaseUpdate:s,shared:r.shared,effects:r.effects},void(e.updateQueue=n)}null===(e=n.lastBaseUpdate)?n.firstBaseUpdate=t:e.next=t,n.lastBaseUpdate=t}function _n(e,t,n,r){var i=e.updateQueue;fn=!1;var a=i.firstBaseUpdate,o=i.lastBaseUpdate,l=i.shared.pending;if(null!==l){i.shared.pending=null;var u=l,c=u.next;u.next=null,null===o?a=c:o.next=c,o=u;var d=e.alternate;null!==d&&((l=(d=d.updateQueue).lastBaseUpdate)!==o&&(null===l?d.firstBaseUpdate=c:l.next=c,d.lastBaseUpdate=u))}if(null!==a){var h=i.baseState;for(o=0,d=c=u=null,l=a;;){var f=l.lane,p=l.eventTime;if((r&f)===f){null!==d&&(d=d.next={eventTime:p,lane:0,tag:l.tag,payload:l.payload,callback:l.callback,next:null});e:{var m=e,g=l;switch(f=t,p=n,g.tag){case 1:if("function"==typeof(m=g.payload)){h=m.call(p,h,f);break e}h=m;break e;case 3:m.flags=-65537&m.flags|128;case 0:if(null==(f="function"==typeof(m=g.payload)?m.call(p,h,f):m))break e;h=s({},h,f);break e;case 2:fn=!0}}null!==l.callback&&0!==l.lane&&(e.flags|=64,null===(f=i.effects)?i.effects=[l]:f.push(l))}else p={eventTime:p,lane:f,tag:l.tag,payload:l.payload,callback:l.callback,next:null},null===d?(c=d=p,u=h):d=d.next=p,o|=f;if(null===(l=l.next)){if(null===(l=i.shared.pending))break;l=(f=l).next,f.next=null,i.lastBaseUpdate=f,i.shared.pending=null}}if(null===d&&(u=h),i.baseState=u,i.firstBaseUpdate=c,i.lastBaseUpdate=d,null!==(t=i.shared.interleaved)){i=t;do{o|=i.lane,i=i.next}while(i!==t)}else null===a&&(i.shared.lanes=0);ea|=o,e.lanes=o,e.memoizedState=h}}function xn(e,t,n){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var r=e[t],i=r.callback;if(null!==i){if(r.callback=null,r=n,"function"!=typeof i)throw Error(a(191,i));i.call(r)}}}var Sn=(new r.Component).refs;function Tn(e,t,n,r){n=null==(n=n(r,t=e.memoizedState))?t:s({},t,n),e.memoizedState=n,0===e.lanes&&(e.updateQueue.baseState=n)}var En={isMounted:function(e){return!!(e=e._reactInternals)&&A(e)===e},enqueueSetState:function(e,t,n){e=e._reactInternals;var r=ba(),i=_a(e),s=gn(r,i);s.payload=t,null!=n&&(s.callback=n),vn(e,s),null!==(t=xa(e,i,r))&&yn(t,e,i)},enqueueReplaceState:function(e,t,n){e=e._reactInternals;var r=ba(),i=_a(e),s=gn(r,i);s.tag=1,s.payload=t,null!=n&&(s.callback=n),vn(e,s),null!==(t=xa(e,i,r))&&yn(t,e,i)},enqueueForceUpdate:function(e,t){e=e._reactInternals;var n=ba(),r=_a(e),i=gn(n,r);i.tag=2,null!=t&&(i.callback=t),vn(e,i),null!==(t=xa(e,r,n))&&yn(t,e,r)}};function An(e,t,n,r,i,s,a){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(r,s,a):!t.prototype||!t.prototype.isPureReactComponent||(!Zt(n,r)||!Zt(i,s))}function wn(e,t,n){var r=!1,i=ut,s=t.contextType;return"object"==typeof s&&null!==s?s=dn(s):(i=pt(t)?ht:ct.current,s=(r=null!=(r=t.contextTypes))?ft(e,i):ut),t=new t(n,s),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=En,e.stateNode=t,t._reactInternals=e,r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=i,e.__reactInternalMemoizedMaskedChildContext=s),t}function Mn(e,t,n,r){e=t.state,"function"==typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(n,r),"function"==typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(n,r),t.state!==e&&En.enqueueReplaceState(t,t.state,null)}function Rn(e,t,n,r){var i=e.stateNode;i.props=n,i.state=e.memoizedState,i.refs=Sn,pn(e);var s=t.contextType;"object"==typeof s&&null!==s?i.context=dn(s):(s=pt(t)?ht:ct.current,i.context=ft(e,s)),i.state=e.memoizedState,"function"==typeof(s=t.getDerivedStateFromProps)&&(Tn(e,t,s,n),i.state=e.memoizedState),"function"==typeof t.getDerivedStateFromProps||"function"==typeof i.getSnapshotBeforeUpdate||"function"!=typeof i.UNSAFE_componentWillMount&&"function"!=typeof i.componentWillMount||(t=i.state,"function"==typeof i.componentWillMount&&i.componentWillMount(),"function"==typeof i.UNSAFE_componentWillMount&&i.UNSAFE_componentWillMount(),t!==i.state&&En.enqueueReplaceState(i,i.state,null),_n(e,n,i,r),i.state=e.memoizedState),"function"==typeof i.componentDidMount&&(e.flags|=4194308)}var Cn=[],In=0,Ln=null,Pn=0,Nn=[],Dn=0,kn=null,On=1,Fn="";function Un(e,t){Cn[In++]=Pn,Cn[In++]=Ln,Ln=e,Pn=t}function Bn(e,t,n){Nn[Dn++]=On,Nn[Dn++]=Fn,Nn[Dn++]=kn,kn=e;var r=On;e=Fn;var i=32-_t(r)-1;r&=~(1<<i),n+=1;var s=32-_t(t)+i;if(30<s){var a=i-i%5;s=(r&(1<<a)-1).toString(32),r>>=a,i-=a,On=1<<32-_t(t)+i|n<<i|r,Fn=s+e}else On=1<<s|n<<i|r,Fn=e}function Vn(e){null!==e.return&&(Un(e,1),Bn(e,1,0))}function zn(e){for(;e===Ln;)Ln=Cn[--In],Cn[In]=null,Pn=Cn[--In],Cn[In]=null;for(;e===kn;)kn=Nn[--Dn],Nn[Dn]=null,Fn=Nn[--Dn],Nn[Dn]=null,On=Nn[--Dn],Nn[Dn]=null}var Gn=null,Hn=null,$n=!1,Wn=!1,jn=null;function qn(e,t){var n=Ka(5,null,null,0);n.elementType="DELETED",n.stateNode=t,n.return=e,null===(t=e.deletions)?(e.deletions=[n],e.flags|=16):t.push(n)}function Xn(e,t){switch(e.tag){case 5:return null!==(t=Ne(t,e.type,e.pendingProps))&&(e.stateNode=t,Gn=e,Hn=Ve(t),!0);case 6:return null!==(t=De(t,e.pendingProps))&&(e.stateNode=t,Gn=e,Hn=null,!0);case 13:if(null!==(t=ke(t))){var n=null!==kn?{id:On,overflow:Fn}:null;return e.memoizedState={dehydrated:t,treeContext:n,retryLane:1073741824},(n=Ka(18,null,null,0)).stateNode=t,n.return=e,e.child=n,Gn=e,Hn=null,!0}return!1;default:return!1}}function Yn(e){return!(!(1&e.mode)||128&e.flags)}function Kn(e){if($n){var t=Hn;if(t){var n=t;if(!Xn(e,t)){if(Yn(e))throw Error(a(418));t=Be(n);var r=Gn;t&&Xn(e,t)?qn(r,n):(e.flags=-4097&e.flags|2,$n=!1,Gn=e)}}else{if(Yn(e))throw Error(a(418));e.flags=-4097&e.flags|2,$n=!1,Gn=e}}}function Qn(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;Gn=e}function Zn(e){if(!K||e!==Gn)return!1;if(!$n)return Qn(e),$n=!0,!1;if(3!==e.tag&&(5!==e.tag||Qe(e.type)&&!G(e.type,e.memoizedProps))){var t=Hn;if(t){if(Yn(e)){for(e=Hn;e;)e=Be(e);throw Error(a(418))}for(;t;)qn(e,t),t=Be(t)}}if(Qn(e),13===e.tag){if(!K)throw Error(a(316));if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(a(317));Hn=je(e)}else Hn=Gn?Be(e.stateNode):null;return!0}function Jn(){K&&(Hn=Gn=null,Wn=$n=!1)}function er(e){null===jn?jn=[e]:jn.push(e)}function tr(e,t,n){if(null!==(e=n.ref)&&"function"!=typeof e&&"object"!=typeof e){if(n._owner){if(n=n._owner){if(1!==n.tag)throw Error(a(309));var r=n.stateNode}if(!r)throw Error(a(147,e));var i=r,s=""+e;return null!==t&&null!==t.ref&&"function"==typeof t.ref&&t.ref._stringRef===s?t.ref:(t=function(e){var t=i.refs;t===Sn&&(t=i.refs={}),null===e?delete t[s]:t[s]=e},t._stringRef=s,t)}if("string"!=typeof e)throw Error(a(284));if(!n._owner)throw Error(a(290,e))}return e}function nr(e,t){throw e=Object.prototype.toString.call(t),Error(a(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function rr(e){return(0,e._init)(e._payload)}function ir(e){function t(t,n){if(e){var r=t.deletions;null===r?(t.deletions=[n],t.flags|=16):r.push(n)}}function n(n,r){if(!e)return null;for(;null!==r;)t(n,r),r=r.sibling;return null}function r(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function i(e,t){return(e=Za(e,t)).index=0,e.sibling=null,e}function s(t,n,r){return t.index=r,e?null!==(r=t.alternate)?(r=r.index)<n?(t.flags|=2,n):r:(t.flags|=2,n):(t.flags|=1048576,n)}function o(t){return e&&null===t.alternate&&(t.flags|=2),t}function d(e,t,n,r){return null===t||6!==t.tag?((t=no(n,e.mode,r)).return=e,t):((t=i(t,n)).return=e,t)}function h(e,t,n,r){var s=n.type;return s===c?p(e,t,n.props.children,r,n.key):null!==t&&(t.elementType===s||"object"==typeof s&&null!==s&&s.$$typeof===b&&rr(s)===t.type)?((r=i(t,n.props)).ref=tr(e,t,n),r.return=e,r):((r=Ja(n.type,n.key,n.props,null,e.mode,r)).ref=tr(e,t,n),r.return=e,r)}function f(e,t,n,r){return null===t||4!==t.tag||t.stateNode.containerInfo!==n.containerInfo||t.stateNode.implementation!==n.implementation?((t=ro(n,e.mode,r)).return=e,t):((t=i(t,n.children||[])).return=e,t)}function p(e,t,n,r,s){return null===t||7!==t.tag?((t=eo(n,e.mode,r,s)).return=e,t):((t=i(t,n)).return=e,t)}function m(e,t,n){if("string"==typeof t&&""!==t||"number"==typeof t)return(t=no(""+t,e.mode,n)).return=e,t;if("object"==typeof t&&null!==t){switch(t.$$typeof){case l:return(n=Ja(t.type,t.key,t.props,null,e.mode,n)).ref=tr(e,null,t),n.return=e,n;case u:return(t=ro(t,e.mode,n)).return=e,t;case b:return m(e,(0,t._init)(t._payload),n)}if(P(t)||S(t))return(t=eo(t,e.mode,n,null)).return=e,t;nr(e,t)}return null}function g(e,t,n,r){var i=null!==t?t.key:null;if("string"==typeof n&&""!==n||"number"==typeof n)return null!==i?null:d(e,t,""+n,r);if("object"==typeof n&&null!==n){switch(n.$$typeof){case l:return n.key===i?h(e,t,n,r):null;case u:return n.key===i?f(e,t,n,r):null;case b:return g(e,t,(i=n._init)(n._payload),r)}if(P(n)||S(n))return null!==i?null:p(e,t,n,r,null);nr(e,n)}return null}function v(e,t,n,r,i){if("string"==typeof r&&""!==r||"number"==typeof r)return d(t,e=e.get(n)||null,""+r,i);if("object"==typeof r&&null!==r){switch(r.$$typeof){case l:return h(t,e=e.get(null===r.key?n:r.key)||null,r,i);case u:return f(t,e=e.get(null===r.key?n:r.key)||null,r,i);case b:return v(e,t,n,(0,r._init)(r._payload),i)}if(P(r)||S(r))return p(t,e=e.get(n)||null,r,i,null);nr(t,r)}return null}function y(i,a,o,l){for(var u=null,c=null,d=a,h=a=0,f=null;null!==d&&h<o.length;h++){d.index>h?(f=d,d=null):f=d.sibling;var p=g(i,d,o[h],l);if(null===p){null===d&&(d=f);break}e&&d&&null===p.alternate&&t(i,d),a=s(p,a,h),null===c?u=p:c.sibling=p,c=p,d=f}if(h===o.length)return n(i,d),$n&&Un(i,h),u;if(null===d){for(;h<o.length;h++)null!==(d=m(i,o[h],l))&&(a=s(d,a,h),null===c?u=d:c.sibling=d,c=d);return $n&&Un(i,h),u}for(d=r(i,d);h<o.length;h++)null!==(f=v(d,i,h,o[h],l))&&(e&&null!==f.alternate&&d.delete(null===f.key?h:f.key),a=s(f,a,h),null===c?u=f:c.sibling=f,c=f);return e&&d.forEach(function(e){return t(i,e)}),$n&&Un(i,h),u}function _(i,o,l,u){var c=S(l);if("function"!=typeof c)throw Error(a(150));if(null==(l=c.call(l)))throw Error(a(151));for(var d=c=null,h=o,f=o=0,p=null,y=l.next();null!==h&&!y.done;f++,y=l.next()){h.index>f?(p=h,h=null):p=h.sibling;var b=g(i,h,y.value,u);if(null===b){null===h&&(h=p);break}e&&h&&null===b.alternate&&t(i,h),o=s(b,o,f),null===d?c=b:d.sibling=b,d=b,h=p}if(y.done)return n(i,h),$n&&Un(i,f),c;if(null===h){for(;!y.done;f++,y=l.next())null!==(y=m(i,y.value,u))&&(o=s(y,o,f),null===d?c=y:d.sibling=y,d=y);return $n&&Un(i,f),c}for(h=r(i,h);!y.done;f++,y=l.next())null!==(y=v(h,i,f,y.value,u))&&(e&&null!==y.alternate&&h.delete(null===y.key?f:y.key),o=s(y,o,f),null===d?c=y:d.sibling=y,d=y);return e&&h.forEach(function(e){return t(i,e)}),$n&&Un(i,f),c}return function e(r,s,a,d){if("object"==typeof a&&null!==a&&a.type===c&&null===a.key&&(a=a.props.children),"object"==typeof a&&null!==a){switch(a.$$typeof){case l:e:{for(var h=a.key,f=s;null!==f;){if(f.key===h){if((h=a.type)===c){if(7===f.tag){n(r,f.sibling),(s=i(f,a.props.children)).return=r,r=s;break e}}else if(f.elementType===h||"object"==typeof h&&null!==h&&h.$$typeof===b&&rr(h)===f.type){n(r,f.sibling),(s=i(f,a.props)).ref=tr(r,f,a),s.return=r,r=s;break e}n(r,f);break}t(r,f),f=f.sibling}a.type===c?((s=eo(a.props.children,r.mode,d,a.key)).return=r,r=s):((d=Ja(a.type,a.key,a.props,null,r.mode,d)).ref=tr(r,s,a),d.return=r,r=d)}return o(r);case u:e:{for(f=a.key;null!==s;){if(s.key===f){if(4===s.tag&&s.stateNode.containerInfo===a.containerInfo&&s.stateNode.implementation===a.implementation){n(r,s.sibling),(s=i(s,a.children||[])).return=r,r=s;break e}n(r,s);break}t(r,s),s=s.sibling}(s=ro(a,r.mode,d)).return=r,r=s}return o(r);case b:return e(r,s,(f=a._init)(a._payload),d)}if(P(a))return y(r,s,a,d);if(S(a))return _(r,s,a,d);nr(r,a)}return"string"==typeof a&&""!==a||"number"==typeof a?(a=""+a,null!==s&&6===s.tag?(n(r,s.sibling),(s=i(s,a)).return=r,r=s):(n(r,s),(s=no(a,r.mode,d)).return=r,r=s),o(r)):n(r,s)}}var sr=ir(!0),ar=ir(!1),or={},lr=at(or),ur=at(or),cr=at(or);function dr(e){if(e===or)throw Error(a(174));return e}function hr(e,t){lt(cr,t),lt(ur,e),lt(lr,or),e=D(t),ot(lr),lt(lr,e)}function fr(){ot(lr),ot(ur),ot(cr)}function pr(e){var t=dr(cr.current),n=dr(lr.current);n!==(t=k(n,e.type,t))&&(lt(ur,e),lt(lr,t))}function mr(e){ur.current===e&&(ot(lr),ot(ur))}var gr=at(0);function vr(e){for(var t=e;null!==t;){if(13===t.tag){var n=t.memoizedState;if(null!==n&&(null===(n=n.dehydrated)||Oe(n)||Fe(n)))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(128&t.flags)return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var yr=[];function br(){for(var e=0;e<yr.length;e++){var t=yr[e];q?t._workInProgressVersionPrimary=null:t._workInProgressVersionSecondary=null}yr.length=0}var _r=o.ReactCurrentDispatcher,xr=o.ReactCurrentBatchConfig,Sr=0,Tr=null,Er=null,Ar=null,wr=!1,Mr=!1,Rr=0,Cr=0;function Ir(){throw Error(a(321))}function Lr(e,t){if(null===t)return!1;for(var n=0;n<t.length&&n<e.length;n++)if(!Wt(e[n],t[n]))return!1;return!0}function Pr(e,t,n,r,i,s){if(Sr=s,Tr=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,_r.current=null===e||null===e.memoizedState?pi:mi,e=n(r,i),Mr){s=0;do{if(Mr=!1,Rr=0,25<=s)throw Error(a(301));s+=1,Ar=Er=null,t.updateQueue=null,_r.current=gi,e=n(r,i)}while(Mr)}if(_r.current=fi,t=null!==Er&&null!==Er.next,Sr=0,Ar=Er=Tr=null,wr=!1,t)throw Error(a(300));return e}function Nr(){var e=0!==Rr;return Rr=0,e}function Dr(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===Ar?Tr.memoizedState=Ar=e:Ar=Ar.next=e,Ar}function kr(){if(null===Er){var e=Tr.alternate;e=null!==e?e.memoizedState:null}else e=Er.next;var t=null===Ar?Tr.memoizedState:Ar.next;if(null!==t)Ar=t,Er=e;else{if(null===e)throw Error(a(310));e={memoizedState:(Er=e).memoizedState,baseState:Er.baseState,baseQueue:Er.baseQueue,queue:Er.queue,next:null},null===Ar?Tr.memoizedState=Ar=e:Ar=Ar.next=e}return Ar}function Or(e,t){return"function"==typeof t?t(e):t}function Fr(e){var t=kr(),n=t.queue;if(null===n)throw Error(a(311));n.lastRenderedReducer=e;var r=Er,i=r.baseQueue,s=n.pending;if(null!==s){if(null!==i){var o=i.next;i.next=s.next,s.next=o}r.baseQueue=i=s,n.pending=null}if(null!==i){s=i.next,r=r.baseState;var l=o=null,u=null,c=s;do{var d=c.lane;if((Sr&d)===d)null!==u&&(u=u.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),r=c.hasEagerState?c.eagerState:e(r,c.action);else{var h={lane:d,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};null===u?(l=u=h,o=r):u=u.next=h,Tr.lanes|=d,ea|=d}c=c.next}while(null!==c&&c!==s);null===u?o=r:u.next=l,Wt(r,t.memoizedState)||(ki=!0),t.memoizedState=r,t.baseState=o,t.baseQueue=u,n.lastRenderedState=r}if(null!==(e=n.interleaved)){i=e;do{s=i.lane,Tr.lanes|=s,ea|=s,i=i.next}while(i!==e)}else null===i&&(n.lanes=0);return[t.memoizedState,n.dispatch]}function Ur(e){var t=kr(),n=t.queue;if(null===n)throw Error(a(311));n.lastRenderedReducer=e;var r=n.dispatch,i=n.pending,s=t.memoizedState;if(null!==i){n.pending=null;var o=i=i.next;do{s=e(s,o.action),o=o.next}while(o!==i);Wt(s,t.memoizedState)||(ki=!0),t.memoizedState=s,null===t.baseQueue&&(t.baseState=s),n.lastRenderedState=s}return[s,r]}function Br(){}function Vr(e,t){var n=Tr,r=kr(),i=t(),s=!Wt(r.memoizedState,i);if(s&&(r.memoizedState=i,ki=!0),r=r.queue,Qr(Hr.bind(null,n,r,e),[e]),r.getSnapshot!==t||s||null!==Ar&&1&Ar.memoizedState.tag){if(n.flags|=2048,jr(9,Gr.bind(null,n,r,i,t),void 0,null),null===qs)throw Error(a(349));30&Sr||zr(n,t,i)}return i}function zr(e,t,n){e.flags|=16384,e={getSnapshot:t,value:n},null===(t=Tr.updateQueue)?(t={lastEffect:null,stores:null},Tr.updateQueue=t,t.stores=[e]):null===(n=t.stores)?t.stores=[e]:n.push(e)}function Gr(e,t,n,r){t.value=n,t.getSnapshot=r,$r(t)&&xa(e,1,-1)}function Hr(e,t,n){return n(function(){$r(t)&&xa(e,1,-1)})}function $r(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!Wt(e,n)}catch(e){return!0}}function Wr(e){var t=Dr();return"function"==typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Or,lastRenderedState:e},t.queue=e,e=e.dispatch=li.bind(null,Tr,e),[t.memoizedState,e]}function jr(e,t,n,r){return e={tag:e,create:t,destroy:n,deps:r,next:null},null===(t=Tr.updateQueue)?(t={lastEffect:null,stores:null},Tr.updateQueue=t,t.lastEffect=e.next=e):null===(n=t.lastEffect)?t.lastEffect=e.next=e:(r=n.next,n.next=e,e.next=r,t.lastEffect=e),e}function qr(){return kr().memoizedState}function Xr(e,t,n,r){var i=Dr();Tr.flags|=e,i.memoizedState=jr(1|t,n,void 0,void 0===r?null:r)}function Yr(e,t,n,r){var i=kr();r=void 0===r?null:r;var s=void 0;if(null!==Er){var a=Er.memoizedState;if(s=a.destroy,null!==r&&Lr(r,a.deps))return void(i.memoizedState=jr(t,n,s,r))}Tr.flags|=e,i.memoizedState=jr(1|t,n,s,r)}function Kr(e,t){return Xr(8390656,8,e,t)}function Qr(e,t){return Yr(2048,8,e,t)}function Zr(e,t){return Yr(4,2,e,t)}function Jr(e,t){return Yr(4,4,e,t)}function ei(e,t){return"function"==typeof t?(e=e(),t(e),function(){t(null)}):null!=t?(e=e(),t.current=e,function(){t.current=null}):void 0}function ti(e,t,n){return n=null!=n?n.concat([e]):null,Yr(4,4,ei.bind(null,t,e),n)}function ni(){}function ri(e,t){var n=kr();t=void 0===t?null:t;var r=n.memoizedState;return null!==r&&null!==t&&Lr(t,r[1])?r[0]:(n.memoizedState=[e,t],e)}function ii(e,t){var n=kr();t=void 0===t?null:t;var r=n.memoizedState;return null!==r&&null!==t&&Lr(t,r[1])?r[0]:(e=e(),n.memoizedState=[e,t],e)}function si(e,t){var n=Pt;Pt=0!==n&&4>n?n:4,e(!0);var r=xr.transition;xr.transition={};try{e(!1),t()}finally{Pt=n,xr.transition=r}}function ai(){return kr().memoizedState}function oi(e,t,n){var r=_a(e);n={lane:r,action:n,hasEagerState:!1,eagerState:null,next:null},ui(e)?ci(t,n):(di(e,t,n),null!==(e=xa(e,r,n=ba()))&&hi(e,t,r))}function li(e,t,n){var r=_a(e),i={lane:r,action:n,hasEagerState:!1,eagerState:null,next:null};if(ui(e))ci(t,i);else{di(e,t,i);var s=e.alternate;if(0===e.lanes&&(null===s||0===s.lanes)&&null!==(s=t.lastRenderedReducer))try{var a=t.lastRenderedState,o=s(a,n);if(i.hasEagerState=!0,i.eagerState=o,Wt(o,a))return}catch(e){}null!==(e=xa(e,r,n=ba()))&&hi(e,t,r)}}function ui(e){var t=e.alternate;return e===Tr||null!==t&&t===Tr}function ci(e,t){Mr=wr=!0;var n=e.pending;null===n?t.next=t:(t.next=n.next,n.next=t),e.pending=t}function di(e,t,n){null!==qs&&1&e.mode&&!(2&js)?(null===(e=t.interleaved)?(n.next=n,null===hn?hn=[t]:hn.push(t)):(n.next=e.next,e.next=n),t.interleaved=n):(null===(e=t.pending)?n.next=n:(n.next=e.next,e.next=n),t.pending=n)}function hi(e,t,n){if(4194240&n){var r=t.lanes;n|=r&=e.pendingLanes,t.lanes=n,Lt(e,n)}}var fi={readContext:dn,useCallback:Ir,useContext:Ir,useEffect:Ir,useImperativeHandle:Ir,useInsertionEffect:Ir,useLayoutEffect:Ir,useMemo:Ir,useReducer:Ir,useRef:Ir,useState:Ir,useDebugValue:Ir,useDeferredValue:Ir,useTransition:Ir,useMutableSource:Ir,useSyncExternalStore:Ir,useId:Ir,unstable_isNewReconciler:!1},pi={readContext:dn,useCallback:function(e,t){return Dr().memoizedState=[e,void 0===t?null:t],e},useContext:dn,useEffect:Kr,useImperativeHandle:function(e,t,n){return n=null!=n?n.concat([e]):null,Xr(4194308,4,ei.bind(null,t,e),n)},useLayoutEffect:function(e,t){return Xr(4194308,4,e,t)},useInsertionEffect:function(e,t){return Xr(4,2,e,t)},useMemo:function(e,t){var n=Dr();return t=void 0===t?null:t,e=e(),n.memoizedState=[e,t],e},useReducer:function(e,t,n){var r=Dr();return t=void 0!==n?n(t):t,r.memoizedState=r.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},r.queue=e,e=e.dispatch=oi.bind(null,Tr,e),[r.memoizedState,e]},useRef:function(e){return e={current:e},Dr().memoizedState=e},useState:Wr,useDebugValue:ni,useDeferredValue:function(e){var t=Wr(e),n=t[0],r=t[1];return Kr(function(){var t=xr.transition;xr.transition={};try{r(e)}finally{xr.transition=t}},[e]),n},useTransition:function(){var e=Wr(!1),t=e[0];return e=si.bind(null,e[1]),Dr().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,n){var r=Tr,i=Dr();if($n){if(void 0===n)throw Error(a(407));n=n()}else{if(n=t(),null===qs)throw Error(a(349));30&Sr||zr(r,t,n)}i.memoizedState=n;var s={value:n,getSnapshot:t};return i.queue=s,Kr(Hr.bind(null,r,s,e),[e]),r.flags|=2048,jr(9,Gr.bind(null,r,s,n,t),void 0,null),n},useId:function(){var e=Dr(),t=qs.identifierPrefix;if($n){var n=Fn;t=":"+t+"R"+(n=(On&~(1<<32-_t(On)-1)).toString(32)+n),0<(n=Rr++)&&(t+="H"+n.toString(32)),t+=":"}else t=":"+t+"r"+(n=Cr++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},mi={readContext:dn,useCallback:ri,useContext:dn,useEffect:Qr,useImperativeHandle:ti,useInsertionEffect:Zr,useLayoutEffect:Jr,useMemo:ii,useReducer:Fr,useRef:qr,useState:function(){return Fr(Or)},useDebugValue:ni,useDeferredValue:function(e){var t=Fr(Or),n=t[0],r=t[1];return Qr(function(){var t=xr.transition;xr.transition={};try{r(e)}finally{xr.transition=t}},[e]),n},useTransition:function(){return[Fr(Or)[0],kr().memoizedState]},useMutableSource:Br,useSyncExternalStore:Vr,useId:ai,unstable_isNewReconciler:!1},gi={readContext:dn,useCallback:ri,useContext:dn,useEffect:Qr,useImperativeHandle:ti,useInsertionEffect:Zr,useLayoutEffect:Jr,useMemo:ii,useReducer:Ur,useRef:qr,useState:function(){return Ur(Or)},useDebugValue:ni,useDeferredValue:function(e){var t=Ur(Or),n=t[0],r=t[1];return Qr(function(){var t=xr.transition;xr.transition={};try{r(e)}finally{xr.transition=t}},[e]),n},useTransition:function(){return[Ur(Or)[0],kr().memoizedState]},useMutableSource:Br,useSyncExternalStore:Vr,useId:ai,unstable_isNewReconciler:!1};function vi(e,t){try{var n="",r=t;do{n+=Jt(r),r=r.return}while(r);var i=n}catch(e){i="\nError generating stack: "+e.message+"\n"+e.stack}return{value:e,source:t,stack:i}}var yi,bi,_i,xi,Si="function"==typeof WeakMap?WeakMap:Map;function Ti(e,t,n){(n=gn(-1,n)).tag=3,n.payload={element:null};var r=t.value;return n.callback=function(){ua||(ua=!0,ca=r)},n}function Ei(e,t,n){(n=gn(-1,n)).tag=3;var r=e.type.getDerivedStateFromError;if("function"==typeof r){var i=t.value;n.payload=function(){return r(i)},n.callback=function(){}}var s=e.stateNode;return null!==s&&"function"==typeof s.componentDidCatch&&(n.callback=function(){"function"!=typeof r&&(null===da?da=new Set([this]):da.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),n}function Ai(e,t,n){var r=e.pingCache;if(null===r){r=e.pingCache=new Si;var i=new Set;r.set(t,i)}else void 0===(i=r.get(t))&&(i=new Set,r.set(t,i));i.has(n)||(i.add(n),e=$a.bind(null,e,t,n),t.then(e,e))}function wi(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function Mi(e,t,n,r,i){return 1&e.mode?(e.flags|=65536,e.lanes=i,e):(e===t?e.flags|=65536:(e.flags|=128,n.flags|=131072,n.flags&=-52805,1===n.tag&&(null===n.alternate?n.tag=17:((t=gn(-1,1)).tag=2,vn(n,t))),n.lanes|=1),e)}function Ri(e){e.flags|=4}function Ci(e,t){if(null!==e&&e.child===t.child)return!0;if(16&t.flags)return!1;for(e=t.child;null!==e;){if(12854&e.flags||12854&e.subtreeFlags)return!1;e=e.sibling}return!0}if(X)yi=function(e,t){for(var n=t.child;null!==n;){if(5===n.tag||6===n.tag)B(e,n.stateNode);else if(4!==n.tag&&null!==n.child){n.child.return=n,n=n.child;continue}if(n===t)break;for(;null===n.sibling;){if(null===n.return||n.return===t)return;n=n.return}n.sibling.return=n.return,n=n.sibling}},bi=function(){},_i=function(e,t,n,r,i){if((e=e.memoizedProps)!==r){var s=t.stateNode,a=dr(lr.current);n=z(s,n,e,r,i,a),(t.updateQueue=n)&&Ri(t)}},xi=function(e,t,n,r){n!==r&&Ri(t)};else if(Y){yi=function(e,t,n,r){for(var i=t.child;null!==i;){if(5===i.tag){var s=i.stateNode;n&&r&&(s=Le(s,i.type,i.memoizedProps,i)),B(e,s)}else if(6===i.tag)s=i.stateNode,n&&r&&(s=Pe(s,i.memoizedProps,i)),B(e,s);else if(4!==i.tag)if(22===i.tag&&null!==i.memoizedState)null!==(s=i.child)&&(s.return=i),yi(e,i,!0,!0);else if(null!==i.child){i.child.return=i,i=i.child;continue}if(i===t)break;for(;null===i.sibling;){if(null===i.return||i.return===t)return;i=i.return}i.sibling.return=i.return,i=i.sibling}};var Ii=function(e,t,n,r){for(var i=t.child;null!==i;){if(5===i.tag){var s=i.stateNode;n&&r&&(s=Le(s,i.type,i.memoizedProps,i)),Re(e,s)}else if(6===i.tag)s=i.stateNode,n&&r&&(s=Pe(s,i.memoizedProps,i)),Re(e,s);else if(4!==i.tag)if(22===i.tag&&null!==i.memoizedState)null!==(s=i.child)&&(s.return=i),Ii(e,i,!0,!0);else if(null!==i.child){i.child.return=i,i=i.child;continue}if(i===t)break;for(;null===i.sibling;){if(null===i.return||i.return===t)return;i=i.return}i.sibling.return=i.return,i=i.sibling}};bi=function(e,t){var n=t.stateNode;if(!Ci(e,t)){e=n.containerInfo;var r=Me(e);Ii(r,t,!1,!1),n.pendingChildren=r,Ri(t),Ce(e,r)}},_i=function(e,t,n,r,i){var s=e.stateNode,a=e.memoizedProps;if((e=Ci(e,t))&&a===r)t.stateNode=s;else{var o=t.stateNode,l=dr(lr.current),u=null;a!==r&&(u=z(o,n,a,r,i,l)),e&&null===u?t.stateNode=s:(s=we(s,u,n,a,r,t,e,o),V(s,n,r,i,l)&&Ri(t),t.stateNode=s,e?Ri(t):yi(s,t,!1,!1))}},xi=function(e,t,n,r){n!==r?(e=dr(cr.current),n=dr(lr.current),t.stateNode=H(r,e,n,t),Ri(t)):t.stateNode=e.stateNode}}else bi=function(){},_i=function(){},xi=function(){};function Li(e,t){if(!$n)switch(e.tailMode){case"hidden":t=e.tail;for(var n=null;null!==t;)null!==t.alternate&&(n=t),t=t.sibling;null===n?e.tail=null:n.sibling=null;break;case"collapsed":n=e.tail;for(var r=null;null!==n;)null!==n.alternate&&(r=n),n=n.sibling;null===r?t||null===e.tail?e.tail=null:e.tail.sibling=null:r.sibling=null}}function Pi(e){var t=null!==e.alternate&&e.alternate.child===e.child,n=0,r=0;if(t)for(var i=e.child;null!==i;)n|=i.lanes|i.childLanes,r|=14680064&i.subtreeFlags,r|=14680064&i.flags,i.return=e,i=i.sibling;else for(i=e.child;null!==i;)n|=i.lanes|i.childLanes,r|=i.subtreeFlags,r|=i.flags,i.return=e,i=i.sibling;return e.subtreeFlags|=r,e.childLanes=n,t}function Ni(e,t,n){var r=t.pendingProps;switch(zn(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Pi(t),null;case 1:case 17:return pt(t.type)&&mt(),Pi(t),null;case 3:return r=t.stateNode,fr(),ot(dt),ot(ct),br(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),null!==e&&null!==e.child||(Zn(t)?Ri(t):null===e||e.memoizedState.isDehydrated&&!(256&t.flags)||(t.flags|=1024,null!==jn&&(wa(jn),jn=null))),bi(e,t),Pi(t),null;case 5:mr(t),n=dr(cr.current);var i=t.type;if(null!==e&&null!=t.stateNode)_i(e,t,i,r,n),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!r){if(null===t.stateNode)throw Error(a(166));return Pi(t),null}if(e=dr(lr.current),Zn(t)){if(!K)throw Error(a(175));e=He(t.stateNode,t.type,t.memoizedProps,n,e,t,!Wn),t.updateQueue=e,null!==e&&Ri(t)}else{var s=U(i,r,n,e,t);yi(s,t,!1,!1),t.stateNode=s,V(s,i,r,n,e)&&Ri(t)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return Pi(t),null;case 6:if(e&&null!=t.stateNode)xi(e,t,e.memoizedProps,r);else{if("string"!=typeof r&&null===t.stateNode)throw Error(a(166));if(e=dr(cr.current),n=dr(lr.current),Zn(t)){if(!K)throw Error(a(176));if(e=t.stateNode,r=t.memoizedProps,(n=$e(e,r,t,!Wn))&&null!==(i=Gn))switch(s=!!(1&i.mode),i.tag){case 3:Ze(i.stateNode.containerInfo,e,r,s);break;case 5:Je(i.type,i.memoizedProps,i.stateNode,e,r,s)}n&&Ri(t)}else t.stateNode=H(r,e,n,t)}return Pi(t),null;case 13:if(ot(gr),r=t.memoizedState,$n&&null!==Hn&&1&t.mode&&!(128&t.flags)){for(e=Hn;e;)e=Be(e);return Jn(),t.flags|=98560,t}if(null!==r&&null!==r.dehydrated){if(r=Zn(t),null===e){if(!r)throw Error(a(318));if(!K)throw Error(a(344));if(!(e=null!==(e=t.memoizedState)?e.dehydrated:null))throw Error(a(317));We(e,t)}else Jn(),!(128&t.flags)&&(t.memoizedState=null),t.flags|=4;return Pi(t),null}return null!==jn&&(wa(jn),jn=null),128&t.flags?(t.lanes=n,t):(r=null!==r,n=!1,null===e?Zn(t):n=null!==e.memoizedState,r&&!n&&(t.child.flags|=8192,1&t.mode&&(null===e||1&gr.current?0===Zs&&(Zs=3):Da())),null!==t.updateQueue&&(t.flags|=4),Pi(t),null);case 4:return fr(),bi(e,t),null===e&&Z(t.stateNode.containerInfo),Pi(t),null;case 10:return ln(t.type._context),Pi(t),null;case 19:if(ot(gr),null===(i=t.memoizedState))return Pi(t),null;if(r=!!(128&t.flags),null===(s=i.rendering))if(r)Li(i,!1);else{if(0!==Zs||null!==e&&128&e.flags)for(e=t.child;null!==e;){if(null!==(s=vr(e))){for(t.flags|=128,Li(i,!1),null!==(e=s.updateQueue)&&(t.updateQueue=e,t.flags|=4),t.subtreeFlags=0,e=n,r=t.child;null!==r;)i=e,(n=r).flags&=14680066,null===(s=n.alternate)?(n.childLanes=0,n.lanes=i,n.child=null,n.subtreeFlags=0,n.memoizedProps=null,n.memoizedState=null,n.updateQueue=null,n.dependencies=null,n.stateNode=null):(n.childLanes=s.childLanes,n.lanes=s.lanes,n.child=s.child,n.subtreeFlags=0,n.deletions=null,n.memoizedProps=s.memoizedProps,n.memoizedState=s.memoizedState,n.updateQueue=s.updateQueue,n.type=s.type,i=s.dependencies,n.dependencies=null===i?null:{lanes:i.lanes,firstContext:i.firstContext}),r=r.sibling;return lt(gr,1&gr.current|2),t.child}e=e.sibling}null!==i.tail&&Ut()>aa&&(t.flags|=128,r=!0,Li(i,!1),t.lanes=4194304)}else{if(!r)if(null!==(e=vr(s))){if(t.flags|=128,r=!0,null!==(e=e.updateQueue)&&(t.updateQueue=e,t.flags|=4),Li(i,!0),null===i.tail&&"hidden"===i.tailMode&&!s.alternate&&!$n)return Pi(t),null}else 2*Ut()-i.renderingStartTime>aa&&1073741824!==n&&(t.flags|=128,r=!0,Li(i,!1),t.lanes=4194304);i.isBackwards?(s.sibling=t.child,t.child=s):(null!==(e=i.last)?e.sibling=s:t.child=s,i.last=s)}return null!==i.tail?(t=i.tail,i.rendering=t,i.tail=t.sibling,i.renderingStartTime=Ut(),t.sibling=null,e=gr.current,lt(gr,r?1&e|2:1&e),t):(Pi(t),null);case 22:case 23:return Ia(),r=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==r&&(t.flags|=8192),r&&1&t.mode?!!(1073741824&Ks)&&(Pi(t),X&&6&t.subtreeFlags&&(t.flags|=8192)):Pi(t),null;case 24:case 25:return null}throw Error(a(156,t.tag))}var Di=o.ReactCurrentOwner,ki=!1;function Oi(e,t,n,r){t.child=null===e?ar(t,null,n,r):sr(t,e.child,n,r)}function Fi(e,t,n,r,i){n=n.render;var s=t.ref;return cn(t,i),r=Pr(e,t,n,r,s,i),n=Nr(),null===e||ki?($n&&n&&Vn(t),t.flags|=1,Oi(e,t,r,i),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~i,rs(e,t,i))}function Ui(e,t,n,r,i){if(null===e){var s=n.type;return"function"!=typeof s||Qa(s)||void 0!==s.defaultProps||null!==n.compare||void 0!==n.defaultProps?((e=Ja(n.type,null,r,t,t.mode,i)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=s,Bi(e,t,s,r,i))}if(s=e.child,0===(e.lanes&i)){var a=s.memoizedProps;if((n=null!==(n=n.compare)?n:Zt)(a,r)&&e.ref===t.ref)return rs(e,t,i)}return t.flags|=1,(e=Za(s,r)).ref=t.ref,e.return=t,t.child=e}function Bi(e,t,n,r,i){if(null!==e&&Zt(e.memoizedProps,r)&&e.ref===t.ref){if(ki=!1,0===(e.lanes&i))return t.lanes=e.lanes,rs(e,t,i);131072&e.flags&&(ki=!0)}return Gi(e,t,n,r,i)}function Vi(e,t,n){var r=t.pendingProps,i=r.children,s=null!==e?e.memoizedState:null;if("hidden"===r.mode)if(1&t.mode){if(!(1073741824&n))return e=null!==s?s.baseLanes|n:n,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null},t.updateQueue=null,lt(Qs,Ks),Ks|=e,null;t.memoizedState={baseLanes:0,cachePool:null},r=null!==s?s.baseLanes:n,lt(Qs,Ks),Ks|=r}else t.memoizedState={baseLanes:0,cachePool:null},lt(Qs,Ks),Ks|=n;else null!==s?(r=s.baseLanes|n,t.memoizedState=null):r=n,lt(Qs,Ks),Ks|=r;return Oi(e,t,i,n),t.child}function zi(e,t){var n=t.ref;(null===e&&null!==n||null!==e&&e.ref!==n)&&(t.flags|=512,t.flags|=2097152)}function Gi(e,t,n,r,i){var s=pt(n)?ht:ct.current;return s=ft(t,s),cn(t,i),n=Pr(e,t,n,r,s,i),r=Nr(),null===e||ki?($n&&r&&Vn(t),t.flags|=1,Oi(e,t,n,i),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~i,rs(e,t,i))}function Hi(e,t,n,r,i){if(pt(n)){var s=!0;yt(t)}else s=!1;if(cn(t,i),null===t.stateNode)null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),wn(t,n,r),Rn(t,n,r,i),r=!0;else if(null===e){var a=t.stateNode,o=t.memoizedProps;a.props=o;var l=a.context,u=n.contextType;"object"==typeof u&&null!==u?u=dn(u):u=ft(t,u=pt(n)?ht:ct.current);var c=n.getDerivedStateFromProps,d="function"==typeof c||"function"==typeof a.getSnapshotBeforeUpdate;d||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==r||l!==u)&&Mn(t,a,r,u),fn=!1;var h=t.memoizedState;a.state=h,_n(t,r,a,i),l=t.memoizedState,o!==r||h!==l||dt.current||fn?("function"==typeof c&&(Tn(t,n,c,r),l=t.memoizedState),(o=fn||An(t,n,o,r,h,l,u))?(d||"function"!=typeof a.UNSAFE_componentWillMount&&"function"!=typeof a.componentWillMount||("function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount()),"function"==typeof a.componentDidMount&&(t.flags|=4194308)):("function"==typeof a.componentDidMount&&(t.flags|=4194308),t.memoizedProps=r,t.memoizedState=l),a.props=r,a.state=l,a.context=u,r=o):("function"==typeof a.componentDidMount&&(t.flags|=4194308),r=!1)}else{a=t.stateNode,mn(e,t),o=t.memoizedProps,u=t.type===t.elementType?o:en(t.type,o),a.props=u,d=t.pendingProps,h=a.context,"object"==typeof(l=n.contextType)&&null!==l?l=dn(l):l=ft(t,l=pt(n)?ht:ct.current);var f=n.getDerivedStateFromProps;(c="function"==typeof f||"function"==typeof a.getSnapshotBeforeUpdate)||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==d||h!==l)&&Mn(t,a,r,l),fn=!1,h=t.memoizedState,a.state=h,_n(t,r,a,i);var p=t.memoizedState;o!==d||h!==p||dt.current||fn?("function"==typeof f&&(Tn(t,n,f,r),p=t.memoizedState),(u=fn||An(t,n,u,r,h,p,l)||!1)?(c||"function"!=typeof a.UNSAFE_componentWillUpdate&&"function"!=typeof a.componentWillUpdate||("function"==typeof a.componentWillUpdate&&a.componentWillUpdate(r,p,l),"function"==typeof a.UNSAFE_componentWillUpdate&&a.UNSAFE_componentWillUpdate(r,p,l)),"function"==typeof a.componentDidUpdate&&(t.flags|=4),"function"==typeof a.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!=typeof a.componentDidUpdate||o===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),t.memoizedProps=r,t.memoizedState=p),a.props=r,a.state=p,a.context=l,r=u):("function"!=typeof a.componentDidUpdate||o===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),r=!1)}return $i(e,t,n,r,s,i)}function $i(e,t,n,r,i,s){zi(e,t);var a=!!(128&t.flags);if(!r&&!a)return i&&bt(t,n,!1),rs(e,t,s);r=t.stateNode,Di.current=t;var o=a&&"function"!=typeof n.getDerivedStateFromError?null:r.render();return t.flags|=1,null!==e&&a?(t.child=sr(t,e.child,null,s),t.child=sr(t,null,o,s)):Oi(e,t,o,s),t.memoizedState=r.state,i&&bt(t,n,!0),t.child}function Wi(e){var t=e.stateNode;t.pendingContext?gt(0,t.pendingContext,t.pendingContext!==t.context):t.context&&gt(0,t.context,!1),hr(e,t.containerInfo)}function ji(e,t,n,r,i){return Jn(),er(i),t.flags|=256,Oi(e,t,n,r),t.child}var qi={dehydrated:null,treeContext:null,retryLane:0};function Xi(e){return{baseLanes:e,cachePool:null}}function Yi(e,t,n){var r,i=t.pendingProps,s=gr.current,o=!1,l=!!(128&t.flags);if((r=l)||(r=(null===e||null!==e.memoizedState)&&!!(2&s)),r?(o=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(s|=1),lt(gr,1&s),null===e)return Kn(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(1&t.mode?Fe(e)?t.lanes=8:t.lanes=1073741824:t.lanes=1,null):(s=i.children,e=i.fallback,o?(i=t.mode,o=t.child,s={mode:"hidden",children:s},1&i||null===o?o=to(s,i,0,null):(o.childLanes=0,o.pendingProps=s),e=eo(e,i,n,null),o.return=t,e.return=t,o.sibling=e,t.child=o,t.child.memoizedState=Xi(n),t.memoizedState=qi,e):Ki(t,s));if(null!==(s=e.memoizedState)){if(null!==(r=s.dehydrated)){if(l)return 256&t.flags?(t.flags&=-257,Ji(e,t,n,Error(a(422)))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(o=i.fallback,s=t.mode,i=to({mode:"visible",children:i.children},s,0,null),(o=eo(o,s,n,null)).flags|=2,i.return=t,o.return=t,i.sibling=o,t.child=i,1&t.mode&&sr(t,e.child,null,n),t.child.memoizedState=Xi(n),t.memoizedState=qi,o);if(1&t.mode)if(Fe(r))t=Ji(e,t,n,Error(a(419)));else if(i=0!==(n&e.childLanes),ki||i){if(null!==(i=qs)){switch(n&-n){case 4:o=2;break;case 16:o=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:o=32;break;case 536870912:o=268435456;break;default:o=0}0!==(i=0!==(o&(i.suspendedLanes|n))?0:o)&&i!==s.retryLane&&(s.retryLane=i,xa(e,i,-1))}Da(),t=Ji(e,t,n,Error(a(421)))}else Oe(r)?(t.flags|=128,t.child=e.child,t=ja.bind(null,e),Ue(r,t),t=null):(n=s.treeContext,K&&(Hn=Ge(r),Gn=t,$n=!0,jn=null,Wn=!1,null!==n&&(Nn[Dn++]=On,Nn[Dn++]=Fn,Nn[Dn++]=kn,On=n.id,Fn=n.overflow,kn=t)),(t=Ki(t,t.pendingProps.children)).flags|=4096);else t=Ji(e,t,n,null);return t}return o?(i=Zi(e,t,i.children,i.fallback,n),o=t.child,s=e.child.memoizedState,o.memoizedState=null===s?Xi(n):{baseLanes:s.baseLanes|n,cachePool:null},o.childLanes=e.childLanes&~n,t.memoizedState=qi,i):(n=Qi(e,t,i.children,n),t.memoizedState=null,n)}return o?(i=Zi(e,t,i.children,i.fallback,n),o=t.child,s=e.child.memoizedState,o.memoizedState=null===s?Xi(n):{baseLanes:s.baseLanes|n,cachePool:null},o.childLanes=e.childLanes&~n,t.memoizedState=qi,i):(n=Qi(e,t,i.children,n),t.memoizedState=null,n)}function Ki(e,t){return(t=to({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function Qi(e,t,n,r){var i=e.child;return e=i.sibling,n=Za(i,{mode:"visible",children:n}),!(1&t.mode)&&(n.lanes=r),n.return=t,n.sibling=null,null!==e&&(null===(r=t.deletions)?(t.deletions=[e],t.flags|=16):r.push(e)),t.child=n}function Zi(e,t,n,r,i){var s=t.mode,a=(e=e.child).sibling,o={mode:"hidden",children:n};return 1&s||t.child===e?(n=Za(e,o)).subtreeFlags=14680064&e.subtreeFlags:((n=t.child).childLanes=0,n.pendingProps=o,t.deletions=null),null!==a?r=Za(a,r):(r=eo(r,s,i,null)).flags|=2,r.return=t,n.return=t,n.sibling=r,t.child=n,r}function Ji(e,t,n,r){return null!==r&&er(r),sr(t,e.child,null,n),(e=Ki(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function es(e,t,n){e.lanes|=t;var r=e.alternate;null!==r&&(r.lanes|=t),un(e.return,t,n)}function ts(e,t,n,r,i){var s=e.memoizedState;null===s?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:r,tail:n,tailMode:i}:(s.isBackwards=t,s.rendering=null,s.renderingStartTime=0,s.last=r,s.tail=n,s.tailMode=i)}function ns(e,t,n){var r=t.pendingProps,i=r.revealOrder,s=r.tail;if(Oi(e,t,r.children,n),2&(r=gr.current))r=1&r|2,t.flags|=128;else{if(null!==e&&128&e.flags)e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&es(e,n,t);else if(19===e.tag)es(e,n,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}r&=1}if(lt(gr,r),1&t.mode)switch(i){case"forwards":for(n=t.child,i=null;null!==n;)null!==(e=n.alternate)&&null===vr(e)&&(i=n),n=n.sibling;null===(n=i)?(i=t.child,t.child=null):(i=n.sibling,n.sibling=null),ts(t,!1,i,n,s);break;case"backwards":for(n=null,i=t.child,t.child=null;null!==i;){if(null!==(e=i.alternate)&&null===vr(e)){t.child=i;break}e=i.sibling,i.sibling=n,n=i,i=e}ts(t,!0,n,null,s);break;case"together":ts(t,!1,null,null,void 0);break;default:t.memoizedState=null}else t.memoizedState=null;return t.child}function rs(e,t,n){if(null!==e&&(t.dependencies=e.dependencies),ea|=t.lanes,0===(n&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(a(153));if(null!==t.child){for(n=Za(e=t.child,e.pendingProps),t.child=n,n.return=t;null!==e.sibling;)e=e.sibling,(n=n.sibling=Za(e,e.pendingProps)).return=t;n.sibling=null}return t.child}function is(e,t){switch(zn(t),t.tag){case 1:return pt(t.type)&&mt(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return fr(),ot(dt),ot(ct),br(),65536&(e=t.flags)&&!(128&e)?(t.flags=-65537&e|128,t):null;case 5:return mr(t),null;case 13:if(ot(gr),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(a(340));Jn()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return ot(gr),null;case 4:return fr(),null;case 10:return ln(t.type._context),null;case 22:case 23:return Ia(),null;default:return null}}var ss=!1,as=!1,os="function"==typeof WeakSet?WeakSet:Set,ls=null;function us(e,t){var n=e.ref;if(null!==n)if("function"==typeof n)try{n(null)}catch(n){Ha(e,t,n)}else n.current=null}function cs(e,t,n){try{n()}catch(n){Ha(e,t,n)}}var ds=!1;function hs(e,t,n){var r=t.updateQueue;if(null!==(r=null!==r?r.lastEffect:null)){var i=r=r.next;do{if((i.tag&e)===e){var s=i.destroy;i.destroy=void 0,void 0!==s&&cs(t,n,s)}i=i.next}while(i!==r)}}function fs(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var n=t=t.next;do{if((n.tag&e)===e){var r=n.create;n.destroy=r()}n=n.next}while(n!==t)}}function ps(e){var t=e.ref;if(null!==t){var n=e.stateNode;if(5===e.tag)e=N(n);else e=n;"function"==typeof t?t(e):t.current=e}}function ms(e,t,n){if($t&&"function"==typeof $t.onCommitFiberUnmount)try{$t.onCommitFiberUnmount(Ht,t)}catch(e){}switch(t.tag){case 0:case 11:case 14:case 15:if(null!==(e=t.updateQueue)&&null!==(e=e.lastEffect)){var r=e=e.next;do{var i=r,s=i.destroy;i=i.tag,void 0!==s&&(2&i||4&i)&&cs(t,n,s),r=r.next}while(r!==e)}break;case 1:if(us(t,n),"function"==typeof(e=t.stateNode).componentWillUnmount)try{e.props=t.memoizedProps,e.state=t.memoizedState,e.componentWillUnmount()}catch(e){Ha(t,n,e)}break;case 5:us(t,n);break;case 4:X?Ts(e,t,n):Y&&Y&&(t=t.stateNode.containerInfo,n=Me(t),Ie(t,n))}}function gs(e,t,n){for(var r=t;;)if(ms(e,r,n),null===r.child||X&&4===r.tag){if(r===t)break;for(;null===r.sibling;){if(null===r.return||r.return===t)return;r=r.return}r.sibling.return=r.return,r=r.sibling}else r.child.return=r,r=r.child}function vs(e){var t=e.alternate;null!==t&&(e.alternate=null,vs(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&(null!==(t=e.stateNode)&&ee(t)),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function ys(e){return 5===e.tag||3===e.tag||4===e.tag}function bs(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||ys(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function _s(e){if(X){e:{for(var t=e.return;null!==t;){if(ys(t))break e;t=t.return}throw Error(a(160))}var n=t;switch(n.tag){case 5:t=n.stateNode,32&n.flags&&(_e(t),n.flags&=-33),Ss(e,n=bs(e),t);break;case 3:case 4:t=n.stateNode.containerInfo,xs(e,n=bs(e),t);break;default:throw Error(a(161))}}}function xs(e,t,n){var r=e.tag;if(5===r||6===r)e=e.stateNode,t?ve(n,e,t):he(n,e);else if(4!==r&&null!==(e=e.child))for(xs(e,t,n),e=e.sibling;null!==e;)xs(e,t,n),e=e.sibling}function Ss(e,t,n){var r=e.tag;if(5===r||6===r)e=e.stateNode,t?ge(n,e,t):de(n,e);else if(4!==r&&null!==(e=e.child))for(Ss(e,t,n),e=e.sibling;null!==e;)Ss(e,t,n),e=e.sibling}function Ts(e,t,n){for(var r,i,s=t,o=!1;;){if(!o){o=s.return;e:for(;;){if(null===o)throw Error(a(160));switch(r=o.stateNode,o.tag){case 5:i=!1;break e;case 3:case 4:r=r.containerInfo,i=!0;break e}o=o.return}o=!0}if(5===s.tag||6===s.tag)gs(e,s,n),i?be(r,s.stateNode):ye(r,s.stateNode);else if(18===s.tag)i?Ke(r,s.stateNode):Ye(r,s.stateNode);else if(4===s.tag){if(null!==s.child){r=s.stateNode.containerInfo,i=!0,s.child.return=s,s=s.child;continue}}else if(ms(e,s,n),null!==s.child){s.child.return=s,s=s.child;continue}if(s===t)break;for(;null===s.sibling;){if(null===s.return||s.return===t)return;4===(s=s.return).tag&&(o=!1)}s.sibling.return=s.return,s=s.sibling}}function Es(e,t){if(X){switch(t.tag){case 0:case 11:case 14:case 15:return hs(3,t,t.return),fs(3,t),void hs(5,t,t.return);case 1:case 12:case 17:return;case 5:var n=t.stateNode;if(null!=n){var r=t.memoizedProps;e=null!==e?e.memoizedProps:r;var i=t.type,s=t.updateQueue;t.updateQueue=null,null!==s&&me(n,s,i,e,r,t)}return;case 6:if(null===t.stateNode)throw Error(a(162));return n=t.memoizedProps,void fe(t.stateNode,null!==e?e.memoizedProps:n,n);case 3:return void(K&&null!==e&&e.memoizedState.isDehydrated&&qe(t.stateNode.containerInfo));case 13:case 19:return void As(t)}throw Error(a(163))}switch(t.tag){case 0:case 11:case 14:case 15:return hs(3,t,t.return),fs(3,t),void hs(5,t,t.return);case 12:case 22:case 23:return;case 13:case 19:return void As(t);case 3:K&&null!==e&&e.memoizedState.isDehydrated&&qe(t.stateNode.containerInfo)}e:if(Y){switch(t.tag){case 1:case 5:case 6:break e;case 3:case 4:t=t.stateNode,Ie(t.containerInfo,t.pendingChildren);break e}throw Error(a(163))}}function As(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var n=e.stateNode;null===n&&(n=e.stateNode=new os),t.forEach(function(t){var r=qa.bind(null,e,t);n.has(t)||(n.add(t),t.then(r,r))})}}function ws(e,t,n){ls=e,Ms(e)}function Ms(e,t,n){for(var r=!!(1&e.mode);null!==ls;){var i=ls,s=i.child;if(22===i.tag&&r){var a=null!==i.memoizedState||ss;if(!a){var o=i.alternate,l=null!==o&&null!==o.memoizedState||as;o=ss;var u=as;if(ss=a,(as=l)&&!u)for(ls=i;null!==ls;)l=(a=ls).child,22===a.tag&&null!==a.memoizedState?Is(i):null!==l?(l.return=a,ls=l):Is(i);for(;null!==s;)ls=s,Ms(s),s=s.sibling;ls=i,ss=o,as=u}Rs(e)}else 8772&i.subtreeFlags&&null!==s?(s.return=i,ls=s):Rs(e)}}function Rs(e){for(;null!==ls;){var t=ls;if(8772&t.flags){var n=t.alternate;try{if(8772&t.flags)switch(t.tag){case 0:case 11:case 15:as||fs(5,t);break;case 1:var r=t.stateNode;if(4&t.flags&&!as)if(null===n)r.componentDidMount();else{var i=t.elementType===t.type?n.memoizedProps:en(t.type,n.memoizedProps);r.componentDidUpdate(i,n.memoizedState,r.__reactInternalSnapshotBeforeUpdate)}var s=t.updateQueue;null!==s&&xn(t,s,r);break;case 3:var o=t.updateQueue;if(null!==o){if(n=null,null!==t.child)switch(t.child.tag){case 5:n=N(t.child.stateNode);break;case 1:n=t.child.stateNode}xn(t,o,n)}break;case 5:var l=t.stateNode;null===n&&4&t.flags&&pe(l,t.type,t.memoizedProps,t);break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:break;case 13:if(K&&null===t.memoizedState){var u=t.alternate;if(null!==u){var c=u.memoizedState;if(null!==c){var d=c.dehydrated;null!==d&&Xe(d)}}}break;default:throw Error(a(163))}as||512&t.flags&&ps(t)}catch(e){Ha(t,t.return,e)}}if(t===e){ls=null;break}if(null!==(n=t.sibling)){n.return=t.return,ls=n;break}ls=t.return}}function Cs(e){for(;null!==ls;){var t=ls;if(t===e){ls=null;break}var n=t.sibling;if(null!==n){n.return=t.return,ls=n;break}ls=t.return}}function Is(e){for(;null!==ls;){var t=ls;try{switch(t.tag){case 0:case 11:case 15:var n=t.return;try{fs(4,t)}catch(e){Ha(t,n,e)}break;case 1:var r=t.stateNode;if("function"==typeof r.componentDidMount){var i=t.return;try{r.componentDidMount()}catch(e){Ha(t,i,e)}}var s=t.return;try{ps(t)}catch(e){Ha(t,s,e)}break;case 5:var a=t.return;try{ps(t)}catch(e){Ha(t,a,e)}}}catch(e){Ha(t,t.return,e)}if(t===e){ls=null;break}var o=t.sibling;if(null!==o){o.return=t.return,ls=o;break}ls=t.return}}var Ls=0,Ps=1,Ns=2,Ds=3,ks=4;if("function"==typeof Symbol&&Symbol.for){var Os=Symbol.for;Ls=Os("selector.component"),Ps=Os("selector.has_pseudo_class"),Ns=Os("selector.role"),Ds=Os("selector.test_id"),ks=Os("selector.text")}function Fs(e){var t=Q(e);if(null!=t){if("string"!=typeof t.memoizedProps["data-testname"])throw Error(a(364));return t}if(null===(e=ie(e)))throw Error(a(362));return e.stateNode.current}function Us(e,t){switch(t.$$typeof){case Ls:if(e.type===t.value)return!0;break;case Ps:e:{t=t.value,e=[e,0];for(var n=0;n<e.length;){var r=e[n++],i=e[n++],s=t[i];if(5!==r.tag||!oe(r)){for(;null!=s&&Us(r,s);)s=t[++i];if(i===t.length){t=!0;break e}for(r=r.child;null!==r;)e.push(r,i),r=r.sibling}}t=!1}return t;case Ns:if(5===e.tag&&le(e.stateNode,t.value))return!0;break;case ks:if((5===e.tag||6===e.tag)&&(null!==(e=ae(e))&&0<=e.indexOf(t.value)))return!0;break;case Ds:if(5===e.tag&&("string"==typeof(e=e.memoizedProps["data-testname"])&&e.toLowerCase()===t.value.toLowerCase()))return!0;break;default:throw Error(a(365))}return!1}function Bs(e){switch(e.$$typeof){case Ls:return"<"+(T(e.value)||"Unknown")+">";case Ps:return":has("+(Bs(e)||"")+")";case Ns:return'[role="'+e.value+'"]';case ks:return'"'+e.value+'"';case Ds:return'[data-testname="'+e.value+'"]';default:throw Error(a(365))}}function Vs(e,t){var n=[];e=[e,0];for(var r=0;r<e.length;){var i=e[r++],s=e[r++],a=t[s];if(5!==i.tag||!oe(i)){for(;null!=a&&Us(i,a);)a=t[++s];if(s===t.length)n.push(i);else for(i=i.child;null!==i;)e.push(i,s),i=i.sibling}}return n}function zs(e,t){if(!re)throw Error(a(363));e=Vs(e=Fs(e),t),t=[],e=Array.from(e);for(var n=0;n<e.length;){var r=e[n++];if(5===r.tag)oe(r)||t.push(r.stateNode);else for(r=r.child;null!==r;)e.push(r),r=r.sibling}return t}var Gs=Math.ceil,Hs=o.ReactCurrentDispatcher,$s=o.ReactCurrentOwner,Ws=o.ReactCurrentBatchConfig,js=0,qs=null,Xs=null,Ys=0,Ks=0,Qs=at(0),Zs=0,Js=null,ea=0,ta=0,na=0,ra=null,ia=null,sa=0,aa=1/0;function oa(){aa=Ut()+500}var la,ua=!1,ca=null,da=null,ha=!1,fa=null,pa=0,ma=0,ga=null,va=-1,ya=0;function ba(){return 6&js?Ut():-1!==va?va:va=Ut()}function _a(e){return 1&e.mode?2&js&&0!==Ys?Ys&-Ys:null!==Qt.transition?(0===ya&&(e=Tt,!(4194240&(Tt<<=1))&&(Tt=64),ya=e),ya):0!==(e=Pt)?e:J():1}function xa(e,t,n){if(50<ma)throw ma=0,ga=null,Error(a(185));var r=Sa(e,t);return null===r?null:(It(r,t,n),2&js&&r===qs||(r===qs&&(!(2&js)&&(ta|=t),4===Zs&&Ma(r,Ys)),Ta(r,n),1===t&&0===js&&!(1&e.mode)&&(oa(),qt&&Kt())),r)}function Sa(e,t){e.lanes|=t;var n=e.alternate;for(null!==n&&(n.lanes|=t),n=e,e=e.return;null!==e;)e.childLanes|=t,null!==(n=e.alternate)&&(n.childLanes|=t),n=e,e=e.return;return 3===n.tag?n.stateNode:null}function Ta(e,t){var n=e.callbackNode;!function(e,t){for(var n=e.suspendedLanes,r=e.pingedLanes,i=e.expirationTimes,s=e.pendingLanes;0<s;){var a=31-_t(s),o=1<<a,l=i[a];-1===l?0!==(o&n)&&0===(o&r)||(i[a]=Mt(o,t)):l<=t&&(e.expiredLanes|=o),s&=~o}}(e,t);var r=wt(e,e===qs?Ys:0);if(0===r)null!==n&&kt(n),e.callbackNode=null,e.callbackPriority=0;else if(t=r&-r,e.callbackPriority!==t){if(null!=n&&kt(n),1===t)0===e.tag?function(e){qt=!0,Yt(e)}(Ra.bind(null,e)):Yt(Ra.bind(null,e)),te?ne(function(){0===js&&Kt()}):Dt(Bt,Kt),n=null;else{switch(Nt(r)){case 1:n=Bt;break;case 4:n=Vt;break;case 16:default:n=zt;break;case 536870912:n=Gt}n=Xa(n,Ea.bind(null,e))}e.callbackPriority=t,e.callbackNode=n}}function Ea(e,t){if(va=-1,ya=0,6&js)throw Error(a(327));var n=e.callbackNode;if(za()&&e.callbackNode!==n)return null;var r=wt(e,e===qs?Ys:0);if(0===r)return null;if(30&r||0!==(r&e.expiredLanes)||t)t=ka(e,r);else{t=r;var i=js;js|=2;var s=Na();for(qs===e&&Ys===t||(oa(),La(e,t));;)try{Fa();break}catch(t){Pa(e,t)}an(),Hs.current=s,js=i,null!==Xs?t=0:(qs=null,Ys=0,t=Zs)}if(0!==t){if(2===t&&(0!==(i=Rt(e))&&(r=i,t=Aa(e,i))),1===t)throw n=Js,La(e,0),Ma(e,r),Ta(e,Ut()),n;if(6===t)Ma(e,r);else{if(i=e.current.alternate,!(30&r||function(e){for(var t=e;;){if(16384&t.flags){var n=t.updateQueue;if(null!==n&&null!==(n=n.stores))for(var r=0;r<n.length;r++){var i=n[r],s=i.getSnapshot;i=i.value;try{if(!Wt(s(),i))return!1}catch(e){return!1}}}if(n=t.child,16384&t.subtreeFlags&&null!==n)n.return=t,t=n;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(i)||(t=ka(e,r),2===t&&(s=Rt(e),0!==s&&(r=s,t=Aa(e,s))),1!==t)))throw n=Js,La(e,0),Ma(e,r),Ta(e,Ut()),n;switch(e.finishedWork=i,e.finishedLanes=r,t){case 0:case 1:throw Error(a(345));case 2:case 5:Va(e,ia);break;case 3:if(Ma(e,r),(130023424&r)===r&&10<(t=sa+500-Ut())){if(0!==wt(e,0))break;if(((i=e.suspendedLanes)&r)!==r){ba(),e.pingedLanes|=e.suspendedLanes&i;break}e.timeoutHandle=$(Va.bind(null,e,ia),t);break}Va(e,ia);break;case 4:if(Ma(e,r),(4194240&r)===r)break;for(t=e.eventTimes,i=-1;0<r;){var o=31-_t(r);s=1<<o,(o=t[o])>i&&(i=o),r&=~s}if(r=i,10<(r=(120>(r=Ut()-r)?120:480>r?480:1080>r?1080:1920>r?1920:3e3>r?3e3:4320>r?4320:1960*Gs(r/1960))-r)){e.timeoutHandle=$(Va.bind(null,e,ia),r);break}Va(e,ia);break;default:throw Error(a(329))}}}return Ta(e,Ut()),e.callbackNode===n?Ea.bind(null,e):null}function Aa(e,t){var n=ra;return e.current.memoizedState.isDehydrated&&(La(e,t).flags|=256),2!==(e=ka(e,t))&&(t=ia,ia=n,null!==t&&wa(t)),e}function wa(e){null===ia?ia=e:ia.push.apply(ia,e)}function Ma(e,t){for(t&=~na,t&=~ta,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var n=31-_t(t),r=1<<n;e[n]=-1,t&=~r}}function Ra(e){if(6&js)throw Error(a(327));za();var t=wt(e,0);if(!(1&t))return Ta(e,Ut()),null;var n=ka(e,t);if(0!==e.tag&&2===n){var r=Rt(e);0!==r&&(t=r,n=Aa(e,r))}if(1===n)throw n=Js,La(e,0),Ma(e,t),Ta(e,Ut()),n;if(6===n)throw Error(a(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,Va(e,ia),Ta(e,Ut()),null}function Ca(e){null!==fa&&0===fa.tag&&!(6&js)&&za();var t=js;js|=1;var n=Ws.transition,r=Pt;try{if(Ws.transition=null,Pt=1,e)return e()}finally{Pt=r,Ws.transition=n,!(6&(js=t))&&Kt()}}function Ia(){Ks=Qs.current,ot(Qs)}function La(e,t){e.finishedWork=null,e.finishedLanes=0;var n=e.timeoutHandle;if(n!==j&&(e.timeoutHandle=j,W(n)),null!==Xs)for(n=Xs.return;null!==n;){var r=n;switch(zn(r),r.tag){case 1:null!=(r=r.type.childContextTypes)&&mt();break;case 3:fr(),ot(dt),ot(ct),br();break;case 5:mr(r);break;case 4:fr();break;case 13:case 19:ot(gr);break;case 10:ln(r.type._context);break;case 22:case 23:Ia()}n=n.return}if(qs=e,Xs=e=Za(e.current,null),Ys=Ks=t,Zs=0,Js=null,na=ta=ea=0,ia=ra=null,null!==hn){for(t=0;t<hn.length;t++)if(null!==(r=(n=hn[t]).interleaved)){n.interleaved=null;var i=r.next,s=n.pending;if(null!==s){var a=s.next;s.next=i,r.next=a}n.pending=r}hn=null}return e}function Pa(e,t){for(;;){var n=Xs;try{if(an(),_r.current=fi,wr){for(var r=Tr.memoizedState;null!==r;){var i=r.queue;null!==i&&(i.pending=null),r=r.next}wr=!1}if(Sr=0,Ar=Er=Tr=null,Mr=!1,Rr=0,$s.current=null,null===n||null===n.return){Zs=1,Js=t,Xs=null;break}e:{var s=e,o=n.return,l=n,u=t;if(t=Ys,l.flags|=32768,null!==u&&"object"==typeof u&&"function"==typeof u.then){var c=u,d=l,h=d.tag;if(!(1&d.mode||0!==h&&11!==h&&15!==h)){var f=d.alternate;f?(d.updateQueue=f.updateQueue,d.memoizedState=f.memoizedState,d.lanes=f.lanes):(d.updateQueue=null,d.memoizedState=null)}var p=wi(o);if(null!==p){p.flags&=-257,Mi(p,o,l,0,t),1&p.mode&&Ai(s,c,t),u=c;var m=(t=p).updateQueue;if(null===m){var g=new Set;g.add(u),t.updateQueue=g}else m.add(u);break e}if(!(1&t)){Ai(s,c,t),Da();break e}u=Error(a(426))}else if($n&&1&l.mode){var v=wi(o);if(null!==v){!(65536&v.flags)&&(v.flags|=256),Mi(v,o,l,0,t),er(u);break e}}s=u,4!==Zs&&(Zs=2),null===ra?ra=[s]:ra.push(s),u=vi(u,l),l=o;do{switch(l.tag){case 3:l.flags|=65536,t&=-t,l.lanes|=t,bn(l,Ti(0,u,t));break e;case 1:s=u;var y=l.type,b=l.stateNode;if(!(128&l.flags||"function"!=typeof y.getDerivedStateFromError&&(null===b||"function"!=typeof b.componentDidCatch||null!==da&&da.has(b)))){l.flags|=65536,t&=-t,l.lanes|=t,bn(l,Ei(l,s,t));break e}}l=l.return}while(null!==l)}Ba(n)}catch(e){t=e,Xs===n&&null!==n&&(Xs=n=n.return);continue}break}}function Na(){var e=Hs.current;return Hs.current=fi,null===e?fi:e}function Da(){0!==Zs&&3!==Zs&&2!==Zs||(Zs=4),null===qs||!(268435455&ea)&&!(268435455&ta)||Ma(qs,Ys)}function ka(e,t){var n=js;js|=2;var r=Na();for(qs===e&&Ys===t||La(e,t);;)try{Oa();break}catch(t){Pa(e,t)}if(an(),js=n,Hs.current=r,null!==Xs)throw Error(a(261));return qs=null,Ys=0,Zs}function Oa(){for(;null!==Xs;)Ua(Xs)}function Fa(){for(;null!==Xs&&!Ot();)Ua(Xs)}function Ua(e){var t=la(e.alternate,e,Ks);e.memoizedProps=e.pendingProps,null===t?Ba(e):Xs=t,$s.current=null}function Ba(e){var t=e;do{var n=t.alternate;if(e=t.return,32768&t.flags){if(null!==(n=is(n,t)))return n.flags&=32767,void(Xs=n);if(null===e)return Zs=6,void(Xs=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}else if(null!==(n=Ni(n,t,Ks)))return void(Xs=n);if(null!==(t=t.sibling))return void(Xs=t);Xs=t=e}while(null!==t);0===Zs&&(Zs=5)}function Va(e,t){var n=Pt,r=Ws.transition;try{Ws.transition=null,Pt=1,function(e,t,n){do{za()}while(null!==fa);if(6&js)throw Error(a(327));var r=e.finishedWork,i=e.finishedLanes;if(null===r)return null;if(e.finishedWork=null,e.finishedLanes=0,r===e.current)throw Error(a(177));e.callbackNode=null,e.callbackPriority=0;var s=r.lanes|r.childLanes;if(function(e,t){var n=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var r=e.eventTimes;for(e=e.expirationTimes;0<n;){var i=31-_t(n),s=1<<i;t[i]=0,r[i]=-1,e[i]=-1,n&=~s}}(e,s),e===qs&&(Xs=qs=null,Ys=0),!(2064&r.subtreeFlags)&&!(2064&r.flags)||ha||(ha=!0,Xa(zt,function(){return za(),null})),s=!!(15990&r.flags),!!(15990&r.subtreeFlags)||s){s=Ws.transition,Ws.transition=null;var o=Pt;Pt=1;var l=js;js|=4,$s.current=null,function(e,t){for(O(e.containerInfo),ls=t;null!==ls;)if(t=(e=ls).child,1028&e.subtreeFlags&&null!==t)t.return=e,ls=t;else for(;null!==ls;){e=ls;try{var n=e.alternate;if(1024&e.flags)switch(e.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==n){var r=n.memoizedProps,i=n.memoizedState,s=e.stateNode,o=s.getSnapshotBeforeUpdate(e.elementType===e.type?r:en(e.type,r),i);s.__reactInternalSnapshotBeforeUpdate=o}break;case 3:X&&Ae(e.stateNode.containerInfo);break;default:throw Error(a(163))}}catch(t){Ha(e,e.return,t)}if(null!==(t=e.sibling)){t.return=e.return,ls=t;break}ls=e.return}n=ds,ds=!1}(e,r),function(e,t){for(ls=t;null!==ls;){var n=(t=ls).deletions;if(null!==n)for(var r=0;r<n.length;r++){var i=n[r];try{var s=e;X?Ts(s,i,t):gs(s,i,t);var a=i.alternate;null!==a&&(a.return=null),i.return=null}catch(e){Ha(i,t,e)}}if(n=t.child,12854&t.subtreeFlags&&null!==n)n.return=t,ls=n;else for(;null!==ls;){t=ls;try{var o=t.flags;if(32&o&&X&&_e(t.stateNode),512&o){var l=t.alternate;if(null!==l){var u=l.ref;null!==u&&("function"==typeof u?u(null):u.current=null)}}if(8192&o)switch(t.tag){case 13:if(null!==t.memoizedState){var c=t.alternate;null!==c&&null!==c.memoizedState||(sa=Ut())}break;case 22:var d=null!==t.memoizedState,h=t.alternate,f=null!==h&&null!==h.memoizedState;if(n=t,X)e:if(r=n,i=d,s=null,X)for(var p=r;;){if(5===p.tag){if(null===s){s=p;var m=p.stateNode;i?xe(m):Te(p.stateNode,p.memoizedProps)}}else if(6===p.tag){if(null===s){var g=p.stateNode;i?Se(g):Ee(g,p.memoizedProps)}}else if((22!==p.tag&&23!==p.tag||null===p.memoizedState||p===r)&&null!==p.child){p.child.return=p,p=p.child;continue}if(p===r)break;for(;null===p.sibling;){if(null===p.return||p.return===r)break e;s===p&&(s=null),p=p.return}s===p&&(s=null),p.sibling.return=p.return,p=p.sibling}if(d&&!f&&1&n.mode){ls=n;for(var v=n.child;null!==v;){for(n=ls=v;null!==ls;){var y=(r=ls).child;switch(r.tag){case 0:case 11:case 14:case 15:hs(4,r,r.return);break;case 1:us(r,r.return);var b=r.stateNode;if("function"==typeof b.componentWillUnmount){var _=r.return;try{b.props=r.memoizedProps,b.state=r.memoizedState,b.componentWillUnmount()}catch(e){Ha(r,_,e)}}break;case 5:us(r,r.return);break;case 22:if(null!==r.memoizedState){Cs(n);continue}}null!==y?(y.return=r,ls=y):Cs(n)}v=v.sibling}}}switch(4102&o){case 2:_s(t),t.flags&=-3;break;case 6:_s(t),t.flags&=-3,Es(t.alternate,t);break;case 4096:t.flags&=-4097;break;case 4100:t.flags&=-4097,Es(t.alternate,t);break;case 4:Es(t.alternate,t)}}catch(e){Ha(t,t.return,e)}if(null!==(n=t.sibling)){n.return=t.return,ls=n;break}ls=t.return}}}(e,r),F(e.containerInfo),e.current=r,ws(r),Ft(),js=l,Pt=o,Ws.transition=s}else e.current=r;if(ha&&(ha=!1,fa=e,pa=i),s=e.pendingLanes,0===s&&(da=null),function(e){if($t&&"function"==typeof $t.onCommitFiberRoot)try{$t.onCommitFiberRoot(Ht,e,void 0,!(128&~e.current.flags))}catch(e){}}(r.stateNode),Ta(e,Ut()),null!==t)for(n=e.onRecoverableError,r=0;r<t.length;r++)n(t[r]);if(ua)throw ua=!1,e=ca,ca=null,e;!!(1&pa)&&0!==e.tag&&za(),s=e.pendingLanes,1&s?e===ga?ma++:(ma=0,ga=e):ma=0,Kt()}(e,t,n)}finally{Ws.transition=r,Pt=n}return null}function za(){if(null!==fa){var e=Nt(pa),t=Ws.transition,n=Pt;try{if(Ws.transition=null,Pt=16>e?16:e,null===fa)var r=!1;else{if(e=fa,fa=null,pa=0,6&js)throw Error(a(331));var i=js;for(js|=4,ls=e.current;null!==ls;){var s=ls,o=s.child;if(16&ls.flags){var l=s.deletions;if(null!==l){for(var u=0;u<l.length;u++){var c=l[u];for(ls=c;null!==ls;){var d=ls;switch(d.tag){case 0:case 11:case 15:hs(8,d,s)}var h=d.child;if(null!==h)h.return=d,ls=h;else for(;null!==ls;){var f=(d=ls).sibling,p=d.return;if(vs(d),d===c){ls=null;break}if(null!==f){f.return=p,ls=f;break}ls=p}}}var m=s.alternate;if(null!==m){var g=m.child;if(null!==g){m.child=null;do{var v=g.sibling;g.sibling=null,g=v}while(null!==g)}}ls=s}}if(2064&s.subtreeFlags&&null!==o)o.return=s,ls=o;else e:for(;null!==ls;){if(2048&(s=ls).flags)switch(s.tag){case 0:case 11:case 15:hs(9,s,s.return)}var y=s.sibling;if(null!==y){y.return=s.return,ls=y;break e}ls=s.return}}var b=e.current;for(ls=b;null!==ls;){var _=(o=ls).child;if(2064&o.subtreeFlags&&null!==_)_.return=o,ls=_;else e:for(o=b;null!==ls;){if(2048&(l=ls).flags)try{switch(l.tag){case 0:case 11:case 15:fs(9,l)}}catch(e){Ha(l,l.return,e)}if(l===o){ls=null;break e}var x=l.sibling;if(null!==x){x.return=l.return,ls=x;break e}ls=l.return}}if(js=i,Kt(),$t&&"function"==typeof $t.onPostCommitFiberRoot)try{$t.onPostCommitFiberRoot(Ht,e)}catch(e){}r=!0}return r}finally{Pt=n,Ws.transition=t}}return!1}function Ga(e,t,n){vn(e,t=Ti(0,t=vi(n,t),1)),t=ba(),null!==(e=Sa(e,1))&&(It(e,1,t),Ta(e,t))}function Ha(e,t,n){if(3===e.tag)Ga(e,e,n);else for(;null!==t;){if(3===t.tag){Ga(t,e,n);break}if(1===t.tag){var r=t.stateNode;if("function"==typeof t.type.getDerivedStateFromError||"function"==typeof r.componentDidCatch&&(null===da||!da.has(r))){vn(t,e=Ei(t,e=vi(n,e),1)),e=ba(),null!==(t=Sa(t,1))&&(It(t,1,e),Ta(t,e));break}}t=t.return}}function $a(e,t,n){var r=e.pingCache;null!==r&&r.delete(t),t=ba(),e.pingedLanes|=e.suspendedLanes&n,qs===e&&(Ys&n)===n&&(4===Zs||3===Zs&&(130023424&Ys)===Ys&&500>Ut()-sa?La(e,0):na|=n),Ta(e,t)}function Wa(e,t){0===t&&(1&e.mode?(t=Et,!(130023424&(Et<<=1))&&(Et=4194304)):t=1);var n=ba();null!==(e=Sa(e,t))&&(It(e,t,n),Ta(e,n))}function ja(e){var t=e.memoizedState,n=0;null!==t&&(n=t.retryLane),Wa(e,n)}function qa(e,t){var n=0;switch(e.tag){case 13:var r=e.stateNode,i=e.memoizedState;null!==i&&(n=i.retryLane);break;case 19:r=e.stateNode;break;default:throw Error(a(314))}null!==r&&r.delete(t),Wa(e,n)}function Xa(e,t){return Dt(e,t)}function Ya(e,t,n,r){this.tag=e,this.key=n,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=r,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ka(e,t,n,r){return new Ya(e,t,n,r)}function Qa(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Za(e,t){var n=e.alternate;return null===n?((n=Ka(e.tag,t,e.key,e.mode)).elementType=e.elementType,n.type=e.type,n.stateNode=e.stateNode,n.alternate=e,e.alternate=n):(n.pendingProps=t,n.type=e.type,n.flags=0,n.subtreeFlags=0,n.deletions=null),n.flags=14680064&e.flags,n.childLanes=e.childLanes,n.lanes=e.lanes,n.child=e.child,n.memoizedProps=e.memoizedProps,n.memoizedState=e.memoizedState,n.updateQueue=e.updateQueue,t=e.dependencies,n.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},n.sibling=e.sibling,n.index=e.index,n.ref=e.ref,n}function Ja(e,t,n,r,i,s){var o=2;if(r=e,"function"==typeof e)Qa(e)&&(o=1);else if("string"==typeof e)o=5;else e:switch(e){case c:return eo(n.children,i,s,t);case d:o=8,i|=8;break;case h:return(e=Ka(12,n,t,2|i)).elementType=h,e.lanes=s,e;case g:return(e=Ka(13,n,t,i)).elementType=g,e.lanes=s,e;case v:return(e=Ka(19,n,t,i)).elementType=v,e.lanes=s,e;case _:return to(n,i,s,t);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case f:o=10;break e;case p:o=9;break e;case m:o=11;break e;case y:o=14;break e;case b:o=16,r=null;break e}throw Error(a(130,null==e?e:typeof e,""))}return(t=Ka(o,n,t,i)).elementType=e,t.type=r,t.lanes=s,t}function eo(e,t,n,r){return(e=Ka(7,e,r,t)).lanes=n,e}function to(e,t,n,r){return(e=Ka(22,e,r,t)).elementType=_,e.lanes=n,e.stateNode={},e}function no(e,t,n){return(e=Ka(6,e,null,t)).lanes=n,e}function ro(e,t,n){return(t=Ka(4,null!==e.children?e.children:[],e.key,t)).lanes=n,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function io(e,t,n,r,i){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=j,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Ct(0),this.expirationTimes=Ct(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Ct(0),this.identifierPrefix=r,this.onRecoverableError=i,K&&(this.mutableSourceEagerHydrationData=null)}function so(e,t,n,r,i,s,a,o,l){return e=new io(e,t,n,o,l),1===t?(t=1,!0===s&&(t|=8)):t=0,s=Ka(3,null,null,t),e.current=s,s.stateNode=e,s.memoizedState={element:r,isDehydrated:n,cache:null,transitions:null},pn(s),e}function ao(e){if(!e)return ut;e:{if(A(e=e._reactInternals)!==e||1!==e.tag)throw Error(a(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(pt(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(a(171))}if(1===e.tag){var n=e.type;if(pt(n))return vt(e,n,t)}return t}function oo(e){var t=e._reactInternals;if(void 0===t){if("function"==typeof e.render)throw Error(a(188));throw e=Object.keys(e).join(","),Error(a(268,e))}return null===(e=R(t))?null:e.stateNode}function lo(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var n=e.retryLane;e.retryLane=0!==n&&n<t?n:t}}function uo(e,t){lo(e,t),(e=e.alternate)&&lo(e,t)}function co(e){return null===(e=R(e))?null:e.stateNode}function ho(){return null}return la=function(e,t,n){if(null!==e)if(e.memoizedProps!==t.pendingProps||dt.current)ki=!0;else{if(0===(e.lanes&n)&&!(128&t.flags))return ki=!1,function(e,t,n){switch(t.tag){case 3:Wi(t),Jn();break;case 5:pr(t);break;case 1:pt(t.type)&&yt(t);break;case 4:hr(t,t.stateNode.containerInfo);break;case 10:on(0,t.type._context,t.memoizedProps.value);break;case 13:var r=t.memoizedState;if(null!==r)return null!==r.dehydrated?(lt(gr,1&gr.current),t.flags|=128,null):0!==(n&t.child.childLanes)?Yi(e,t,n):(lt(gr,1&gr.current),null!==(e=rs(e,t,n))?e.sibling:null);lt(gr,1&gr.current);break;case 19:if(r=0!==(n&t.childLanes),128&e.flags){if(r)return ns(e,t,n);t.flags|=128}var i=t.memoizedState;if(null!==i&&(i.rendering=null,i.tail=null,i.lastEffect=null),lt(gr,gr.current),r)break;return null;case 22:case 23:return t.lanes=0,Vi(e,t,n)}return rs(e,t,n)}(e,t,n);ki=!!(131072&e.flags)}else ki=!1,$n&&1048576&t.flags&&Bn(t,Pn,t.index);switch(t.lanes=0,t.tag){case 2:var r=t.type;null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),e=t.pendingProps;var i=ft(t,ct.current);cn(t,n),i=Pr(null,t,r,e,i,n);var s=Nr();return t.flags|=1,"object"==typeof i&&null!==i&&"function"==typeof i.render&&void 0===i.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,pt(r)?(s=!0,yt(t)):s=!1,t.memoizedState=null!==i.state&&void 0!==i.state?i.state:null,pn(t),i.updater=En,t.stateNode=i,i._reactInternals=t,Rn(t,r,e,n),t=$i(null,t,r,!0,s,n)):(t.tag=0,$n&&s&&Vn(t),Oi(null,t,i,n),t=t.child),t;case 16:r=t.elementType;e:{switch(null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),e=t.pendingProps,r=(i=r._init)(r._payload),t.type=r,i=t.tag=function(e){if("function"==typeof e)return Qa(e)?1:0;if(null!=e){if((e=e.$$typeof)===m)return 11;if(e===y)return 14}return 2}(r),e=en(r,e),i){case 0:t=Gi(null,t,r,e,n);break e;case 1:t=Hi(null,t,r,e,n);break e;case 11:t=Fi(null,t,r,e,n);break e;case 14:t=Ui(null,t,r,en(r.type,e),n);break e}throw Error(a(306,r,""))}return t;case 0:return r=t.type,i=t.pendingProps,Gi(e,t,r,i=t.elementType===r?i:en(r,i),n);case 1:return r=t.type,i=t.pendingProps,Hi(e,t,r,i=t.elementType===r?i:en(r,i),n);case 3:e:{if(Wi(t),null===e)throw Error(a(387));r=t.pendingProps,i=(s=t.memoizedState).element,mn(e,t),_n(t,r,null,n);var o=t.memoizedState;if(r=o.element,K&&s.isDehydrated){if(s={element:r,isDehydrated:!1,cache:o.cache,transitions:o.transitions},t.updateQueue.baseState=s,t.memoizedState=s,256&t.flags){t=ji(e,t,r,n,i=Error(a(423)));break e}if(r!==i){t=ji(e,t,r,n,i=Error(a(424)));break e}for(K&&(Hn=ze(t.stateNode.containerInfo),Gn=t,$n=!0,jn=null,Wn=!1),n=ar(t,null,r,n),t.child=n;n;)n.flags=-3&n.flags|4096,n=n.sibling}else{if(Jn(),r===i){t=rs(e,t,n);break e}Oi(e,t,r,n)}t=t.child}return t;case 5:return pr(t),null===e&&Kn(t),r=t.type,i=t.pendingProps,s=null!==e?e.memoizedProps:null,o=i.children,G(r,i)?o=null:null!==s&&G(r,s)&&(t.flags|=32),zi(e,t),Oi(e,t,o,n),t.child;case 6:return null===e&&Kn(t),null;case 13:return Yi(e,t,n);case 4:return hr(t,t.stateNode.containerInfo),r=t.pendingProps,null===e?t.child=sr(t,null,r,n):Oi(e,t,r,n),t.child;case 11:return r=t.type,i=t.pendingProps,Fi(e,t,r,i=t.elementType===r?i:en(r,i),n);case 7:return Oi(e,t,t.pendingProps,n),t.child;case 8:case 12:return Oi(e,t,t.pendingProps.children,n),t.child;case 10:e:{if(r=t.type._context,i=t.pendingProps,s=t.memoizedProps,on(0,r,o=i.value),null!==s)if(Wt(s.value,o)){if(s.children===i.children&&!dt.current){t=rs(e,t,n);break e}}else for(null!==(s=t.child)&&(s.return=t);null!==s;){var l=s.dependencies;if(null!==l){o=s.child;for(var u=l.firstContext;null!==u;){if(u.context===r){if(1===s.tag){(u=gn(-1,n&-n)).tag=2;var c=s.updateQueue;if(null!==c){var d=(c=c.shared).pending;null===d?u.next=u:(u.next=d.next,d.next=u),c.pending=u}}s.lanes|=n,null!==(u=s.alternate)&&(u.lanes|=n),un(s.return,n,t),l.lanes|=n;break}u=u.next}}else if(10===s.tag)o=s.type===t.type?null:s.child;else if(18===s.tag){if(null===(o=s.return))throw Error(a(341));o.lanes|=n,null!==(l=o.alternate)&&(l.lanes|=n),un(o,n,t),o=s.sibling}else o=s.child;if(null!==o)o.return=s;else for(o=s;null!==o;){if(o===t){o=null;break}if(null!==(s=o.sibling)){s.return=o.return,o=s;break}o=o.return}s=o}Oi(e,t,i.children,n),t=t.child}return t;case 9:return i=t.type,r=t.pendingProps.children,cn(t,n),r=r(i=dn(i)),t.flags|=1,Oi(e,t,r,n),t.child;case 14:return i=en(r=t.type,t.pendingProps),Ui(e,t,r,i=en(r.type,i),n);case 15:return Bi(e,t,t.type,t.pendingProps,n);case 17:return r=t.type,i=t.pendingProps,i=t.elementType===r?i:en(r,i),null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),t.tag=1,pt(r)?(e=!0,yt(t)):e=!1,cn(t,n),wn(t,r,i),Rn(t,r,i,n),$i(null,t,r,!0,e,n);case 19:return ns(e,t,n);case 22:return Vi(e,t,n)}throw Error(a(156,t.tag))},n.attemptContinuousHydration=function(e){13===e.tag&&(xa(e,134217728,ba()),uo(e,134217728))},n.attemptHydrationAtCurrentPriority=function(e){if(13===e.tag){var t=ba(),n=_a(e);xa(e,n,t),uo(e,n)}},n.attemptSynchronousHydration=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var n=At(t.pendingLanes);0!==n&&(Lt(t,1|n),Ta(t,Ut()),!(6&js)&&(oa(),Kt()))}break;case 13:var r=ba();Ca(function(){return xa(e,1,r)}),uo(e,1)}},n.batchedUpdates=function(e,t){var n=js;js|=1;try{return e(t)}finally{0===(js=n)&&(oa(),qt&&Kt())}},n.createComponentSelector=function(e){return{$$typeof:Ls,value:e}},n.createContainer=function(e,t,n,r,i,s,a){return so(e,t,!1,null,0,r,0,s,a)},n.createHasPseudoClassSelector=function(e){return{$$typeof:Ps,value:e}},n.createHydrationContainer=function(e,t,n,r,i,s,a,o,l){return(e=so(n,r,!0,e,0,s,0,o,l)).context=ao(null),n=e.current,(s=gn(r=ba(),i=_a(n))).callback=null!=t?t:null,vn(n,s),e.current.lanes=i,It(e,i,r),Ta(e,r),e},n.createPortal=function(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:u,key:null==r?null:""+r,children:e,containerInfo:t,implementation:n}},n.createRoleSelector=function(e){return{$$typeof:Ns,value:e}},n.createTestNameSelector=function(e){return{$$typeof:Ds,value:e}},n.createTextSelector=function(e){return{$$typeof:ks,value:e}},n.deferredUpdates=function(e){var t=Pt,n=Ws.transition;try{return Ws.transition=null,Pt=16,e()}finally{Pt=t,Ws.transition=n}},n.discreteUpdates=function(e,t,n,r,i){var s=Pt,a=Ws.transition;try{return Ws.transition=null,Pt=1,e(t,n,r,i)}finally{Pt=s,Ws.transition=a,0===js&&oa()}},n.findAllNodes=zs,n.findBoundingRects=function(e,t){if(!re)throw Error(a(363));t=zs(e,t),e=[];for(var n=0;n<t.length;n++)e.push(se(t[n]));for(t=e.length-1;0<t;t--)for(var r=(n=e[t]).x,i=r+n.width,s=n.y,o=s+n.height,l=t-1;0<=l;l--)if(t!==l){var u=e[l],c=u.x,d=c+u.width,h=u.y,f=h+u.height;if(r>=c&&s>=h&&i<=d&&o<=f){e.splice(t,1);break}if(!(r!==c||n.width!==u.width||f<s||h>o)){h>s&&(u.height+=h-s,u.y=s),f<o&&(u.height=o-h),e.splice(t,1);break}if(!(s!==h||n.height!==u.height||d<r||c>i)){c>r&&(u.width+=c-r,u.x=r),d<i&&(u.width=i-c),e.splice(t,1);break}}return e},n.findHostInstance=oo,n.findHostInstanceWithNoPortals=function(e){return null===(e=null!==(e=M(e))?I(e):null)?null:e.stateNode},n.findHostInstanceWithWarning=function(e){return oo(e)},n.flushControlled=function(e){var t=js;js|=1;var n=Ws.transition,r=Pt;try{Ws.transition=null,Pt=1,e()}finally{Pt=r,Ws.transition=n,0===(js=t)&&(oa(),Kt())}},n.flushPassiveEffects=za,n.flushSync=Ca,n.focusWithin=function(e,t){if(!re)throw Error(a(363));for(t=Vs(e=Fs(e),t),t=Array.from(t),e=0;e<t.length;){var n=t[e++];if(!oe(n)){if(5===n.tag&&ue(n.stateNode))return!0;for(n=n.child;null!==n;)t.push(n),n=n.sibling}}return!1},n.getCurrentUpdatePriority=function(){return Pt},n.getFindAllNodesFailureDescription=function(e,t){if(!re)throw Error(a(363));var n=0,r=[];e=[Fs(e),0];for(var i=0;i<e.length;){var s=e[i++],o=e[i++],l=t[o];if((5!==s.tag||!oe(s))&&(Us(s,l)&&(r.push(Bs(l)),++o>n&&(n=o)),o<t.length))for(s=s.child;null!==s;)e.push(s,o),s=s.sibling}if(n<t.length){for(e=[];n<t.length;n++)e.push(Bs(t[n]));return"findAllNodes was able to match part of the selector:\n  "+r.join(" > ")+"\n\nNo matching component was found for:\n  "+e.join(" > ")}return null},n.getPublicRootInstance=function(e){return(e=e.current).child?5===e.child.tag?N(e.child.stateNode):e.child.stateNode:null},n.injectIntoDevTools=function(e){if(e={bundleType:e.bundleType,version:e.version,rendererPackageName:e.rendererPackageName,rendererConfig:e.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:o.ReactCurrentDispatcher,findHostInstanceByFiber:co,findFiberByHostInstance:e.findFiberByHostInstance||ho,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.0.0-fc46dba67-20220329"},"undefined"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)e=!1;else{var t=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(t.isDisabled||!t.supportsFiber)e=!0;else{try{Ht=t.inject(e),$t=t}catch(e){}e=!!t.checkDCE}}return e},n.isAlreadyRendering=function(){return!1},n.observeVisibleRects=function(e,t,n,r){if(!re)throw Error(a(363));e=zs(e,t);var i=ce(e,n,r).disconnect;return{disconnect:function(){i()}}},n.registerMutableSourceForHydration=function(e,t){var n=t._getVersion;n=n(t._source),null==e.mutableSourceEagerHydrationData?e.mutableSourceEagerHydrationData=[t,n]:e.mutableSourceEagerHydrationData.push(t,n)},n.runWithPriority=function(e,t){var n=Pt;try{return Pt=e,t()}finally{Pt=n}},n.shouldError=function(){return null},n.shouldSuspend=function(){return!1},n.updateContainer=function(e,t,n,r){var i=t.current,s=ba(),a=_a(i);return n=ao(n),null===t.context?t.context=n:t.pendingContext=n,(t=gn(s,a)).payload={element:e},null!==(r=void 0===r?null:r)&&(t.callback=r),vn(i,t),null!==(e=xa(i,a,s))&&yn(e,i,a),a},n}),Df}var Vf,zf,Gf={exports:{}};function Hf(){return Vf||(Vf=1,"production"!==process.env.NODE_ENV&&(Gf.exports=function(e){var n={},r=t,i=Uf(),s=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,a=!1;function o(e){if(!a){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];u("warn",e,n)}}function l(e){if(!a){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];u("error",e,n)}}function u(e,t,n){var r=s.ReactDebugCurrentFrame.getStackAddendum();""!==r&&(t+="%s",n=n.concat([r]));var i=n.map(function(e){return String(e)});i.unshift("Warning: "+t),Function.prototype.apply.call(console[e],console,i)}var c=Object.assign;function d(e){return e._reactInternals}var h=!1,f=!1,p=10,m=11,g=12,v=13,y=14,b=15,_=17,x=18,S=19,T=22,E=23,A=Symbol.for("react.element"),w=Symbol.for("react.portal"),M=Symbol.for("react.fragment"),R=Symbol.for("react.strict_mode"),C=Symbol.for("react.profiler"),I=Symbol.for("react.provider"),L=Symbol.for("react.context"),P=Symbol.for("react.forward_ref"),N=Symbol.for("react.suspense"),D=Symbol.for("react.suspense_list"),k=Symbol.for("react.memo"),O=Symbol.for("react.lazy"),F=(Symbol.for("react.scope"),Symbol.for("react.debug_trace_mode"),Symbol.for("react.offscreen")),U=(Symbol.for("react.legacy_hidden"),Symbol.for("react.cache"),Symbol.for("react.tracing_marker"),Symbol.iterator);function B(e){if(null===e||"object"!=typeof e)return null;var t=U&&e[U]||e["@@iterator"];return"function"==typeof t?t:null}function V(e){return e.displayName||"Context"}function z(e){if(null==e)return null;if("number"==typeof e.tag&&l("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),"function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case M:return"Fragment";case w:return"Portal";case C:return"Profiler";case R:return"StrictMode";case N:return"Suspense";case D:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case L:return V(e)+".Consumer";case I:return V(e._context)+".Provider";case P:return function(e,t,n){var r=e.displayName;if(r)return r;var i=t.displayName||t.name||"";return""!==i?n+"("+i+")":n}(e,e.render,"ForwardRef");case k:var t=e.displayName||null;return null!==t?t:z(e.type)||"Memo";case O:var n=e,r=n._payload,i=n._init;try{return z(i(r))}catch(e){return null}}return null}function G(e){return e.displayName||"Context"}function H(e){var t,n,r,i,s=e.tag,a=e.type;switch(s){case 24:return"Cache";case 9:return G(a)+".Consumer";case p:return G(a._context)+".Provider";case x:return"DehydratedFragment";case m:return t=a,n=a.render,r="ForwardRef",i=n.displayName||n.name||"",t.displayName||(""!==i?r+"("+i+")":r);case 7:return"Fragment";case 5:return a;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return z(a);case 8:return a===R?"StrictMode":"Mode";case T:return"Offscreen";case g:return"Profiler";case 21:return"Scope";case v:return"Suspense";case S:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case _:case 2:case y:case b:if("function"==typeof a)return a.displayName||a.name||null;if("string"==typeof a)return a}return null}var $=16,W=128,j=256,q=512,X=1024,Y=2048,K=4096,Q=8192,Z=16384,J=32768,ee=65536,te=131072,ne=1048576,re=2097152,ie=4194304,se=16777216,ae=33554432,oe=1028,le=12854,ue=8772,ce=2064,de=14680064,he=s.ReactCurrentOwner;function fe(e){var t=e,n=e;if(e.alternate)for(;t.return;)t=t.return;else{var r=t;do{4098&(t=r).flags&&(n=t.return),r=t.return}while(r)}return 3===t.tag?n:null}function pe(e){if(fe(e)!==e)throw new Error("Unable to find node on an unmounted component.")}function me(e){var t=e.alternate;if(!t){var n=fe(e);if(null===n)throw new Error("Unable to find node on an unmounted component.");return n!==e?null:e}for(var r=e,i=t;;){var s=r.return;if(null===s)break;var a=s.alternate;if(null===a){var o=s.return;if(null!==o){r=i=o;continue}break}if(s.child===a.child){for(var l=s.child;l;){if(l===r)return pe(s),e;if(l===i)return pe(s),t;l=l.sibling}throw new Error("Unable to find node on an unmounted component.")}if(r.return!==i.return)r=s,i=a;else{for(var u=!1,c=s.child;c;){if(c===r){u=!0,r=s,i=a;break}if(c===i){u=!0,i=s,r=a;break}c=c.sibling}if(!u){for(c=a.child;c;){if(c===r){u=!0,r=a,i=s;break}if(c===i){u=!0,i=a,r=s;break}c=c.sibling}if(!u)throw new Error("Child was not found in either parent set. This indicates a bug in React related to the return pointer. Please file an issue.")}}if(r.alternate!==i)throw new Error("Return fibers should always be each others' alternates. This error is likely caused by a bug in React. Please file an issue.")}if(3!==r.tag)throw new Error("Unable to find node on an unmounted component.");return r.stateNode.current===r?e:t}function ge(e){var t=me(e);return null!==t?ve(t):null}function ve(e){if(5===e.tag||6===e.tag)return e;for(var t=e.child;null!==t;){var n=ve(t);if(null!==n)return n;t=t.sibling}return null}function ye(e){var t=me(e);return null!==t?be(t):null}function be(e){if(5===e.tag||6===e.tag)return e;for(var t=e.child;null!==t;){if(4!==t.tag){var n=be(t);if(null!==n)return n}t=t.sibling}return null}var _e=Array.isArray;function xe(e){return _e(e)}var Se=e.getPublicInstance,Te=e.getRootHostContext,Ee=e.getChildHostContext,Ae=e.prepareForCommit,we=e.resetAfterCommit,Me=e.createInstance,Re=e.appendInitialChild,Ce=e.finalizeInitialChildren,Ie=e.prepareUpdate,Le=e.shouldSetTextContent,Pe=e.createTextInstance,Ne=e.scheduleTimeout,De=e.cancelTimeout,ke=e.noTimeout;e.now;var Oe=e.isPrimaryRenderer,Fe=e.warnsIfNotActing,Ue=e.supportsMutation,Be=e.supportsPersistence,Ve=e.supportsHydration,ze=e.getInstanceFromNode;e.beforeActiveInstanceBlur,e.afterActiveInstanceBlur;var Ge=e.preparePortalMount;e.preparePortalMount,e.getInstanceFromScope;var He=e.getCurrentEventPriority,$e=e.detachDeletedInstance,We=e.supportsMicrotasks,je=e.scheduleMicrotask,qe=e.supportsTestSelectors,Xe=e.findFiberRoot,Ye=e.getBoundingRect,Ke=e.getTextContent,Qe=e.isHiddenSubtree,Ze=e.matchAccessibilityRole,Je=e.setFocusIfFocusable,et=e.setupIntersectionObserver,tt=e.appendChild,nt=e.appendChildToContainer,rt=e.commitTextUpdate,it=e.commitMount,st=e.commitUpdate,at=e.insertBefore,ot=e.insertInContainerBefore,lt=e.removeChild,ut=e.removeChildFromContainer,ct=e.resetTextContent,dt=e.hideInstance,ht=e.hideTextInstance,ft=e.unhideInstance,pt=e.unhideTextInstance,mt=e.clearContainer,gt=e.cloneInstance,vt=e.createContainerChildSet,yt=e.appendChildToContainerChildSet,bt=e.finalizeContainerChildren,_t=e.replaceContainerChildren;e.getOffscreenContainerType;e.getOffscreenContainerProps;var xt,St,Tt,Et,At,wt,Mt,Rt=e.cloneHiddenInstance,Ct=e.cloneHiddenTextInstance,It=e.canHydrateInstance,Lt=e.canHydrateTextInstance,Pt=e.canHydrateSuspenseInstance,Nt=e.isSuspenseInstancePending,Dt=e.isSuspenseInstanceFallback,kt=e.registerSuspenseInstanceRetry,Ot=e.getNextHydratableSibling,Ft=e.getFirstHydratableChild,Ut=e.getFirstHydratableChildWithinContainer,Bt=e.getFirstHydratableChildWithinSuspenseInstance,Vt=e.hydrateInstance,zt=e.hydrateTextInstance,Gt=e.hydrateSuspenseInstance,Ht=e.getNextHydratableInstanceAfterSuspenseInstance,$t=e.commitHydratedContainer,Wt=e.commitHydratedSuspenseInstance,jt=e.clearSuspenseBoundary,qt=e.clearSuspenseBoundaryFromContainer,Xt=e.shouldDeleteUnhydratedTailInstances,Yt=e.didNotMatchHydratedContainerTextInstance,Kt=e.didNotMatchHydratedTextInstance,Qt=e.didNotHydrateInstanceWithinContainer,Zt=e.didNotHydrateInstanceWithinSuspenseInstance,Jt=e.didNotHydrateInstance,en=e.didNotFindHydratableInstanceWithinContainer,tn=e.didNotFindHydratableTextInstanceWithinContainer,nn=e.didNotFindHydratableSuspenseInstanceWithinContainer,rn=e.didNotFindHydratableInstanceWithinSuspenseInstance,sn=e.didNotFindHydratableTextInstanceWithinSuspenseInstance,an=e.didNotFindHydratableSuspenseInstanceWithinSuspenseInstance,on=e.didNotFindHydratableInstance,ln=e.didNotFindHydratableTextInstance,un=e.didNotFindHydratableSuspenseInstance,cn=e.errorHydratingContainer,dn=0;function hn(){}hn.__reactDisabledLog=!0;var fn,pn=s.ReactCurrentDispatcher;function mn(e,t,n){if(void 0===fn)try{throw Error()}catch(e){var r=e.stack.trim().match(/\n( *(at )?)/);fn=r&&r[1]||""}return"\n"+fn+e}var gn,vn=!1,yn="function"==typeof WeakMap?WeakMap:Map;function bn(e,t){if(!e||vn)return"";var n,r=gn.get(e);if(void 0!==r)return r;vn=!0;var i,s=Error.prepareStackTrace;Error.prepareStackTrace=void 0,i=pn.current,pn.current=null,function(){if(0===dn){xt=console.log,St=console.info,Tt=console.warn,Et=console.error,At=console.group,wt=console.groupCollapsed,Mt=console.groupEnd;var e={configurable:!0,enumerable:!0,value:hn,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}dn++}();try{if(t){var a=function(){throw Error()};if(Object.defineProperty(a.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(a,[])}catch(e){n=e}Reflect.construct(e,[],a)}else{try{a.call()}catch(e){n=e}e.call(a.prototype)}}else{try{throw Error()}catch(e){n=e}e()}}catch(t){if(t&&n&&"string"==typeof t.stack){for(var o=t.stack.split("\n"),u=n.stack.split("\n"),d=o.length-1,h=u.length-1;d>=1&&h>=0&&o[d]!==u[h];)h--;for(;d>=1&&h>=0;d--,h--)if(o[d]!==u[h]){if(1!==d||1!==h)do{if(d--,--h<0||o[d]!==u[h]){var f="\n"+o[d].replace(" at new "," at ");return e.displayName&&f.includes("<anonymous>")&&(f=f.replace("<anonymous>",e.displayName)),"function"==typeof e&&gn.set(e,f),f}}while(d>=1&&h>=0);break}}}finally{vn=!1,pn.current=i,function(){if(0===--dn){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:c({},e,{value:xt}),info:c({},e,{value:St}),warn:c({},e,{value:Tt}),error:c({},e,{value:Et}),group:c({},e,{value:At}),groupCollapsed:c({},e,{value:wt}),groupEnd:c({},e,{value:Mt})})}dn<0&&l("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}(),Error.prepareStackTrace=s}var p=e?e.displayName||e.name:"",m=p?mn(p):"";return"function"==typeof e&&gn.set(e,m),m}function _n(e,t,n){return bn(e,!1)}function xn(e,t,n){if(null==e)return"";if("function"==typeof e)return bn(e,!(!(r=e.prototype)||!r.isReactComponent));var r;if("string"==typeof e)return mn(e);switch(e){case N:return mn("Suspense");case D:return mn("SuspenseList")}if("object"==typeof e)switch(e.$$typeof){case P:return _n(e.render);case k:return xn(e.type,t,n);case O:var i=e,s=i._payload,a=i._init;try{return xn(a(s),t,n)}catch(e){}}return""}gn=new yn;var Sn=Object.prototype.hasOwnProperty,Tn={},En=s.ReactDebugCurrentFrame;function An(e){if(e){var t=e._owner,n=xn(e.type,e._source,t?t.type:null);En.setExtraStackFrame(n)}else En.setExtraStackFrame(null)}function wn(e,t,n,r,i){var s=Function.call.bind(Sn);for(var a in e)if(s(e,a)){var o=void 0;try{if("function"!=typeof e[a]){var u=Error((r||"React class")+": "+n+" type `"+a+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof e[a]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw u.name="Invariant Violation",u}o=e[a](t,a,r,n,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(e){o=e}!o||o instanceof Error||(An(i),l("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",r||"React class",n,a,typeof o),An(null)),o instanceof Error&&!(o.message in Tn)&&(Tn[o.message]=!0,An(i),l("Failed %s type: %s",n,o.message),An(null))}}var Mn,Rn=[];Mn=[];var Cn,In=-1;function Ln(e){return{current:e}}function Pn(e,t){In<0?l("Unexpected pop."):(t!==Mn[In]&&l("Unexpected Fiber popped."),e.current=Rn[In],Rn[In]=null,Mn[In]=null,In--)}function Nn(e,t,n){In++,Rn[In]=e.current,Mn[In]=n,e.current=t}Cn={};var Dn={};Object.freeze(Dn);var kn=Ln(Dn),On=Ln(!1),Fn=Dn;function Un(e,t,n){return n&&Gn(t)?Fn:kn.current}function Bn(e,t,n){var r=e.stateNode;r.__reactInternalMemoizedUnmaskedChildContext=t,r.__reactInternalMemoizedMaskedChildContext=n}function Vn(e,t){var n=e.type.contextTypes;if(!n)return Dn;var r=e.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===t)return r.__reactInternalMemoizedMaskedChildContext;var i={};for(var s in n)i[s]=t[s];return wn(n,i,"context",H(e)||"Unknown"),r&&Bn(e,t,i),i}function zn(){return On.current}function Gn(e){var t=e.childContextTypes;return null!=t}function Hn(e){Pn(On,e),Pn(kn,e)}function $n(e){Pn(On,e),Pn(kn,e)}function Wn(e,t,n){if(kn.current!==Dn)throw new Error("Unexpected context found on stack. This error is likely caused by a bug in React. Please file an issue.");Nn(kn,t,e),Nn(On,n,e)}function jn(e,t,n){var r=e.stateNode,i=t.childContextTypes;if("function"!=typeof r.getChildContext){var s=H(e)||"Unknown";return Cn[s]||(Cn[s]=!0,l("%s.childContextTypes is specified but there is no getChildContext() method on the instance. You can either define getChildContext() on %s or remove childContextTypes from it.",s,s)),n}var a=r.getChildContext();for(var o in a)if(!(o in i))throw new Error((H(e)||"Unknown")+'.getChildContext(): key "'+o+'" is not defined in childContextTypes.');return wn(i,a,"child context",H(e)||"Unknown"),c({},n,a)}function qn(e){var t=e.stateNode,n=t&&t.__reactInternalMemoizedMergedChildContext||Dn;return Fn=kn.current,Nn(kn,n,e),Nn(On,On.current,e),!0}function Xn(e,t,n){var r=e.stateNode;if(!r)throw new Error("Expected to have an instance by this point. This error is likely caused by a bug in React. Please file an issue.");if(n){var i=jn(e,t,Fn);r.__reactInternalMemoizedMergedChildContext=i,Pn(On,e),Pn(kn,e),Nn(kn,i,e),Nn(On,n,e)}else Pn(On,e),Nn(On,n,e)}function Yn(e){if(!function(e){return fe(e)===e}(e)||1!==e.tag)throw new Error("Expected subtree parent to be a mounted class component. This error is likely caused by a bug in React. Please file an issue.");var t=e;do{switch(t.tag){case 3:return t.stateNode.context;case 1:if(Gn(t.type))return t.stateNode.__reactInternalMemoizedMergedChildContext}t=t.return}while(null!==t);throw new Error("Found unexpected detached subtree parent. This error is likely caused by a bug in React. Please file an issue.")}var Kn=16,Qn=Math.clz32?Math.clz32:function(e){var t=e>>>0;if(0===t)return 32;return 31-(Zn(t)/Jn|0)|0},Zn=Math.log,Jn=Math.LN2;var er=16,tr=4194240,nr=1024,rr=2048,ir=4096,sr=8192,ar=16384,or=32768,lr=65536,ur=131072,cr=262144,dr=524288,hr=1048576,fr=2097152,pr=130023424,mr=4194304,gr=8388608,vr=16777216,yr=33554432,br=67108864,_r=mr,xr=134217728,Sr=268435455,Tr=268435456,Er=536870912,Ar=1073741824;function wr(e){return 1&e?"Sync":2&e?"InputContinuousHydration":4&e?"InputContinuous":8&e?"DefaultHydration":e&er?"Default":32&e?"TransitionHydration":e&tr?"Transition":e&pr?"Retry":e&xr?"SelectiveHydration":e&Tr?"IdleHydration":e&Er?"Idle":e&Ar?"Offscreen":void 0}var Mr=-1,Rr=64,Cr=mr;function Ir(e){switch(Ur(e)){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case er:return er;case 32:return 32;case 64:case 128:case 256:case 512:case nr:case rr:case ir:case sr:case ar:case or:case lr:case ur:case cr:case dr:case hr:case fr:return e&tr;case mr:case gr:case vr:case yr:case br:return e&pr;case xr:return xr;case Tr:return Tr;case Er:return Er;case Ar:return Ar;default:return l("Should have found matching lanes. This is a bug in React."),e}}function Lr(e,t){var n=e.pendingLanes;if(0===n)return 0;var r=0,i=e.suspendedLanes,s=e.pingedLanes,a=n&Sr;if(0!==a){var o=a&~i;if(0!==o)r=Ir(o);else{var l=a&s;0!==l&&(r=Ir(l))}}else{var u=n&~i;0!==u?r=Ir(u):0!==s&&(r=Ir(s))}if(0===r)return 0;if(0!==t&&t!==r&&0===(t&i)){var c=Ur(r),d=Ur(t);if(c>=d||c===er&&0!==(d&tr))return t}4&r&&(r|=n&er);var h=e.entangledLanes;if(0!==h)for(var f=e.entanglements,p=r&h;p>0;){var m=Vr(p),g=1<<m;r|=f[m],p&=~g}return r}function Pr(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case er:case 32:case 64:case 128:case 256:case 512:case nr:case rr:case ir:case sr:case ar:case or:case lr:case ur:case cr:case dr:case hr:case fr:return t+5e3;case mr:case gr:case vr:case yr:case br:case xr:case Tr:case Er:case Ar:return Mr;default:return l("Should have found matching lanes. This is a bug in React."),Mr}}function Nr(e){var t=-1073741825&e.pendingLanes;return 0!==t?t:t&Ar?Ar:0}function Dr(e){return 0!==(e&Sr)}function kr(e){return(e&pr)===e}function Or(e,t){return!!(30&t)}function Fr(e){return 0!==(e&tr)}function Ur(e){return e&-e}function Br(e){return Ur(e)}function Vr(e){return 31-Qn(e)}function zr(e){return Vr(e)}function Gr(e,t){return 0!==(e&t)}function Hr(e,t){return(e&t)===t}function $r(e,t){return e|t}function Wr(e,t){return e&~t}function jr(e,t){return e&t}function qr(e){for(var t=[],n=0;n<31;n++)t.push(e);return t}function Xr(e,t,n){e.pendingLanes|=t,t!==Er&&(e.suspendedLanes=0,e.pingedLanes=0),e.eventTimes[zr(t)]=n}function Yr(e,t,n){e.pingedLanes|=e.suspendedLanes&t}function Kr(e,t){for(var n=e.entangledLanes|=t,r=e.entanglements,i=n;i;){var s=Vr(i),a=1<<s;a&t|r[s]&t&&(r[s]|=t),i&=~a}}function Qr(e,t,n){if(xi)for(var r=e.pendingUpdatersLaneMap;n>0;){var i=zr(n),s=1<<i;r[i].add(t),n&=~s}}function Zr(e,t){if(xi)for(var n=e.pendingUpdatersLaneMap,r=e.memoizedUpdaters;t>0;){var i=zr(t),s=1<<i,a=n[i];a.size>0&&(a.forEach(function(e){var t=e.alternate;null!==t&&r.has(t)||r.add(e)}),a.clear()),t&=~s}}var Jr=er,ei=Er,ti=0;function ni(){return ti}function ri(e){ti=e}function ii(e,t){return 0!==e&&e<t}function si(e){var t=Ur(e);return ii(1,t)?ii(4,t)?Dr(t)?Jr:ei:4:1}var ai=i.unstable_scheduleCallback,oi=i.unstable_cancelCallback,li=i.unstable_shouldYield,ui=i.unstable_requestPaint,ci=i.unstable_now,di=i.unstable_ImmediatePriority,hi=i.unstable_UserBlockingPriority,fi=i.unstable_NormalPriority,pi=i.unstable_IdlePriority,mi=i.unstable_yieldValue,gi=i.unstable_setDisableYieldValue,vi=null,yi=null,bi=null,_i=!1,xi="undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__;function Si(e){if("function"==typeof mi&&(gi(e),a=e),yi&&"function"==typeof yi.setStrictMode)try{yi.setStrictMode(vi,e)}catch(e){_i||(_i=!0,l("React instrumentation encountered an error: %s",e))}}function Ti(e){bi=e}function Ei(){for(var e=new Map,t=1,n=0;n<31;n++){var r=wr(t);e.set(t,r),t*=2}return e}function Ai(){null!==bi&&"function"==typeof bi.markCommitStopped&&bi.markCommitStopped()}function wi(e){null!==bi&&"function"==typeof bi.markComponentRenderStarted&&bi.markComponentRenderStarted(e)}function Mi(){null!==bi&&"function"==typeof bi.markComponentRenderStopped&&bi.markComponentRenderStopped()}function Ri(e){null!==bi&&"function"==typeof bi.markComponentPassiveEffectMountStarted&&bi.markComponentPassiveEffectMountStarted(e)}function Ci(){null!==bi&&"function"==typeof bi.markComponentPassiveEffectMountStopped&&bi.markComponentPassiveEffectMountStopped()}function Ii(e){null!==bi&&"function"==typeof bi.markComponentPassiveEffectUnmountStarted&&bi.markComponentPassiveEffectUnmountStarted(e)}function Li(){null!==bi&&"function"==typeof bi.markComponentPassiveEffectUnmountStopped&&bi.markComponentPassiveEffectUnmountStopped()}function Pi(e){null!==bi&&"function"==typeof bi.markComponentLayoutEffectMountStarted&&bi.markComponentLayoutEffectMountStarted(e)}function Ni(){null!==bi&&"function"==typeof bi.markComponentLayoutEffectMountStopped&&bi.markComponentLayoutEffectMountStopped()}function Di(e){null!==bi&&"function"==typeof bi.markComponentLayoutEffectUnmountStarted&&bi.markComponentLayoutEffectUnmountStarted(e)}function ki(){null!==bi&&"function"==typeof bi.markComponentLayoutEffectUnmountStopped&&bi.markComponentLayoutEffectUnmountStopped()}function Oi(e,t,n){null!==bi&&"function"==typeof bi.markComponentErrored&&bi.markComponentErrored(e,t,n)}function Fi(e,t,n){null!==bi&&"function"==typeof bi.markComponentSuspended&&bi.markComponentSuspended(e,t,n)}function Ui(e){null!==bi&&"function"==typeof bi.markRenderStarted&&bi.markRenderStarted(e)}function Bi(){null!==bi&&"function"==typeof bi.markRenderStopped&&bi.markRenderStopped()}function Vi(e,t){null!==bi&&"function"==typeof bi.markStateUpdateScheduled&&bi.markStateUpdateScheduled(e,t)}var zi="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},Gi=null,Hi=!1,$i=!1;function Wi(e){null===Gi?Gi=[e]:Gi.push(e)}function ji(){Hi&&qi()}function qi(){if(!$i&&null!==Gi){$i=!0;var e=0,t=ni();try{var n=Gi;for(ri(1);e<n.length;e++){var r=n[e];do{r=r(true)}while(null!==r)}Gi=null,Hi=!1}catch(t){throw null!==Gi&&(Gi=Gi.slice(e+1)),ai(di,qi),t}finally{ri(t),$i=!1}}return null}function Xi(e){return e.current.memoizedState.isDehydrated}var Yi=s.ReactCurrentBatchConfig;function Ki(e,t){if(zi(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var i=0;i<n.length;i++){var s=n[i];if(!Sn.call(t,s)||!zi(e[s],t[s]))return!1}return!0}function Qi(e){switch(e._debugOwner&&e._debugOwner.type,e._debugSource,e.tag){case 5:return mn(e.type);case 16:return mn("Lazy");case v:return mn("Suspense");case S:return mn("SuspenseList");case 0:case 2:case b:return _n(e.type);case m:return _n(e.type.render);case 1:return bn(e.type,!0);default:return""}}function Zi(e){try{var t="",n=e;do{t+=Qi(n),n=n.return}while(n);return t}catch(e){return"\nError generating stack: "+e.message+"\n"+e.stack}}var Ji=s.ReactDebugCurrentFrame,es=null,ts=!1;function ns(){return null===es?"":Zi(es)}function rs(){Ji.getCurrentStack=null,es=null,ts=!1}function is(e){Ji.getCurrentStack=ns,es=e,ts=!1}function ss(e){ts=e}var as={recordUnsafeLifecycleWarnings:function(e,t){},flushPendingUnsafeLifecycleWarnings:function(){},recordLegacyContextWarning:function(e,t){},flushLegacyContextWarning:function(){},discardPendingWarnings:function(){}},os=function(e){var t=[];return e.forEach(function(e){t.push(e)}),t.sort().join(", ")},ls=[],us=[],cs=[],ds=[],hs=[],fs=[],ps=new Set;as.recordUnsafeLifecycleWarnings=function(e,t){ps.has(e.type)||("function"==typeof t.componentWillMount&&!0!==t.componentWillMount.__suppressDeprecationWarning&&ls.push(e),8&e.mode&&"function"==typeof t.UNSAFE_componentWillMount&&us.push(e),"function"==typeof t.componentWillReceiveProps&&!0!==t.componentWillReceiveProps.__suppressDeprecationWarning&&cs.push(e),8&e.mode&&"function"==typeof t.UNSAFE_componentWillReceiveProps&&ds.push(e),"function"==typeof t.componentWillUpdate&&!0!==t.componentWillUpdate.__suppressDeprecationWarning&&hs.push(e),8&e.mode&&"function"==typeof t.UNSAFE_componentWillUpdate&&fs.push(e))},as.flushPendingUnsafeLifecycleWarnings=function(){var e=new Set;ls.length>0&&(ls.forEach(function(t){e.add(H(t)||"Component"),ps.add(t.type)}),ls=[]);var t=new Set;us.length>0&&(us.forEach(function(e){t.add(H(e)||"Component"),ps.add(e.type)}),us=[]);var n=new Set;cs.length>0&&(cs.forEach(function(e){n.add(H(e)||"Component"),ps.add(e.type)}),cs=[]);var r=new Set;ds.length>0&&(ds.forEach(function(e){r.add(H(e)||"Component"),ps.add(e.type)}),ds=[]);var i=new Set;hs.length>0&&(hs.forEach(function(e){i.add(H(e)||"Component"),ps.add(e.type)}),hs=[]);var s=new Set;(fs.length>0&&(fs.forEach(function(e){s.add(H(e)||"Component"),ps.add(e.type)}),fs=[]),t.size>0)&&l("Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.\n\n* Move code with side effects to componentDidMount, and set initial state in the constructor.\n\nPlease update the following components: %s",os(t));r.size>0&&l("Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.\n\n* Move data fetching code or side effects to componentDidUpdate.\n* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://reactjs.org/link/derived-state\n\nPlease update the following components: %s",os(r));s.size>0&&l("Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.\n\n* Move data fetching code or side effects to componentDidUpdate.\n\nPlease update the following components: %s",os(s));e.size>0&&o("componentWillMount has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.\n\n* Move code with side effects to componentDidMount, and set initial state in the constructor.\n* Rename componentWillMount to UNSAFE_componentWillMount to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run `npx react-codemod rename-unsafe-lifecycles` in your project source folder.\n\nPlease update the following components: %s",os(e));n.size>0&&o("componentWillReceiveProps has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.\n\n* Move data fetching code or side effects to componentDidUpdate.\n* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://reactjs.org/link/derived-state\n* Rename componentWillReceiveProps to UNSAFE_componentWillReceiveProps to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run `npx react-codemod rename-unsafe-lifecycles` in your project source folder.\n\nPlease update the following components: %s",os(n));i.size>0&&o("componentWillUpdate has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.\n\n* Move data fetching code or side effects to componentDidUpdate.\n* Rename componentWillUpdate to UNSAFE_componentWillUpdate to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run `npx react-codemod rename-unsafe-lifecycles` in your project source folder.\n\nPlease update the following components: %s",os(i))};var ms=new Map,gs=new Set;function vs(e){return"function"==typeof Symbol&&Symbol.toStringTag&&e[Symbol.toStringTag]||e.constructor.name||"Object"}function ys(e){try{return bs(e),!1}catch(e){return!0}}function bs(e){return""+e}function _s(e,t){if(e&&e.defaultProps){var n=c({},t),r=e.defaultProps;for(var i in r)void 0===n[i]&&(n[i]=r[i]);return n}return t}as.recordLegacyContextWarning=function(e,t){var n=function(e){for(var t=null,n=e;null!==n;)8&n.mode&&(t=n),n=n.return;return t}(e);if(null!==n){if(!gs.has(e.type)){var r=ms.get(n);(null!=e.type.contextTypes||null!=e.type.childContextTypes||null!==t&&"function"==typeof t.getChildContext)&&(void 0===r&&(r=[],ms.set(n,r)),r.push(e))}}else l("Expected to find a StrictMode component in a strict mode tree. This error is likely caused by a bug in React. Please file an issue.")},as.flushLegacyContextWarning=function(){ms.forEach(function(e,t){if(0!==e.length){var n=e[0],r=new Set;e.forEach(function(e){r.add(H(e)||"Component"),gs.add(e.type)});var i=os(r);try{is(n),l("Legacy context API has been detected within a strict-mode tree.\n\nThe old API will be supported in all 16.x releases, but applications using it should migrate to the new version.\n\nPlease update the following components: %s\n\nLearn more about this warning here: https://reactjs.org/link/legacy-context",i)}finally{rs()}}})},as.discardPendingWarnings=function(){ls=[],us=[],cs=[],ds=[],hs=[],fs=[],ms=new Map};var xs,Ss=Ln(null);xs={};var Ts=null,Es=null,As=null,ws=!1;function Ms(){Ts=null,Es=null,As=null,ws=!1}function Rs(){ws=!0}function Cs(){ws=!1}function Is(e,t,n){Oe?(Nn(Ss,t._currentValue,e),t._currentValue=n,void 0!==t._currentRenderer&&null!==t._currentRenderer&&t._currentRenderer!==xs&&l("Detected multiple renderers concurrently rendering the same context provider. This is currently unsupported."),t._currentRenderer=xs):(Nn(Ss,t._currentValue2,e),t._currentValue2=n,void 0!==t._currentRenderer2&&null!==t._currentRenderer2&&t._currentRenderer2!==xs&&l("Detected multiple renderers concurrently rendering the same context provider. This is currently unsupported."),t._currentRenderer2=xs)}function Ls(e,t){var n=Ss.current;Pn(Ss,t),Oe?e._currentValue=n:e._currentValue2=n}function Ps(e,t,n){for(var r=e;null!==r;){var i=r.alternate;if(Hr(r.childLanes,t)?null===i||Hr(i.childLanes,t)||(i.childLanes=$r(i.childLanes,t)):(r.childLanes=$r(r.childLanes,t),null!==i&&(i.childLanes=$r(i.childLanes,t))),r===n)break;r=r.return}r!==n&&l("Expected to find the propagation root when scheduling context work. This error is likely caused by a bug in React. Please file an issue.")}function Ns(e,t,n){!function(e,t,n){var r=e.child;null!==r&&(r.return=e);for(;null!==r;){var i=void 0,s=r.dependencies;if(null!==s){i=r.child;for(var a=s.firstContext;null!==a;){if(a.context===t){if(1===r.tag){var o=Br(n),l=Ws(Mr,o);l.tag=zs;var u=r.updateQueue;if(null===u);else{var c=u.shared,d=c.pending;null===d?l.next=l:(l.next=d.next,d.next=l),c.pending=l}}r.lanes=$r(r.lanes,n);var h=r.alternate;null!==h&&(h.lanes=$r(h.lanes,n)),Ps(r.return,n,e),s.lanes=$r(s.lanes,n);break}a=a.next}}else if(r.tag===p)i=r.type===e.type?null:r.child;else if(r.tag===x){var f=r.return;if(null===f)throw new Error("We just came from a parent so we must have had a parent. This is a bug in React.");f.lanes=$r(f.lanes,n);var m=f.alternate;null!==m&&(m.lanes=$r(m.lanes,n)),Ps(f,n,e),i=r.sibling}else i=r.child;if(null!==i)i.return=r;else for(i=r;null!==i;){if(i===e){i=null;break}var g=i.sibling;if(null!==g){g.return=i.return,i=g;break}i=i.return}r=i}}(e,t,n)}function Ds(e,t){Ts=e,Es=null,As=null;var n=e.dependencies;null!==n&&(null!==n.firstContext&&(Gr(n.lanes,t)&&Jc(),n.firstContext=null))}function ks(e){ws&&l("Context can only be read while React is rendering. In classes, you can read it in the render method or getDerivedStateFromProps. In function components, you can read it directly in the function body, but not inside Hooks like useReducer() or useMemo().");var t=Oe?e._currentValue:e._currentValue2;if(As===e);else{var n={context:e,memoizedValue:t,next:null};if(null===Es){if(null===Ts)throw new Error("Context can only be read while React is rendering. In classes, you can read it in the render method or getDerivedStateFromProps. In function components, you can read it directly in the function body, but not inside Hooks like useReducer() or useMemo().");Es=n,Ts.dependencies={lanes:0,firstContext:n}}else Es=Es.next=n}return t}var Os=null;function Fs(e){null===Os?Os=[e]:Os.push(e)}var Us,Bs,Vs=0,zs=2,Gs=!1;function Hs(e){var t={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null};e.updateQueue=t}function $s(e,t){var n=t.updateQueue,r=e.updateQueue;if(n===r){var i={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,effects:r.effects};t.updateQueue=i}}function Ws(e,t){return{eventTime:e,lane:t,tag:Vs,payload:null,callback:null,next:null}}function js(e,t,n){var r=e.updateQueue;if(null!==r){var i=r.shared;if(Ff(e)){var s=i.interleaved;null===s?(t.next=t,Fs(i)):(t.next=s.next,s.next=t),i.interleaved=t}else{var a=i.pending;null===a?t.next=t:(t.next=a.next,a.next=t),i.pending=t}Bs!==i||Us||(l("An update (setState, replaceState, or forceUpdate) was scheduled from inside an update function. Update functions should be pure, with zero side-effects. Consider using componentDidUpdate or a callback."),Us=!0)}}function qs(e,t,n){var r=t.updateQueue;if(null!==r){var i=r.shared;if(Fr(n)){var s=i.lanes,a=$r(s=jr(s,e.pendingLanes),n);i.lanes=a,Kr(e,a)}}}function Xs(e,t){var n=e.updateQueue,r=e.alternate;if(null!==r){var i=r.updateQueue;if(n===i){var s=null,a=null,o=n.firstBaseUpdate;if(null!==o){var l=o;do{var u={eventTime:l.eventTime,lane:l.lane,tag:l.tag,payload:l.payload,callback:l.callback,next:null};null===a?s=a=u:(a.next=u,a=u),l=l.next}while(null!==l);null===a?s=a=t:(a.next=t,a=t)}else s=a=t;return n={baseState:i.baseState,firstBaseUpdate:s,lastBaseUpdate:a,shared:i.shared,effects:i.effects},void(e.updateQueue=n)}}var c=n.lastBaseUpdate;null===c?n.firstBaseUpdate=t:c.next=t,n.lastBaseUpdate=t}function Ys(e,t,n,r,i,s){switch(n.tag){case 1:var a=n.payload;if("function"==typeof a){Rs();var o=a.call(s,r,i);if(8&e.mode){Si(!0);try{a.call(s,r,i)}finally{Si(!1)}}return Cs(),o}return a;case 3:e.flags=-65537&e.flags|W;case Vs:var l,u=n.payload;if("function"==typeof u){if(Rs(),l=u.call(s,r,i),8&e.mode){Si(!0);try{u.call(s,r,i)}finally{Si(!1)}}Cs()}else l=u;return null==l?r:c({},r,l);case zs:return Gs=!0,r}return r}function Ks(e,t,n,r){var i=e.updateQueue;Gs=!1,Bs=i.shared;var s=i.firstBaseUpdate,a=i.lastBaseUpdate,o=i.shared.pending;if(null!==o){i.shared.pending=null;var l=o,u=l.next;l.next=null,null===a?s=u:a.next=u,a=l;var c=e.alternate;if(null!==c){var d=c.updateQueue,h=d.lastBaseUpdate;h!==a&&(null===h?d.firstBaseUpdate=u:h.next=u,d.lastBaseUpdate=l)}}if(null!==s){for(var f=i.baseState,p=0,m=null,g=null,v=null,y=s;;){var b=y.lane,_=y.eventTime;if(Hr(r,b)){if(null!==v){var x={eventTime:_,lane:0,tag:y.tag,payload:y.payload,callback:y.callback,next:null};v=v.next=x}if(f=Ys(e,0,y,f,t,n),null!==y.callback&&0!==y.lane){e.flags|=64;var S=i.effects;null===S?i.effects=[y]:S.push(y)}}else{var T={eventTime:_,lane:b,tag:y.tag,payload:y.payload,callback:y.callback,next:null};null===v?(g=v=T,m=f):v=v.next=T,p=$r(p,b)}if(null===(y=y.next)){if(null===(o=i.shared.pending))break;var E=o,A=E.next;E.next=null,y=A,i.lastBaseUpdate=E,i.shared.pending=null}}null===v&&(m=f),i.baseState=m,i.firstBaseUpdate=g,i.lastBaseUpdate=v;var w=i.shared.interleaved;if(null!==w){var M=w;do{p=$r(p,M.lane),M=M.next}while(M!==w)}else null===s&&(i.shared.lanes=0);Zf(p),e.lanes=p,e.memoizedState=f}Bs=null}function Qs(e,t){if("function"!=typeof e)throw new Error("Invalid argument passed as callback. Expected a function. Instead received: "+e);e.call(t)}function Zs(){Gs=!1}function Js(){return Gs}function ea(e,t,n){var r=t.effects;if(t.effects=null,null!==r)for(var i=0;i<r.length;i++){var s=r[i],a=s.callback;null!==a&&(s.callback=null,Qs(a,n))}}Us=!1,Bs=null;var ta,na,ra,ia,sa,aa,oa,la,ua,ca,da={},ha=(new r.Component).refs;ta=new Set,na=new Set,ra=new Set,ia=new Set,la=new Set,sa=new Set,ua=new Set,ca=new Set;var fa=new Set;function pa(e,t,n,r){var i=e.memoizedState,s=n(r,i);if(8&e.mode){Si(!0);try{s=n(r,i)}finally{Si(!1)}}aa(t,s);var a=null==s?i:c({},i,s);(e.memoizedState=a,0===e.lanes)&&(e.updateQueue.baseState=a)}oa=function(e,t){if(null!==e&&"function"!=typeof e){var n=t+"_"+e;fa.has(n)||(fa.add(n),l("%s(...): Expected the last optional `callback` argument to be a function. Instead received: %s.",t,e))}},aa=function(e,t){if(void 0===t){var n=z(e)||"Component";sa.has(n)||(sa.add(n),l("%s.getDerivedStateFromProps(): A valid state object (or null) must be returned. You have returned undefined.",n))}},Object.defineProperty(da,"_processChildContext",{enumerable:!1,value:function(){throw new Error("_processChildContext is not available in React 16+. This likely means you have multiple copies of React and are attempting to nest a React 15 tree inside a React 16 tree using unstable_renderSubtreeIntoContainer, which isn't supported. Try to make sure you have only one copy of React (and ideally, switch to ReactDOM.createPortal).")}}),Object.freeze(da);var ma={isMounted:function(e){var t=he.current;if(null!==t&&1===t.tag){var n=t,r=n.stateNode;r._warnedAboutRefsInRender||l("%s is accessing isMounted inside its render() function. render() should be a pure function of props and state. It should never access something that requires stale data from the previous render, such as refs. Move this logic to componentDidMount and componentDidUpdate instead.",H(n)||"A component"),r._warnedAboutRefsInRender=!0}var i=d(e);return!!i&&fe(i)===i},enqueueSetState:function(e,t,n){var r=d(e),i=Pf(),s=Nf(r),a=Ws(i,s);a.payload=t,null!=n&&(oa(n,"setState"),a.callback=n),js(r,a);var o=kf(r,s,i);null!==o&&qs(o,r,s),Vi(r,s)},enqueueReplaceState:function(e,t,n){var r=d(e),i=Pf(),s=Nf(r),a=Ws(i,s);a.tag=1,a.payload=t,null!=n&&(oa(n,"replaceState"),a.callback=n),js(r,a);var o=kf(r,s,i);null!==o&&qs(o,r,s),Vi(r,s)},enqueueForceUpdate:function(e,t){var n=d(e),r=Pf(),i=Nf(n),s=Ws(r,i);s.tag=zs,null!=t&&(oa(t,"forceUpdate"),s.callback=t),js(n,s);var a=kf(n,i,r);null!==a&&qs(a,n,i),function(e,t){null!==bi&&"function"==typeof bi.markForceUpdateScheduled&&bi.markForceUpdateScheduled(e,t)}(n,i)}};function ga(e,t,n,r,i,s,a){var o=e.stateNode;if("function"==typeof o.shouldComponentUpdate){var u=o.shouldComponentUpdate(r,s,a);if(8&e.mode){Si(!0);try{u=o.shouldComponentUpdate(r,s,a)}finally{Si(!1)}}return void 0===u&&l("%s.shouldComponentUpdate(): Returned undefined instead of a boolean value. Make sure to return true or false.",z(t)||"Component"),u}return!t.prototype||!t.prototype.isPureReactComponent||(!Ki(n,r)||!Ki(i,s))}function va(e,t){var n;t.updater=ma,e.stateNode=t,n=e,t._reactInternals=n,t._reactInternalInstance=da}function ya(e,t,n){var r=!1,i=Dn,s=Dn,a=t.contextType;if("contextType"in t&&(!(null===a||void 0!==a&&a.$$typeof===L&&void 0===a._context)&&!ca.has(t))){ca.add(t);var o="";o=void 0===a?" However, it is set to undefined. This can be caused by a typo or by mixing up named and default imports. This can also happen due to a circular dependency, so try moving the createContext() call to a separate file.":"object"!=typeof a?" However, it is set to a "+typeof a+".":a.$$typeof===I?" Did you accidentally pass the Context.Provider instead?":void 0!==a._context?" Did you accidentally pass the Context.Consumer instead?":" However, it is set to an object with keys {"+Object.keys(a).join(", ")+"}.",l("%s defines an invalid contextType. contextType should point to the Context object returned by React.createContext().%s",z(t)||"Component",o)}if("object"==typeof a&&null!==a)s=ks(a);else{i=Un(0,t,!0);var u=t.contextTypes;s=(r=null!=u)?Vn(e,i):Dn}var c=new t(n,s);if(8&e.mode){Si(!0);try{c=new t(n,s)}finally{Si(!1)}}var d=e.memoizedState=null!==c.state&&void 0!==c.state?c.state:null;if(va(e,c),"function"==typeof t.getDerivedStateFromProps&&null===d){var h=z(t)||"Component";na.has(h)||(na.add(h),l("`%s` uses `getDerivedStateFromProps` but its initial state is %s. This is not recommended. Instead, define the initial state by assigning an object to `this.state` in the constructor of `%s`. This ensures that `getDerivedStateFromProps` arguments have a consistent shape.",h,null===c.state?"null":"undefined",h))}if("function"==typeof t.getDerivedStateFromProps||"function"==typeof c.getSnapshotBeforeUpdate){var f=null,p=null,m=null;if("function"==typeof c.componentWillMount&&!0!==c.componentWillMount.__suppressDeprecationWarning?f="componentWillMount":"function"==typeof c.UNSAFE_componentWillMount&&(f="UNSAFE_componentWillMount"),"function"==typeof c.componentWillReceiveProps&&!0!==c.componentWillReceiveProps.__suppressDeprecationWarning?p="componentWillReceiveProps":"function"==typeof c.UNSAFE_componentWillReceiveProps&&(p="UNSAFE_componentWillReceiveProps"),"function"==typeof c.componentWillUpdate&&!0!==c.componentWillUpdate.__suppressDeprecationWarning?m="componentWillUpdate":"function"==typeof c.UNSAFE_componentWillUpdate&&(m="UNSAFE_componentWillUpdate"),null!==f||null!==p||null!==m){var g=z(t)||"Component",v="function"==typeof t.getDerivedStateFromProps?"getDerivedStateFromProps()":"getSnapshotBeforeUpdate()";ia.has(g)||(ia.add(g),l("Unsafe legacy lifecycles will not be called for components using new component APIs.\n\n%s uses %s but also contains the following legacy lifecycles:%s%s%s\n\nThe above lifecycles should be removed. Learn more about this warning here:\nhttps://reactjs.org/link/unsafe-component-lifecycles",g,v,null!==f?"\n  "+f:"",null!==p?"\n  "+p:"",null!==m?"\n  "+m:""))}}return r&&Bn(e,i,s),c}function ba(e,t,n,r){var i=t.state;if("function"==typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(n,r),"function"==typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(n,r),t.state!==i){var s=H(e)||"Component";ta.has(s)||(ta.add(s),l("%s.componentWillReceiveProps(): Assigning directly to this.state is deprecated (except inside a component's constructor). Use setState instead.",s)),ma.enqueueReplaceState(t,t.state,null)}}function _a(e,t,n,r){!function(e,t,n){var r=e.stateNode,i=z(t)||"Component";r.render||(t.prototype&&"function"==typeof t.prototype.render?l("%s(...): No `render` method found on the returned component instance: did you accidentally return an object from the constructor?",i):l("%s(...): No `render` method found on the returned component instance: you may have forgotten to define `render`.",i)),!r.getInitialState||r.getInitialState.isReactClassApproved||r.state||l("getInitialState was defined on %s, a plain JavaScript class. This is only supported for classes created using React.createClass. Did you mean to define a state property instead?",i),r.getDefaultProps&&!r.getDefaultProps.isReactClassApproved&&l("getDefaultProps was defined on %s, a plain JavaScript class. This is only supported for classes created using React.createClass. Use a static property to define defaultProps instead.",i),r.propTypes&&l("propTypes was defined as an instance property on %s. Use a static property to define propTypes instead.",i),r.contextType&&l("contextType was defined as an instance property on %s. Use a static property to define contextType instead.",i),r.contextTypes&&l("contextTypes was defined as an instance property on %s. Use a static property to define contextTypes instead.",i),t.contextType&&t.contextTypes&&!ua.has(t)&&(ua.add(t),l("%s declares both contextTypes and contextType static properties. The legacy contextTypes property will be ignored.",i)),"function"==typeof r.componentShouldUpdate&&l("%s has a method called componentShouldUpdate(). Did you mean shouldComponentUpdate()? The name is phrased as a question because the function is expected to return a value.",i),t.prototype&&t.prototype.isPureReactComponent&&void 0!==r.shouldComponentUpdate&&l("%s has a method called shouldComponentUpdate(). shouldComponentUpdate should not be used when extending React.PureComponent. Please extend React.Component if shouldComponentUpdate is used.",z(t)||"A pure component"),"function"==typeof r.componentDidUnmount&&l("%s has a method called componentDidUnmount(). But there is no such lifecycle method. Did you mean componentWillUnmount()?",i),"function"==typeof r.componentDidReceiveProps&&l("%s has a method called componentDidReceiveProps(). But there is no such lifecycle method. If you meant to update the state in response to changing props, use componentWillReceiveProps(). If you meant to fetch data or run side-effects or mutations after React has updated the UI, use componentDidUpdate().",i),"function"==typeof r.componentWillRecieveProps&&l("%s has a method called componentWillRecieveProps(). Did you mean componentWillReceiveProps()?",i),"function"==typeof r.UNSAFE_componentWillRecieveProps&&l("%s has a method called UNSAFE_componentWillRecieveProps(). Did you mean UNSAFE_componentWillReceiveProps()?",i);var s=r.props!==n;void 0!==r.props&&s&&l("%s(...): When calling super() in `%s`, make sure to pass up the same props that your component's constructor was passed.",i,i),r.defaultProps&&l("Setting defaultProps as an instance property on %s is not supported and will be ignored. Instead, define defaultProps as a static property on %s.",i,i),"function"!=typeof r.getSnapshotBeforeUpdate||"function"==typeof r.componentDidUpdate||ra.has(t)||(ra.add(t),l("%s: getSnapshotBeforeUpdate() should be used with componentDidUpdate(). This component defines getSnapshotBeforeUpdate() only.",z(t))),"function"==typeof r.getDerivedStateFromProps&&l("%s: getDerivedStateFromProps() is defined as an instance method and will be ignored. Instead, declare it as a static method.",i),"function"==typeof r.getDerivedStateFromError&&l("%s: getDerivedStateFromError() is defined as an instance method and will be ignored. Instead, declare it as a static method.",i),"function"==typeof t.getSnapshotBeforeUpdate&&l("%s: getSnapshotBeforeUpdate() is defined as a static method and will be ignored. Instead, declare it as an instance method.",i);var a=r.state;a&&("object"!=typeof a||xe(a))&&l("%s.state: must be set to an object or null",i),"function"==typeof r.getChildContext&&"object"!=typeof t.childContextTypes&&l("%s.getChildContext(): childContextTypes must be defined in order to use getChildContext().",i)}(e,t,n);var i=e.stateNode;i.props=n,i.state=e.memoizedState,i.refs=ha,Hs(e);var s=t.contextType;if("object"==typeof s&&null!==s)i.context=ks(s);else{var a=Un(0,t,!0);i.context=Vn(e,a)}if(i.state===n){var o=z(t)||"Component";la.has(o)||(la.add(o),l("%s: It is not recommended to assign props directly to state because updates to props won't be reflected in state. In most cases, it is better to use props directly.",o))}8&e.mode&&as.recordLegacyContextWarning(e,i),as.recordUnsafeLifecycleWarnings(e,i),i.state=e.memoizedState;var u=t.getDerivedStateFromProps;if("function"==typeof u&&(pa(e,t,u,n),i.state=e.memoizedState),"function"==typeof t.getDerivedStateFromProps||"function"==typeof i.getSnapshotBeforeUpdate||"function"!=typeof i.UNSAFE_componentWillMount&&"function"!=typeof i.componentWillMount||(!function(e,t){var n=t.state;"function"==typeof t.componentWillMount&&t.componentWillMount(),"function"==typeof t.UNSAFE_componentWillMount&&t.UNSAFE_componentWillMount(),n!==t.state&&(l("%s.componentWillMount(): Assigning directly to this.state is deprecated (except inside a component's constructor). Use setState instead.",H(e)||"Component"),ma.enqueueReplaceState(t,t.state,null))}(e,i),Ks(e,n,i,r),i.state=e.memoizedState),"function"==typeof i.componentDidMount){var c=4;c|=ie,0!==(e.mode&Kn)&&(c|=se),e.flags|=c}}var xa=[],Sa=0,Ta=null,Ea=0,Aa=[],wa=0,Ma=null,Ra=1,Ca="";function Ia(){var e=Ca;return(Ra&~function(e){return 1<<Da(e)-1}(Ra)).toString(32)+e}function La(e,t){Oa(),xa[Sa++]=Ea,xa[Sa++]=Ta,Ta=e,Ea=t}function Pa(e,t,n){Oa(),Aa[wa++]=Ra,Aa[wa++]=Ca,Aa[wa++]=Ma,Ma=e;var r=Ra,i=Ca,s=Da(r)-1,a=r&~(1<<s),o=n+1,l=Da(t)+s;if(l>30){var u=s-s%5,c=(a&(1<<u)-1).toString(32),d=a>>u,h=s-u,f=Da(t)+h;Ra=1<<f|(o<<h|d),Ca=c+i}else{Ra=1<<l|(o<<s|a),Ca=i}}function Na(e){if(Oa(),null!==e.return){La(e,1),Pa(e,1,0)}}function Da(e){return 32-Qn(e)}function ka(e){for(;e===Ta;)Ta=xa[--Sa],xa[Sa]=null,Ea=xa[--Sa],xa[Sa]=null;for(;e===Ma;)Ma=Aa[--wa],Aa[wa]=null,Ca=Aa[--wa],Aa[wa]=null,Ra=Aa[--wa],Aa[wa]=null}function Oa(){oo()||l("Expected to be hydrating. This is a bug in React. Please file an issue.")}var Fa,Ua,Ba,Va,za,Ga=null,Ha=null,$a=!1,Wa=!1,ja=null;function qa(e,t,n){return!!Ve&&(Ha=Bt(t),Ga=e,$a=!0,ja=null,Wa=!1,null!==n&&function(e,t){Oa(),Aa[wa++]=Ra,Aa[wa++]=Ca,Aa[wa++]=Ma,Ra=t.id,Ca=t.overflow,Ma=e}(e,n),!0)}function Xa(e,t){switch(e.tag){case 3:Qt(e.stateNode.containerInfo,t);break;case 5:Jt(e.type,e.memoizedProps,e.stateNode,t);break;case v:var n=e.memoizedState;null!==n.dehydrated&&Zt(n.dehydrated,t)}}function Ya(e,t){Xa(e,t);var n,r=((n=Hp(5,null,null,0)).elementType="DELETED",n);r.stateNode=t,r.return=e;var i=e.deletions;null===i?(e.deletions=[r],e.flags|=$):i.push(r)}function Ka(e,t){if(!Wa)switch(e.tag){case 3:var n=e.stateNode.containerInfo;switch(t.tag){case 5:var r=t.type,i=t.pendingProps;en(n,r,i);break;case 6:var s=t.pendingProps;tn(n,s);break;case v:nn(n)}break;case 5:var a=e.type,o=e.memoizedProps,l=e.stateNode;switch(t.tag){case 5:var u=t.type,c=t.pendingProps;on(a,o,l,u,c);break;case 6:var d=t.pendingProps;ln(a,o,l,d);break;case v:un(a,o,l)}break;case v:var h=e.memoizedState.dehydrated;if(null!==h)switch(t.tag){case 5:var f=t.type,p=t.pendingProps;rn(h,f,p);break;case 6:var m=t.pendingProps;sn(h,m);break;case v:an(h)}break;default:return}}function Qa(e,t){t.flags=-4097&t.flags|2,Ka(e,t)}function Za(e,t){switch(e.tag){case 5:var n=e.type,r=e.pendingProps,i=It(t,n,r);return null!==i&&(e.stateNode=i,Ga=e,Ha=Ft(i),!0);case 6:var s=e.pendingProps,a=Lt(t,s);return null!==a&&(e.stateNode=a,Ga=e,Ha=null,!0);case v:var o=Pt(t);if(null!==o){var l={dehydrated:o,treeContext:(Oa(),null!==Ma?{id:Ra,overflow:Ca}:null),retryLane:Ar};e.memoizedState=l;var u=function(e){var t=Hp(x,null,null,0);return t.stateNode=e,t}(o);return u.return=e,e.child=u,Ga=e,Ha=null,!0}return!1;default:return!1}}function Ja(e){return!!(1&e.mode)&&0===(e.flags&W)}function eo(e){throw new Error("Hydration failed because the initial UI does not match what was rendered on the server.")}function to(e){if($a){var t=Ha;if(!t)return Ja(e)&&(Ka(Ga,e),eo()),Qa(Ga,e),$a=!1,void(Ga=e);var n=t;if(!Za(e,t)){Ja(e)&&(Ka(Ga,e),eo()),t=Ot(n);var r=Ga;if(!t||!Za(e,t))return Qa(Ga,e),$a=!1,void(Ga=e);Ya(r,n)}}}function no(e){for(var t=e.return;null!==t&&5!==t.tag&&3!==t.tag&&t.tag!==v;)t=t.return;Ga=t}function ro(e){if(!Ve)return!1;if(e!==Ga)return!1;if(!$a)return no(e),$a=!0,!1;if(3!==e.tag&&(5!==e.tag||Xt(e.type)&&!Le(e.type,e.memoizedProps))){var t=Ha;if(t)if(Ja(e))io(e),eo();else for(;t;)Ya(e,t),t=Ot(t)}return no(e),Ha=e.tag===v?function(e){if(!Ve)throw new Error("Expected skipPastDehydratedSuspenseInstance() to never be called. This error is likely caused by a bug in React. Please file an issue.");var t=e.memoizedState,n=null!==t?t.dehydrated:null;if(!n)throw new Error("Expected to have a hydrated suspense instance. This error is likely caused by a bug in React. Please file an issue.");return Ht(n)}(e):Ga?Ot(e.stateNode):null,!0}function io(e){for(var t=Ha;t;)Xa(e,t),t=Ot(t)}function so(){Ve&&(Ga=null,Ha=null,$a=!1,Wa=!1)}function ao(){null!==ja&&(Gf(ja),ja=null)}function oo(){return $a}function lo(e){null===ja?ja=[e]:ja.push(e)}var uo;function co(e,t,n){var r=n.ref;if(null!==r&&"function"!=typeof r&&"object"!=typeof r){if(8&e.mode&&(!n._owner||!n._self||n._owner.stateNode===n._self)){var i=H(e)||"Component";Ba[i]||(l('A string ref, "%s", has been found within a strict mode tree. String refs are a source of potential bugs and should be avoided. We recommend using useRef() or createRef() instead. Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref',r),Ba[i]=!0)}if(n._owner){var s,a=n._owner;if(a){var o=a;if(1!==o.tag)throw new Error("Function components cannot have string refs. We recommend using useRef() instead. Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref");s=o.stateNode}if(!s)throw new Error("Missing owner for string ref "+r+". This error is likely caused by a bug in React. Please file an issue.");var u=s;!function(e,t){if(ys(e))l("The provided `%s` prop is an unsupported type %s. This value must be coerced to a string before before using it here.",t,vs(e)),bs(e)}(r,"ref");var c=""+r;if(null!==t&&null!==t.ref&&"function"==typeof t.ref&&t.ref._stringRef===c)return t.ref;var d=function(e){var t=u.refs;t===ha&&(t=u.refs={}),null===e?delete t[c]:t[c]=e};return d._stringRef=c,d}if("string"!=typeof r)throw new Error("Expected ref to be a function, a string, an object returned by React.createRef(), or null.");if(!n._owner)throw new Error("Element ref was specified as a string ("+r+") but no owner was set. This could happen for one of the following reasons:\n1. You may be adding a ref to a function component\n2. You may be adding a ref to a component that was not created inside a component's render method\n3. You have multiple copies of React loaded\nSee https://reactjs.org/link/refs-must-have-owner for more information.")}return r}function ho(e,t){var n=Object.prototype.toString.call(t);throw new Error("Objects are not valid as a React child (found: "+("[object Object]"===n?"object with keys {"+Object.keys(t).join(", ")+"}":n)+"). If you meant to render a collection of children, use an array instead.")}function fo(e){var t=H(e)||"Component";za[t]||(za[t]=!0,l("Functions are not valid as a React child. This may happen if you return a Component instead of <Component /> from render. Or maybe you meant to call this function rather than return it."))}function po(e){var t=e._payload;return(0,e._init)(t)}function mo(e){function t(t,n){if(e){var r=t.deletions;null===r?(t.deletions=[n],t.flags|=$):r.push(n)}}function n(n,r){if(!e)return null;for(var i=r;null!==i;)t(n,i),i=i.sibling;return null}function r(e,t){for(var n=new Map,r=t;null!==r;)null!==r.key?n.set(r.key,r):n.set(r.index,r),r=r.sibling;return n}function i(e,t){var n=Wp(e,t);return n.index=0,n.sibling=null,n}function s(t,n,r){if(t.index=r,!e)return t.flags|=ne,n;var i=t.alternate;if(null!==i){var s=i.index;return s<n?(t.flags|=2,n):s}return t.flags|=2,n}function a(t){return e&&null===t.alternate&&(t.flags|=2),t}function o(e,t,n,r){if(null===t||6!==t.tag){var s=Qp(n,e.mode,r);return s.return=e,s}var a=i(t,n);return a.return=e,a}function u(e,t,n,r){var s=n.type;if(s===M)return d(e,t,n.props.children,r,n.key);if(null!==t&&(t.elementType===s||Np(t,n)||"object"==typeof s&&null!==s&&s.$$typeof===O&&po(s)===t.type)){var a=i(t,n.props);return a.ref=co(e,t,n),a.return=e,a._debugSource=n._source,a._debugOwner=n._owner,a}var o=Xp(n,e.mode,r);return o.ref=co(e,t,n),o.return=e,o}function c(e,t,n,r){if(null===t||4!==t.tag||t.stateNode.containerInfo!==n.containerInfo||t.stateNode.implementation!==n.implementation){var s=Zp(n,e.mode,r);return s.return=e,s}var a=i(t,n.children||[]);return a.return=e,a}function d(e,t,n,r,s){if(null===t||7!==t.tag){var a=Yp(n,e.mode,r,s);return a.return=e,a}var o=i(t,n);return o.return=e,o}function h(e,t,n){if("string"==typeof t&&""!==t||"number"==typeof t){var r=Qp(""+t,e.mode,n);return r.return=e,r}if("object"==typeof t&&null!==t){switch(t.$$typeof){case A:var i=Xp(t,e.mode,n);return i.ref=co(e,null,t),i.return=e,i;case w:var s=Zp(t,e.mode,n);return s.return=e,s;case O:var a=t._payload;return h(e,(0,t._init)(a),n)}if(xe(t)||B(t)){var o=Yp(t,e.mode,n,null);return o.return=e,o}ho(0,t)}return"function"==typeof t&&fo(e),null}function f(e,t,n,r){var i=null!==t?t.key:null;if("string"==typeof n&&""!==n||"number"==typeof n)return null!==i?null:o(e,t,""+n,r);if("object"==typeof n&&null!==n){switch(n.$$typeof){case A:return n.key===i?u(e,t,n,r):null;case w:return n.key===i?c(e,t,n,r):null;case O:var s=n._payload;return f(e,t,(0,n._init)(s),r)}if(xe(n)||B(n))return null!==i?null:d(e,t,n,r,null);ho(0,n)}return"function"==typeof n&&fo(e),null}function p(e,t,n,r,i){if("string"==typeof r&&""!==r||"number"==typeof r)return o(t,e.get(n)||null,""+r,i);if("object"==typeof r&&null!==r){switch(r.$$typeof){case A:return u(t,e.get(null===r.key?n:r.key)||null,r,i);case w:return c(t,e.get(null===r.key?n:r.key)||null,r,i);case O:var s=r._payload;return p(e,t,n,(0,r._init)(s),i)}if(xe(r)||B(r))return d(t,e.get(n)||null,r,i,null);ho(0,r)}return"function"==typeof r&&fo(t),null}function m(e,t,n){if("object"!=typeof e||null===e)return t;switch(e.$$typeof){case A:case w:uo(e,n);var r=e.key;if("string"!=typeof r)break;if(null===t){(t=new Set).add(r);break}if(!t.has(r)){t.add(r);break}l("Encountered two children with the same key, `%s`. Keys should be unique so that components maintain their identity across updates. Non-unique keys may cause children to be duplicated and/or omitted  the behavior is unsupported and could change in a future version.",r);break;case O:var i=e._payload;m((0,e._init)(i),t,n)}return t}return function o(u,c,d,g){if("object"==typeof d&&null!==d&&d.type===M&&null===d.key&&(d=d.props.children),"object"==typeof d&&null!==d){switch(d.$$typeof){case A:return a(function(e,r,s,a){for(var o=s.key,l=r;null!==l;){if(l.key===o){var u=s.type;if(u===M){if(7===l.tag){n(e,l.sibling);var c=i(l,s.props.children);return c.return=e,c._debugSource=s._source,c._debugOwner=s._owner,c}}else if(l.elementType===u||Np(l,s)||"object"==typeof u&&null!==u&&u.$$typeof===O&&po(u)===l.type){n(e,l.sibling);var d=i(l,s.props);return d.ref=co(e,l,s),d.return=e,d._debugSource=s._source,d._debugOwner=s._owner,d}n(e,l);break}t(e,l),l=l.sibling}if(s.type===M){var h=Yp(s.props.children,e.mode,a,s.key);return h.return=e,h}var f=Xp(s,e.mode,a);return f.ref=co(e,r,s),f.return=e,f}(u,c,d,g));case w:return a(function(e,r,s,a){for(var o=s.key,l=r;null!==l;){if(l.key===o){if(4===l.tag&&l.stateNode.containerInfo===s.containerInfo&&l.stateNode.implementation===s.implementation){n(e,l.sibling);var u=i(l,s.children||[]);return u.return=e,u}n(e,l);break}t(e,l),l=l.sibling}var c=Zp(s,e.mode,a);return c.return=e,c}(u,c,d,g));case O:var v=d._payload;return o(u,c,(0,d._init)(v),g)}if(xe(d))return function(i,a,o,l){for(var u=null,c=0;c<o.length;c++)u=m(o[c],u,i);for(var d=null,g=null,v=a,y=0,b=0,_=null;null!==v&&b<o.length;b++){v.index>b?(_=v,v=null):_=v.sibling;var x=f(i,v,o[b],l);if(null===x){null===v&&(v=_);break}e&&v&&null===x.alternate&&t(i,v),y=s(x,y,b),null===g?d=x:g.sibling=x,g=x,v=_}if(b===o.length)return n(i,v),oo()&&La(i,b),d;if(null===v){for(;b<o.length;b++){var S=h(i,o[b],l);null!==S&&(y=s(S,y,b),null===g?d=S:g.sibling=S,g=S)}return oo()&&La(i,b),d}for(var T=r(0,v);b<o.length;b++){var E=p(T,i,b,o[b],l);null!==E&&(e&&null!==E.alternate&&T.delete(null===E.key?b:E.key),y=s(E,y,b),null===g?d=E:g.sibling=E,g=E)}return e&&T.forEach(function(e){return t(i,e)}),oo()&&La(i,b),d}(u,c,d,g);if(B(d))return function(i,a,o,u){var c=B(o);if("function"!=typeof c)throw new Error("An object is not an iterable. This error is likely caused by a bug in React. Please file an issue.");"function"==typeof Symbol&&"Generator"===o[Symbol.toStringTag]&&(Ua||l("Using Generators as children is unsupported and will likely yield unexpected results because enumerating a generator mutates it. You may convert it to an array with `Array.from()` or the `[...spread]` operator before rendering. Keep in mind you might need to polyfill these features for older browsers."),Ua=!0),o.entries===c&&(Fa||l("Using Maps as children is not supported. Use an array of keyed ReactElements instead."),Fa=!0);var d=c.call(o);if(d)for(var g=null,v=d.next();!v.done;v=d.next())g=m(v.value,g,i);var y=c.call(o);if(null==y)throw new Error("An iterable object provided no iterator.");for(var b=null,_=null,x=a,S=0,T=0,E=null,A=y.next();null!==x&&!A.done;T++,A=y.next()){x.index>T?(E=x,x=null):E=x.sibling;var w=f(i,x,A.value,u);if(null===w){null===x&&(x=E);break}e&&x&&null===w.alternate&&t(i,x),S=s(w,S,T),null===_?b=w:_.sibling=w,_=w,x=E}if(A.done)return n(i,x),oo()&&La(i,T),b;if(null===x){for(;!A.done;T++,A=y.next()){var M=h(i,A.value,u);null!==M&&(S=s(M,S,T),null===_?b=M:_.sibling=M,_=M)}return oo()&&La(i,T),b}for(var R=r(0,x);!A.done;T++,A=y.next()){var C=p(R,i,T,A.value,u);null!==C&&(e&&null!==C.alternate&&R.delete(null===C.key?T:C.key),S=s(C,S,T),null===_?b=C:_.sibling=C,_=C)}return e&&R.forEach(function(e){return t(i,e)}),oo()&&La(i,T),b}(u,c,d,g);ho(0,d)}return"string"==typeof d&&""!==d||"number"==typeof d?a(function(e,t,r,s){if(null!==t&&6===t.tag){n(e,t.sibling);var a=i(t,r);return a.return=e,a}n(e,t);var o=Qp(r,e.mode,s);return o.return=e,o}(u,c,""+d,g)):("function"==typeof d&&fo(u),n(u,c))}}Fa=!1,Ua=!1,Ba={},Va={},za={},uo=function(e,t){if(null!==e&&"object"==typeof e&&e._store&&!e._store.validated&&null==e.key){if("object"!=typeof e._store)throw new Error("React Component in warnForMissingKey should have a _store. This error is likely caused by a bug in React. Please file an issue.");e._store.validated=!0;var n=H(t)||"Component";Va[n]||(Va[n]=!0,l('Each child in a list should have a unique "key" prop. See https://reactjs.org/link/warning-keys for more information.'))}};var go=mo(!0),vo=mo(!1);function yo(e,t){for(var n=e.child;null!==n;)jp(n,t),n=n.sibling}var bo={},_o=Ln(bo),xo=Ln(bo),So=Ln(bo);function To(e){if(e===bo)throw new Error("Expected host context to exist. This error is likely caused by a bug in React. Please file an issue.");return e}function Eo(){return To(So.current)}function Ao(e,t){Nn(So,t,e),Nn(xo,e,e),Nn(_o,bo,e);var n=Te(t);Pn(_o,e),Nn(_o,n,e)}function wo(e){Pn(_o,e),Pn(xo,e),Pn(So,e)}function Mo(){return To(_o.current)}function Ro(e){var t=To(So.current),n=To(_o.current),r=Ee(n,e.type,t);n!==r&&(Nn(xo,e,e),Nn(_o,r,e))}function Co(e){xo.current===e&&(Pn(_o,e),Pn(xo,e))}var Io=1,Lo=1,Po=2,No=Ln(0);function Do(e,t){return 0!==(e&t)}function ko(e){return e&Io}function Oo(e,t){return e&Io|t}function Fo(e,t){Nn(No,t,e)}function Uo(e){Pn(No,e)}function Bo(e,t){var n=e.memoizedState;return null!==n?null!==n.dehydrated:(e.memoizedProps,!0)}function Vo(e){for(var t=e;null!==t;){if(t.tag===v){var n=t.memoizedState;if(null!==n){var r=n.dehydrated;if(null===r||Nt(r)||Dt(r))return t}}else if(t.tag===S&&void 0!==t.memoizedProps.revealOrder){if(0!==(t.flags&W))return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)return null;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var zo=0,Go=1,Ho=2,$o=4,Wo=8,jo=[];function qo(){for(var e=0;e<jo.length;e++){var t=jo[e];Oe?t._workInProgressVersionPrimary=null:t._workInProgressVersionSecondary=null}jo.length=0}var Xo,Yo,Ko=s.ReactCurrentDispatcher,Qo=s.ReactCurrentBatchConfig;Xo=new Set;var Zo=0,Jo=null,el=null,tl=null,nl=!1,rl=!1,il=0,sl=0,al=null,ol=null,ll=-1,ul=!1;function cl(){var e=al;null===ol?ol=[e]:ol.push(e)}function dl(){var e=al;null!==ol&&(ll++,ol[ll]!==e&&function(e){var t=H(Jo);if(!Xo.has(t)&&(Xo.add(t),null!==ol)){for(var n="",r=30,i=0;i<=ll;i++){for(var s=ol[i],a=i===ll?e:s,o=i+1+". "+s;o.length<r;)o+=" ";n+=o+=a+"\n"}l("React has detected a change in the order of Hooks called by %s. This will lead to bugs and errors if not fixed. For more information, read the Rules of Hooks: https://reactjs.org/link/rules-of-hooks\n\n   Previous render            Next render\n   ------------------------------------------------------\n%s   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n",t,n)}}(e))}function hl(e){null==e||xe(e)||l("%s received a final argument that is not an array (instead, received `%s`). When specified, the final argument must be an array.",al,typeof e)}function fl(){throw new Error("Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for one of the following reasons:\n1. You might have mismatching versions of React and the renderer (such as React DOM)\n2. You might be breaking the Rules of Hooks\n3. You might have more than one copy of React in the same app\nSee https://reactjs.org/link/invalid-hook-call for tips about how to debug and fix this problem.")}function pl(e,t){if(ul)return!1;if(null===t)return l("%s received a final argument during this render, but not during the previous render. Even though the final argument is optional, its type cannot change between renders.",al),!1;e.length!==t.length&&l("The final argument passed to %s changed size between renders. The order and size of this array must remain constant.\n\nPrevious: %s\nIncoming: %s",al,"["+t.join(", ")+"]","["+e.join(", ")+"]");for(var n=0;n<t.length&&n<e.length;n++)if(!zi(e[n],t[n]))return!1;return!0}function ml(e,t,n,r,i,s){Zo=s,Jo=t,ol=null!==e?e._debugHookTypes:null,ll=-1,ul=null!==e&&e.type!==t.type,t.memoizedState=null,t.updateQueue=null,t.lanes=0,null!==e&&null!==e.memoizedState?Ko.current=xu:Ko.current=null!==ol?_u:bu;var a=n(r,i);if(rl){var o=0;do{if(rl=!1,il=0,o>=25)throw new Error("Too many re-renders. React limits the number of renders to prevent an infinite loop.");o+=1,ul=!1,el=null,tl=null,t.updateQueue=null,ll=-1,Ko.current=Su,a=n(r,i)}while(rl)}Ko.current=yu,t._debugHookTypes=ol;var u=null!==el&&null!==el.next;if(Zo=0,Jo=null,el=null,tl=null,al=null,ol=null,ll=-1,null!==e&&(e.flags&de)!==(t.flags&de)&&1&e.mode&&l("Internal React error: Expected static flag was missing. Please notify the React team."),nl=!1,u)throw new Error("Rendered fewer hooks than expected. This may be caused by an accidental early return statement.");return a}function gl(){var e=0!==il;return il=0,e}function vl(e,t,n){t.updateQueue=e.updateQueue,0!==(t.mode&Kn)?t.flags&=-50333701:t.flags&=-2053,e.lanes=Wr(e.lanes,n)}function yl(){if(Ko.current=yu,nl){for(var e=Jo.memoizedState;null!==e;){var t=e.queue;null!==t&&(t.pending=null),e=e.next}nl=!1}Zo=0,Jo=null,el=null,tl=null,ol=null,ll=-1,al=null,lu=!1,rl=!1,il=0}function bl(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===tl?Jo.memoizedState=tl=e:tl=tl.next=e,tl}function _l(){var e,t;if(null===el){var n=Jo.alternate;e=null!==n?n.memoizedState:null}else e=el.next;if(null!==(t=null===tl?Jo.memoizedState:tl.next))t=(tl=t).next,el=e;else{if(null===e)throw new Error("Rendered more hooks than during the previous render.");var r={memoizedState:(el=e).memoizedState,baseState:el.baseState,baseQueue:el.baseQueue,queue:el.queue,next:null};null===tl?Jo.memoizedState=tl=r:tl=tl.next=r}return tl}function xl(e,t){return"function"==typeof t?t(e):t}function Sl(e,t,n){var r,i=bl();r=void 0!==n?n(t):t,i.memoizedState=i.baseState=r;var s={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:r};i.queue=s;var a=s.dispatch=du.bind(null,Jo,s);return[i.memoizedState,a]}function Tl(e,t,n){var r=_l(),i=r.queue;if(null===i)throw new Error("Should have a queue. This is likely a bug in React. Please file an issue.");i.lastRenderedReducer=e;var s=el,a=s.baseQueue,o=i.pending;if(null!==o){if(null!==a){var u=a.next,c=o.next;a.next=c,o.next=u}s.baseQueue!==a&&l("Internal error: Expected work-in-progress queue to be a clone. This is a bug in React."),s.baseQueue=a=o,i.pending=null}if(null!==a){var d=a.next,h=s.baseState,f=null,p=null,m=null,g=d;do{var v=g.lane;if(Hr(Zo,v)){if(null!==m){var y={lane:0,action:g.action,hasEagerState:g.hasEagerState,eagerState:g.eagerState,next:null};m=m.next=y}if(g.hasEagerState)h=g.eagerState;else h=e(h,g.action)}else{var b={lane:v,action:g.action,hasEagerState:g.hasEagerState,eagerState:g.eagerState,next:null};null===m?(p=m=b,f=h):m=m.next=b,Jo.lanes=$r(Jo.lanes,v),Zf(v)}g=g.next}while(null!==g&&g!==d);null===m?f=h:m.next=p,zi(h,r.memoizedState)||Jc(),r.memoizedState=h,r.baseState=f,r.baseQueue=m,i.lastRenderedState=h}var _=i.interleaved;if(null!==_){var x=_;do{var S=x.lane;Jo.lanes=$r(Jo.lanes,S),Zf(S),x=x.next}while(x!==_)}else null===a&&(i.lanes=0);var T=i.dispatch;return[r.memoizedState,T]}function El(e,t,n){var r=_l(),i=r.queue;if(null===i)throw new Error("Should have a queue. This is likely a bug in React. Please file an issue.");i.lastRenderedReducer=e;var s=i.dispatch,a=i.pending,o=r.memoizedState;if(null!==a){i.pending=null;var l=a.next,u=l;do{o=e(o,u.action),u=u.next}while(u!==l);zi(o,r.memoizedState)||Jc(),r.memoizedState=o,null===r.baseQueue&&(r.baseState=o),i.lastRenderedState=o}return[o,s]}function Al(e,t,n){var r,i=Jo,s=bl();if(oo()){if(void 0===n)throw new Error("Missing getServerSnapshot, which is required for server-rendered content. Will revert to client rendering.");r=n(),Yo||r!==n()&&(l("The result of getServerSnapshot should be cached to avoid an infinite loop"),Yo=!0)}else{if(r=t(),!Yo){var a=t();zi(r,a)||(l("The result of getSnapshot should be cached to avoid an infinite loop"),Yo=!0)}var o=Lf();if(null===o)throw new Error("Expected a work-in-progress root. This is a bug in React. Please file an issue.");Or(0,Zo)||Ml(i,t,r)}s.memoizedState=r;var u={value:r,getSnapshot:t};return s.queue=u,Vl(Cl.bind(null,i,u,e),[e]),i.flags|=Y,kl(Go|Wo,Rl.bind(null,i,u,r,t),void 0,null),r}function wl(e,t,n){var r=Jo,i=_l(),s=t();if(!Yo){var a=t();zi(s,a)||(l("The result of getSnapshot should be cached to avoid an infinite loop"),Yo=!0)}var o=i.memoizedState,u=!zi(o,s);u&&(i.memoizedState=s,Jc());var c=i.queue;if(zl(Cl.bind(null,r,c,e),[e]),c.getSnapshot!==t||u||null!==tl&&tl.memoizedState.tag&Go){r.flags|=Y,kl(Go|Wo,Rl.bind(null,r,c,s,t),void 0,null);var d=Lf();if(null===d)throw new Error("Expected a work-in-progress root. This is a bug in React. Please file an issue.");Or(0,Zo)||Ml(r,t,s)}return s}function Ml(e,t,n){e.flags|=Z;var r={getSnapshot:t,value:n},i=Jo.updateQueue;if(null===i)i={lastEffect:null,stores:null},Jo.updateQueue=i,i.stores=[r];else{var s=i.stores;null===s?i.stores=[r]:s.push(r)}}function Rl(e,t,n,r){t.value=n,t.getSnapshot=r,Il(t)&&Ll(e)}function Cl(e,t,n){return n(function(){Il(t)&&Ll(e)})}function Il(e){var t=e.getSnapshot,n=e.value;try{var r=t();return!zi(n,r)}catch(e){return!0}}function Ll(e){kf(e,1,Mr)}function Pl(e){var t=bl();"function"==typeof e&&(e=e()),t.memoizedState=t.baseState=e;var n={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:xl,lastRenderedState:e};t.queue=n;var r=n.dispatch=hu.bind(null,Jo,n);return[t.memoizedState,r]}function Nl(e){return Tl(xl)}function Dl(e){return El(xl)}function kl(e,t,n,r){var i={tag:e,create:t,destroy:n,deps:r,next:null},s=Jo.updateQueue;if(null===s)s={lastEffect:null,stores:null},Jo.updateQueue=s,s.lastEffect=i.next=i;else{var a=s.lastEffect;if(null===a)s.lastEffect=i.next=i;else{var o=a.next;a.next=i,i.next=o,s.lastEffect=i}}return i}function Ol(e){var t={current:e};return bl().memoizedState=t,t}function Fl(e){return _l().memoizedState}function Ul(e,t,n,r){var i=bl(),s=void 0===r?null:r;Jo.flags|=e,i.memoizedState=kl(Go|t,n,void 0,s)}function Bl(e,t,n,r){var i=_l(),s=void 0===r?null:r,a=void 0;if(null!==el){var o=el.memoizedState;if(a=o.destroy,null!==s)if(pl(s,o.deps))return void(i.memoizedState=kl(t,n,a,s))}Jo.flags|=e,i.memoizedState=kl(Go|t,n,a,s)}function Vl(e,t){return 0!==(Jo.mode&Kn)?Ul(41945088,Wo,e,t):Ul(8390656,Wo,e,t)}function zl(e,t){return Bl(Y,Wo,e,t)}function Gl(e,t){return Ul(4,Ho,e,t)}function Hl(e,t){return Bl(4,Ho,e,t)}function $l(e,t){var n=4;return n|=ie,0!==(Jo.mode&Kn)&&(n|=se),Ul(n,$o,e,t)}function Wl(e,t){return Bl(4,$o,e,t)}function jl(e,t){if("function"==typeof t){var n=t,r=e();return n(r),function(){n(null)}}if(null!=t){var i=t;i.hasOwnProperty("current")||l("Expected useImperativeHandle() first argument to either be a ref callback or React.createRef() object. Instead received: %s.","an object with keys {"+Object.keys(i).join(", ")+"}");var s=e();return i.current=s,function(){i.current=null}}}function ql(e,t,n){"function"!=typeof t&&l("Expected useImperativeHandle() second argument to be a function that creates a handle. Instead received: %s.",null!==t?typeof t:"null");var r=null!=n?n.concat([e]):null,i=4;return i|=ie,0!==(Jo.mode&Kn)&&(i|=se),Ul(i,$o,jl.bind(null,t,e),r)}function Xl(e,t,n){"function"!=typeof t&&l("Expected useImperativeHandle() second argument to be a function that creates a handle. Instead received: %s.",null!==t?typeof t:"null");var r=null!=n?n.concat([e]):null;return Bl(4,$o,jl.bind(null,t,e),r)}function Yl(e,t){}var Kl=Yl;function Ql(e,t){var n=void 0===t?null:t;return bl().memoizedState=[e,n],e}function Zl(e,t){var n=_l(),r=void 0===t?null:t,i=n.memoizedState;if(null!==i&&(null!==r&&pl(r,i[1])))return i[0];return n.memoizedState=[e,r],e}function Jl(e,t){var n=bl(),r=void 0===t?null:t,i=e();return n.memoizedState=[i,r],i}function eu(e,t){var n=_l(),r=void 0===t?null:t,i=n.memoizedState;if(null!==i&&(null!==r&&pl(r,i[1])))return i[0];var s=e();return n.memoizedState=[s,r],s}function tu(e){var t=Pl(e),n=t[0],r=t[1];return Vl(function(){var t=Qo.transition;Qo.transition={};try{r(e)}finally{Qo.transition=t}},[e]),n}function nu(e){var t=Nl(),n=t[0],r=t[1];return zl(function(){var t=Qo.transition;Qo.transition={};try{r(e)}finally{Qo.transition=t}},[e]),n}function ru(e){var t=Dl(),n=t[0],r=t[1];return zl(function(){var t=Qo.transition;Qo.transition={};try{r(e)}finally{Qo.transition=t}},[e]),n}function iu(e,t,n){var r,i,s=ni();ri((i=4,0!==(r=s)&&r<i?r:i)),e(!0);var a=Qo.transition;Qo.transition={};var l=Qo.transition;Qo.transition._updatedFibers=new Set;try{e(!1),t()}finally{if(ri(s),Qo.transition=a,null===a&&l._updatedFibers)l._updatedFibers.size>10&&o("Detected a large number of updates inside startTransition. If this is due to a subscription please re-write it to use React provided hooks. Otherwise concurrent mode guarantees are off the table."),l._updatedFibers.clear()}}function su(){var e=Pl(!1),t=e[0],n=e[1],r=iu.bind(null,n);return bl().memoizedState=r,[t,r]}function au(){return[Nl()[0],_l().memoizedState]}function ou(){return[Dl()[0],_l().memoizedState]}var lu=!1;function uu(){var e,t=bl(),n=Lf().identifierPrefix;if(oo()){e=":"+n+"R"+Ia();var r=il++;r>0&&(e+="H"+r.toString(32)),e+=":"}else{e=":"+n+"r"+(sl++).toString(32)+":"}return t.memoizedState=e,e}function cu(){return _l().memoizedState}function du(e,t,n){"function"==typeof arguments[3]&&l("State updates from the useState() and useReducer() Hooks don't support the second callback argument. To execute a side effect after rendering, declare it in the component body with useEffect().");var r=Nf(e),i={lane:r,action:n,hasEagerState:!1,eagerState:null,next:null};if(fu(e))pu(t,i);else{mu(e,t,i);var s=kf(e,r,Pf());null!==s&&gu(s,t,r)}vu(e,r)}function hu(e,t,n){"function"==typeof arguments[3]&&l("State updates from the useState() and useReducer() Hooks don't support the second callback argument. To execute a side effect after rendering, declare it in the component body with useEffect().");var r=Nf(e),i={lane:r,action:n,hasEagerState:!1,eagerState:null,next:null};if(fu(e))pu(t,i);else{mu(e,t,i);var s=e.alternate;if(0===e.lanes&&(null===s||0===s.lanes)){var a=t.lastRenderedReducer;if(null!==a){var o;o=Ko.current,Ko.current=Eu;try{var u=t.lastRenderedState,c=a(u,n);if(i.hasEagerState=!0,i.eagerState=c,zi(c,u))return}catch(e){}finally{Ko.current=o}}}var d=kf(e,r,Pf());null!==d&&gu(d,t,r)}vu(e,r)}function fu(e){var t=e.alternate;return e===Jo||null!==t&&t===Jo}function pu(e,t){rl=nl=!0;var n=e.pending;null===n?t.next=t:(t.next=n.next,n.next=t),e.pending=t}function mu(e,t,n,r){if(Ff(e)){var i=t.interleaved;null===i?(n.next=n,Fs(t)):(n.next=i.next,i.next=n),t.interleaved=n}else{var s=t.pending;null===s?n.next=n:(n.next=s.next,s.next=n),t.pending=n}}function gu(e,t,n){if(Fr(n)){var r=t.lanes,i=$r(r=jr(r,e.pendingLanes),n);t.lanes=i,Kr(e,i)}}function vu(e,t,n){Vi(e,t)}var yu={readContext:ks,useCallback:fl,useContext:fl,useEffect:fl,useImperativeHandle:fl,useInsertionEffect:fl,useLayoutEffect:fl,useMemo:fl,useReducer:fl,useRef:fl,useState:fl,useDebugValue:fl,useDeferredValue:fl,useTransition:fl,useMutableSource:fl,useSyncExternalStore:fl,useId:fl,unstable_isNewReconciler:h},bu=null,_u=null,xu=null,Su=null,Tu=null,Eu=null,Au=null,wu=function(){l("Context can only be read while React is rendering. In classes, you can read it in the render method or getDerivedStateFromProps. In function components, you can read it directly in the function body, but not inside Hooks like useReducer() or useMemo().")},Mu=function(){l("Do not call Hooks inside useEffect(...), useMemo(...), or other built-in Hooks. You can only call Hooks at the top level of your React function. For more information, see https://reactjs.org/link/rules-of-hooks")};bu={readContext:function(e){return ks(e)},useCallback:function(e,t){return al="useCallback",cl(),hl(t),Ql(e,t)},useContext:function(e){return al="useContext",cl(),ks(e)},useEffect:function(e,t){return al="useEffect",cl(),hl(t),Vl(e,t)},useImperativeHandle:function(e,t,n){return al="useImperativeHandle",cl(),hl(n),ql(e,t,n)},useInsertionEffect:function(e,t){return al="useInsertionEffect",cl(),hl(t),Gl(e,t)},useLayoutEffect:function(e,t){return al="useLayoutEffect",cl(),hl(t),$l(e,t)},useMemo:function(e,t){al="useMemo",cl(),hl(t);var n=Ko.current;Ko.current=Tu;try{return Jl(e,t)}finally{Ko.current=n}},useReducer:function(e,t,n){al="useReducer",cl();var r=Ko.current;Ko.current=Tu;try{return Sl(e,t,n)}finally{Ko.current=r}},useRef:function(e){return al="useRef",cl(),Ol(e)},useState:function(e){al="useState",cl();var t=Ko.current;Ko.current=Tu;try{return Pl(e)}finally{Ko.current=t}},useDebugValue:function(e,t){al="useDebugValue",cl()},useDeferredValue:function(e){return al="useDeferredValue",cl(),tu(e)},useTransition:function(){return al="useTransition",cl(),su()},useMutableSource:function(e,t,n){al="useMutableSource",cl()},useSyncExternalStore:function(e,t,n){return al="useSyncExternalStore",cl(),Al(e,t,n)},useId:function(){return al="useId",cl(),uu()},unstable_isNewReconciler:h},_u={readContext:function(e){return ks(e)},useCallback:function(e,t){return al="useCallback",dl(),Ql(e,t)},useContext:function(e){return al="useContext",dl(),ks(e)},useEffect:function(e,t){return al="useEffect",dl(),Vl(e,t)},useImperativeHandle:function(e,t,n){return al="useImperativeHandle",dl(),ql(e,t,n)},useInsertionEffect:function(e,t){return al="useInsertionEffect",dl(),Gl(e,t)},useLayoutEffect:function(e,t){return al="useLayoutEffect",dl(),$l(e,t)},useMemo:function(e,t){al="useMemo",dl();var n=Ko.current;Ko.current=Tu;try{return Jl(e,t)}finally{Ko.current=n}},useReducer:function(e,t,n){al="useReducer",dl();var r=Ko.current;Ko.current=Tu;try{return Sl(e,t,n)}finally{Ko.current=r}},useRef:function(e){return al="useRef",dl(),Ol(e)},useState:function(e){al="useState",dl();var t=Ko.current;Ko.current=Tu;try{return Pl(e)}finally{Ko.current=t}},useDebugValue:function(e,t){al="useDebugValue",dl()},useDeferredValue:function(e){return al="useDeferredValue",dl(),tu(e)},useTransition:function(){return al="useTransition",dl(),su()},useMutableSource:function(e,t,n){al="useMutableSource",dl()},useSyncExternalStore:function(e,t,n){return al="useSyncExternalStore",dl(),Al(e,t,n)},useId:function(){return al="useId",dl(),uu()},unstable_isNewReconciler:h},xu={readContext:function(e){return ks(e)},useCallback:function(e,t){return al="useCallback",dl(),Zl(e,t)},useContext:function(e){return al="useContext",dl(),ks(e)},useEffect:function(e,t){return al="useEffect",dl(),zl(e,t)},useImperativeHandle:function(e,t,n){return al="useImperativeHandle",dl(),Xl(e,t,n)},useInsertionEffect:function(e,t){return al="useInsertionEffect",dl(),Hl(e,t)},useLayoutEffect:function(e,t){return al="useLayoutEffect",dl(),Wl(e,t)},useMemo:function(e,t){al="useMemo",dl();var n=Ko.current;Ko.current=Eu;try{return eu(e,t)}finally{Ko.current=n}},useReducer:function(e,t,n){al="useReducer",dl();var r=Ko.current;Ko.current=Eu;try{return Tl(e)}finally{Ko.current=r}},useRef:function(e){return al="useRef",dl(),Fl()},useState:function(e){al="useState",dl();var t=Ko.current;Ko.current=Eu;try{return Nl()}finally{Ko.current=t}},useDebugValue:function(e,t){return al="useDebugValue",dl(),Kl()},useDeferredValue:function(e){return al="useDeferredValue",dl(),nu(e)},useTransition:function(){return al="useTransition",dl(),au()},useMutableSource:function(e,t,n){al="useMutableSource",dl()},useSyncExternalStore:function(e,t,n){return al="useSyncExternalStore",dl(),wl(e,t)},useId:function(){return al="useId",dl(),cu()},unstable_isNewReconciler:h},Su={readContext:function(e){return ks(e)},useCallback:function(e,t){return al="useCallback",dl(),Zl(e,t)},useContext:function(e){return al="useContext",dl(),ks(e)},useEffect:function(e,t){return al="useEffect",dl(),zl(e,t)},useImperativeHandle:function(e,t,n){return al="useImperativeHandle",dl(),Xl(e,t,n)},useInsertionEffect:function(e,t){return al="useInsertionEffect",dl(),Hl(e,t)},useLayoutEffect:function(e,t){return al="useLayoutEffect",dl(),Wl(e,t)},useMemo:function(e,t){al="useMemo",dl();var n=Ko.current;Ko.current=Au;try{return eu(e,t)}finally{Ko.current=n}},useReducer:function(e,t,n){al="useReducer",dl();var r=Ko.current;Ko.current=Au;try{return El(e)}finally{Ko.current=r}},useRef:function(e){return al="useRef",dl(),Fl()},useState:function(e){al="useState",dl();var t=Ko.current;Ko.current=Au;try{return Dl()}finally{Ko.current=t}},useDebugValue:function(e,t){return al="useDebugValue",dl(),Kl()},useDeferredValue:function(e){return al="useDeferredValue",dl(),ru(e)},useTransition:function(){return al="useTransition",dl(),ou()},useMutableSource:function(e,t,n){al="useMutableSource",dl()},useSyncExternalStore:function(e,t,n){return al="useSyncExternalStore",dl(),wl(e,t)},useId:function(){return al="useId",dl(),cu()},unstable_isNewReconciler:h},Tu={readContext:function(e){return wu(),ks(e)},useCallback:function(e,t){return al="useCallback",Mu(),cl(),Ql(e,t)},useContext:function(e){return al="useContext",Mu(),cl(),ks(e)},useEffect:function(e,t){return al="useEffect",Mu(),cl(),Vl(e,t)},useImperativeHandle:function(e,t,n){return al="useImperativeHandle",Mu(),cl(),ql(e,t,n)},useInsertionEffect:function(e,t){return al="useInsertionEffect",Mu(),cl(),Gl(e,t)},useLayoutEffect:function(e,t){return al="useLayoutEffect",Mu(),cl(),$l(e,t)},useMemo:function(e,t){al="useMemo",Mu(),cl();var n=Ko.current;Ko.current=Tu;try{return Jl(e,t)}finally{Ko.current=n}},useReducer:function(e,t,n){al="useReducer",Mu(),cl();var r=Ko.current;Ko.current=Tu;try{return Sl(e,t,n)}finally{Ko.current=r}},useRef:function(e){return al="useRef",Mu(),cl(),Ol(e)},useState:function(e){al="useState",Mu(),cl();var t=Ko.current;Ko.current=Tu;try{return Pl(e)}finally{Ko.current=t}},useDebugValue:function(e,t){al="useDebugValue",Mu(),cl()},useDeferredValue:function(e){return al="useDeferredValue",Mu(),cl(),tu(e)},useTransition:function(){return al="useTransition",Mu(),cl(),su()},useMutableSource:function(e,t,n){al="useMutableSource",Mu(),cl()},useSyncExternalStore:function(e,t,n){return al="useSyncExternalStore",Mu(),cl(),Al(e,t,n)},useId:function(){return al="useId",Mu(),cl(),uu()},unstable_isNewReconciler:h},Eu={readContext:function(e){return wu(),ks(e)},useCallback:function(e,t){return al="useCallback",Mu(),dl(),Zl(e,t)},useContext:function(e){return al="useContext",Mu(),dl(),ks(e)},useEffect:function(e,t){return al="useEffect",Mu(),dl(),zl(e,t)},useImperativeHandle:function(e,t,n){return al="useImperativeHandle",Mu(),dl(),Xl(e,t,n)},useInsertionEffect:function(e,t){return al="useInsertionEffect",Mu(),dl(),Hl(e,t)},useLayoutEffect:function(e,t){return al="useLayoutEffect",Mu(),dl(),Wl(e,t)},useMemo:function(e,t){al="useMemo",Mu(),dl();var n=Ko.current;Ko.current=Eu;try{return eu(e,t)}finally{Ko.current=n}},useReducer:function(e,t,n){al="useReducer",Mu(),dl();var r=Ko.current;Ko.current=Eu;try{return Tl(e)}finally{Ko.current=r}},useRef:function(e){return al="useRef",Mu(),dl(),Fl()},useState:function(e){al="useState",Mu(),dl();var t=Ko.current;Ko.current=Eu;try{return Nl()}finally{Ko.current=t}},useDebugValue:function(e,t){return al="useDebugValue",Mu(),dl(),Kl()},useDeferredValue:function(e){return al="useDeferredValue",Mu(),dl(),nu(e)},useTransition:function(){return al="useTransition",Mu(),dl(),au()},useMutableSource:function(e,t,n){al="useMutableSource",Mu(),dl()},useSyncExternalStore:function(e,t,n){return al="useSyncExternalStore",Mu(),dl(),wl(e,t)},useId:function(){return al="useId",Mu(),dl(),cu()},unstable_isNewReconciler:h},Au={readContext:function(e){return wu(),ks(e)},useCallback:function(e,t){return al="useCallback",Mu(),dl(),Zl(e,t)},useContext:function(e){return al="useContext",Mu(),dl(),ks(e)},useEffect:function(e,t){return al="useEffect",Mu(),dl(),zl(e,t)},useImperativeHandle:function(e,t,n){return al="useImperativeHandle",Mu(),dl(),Xl(e,t,n)},useInsertionEffect:function(e,t){return al="useInsertionEffect",Mu(),dl(),Hl(e,t)},useLayoutEffect:function(e,t){return al="useLayoutEffect",Mu(),dl(),Wl(e,t)},useMemo:function(e,t){al="useMemo",Mu(),dl();var n=Ko.current;Ko.current=Eu;try{return eu(e,t)}finally{Ko.current=n}},useReducer:function(e,t,n){al="useReducer",Mu(),dl();var r=Ko.current;Ko.current=Eu;try{return El(e)}finally{Ko.current=r}},useRef:function(e){return al="useRef",Mu(),dl(),Fl()},useState:function(e){al="useState",Mu(),dl();var t=Ko.current;Ko.current=Eu;try{return Dl()}finally{Ko.current=t}},useDebugValue:function(e,t){return al="useDebugValue",Mu(),dl(),Kl()},useDeferredValue:function(e){return al="useDeferredValue",Mu(),dl(),ru(e)},useTransition:function(){return al="useTransition",Mu(),dl(),ou()},useMutableSource:function(e,t,n){al="useMutableSource",Mu(),dl()},useSyncExternalStore:function(e,t,n){return al="useSyncExternalStore",Mu(),dl(),wl(e,t)},useId:function(){return al="useId",Mu(),dl(),cu()},unstable_isNewReconciler:h};var Ru=i.unstable_now,Cu=0,Iu=-1,Lu=-1,Pu=-1,Nu=!1,Du=!1;function ku(){return Nu}function Ou(){return Cu}function Fu(){Cu=Ru()}function Uu(e){Lu=Ru(),e.actualStartTime<0&&(e.actualStartTime=Ru())}function Bu(e){Lu=-1}function Vu(e,t){if(Lu>=0){var n=Ru()-Lu;e.actualDuration+=n,t&&(e.selfBaseDuration=n),Lu=-1}}function zu(e){if(Iu>=0){var t=Ru()-Iu;Iu=-1;for(var n=e.return;null!==n;){switch(n.tag){case 3:return void(n.stateNode.effectDuration+=t);case g:return void(n.stateNode.effectDuration+=t)}n=n.return}}}function Gu(e){if(Pu>=0){var t=Ru()-Pu;Pu=-1;for(var n=e.return;null!==n;){switch(n.tag){case 3:var r=n.stateNode;return void(null!==r&&(r.passiveEffectDuration+=t));case g:var i=n.stateNode;return void(null!==i&&(i.passiveEffectDuration+=t))}n=n.return}}}function Hu(){Iu=Ru()}function $u(){Pu=Ru()}function Wu(e){for(var t=e.child;t;)e.actualDuration+=t.actualDuration,t=t.sibling}function ju(e,t){return{value:e,source:t,stack:Zi(t)}}function qu(e,t){try{0;var n=t.value,r=t.source,i=t.stack,s=null!==i?i:"";if(null!=n&&n._suppressLogging&&1===e.tag)return;var a=r?H(r):null;3===e.tag||H(e)}catch(e){setTimeout(function(){throw e})}}var Xu,Yu,Ku,Qu,Zu="function"==typeof WeakMap?WeakMap:Map;function Ju(e,t,n){var r=Ws(Mr,n);r.tag=3,r.payload={element:null};var i=t.value;return r.callback=function(){lp(i),qu(e,t)},r}function ec(e,t,n){var r=Ws(Mr,n);r.tag=3;var i=e.type.getDerivedStateFromError;if("function"==typeof i){var s=t.value;r.payload=function(){return i(s)},r.callback=function(){Dp(e),qu(e,t)}}var a=e.stateNode;return null!==a&&"function"==typeof a.componentDidCatch&&(r.callback=function(){Dp(e),qu(e,t),"function"!=typeof i&&function(e){null===bf?bf=new Set([e]):bf.add(e)}(this);var n=t.value,r=t.stack;this.componentDidCatch(n,{componentStack:null!==r?r:""}),"function"!=typeof i&&(Gr(e.lanes,1)||l("%s: Error boundaries should implement getDerivedStateFromError(). In that method, return a state update to display an error message or fallback UI.",H(e)||"Unknown"))}),r}function tc(e,t,n){var r,i=e.pingCache;if(null===i?(i=e.pingCache=new Zu,r=new Set,i.set(t,r)):void 0===(r=i.get(t))&&(r=new Set,i.set(t,r)),!r.has(n)){r.add(n);var s=dp.bind(null,e,t,n);xi&&Sp(e,n),t.then(s,s)}}function nc(e){var t=e;do{if(t.tag===v&&Bo(t))return t;t=t.return}while(null!==t);return null}function rc(e,t,n,r,i){if(!(1&e.mode)){if(e===t)e.flags|=ee;else{if(e.flags|=W,n.flags|=te,n.flags&=-52805,1===n.tag)if(null===n.alternate)n.tag=_;else{var s=Ws(Mr,1);s.tag=zs,js(n,s)}n.lanes=$r(n.lanes,1)}return e}return e.flags|=ee,e.lanes=i,e}function ic(e,t,n,r,i){if(n.flags|=J,xi&&Sp(e,i),null!==r&&"object"==typeof r&&"function"==typeof r.then){var s=r;!function(e){var t=e.tag;if(!(1&e.mode||0!==t&&t!==m&&t!==b)){var n=e.alternate;n?(e.updateQueue=n.updateQueue,e.memoizedState=n.memoizedState,e.lanes=n.lanes):(e.updateQueue=null,e.memoizedState=null)}}(n);var a=nc(t);if(null!==a)return a.flags&=-257,rc(a,t,n,0,i),1&a.mode&&tc(e,s,i),void function(e,t,n){var r=e.updateQueue;if(null===r){var i=new Set;i.add(n),e.updateQueue=i}else r.add(n)}(a,0,s);if(!(1&i))return tc(e,s,i),void Jf();r=new Error("A component suspended while responding to synchronous input. This will cause the UI to be replaced with a loading indicator. To fix, updates that suspend should be wrapped with startTransition.")}else if(oo()&&1&n.mode){Wa=!0;var o=nc(t);if(null!==o)return 0===(o.flags&ee)&&(o.flags|=j),rc(o,t,n,0,i),void lo(r)}!function(e){rf!==Xh&&(rf=jh);null===uf?uf=[e]:uf.push(e)}(r),r=ju(r,n);var l=t;do{switch(l.tag){case 3:var u=r;l.flags|=ee;var c=Br(i);return l.lanes=$r(l.lanes,c),void Xs(l,Ju(l,u,c));case 1:var d=r,h=l.type,f=l.stateNode;if(0===(l.flags&W)&&("function"==typeof h.getDerivedStateFromError||null!==f&&"function"==typeof f.componentDidCatch&&!op(f))){l.flags|=ee;var p=Br(i);return l.lanes=$r(l.lanes,p),void Xs(l,ec(l,d,p))}}l=l.return}while(null!==l)}function sc(e){e.flags|=4}function ac(e){e.flags|=q,e.flags|=re}function oc(e,t){if(null!==e&&e.child===t.child)return!0;if(0!==(t.flags&$))return!1;for(var n=t.child;null!==n;){if(0!==(n.flags&le)||0!==(n.subtreeFlags&le))return!1;n=n.sibling}return!0}if(Ue)Xu=function(e,t,n,r){for(var i=t.child;null!==i;){if(5===i.tag||6===i.tag)Re(e,i.stateNode);else if(4===i.tag);else if(null!==i.child){i.child.return=i,i=i.child;continue}if(i===t)return;for(;null===i.sibling;){if(null===i.return||i.return===t)return;i=i.return}i.sibling.return=i.return,i=i.sibling}},Yu=function(e,t){},Ku=function(e,t,n,r,i){var s=e.memoizedProps;if(s!==r){var a=t.stateNode,o=Mo(),l=Ie(a,n,s,r,i,o);t.updateQueue=l,l&&sc(t)}},Qu=function(e,t,n,r){n!==r&&sc(t)};else if(Be){Xu=function(e,t,n,r){for(var i=t.child;null!==i;){if(5===i.tag){var s=i.stateNode;if(n&&r){var a=i.memoizedProps,o=i.type;s=Rt(s,o,a,i)}Re(e,s)}else if(6===i.tag){var l=i.stateNode;if(n&&r){var u=i.memoizedProps;l=Ct(l,u,i)}Re(e,l)}else if(4===i.tag);else if(i.tag===T&&null!==i.memoizedState){var c=i.child;null!==c&&(c.return=i),Xu(e,i,!0,!0)}else if(null!==i.child){i.child.return=i,i=i.child;continue}if(i===t)return;for(;null===i.sibling;){if(null===i.return||i.return===t)return;i=i.return}i.sibling.return=i.return,i=i.sibling}};var lc=function(e,t,n,r){for(var i=t.child;null!==i;){if(5===i.tag){var s=i.stateNode;if(n&&r){var a=i.memoizedProps,o=i.type;s=Rt(s,o,a,i)}yt(e,s)}else if(6===i.tag){var l=i.stateNode;if(n&&r){var u=i.memoizedProps;l=Ct(l,u,i)}yt(e,l)}else if(4===i.tag);else if(i.tag===T&&null!==i.memoizedState){var c=i.child;null!==c&&(c.return=i),lc(e,i,!0,!0)}else if(null!==i.child){i.child.return=i,i=i.child;continue}if(i===t)return;for(;null===i.sibling;){if(null===i.return||i.return===t)return;i=i.return}i.sibling.return=i.return,i=i.sibling}};Yu=function(e,t){var n=t.stateNode;if(oc(e,t));else{var r=n.containerInfo,i=vt(r);lc(i,t,!1,!1),n.pendingChildren=i,sc(t),bt(r,i)}},Ku=function(e,t,n,r,i){var s=e.stateNode,a=e.memoizedProps,o=oc(e,t);if(o&&a===r)t.stateNode=s;else{var l=t.stateNode,u=Mo(),c=null;if(a!==r&&(c=Ie(l,n,a,r,i,u)),o&&null===c)t.stateNode=s;else{var d=gt(s,c,n,a,r,t,o,l);Ce(d,n,r,i,u)&&sc(t),t.stateNode=d,o?sc(t):Xu(d,t,!1,!1)}}},Qu=function(e,t,n,r){if(n!==r){var i=Eo(),s=Mo();t.stateNode=Pe(r,i,s,t),sc(t)}else t.stateNode=e.stateNode}}else Yu=function(e,t){},Ku=function(e,t,n,r,i){},Qu=function(e,t,n,r){};function uc(e,t){if(!oo())switch(e.tailMode){case"hidden":for(var n=e.tail,r=null;null!==n;)null!==n.alternate&&(r=n),n=n.sibling;null===r?e.tail=null:r.sibling=null;break;case"collapsed":for(var i=e.tail,s=null;null!==i;)null!==i.alternate&&(s=i),i=i.sibling;null===s?t||null===e.tail?e.tail=null:e.tail.sibling=null:s.sibling=null}}function cc(e){var t=null!==e.alternate&&e.alternate.child===e.child,n=0,r=0;if(t){if(2&e.mode){for(var i=e.selfBaseDuration,s=e.child;null!==s;)n=$r(n,$r(s.lanes,s.childLanes)),r|=s.subtreeFlags&de,r|=s.flags&de,i+=s.treeBaseDuration,s=s.sibling;e.treeBaseDuration=i}else for(var a=e.child;null!==a;)n=$r(n,$r(a.lanes,a.childLanes)),r|=a.subtreeFlags&de,r|=a.flags&de,a.return=e,a=a.sibling;e.subtreeFlags|=r}else{if(2&e.mode){for(var o=e.actualDuration,l=e.selfBaseDuration,u=e.child;null!==u;)n=$r(n,$r(u.lanes,u.childLanes)),r|=u.subtreeFlags,r|=u.flags,o+=u.actualDuration,l+=u.treeBaseDuration,u=u.sibling;e.actualDuration=o,e.treeBaseDuration=l}else for(var c=e.child;null!==c;)n=$r(n,$r(c.lanes,c.childLanes)),r|=c.subtreeFlags,r|=c.flags,c.return=e,c=c.sibling;e.subtreeFlags|=r}return e.childLanes=n,t}function dc(e,t,n){var r=t.pendingProps;switch(ka(t),t.tag){case 2:case 16:case b:case 0:case m:case 7:case 8:case g:case 9:case y:return cc(t),null;case 1:return Gn(t.type)&&Hn(t),cc(t),null;case 3:var i=t.stateNode;if(wo(t),$n(t),qo(),i.pendingContext&&(i.context=i.pendingContext,i.pendingContext=null),null===e||null===e.child)if(ro(t))sc(t);else if(null!==e)e.memoizedState.isDehydrated&&0===(t.flags&j)||(t.flags|=X,ao());return Yu(e,t),cc(t),null;case 5:Co(t);var s=Eo(),a=t.type;if(null!==e&&null!=t.stateNode)Ku(e,t,a,r,s),e.ref!==t.ref&&ac(t);else{if(!r){if(null===t.stateNode)throw new Error("We must have new props for new mounts. This error is likely caused by a bug in React. Please file an issue.");return cc(t),null}var o=Mo();if(ro(t))(function(e,t,n){if(!Ve)throw new Error("Expected prepareToHydrateHostInstance() to never be called. This error is likely caused by a bug in React. Please file an issue.");var r=e.stateNode,i=!Wa,s=Vt(r,e.type,e.memoizedProps,t,n,e,i);return e.updateQueue=s,null!==s})(t,s,o)&&sc(t);else{var l=Me(a,r,s,o,t);Xu(l,t,!1,!1),t.stateNode=l,Ce(l,a,r,s,o)&&sc(t)}null!==t.ref&&ac(t)}return cc(t),null;case 6:var u=r;if(e&&null!=t.stateNode){var c=e.memoizedProps;Qu(e,t,c,u)}else{if("string"!=typeof u&&null===t.stateNode)throw new Error("We must have new props for new mounts. This error is likely caused by a bug in React. Please file an issue.");var d=Eo(),h=Mo();ro(t)?function(e){if(!Ve)throw new Error("Expected prepareToHydrateHostTextInstance() to never be called. This error is likely caused by a bug in React. Please file an issue.");var t=e.stateNode,n=e.memoizedProps,r=zt(t,n,e,!Wa);if(r){var i=Ga;if(null!==i){var s=!!(1&i.mode);switch(i.tag){case 3:var a=i.stateNode.containerInfo;Yt(a,t,n,s);break;case 5:var o=i.type,l=i.memoizedProps,u=i.stateNode;Kt(o,l,u,t,n,s)}}}return r}(t)&&sc(t):t.stateNode=Pe(u,d,h,t)}return cc(t),null;case v:Uo(t);var f=t.memoizedState;if($a&&null!==Ha&&1&t.mode&&0===(t.flags&W))return io(t),so(),t.flags|=98560,t;if(null!==f&&null!==f.dehydrated){var x=ro(t);if(null===e){if(!x)throw new Error("A dehydrated suspense component was completed without a hydrated node. This is probably a bug in React.");if(function(e){if(!Ve)throw new Error("Expected prepareToHydrateHostSuspenseInstance() to never be called. This error is likely caused by a bug in React. Please file an issue.");var t=e.memoizedState,n=null!==t?t.dehydrated:null;if(!n)throw new Error("Expected to have a hydrated suspense instance. This error is likely caused by a bug in React. Please file an issue.");Gt(n,e)}(t),cc(t),2&t.mode)if(null!==f){var A=t.child;null!==A&&(t.treeBaseDuration-=A.treeBaseDuration)}return null}if(so(),0===(t.flags&W)&&(t.memoizedState=null),t.flags|=4,cc(t),2&t.mode&&null!==f){var w=t.child;null!==w&&(t.treeBaseDuration-=w.treeBaseDuration)}return null}if(ao(),0!==(t.flags&W))return t.lanes=n,2&t.mode&&Wu(t),t;var M=null!==f,R=!1;if(null===e)ro(t);else R=null!==e.memoizedState;if(M&&!R)if(t.child.flags|=Q,1&t.mode)null===e&&(!0!==t.memoizedProps.unstable_avoidThisFallback||!0)||Do(No.current,Lo)?rf===$h&&(rf=qh):Jf();if(null!==t.updateQueue&&(t.flags|=4),cc(t),2&t.mode&&M){var C=t.child;null!==C&&(t.treeBaseDuration-=C.treeBaseDuration)}return null;case 4:return wo(t),Yu(e,t),null===e&&Ge(t.stateNode.containerInfo),cc(t),null;case p:return Ls(t.type._context,t),cc(t),null;case _:return Gn(t.type)&&Hn(t),cc(t),null;case S:Uo(t);var I=t.memoizedState;if(null===I)return cc(t),null;var L=0!==(t.flags&W),P=I.rendering;if(null===P)if(L)uc(I,!1);else{if(!(rf===$h&&(null===e||0===(e.flags&W))))for(var N=t.child;null!==N;){var D=Vo(N);if(null!==D){L=!0,t.flags|=W,uc(I,!1);var k=D.updateQueue;return null!==k&&(t.updateQueue=k,t.flags|=4),t.subtreeFlags=0,yo(t,n),Fo(t,Oo(No.current,Po)),t.child}N=N.sibling}null!==I.tail&&ci()>gf()&&(t.flags|=W,L=!0,uc(I,!1),t.lanes=_r)}else{if(!L){var O=Vo(P);if(null!==O){t.flags|=W,L=!0;var F=O.updateQueue;if(null!==F&&(t.updateQueue=F,t.flags|=4),uc(I,!0),null===I.tail&&"hidden"===I.tailMode&&!P.alternate&&!oo())return cc(t),null}else 2*ci()-I.renderingStartTime>gf()&&n!==Ar&&(t.flags|=W,L=!0,uc(I,!1),t.lanes=_r)}if(I.isBackwards)P.sibling=t.child,t.child=P;else{var U=I.last;null!==U?U.sibling=P:t.child=P,I.last=P}}if(null!==I.tail){var B=I.tail;I.rendering=B,I.tail=B.sibling,I.renderingStartTime=ci(),B.sibling=null;var V=No.current;return Fo(t,V=L?Oo(V,Po):ko(V)),B}return cc(t),null;case 21:break;case T:case E:qf(t);var z=null!==t.memoizedState;if(null!==e)null!==e.memoizedState!==z&&(t.flags|=Q);return z&&1&t.mode?Gr(tf,Ar)&&(cc(t),Ue&&6&t.subtreeFlags&&(t.flags|=Q)):cc(t),null;case 24:case 25:return null}throw new Error("Unknown unit of work tag ("+t.tag+"). This error is likely caused by a bug in React. Please file an issue.")}var hc,fc,pc,mc,gc,vc,yc,bc,_c=s.ReactCurrentOwner,xc=!1;function Sc(e,t,n,r){t.child=null===e?vo(t,null,n,r):go(t,e.child,n,r)}function Tc(e,t,n,r,i){if(t.type!==t.elementType){var s=n.propTypes;s&&wn(s,r,"prop",z(n))}var a,o,l=n.render,u=t.ref;if(Ds(t,i),wi(t),_c.current=t,ss(!0),a=ml(e,t,l,r,u,i),o=gl(),8&t.mode){Si(!0);try{a=ml(e,t,l,r,u,i),o=gl()}finally{Si(!1)}}return ss(!1),Mi(),null===e||xc?(oo()&&o&&Na(t),t.flags|=1,Sc(e,t,a,i),t.child):(vl(e,t,i),ed(e,t,i))}function Ec(e,t,n,r,i){if(null===e){var s=n.type;if(function(e){return"function"==typeof e&&!$p(e)&&void 0===e.defaultProps}(s)&&null===n.compare&&void 0===n.defaultProps){var a;return a=Ip(s),t.tag=b,t.type=a,kc(t,s),Ac(e,t,a,r,i)}var o=s.propTypes;o&&wn(o,r,"prop",z(s));var l=qp(n.type,null,r,t,t.mode,i);return l.ref=t.ref,l.return=t,t.child=l,l}var u=n.type,c=u.propTypes;c&&wn(c,r,"prop",z(u));var d=e.child;if(!td(e,i)){var h=d.memoizedProps,f=n.compare;if((f=null!==f?f:Ki)(h,r)&&e.ref===t.ref)return ed(e,t,i)}t.flags|=1;var p=Wp(d,r);return p.ref=t.ref,p.return=t,t.child=p,p}function Ac(e,t,n,r,i){if(t.type!==t.elementType){var s=t.elementType;if(s.$$typeof===O){var a=s,o=a._payload,l=a._init;try{s=l(o)}catch(e){s=null}var u=s&&s.propTypes;u&&wn(u,r,"prop",z(s))}}if(null!==e&&(Ki(e.memoizedProps,r)&&e.ref===t.ref&&t.type===e.type)){if(xc=!1,!td(e,i))return t.lanes=e.lanes,ed(e,t,i);0!==(e.flags&te)&&(xc=!0)}return Rc(e,t,n,r,i)}function wc(e,t,n){var r,i=t.pendingProps,s=i.children,a=null!==e?e.memoizedState:null;if("hidden"===i.mode)if(1&t.mode){if(!Gr(n,Ar)){var o;if(null!==a)o=$r(a.baseLanes,n);else o=n;t.lanes=t.childLanes=Ar;var l={baseLanes:o,cachePool:null};return t.memoizedState=l,t.updateQueue=null,jf(t,o),null}var u={baseLanes:0,cachePool:null};t.memoizedState=u,jf(t,null!==a?a.baseLanes:n)}else{var c={baseLanes:0,cachePool:null};t.memoizedState=c,jf(t,n)}else null!==a?(r=$r(a.baseLanes,n),t.memoizedState=null):r=n,jf(t,r);return Sc(e,t,s,n),t.child}function Mc(e,t){var n=t.ref;(null===e&&null!==n||null!==e&&e.ref!==n)&&(t.flags|=q,t.flags|=re)}function Rc(e,t,n,r,i){if(t.type!==t.elementType){var s=n.propTypes;s&&wn(s,r,"prop",z(n))}var a,o,l;if(a=Vn(t,Un(0,n,!0)),Ds(t,i),wi(t),_c.current=t,ss(!0),o=ml(e,t,n,r,a,i),l=gl(),8&t.mode){Si(!0);try{o=ml(e,t,n,r,a,i),l=gl()}finally{Si(!1)}}return ss(!1),Mi(),null===e||xc?(oo()&&l&&Na(t),t.flags|=1,Sc(e,t,o,i),t.child):(vl(e,t,i),ed(e,t,i))}function Cc(e,t,n,r,i){switch(um(t)){case!1:var s=t.stateNode,a=new(0,t.type)(t.memoizedProps,s.context).state;s.updater.enqueueSetState(s,a,null);break;case!0:t.flags|=W,t.flags|=ee;var o=new Error("Simulated error coming from DevTools"),u=Br(i);t.lanes=$r(t.lanes,u),Xs(t,ec(t,ju(o,t),u))}if(t.type!==t.elementType){var c=n.propTypes;c&&wn(c,r,"prop",z(n))}var d,h;Gn(n)?(d=!0,qn(t)):d=!1,Ds(t,i),null===t.stateNode?(null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),ya(t,n,r),_a(t,n,r,i),h=!0):h=null===e?function(e,t,n,r){var i=e.stateNode,s=e.memoizedProps;i.props=s;var a=i.context,o=t.contextType,l=Dn;l="object"==typeof o&&null!==o?ks(o):Vn(e,Un(0,t,!0));var u=t.getDerivedStateFromProps,c="function"==typeof u||"function"==typeof i.getSnapshotBeforeUpdate;c||"function"!=typeof i.UNSAFE_componentWillReceiveProps&&"function"!=typeof i.componentWillReceiveProps||s===n&&a===l||ba(e,i,n,l),Zs();var d=e.memoizedState,h=i.state=d;if(Ks(e,n,i,r),h=e.memoizedState,s===n&&d===h&&!zn()&&!Js()){if("function"==typeof i.componentDidMount){var f=4;f|=ie,0!==(e.mode&Kn)&&(f|=se),e.flags|=f}return!1}"function"==typeof u&&(pa(e,t,u,n),h=e.memoizedState);var p=Js()||ga(e,t,s,n,d,h,l);if(p){if(c||"function"!=typeof i.UNSAFE_componentWillMount&&"function"!=typeof i.componentWillMount||("function"==typeof i.componentWillMount&&i.componentWillMount(),"function"==typeof i.UNSAFE_componentWillMount&&i.UNSAFE_componentWillMount()),"function"==typeof i.componentDidMount){var m=4;m|=ie,0!==(e.mode&Kn)&&(m|=se),e.flags|=m}}else{if("function"==typeof i.componentDidMount){var g=4;g|=ie,0!==(e.mode&Kn)&&(g|=se),e.flags|=g}e.memoizedProps=n,e.memoizedState=h}return i.props=n,i.state=h,i.context=l,p}(t,n,r,i):function(e,t,n,r,i){var s=t.stateNode;$s(e,t);var a=t.memoizedProps,o=t.type===t.elementType?a:_s(t.type,a);s.props=o;var l=t.pendingProps,u=s.context,c=n.contextType,d=Dn;d="object"==typeof c&&null!==c?ks(c):Vn(t,Un(0,n,!0));var h=n.getDerivedStateFromProps,p="function"==typeof h||"function"==typeof s.getSnapshotBeforeUpdate;p||"function"!=typeof s.UNSAFE_componentWillReceiveProps&&"function"!=typeof s.componentWillReceiveProps||a===l&&u===d||ba(t,s,r,d),Zs();var m=t.memoizedState,g=s.state=m;if(Ks(t,r,s,i),g=t.memoizedState,a===l&&m===g&&!zn()&&!Js())return"function"==typeof s.componentDidUpdate&&(a===e.memoizedProps&&m===e.memoizedState||(t.flags|=4)),"function"==typeof s.getSnapshotBeforeUpdate&&(a===e.memoizedProps&&m===e.memoizedState||(t.flags|=X)),!1;"function"==typeof h&&(pa(t,n,h,r),g=t.memoizedState);var v=Js()||ga(t,n,o,r,m,g,d)||f;return v?(p||"function"!=typeof s.UNSAFE_componentWillUpdate&&"function"!=typeof s.componentWillUpdate||("function"==typeof s.componentWillUpdate&&s.componentWillUpdate(r,g,d),"function"==typeof s.UNSAFE_componentWillUpdate&&s.UNSAFE_componentWillUpdate(r,g,d)),"function"==typeof s.componentDidUpdate&&(t.flags|=4),"function"==typeof s.getSnapshotBeforeUpdate&&(t.flags|=X)):("function"==typeof s.componentDidUpdate&&(a===e.memoizedProps&&m===e.memoizedState||(t.flags|=4)),"function"==typeof s.getSnapshotBeforeUpdate&&(a===e.memoizedProps&&m===e.memoizedState||(t.flags|=X)),t.memoizedProps=r,t.memoizedState=g),s.props=r,s.state=g,s.context=d,v}(e,t,n,r,i);var p=Ic(e,t,n,h,d,i),m=t.stateNode;return h&&m.props!==r&&(vc||l("It looks like %s is reassigning its own `this.props` while rendering. This is not supported and can lead to confusing bugs.",H(t)||"a component"),vc=!0),p}function Ic(e,t,n,r,i,s){Mc(e,t);var a=0!==(t.flags&W);if(!r&&!a)return i&&Xn(t,n,!1),ed(e,t,s);var o,l=t.stateNode;if(_c.current=t,a&&"function"!=typeof n.getDerivedStateFromError)o=null,Bu();else{if(wi(t),ss(!0),o=l.render(),8&t.mode){Si(!0);try{l.render()}finally{Si(!1)}}ss(!1),Mi()}return t.flags|=1,null!==e&&a?function(e,t,n,r){t.child=go(t,e.child,null,r),t.child=go(t,null,n,r)}(e,t,o,s):Sc(e,t,o,s),t.memoizedState=l.state,i&&Xn(t,n,!0),t.child}function Lc(e){var t=e.stateNode;t.pendingContext?Wn(e,t.pendingContext,t.pendingContext!==t.context):t.context&&Wn(e,t.context,!1),Ao(e,t.containerInfo)}function Pc(e,t,n){if(Lc(t),null===e)throw new Error("Should have a current fiber. This is a bug in React.");var r=t.pendingProps,i=t.memoizedState,s=i.element;$s(e,t),Ks(t,r,null,n);var a=t.memoizedState;t.stateNode;var o=a.element;if(Ve&&i.isDehydrated){var l={element:o,isDehydrated:!1,cache:a.cache,transitions:a.transitions};if(t.updateQueue.baseState=l,t.memoizedState=l,t.flags&j)return Nc(e,t,o,n,new Error("There was an error while hydrating. Because the error happened outside of a Suspense boundary, the entire root will switch to client rendering."));if(o!==s)return Nc(e,t,o,n,new Error("This root received an early update, before anything was able hydrate. Switched the entire root to client rendering."));!function(e){if(!Ve)return!1;var t=e.stateNode.containerInfo;Ha=Ut(t),Ga=e,$a=!0,ja=null,Wa=!1}(t);var u=vo(t,null,o,n);t.child=u;for(var c=u;c;)c.flags=-3&c.flags|K,c=c.sibling}else{if(so(),o===s)return ed(e,t,n);Sc(e,t,o,n)}return t.child}function Nc(e,t,n,r,i){return so(),lo(i),t.flags|=j,Sc(e,t,n,r),t.child}function Dc(e,t,n,r){null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2);var i=t.pendingProps,s=n,a=s._payload,o=(0,s._init)(a);t.type=o;var l=t.tag=function(e){if("function"==typeof e)return $p(e)?1:0;if(null!=e){var t=e.$$typeof;if(t===P)return m;if(t===k)return y}return 2}(o),u=_s(o,i);switch(l){case 0:return kc(t,o),t.type=o=Ip(o),Rc(null,t,o,u,r);case 1:return t.type=o=Lp(o),Cc(null,t,o,u,r);case m:return t.type=o=Pp(o),Tc(null,t,o,u,r);case y:if(t.type!==t.elementType){var c=o.propTypes;c&&wn(c,u,"prop",z(o))}return Ec(null,t,o,_s(o.type,u),r)}var d="";throw null!==o&&"object"==typeof o&&o.$$typeof===O&&(d=" Did you wrap a component in React.lazy() more than once?"),new Error("Element type is invalid. Received a promise that resolves to: "+o+". Lazy element type must resolve to a class or function."+d)}function kc(e,t){if(t&&t.childContextTypes&&l("%s(...): childContextTypes cannot be defined on a function component.",t.displayName||t.name||"Component"),null!==e.ref){var n="",r=function(){if(null===es)return null;var e=es._debugOwner;return null!=e?H(e):null}();r&&(n+="\n\nCheck the render method of `"+r+"`.");var i=r||"",s=e._debugSource;s&&(i=s.fileName+":"+s.lineNumber),gc[i]||(gc[i]=!0,l("Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use React.forwardRef()?%s",n))}if("function"==typeof t.getDerivedStateFromProps){var a=z(t)||"Unknown";mc[a]||(l("%s: Function components do not support getDerivedStateFromProps.",a),mc[a]=!0)}if("object"==typeof t.contextType&&null!==t.contextType){var o=z(t)||"Unknown";pc[o]||(l("%s: Function components do not support contextType.",o),pc[o]=!0)}}hc={},fc={},pc={},mc={},gc={},vc=!1,yc={},bc={};var Oc={dehydrated:null,treeContext:null,retryLane:0};function Fc(e){return{baseLanes:e,cachePool:null}}function Uc(e,t){return{baseLanes:$r(e.baseLanes,t),cachePool:null}}function Bc(e,t){return Wr(e.childLanes,t)}function Vc(e,t,n){var r=t.pendingProps;dm(t)&&(t.flags|=W);var i=No.current,s=!1,a=0!==(t.flags&W);if(a||function(e,t){return(null===t||null!==t.memoizedState)&&Do(e,Po)}(i,e)?(s=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(i=i|Lo),Fo(t,i=ko(i)),null===e){to(t);var o=t.memoizedState;if(null!==o){var u=o.dehydrated;if(null!==u)return function(e,t){1&e.mode?Dt(t)?e.lanes=8:e.lanes=Ar:(l("Cannot hydrate Suspense in legacy mode. Switch from ReactDOM.hydrate(element, container) to ReactDOMClient.hydrateRoot(container, <App />).render(element) or remove the Suspense components from the server rendered components."),e.lanes=1);return null}(t,u)}var c=r.children,d=r.fallback;if(s){var h=function(e,t,n,r){var i,s,a=e.mode,o=e.child,l={mode:"hidden",children:t};1&a||null===o?(i=Gc(l,a),s=Yp(n,a,r,null)):((i=o).childLanes=0,i.pendingProps=l,2&e.mode&&(i.actualDuration=0,i.actualStartTime=-1,i.selfBaseDuration=0,i.treeBaseDuration=0),s=Yp(n,a,r,null));return i.return=e,s.return=e,i.sibling=s,e.child=i,s}(t,c,d,n);return t.child.memoizedState=Fc(n),t.memoizedState=Oc,h}return zc(t,c)}var f=e.memoizedState;if(null!==f){var p=f.dehydrated;if(null!==p){if(a){if(t.flags&j)return t.flags&=-257,jc(e,t,n,new Error("There was an error while hydrating this Suspense boundary. Switched to client rendering."));if(null!==t.memoizedState)return t.child=e.child,t.flags|=W,null;var m=function(e,t,n,r,i){var s=t.mode,a=Gc({mode:"visible",children:n},s),o=Yp(r,s,i,null);o.flags|=2,a.return=t,o.return=t,a.sibling=o,t.child=a,!(1&t.mode)||go(t,e.child,null,i);return o}(e,t,r.children,r.fallback,n);return t.child.memoizedState=Fc(n),t.memoizedState=Oc,m}return function(e,t,n,r,i){if(function(){$a&&l("We should not be hydrating here. This is a bug in React. Please file a bug.")}(),!(1&t.mode))return jc(e,t,i,null);if(Dt(n))return jc(e,t,i,new Error("The server could not finish this Suspense boundary, likely due to an error during server rendering. Switched to client rendering."));var s=Gr(i,e.childLanes);if(xc||s){var a=Lf();if(null!==a){var o=function(e,t){var n;switch(Ur(t)){case 4:n=2;break;case er:n=8;break;case 64:case 128:case 256:case 512:case nr:case rr:case ir:case sr:case ar:case or:case lr:case ur:case cr:case dr:case hr:case fr:case mr:case gr:case vr:case yr:case br:n=32;break;case Er:n=Tr;break;default:n=0}return 0!==(n&(e.suspendedLanes|t))?0:n}(a,i);if(0!==o&&o!==r.retryLane)r.retryLane=o,kf(e,o,Mr)}return Jf(),jc(e,t,i,new Error("This Suspense boundary received an update before it finished hydrating. This caused the boundary to switch to client rendering. The usual way to fix this is to wrap the original update in startTransition."))}if(Nt(n)){t.flags|=W,t.child=e.child;var u=fp.bind(null,e);return kt(n,u),null}qa(t,n,r.treeContext);var c=zc(t,t.pendingProps.children);return c.flags|=K,c}(e,t,p,f,n)}if(s){var g=r.fallback,v=Wc(e,t,r.children,g,n),y=t.child,b=e.child.memoizedState;return y.memoizedState=null===b?Fc(n):Uc(b,n),y.childLanes=Bc(e,n),t.memoizedState=Oc,v}var _=$c(e,t,r.children,n);return t.memoizedState=null,_}if(s){var x=r.fallback,S=Wc(e,t,r.children,x,n),T=t.child,E=e.child.memoizedState;return T.memoizedState=null===E?Fc(n):Uc(E,n),T.childLanes=Bc(e,n),t.memoizedState=Oc,S}var A=$c(e,t,r.children,n);return t.memoizedState=null,A}function zc(e,t,n){var r=Gc({mode:"visible",children:t},e.mode);return r.return=e,e.child=r,r}function Gc(e,t,n){return Kp(e,t,0,null)}function Hc(e,t){return Wp(e,t)}function $c(e,t,n,r){var i=e.child,s=i.sibling,a=Hc(i,{mode:"visible",children:n});if(1&t.mode||(a.lanes=r),a.return=t,a.sibling=null,null!==s){var o=t.deletions;null===o?(t.deletions=[s],t.flags|=$):o.push(s)}return t.child=a,a}function Wc(e,t,n,r,i){var s,a,o=t.mode,l=e.child,u=l.sibling,c={mode:"hidden",children:n};1&o||t.child===l?(s=Hc(l,c)).subtreeFlags=l.subtreeFlags&de:((s=t.child).childLanes=0,s.pendingProps=c,2&t.mode&&(s.actualDuration=0,s.actualStartTime=-1,s.selfBaseDuration=l.selfBaseDuration,s.treeBaseDuration=l.treeBaseDuration),t.deletions=null);return null!==u?a=Wp(u,r):(a=Yp(r,o,i,null)).flags|=2,a.return=t,s.return=t,s.sibling=a,t.child=s,a}function jc(e,t,n,r){null!==r&&lo(r),go(t,e.child,null,n);var i=zc(t,t.pendingProps.children);return i.flags|=2,t.memoizedState=null,i}function qc(e,t,n){e.lanes=$r(e.lanes,t);var r=e.alternate;null!==r&&(r.lanes=$r(r.lanes,t)),Ps(e.return,t,n)}function Xc(e,t){var n=xe(e),r=!n&&"function"==typeof B(e);if(n||r){var i=n?"array":"iterable";return l("A nested %s was passed to row #%s in <SuspenseList />. Wrap it in an additional SuspenseList to configure its revealOrder: <SuspenseList revealOrder=...> ... <SuspenseList revealOrder=...>{%s}</SuspenseList> ... </SuspenseList>",i,t,i),!1}return!0}function Yc(e,t,n,r,i){var s=e.memoizedState;null===s?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:r,tail:n,tailMode:i}:(s.isBackwards=t,s.rendering=null,s.renderingStartTime=0,s.last=r,s.tail=n,s.tailMode=i)}function Kc(e,t,n){var r=t.pendingProps,i=r.revealOrder,s=r.tail,a=r.children;!function(e){if(void 0!==e&&"forwards"!==e&&"backwards"!==e&&"together"!==e&&!yc[e])if(yc[e]=!0,"string"==typeof e)switch(e.toLowerCase()){case"together":case"forwards":case"backwards":l('"%s" is not a valid value for revealOrder on <SuspenseList />. Use lowercase "%s" instead.',e,e.toLowerCase());break;case"forward":case"backward":l('"%s" is not a valid value for revealOrder on <SuspenseList />. React uses the -s suffix in the spelling. Use "%ss" instead.',e,e.toLowerCase());break;default:l('"%s" is not a supported revealOrder on <SuspenseList />. Did you mean "together", "forwards" or "backwards"?',e)}else l('%s is not a supported value for revealOrder on <SuspenseList />. Did you mean "together", "forwards" or "backwards"?',e)}(i),function(e,t){void 0===e||bc[e]||("collapsed"!==e&&"hidden"!==e?(bc[e]=!0,l('"%s" is not a supported value for tail on <SuspenseList />. Did you mean "collapsed" or "hidden"?',e)):"forwards"!==t&&"backwards"!==t&&(bc[e]=!0,l('<SuspenseList tail="%s" /> is only valid if revealOrder is "forwards" or "backwards". Did you mean to specify revealOrder="forwards"?',e)))}(s,i),function(e,t){if(("forwards"===t||"backwards"===t)&&null!=e&&!1!==e)if(xe(e)){for(var n=0;n<e.length;n++)if(!Xc(e[n],n))return}else{var r=B(e);if("function"==typeof r){var i=r.call(e);if(i)for(var s=i.next(),a=0;!s.done;s=i.next()){if(!Xc(s.value,a))return;a++}}else l('A single row was passed to a <SuspenseList revealOrder="%s" />. This is not useful since it needs multiple rows. Did you mean to pass multiple children or an array?',t)}}(a,i),Sc(e,t,a,n);var o=No.current;Do(o,Po)?(o=Oo(o,Po),t.flags|=W):(null!==e&&0!==(e.flags&W)&&function(e,t,n){for(var r=t;null!==r;){if(r.tag===v)null!==r.memoizedState&&qc(r,n,e);else if(r.tag===S)qc(r,n,e);else if(null!==r.child){r.child.return=r,r=r.child;continue}if(r===e)return;for(;null===r.sibling;){if(null===r.return||r.return===e)return;r=r.return}r.sibling.return=r.return,r=r.sibling}}(t,t.child,n),o=ko(o));if(Fo(t,o),1&t.mode)switch(i){case"forwards":var u,c=function(e){for(var t=e,n=null;null!==t;){var r=t.alternate;null!==r&&null===Vo(r)&&(n=t),t=t.sibling}return n}(t.child);null===c?(u=t.child,t.child=null):(u=c.sibling,c.sibling=null),Yc(t,!1,u,c,s);break;case"backwards":var d=null,h=t.child;for(t.child=null;null!==h;){var f=h.alternate;if(null!==f&&null===Vo(f)){t.child=h;break}var p=h.sibling;h.sibling=d,d=h,h=p}Yc(t,!0,d,null,s);break;case"together":Yc(t,!1,null,null,void 0);break;default:t.memoizedState=null}else t.memoizedState=null;return t.child}var Qc=!1;var Zc=!1;function Jc(){xc=!0}function ed(e,t,n){return null!==e&&(t.dependencies=e.dependencies),Bu(),Zf(t.lanes),Gr(n,t.childLanes)?(function(e,t){if(null!==e&&t.child!==e.child)throw new Error("Resuming work not yet implemented.");if(null!==t.child){var n=t.child,r=Wp(n,n.pendingProps);for(t.child=r,r.return=t;null!==n.sibling;)n=n.sibling,(r=r.sibling=Wp(n,n.pendingProps)).return=t;r.sibling=null}}(e,t),t.child):null}function td(e,t){return!!Gr(e.lanes,t)}function nd(e,t,n){if(t._debugNeedsRemount&&null!==e)return function(e,t,n){var r=t.return;if(null===r)throw new Error("Cannot swap the root fiber.");if(e.alternate=null,t.alternate=null,n.index=t.index,n.sibling=t.sibling,n.return=t.return,n.ref=t.ref,t===r.child)r.child=n;else{var i=r.child;if(null===i)throw new Error("Expected parent to have a child.");for(;i.sibling!==t;)if(null===(i=i.sibling))throw new Error("Expected to find the previous sibling.");i.sibling=n}var s=r.deletions;return null===s?(r.deletions=[e],r.flags|=$):s.push(e),n.flags|=2,n}(e,t,qp(t.type,t.key,t.pendingProps,t._debugOwner||null,t.mode,t.lanes));if(null!==e)if(e.memoizedProps!==t.pendingProps||zn()||t.type!==e.type)xc=!0;else{if(!td(e,n)&&0===(t.flags&W))return xc=!1,function(e,t,n){switch(t.tag){case 3:Lc(t),t.stateNode,so();break;case 5:Ro(t);break;case 1:Gn(t.type)&&qn(t);break;case 4:Ao(t,t.stateNode.containerInfo);break;case p:var r=t.memoizedProps.value;Is(t,t.type._context,r);break;case g:Gr(n,t.childLanes)&&(t.flags|=4);var i=t.stateNode;i.effectDuration=0,i.passiveEffectDuration=0;break;case v:var s=t.memoizedState;if(null!==s){if(null!==s.dehydrated)return Fo(t,ko(No.current)),t.flags|=W,null;if(Gr(n,t.child.childLanes))return Vc(e,t,n);Fo(t,ko(No.current));var a=ed(e,t,n);return null!==a?a.sibling:null}Fo(t,ko(No.current));break;case S:var o=0!==(e.flags&W),l=Gr(n,t.childLanes);if(o){if(l)return Kc(e,t,n);t.flags|=W}var u=t.memoizedState;if(null!==u&&(u.rendering=null,u.tail=null,u.lastEffect=null),Fo(t,No.current),l)break;return null;case T:case E:return t.lanes=0,wc(e,t,n)}return ed(e,t,n)}(e,t,n);xc=0!==(e.flags&te)}else if(xc=!1,oo()&&function(e){return Oa(),0!==(e.flags&ne)}(t)){var r=t.index;Pa(t,(Oa(),Ea),r)}switch(t.lanes=0,t.tag){case 2:return function(e,t,n,r){null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2);var i,s,a,o=t.pendingProps;if(i=Vn(t,Un(0,n,!1)),Ds(t,r),wi(t),n.prototype&&"function"==typeof n.prototype.render){var u=z(n)||"Unknown";hc[u]||(l("The <%s /> component appears to have a render method, but doesn't extend React.Component. This is likely to cause errors. Change %s to extend React.Component instead.",u,u),hc[u]=!0)}if(8&t.mode&&as.recordLegacyContextWarning(t,null),ss(!0),_c.current=t,s=ml(null,t,n,o,i,r),a=gl(),ss(!1),Mi(),t.flags|=1,"object"==typeof s&&null!==s&&"function"==typeof s.render&&void 0===s.$$typeof){var c=z(n)||"Unknown";fc[c]||(l("The <%s /> component appears to be a function component that returns a class instance. Change %s to a class that extends React.Component instead. If you can't use a class try assigning the prototype on the function as a workaround. `%s.prototype = React.Component.prototype`. Don't use an arrow function since it cannot be called with `new` by React.",c,c,c),fc[c]=!0)}if("object"==typeof s&&null!==s&&"function"==typeof s.render&&void 0===s.$$typeof){var d=z(n)||"Unknown";fc[d]||(l("The <%s /> component appears to be a function component that returns a class instance. Change %s to a class that extends React.Component instead. If you can't use a class try assigning the prototype on the function as a workaround. `%s.prototype = React.Component.prototype`. Don't use an arrow function since it cannot be called with `new` by React.",d,d,d),fc[d]=!0),t.tag=1,t.memoizedState=null,t.updateQueue=null;var h=!1;return Gn(n)?(h=!0,qn(t)):h=!1,t.memoizedState=null!==s.state&&void 0!==s.state?s.state:null,Hs(t),va(t,s),_a(t,n,o,r),Ic(null,t,n,!0,h,r)}if(t.tag=0,8&t.mode){Si(!0);try{s=ml(null,t,n,o,i,r),a=gl()}finally{Si(!1)}}return oo()&&a&&Na(t),Sc(null,t,s,r),kc(t,n),t.child}(e,t,t.type,n);case 16:return Dc(e,t,t.elementType,n);case 0:var i=t.type,s=t.pendingProps;return Rc(e,t,i,t.elementType===i?s:_s(i,s),n);case 1:var a=t.type,o=t.pendingProps;return Cc(e,t,a,t.elementType===a?o:_s(a,o),n);case 3:return Pc(e,t,n);case 5:return function(e,t,n){Ro(t),null===e&&to(t);var r=t.type,i=t.pendingProps,s=null!==e?e.memoizedProps:null,a=i.children;return Le(r,i)?a=null:null!==s&&Le(r,s)&&(t.flags|=32),Mc(e,t),Sc(e,t,a,n),t.child}(e,t,n);case 6:return function(e,t){return null===e&&to(t),null}(e,t);case v:return Vc(e,t,n);case 4:return function(e,t,n){Ao(t,t.stateNode.containerInfo);var r=t.pendingProps;return null===e?t.child=go(t,null,r,n):Sc(e,t,r,n),t.child}(e,t,n);case m:var u=t.type,c=t.pendingProps;return Tc(e,t,u,t.elementType===u?c:_s(u,c),n);case 7:return function(e,t,n){return Sc(e,t,t.pendingProps,n),t.child}(e,t,n);case 8:return function(e,t,n){return Sc(e,t,t.pendingProps.children,n),t.child}(e,t,n);case g:return function(e,t,n){t.flags|=4;var r=t.stateNode;return r.effectDuration=0,r.passiveEffectDuration=0,Sc(e,t,t.pendingProps.children,n),t.child}(e,t,n);case p:return function(e,t,n){var r=t.type._context,i=t.pendingProps,s=t.memoizedProps,a=i.value;"value"in i||Qc||(Qc=!0,l("The `value` prop is required for the `<Context.Provider>`. Did you misspell it or forget to pass it?"));var o=t.type.propTypes;if(o&&wn(o,i,"prop","Context.Provider"),Is(t,r,a),null!==s){var u=s.value;if(zi(u,a)){if(s.children===i.children&&!zn())return ed(e,t,n)}else Ns(t,r,n)}return Sc(e,t,i.children,n),t.child}(e,t,n);case 9:return function(e,t,n){var r=t.type;void 0===r._context?r!==r.Consumer&&(Zc||(Zc=!0,l("Rendering <Context> directly is not supported and will be removed in a future major release. Did you mean to render <Context.Consumer> instead?"))):r=r._context;var i=t.pendingProps.children;"function"!=typeof i&&l("A context consumer was rendered with multiple children, or a child that isn't a function. A context consumer expects a single child that is a function. If you did pass a function, make sure there is no trailing or leading whitespace around it."),Ds(t,n);var s,a=ks(r);return wi(t),_c.current=t,ss(!0),s=i(a),ss(!1),Mi(),t.flags|=1,Sc(e,t,s,n),t.child}(e,t,n);case y:var d=t.type,h=_s(d,t.pendingProps);if(t.type!==t.elementType){var f=d.propTypes;f&&wn(f,h,"prop",z(d))}return Ec(e,t,d,h=_s(d.type,h),n);case b:return Ac(e,t,t.type,t.pendingProps,n);case _:var x=t.type,A=t.pendingProps;return function(e,t,n,r,i){var s;return null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),t.tag=1,Gn(n)?(s=!0,qn(t)):s=!1,Ds(t,i),ya(t,n,r),_a(t,n,r,i),Ic(null,t,n,!0,s,i)}(e,t,x,t.elementType===x?A:_s(x,A),n);case S:return Kc(e,t,n);case 21:break;case T:return wc(e,t,n)}throw new Error("Unknown unit of work tag ("+t.tag+"). This error is likely caused by a bug in React. Please file an issue.")}function rd(e,t,n){switch(ka(t),t.tag){case 1:Gn(t.type)&&Hn(t);var r=t.flags;return r&ee?(t.flags=-65537&r|W,2&t.mode&&Wu(t),t):null;case 3:wo(t),$n(t),qo();var i=t.flags;return 0!==(i&ee)&&0===(i&W)?(t.flags=-65537&i|W,t):null;case 5:return Co(t),null;case v:Uo(t);var s=t.memoizedState;if(null!==s&&null!==s.dehydrated){if(null===t.alternate)throw new Error("Threw in newly mounted dehydrated component. This is likely a bug in React. Please file an issue.");so()}var a=t.flags;return a&ee?(t.flags=-65537&a|W,2&t.mode&&Wu(t),t):null;case S:return Uo(t),null;case 4:return wo(t),null;case p:return Ls(t.type._context,t),null;case T:case E:return qf(t),null;default:return null}}function id(e,t,n){switch(ka(t),t.tag){case 1:var r=t.type.childContextTypes;null!=r&&Hn(t);break;case 3:wo(t),$n(t),qo();break;case 5:Co(t);break;case 4:wo(t);break;case v:case S:Uo(t);break;case p:Ls(t.type._context,t);break;case T:case E:qf(t)}}function sd(e,t,n,r,i,s,a,o,l){var u=Array.prototype.slice.call(arguments,3);try{t.apply(n,u)}catch(e){this.onError(e)}}var ad=sd;if("undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&"undefined"!=typeof document&&"function"==typeof document.createEvent){var od=document.createElement("react");ad=function(e,t,n,r,i,s,a,o,l){if("undefined"==typeof document||null===document)throw new Error("The `document` global was defined when React was initialized, but is not defined anymore. This can happen in a test environment if a component schedules an update from an asynchronous callback, but the test has already finished running. To solve this, you can either unmount the component at the end of your test (and ensure that any asynchronous operations get canceled in `componentWillUnmount`), or you can change the test itself to be asynchronous.");var u=document.createEvent("Event"),c=!1,d=!0,h=window.event,f=Object.getOwnPropertyDescriptor(window,"event");function p(){od.removeEventListener(x,v,!1),void 0!==window.event&&window.hasOwnProperty("event")&&(window.event=h)}var m,g=Array.prototype.slice.call(arguments,3);function v(){c=!0,p(),t.apply(n,g),d=!1}var y=!1,b=!1;function _(e){if(m=e.error,y=!0,null===m&&0===e.colno&&0===e.lineno&&(b=!0),e.defaultPrevented&&null!=m&&"object"==typeof m)try{m._suppressLogging=!0}catch(e){}}var x="react-"+(e||"invokeguardedcallback");if(window.addEventListener("error",_),od.addEventListener(x,v,!1),u.initEvent(x,!1,!1),od.dispatchEvent(u),f&&Object.defineProperty(window,"event",f),c&&d&&(y?b&&(m=new Error("A cross-origin error was thrown. React doesn't have access to the actual error object in development. See https://reactjs.org/link/crossorigin-error for more information.")):m=new Error("An error was thrown inside one of your components, but React doesn't know what it was. This is likely due to browser flakiness. React does its best to preserve the \"Pause on exceptions\" behavior of the DevTools, which requires some DEV-mode only tricks. It's possible that these don't work in your browser. Try triggering the error in production mode, or switching to a modern browser. If you suspect that this is actually an issue with React, please file an issue."),this.onError(m)),window.removeEventListener("error",_),!c)return p(),sd.apply(this,arguments)}}var ld=ad,ud=!1,cd=null,dd={onError:function(e){ud=!0,cd=e}};function hd(e,t,n,r,i,s,a,o,l){ud=!1,cd=null,ld.apply(dd,arguments)}function fd(){if(ud){var e=cd;return ud=!1,cd=null,e}throw new Error("clearCaughtError was called but no error was captured. This error is likely caused by a bug in React. Please file an issue.")}var pd=null;pd=new Set;var md=!1,gd=!1,vd="function"==typeof WeakSet?WeakSet:Set,yd=null,bd=null,_d=null;function xd(e){hd(null,function(){throw e}),fd()}var Sd=function(e,t){if(t.props=e.memoizedProps,t.state=e.memoizedState,2&e.mode)try{Hu(),t.componentWillUnmount()}finally{zu(e)}else t.componentWillUnmount()};function Td(e,t){try{Nd($o,e)}catch(n){xd(n),cp(e,t,n)}}function Ed(e,t,n){try{Sd(e,n)}catch(n){xd(n),cp(e,t,n)}}function Ad(e,t){try{Fd(e)}catch(n){xd(n),cp(e,t,n)}}function wd(e,t){var n=e.ref;if(null!==n)if("function"==typeof n){var r;try{if(2&e.mode)try{Hu(),r=n(null)}finally{zu(e)}else r=n(null)}catch(n){xd(n),cp(e,t,n)}"function"==typeof r&&l("Unexpected return value from a callback ref in %s. A callback ref should not return a function.",H(e))}else n.current=null}function Md(e,t,n){try{n()}catch(n){xd(n),cp(e,t,n)}}var Rd=!1;function Cd(e,t){Ae(e.containerInfo),yd=t,function(){for(;null!==yd;){var e=yd,t=e.child;0!==(e.subtreeFlags&oe)&&null!==t?(vh(t,e),yd=t):Id()}}();var n=Rd;return Rd=!1,n}function Id(){for(;null!==yd;){var e=yd;is(e);try{Ld(e)}catch(t){xd(t),cp(e,e.return,t)}rs();var t=e.sibling;if(null!==t)return vh(t,e.return),void(yd=t);yd=e.return}}function Ld(e){var t=e.alternate;if(0!==(e.flags&X)){switch(is(e),e.tag){case 0:case m:case b:break;case 1:if(null!==t){var n=t.memoizedProps,r=t.memoizedState,i=e.stateNode;e.type!==e.elementType||vc||(i.props!==e.memoizedProps&&l("Expected %s props to match memoized props before getSnapshotBeforeUpdate. This might either be because of a bug in React, or because a component reassigns its own `this.props`. Please file an issue.",H(e)||"instance"),i.state!==e.memoizedState&&l("Expected %s state to match memoized state before getSnapshotBeforeUpdate. This might either be because of a bug in React, or because a component reassigns its own `this.state`. Please file an issue.",H(e)||"instance"));var s=i.getSnapshotBeforeUpdate(e.elementType===e.type?n:_s(e.type,n),r),a=pd;void 0!==s||a.has(e.type)||(a.add(e.type),l("%s.getSnapshotBeforeUpdate(): A snapshot value (or null) must be returned. You have returned undefined.",H(e))),i.__reactInternalSnapshotBeforeUpdate=s}break;case 3:if(Ue){var o=e.stateNode;mt(o.containerInfo)}break;case 5:case 6:case 4:case _:break;default:throw new Error("This unit of work tag should not have side-effects. This error is likely caused by a bug in React. Please file an issue.")}rs()}}function Pd(e,t,n){var r=t.updateQueue,i=null!==r?r.lastEffect:null;if(null!==i){var s=i.next,a=s;do{if((a.tag&e)===e){var o=a.destroy;a.destroy=void 0,void 0!==o&&((e&Wo)!==zo?Ii(t):(e&$o)!==zo&&Di(t),Md(t,n,o),(e&Wo)!==zo?Li():(e&$o)!==zo&&ki())}a=a.next}while(a!==s)}}function Nd(e,t){var n=t.updateQueue,r=null!==n?n.lastEffect:null;if(null!==r){var i=r.next,s=i;do{if((s.tag&e)===e){(e&Wo)!==zo?Ri(t):(e&$o)!==zo&&Pi(t);var a=s.create;s.destroy=a(),(e&Wo)!==zo?Ci():(e&$o)!==zo&&Ni();var o=s.destroy;if(void 0!==o&&"function"!=typeof o){var u=void 0;l("%s must not return anything besides a function, which is used for clean-up.%s",u=0!==(s.tag&$o)?"useLayoutEffect":0!==(s.tag&Ho)?"useInsertionEffect":"useEffect",null===o?" You returned null. If your effect does not require clean up, return undefined (or nothing).":"function"==typeof o.then?"\n\nIt looks like you wrote "+u+"(async () => ...) or returned a Promise. Instead, write the async function inside your effect and call it immediately:\n\n"+u+"(() => {\n  async function fetchData() {\n    // You can await here\n    const response = await MyAPI.getData(someId);\n    // ...\n  }\n  fetchData();\n}, [someId]); // Or [] if effect doesn't need props or state\n\nLearn more about data fetching with Hooks: https://reactjs.org/link/hooks-data-fetching":" You returned: "+o)}}s=s.next}while(s!==i)}}function Dd(e,t){if(4&t.flags&&t.tag===g){var n=t.stateNode.passiveEffectDuration,r=t.memoizedProps,i=r.id,s=r.onPostCommit,a=Ou(),o=null===t.alternate?"mount":"update";ku()&&(o="nested-update"),"function"==typeof s&&s(i,o,n,a);var l=t.return;e:for(;null!==l;){switch(l.tag){case 3:l.stateNode.passiveEffectDuration+=n;break e;case g:l.stateNode.passiveEffectDuration+=n;break e}l=l.return}}}function kd(e,t,n,r){if(0!==(n.flags&ue))switch(n.tag){case 0:case m:case b:if(!gd)if(2&n.mode)try{Hu(),Nd($o|Go,n)}finally{zu(n)}else Nd($o|Go,n);break;case 1:var i=n.stateNode;if(4&n.flags&&!gd)if(null===t)if(n.type!==n.elementType||vc||(i.props!==n.memoizedProps&&l("Expected %s props to match memoized props before componentDidMount. This might either be because of a bug in React, or because a component reassigns its own `this.props`. Please file an issue.",H(n)||"instance"),i.state!==n.memoizedState&&l("Expected %s state to match memoized state before componentDidMount. This might either be because of a bug in React, or because a component reassigns its own `this.state`. Please file an issue.",H(n)||"instance")),2&n.mode)try{Hu(),i.componentDidMount()}finally{zu(n)}else i.componentDidMount();else{var s=n.elementType===n.type?t.memoizedProps:_s(n.type,t.memoizedProps),a=t.memoizedState;if(n.type!==n.elementType||vc||(i.props!==n.memoizedProps&&l("Expected %s props to match memoized props before componentDidUpdate. This might either be because of a bug in React, or because a component reassigns its own `this.props`. Please file an issue.",H(n)||"instance"),i.state!==n.memoizedState&&l("Expected %s state to match memoized state before componentDidUpdate. This might either be because of a bug in React, or because a component reassigns its own `this.state`. Please file an issue.",H(n)||"instance")),2&n.mode)try{Hu(),i.componentDidUpdate(s,a,i.__reactInternalSnapshotBeforeUpdate)}finally{zu(n)}else i.componentDidUpdate(s,a,i.__reactInternalSnapshotBeforeUpdate)}var o=n.updateQueue;null!==o&&(n.type!==n.elementType||vc||(i.props!==n.memoizedProps&&l("Expected %s props to match memoized props before processing the update queue. This might either be because of a bug in React, or because a component reassigns its own `this.props`. Please file an issue.",H(n)||"instance"),i.state!==n.memoizedState&&l("Expected %s state to match memoized state before processing the update queue. This might either be because of a bug in React, or because a component reassigns its own `this.state`. Please file an issue.",H(n)||"instance")),ea(0,o,i));break;case 3:var u=n.updateQueue;if(null!==u){var c=null;if(null!==n.child)switch(n.child.tag){case 5:c=Se(n.child.stateNode);break;case 1:c=n.child.stateNode}ea(0,u,c)}break;case 5:var d=n.stateNode;if(null===t&&4&n.flags){var h=n.type,f=n.memoizedProps;it(d,h,f,n)}break;case 6:case 4:break;case g:var p=n.memoizedProps,y=p.onCommit,x=p.onRender,A=n.stateNode.effectDuration,w=Ou(),M=null===t?"mount":"update";ku()&&(M="nested-update"),"function"==typeof x&&x(n.memoizedProps.id,M,n.actualDuration,n.treeBaseDuration,n.actualStartTime,w),"function"==typeof y&&y(n.memoizedProps.id,M,A,w),C=n,Tf.push(C),_f||(_f=!0,Ep(fi,function(){return ap(),null}));var R=n.return;e:for(;null!==R;){switch(R.tag){case 3:R.stateNode.effectDuration+=A;break e;case g:R.stateNode.effectDuration+=A;break e}R=R.return}break;case v:!function(e,t){if(!Ve)return;var n=t.memoizedState;if(null===n){var r=t.alternate;if(null!==r){var i=r.memoizedState;if(null!==i){var s=i.dehydrated;null!==s&&Wt(s)}}}}(0,n);break;case S:case _:case 21:case T:case E:break;default:throw new Error("This unit of work tag should not have side-effects. This error is likely caused by a bug in React. Please file an issue.")}var C;gd||n.flags&q&&Fd(n)}function Od(e){switch(e.tag){case 0:case m:case b:if(2&e.mode)try{Hu(),Td(e,e.return)}finally{zu(e)}else Td(e,e.return);break;case 1:var t=e.stateNode;"function"==typeof t.componentDidMount&&function(e,t,n){try{n.componentDidMount()}catch(n){xd(n),cp(e,t,n)}}(e,e.return,t),Ad(e,e.return);break;case 5:Ad(e,e.return)}}function Fd(e){var t=e.ref;if(null!==t){var n,r=e.stateNode;if(5===e.tag)n=Se(r);else n=r;if("function"==typeof t){var i;if(2&e.mode)try{Hu(),i=t(n)}finally{zu(e)}else i=t(n);"function"==typeof i&&l("Unexpected return value from a callback ref in %s. A callback ref should not return a function.",H(e))}else t.hasOwnProperty("current")||l("Unexpected ref object provided for %s. Use either a ref-setter function or React.createRef().",H(e)),t.current=n}}function Ud(e,t,n){switch(function(e){if(yi&&"function"==typeof yi.onCommitFiberUnmount)try{yi.onCommitFiberUnmount(vi,e)}catch(e){_i||(_i=!0,l("React instrumentation encountered an error: %s",e))}}(t),t.tag){case 0:case m:case y:case b:var r=t.updateQueue;if(null!==r){var i=r.lastEffect;if(null!==i){var s=i.next,a=s;do{var o=a,u=o.destroy,c=o.tag;void 0!==u&&((c&Ho)!==zo?Md(t,n,u):(c&$o)!==zo&&(Di(t),2&t.mode?(Hu(),Md(t,n,u),zu(t)):Md(t,n,u),ki())),a=a.next}while(a!==s)}}return;case 1:wd(t,n);var d=t.stateNode;return void("function"==typeof d.componentWillUnmount&&Ed(t,n,d));case 5:return void wd(t,n);case 4:return void(Ue?jd(e,t,n):Be&&function(e){if(!Be)return;var t=e.stateNode,n=t.containerInfo,r=vt(n);_t(n,r)}(t));case x:case 21:return}}function Bd(e,t,n){for(var r=t;;)if(Ud(e,r,n),null===r.child||Ue&&4===r.tag){if(r===t)return;for(;null===r.sibling;){if(null===r.return||r.return===t)return;r=r.return}r.sibling.return=r.return,r=r.sibling}else r.child.return=r,r=r.child}function Vd(e){var t=e.alternate;if(null!==t&&(e.alternate=null,Vd(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag){var n=e.stateNode;null!==n&&$e(n)}e.stateNode=null,e._debugOwner=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function zd(e){return 5===e.tag||3===e.tag||4===e.tag}function Gd(e){var t=e;e:for(;;){for(;null===t.sibling;){if(null===t.return||zd(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;5!==t.tag&&6!==t.tag&&t.tag!==x;){if(2&t.flags)continue e;if(null===t.child||4===t.tag)continue e;t.child.return=t,t=t.child}if(!(2&t.flags))return t.stateNode}}function Hd(e){if(Ue){var t=function(e){for(var t=e.return;null!==t;){if(zd(t))return t;t=t.return}throw new Error("Expected to find a host parent. This error is likely caused by a bug in React. Please file an issue.")}(e);switch(t.tag){case 5:var n=t.stateNode;32&t.flags&&(ct(n),t.flags&=-33),Wd(e,Gd(e),n);break;case 3:case 4:var r=t.stateNode.containerInfo;$d(e,Gd(e),r);break;default:throw new Error("Invalid host parent fiber. This error is likely caused by a bug in React. Please file an issue.")}}}function $d(e,t,n){var r=e.tag;if(5===r||6===r){var i=e.stateNode;t?ot(n,i,t):nt(n,i)}else if(4===r);else{var s=e.child;if(null!==s){$d(s,t,n);for(var a=s.sibling;null!==a;)$d(a,t,n),a=a.sibling}}}function Wd(e,t,n){var r=e.tag;if(5===r||6===r){var i=e.stateNode;t?at(n,i,t):tt(n,i)}else if(4===r);else{var s=e.child;if(null!==s){Wd(s,t,n);for(var a=s.sibling;null!==a;)Wd(a,t,n),a=a.sibling}}}function jd(e,t,n){for(var r,i,s=t,a=!1;;){if(!a){var o=s.return;e:for(;;){if(null===o)throw new Error("Expected to find a host parent. This error is likely caused by a bug in React. Please file an issue.");var l=o.stateNode;switch(o.tag){case 5:r=l,i=!1;break e;case 3:case 4:r=l.containerInfo,i=!0;break e}o=o.return}a=!0}if(5===s.tag||6===s.tag)Bd(e,s,n),i?ut(r,s.stateNode):lt(r,s.stateNode);else if(s.tag===x)i?qt(r,s.stateNode):jt(r,s.stateNode);else if(4===s.tag){if(null!==s.child){r=s.stateNode.containerInfo,i=!0,s.child.return=s,s=s.child;continue}}else if(Ud(e,s,n),null!==s.child){s.child.return=s,s=s.child;continue}if(s===t)return;for(;null===s.sibling;){if(null===s.return||s.return===t)return;4===(s=s.return).tag&&(a=!1)}s.sibling.return=s.return,s=s.sibling}}function qd(e,t,n){var r,i;Ue?jd(e,t,n):Bd(e,t,n),null!==(i=(r=t).alternate)&&(i.return=null),r.return=null}function Xd(e,t){if(Ue){switch(t.tag){case 0:case m:case y:case b:if(Pd(Ho|Go,t,t.return),Nd(Ho|Go,t),2&t.mode)try{Hu(),Pd($o|Go,t,t.return)}finally{zu(t)}else Pd($o|Go,t,t.return);return;case 1:return;case 5:var n=t.stateNode;if(null!=n){var r=t.memoizedProps,i=null!==e?e.memoizedProps:r,s=t.type,a=t.updateQueue;t.updateQueue=null,null!==a&&st(n,a,s,i,r,t)}return;case 6:if(null===t.stateNode)throw new Error("This should have a text node initialized. This error is likely caused by a bug in React. Please file an issue.");var o=t.stateNode,l=t.memoizedProps,u=null!==e?e.memoizedProps:l;return void rt(o,u,l);case 3:if(Ve)if(null!==e)if(e.memoizedState.isDehydrated){var c=t.stateNode;$t(c.containerInfo)}return;case g:return;case v:return Yd(t),void Kd(t);case S:return void Kd(t);case _:return}throw new Error("This unit of work tag should not have side-effects. This error is likely caused by a bug in React. Please file an issue.")}switch(t.tag){case 0:case m:case y:case b:if(Pd(Ho|Go,t,t.return),Nd(Ho|Go,t),2&t.mode)try{Hu(),Pd($o|Go,t,t.return)}finally{zu(t)}else Pd($o|Go,t,t.return);return;case g:return;case v:return Yd(t),void Kd(t);case S:return void Kd(t);case 3:if(Ve)if(null!==e)if(e.memoizedState.isDehydrated){var d=t.stateNode;$t(d.containerInfo)}break;case T:case E:return}!function(e){if(Be){switch(e.tag){case 1:case 5:case 6:return;case 3:case 4:var t=e.stateNode,n=t.containerInfo,r=t.pendingChildren;return void _t(n,r)}throw new Error("This unit of work tag should not have side-effects. This error is likely caused by a bug in React. Please file an issue.")}}(t)}function Yd(e){e.memoizedState}function Kd(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var n=e.stateNode;null===n&&(n=e.stateNode=new vd),t.forEach(function(t){var r=pp.bind(null,e,t);if(!n.has(t)){if(n.add(t),xi){if(null===bd||null===_d)throw Error("Expected finished root and lanes to be set. This is a bug in React.");Sp(_d,bd)}t.then(r,r)}})}}function Qd(e,t,n){bd=n,_d=e,yd=t,function(e,t){for(;null!==yd;){var n=yd,r=n.deletions;if(null!==r)for(var i=0;i<r.length;i++){var s=r[i];try{qd(e,s,n)}catch(e){xd(e),cp(s,n,e)}}var a=n.child;0!==(n.subtreeFlags&le)&&null!==a?(vh(a,n),yd=a):Zd(e,t)}}(e,n),bd=null,_d=null}function Zd(e,t){for(;null!==yd;){var n=yd;is(n);try{Jd(n,e,t)}catch(e){xd(e),cp(n,n.return,e)}rs();var r=n.sibling;if(null!==r)return vh(r,n.return),void(yd=r);yd=n.return}}function Jd(e,t,n){var r=e.flags;if(32&r&&function(e){Ue&&ct(e.stateNode)}(e),r&q){var i=e.alternate;null!==i&&function(e){var t=e.ref;if(null!==t)if("function"==typeof t)if(2&e.mode)try{Hu(),t(null)}finally{zu(e)}else t(null);else t.current=null}(i)}if(r&Q)switch(e.tag){case v:if(null!==e.memoizedState){var s=e.alternate;null!==s&&null!==s.memoizedState||(df=ci())}break;case T:var a=null!==e.memoizedState,o=e.alternate,l=null!==o&&null!==o.memoizedState,u=e;if(Ue&&function(e,t){var n=null;if(Ue)for(var r=e;;){if(5===r.tag){if(null===n){n=r;var i=r.stateNode;t?dt(i):ft(r.stateNode,r.memoizedProps)}}else if(6===r.tag){if(null===n){var s=r.stateNode;t?ht(s):pt(s,r.memoizedProps)}}else if((r.tag!==T&&r.tag!==E||null===r.memoizedState||r===e)&&null!==r.child){r.child.return=r,r=r.child;continue}if(r===e)return;for(;null===r.sibling;){if(null===r.return||r.return===e)return;n===r&&(n=null),r=r.return}n===r&&(n=null),r.sibling.return=r.return,r=r.sibling}}(u,a),a&&!l&&1&u.mode){yd=u;for(var c=u.child;null!==c;)yd=c,rh(c),c=c.sibling}}switch(4102&r){case 2:Hd(e),e.flags&=-3;break;case 6:Hd(e),e.flags&=-3,Xd(e.alternate,e);break;case K:e.flags&=-4097;break;case 4100:e.flags&=-4097,Xd(e.alternate,e);break;case 4:Xd(e.alternate,e)}}function eh(e,t,n){bd=n,_d=t,yd=e,th(e,t,n),bd=null,_d=null}function th(e,t,n){for(var r=!!(1&e.mode);null!==yd;){var i=yd,s=i.child;if(i.tag===T&&r){var a=null!==i.memoizedState||md;if(a){nh(e,t,n);continue}var o=i.alternate,l=null!==o&&null!==o.memoizedState,u=md,c=gd;md=a,(gd=l||gd)&&!c&&(yd=i,sh(i));for(var d=s;null!==d;)yd=d,th(d,t,n),d=d.sibling;yd=i,md=u,gd=c,nh(e,t,n)}else 0!==(i.subtreeFlags&ue)&&null!==s?(vh(s,i),yd=s):nh(e,t,n)}}function nh(e,t,n){for(;null!==yd;){var r=yd;if(0!==(r.flags&ue)){var i=r.alternate;is(r);try{kd(0,i,r)}catch(e){xd(e),cp(r,r.return,e)}rs()}if(r===e)return void(yd=null);var s=r.sibling;if(null!==s)return vh(s,r.return),void(yd=s);yd=r.return}}function rh(e){for(;null!==yd;){var t=yd,n=t.child;switch(t.tag){case 0:case m:case y:case b:if(2&t.mode)try{Hu(),Pd($o,t,t.return)}finally{zu(t)}else Pd($o,t,t.return);break;case 1:wd(t,t.return);var r=t.stateNode;"function"==typeof r.componentWillUnmount&&Ed(t,t.return,r);break;case 5:wd(t,t.return);break;case T:if(null!==t.memoizedState){ih(e);continue}}null!==n?(n.return=t,yd=n):ih(e)}}function ih(e){for(;null!==yd;){var t=yd;if(t===e)return void(yd=null);var n=t.sibling;if(null!==n)return n.return=t.return,void(yd=n);yd=t.return}}function sh(e){for(;null!==yd;){var t=yd,n=t.child;if(t.tag===T)if(null!==t.memoizedState){ah(e);continue}null!==n?(n.return=t,yd=n):ah(e)}}function ah(e){for(;null!==yd;){var t=yd;is(t);try{Od(t)}catch(e){xd(e),cp(t,t.return,e)}if(rs(),t===e)return void(yd=null);var n=t.sibling;if(null!==n)return n.return=t.return,void(yd=n);yd=t.return}}function oh(e,t){yd=t,function(e,t){for(;null!==yd;){var n=yd,r=n.child;0!==(n.subtreeFlags&ce)&&null!==r?(vh(r,n),yd=r):lh(e,t)}}(t,e)}function lh(e,t){for(;null!==yd;){var n=yd;if(0!==(n.flags&Y)){is(n);try{uh(t,n)}catch(e){xd(e),cp(n,n.return,e)}rs()}if(n===e)return void(yd=null);var r=n.sibling;if(null!==r)return vh(r,n.return),void(yd=r);yd=n.return}}function uh(e,t){switch(t.tag){case 0:case m:case b:if(2&t.mode){$u();try{Nd(Wo|Go,t)}finally{Gu(t)}}else Nd(Wo|Go,t)}}function ch(e){yd=e,function(){for(;null!==yd;){var e=yd,t=e.child;if(0!==(yd.flags&$)){var n=e.deletions;if(null!==n){for(var r=0;r<n.length;r++){var i=n[r];yd=i,fh(i,e)}var s=e.alternate;if(null!==s){var a=s.child;if(null!==a){s.child=null;do{var o=a.sibling;a.sibling=null,a=o}while(null!==a)}}yd=e}}0!==(e.subtreeFlags&ce)&&null!==t?(vh(t,e),yd=t):dh()}}()}function dh(){for(;null!==yd;){var e=yd;0!==(e.flags&Y)&&(is(e),hh(e),rs());var t=e.sibling;if(null!==t)return vh(t,e.return),void(yd=t);yd=e.return}}function hh(e){switch(e.tag){case 0:case m:case b:2&e.mode?($u(),Pd(Wo|Go,e,e.return),Gu(e)):Pd(Wo|Go,e,e.return)}}function fh(e,t){for(;null!==yd;){var n=yd;is(n),mh(n,t),rs();var r=n.child;null!==r?(vh(r,n),yd=r):ph(e)}}function ph(e){for(;null!==yd;){var t=yd,n=t.sibling,r=t.return;if(Vd(t),t===e)return void(yd=null);if(null!==n)return vh(n,r),void(yd=n);yd=r}}function mh(e,t){switch(e.tag){case 0:case m:case b:2&e.mode?($u(),Pd(Wo,e,t),Gu(e)):Pd(Wo,e,t)}}var gh=!1;function vh(e,t){gh||e.return===t||(gh=!0,l("Internal React error: Return pointer is inconsistent with parent.")),e.return=t}function yh(e){switch(e.tag){case 0:case m:case b:try{Nd($o|Go,e)}catch(t){xd(t),cp(e,e.return,t)}break;case 1:var t=e.stateNode;try{t.componentDidMount()}catch(t){xd(t),cp(e,e.return,t)}}}function bh(e){switch(e.tag){case 0:case m:case b:try{Nd(Wo|Go,e)}catch(t){xd(t),cp(e,e.return,t)}}}function _h(e){switch(e.tag){case 0:case m:case b:try{Pd($o|Go,e,e.return)}catch(t){xd(t),cp(e,e.return,t)}break;case 1:var t=e.stateNode;"function"==typeof t.componentWillUnmount&&Ed(e,e.return,t)}}function xh(e){switch(e.tag){case 0:case m:case b:try{Pd(Wo|Go,e,e.return)}catch(t){xd(t),cp(e,e.return,t)}}}var Sh=0,Th=1,Eh=2,Ah=3,wh=4;if("function"==typeof Symbol&&Symbol.for){var Mh=Symbol.for;Sh=Mh("selector.component"),Th=Mh("selector.has_pseudo_class"),Eh=Mh("selector.role"),Ah=Mh("selector.test_id"),wh=Mh("selector.text")}function Rh(e){var t=ze(e);if(null!=t){if("string"!=typeof t.memoizedProps["data-testname"])throw new Error("Invalid host root specified. Should be either a React container or a node with a testname attribute.");return t}var n=Xe(e);if(null===n)throw new Error("Could not find React container within specified host subtree.");return n.stateNode.current}function Ch(e,t){switch(t.$$typeof){case Sh:if(e.type===t.value)return!0;break;case Th:return function(e,t){var n=[e,0],r=0;for(;r<n.length;){var i=n[r++],s=n[r++],a=t[s];if(5!==i.tag||!Qe(i)){for(;null!=a&&Ch(i,a);)a=t[++s];if(s===t.length)return!0;for(var o=i.child;null!==o;)n.push(o,s),o=o.sibling}}return!1}(e,t.value);case Eh:if(5===e.tag){var n=e.stateNode;if(Ze(n,t.value))return!0}break;case wh:if(5===e.tag||6===e.tag){var r=Ke(e);if(null!==r&&r.indexOf(t.value)>=0)return!0}break;case Ah:if(5===e.tag){var i=e.memoizedProps["data-testname"];if("string"==typeof i&&i.toLowerCase()===t.value.toLowerCase())return!0}break;default:throw new Error("Invalid selector type specified.")}return!1}function Ih(e){switch(e.$$typeof){case Sh:return"<"+(z(e.value)||"Unknown")+">";case Th:return":has("+(Ih(e)||"")+")";case Eh:return'[role="'+e.value+'"]';case wh:return'"'+e.value+'"';case Ah:return'[data-testname="'+e.value+'"]';default:throw new Error("Invalid selector type specified.")}}function Lh(e,t){for(var n=[],r=[e,0],i=0;i<r.length;){var s=r[i++],a=r[i++],o=t[a];if(5!==s.tag||!Qe(s)){for(;null!=o&&Ch(s,o);)o=t[++a];if(a===t.length)n.push(s);else for(var l=s.child;null!==l;)r.push(l,a),l=l.sibling}}return n}function Ph(e,t){if(!qe)throw new Error("Test selector API is not supported by this renderer.");for(var n=Lh(Rh(e),t),r=[],i=Array.from(n),s=0;s<i.length;){var a=i[s++];if(5===a.tag){if(Qe(a))continue;r.push(a.stateNode)}else for(var o=a.child;null!==o;)i.push(o),o=o.sibling}return r}var Nh=[];var Dh=s.ReactCurrentActQueue;function kh(){var e="undefined"!=typeof IS_REACT_ACT_ENVIRONMENT?IS_REACT_ACT_ENVIRONMENT:void 0;return e||null===Dh.current||l("The current testing environment is not configured to support act(...)"),e}var Oh=Math.ceil,Fh=s.ReactCurrentDispatcher,Uh=s.ReactCurrentOwner,Bh=s.ReactCurrentBatchConfig,Vh=s.ReactCurrentActQueue,zh=0,Gh=2,Hh=4,$h=0,Wh=1,jh=2,qh=3,Xh=4,Yh=5,Kh=6,Qh=zh,Zh=null,Jh=null,ef=0,tf=0,nf=Ln(0),rf=$h,sf=null,af=0,of=0,lf=0,uf=null,cf=null,df=0,hf=500,ff=1/0,pf=500;function mf(){ff=ci()+pf}function gf(){return ff}var vf=!1,yf=null,bf=null,_f=!1,xf=null,Sf=0,Tf=[],Ef=50,Af=0,wf=null,Mf=50,Rf=0,Cf=Mr,If=0;function Lf(){return Zh}function Pf(){return(Qh&(Gh|Hh))!==zh?ci():Cf!==Mr?Cf:Cf=ci()}function Nf(e){var t;if(!(1&e.mode))return 1;if((Qh&Gh)!==zh&&0!==ef)return Br(ef);if(null!==Yi.transition){if(null!==Bh.transition){var n=Bh.transition;n._updatedFibers||(n._updatedFibers=new Set),n._updatedFibers.add(e)}return 0===If&&(t=Rr,!((Rr<<=1)&tr)&&(Rr=64),If=t),If}var r=ni();return 0!==r?r:He()}function Df(e){var t;return 1&e.mode?(t=Cr,!((Cr<<=1)&pr)&&(Cr=mr),t):1}function kf(e,t,n){!function(){if(Af>Ef)throw Af=0,wf=null,new Error("Maximum update depth exceeded. This can happen when a component repeatedly calls setState inside componentWillUpdate or componentDidUpdate. React limits the number of nested updates to prevent infinite loops.");Rf>Mf&&(Rf=0,l("Maximum update depth exceeded. This can happen when a component calls setState inside useEffect, but useEffect either doesn't have a dependency array, or one of the dependencies changes on every render."))}();var r=Of(e,t);return null===r?null:(Xr(r,t,n),0!==(Qh&Gh)&&r===Zh?function(e){if(ts&&!lu)switch(e.tag){case 0:case m:case b:var t=Jh&&H(Jh)||"Unknown",n=t;if(!_p.has(n))_p.add(n),l("Cannot update a component (`%s`) while rendering a different component (`%s`). To locate the bad setState() call inside `%s`, follow the stack trace as described in https://reactjs.org/link/setstate-in-render",H(e)||"Unknown",t,t);break;case 1:xp||(l("Cannot update during an existing state transition (such as within `render`). Render methods should be a pure function of props and state."),xp=!0)}}(e):(xi&&Qr(r,e,t),function(e){if(1&e.mode){if(!kh())return}else{if(t="undefined"!=typeof IS_REACT_ACT_ENVIRONMENT?IS_REACT_ACT_ENVIRONMENT:void 0,n="undefined"!=typeof jest,!Fe||!n||!1===t)return;if(Qh!==zh)return;if(0!==e.tag&&e.tag!==m&&e.tag!==b)return}var t,n;if(null===Vh.current){var r=es;try{is(e),l("An update to %s inside a test was not wrapped in act(...).\n\nWhen testing, code that causes React state updates should be wrapped into act(...):\n\nact(() => {\n  /* fire events that update state */\n});\n/* assert on the output */\n\nThis ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act",H(e))}finally{r?is(e):rs()}}}(e),r===Zh&&((Qh&Gh)===zh&&(of=$r(of,t)),rf===Xh&&Hf(r,ef)),Bf(r,n),1!==t||Qh!==zh||1&e.mode||Vh.isBatchingLegacy||(mf(),ji())),r)}function Of(e,t){e.lanes=$r(e.lanes,t);var n=e.alternate;null!==n&&(n.lanes=$r(n.lanes,t)),null===n&&4098&e.flags&&bp(e);for(var r=e,i=e.return;null!==i;)i.childLanes=$r(i.childLanes,t),null!==(n=i.alternate)?n.childLanes=$r(n.childLanes,t):4098&i.flags&&bp(e),r=i,i=i.return;return 3===r.tag?r.stateNode:null}function Ff(e,t){return null!==Zh&&!!(1&e.mode)&&(Qh&Gh)===zh}function Bf(e,t){var n=e.callbackNode;!function(e,t){for(var n=e.pendingLanes,r=e.suspendedLanes,i=e.pingedLanes,s=e.expirationTimes,a=n;a>0;){var o=Vr(a),l=1<<o,u=s[o];u===Mr?0!==(l&r)&&0===(l&i)||(s[o]=Pr(l,t)):u<=t&&(e.expiredLanes|=l),a&=~l}}(e,t);var r=Lr(e,e===Zh?ef:0);if(0===r)return null!==n&&Ap(n),e.callbackNode=null,void(e.callbackPriority=0);var i=Ur(r),s=e.callbackPriority;if(s!==i||null!==Vh.current&&n!==Tp){var a,o;if(null!=n&&Ap(n),1===i)0===e.tag?(null!==Vh.isBatchingLegacy&&(Vh.didScheduleLegacyUpdate=!0),o=$f.bind(null,e),Hi=!0,Wi(o)):Wi($f.bind(null,e)),We?null!==Vh.current?Vh.current.push(qi):je(function(){Qh===zh&&qi()}):Ep(di,qi),a=null;else{var u;switch(si(r)){case 1:u=di;break;case 4:u=hi;break;case Jr:u=fi;break;case ei:u=pi;break;default:u=fi}a=Ep(u,Vf.bind(null,e))}e.callbackPriority=i,e.callbackNode=a}else null==n&&1!==s&&l("Expected scheduled callback to exist. This error is likely caused by a bug in React. Please file an issue.")}function Vf(e,t){if(Nu=!1,Du=!1,Cf=Mr,If=0,(Qh&(Gh|Hh))!==zh)throw new Error("Should not already be working.");var n=e.callbackNode;if(ap()&&e.callbackNode!==n)return null;var r=Lr(e,e===Zh?ef:0);if(0===r)return null;var i=!Or(0,r)&&!function(e,t){return 0!==(t&e.expiredLanes)}(e,r)&&!t,s=i?function(e,t){var n=Qh;Qh|=Gh;var r=Kf();if(Zh!==e||ef!==t){if(xi){var i=e.memoizedUpdaters;i.size>0&&(Sp(e,ef),i.clear()),Zr(e,t)}mf(),Xf(e,t)}Ui(t);for(;;)try{np();break}catch(t){Yf(e,t)}return Ms(),Qf(r),Qh=n,null!==Jh?(null!==bi&&"function"==typeof bi.markRenderYielded&&bi.markRenderYielded(),$h):(Bi(),Zh=null,ef=0,rf)}(e,r):ep(e,r);if(s!==$h){if(s===jh){var a=Nr(e);0!==a&&(r=a,s=zf(e,a))}if(s===Wh){var o=sf;throw Xf(e,0),Hf(e,r),Bf(e,ci()),o}if(s===Kh)Hf(e,r);else{var l=!Or(0,r),u=e.current.alternate;if(l&&!function(e){var t=e;for(;;){if(t.flags&Z){var n=t.updateQueue;if(null!==n){var r=n.stores;if(null!==r)for(var i=0;i<r.length;i++){var s=r[i],a=s.getSnapshot,o=s.value;try{if(!zi(a(),o))return!1}catch(e){return!1}}}}var l=t.child;if(t.subtreeFlags&Z&&null!==l)l.return=t,t=l;else{if(t===e)return!0;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(u)){if((s=ep(e,r))===jh){var c=Nr(e);0!==c&&(r=c,s=zf(e,c))}if(s===Wh){var d=sf;throw Xf(e,0),Hf(e,r),Bf(e,ci()),d}}e.finishedWork=u,e.finishedLanes=r,function(e,t,n){switch(t){case $h:case Wh:throw new Error("Root did not complete. This is a bug in React.");case jh:sp(e,cf);break;case qh:if(Hf(e,n),kr(n)&&!wp()){var r=df+hf-ci();if(r>10){if(0!==Lr(e,0))break;var i=e.suspendedLanes;if(!Hr(i,n)){Pf(),Yr(e,i);break}e.timeoutHandle=Ne(sp.bind(null,e,cf),r);break}}sp(e,cf);break;case Xh:if(Hf(e,n),function(e){return(e&tr)===e}(n))break;if(!wp()){var s=function(e,t){for(var n=e.eventTimes,r=Mr;t>0;){var i=Vr(t),s=1<<i,a=n[i];a>r&&(r=a),t&=~s}return r}(e,n),a=s,o=ci()-a,l=((u=o)<120?120:u<480?480:u<1080?1080:u<1920?1920:u<3e3?3e3:u<4320?4320:1960*Oh(u/1960))-o;if(l>10){e.timeoutHandle=Ne(sp.bind(null,e,cf),l);break}}sp(e,cf);break;case Yh:sp(e,cf);break;default:throw new Error("Unknown root exit status.")}var u}(e,s,r)}}return Bf(e,ci()),e.callbackNode===n?Vf.bind(null,e):null}function zf(e,t){var n=uf;Xi(e)&&(Xf(e,t).flags|=j,cn(e.containerInfo));var r=ep(e,t);if(r!==jh){var i=cf;cf=n,null!==i&&Gf(i)}return r}function Gf(e){null===cf?cf=e:cf.push.apply(cf,e)}function Hf(e,t){t=Wr(t,lf),function(e,t){e.suspendedLanes|=t,e.pingedLanes&=~t;for(var n=e.expirationTimes,r=t;r>0;){var i=Vr(r),s=1<<i;n[i]=Mr,r&=~s}}(e,t=Wr(t,of))}function $f(e){if(Nu=Du,Du=!1,(Qh&(Gh|Hh))!==zh)throw new Error("Should not already be working.");ap();var t=Lr(e,0);if(!Gr(t,1))return Bf(e,ci()),null;var n=ep(e,t);if(0!==e.tag&&n===jh){var r=Nr(e);0!==r&&(t=r,n=zf(e,r))}if(n===Wh){var i=sf;throw Xf(e,0),Hf(e,t),Bf(e,ci()),i}if(n===Kh)throw new Error("Root did not complete. This is a bug in React.");var s=e.current.alternate;return e.finishedWork=s,e.finishedLanes=t,sp(e,cf),Bf(e,ci()),null}function Wf(e){null!==xf&&0===xf.tag&&(Qh&(Gh|Hh))===zh&&ap();var t=Qh;Qh|=1;var n=Bh.transition,r=ni();try{return Bh.transition=null,ri(1),e?e():void 0}finally{ri(r),Bh.transition=n,((Qh=t)&(Gh|Hh))===zh&&qi()}}function jf(e,t){Nn(nf,tf,e),tf=$r(tf,t)}function qf(e){tf=nf.current,Pn(nf,e)}function Xf(e,t){e.finishedWork=null,e.finishedLanes=0;var n=e.timeoutHandle;if(n!==ke&&(e.timeoutHandle=ke,De(n)),null!==Jh)for(var r=Jh.return;null!==r;){r.alternate;id(0,r),r=r.return}Zh=e;var i=Wp(e.current,null);return Jh=i,ef=tf=t,rf=$h,sf=null,af=0,of=0,lf=0,uf=null,cf=null,function(){if(null!==Os){for(var e=0;e<Os.length;e++){var t=Os[e],n=t.interleaved;if(null!==n){t.interleaved=null;var r=n.next,i=t.pending;if(null!==i){var s=i.next;i.next=r,n.next=s}t.pending=n}}Os=null}}(),as.discardPendingWarnings(),i}function Yf(e,t){for(;;){var n=Jh;try{if(Ms(),yl(),rs(),Uh.current=null,null===n||null===n.return)return rf=Wh,sf=t,void(Jh=null);2&n.mode&&Vu(n,!0),Mi(),null!==t&&"object"==typeof t&&"function"==typeof t.then?Fi(n,t,ef):Oi(n,t,ef),ic(e,n.return,n,t,ef),ip(n)}catch(e){t=e,Jh===n&&null!==n?(n=n.return,Jh=n):n=Jh;continue}return}}function Kf(){var e=Fh.current;return Fh.current=yu,null===e?yu:e}function Qf(e){Fh.current=e}function Zf(e){af=$r(e,af)}function Jf(){rf!==$h&&rf!==qh&&rf!==jh||(rf=Xh),null!==Zh&&(Dr(af)||Dr(of))&&Hf(Zh,ef)}function ep(e,t){var n=Qh;Qh|=Gh;var r=Kf();if(Zh!==e||ef!==t){if(xi){var i=e.memoizedUpdaters;i.size>0&&(Sp(e,ef),i.clear()),Zr(e,t)}Xf(e,t)}for(Ui(t);;)try{tp();break}catch(t){Yf(e,t)}if(Ms(),Qh=n,Qf(r),null!==Jh)throw new Error("Cannot commit an incomplete root. This error is likely caused by a bug in React. Please file an issue.");return Bi(),Zh=null,ef=0,rf}function tp(){for(;null!==Jh;)rp(Jh)}function np(){for(;null!==Jh&&!li();)rp(Jh)}function rp(e){var t,n=e.alternate;is(e),2&e.mode?(Uu(e),t=vp(n,e,tf),Vu(e,!0)):t=vp(n,e,tf),rs(),e.memoizedProps=e.pendingProps,null===t?ip(e):Jh=t,Uh.current=null}function ip(e){var t=e;do{var n=t.alternate,r=t.return;if(0===(t.flags&J)){is(t);var i=void 0;if(2&t.mode?(Uu(t),i=dc(n,t,tf),Vu(t,!1)):i=dc(n,t,tf),rs(),null!==i)return void(Jh=i)}else{var s=rd(0,t);if(null!==s)return s.flags&=32767,void(Jh=s);if(2&t.mode){Vu(t,!1);for(var a=t.actualDuration,o=t.child;null!==o;)a+=o.actualDuration,o=o.sibling;t.actualDuration=a}if(null===r)return rf=Kh,void(Jh=null);r.flags|=J,r.subtreeFlags=0,r.deletions=null}var l=t.sibling;if(null!==l)return void(Jh=l);Jh=t=r}while(null!==t);rf===$h&&(rf=Yh)}function sp(e,t){var n=ni(),r=Bh.transition;try{Bh.transition=null,ri(1),function(e,t,n){do{ap()}while(null!==xf);if(function(){as.flushLegacyContextWarning(),as.flushPendingUnsafeLifecycleWarnings()}(),(Qh&(Gh|Hh))!==zh)throw new Error("Should not already be working.");var r=e.finishedWork,i=e.finishedLanes;if(function(e){null!==bi&&"function"==typeof bi.markCommitStarted&&bi.markCommitStarted(e)}(i),null===r)return Ai(),null;0===i&&l("root.finishedLanes should not be empty during a commit. This is a bug in React.");if(e.finishedWork=null,e.finishedLanes=0,r===e.current)throw new Error("Cannot commit the same tree as before. This error is likely caused by a bug in React. Please file an issue.");e.callbackNode=null,e.callbackPriority=0;var s=$r(r.lanes,r.childLanes);(function(e,t){var n=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t;for(var r=e.entanglements,i=e.eventTimes,s=e.expirationTimes,a=n;a>0;){var o=Vr(a),l=1<<o;r[o]=0,i[o]=Mr,s[o]=Mr,a&=~l}})(e,s),e===Zh&&(Zh=null,Jh=null,ef=0);0===(r.subtreeFlags&ce)&&0===(r.flags&ce)||_f||(_f=!0,Ep(fi,function(){return ap(),null}));var a=!!(15990&r.subtreeFlags),o=!!(15990&r.flags);if(a||o){var u=Bh.transition;Bh.transition=null;var c=ni();ri(1);var d=Qh;Qh|=Hh,Uh.current=null,Cd(e,r),Fu(),Qd(e,r,i),we(e.containerInfo),e.current=r,function(e){null!==bi&&"function"==typeof bi.markLayoutEffectsStarted&&bi.markLayoutEffectsStarted(e)}(i),eh(r,e,i),null!==bi&&"function"==typeof bi.markLayoutEffectsStopped&&bi.markLayoutEffectsStopped(),ui(),Qh=d,ri(c),Bh.transition=u}else e.current=r,Fu();var h=_f;_f&&(_f=!1,xf=e,Sf=i);s=e.pendingLanes,0===s&&(bf=null);h||mp(e.current,!1);(function(e,t){if(yi&&"function"==typeof yi.onCommitFiberRoot)try{var n,r=(e.current.flags&W)===W;switch(t){case 1:n=di;break;case 4:n=hi;break;case Jr:n=fi;break;case ei:n=pi;break;default:n=fi}yi.onCommitFiberRoot(vi,e,n,r)}catch(e){_i||(_i=!0,l("React instrumentation encountered an error: %s",e))}})(r.stateNode,n),xi&&e.memoizedUpdaters.clear();if(function(){qe&&Nh.forEach(function(e){return e()})}(),Bf(e,ci()),null!==t)for(var f=e.onRecoverableError,p=0;p<t.length;p++){f(t[p])}if(vf){vf=!1;var m=yf;throw yf=null,m}Gr(Sf,1)&&0!==e.tag&&ap();s=e.pendingLanes,Gr(s,1)?(Du=!0,e===wf?Af++:(Af=0,wf=e)):Af=0;qi(),Ai()}(e,t,n)}finally{Bh.transition=r,ri(n)}return null}function ap(){if(null!==xf){var e=si(Sf),t=(s=e,0===(i=Jr)||i>s?i:s),n=Bh.transition,r=ni();try{return Bh.transition=null,ri(t),function(){if(null===xf)return!1;var e=xf,t=Sf;if(xf=null,Sf=0,(Qh&(Gh|Hh))!==zh)throw new Error("Cannot flush passive effects while already rendering.");!function(e){null!==bi&&"function"==typeof bi.markPassiveEffectsStarted&&bi.markPassiveEffectsStarted(e)}(t);var n=Qh;Qh|=Hh,ch(e.current),oh(e,e.current);var r=Tf;Tf=[];for(var i=0;i<r.length;i++){Dd(0,r[i])}null!==bi&&"function"==typeof bi.markPassiveEffectsStopped&&bi.markPassiveEffectsStopped(),mp(e.current,!0),Qh=n,qi(),Rf=null===xf?0:Rf+1,function(e){if(yi&&"function"==typeof yi.onPostCommitFiberRoot)try{yi.onPostCommitFiberRoot(vi,e)}catch(e){_i||(_i=!0,l("React instrumentation encountered an error: %s",e))}}(e);var s=e.current.stateNode;return s.effectDuration=0,s.passiveEffectDuration=0,!0}()}finally{ri(r),Bh.transition=n}}var i,s;return!1}function op(e){return null!==bf&&bf.has(e)}var lp=function(e){vf||(vf=!0,yf=e)};function up(e,t,n){js(e,Ju(e,ju(n,t),1));var r=Pf(),i=Of(e,1);null!==i&&(Xr(i,1,r),Bf(i,r))}function cp(e,t,n){if(3!==e.tag){var r=null;for(r=t;null!==r;){if(3===r.tag)return void up(r,e,n);if(1===r.tag){var i=r.type,s=r.stateNode;if("function"==typeof i.getDerivedStateFromError||"function"==typeof s.componentDidCatch&&!op(s)){js(r,ec(r,ju(n,e),1));var a=Pf(),o=Of(r,1);return void(null!==o&&(Xr(o,1,a),Bf(o,a)))}}r=r.return}l("Internal React error: Attempted to capture a commit phase error inside a detached tree. This indicates a bug in React. Likely causes include deleting the same fiber more than once, committing an already-finished tree, or an inconsistent return pointer.\n\nError message:\n\n%s",n)}else up(e,e,n)}function dp(e,t,n){var r=e.pingCache;null!==r&&r.delete(t);var i=Pf();Yr(e,n),function(e){0!==e.tag&&kh()&&null===Vh.current&&l("A suspended resource finished loading inside a test, but the event was not wrapped in act(...).\n\nWhen testing, code that resolves suspended data should be wrapped into act(...):\n\nact(() => {\n  /* finish loading suspended data */\n});\n/* assert on the output */\n\nThis ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act")}(e),Zh===e&&Hr(ef,n)&&(rf===Xh||rf===qh&&kr(ef)&&ci()-df<hf?Xf(e,0):lf=$r(lf,n)),Bf(e,i)}function hp(e,t){0===t&&(t=Df(e));var n=Pf(),r=Of(e,t);null!==r&&(Xr(r,t,n),Bf(r,n))}function fp(e){var t=e.memoizedState,n=0;null!==t&&(n=t.retryLane),hp(e,n)}function pp(e,t){var n,r=0;switch(e.tag){case v:n=e.stateNode;var i=e.memoizedState;null!==i&&(r=i.retryLane);break;case S:n=e.stateNode;break;default:throw new Error("Pinged unknown suspense boundary type. This is probably a bug in React.")}null!==n&&n.delete(t),hp(e,r)}function mp(e,t){is(e),gp(e,se,_h),t&&gp(e,ae,xh),gp(e,se,yh),t&&gp(e,ae,bh),rs()}function gp(e,t,n){for(var r=e,i=null;null!==r;){var s=r.subtreeFlags&t;r!==i&&null!==r.child&&0!==s?r=r.child:(0!==(r.flags&t)&&n(r),r=null!==r.sibling?r.sibling:i=r.return)}}var vp,yp=null;function bp(e){if((Qh&Gh)===zh&&1&e.mode){var t=e.tag;if(2===t||3===t||1===t||0===t||t===m||t===y||t===b){var n=H(e)||"ReactComponent";if(null!==yp){if(yp.has(n))return;yp.add(n)}else yp=new Set([n]);var r=es;try{is(e),l("Can't perform a React state update on a component that hasn't mounted yet. This indicates that you have a side-effect in your render function that asynchronously later calls tries to update the component. Move this work to useEffect instead.")}finally{r?is(e):rs()}}}}vp=function(e,t,n){var r=Jp(null,t);try{return nd(e,t,n)}catch(s){if(null!==s&&"object"==typeof s&&"function"==typeof s.then)throw s;if(Ms(),yl(),id(0,t),Jp(t,r),2&t.mode&&Uu(t),hd(null,nd,null,e,t,n),ud){var i=fd();"object"==typeof i&&null!==i&&i._suppressLogging&&"object"==typeof s&&null!==s&&!s._suppressLogging&&(s._suppressLogging=!0)}throw s}};var _p,xp=!1;function Sp(e,t){xi&&e.memoizedUpdaters.forEach(function(n){Qr(e,n,t)})}_p=new Set;var Tp={};function Ep(e,t){var n=Vh.current;return null!==n?(n.push(t),Tp):ai(e,t)}function Ap(e){if(e!==Tp)return oi(e)}function wp(){return null!==Vh.current}var Mp=null,Rp=null,Cp=function(e){Mp=e};function Ip(e){if(null===Mp)return e;var t=Mp(e);return void 0===t?e:t.current}function Lp(e){return Ip(e)}function Pp(e){if(null===Mp)return e;var t=Mp(e);if(void 0===t){if(null!=e&&"function"==typeof e.render){var n=Ip(e.render);if(e.render!==n){var r={$$typeof:P,render:n};return void 0!==e.displayName&&(r.displayName=e.displayName),r}}return e}return t.current}function Np(e,t){if(null===Mp)return!1;var n=e.elementType,r=t.type,i=!1,s="object"==typeof r&&null!==r?r.$$typeof:null;switch(e.tag){case 1:"function"==typeof r&&(i=!0);break;case 0:("function"==typeof r||s===O)&&(i=!0);break;case m:(s===P||s===O)&&(i=!0);break;case y:case b:(s===k||s===O)&&(i=!0);break;default:return!1}if(i){var a=Mp(n);if(void 0!==a&&a===Mp(r))return!0}return!1}function Dp(e){null!==Mp&&"function"==typeof WeakSet&&(null===Rp&&(Rp=new WeakSet),Rp.add(e))}var kp=function(e,t){if(null!==Mp){var n=t.staleFamilies,r=t.updatedFamilies;ap(),Wf(function(){Fp(e.current,r,n)})}},Op=function(e,t){e.context===Dn&&(ap(),Wf(function(){sm(t,e,null,null)}))};function Fp(e,t,n){var r=e.alternate,i=e.child,s=e.sibling,a=e.tag,o=e.type,l=null;switch(a){case 0:case b:case 1:l=o;break;case m:l=o.render}if(null===Mp)throw new Error("Expected resolveFamily to be set during hot reload.");var u=!1,c=!1;if(null!==l){var d=Mp(l);void 0!==d&&(n.has(d)?c=!0:t.has(d)&&(1===a?c=!0:u=!0))}null!==Rp&&(Rp.has(e)||null!==r&&Rp.has(r))&&(c=!0),c&&(e._debugNeedsRemount=!0),(c||u)&&kf(e,1,Mr),null===i||c||Fp(i,t,n),null!==s&&Fp(s,t,n)}var Up,Bp=function(e,t){var n=new Set,r=new Set(t.map(function(e){return e.current}));return Vp(e.current,r,n),n};function Vp(e,t,n){var r=e.child,i=e.sibling,s=e.tag,a=e.type,o=null;switch(s){case 0:case b:case 1:o=a;break;case m:o=a.render}var l=!1;null!==o&&t.has(o)&&(l=!0),l?function(e,t){var n=function(e,t){var n=e,r=!1;for(;;){if(5===n.tag)r=!0,t.add(n.stateNode);else if(null!==n.child){n.child.return=n,n=n.child;continue}if(n===e)return r;for(;null===n.sibling;){if(null===n.return||n.return===e)return r;n=n.return}n.sibling.return=n.return,n=n.sibling}return!1}(e,t);if(n)return;var r=e;for(;;){switch(r.tag){case 5:return void t.add(r.stateNode);case 4:case 3:return void t.add(r.stateNode.containerInfo)}if(null===r.return)throw new Error("Expected to reach root first.");r=r.return}}(e,n):null!==r&&Vp(r,t,n),null!==i&&Vp(i,t,n)}Up=!1;try{var zp=Object.preventExtensions({});new Map([[zp,null]]),new Set([zp])}catch(e){Up=!0}function Gp(e,t,n,r){this.tag=e,this.key=n,this.elementType=null,this.type=null,this.stateNode=null,this.return=null,this.child=null,this.sibling=null,this.index=0,this.ref=null,this.pendingProps=t,this.memoizedProps=null,this.updateQueue=null,this.memoizedState=null,this.dependencies=null,this.mode=r,this.flags=0,this.subtreeFlags=0,this.deletions=null,this.lanes=0,this.childLanes=0,this.alternate=null,this.actualDuration=Number.NaN,this.actualStartTime=Number.NaN,this.selfBaseDuration=Number.NaN,this.treeBaseDuration=Number.NaN,this.actualDuration=0,this.actualStartTime=-1,this.selfBaseDuration=0,this.treeBaseDuration=0,this._debugSource=null,this._debugOwner=null,this._debugNeedsRemount=!1,this._debugHookTypes=null,Up||"function"!=typeof Object.preventExtensions||Object.preventExtensions(this)}var Hp=function(e,t,n,r){return new Gp(e,t,n,r)};function $p(e){var t=e.prototype;return!(!t||!t.isReactComponent)}function Wp(e,t){var n=e.alternate;null===n?((n=Hp(e.tag,t,e.key,e.mode)).elementType=e.elementType,n.type=e.type,n.stateNode=e.stateNode,n._debugSource=e._debugSource,n._debugOwner=e._debugOwner,n._debugHookTypes=e._debugHookTypes,n.alternate=e,e.alternate=n):(n.pendingProps=t,n.type=e.type,n.flags=0,n.subtreeFlags=0,n.deletions=null,n.actualDuration=0,n.actualStartTime=-1),n.flags=e.flags&de,n.childLanes=e.childLanes,n.lanes=e.lanes,n.child=e.child,n.memoizedProps=e.memoizedProps,n.memoizedState=e.memoizedState,n.updateQueue=e.updateQueue;var r=e.dependencies;switch(n.dependencies=null===r?null:{lanes:r.lanes,firstContext:r.firstContext},n.sibling=e.sibling,n.index=e.index,n.ref=e.ref,n.selfBaseDuration=e.selfBaseDuration,n.treeBaseDuration=e.treeBaseDuration,n._debugNeedsRemount=e._debugNeedsRemount,n.tag){case 2:case 0:case b:n.type=Ip(e.type);break;case 1:n.type=Lp(e.type);break;case m:n.type=Pp(e.type)}return n}function jp(e,t){e.flags&=14680066;var n=e.alternate;if(null===n)e.childLanes=0,e.lanes=t,e.child=null,e.subtreeFlags=0,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null,e.stateNode=null,e.selfBaseDuration=0,e.treeBaseDuration=0;else{e.childLanes=n.childLanes,e.lanes=n.lanes,e.child=n.child,e.subtreeFlags=0,e.deletions=null,e.memoizedProps=n.memoizedProps,e.memoizedState=n.memoizedState,e.updateQueue=n.updateQueue,e.type=n.type;var r=n.dependencies;e.dependencies=null===r?null:{lanes:r.lanes,firstContext:r.firstContext},e.selfBaseDuration=n.selfBaseDuration,e.treeBaseDuration=n.treeBaseDuration}return e}function qp(e,t,n,r,i,s){var a=2,o=e;if("function"==typeof e)$p(e)?(a=1,o=Lp(o)):o=Ip(o);else if("string"==typeof e)a=5;else e:switch(e){case M:return Yp(n.children,i,s,t);case R:a=8,1&(i|=8)&&(i|=Kn);break;case C:return function(e,t,n,r){"string"!=typeof e.id&&l('Profiler must specify an "id" of type `string` as a prop. Received the type `%s` instead.',typeof e.id);var i=Hp(g,e,r,2|t);return i.elementType=C,i.lanes=n,i.stateNode={effectDuration:0,passiveEffectDuration:0},i}(n,i,s,t);case N:return function(e,t,n,r){var i=Hp(v,e,r,t);return i.elementType=N,i.lanes=n,i}(n,i,s,t);case D:return function(e,t,n,r){var i=Hp(S,e,r,t);return i.elementType=D,i.lanes=n,i}(n,i,s,t);case F:return Kp(n,i,s,t);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case I:a=p;break e;case L:a=9;break e;case P:a=m,o=Pp(o);break e;case k:a=y;break e;case O:a=16,o=null;break e}var u="";(void 0===e||"object"==typeof e&&null!==e&&0===Object.keys(e).length)&&(u+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var c=r?H(r):null;throw c&&(u+="\n\nCheck the render method of `"+c+"`."),new Error("Element type is invalid: expected a string (for built-in components) or a class/function (for composite components) but got: "+(null==e?e:typeof e)+"."+u)}var d=Hp(a,n,t,i);return d.elementType=e,d.type=o,d.lanes=s,d._debugOwner=r,d}function Xp(e,t,n){var r;r=e._owner;var i=qp(e.type,e.key,e.props,r,t,n);return i._debugSource=e._source,i._debugOwner=e._owner,i}function Yp(e,t,n,r){var i=Hp(7,e,r,t);return i.lanes=n,i}function Kp(e,t,n,r){var i=Hp(T,e,r,t);i.elementType=F,i.lanes=n;return i.stateNode={},i}function Qp(e,t,n){var r=Hp(6,e,null,t);return r.lanes=n,r}function Zp(e,t,n){var r=null!==e.children?e.children:[],i=Hp(4,r,e.key,t);return i.lanes=n,i.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},i}function Jp(e,t){return null===e&&(e=Hp(2,null,null,0)),e.tag=t.tag,e.key=t.key,e.elementType=t.elementType,e.type=t.type,e.stateNode=t.stateNode,e.return=t.return,e.child=t.child,e.sibling=t.sibling,e.index=t.index,e.ref=t.ref,e.pendingProps=t.pendingProps,e.memoizedProps=t.memoizedProps,e.updateQueue=t.updateQueue,e.memoizedState=t.memoizedState,e.dependencies=t.dependencies,e.mode=t.mode,e.flags=t.flags,e.subtreeFlags=t.subtreeFlags,e.deletions=t.deletions,e.lanes=t.lanes,e.childLanes=t.childLanes,e.alternate=t.alternate,e.actualDuration=t.actualDuration,e.actualStartTime=t.actualStartTime,e.selfBaseDuration=t.selfBaseDuration,e.treeBaseDuration=t.treeBaseDuration,e._debugSource=t._debugSource,e._debugOwner=t._debugOwner,e._debugNeedsRemount=t._debugNeedsRemount,e._debugHookTypes=t._debugHookTypes,e}function em(e,t,n,r,i){this.tag=t,this.containerInfo=e,this.pendingChildren=null,this.current=null,this.pingCache=null,this.finishedWork=null,this.timeoutHandle=ke,this.context=null,this.pendingContext=null,this.callbackNode=null,this.callbackPriority=0,this.eventTimes=qr(0),this.expirationTimes=qr(Mr),this.pendingLanes=0,this.suspendedLanes=0,this.pingedLanes=0,this.expiredLanes=0,this.mutableReadLanes=0,this.finishedLanes=0,this.entangledLanes=0,this.entanglements=qr(0),this.identifierPrefix=r,this.onRecoverableError=i,Ve&&(this.mutableSourceEagerHydrationData=null),this.effectDuration=0,this.passiveEffectDuration=0,this.memoizedUpdaters=new Set;for(var s=this.pendingUpdatersLaneMap=[],a=0;a<31;a++)s.push(new Set);switch(t){case 1:this._debugRootType=n?"hydrateRoot()":"createRoot()";break;case 0:this._debugRootType=n?"hydrate()":"render()"}}function tm(e,t,n,r,i,s,a,o,l,u){var c=new em(e,t,n,o,l),d=function(e,t){var n;return 1===e?(n=1,!0===t&&(n|=8,n|=Kn)):n=0,xi&&(n|=2),Hp(3,null,null,n)}(t,s);c.current=d,d.stateNode=c;var h={element:r,isDehydrated:n,cache:null,transitions:null};return d.memoizedState=h,Hs(d),c}var nm,rm;function im(e){if(!e)return Dn;var t=d(e),n=Yn(t);if(1===t.tag){var r=t.type;if(Gn(r))return jn(t,r,n)}return n}function sm(e,t,n,r){!function(e,t){if(yi&&"function"==typeof yi.onScheduleFiberRoot)try{yi.onScheduleFiberRoot(vi,e,t)}catch(e){_i||(_i=!0,l("React instrumentation encountered an error: %s",e))}}(t,e);var i=t.current,s=Pf(),a=Nf(i);!function(e){null!==bi&&"function"==typeof bi.markRenderScheduled&&bi.markRenderScheduled(e)}(a);var o=im(n);null===t.context?t.context=o:t.pendingContext=o,ts&&null!==es&&!nm&&(nm=!0,l("Render methods should be a pure function of props and state; triggering nested component updates from render is not allowed. If necessary, trigger nested updates in componentDidUpdate.\n\nCheck the render method of %s.",H(es)||"Unknown"));var u=Ws(s,a);u.payload={element:e},null!==(r=void 0===r?null:r)&&("function"!=typeof r&&l("render(...): Expected the last optional `callback` argument to be a function. Instead received: %s.",r),u.callback=r),js(i,u);var c=kf(i,a,s);return null!==c&&qs(c,i,a),a}function am(e,t){var n,r,i=e.memoizedState;null!==i&&null!==i.dehydrated&&(i.retryLane=(n=i.retryLane,r=t,0!==n&&n<r?n:r))}function om(e,t){am(e,t);var n=e.alternate;n&&am(n,t)}nm=!1,rm={};var lm=function(e){return null};function um(e){return lm(e)}var cm=function(e){return!1};function dm(e){return cm(e)}var hm,fm,pm,mm,gm,vm,ym,bm,_m,xm=function(e,t,n){var r=t[n],i=xe(e)?e.slice():c({},e);return n+1===t.length?(xe(i)?i.splice(r,1):delete i[r],i):(i[r]=xm(e[r],t,n+1),i)},Sm=function(e,t){return xm(e,t,0)},Tm=function(e,t,n,r){var i=t[r],s=xe(e)?e.slice():c({},e);r+1===t.length?(s[n[r]]=s[i],xe(s)?s.splice(i,1):delete s[i]):s[i]=Tm(e[i],t,n,r+1);return s},Em=function(e,t,n){if(t.length===n.length){for(var r=0;r<n.length-1;r++)if(t[r]!==n[r])return void o("copyWithRename() expects paths to be the same except for the deepest key");return Tm(e,t,n,0)}o("copyWithRename() expects paths of the same length")},Am=function(e,t,n,r){if(n>=t.length)return r;var i=t[n],s=xe(e)?e.slice():c({},e);return s[i]=Am(e[i],t,n+1,r),s},wm=function(e,t,n){return Am(e,t,0,n)},Mm=function(e,t){for(var n=e.memoizedState;null!==n&&t>0;)n=n.next,t--;return n};function Rm(e){var t=ge(e);return null===t?null:t.stateNode}function Cm(e){return null}function Im(){return es}return hm=function(e,t,n,r){var i=Mm(e,t);if(null!==i){var s=wm(i.memoizedState,n,r);i.memoizedState=s,i.baseState=s,e.memoizedProps=c({},e.memoizedProps),kf(e,1,Mr)}},fm=function(e,t,n){var r=Mm(e,t);if(null!==r){var i=Sm(r.memoizedState,n);r.memoizedState=i,r.baseState=i,e.memoizedProps=c({},e.memoizedProps),kf(e,1,Mr)}},pm=function(e,t,n,r){var i=Mm(e,t);if(null!==i){var s=Em(i.memoizedState,n,r);i.memoizedState=s,i.baseState=s,e.memoizedProps=c({},e.memoizedProps),kf(e,1,Mr)}},mm=function(e,t,n){e.pendingProps=wm(e.memoizedProps,t,n),e.alternate&&(e.alternate.pendingProps=e.pendingProps),kf(e,1,Mr)},gm=function(e,t){e.pendingProps=Sm(e.memoizedProps,t),e.alternate&&(e.alternate.pendingProps=e.pendingProps),kf(e,1,Mr)},vm=function(e,t,n){e.pendingProps=Em(e.memoizedProps,t,n),e.alternate&&(e.alternate.pendingProps=e.pendingProps),kf(e,1,Mr)},ym=function(e){kf(e,1,Mr)},bm=function(e){lm=e},_m=function(e){cm=e},n.attemptContinuousHydration=function(e){if(e.tag===v){var t=Pf(),n=xr;kf(e,n,t),om(e,n)}},n.attemptHydrationAtCurrentPriority=function(e){if(e.tag===v){var t=Pf(),n=Nf(e);kf(e,n,t),om(e,n)}},n.attemptSynchronousHydration=function(e){switch(e.tag){case 3:var t=e.stateNode;if(Xi(t)){var n=function(e){return Ir(e.pendingLanes)}(t);!function(e,t){0!==t&&(Kr(e,$r(t,1)),Bf(e,ci()),(Qh&(Gh|Hh))===zh&&(mf(),qi()))}(t,n)}break;case v:var r=Pf();Wf(function(){return kf(e,1,r)});om(e,1)}},n.batchedUpdates=function(e,t){var n=Qh;Qh|=1;try{return e(t)}finally{(Qh=n)!==zh||Vh.isBatchingLegacy||(mf(),ji())}},n.createComponentSelector=function(e){return{$$typeof:Sh,value:e}},n.createContainer=function(e,t,n,r,i,s,a,o){return tm(e,t,!1,null,0,r,0,s,a)},n.createHasPseudoClassSelector=function(e){return{$$typeof:Th,value:e}},n.createHydrationContainer=function(e,t,n,r,i,s,a,o,l,u){var c=tm(n,r,!0,e,0,s,0,o,l);c.context=im(null);var d=c.current,h=Pf(),f=Nf(d),p=Ws(h,f);return p.callback=null!=t?t:null,js(d,p),function(e,t,n){e.current.lanes=t,Xr(e,t,n),Bf(e,n)}(c,f,h),c},n.createPortal=function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return function(e){if(ys(e))l("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",vs(e)),bs(e)}(r),{$$typeof:w,key:null==r?null:""+r,children:e,containerInfo:t,implementation:n}},n.createRoleSelector=function(e){return{$$typeof:Eh,value:e}},n.createTestNameSelector=function(e){return{$$typeof:Ah,value:e}},n.createTextSelector=function(e){return{$$typeof:wh,value:e}},n.deferredUpdates=function(e){var t=ni(),n=Bh.transition;try{return Bh.transition=null,ri(Jr),e()}finally{ri(t),Bh.transition=n}},n.discreteUpdates=function(e,t,n,r,i){var s=ni(),a=Bh.transition;try{return Bh.transition=null,ri(1),e(t,n,r,i)}finally{ri(s),Bh.transition=a,Qh===zh&&mf()}},n.findAllNodes=Ph,n.findBoundingRects=function(e,t){if(!qe)throw new Error("Test selector API is not supported by this renderer.");for(var n=Ph(e,t),r=[],i=0;i<n.length;i++)r.push(Ye(n[i]));for(var s=r.length-1;s>0;s--)for(var a=r[s],o=a.x,l=o+a.width,u=a.y,c=u+a.height,d=s-1;d>=0;d--)if(s!==d){var h=r[d],f=h.x,p=f+h.width,m=h.y,g=m+h.height;if(o>=f&&u>=m&&l<=p&&c<=g){r.splice(s,1);break}if(!(o!==f||a.width!==h.width||g<u||m>c)){m>u&&(h.height+=m-u,h.y=u),g<c&&(h.height=c-m),r.splice(s,1);break}if(!(u!==m||a.height!==h.height||p<o||f>l)){f>o&&(h.width+=f-o,h.x=o),p<l&&(h.width=l-f),r.splice(s,1);break}}return r},n.findHostInstance=function(e){var t=d(e);if(void 0===t){if("function"==typeof e.render)throw new Error("Unable to find node on an unmounted component.");var n=Object.keys(e).join(",");throw new Error("Argument appears to not be a ReactComponent. Keys: "+n)}var r=ge(t);return null===r?null:r.stateNode},n.findHostInstanceWithNoPortals=function(e){var t=ye(e);return null===t?null:t.stateNode},n.findHostInstanceWithWarning=function(e,t){var n=d(e);if(void 0===n){if("function"==typeof e.render)throw new Error("Unable to find node on an unmounted component.");var r=Object.keys(e).join(",");throw new Error("Argument appears to not be a ReactComponent. Keys: "+r)}var i=ge(n);if(null===i)return null;if(8&i.mode){var s=H(n)||"Component";if(!rm[s]){rm[s]=!0;var a=es;try{is(i),8&n.mode?l("%s is deprecated in StrictMode. %s was passed an instance of %s which is inside StrictMode. Instead, add a ref directly to the element you want to reference. Learn more about using refs safely here: https://reactjs.org/link/strict-mode-find-node",t,t,s):l("%s is deprecated in StrictMode. %s was passed an instance of %s which renders StrictMode children. Instead, add a ref directly to the element you want to reference. Learn more about using refs safely here: https://reactjs.org/link/strict-mode-find-node",t,t,s)}finally{a?is(a):rs()}}}return i.stateNode},n.flushControlled=function(e){var t=Qh;Qh|=1;var n=Bh.transition,r=ni();try{Bh.transition=null,ri(1),e()}finally{ri(r),Bh.transition=n,(Qh=t)===zh&&(mf(),qi())}},n.flushPassiveEffects=ap,n.flushSync=Wf,n.focusWithin=function(e,t){if(!qe)throw new Error("Test selector API is not supported by this renderer.");for(var n=Lh(Rh(e),t),r=Array.from(n),i=0;i<r.length;){var s=r[i++];if(!Qe(s)){if(5===s.tag){var a=s.stateNode;if(Je(a))return!0}for(var o=s.child;null!==o;)r.push(o),o=o.sibling}}return!1},n.getCurrentUpdatePriority=ni,n.getFindAllNodesFailureDescription=function(e,t){if(!qe)throw new Error("Test selector API is not supported by this renderer.");for(var n=0,r=[],i=[Rh(e),0],s=0;s<i.length;){var a=i[s++],o=i[s++],l=t[o];if((5!==a.tag||!Qe(a))&&(Ch(a,l)&&(r.push(Ih(l)),++o>n&&(n=o)),o<t.length))for(var u=a.child;null!==u;)i.push(u,o),u=u.sibling}if(n<t.length){for(var c=[],d=n;d<t.length;d++)c.push(Ih(t[d]));return"findAllNodes was able to match part of the selector:\n  "+r.join(" > ")+"\n\nNo matching component was found for:\n  "+c.join(" > ")}return null},n.getPublicRootInstance=function(e){var t=e.current;return t.child?5===t.child.tag?Se(t.child.stateNode):t.child.stateNode:null},n.injectIntoDevTools=function(e){var t=e.findFiberByHostInstance,n=s.ReactCurrentDispatcher;return function(e){if("undefined"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var t=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(t.isDisabled)return!0;if(!t.supportsFiber)return l("The installed version of React DevTools is too old and will not work with the current version of React. Please update React DevTools. https://reactjs.org/link/react-devtools"),!0;try{e=c({},e,{getLaneLabelMap:Ei,injectProfilingHooks:Ti}),vi=t.inject(e),yi=t}catch(e){l("React instrumentation encountered an error: %s.",e)}return!!t.checkDCE}({bundleType:e.bundleType,version:e.version,rendererPackageName:e.rendererPackageName,rendererConfig:e.rendererConfig,overrideHookState:hm,overrideHookStateDeletePath:fm,overrideHookStateRenamePath:pm,overrideProps:mm,overridePropsDeletePath:gm,overridePropsRenamePath:vm,setErrorHandler:bm,setSuspenseHandler:_m,scheduleUpdate:ym,currentDispatcherRef:n,findHostInstanceByFiber:Rm,findFiberByHostInstance:t||Cm,findHostInstancesForRefresh:Bp,scheduleRefresh:kp,scheduleRoot:Op,setRefreshHandler:Cp,getCurrentFiber:Im,reconcilerVersion:"18.0.0-fc46dba67-20220329"})},n.isAlreadyRendering=function(){return(Qh&(Gh|Hh))!==zh},n.observeVisibleRects=function(e,t,n,r){if(!qe)throw new Error("Test selector API is not supported by this renderer.");var i=Ph(e,t),s=et(i,n,r),a=s.disconnect,o=s.observe,l=s.unobserve,u=function(){var n=Ph(e,t);i.forEach(function(e){n.indexOf(e)<0&&l(e)}),n.forEach(function(e){i.indexOf(e)<0&&o(e)})};return Nh.push(u),{disconnect:function(){var e=Nh.indexOf(u);e>=0&&Nh.splice(e,1),a()}}},n.registerMutableSourceForHydration=function(e,t){var n=(0,t._getVersion)(t._source);null==e.mutableSourceEagerHydrationData?e.mutableSourceEagerHydrationData=[t,n]:e.mutableSourceEagerHydrationData.push(t,n)},n.runWithPriority=function(e,t){var n=ti;try{return ti=e,t()}finally{ti=n}},n.shouldError=um,n.shouldSuspend=dm,n.updateContainer=sm,n})),Gf.exports}var $f,Wf=d((zf||(zf=1,"production"===process.env.NODE_ENV?Cf.exports=Bf():Cf.exports=Hf()),Cf.exports)),jf={exports:{}},qf={};var Xf,Yf,Kf={};function Qf(){return Xf||(Xf=1,e=Kf,"production"!==process.env.NODE_ENV&&function(){function t(e,t){var n=e.length;e.push(t),function(e,t,n){for(var r=n;r>0;){var s=r-1>>>1,a=e[s];if(!(i(a,t)>0))return;e[s]=t,e[r]=a,r=s}}(e,t,n)}function n(e){return 0===e.length?null:e[0]}function r(e){if(0===e.length)return null;var t=e[0],n=e.pop();return n!==t&&(e[0]=n,function(e,t,n){for(var r=n,s=e.length,a=s>>>1;r<a;){var o=2*(r+1)-1,l=e[o],u=o+1,c=e[u];if(i(l,t)<0)u<s&&i(c,l)<0?(e[r]=c,e[u]=t,r=u):(e[r]=l,e[o]=t,r=o);else{if(!(u<s&&i(c,t)<0))return;e[r]=c,e[u]=t,r=u}}}(e,n,0)),t}function i(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error),"object"==typeof performance&&"function"==typeof performance.now){var s=performance;e.unstable_now=function(){return s.now()}}else{var a=Date,o=a.now();e.unstable_now=function(){return a.now()-o}}var l=[],u=[],c=1,d=null,h=3,f=!1,p=!1,m=!1,g="function"==typeof setTimeout?setTimeout:null,v="function"==typeof clearTimeout?clearTimeout:null,y="undefined"!=typeof setImmediate?setImmediate:null;function b(e){for(var i=n(u);null!==i;){if(null===i.callback)r(u);else{if(!(i.startTime<=e))return;r(u),i.sortIndex=i.expirationTime,t(l,i)}i=n(u)}}function _(e){if(m=!1,b(e),!p)if(null!==n(l))p=!0,P(x);else{var t=n(u);null!==t&&N(_,t.startTime-e)}}function x(t,i){p=!1,m&&(m=!1,D()),f=!0;var s=h;try{return function(t,i){var s=i;for(b(s),d=n(l);null!==d&&(!(d.expirationTime>s)||t&&!M());){var a=d.callback;if("function"==typeof a){d.callback=null,h=d.priorityLevel;var o=a(d.expirationTime<=s);s=e.unstable_now(),"function"==typeof o?d.callback=o:d===n(l)&&r(l),b(s)}else r(l);d=n(l)}if(null!==d)return!0;var c=n(u);return null!==c&&N(_,c.startTime-s),!1}(t,i)}finally{d=null,h=s,f=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var S=!1,T=null,E=-1,A=5,w=-1;function M(){return!(e.unstable_now()-w<A)}var R,C=function(){if(null!==T){var t=e.unstable_now();w=t;var n=!0;try{n=T(!0,t)}finally{n?R():(S=!1,T=null)}}else S=!1};if("function"==typeof y)R=function(){y(C)};else if("undefined"!=typeof MessageChannel){var I=new MessageChannel,L=I.port2;I.port1.onmessage=C,R=function(){L.postMessage(null)}}else R=function(){g(C,0)};function P(e){T=e,S||(S=!0,R())}function N(t,n){E=g(function(){t(e.unstable_now())},n)}function D(){v(E),E=-1}var k=function(){};e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(e){e.callback=null},e.unstable_continueExecution=function(){p||f||(p=!0,P(x))},e.unstable_forceFrameRate=function(e){e<0||e>125||(A=e>0?Math.floor(1e3/e):5)},e.unstable_getCurrentPriorityLevel=function(){return h},e.unstable_getFirstCallbackNode=function(){return n(l)},e.unstable_next=function(e){var t;switch(h){case 1:case 2:case 3:t=3;break;default:t=h}var n=h;h=t;try{return e()}finally{h=n}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=k,e.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=h;h=e;try{return t()}finally{h=n}},e.unstable_scheduleCallback=function(r,i,s){var a,o,d=e.unstable_now();if("object"==typeof s&&null!==s){var h=s.delay;a="number"==typeof h&&h>0?d+h:d}else a=d;switch(r){case 1:o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}var g=a+o,v={id:c++,callback:i,priorityLevel:r,startTime:a,expirationTime:g,sortIndex:-1};return a>d?(v.sortIndex=a,t(u,v),null===n(l)&&v===n(u)&&(m?D():m=!0,N(_,a-d))):(v.sortIndex=g,t(l,v),p||f||(p=!0,P(x))),v},e.unstable_shouldYield=M,e.unstable_wrapCallback=function(e){var t=h;return function(){var n=h;h=t;try{return e.apply(this,arguments)}finally{h=n}}},"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error)}()),Kf;var e}var Zf=(Yf||(Yf=1,"production"===process.env.NODE_ENV?jf.exports=($f||($f=1,function(e){function t(e,t){var n=e.length;e.push(t);e:for(;0<n;){var r=n-1>>>1,s=e[r];if(!(0<i(s,t)))break e;e[r]=t,e[n]=s,n=r}}function n(e){return 0===e.length?null:e[0]}function r(e){if(0===e.length)return null;var t=e[0],n=e.pop();if(n!==t){e[0]=n;e:for(var r=0,s=e.length,a=s>>>1;r<a;){var o=2*(r+1)-1,l=e[o],u=o+1,c=e[u];if(0>i(l,n))u<s&&0>i(c,l)?(e[r]=c,e[u]=n,r=u):(e[r]=l,e[o]=n,r=o);else{if(!(u<s&&0>i(c,n)))break e;e[r]=c,e[u]=n,r=u}}}return t}function i(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var s=performance;e.unstable_now=function(){return s.now()}}else{var a=Date,o=a.now();e.unstable_now=function(){return a.now()-o}}var l=[],u=[],c=1,d=null,h=3,f=!1,p=!1,m=!1,g="function"==typeof setTimeout?setTimeout:null,v="function"==typeof clearTimeout?clearTimeout:null,y="undefined"!=typeof setImmediate?setImmediate:null;function b(e){for(var i=n(u);null!==i;){if(null===i.callback)r(u);else{if(!(i.startTime<=e))break;r(u),i.sortIndex=i.expirationTime,t(l,i)}i=n(u)}}function _(e){if(m=!1,b(e),!p)if(null!==n(l))p=!0,P(x);else{var t=n(u);null!==t&&N(_,t.startTime-e)}}function x(t,i){p=!1,m&&(m=!1,v(A),A=-1),f=!0;var s=h;try{for(b(i),d=n(l);null!==d&&(!(d.expirationTime>i)||t&&!R());){var a=d.callback;if("function"==typeof a){d.callback=null,h=d.priorityLevel;var o=a(d.expirationTime<=i);i=e.unstable_now(),"function"==typeof o?d.callback=o:d===n(l)&&r(l),b(i)}else r(l);d=n(l)}if(null!==d)var c=!0;else{var g=n(u);null!==g&&N(_,g.startTime-i),c=!1}return c}finally{d=null,h=s,f=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var S,T=!1,E=null,A=-1,w=5,M=-1;function R(){return!(e.unstable_now()-M<w)}function C(){if(null!==E){var t=e.unstable_now();M=t;var n=!0;try{n=E(!0,t)}finally{n?S():(T=!1,E=null)}}else T=!1}if("function"==typeof y)S=function(){y(C)};else if("undefined"!=typeof MessageChannel){var I=new MessageChannel,L=I.port2;I.port1.onmessage=C,S=function(){L.postMessage(null)}}else S=function(){g(C,0)};function P(e){E=e,T||(T=!0,S())}function N(t,n){A=g(function(){t(e.unstable_now())},n)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(e){e.callback=null},e.unstable_continueExecution=function(){p||f||(p=!0,P(x))},e.unstable_forceFrameRate=function(e){0>e||125<e||(w=0<e?Math.floor(1e3/e):5)},e.unstable_getCurrentPriorityLevel=function(){return h},e.unstable_getFirstCallbackNode=function(){return n(l)},e.unstable_next=function(e){switch(h){case 1:case 2:case 3:var t=3;break;default:t=h}var n=h;h=t;try{return e()}finally{h=n}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=function(){},e.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=h;h=e;try{return t()}finally{h=n}},e.unstable_scheduleCallback=function(r,i,s){var a=e.unstable_now();switch(s="object"==typeof s&&null!==s&&"number"==typeof(s=s.delay)&&0<s?a+s:a,r){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return r={id:c++,callback:i,priorityLevel:r,startTime:s,expirationTime:o=s+o,sortIndex:-1},s>a?(r.sortIndex=s,t(u,r),null===n(l)&&r===n(u)&&(m?(v(A),A=-1):m=!0,N(_,s-a))):(r.sortIndex=o,t(l,r),p||f||(p=!0,P(x))),r},e.unstable_shouldYield=R,e.unstable_wrapCallback=function(e){var t=h;return function(){var n=h;h=t;try{return e.apply(this,arguments)}finally{h=n}}}}(qf)),qf):jf.exports=Qf()),jf.exports);const Jf={},ep=e=>{Object.assign(Jf,e)};var tp,np;const rp=e=>"colorSpace"in e||"outputColorSpace"in e,ip=()=>{var e;return null!=(e=Jf.ColorManagement)?e:null},sp=e=>e&&e.isOrthographicCamera,ap="undefined"!=typeof window&&(null!=(tp=window.document)&&tp.createElement||"ReactNative"===(null==(np=window.navigator)?void 0:np.product))?e.useLayoutEffect:e.useEffect;function op(t){const n=e.useRef(t);return ap(()=>{n.current=t},[t]),n}function lp({set:e}){return ap(()=>(e(new Promise(()=>null)),()=>e(!1)),[e]),null}class up extends e.Component{constructor(...e){super(...e),this.state={error:!1}}componentDidCatch(e){this.props.set(e)}render(){return this.state.error?null:this.props.children}}up.getDerivedStateFromError=()=>({error:!0});const cp="__default",dp=new Map,hp=e=>e&&!!e.memoized&&!!e.changes;function fp(e){var t;const n="undefined"!=typeof window?null!=(t=window.devicePixelRatio)?t:2:1;return Array.isArray(e)?Math.min(Math.max(e[0],n),e[1]):e}const pp=e=>{var t;return null==(t=e.__r3f)?void 0:t.root.getState()};function mp(e){let t=e.__r3f.root;for(;t.getState().previousRoot;)t=t.getState().previousRoot;return t}const gp={obj:e=>e===Object(e)&&!gp.arr(e)&&"function"!=typeof e,fun:e=>"function"==typeof e,str:e=>"string"==typeof e,num:e=>"number"==typeof e,boo:e=>"boolean"==typeof e,und:e=>void 0===e,arr:e=>Array.isArray(e),equ(e,t,{arrays:n="shallow",objects:r="reference",strict:i=!0}={}){if(typeof e!=typeof t||!!e!=!!t)return!1;if(gp.str(e)||gp.num(e)||gp.boo(e))return e===t;const s=gp.obj(e);if(s&&"reference"===r)return e===t;const a=gp.arr(e);if(a&&"reference"===n)return e===t;if((a||s)&&e===t)return!0;let o;for(o in e)if(!(o in t))return!1;if(s&&"shallow"===n&&"shallow"===r){for(o in i?t:e)if(!gp.equ(e[o],t[o],{strict:i,objects:"reference"}))return!1}else for(o in i?t:e)if(e[o]!==t[o])return!1;if(gp.und(o)){if(a&&0===e.length&&0===t.length)return!0;if(s&&0===Object.keys(e).length&&0===Object.keys(t).length)return!0;if(e!==t)return!1}return!0}};function vp(e,t){return e.__r3f={type:"",root:null,previousAttach:null,memoizedProps:{},eventCount:0,handlers:{},objects:[],parent:null,...t},e}function yp(e,t){let n=e;if(t.includes("-")){const r=t.split("-"),i=r.pop();return n=r.reduce((e,t)=>e[t],e),{target:n,key:i}}return{target:n,key:t}}const bp=/-\d+$/;function _p(e,t,n){if(gp.str(n)){if(bp.test(n)){const t=n.replace(bp,""),{target:r,key:i}=yp(e,t);Array.isArray(r[i])||(r[i]=[])}const{target:r,key:i}=yp(e,n);t.__r3f.previousAttach=r[i],r[i]=t}else t.__r3f.previousAttach=n(e,t)}function xp(e,t,n){var r,i;if(gp.str(n)){const{target:r,key:i}=yp(e,n),s=t.__r3f.previousAttach;void 0===s?delete r[i]:r[i]=s}else null==(r=t.__r3f)||null==r.previousAttach||r.previousAttach(e,t);null==(i=t.__r3f)||delete i.previousAttach}function Sp(e,{children:t,key:n,ref:r,...i},{children:s,key:a,ref:o,...l}={},u=!1){const c=e.__r3f,d=Object.entries(i),h=[];if(u){const e=Object.keys(l);for(let t=0;t<e.length;t++)i.hasOwnProperty(e[t])||d.unshift([e[t],cp+"remove"])}d.forEach(([t,n])=>{var r;if(null!=(r=e.__r3f)&&r.primitive&&"object"===t)return;if(gp.equ(n,l[t]))return;if(/^on(Pointer|Click|DoubleClick|ContextMenu|Wheel)/.test(t))return h.push([t,n,!0,[]]);let s=[];t.includes("-")&&(s=t.split("-")),h.push([t,n,!1,s]);for(const e in i){const n=i[e];e.startsWith(`${t}-`)&&h.push([e,n,!1,e.split("-")])}});const f={...i};return null!=c&&c.memoizedProps&&null!=c&&c.memoizedProps.args&&(f.args=c.memoizedProps.args),null!=c&&c.memoizedProps&&null!=c&&c.memoizedProps.attach&&(f.attach=c.memoizedProps.attach),{memoized:f,changes:h}}const Tp="undefined"!=typeof process&&"production"!==process.env.NODE_ENV;function Ep(e,t){var n;const r=e.__r3f,i=null==r?void 0:r.root,s=null==i||null==i.getState?void 0:i.getState(),{memoized:a,changes:o}=hp(t)?t:Sp(e,t),l=null==r?void 0:r.eventCount;e.__r3f&&(e.__r3f.memoizedProps=a);for(let t=0;t<o.length;t++){let[n,i,a,l]=o[t];if(rp(e)){const e=3001,t="srgb",r="srgb-linear";"encoding"===n?(n="colorSpace",i=i===e?t:r):"outputEncoding"===n&&(n="outputColorSpace",i=i===e?t:r)}let d=e,h=d[n];if(l.length&&(h=l.reduce((e,t)=>e[t],e),!h||!h.set)){const[t,...r]=l.reverse();d=r.reverse().reduce((e,t)=>e[t],e),n=t}if(i===cp+"remove")if(d.constructor){let e=dp.get(d.constructor);e||(e=new d.constructor,dp.set(d.constructor,e)),i=e[n]}else i=0;if(a&&r)i?r.handlers[n]=i:delete r.handlers[n],r.eventCount=Object.keys(r.handlers).length;else if(h&&h.set&&(h.copy||h instanceof hr)){if(Array.isArray(i))h.fromArray?h.fromArray(i):h.set(...i);else if(h.copy&&i&&i.constructor&&(Tp?h.constructor.name===i.constructor.name:h.constructor===i.constructor))h.copy(i);else if(void 0!==i){var u;const e=null==(u=h)?void 0:u.isColor;!e&&h.setScalar?h.setScalar(i):h instanceof hr&&i instanceof hr?h.mask=i.mask:h.set(i),!ip()&&s&&!s.linear&&e&&h.convertSRGBToLinear()}}else{var c;if(d[n]=i,null!=(c=d[n])&&c.isTexture&&d[n].format===xe&&d[n].type===oe&&s){const e=d[n];rp(e)&&rp(s.gl)?e.colorSpace=s.gl.outputColorSpace:e.encoding=s.gl.outputEncoding}}Ap(e)}if(r&&r.parent&&e.raycast&&l!==r.eventCount){const t=mp(e).getState().internal,n=t.interaction.indexOf(e);n>-1&&t.interaction.splice(n,1),r.eventCount&&t.interaction.push(e)}return!(1===o.length&&"onUpdate"===o[0][0])&&o.length&&null!=(n=e.__r3f)&&n.parent&&wp(e),e}function Ap(e){var t,n;const r=null==(t=e.__r3f)||null==(n=t.root)||null==n.getState?void 0:n.getState();r&&0===r.internal.frames&&r.invalidate()}function wp(e){null==e.onUpdate||e.onUpdate(e)}function Mp(e){return(e.eventObject||e.object).uuid+"/"+e.index+e.instanceId}function Rp(e,t,n,r){const i=n.get(t);i&&(n.delete(t),0===n.size&&(e.delete(r),i.target.releasePointerCapture(r)))}function Cp(e){function t(e){return e.filter(e=>["Move","Over","Enter","Out","Leave"].some(t=>{var n;return null==(n=e.__r3f)?void 0:n.handlers["onPointer"+t]}))}function n(t){const{internal:n}=e.getState();for(const e of n.hovered.values())if(!t.length||!t.find(t=>t.object===e.object&&t.index===e.index&&t.instanceId===e.instanceId)){const r=e.eventObject.__r3f,i=null==r?void 0:r.handlers;if(n.hovered.delete(Mp(e)),null!=r&&r.eventCount){const n={...e,intersections:t};null==i.onPointerOut||i.onPointerOut(n),null==i.onPointerLeave||i.onPointerLeave(n)}}}function r(e,t){for(let n=0;n<t.length;n++){const r=t[n].__r3f;null==r||null==r.handlers.onPointerMissed||r.handlers.onPointerMissed(e)}}return{handlePointer:function(i){switch(i){case"onPointerLeave":case"onPointerCancel":return()=>n([]);case"onLostPointerCapture":return t=>{const{internal:r}=e.getState();"pointerId"in t&&r.capturedMap.has(t.pointerId)&&requestAnimationFrame(()=>{r.capturedMap.has(t.pointerId)&&(r.capturedMap.delete(t.pointerId),n([]))})}}return function(s){const{onPointerMissed:a,internal:o}=e.getState();o.lastEvent.current=s;const l="onPointerMove"===i,u="onClick"===i||"onContextMenu"===i||"onDoubleClick"===i,c=function(t,n){const r=e.getState(),i=new Set,s=[],a=n?n(r.internal.interaction):r.internal.interaction;for(let e=0;e<a.length;e++){const t=pp(a[e]);t&&(t.raycaster.camera=void 0)}r.previousRoot||null==r.events.compute||r.events.compute(t,r);let o=a.flatMap(function(e){const n=pp(e);return n&&n.events.enabled&&null!==n.raycaster.camera?(void 0===n.raycaster.camera&&(null==n.events.compute||n.events.compute(t,n,null==(r=n.previousRoot)?void 0:r.getState()),void 0===n.raycaster.camera&&(n.raycaster.camera=null)),n.raycaster.camera?n.raycaster.intersectObject(e,!0):[]):[];var r}).sort((e,t)=>{const n=pp(e.object),r=pp(t.object);return n&&r&&r.events.priority-n.events.priority||e.distance-t.distance}).filter(e=>{const t=Mp(e);return!i.has(t)&&(i.add(t),!0)});r.events.filter&&(o=r.events.filter(o,r));for(const e of o){let t=e.object;for(;t;){var l;null!=(l=t.__r3f)&&l.eventCount&&s.push({...e,eventObject:t}),t=t.parent}}if("pointerId"in t&&r.internal.capturedMap.has(t.pointerId))for(let e of r.internal.capturedMap.get(t.pointerId).values())i.has(Mp(e.intersection))||s.push(e.intersection);return s}(s,l?t:void 0),d=u?function(t){const{internal:n}=e.getState(),r=t.offsetX-n.initialClick[0],i=t.offsetY-n.initialClick[1];return Math.round(Math.sqrt(r*r+i*i))}(s):0;"onPointerDown"===i&&(o.initialClick=[s.offsetX,s.offsetY],o.initialHits=c.map(e=>e.eventObject)),u&&!c.length&&d<=2&&(r(s,o.interaction),a&&a(s)),l&&n(c),function(t,r,i,s){const a=e.getState();if(t.length){const e={stopped:!1};for(const o of t){const l=pp(o.object)||a,{raycaster:u,pointer:c,camera:d,internal:h}=l,f=new An(c.x,c.y,0).unproject(d),p=e=>{var t,n;return null!=(t=null==(n=h.capturedMap.get(e))?void 0:n.has(o.eventObject))&&t},m=e=>{const t={intersection:o,target:r.target};h.capturedMap.has(e)?h.capturedMap.get(e).set(o.eventObject,t):h.capturedMap.set(e,new Map([[o.eventObject,t]])),r.target.setPointerCapture(e)},g=e=>{const t=h.capturedMap.get(e);t&&Rp(h.capturedMap,o.eventObject,t,e)};let v={};for(let e in r){let t=r[e];"function"!=typeof t&&(v[e]=t)}let y={...o,...v,pointer:c,intersections:t,stopped:e.stopped,delta:i,unprojectedPoint:f,ray:u.ray,camera:d,stopPropagation(){const i="pointerId"in r&&h.capturedMap.get(r.pointerId);(!i||i.has(o.eventObject))&&(y.stopped=e.stopped=!0,h.hovered.size&&Array.from(h.hovered.values()).find(e=>e.eventObject===o.eventObject))&&n([...t.slice(0,t.indexOf(o)),o])},target:{hasPointerCapture:p,setPointerCapture:m,releasePointerCapture:g},currentTarget:{hasPointerCapture:p,setPointerCapture:m,releasePointerCapture:g},nativeEvent:r};if(s(y),!0===e.stopped)break}}}(c,s,d,function(e){const t=e.eventObject,n=t.__r3f,a=null==n?void 0:n.handlers;if(null!=n&&n.eventCount)if(l){if(a.onPointerOver||a.onPointerEnter||a.onPointerOut||a.onPointerLeave){const t=Mp(e),n=o.hovered.get(t);n?n.stopped&&e.stopPropagation():(o.hovered.set(t,e),null==a.onPointerOver||a.onPointerOver(e),null==a.onPointerEnter||a.onPointerEnter(e))}null==a.onPointerMove||a.onPointerMove(e)}else{const n=a[i];n?u&&!o.initialHits.includes(t)||(r(s,o.interaction.filter(e=>!o.initialHits.includes(e))),n(e)):u&&o.initialHits.includes(t)&&r(s,o.interaction.filter(e=>!o.initialHits.includes(e)))}})}}}}const Ip=e=>!(null==e||!e.render),Lp=e.createContext(null),Pp=(t,s)=>{const a=function(e){const t="function"==typeof e?Sf(e):e,s=(e=t.getState,s=Object.is)=>{const[,a]=n(e=>e+1,0),o=t.getState(),l=r(o),u=r(e),c=r(s),d=r(!1),h=r();let f;void 0===h.current&&(h.current=e(o));let p=!1;(l.current!==o||u.current!==e||c.current!==s||d.current)&&(f=e(o),p=!s(h.current,f)),Tf(()=>{p&&(h.current=f),l.current=o,u.current=e,c.current=s,d.current=!1});const m=r(o);Tf(()=>{const e=()=>{try{const e=t.getState(),n=u.current(e);c.current(h.current,n)||(l.current=e,h.current=n,a())}catch(e){d.current=!0,a()}},n=t.subscribe(e);return t.getState()!==m.current&&e(),n},[]);const g=p?f:h.current;return i(g),g};return Object.assign(s,t),s[Symbol.iterator]=function(){const e=[s,t];return{next(){const t=e.length<=0;return{value:e.shift(),done:t}}}},s}((n,r)=>{const i=new An,a=new An,o=new An;function l(e=r().camera,t=a,n=r().size){const{width:s,height:l,top:u,left:c}=n,d=s/l;t.isVector3?o.copy(t):o.set(...t);const h=e.getWorldPosition(i).distanceTo(o);if(sp(e))return{width:s/e.zoom,height:l/e.zoom,top:u,left:c,factor:1,distance:h,aspect:d};{const t=e.fov*Math.PI/180,n=2*Math.tan(t/2)*h,r=n*(s/l);return{width:r,height:n,top:u,left:c,factor:s/r,distance:h,aspect:d}}}let u;const c=e=>n(t=>({performance:{...t.performance,current:e}})),d=new Yt,h={set:n,get:r,gl:null,camera:null,raycaster:null,events:{priority:1,enabled:!0,connected:!1},xr:null,scene:null,invalidate:(e=1)=>t(r(),e),advance:(e,t)=>s(e,t,r()),legacy:!1,linear:!1,flat:!1,controls:null,clock:new Iu,pointer:d,mouse:d,frameloop:"always",onPointerMissed:void 0,performance:{current:1,min:.5,max:1,debounce:200,regress:()=>{const e=r();u&&clearTimeout(u),e.performance.current!==e.performance.min&&c(e.performance.min),u=setTimeout(()=>c(r().performance.max),e.performance.debounce)}},size:{width:0,height:0,top:0,left:0,updateStyle:!1},viewport:{initialDpr:0,dpr:0,width:0,height:0,top:0,left:0,aspect:0,distance:0,factor:0,getCurrentViewport:l},setEvents:e=>n(t=>({...t,events:{...t.events,...e}})),setSize:(e,t,i,s,o)=>{const u=r().camera,c={width:e,height:t,top:s||0,left:o||0,updateStyle:i};n(e=>({size:c,viewport:{...e.viewport,...l(u,a,c)}}))},setDpr:e=>n(t=>{const n=fp(e);return{viewport:{...t.viewport,dpr:n,initialDpr:t.viewport.initialDpr||n}}}),setFrameloop:(e="always")=>{const t=r().clock;t.stop(),t.elapsedTime=0,"never"!==e&&(t.start(),t.elapsedTime=0),n(()=>({frameloop:e}))},previousRoot:void 0,internal:{active:!1,priority:0,frames:0,lastEvent:e.createRef(),interaction:[],hovered:new Map,subscribers:[],initialClick:[0,0],initialHits:[],capturedMap:new Map,subscribe:(e,t,n)=>{const i=r().internal;return i.priority=i.priority+(t>0?1:0),i.subscribers.push({ref:e,priority:t,store:n}),i.subscribers=i.subscribers.sort((e,t)=>e.priority-t.priority),()=>{const n=r().internal;null!=n&&n.subscribers&&(n.priority=n.priority-(t>0?1:0),n.subscribers=n.subscribers.filter(t=>t.ref!==e))}}}};return h}),o=a.getState();let l=o.size,u=o.viewport.dpr,c=o.camera;return a.subscribe(()=>{const{camera:e,size:t,viewport:n,gl:r,set:i}=a.getState();if(t.width!==l.width||t.height!==l.height||n.dpr!==u){var s;l=t,u=n.dpr,function(e,t){e.manual||(sp(e)?(e.left=t.width/-2,e.right=t.width/2,e.top=t.height/2,e.bottom=t.height/-2):e.aspect=t.width/t.height,e.updateProjectionMatrix(),e.updateMatrixWorld())}(e,t),r.setPixelRatio(n.dpr);const i=null!=(s=t.updateStyle)?s:"undefined"!=typeof HTMLCanvasElement&&r.domElement instanceof HTMLCanvasElement;r.setSize(t.width,t.height,i)}e!==c&&(c=e,i(t=>({viewport:{...t.viewport,...t.viewport.getCurrentViewport(e)}})))}),a.subscribe(e=>t(e)),a};let Np,Dp,kp,Op=new Set,Fp=new Set,Up=new Set;function Bp(e,t){if(e.size)for(const{callback:n}of e.values())n(t)}function Vp(e,t){switch(e){case"before":return Bp(Op,t);case"after":return Bp(Fp,t);case"tail":return Bp(Up,t)}}function zp(e,t,n){let r=t.clock.getDelta();for("never"===t.frameloop&&"number"==typeof e&&(r=e-t.clock.elapsedTime,t.clock.oldTime=t.clock.elapsedTime,t.clock.elapsedTime=e),Dp=t.internal.subscribers,Np=0;Np<Dp.length;Np++)kp=Dp[Np],kp.ref.current(kp.store.getState(),r,n);return!t.internal.priority&&t.gl.render&&t.gl.render(t.scene,t.camera),t.internal.frames=Math.max(0,t.internal.frames-1),"always"===t.frameloop?1:t.internal.frames}function Gp(){const t=e.useContext(Lp);if(!t)throw new Error("R3F: Hooks can only be used within the Canvas component!");return t}function Hp(e=e=>e,t){return Gp()(e,t)}const $p=new WeakMap;function Wp(e,t){return function(n,...r){let i=$p.get(n);return i||(i=new n,$p.set(n,i)),e&&e(i),Promise.all(r.map(e=>new Promise((n,r)=>i.load(e,e=>{e.scene&&Object.assign(e,function(e){const t={nodes:{},materials:{}};return e&&e.traverse(e=>{e.name&&(t.nodes[e.name]=e),e.material&&!t.materials[e.material.name]&&(t.materials[e.material.name]=e.material)}),t}(e.scene)),n(e)},t,t=>r(new Error(`Could not load ${e}: ${null==t?void 0:t.message}`))))))}}function jp(e,t,n,r){const i=Array.isArray(t)?t:[t],s=Mf(Wp(n,r),[e,...i],{equal:gp.equ});return Array.isArray(t)?s:s[0]}jp.preload=function(e,t,n){const r=Array.isArray(t)?t:[t];return((e,t,n)=>{wf(e,t,!0,n)})(Wp(n),[e,...r])},jp.clear=function(e,t){return(e=>{if(void 0===e||0===e.length)Ef.splice(0,Ef.length);else{const t=Ef.find(t=>Af(e,t.keys,t.equal));t&&t.remove()}})([e,...Array.isArray(t)?t:[t]])};const qp=new Map,{invalidate:Xp,advance:Yp}=function(e){let t,n,r,i=!1,s=!1;function a(o){n=requestAnimationFrame(a),i=!0,t=0,Vp("before",o),s=!0;for(const n of e.values()){var l;r=n.store.getState(),!r.internal.active||!("always"===r.frameloop||r.internal.frames>0)||null!=(l=r.gl.xr)&&l.isPresenting||(t+=zp(o,r))}if(s=!1,Vp("after",o),0===t)return Vp("tail",o),i=!1,cancelAnimationFrame(n)}return{loop:a,invalidate:function t(n,r=1){var o;if(!n)return e.forEach(e=>t(e.store.getState(),r));null!=(o=n.gl.xr)&&o.isPresenting||!n.internal.active||"never"===n.frameloop||(n.internal.frames=r>1?Math.min(60,n.internal.frames+r):s?2:1,i||(i=!0,requestAnimationFrame(a)))},advance:function(t,n=!0,r,i){if(n&&Vp("before",t),r)zp(t,r,i);else for(const n of e.values())zp(t,n.store.getState());n&&Vp("after",t)}}}(qp),{reconciler:Kp,applyProps:Qp}=function(e,t){function n(e,{args:t=[],attach:n,...r},i){let s,a=`${e[0].toUpperCase()}${e.slice(1)}`;if("primitive"===e){if(void 0===r.object)throw new Error("R3F: Primitives without 'object' are invalid!");s=vp(r.object,{type:e,root:i,attach:n,primitive:!0})}else{const r=Jf[a];if(!r)throw new Error(`R3F: ${a} is not part of the THREE namespace! Did you forget to extend? See: https://docs.pmnd.rs/react-three-fiber/api/objects#using-3rd-party-objects-declaratively`);if(!Array.isArray(t))throw new Error("R3F: The args prop must be an array!");s=vp(new r(...t),{type:e,root:i,attach:n,memoizedProps:{args:t}})}return void 0===s.__r3f.attach&&(s.isBufferGeometry?s.__r3f.attach="geometry":s.isMaterial&&(s.__r3f.attach="material")),"inject"!==a&&Ep(s,r),s}function r(e,t){let n=!1;var r,i;t&&(null!=(r=t.__r3f)&&r.attach?_p(e,t,t.__r3f.attach):t.isObject3D&&e.isObject3D&&(e.add(t),n=!0),n||null==(i=e.__r3f)||i.objects.push(t),t.__r3f||vp(t,{}),t.__r3f.parent=e,wp(t),Ap(t))}function i(e,t,n){let r=!1;if(t){var i,s;if(null!=(i=t.__r3f)&&i.attach)_p(e,t,t.__r3f.attach);else if(t.isObject3D&&e.isObject3D){t.parent=e,t.dispatchEvent({type:"added"}),e.dispatchEvent({type:"childadded",child:t});const i=e.children.filter(e=>e!==t),s=i.indexOf(n);e.children=[...i.slice(0,s),t,...i.slice(s)],r=!0}r||null==(s=e.__r3f)||s.objects.push(t),t.__r3f||vp(t,{}),t.__r3f.parent=e,wp(t),Ap(t)}}function s(e,t,n=!1){e&&[...e].forEach(e=>a(t,e,n))}function a(e,t,n){if(t){var r,i,a;if(t.__r3f&&(t.__r3f.parent=null),null!=(r=e.__r3f)&&r.objects&&(e.__r3f.objects=e.__r3f.objects.filter(e=>e!==t)),null!=(i=t.__r3f)&&i.attach)xp(e,t,t.__r3f.attach);else if(t.isObject3D&&e.isObject3D){var o;e.remove(t),null!=(o=t.__r3f)&&o.root&&function(e,t){const{internal:n}=e.getState();n.interaction=n.interaction.filter(e=>e!==t),n.initialHits=n.initialHits.filter(e=>e!==t),n.hovered.forEach((e,r)=>{e.eventObject!==t&&e.object!==t||n.hovered.delete(r)}),n.capturedMap.forEach((e,r)=>{Rp(n.capturedMap,t,e,r)})}(mp(t),t)}const u=null==(a=t.__r3f)?void 0:a.primitive,c=!u&&(void 0===n?null!==t.dispose:n);var l;if(!u)s(null==(l=t.__r3f)?void 0:l.objects,t,c),s(t.children,t,c);if(delete t.__r3f,c&&t.dispose&&"Scene"!==t.type){const e=()=>{try{t.dispose()}catch(e){}};"undefined"==typeof IS_REACT_ACT_ENVIRONMENT?Zf.unstable_scheduleCallback(Zf.unstable_IdlePriority,e):e()}Ap(e)}}const o=()=>{},l=Wf({createInstance:n,removeChild:a,appendChild:r,appendInitialChild:r,insertBefore:i,supportsMutation:!0,isPrimaryRenderer:!1,supportsPersistence:!1,supportsHydration:!1,noTimeout:-1,appendChildToContainer:(e,t)=>{if(!t)return;const n=e.getState().scene;n.__r3f&&(n.__r3f.root=e,r(n,t))},removeChildFromContainer:(e,t)=>{t&&a(e.getState().scene,t)},insertInContainerBefore:(e,t,n)=>{if(!t||!n)return;const r=e.getState().scene;r.__r3f&&i(r,t,n)},getRootHostContext:()=>null,getChildHostContext:e=>e,finalizeInitialChildren(e){var t;const n=null!=(t=null==e?void 0:e.__r3f)?t:{};return Boolean(n.handlers)},prepareUpdate(e,t,n,r){var i;if((null!=(i=null==e?void 0:e.__r3f)?i:{}).primitive&&r.object&&r.object!==e)return[!0];{const{args:t=[],children:i,...s}=r,{args:a=[],children:o,...l}=n;if(!Array.isArray(t))throw new Error("R3F: the args prop must be an array!");if(t.some((e,t)=>e!==a[t]))return[!0];const u=Sp(e,s,l,!0);return u.changes.length?[!1,u]:null}},commitUpdate(e,[t,i],s,o,l,u){t?function(e,t,i,s){var o;const l=null==(o=e.__r3f)?void 0:o.parent;if(!l)return;const u=n(t,i,e.__r3f.root);if(e.children){for(const t of e.children)t.__r3f&&r(u,t);e.children=e.children.filter(e=>!e.__r3f)}e.__r3f.objects.forEach(e=>r(u,e)),e.__r3f.objects=[],e.__r3f.autoRemovedBeforeAppend||a(l,e),u.parent&&(u.__r3f.autoRemovedBeforeAppend=!0),r(l,u),u.raycast&&u.__r3f.eventCount&&mp(u).getState().internal.interaction.push(u);[s,s.alternate].forEach(e=>{null!==e&&(e.stateNode=u,e.ref&&("function"==typeof e.ref?e.ref(u):e.ref.current=u))})}(e,s,l,u):Ep(e,i)},commitMount(e,t,n,r){var i;const s=null!=(i=e.__r3f)?i:{};e.raycast&&s.handlers&&s.eventCount&&mp(e).getState().internal.interaction.push(e)},getPublicInstance:e=>e,prepareForCommit:()=>null,preparePortalMount:e=>vp(e.getState().scene),resetAfterCommit:()=>{},shouldSetTextContent:()=>!1,clearContainer:()=>!1,hideInstance(e){var t;const{attach:n,parent:r}=null!=(t=e.__r3f)?t:{};n&&r&&xp(r,e,n),e.isObject3D&&(e.visible=!1),Ap(e)},unhideInstance(e,t){var n;const{attach:r,parent:i}=null!=(n=e.__r3f)?n:{};r&&i&&_p(i,e,r),(e.isObject3D&&null==t.visible||t.visible)&&(e.visible=!0),Ap(e)},createTextInstance:o,hideTextInstance:o,unhideTextInstance:o,getCurrentEventPriority:()=>t?t():xf.DefaultEventPriority,beforeActiveInstanceBlur:()=>{},afterActiveInstanceBlur:()=>{},detachDeletedInstance:()=>{},now:"undefined"!=typeof performance&&gp.fun(performance.now)?performance.now:gp.fun(Date.now)?Date.now:()=>0,scheduleTimeout:gp.fun(setTimeout)?setTimeout:void 0,cancelTimeout:gp.fun(clearTimeout)?clearTimeout:void 0});return{reconciler:l,applyProps:Ep}}(0,function(){var e;const t="undefined"!=typeof self&&self||"undefined"!=typeof window&&window;if(!t)return xf.DefaultEventPriority;switch(null==(e=t.event)?void 0:e.type){case"click":case"contextmenu":case"dblclick":case"pointercancel":case"pointerdown":case"pointerup":return xf.DiscreteEventPriority;case"pointermove":case"pointerout":case"pointerover":case"pointerenter":case"pointerleave":case"wheel":return xf.ContinuousEventPriority;default:return xf.DefaultEventPriority}}),Zp={objects:"shallow",strict:!1},Jp=(e,t)=>{const n="function"==typeof e?e(t):e;return Ip(n)?n:new ff({powerPreference:"high-performance",canvas:t,antialias:!0,alpha:!0,...e})};function em(e){const t=qp.get(e),n=null==t?void 0:t.fiber,r=null==t?void 0:t.store,i="function"==typeof reportError?reportError:console.error,s=r||Pp(Xp,Yp),a=n||Kp.createContainer(s,xf.ConcurrentRoot,null,!1,null,"",i,null);let o;t||qp.set(e,{fiber:a,store:s});let l,c=!1;return{configure(t={}){let{gl:n,size:r,scene:i,events:a,onCreated:u,shadows:d=!1,linear:h=!1,flat:f=!1,legacy:p=!1,orthographic:m=!1,frameloop:g="always",dpr:v=[1,2],performance:y,raycaster:b,camera:_,onPointerMissed:x}=t,S=s.getState(),T=S.gl;S.gl||S.set({gl:T=Jp(n,e)});let E=S.raycaster;E||S.set({raycaster:E=new tc});const{params:A,...w}=b||{};if(gp.equ(w,E,Zp)||Qp(E,{...w}),gp.equ(A,E.params,Zp)||Qp(E,{params:{...E.params,...A}}),!S.camera||S.camera===l&&!gp.equ(l,_,Zp)){l=_;const e=_ instanceof Fi,t=e?_:m?new uu(0,0,0,0,.1,1e3):new zi(75,0,.1,1e3);e||(t.position.z=5,_&&(Qp(t,_),("aspect"in _||"left"in _||"right"in _||"bottom"in _||"top"in _)&&(t.manual=!0,t.updateProjectionMatrix())),S.camera||null!=_&&_.rotation||t.lookAt(0,0,0)),S.set({camera:t}),E.camera=t}if(!S.scene){let e;null!=i&&i.isScene?e=i:(e=new Xi,i&&Qp(e,i)),S.set({scene:vp(e)})}if(!S.xr){var M;const e=(e,t)=>{const n=s.getState();"never"!==n.frameloop&&Yp(e,!0,n,t)},t=()=>{const t=s.getState();t.gl.xr.enabled=t.gl.xr.isPresenting,t.gl.xr.setAnimationLoop(t.gl.xr.isPresenting?e:null),t.gl.xr.isPresenting||Xp(t)},n={connect(){const e=s.getState().gl;e.xr.addEventListener("sessionstart",t),e.xr.addEventListener("sessionend",t)},disconnect(){const e=s.getState().gl;e.xr.removeEventListener("sessionstart",t),e.xr.removeEventListener("sessionend",t)}};"function"==typeof(null==(M=T.xr)?void 0:M.addEventListener)&&n.connect(),S.set({xr:n})}if(T.shadowMap){const e=T.shadowMap.enabled,t=T.shadowMap.type;if(T.shadowMap.enabled=!!d,gp.boo(d))T.shadowMap.type=2;else if(gp.str(d)){var R;const e={basic:0,percentage:1,soft:2,variance:3};T.shadowMap.type=null!=(R=e[d])?R:2}else gp.obj(d)&&Object.assign(T.shadowMap,d);e===T.shadowMap.enabled&&t===T.shadowMap.type||(T.shadowMap.needsUpdate=!0)}const C=ip();if(C&&("enabled"in C?C.enabled=!p:"legacyMode"in C&&(C.legacyMode=p)),!c){Qp(T,{outputEncoding:h?3e3:3001,toneMapping:f?0:4})}S.legacy!==p&&S.set(()=>({legacy:p})),S.linear!==h&&S.set(()=>({linear:h})),S.flat!==f&&S.set(()=>({flat:f})),!n||gp.fun(n)||Ip(n)||gp.equ(n,T,Zp)||Qp(T,n),a&&!S.events.handlers&&S.set({events:a(s)});const I=function(e,t){const n="undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement;if(t){const{width:e,height:r,top:i,left:s,updateStyle:a=n}=t;return{width:e,height:r,top:i,left:s,updateStyle:a}}if("undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement&&e.parentElement){const{width:t,height:r,top:i,left:s}=e.parentElement.getBoundingClientRect();return{width:t,height:r,top:i,left:s,updateStyle:n}}return"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas?{width:e.width,height:e.height,top:0,left:0,updateStyle:n}:{width:0,height:0,top:0,left:0}}(e,r);return gp.equ(I,S.size,Zp)||S.setSize(I.width,I.height,I.updateStyle,I.top,I.left),v&&S.viewport.dpr!==fp(v)&&S.setDpr(v),S.frameloop!==g&&S.setFrameloop(g),S.onPointerMissed||S.set({onPointerMissed:x}),y&&!gp.equ(y,S.performance,Zp)&&S.set(e=>({performance:{...e.performance,...y}})),o=u,c=!0,this},render(t){return c||this.configure(),Kp.updateContainer(u(tm,{store:s,children:t,onCreated:o,rootElement:e}),a,null,()=>{}),s},unmount(){nm(e)}}}function tm({store:e,children:t,onCreated:n,rootElement:r}){return ap(()=>{const t=e.getState();t.set(e=>({internal:{...e.internal,active:!0}})),n&&n(t),e.getState().events.connected||null==t.events.connect||t.events.connect(r)},[]),u(Lp.Provider,{value:e,children:t})}function nm(e,t){const n=qp.get(e),r=null==n?void 0:n.fiber;if(r){const i=null==n?void 0:n.store.getState();i&&(i.internal.active=!1),Kp.updateContainer(null,r,null,()=>{i&&setTimeout(()=>{try{var n,r,s,a;null==i.events.disconnect||i.events.disconnect(),null==(n=i.gl)||null==(r=n.renderLists)||null==r.dispose||r.dispose(),null==(s=i.gl)||null==s.forceContextLoss||s.forceContextLoss(),null!=(a=i.gl)&&a.xr&&i.xr.disconnect(),function(e){e.dispose&&"Scene"!==e.type&&e.dispose();for(const t in e)null==t.dispose||t.dispose(),delete e[t]}(i),qp.delete(e),t&&t(e)}catch(e){}},500)})}}Kp.injectIntoDevTools({bundleType:"production"===process.env.NODE_ENV?0:1,rendererPackageName:"@react-three/fiber",version:e.version});const rm={onClick:["click",!1],onContextMenu:["contextmenu",!1],onDoubleClick:["dblclick",!1],onWheel:["wheel",!0],onPointerDown:["pointerdown",!0],onPointerUp:["pointerup",!0],onPointerLeave:["pointerleave",!0],onPointerMove:["pointermove",!0],onPointerCancel:["pointercancel",!0],onLostPointerCapture:["lostpointercapture",!0]};function im(e){const{handlePointer:t}=Cp(e);return{priority:1,enabled:!0,compute(e,t,n){t.pointer.set(e.offsetX/t.size.width*2-1,-e.offsetY/t.size.height*2+1),t.raycaster.setFromCamera(t.pointer,t.camera)},connected:void 0,handlers:Object.keys(rm).reduce((e,n)=>({...e,[n]:t(n)}),{}),update:()=>{var t;const{events:n,internal:r}=e.getState();null!=(t=r.lastEvent)&&t.current&&n.handlers&&n.handlers.onPointerMove(r.lastEvent.current)},connect:t=>{var n;const{set:r,events:i}=e.getState();null==i.disconnect||i.disconnect(),r(e=>({events:{...e.events,connected:t}})),Object.entries(null!=(n=i.handlers)?n:[]).forEach(([e,n])=>{const[r,i]=rm[e];t.addEventListener(r,n,{passive:i})})},disconnect:()=>{const{set:t,events:n}=e.getState();var r;n.connected&&(Object.entries(null!=(r=n.handlers)?r:[]).forEach(([e,t])=>{if(n&&n.connected instanceof HTMLElement){const[r]=rm[e];n.connected.removeEventListener(r,t)}}),t(e=>({events:{...e.events,connected:void 0}})))}}}function sm(e,t){let n;return(...r)=>{window.clearTimeout(n),n=window.setTimeout(()=>e(...r),t)}}function am({debounce:e,scroll:t,polyfill:n,offsetSize:i}={debounce:0,scroll:!1,offsetSize:!1}){const a=n||("undefined"==typeof window?class{}:window.ResizeObserver);if(!a)throw new Error("This browser does not support ResizeObserver out of the box. See: https://github.com/react-spring/react-use-measure/#resize-observer-polyfills");const[u,c]=o({left:0,top:0,width:0,height:0,bottom:0,right:0,x:0,y:0}),d=r({element:null,scrollContainers:null,resizeObserver:null,lastBounds:u,orientationHandler:null}),h=e?"number"==typeof e?e:e.scroll:null,f=e?"number"==typeof e?e:e.resize:null,p=r(!1);s(()=>(p.current=!0,()=>{p.current=!1}));const[m,g,v]=l(()=>{const e=()=>{if(!d.current.element)return;const{left:e,top:t,width:n,height:r,bottom:s,right:a,x:o,y:l}=d.current.element.getBoundingClientRect(),u={left:e,top:t,width:n,height:r,bottom:s,right:a,x:o,y:l};d.current.element instanceof HTMLElement&&i&&(u.height=d.current.element.offsetHeight,u.width=d.current.element.offsetWidth),Object.freeze(u),p.current&&!um(d.current.lastBounds,u)&&c(d.current.lastBounds=u)};return[e,f?sm(e,f):e,h?sm(e,h):e]},[c,i,h,f]);function y(){d.current.scrollContainers&&(d.current.scrollContainers.forEach(e=>e.removeEventListener("scroll",v,!0)),d.current.scrollContainers=null),d.current.resizeObserver&&(d.current.resizeObserver.disconnect(),d.current.resizeObserver=null),d.current.orientationHandler&&("orientation"in screen&&"removeEventListener"in screen.orientation?screen.orientation.removeEventListener("change",d.current.orientationHandler):"onorientationchange"in window&&window.removeEventListener("orientationchange",d.current.orientationHandler))}function b(){d.current.element&&(d.current.resizeObserver=new a(v),d.current.resizeObserver.observe(d.current.element),t&&d.current.scrollContainers&&d.current.scrollContainers.forEach(e=>e.addEventListener("scroll",v,{capture:!0,passive:!0})),d.current.orientationHandler=()=>{v()},"orientation"in screen&&"addEventListener"in screen.orientation?screen.orientation.addEventListener("change",d.current.orientationHandler):"onorientationchange"in window&&window.addEventListener("orientationchange",d.current.orientationHandler))}return function(e,t){s(()=>{if(t){const t=e;return window.addEventListener("scroll",t,{capture:!0,passive:!0}),()=>{window.removeEventListener("scroll",t,!0)}}},[e,t])}(v,!!t),function(e){s(()=>{const t=e;return window.addEventListener("resize",t),()=>{window.removeEventListener("resize",t)}},[e])}(g),s(()=>{y(),b()},[t,v,g]),s(()=>y,[]),[e=>{!e||e===d.current.element||(y(),d.current.element=e,d.current.scrollContainers=om(e),b())},u,m]}function om(e){const t=[];if(!e||e===document.body)return t;const{overflow:n,overflowX:r,overflowY:i}=window.getComputedStyle(e);return[n,r,i].some(e=>"auto"===e||"scroll"===e)&&t.push(e),[...t,...om(e.parentElement)]}const lm=["x","y","top","bottom","left","right","width","height"],um=(e,t)=>lm.every(n=>e[n]===t[n]);var cm,dm,hm=Object.defineProperty,fm=Object.defineProperties,pm=Object.getOwnPropertyDescriptors,mm=Object.getOwnPropertySymbols,gm=Object.prototype.hasOwnProperty,vm=Object.prototype.propertyIsEnumerable,ym=(e,t,n)=>t in e?hm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,bm=(e,t)=>{for(var n in t||(t={}))gm.call(t,n)&&ym(e,n,t[n]);if(mm)for(var n of mm(t))vm.call(t,n)&&ym(e,n,t[n]);return e};function _m(e,t,n){if(!e)return;if(!0===n(e))return e;let r=t?e.return:e.child;for(;r;){const e=_m(r,t,n);if(e)return e;r=t?null:r.sibling}}function xm(e){try{return Object.defineProperties(e,{_currentRenderer:{get:()=>null,set(){}},_currentRenderer2:{get:()=>null,set(){}}})}catch(t){return e}}"undefined"==typeof window||!(null==(cm=window.document)?void 0:cm.createElement)&&"ReactNative"!==(null==(dm=window.navigator)?void 0:dm.product)?e.useEffect:e.useLayoutEffect;const Sm=console.error;console.error=function(){const e=[...arguments].join("");if(!(null==e?void 0:e.startsWith("Warning:"))||!e.includes("useContext"))return Sm.apply(this,arguments);console.error=Sm};const Tm=xm(e.createContext(null));class Em extends e.Component{render(){return e.createElement(Tm.Provider,{value:this._reactInternals},this.props.children)}}function Am(){const t=function(){const t=e.useContext(Tm);if(null===t)throw new Error("its-fine: useFiber must be called within a <FiberProvider />!");const n=e.useId();return e.useMemo(()=>{for(const e of[t,null==t?void 0:t.alternate]){if(!e)continue;const t=_m(e,!1,e=>{let t=e.memoizedState;for(;t;){if(t.memoizedState===n)return!0;t=t.next}});if(t)return t}},[t,n])}(),[n]=e.useState(()=>new Map);n.clear();let r=t;for(;r;){if(r.type&&"object"==typeof r.type){const t=void 0===r.type._context&&r.type.Provider===r.type?r.type:r.type._context;t&&t!==Tm&&!n.has(t)&&n.set(t,e.useContext(xm(t)))}r=r.return}return n}function wm(){const t=Am();return e.useMemo(()=>Array.from(t.keys()).reduce((n,r)=>i=>{return e.createElement(n,null,e.createElement(r.Provider,(s=bm({},i),a={value:t.get(r)},fm(s,pm(a)))));var s,a},t=>e.createElement(Em,bm({},t))),[t])}const Mm=e.forwardRef(function({children:t,fallback:n,resize:r,style:i,gl:s,events:a=im,eventSource:o,eventPrefix:l,shadows:c,linear:d,flat:h,legacy:f,orthographic:p,frameloop:m,dpr:g,performance:v,raycaster:y,camera:b,scene:_,onPointerMissed:x,onCreated:S,...T},E){e.useMemo(()=>ep(mf),[]);const A=wm(),[w,M]=am({scroll:!0,debounce:{scroll:50,resize:0},...r}),R=e.useRef(null),C=e.useRef(null);e.useImperativeHandle(E,()=>R.current);const I=op(x),[L,P]=e.useState(!1),[N,D]=e.useState(!1);if(L)throw L;if(N)throw N;const k=e.useRef(null);ap(()=>{const n=R.current;M.width>0&&M.height>0&&n&&(k.current||(k.current=em(n)),k.current.configure({gl:s,events:a,shadows:c,linear:d,flat:h,legacy:f,orthographic:p,frameloop:m,dpr:g,performance:v,raycaster:y,camera:b,scene:_,size:M,onPointerMissed:(...e)=>null==I.current?void 0:I.current(...e),onCreated:e=>{var t;null==e.events.connect||e.events.connect(o?(t=o)&&t.hasOwnProperty("current")?o.current:o:C.current),l&&e.setEvents({compute:(e,t)=>{const n=e[l+"X"],r=e[l+"Y"];t.pointer.set(n/t.size.width*2-1,-r/t.size.height*2+1),t.raycaster.setFromCamera(t.pointer,t.camera)}}),null==S||S(e)}}),k.current.render(u(A,{children:u(up,{set:D,children:u(e.Suspense,{fallback:u(lp,{set:P}),children:null!=t?t:null})})})))}),e.useEffect(()=>{const e=R.current;if(e)return()=>nm(e)},[]);return u("div",{ref:C,style:{position:"relative",width:"100%",height:"100%",overflow:"hidden",pointerEvents:o?"none":"auto",...i},...T,children:u("div",{ref:w,style:{width:"100%",height:"100%"},children:u("canvas",{ref:R,style:{display:"block"},children:n})})})}),Rm=e.forwardRef(function(e,t){return u(Em,{children:u(Mm,{...e,ref:t})})});var Cm=Object.defineProperty,Im=(e,t,n)=>(((e,t,n)=>{t in e?Cm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Lm{constructor(){Im(this,"_listeners")}addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;const n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const n=this._listeners[e];if(void 0!==n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const n=t.slice(0);for(let t=0,r=n.length;t<r;t++)n[t].call(this,e);e.target=null}}}var Pm=Object.defineProperty,Nm=(e,t,n)=>(((e,t,n)=>{t in e?Pm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Dm=new er,km=new $s,Om=Math.cos(Math.PI/180*70),Fm=(e,t)=>(e%t+t)%t;class Um extends Lm{constructor(e,t){super(),Nm(this,"object"),Nm(this,"domElement"),Nm(this,"enabled",!0),Nm(this,"target",new An),Nm(this,"minDistance",0),Nm(this,"maxDistance",1/0),Nm(this,"minZoom",0),Nm(this,"maxZoom",1/0),Nm(this,"minPolarAngle",0),Nm(this,"maxPolarAngle",Math.PI),Nm(this,"minAzimuthAngle",-1/0),Nm(this,"maxAzimuthAngle",1/0),Nm(this,"enableDamping",!1),Nm(this,"dampingFactor",.05),Nm(this,"enableZoom",!0),Nm(this,"zoomSpeed",1),Nm(this,"enableRotate",!0),Nm(this,"rotateSpeed",1),Nm(this,"enablePan",!0),Nm(this,"panSpeed",1),Nm(this,"screenSpacePanning",!0),Nm(this,"keyPanSpeed",7),Nm(this,"zoomToCursor",!1),Nm(this,"autoRotate",!1),Nm(this,"autoRotateSpeed",2),Nm(this,"reverseOrbit",!1),Nm(this,"reverseHorizontalOrbit",!1),Nm(this,"reverseVerticalOrbit",!1),Nm(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),Nm(this,"mouseButtons",{LEFT:f.ROTATE,MIDDLE:f.DOLLY,RIGHT:f.PAN}),Nm(this,"touches",{ONE:p.ROTATE,TWO:p.DOLLY_PAN}),Nm(this,"target0"),Nm(this,"position0"),Nm(this,"zoom0"),Nm(this,"_domElementKeyEvents",null),Nm(this,"getPolarAngle"),Nm(this,"getAzimuthalAngle"),Nm(this,"setPolarAngle"),Nm(this,"setAzimuthalAngle"),Nm(this,"getDistance"),Nm(this,"getZoomScale"),Nm(this,"listenToKeyEvents"),Nm(this,"stopListenToKeyEvents"),Nm(this,"saveState"),Nm(this,"reset"),Nm(this,"update"),Nm(this,"connect"),Nm(this,"dispose"),Nm(this,"dollyIn"),Nm(this,"dollyOut"),Nm(this,"getScale"),Nm(this,"setScale"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>u.phi,this.getAzimuthalAngle=()=>u.theta,this.setPolarAngle=e=>{let t=Fm(e,2*Math.PI),r=u.phi;r<0&&(r+=2*Math.PI),t<0&&(t+=2*Math.PI);let i=Math.abs(t-r);2*Math.PI-i<i&&(t<r?t+=2*Math.PI:r+=2*Math.PI),c.phi=t-r,n.update()},this.setAzimuthalAngle=e=>{let t=Fm(e,2*Math.PI),r=u.theta;r<0&&(r+=2*Math.PI),t<0&&(t+=2*Math.PI);let i=Math.abs(t-r);2*Math.PI-i<i&&(t<r?t+=2*Math.PI:r+=2*Math.PI),c.theta=t-r,n.update()},this.getDistance=()=>n.object.position.distanceTo(n.target),this.listenToKeyEvents=e=>{e.addEventListener("keydown",Z),this._domElementKeyEvents=e},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",Z),this._domElementKeyEvents=null},this.saveState=()=>{n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=()=>{n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(r),n.update(),o=a.NONE},this.update=(()=>{const t=new An,i=new An(0,1,0),s=(new En).setFromUnitVectors(e.up,i),f=s.clone().invert(),p=new An,m=new En,g=2*Math.PI;return function(){const v=n.object.position;s.setFromUnitVectors(e.up,i),f.copy(s).invert(),t.copy(v).sub(n.target),t.applyQuaternion(s),u.setFromVector3(t),n.autoRotate&&o===a.NONE&&I(2*Math.PI/60/60*n.autoRotateSpeed),n.enableDamping?(u.theta+=c.theta*n.dampingFactor,u.phi+=c.phi*n.dampingFactor):(u.theta+=c.theta,u.phi+=c.phi);let y=n.minAzimuthAngle,b=n.maxAzimuthAngle;isFinite(y)&&isFinite(b)&&(y<-Math.PI?y+=g:y>Math.PI&&(y-=g),b<-Math.PI?b+=g:b>Math.PI&&(b-=g),u.theta=y<=b?Math.max(y,Math.min(b,u.theta)):u.theta>(y+b)/2?Math.max(y,u.theta):Math.min(b,u.theta)),u.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,u.phi)),u.makeSafe(),!0===n.enableDamping?n.target.addScaledVector(h,n.dampingFactor):n.target.add(h),n.zoomToCursor&&w||n.object.isOrthographicCamera?u.radius=B(u.radius):u.radius=B(u.radius*d),t.setFromSpherical(u),t.applyQuaternion(f),v.copy(n.target).add(t),n.object.matrixAutoUpdate||n.object.updateMatrix(),n.object.lookAt(n.target),!0===n.enableDamping?(c.theta*=1-n.dampingFactor,c.phi*=1-n.dampingFactor,h.multiplyScalar(1-n.dampingFactor)):(c.set(0,0,0),h.set(0,0,0));let _=!1;if(n.zoomToCursor&&w){let r=null;if(n.object instanceof zi&&n.object.isPerspectiveCamera){const e=t.length();r=B(e*d);const i=e-r;n.object.position.addScaledVector(E,i),n.object.updateMatrixWorld()}else if(n.object.isOrthographicCamera){const e=new An(A.x,A.y,0);e.unproject(n.object),n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/d)),n.object.updateProjectionMatrix(),_=!0;const i=new An(A.x,A.y,0);i.unproject(n.object),n.object.position.sub(i).add(e),n.object.updateMatrixWorld(),r=t.length()}else n.zoomToCursor=!1;null!==r&&(n.screenSpacePanning?n.target.set(0,0,-1).transformDirection(n.object.matrix).multiplyScalar(r).add(n.object.position):(Dm.origin.copy(n.object.position),Dm.direction.set(0,0,-1).transformDirection(n.object.matrix),Math.abs(n.object.up.dot(Dm.direction))<Om?e.lookAt(n.target):(km.setFromNormalAndCoplanarPoint(n.object.up,n.target),Dm.intersectPlane(km,n.target))))}else n.object instanceof uu&&n.object.isOrthographicCamera&&(_=1!==d,_&&(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/d)),n.object.updateProjectionMatrix()));return d=1,w=!1,!!(_||p.distanceToSquared(n.object.position)>l||8*(1-m.dot(n.object.quaternion))>l)&&(n.dispatchEvent(r),p.copy(n.object.position),m.copy(n.object.quaternion),_=!1,!0)}})(),this.connect=e=>{n.domElement=e,n.domElement.style.touchAction="none",n.domElement.addEventListener("contextmenu",J),n.domElement.addEventListener("pointerdown",X),n.domElement.addEventListener("pointercancel",K),n.domElement.addEventListener("wheel",Q)},this.dispose=()=>{var e,t,r,i,s,a;n.domElement&&(n.domElement.style.touchAction="auto"),null==(e=n.domElement)||e.removeEventListener("contextmenu",J),null==(t=n.domElement)||t.removeEventListener("pointerdown",X),null==(r=n.domElement)||r.removeEventListener("pointercancel",K),null==(i=n.domElement)||i.removeEventListener("wheel",Q),null==(s=n.domElement)||s.ownerDocument.removeEventListener("pointermove",Y),null==(a=n.domElement)||a.ownerDocument.removeEventListener("pointerup",K),null!==n._domElementKeyEvents&&n._domElementKeyEvents.removeEventListener("keydown",Z)};const n=this,r={type:"change"},i={type:"start"},s={type:"end"},a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let o=a.NONE;const l=1e-6,u=new ic,c=new ic;let d=1;const h=new An,m=new Yt,g=new Yt,v=new Yt,y=new Yt,b=new Yt,_=new Yt,x=new Yt,S=new Yt,T=new Yt,E=new An,A=new Yt;let w=!1;const M=[],R={};function C(){return Math.pow(.95,n.zoomSpeed)}function I(e){n.reverseOrbit||n.reverseHorizontalOrbit?c.theta+=e:c.theta-=e}function L(e){n.reverseOrbit||n.reverseVerticalOrbit?c.phi+=e:c.phi-=e}const P=(()=>{const e=new An;return function(t,n){e.setFromMatrixColumn(n,0),e.multiplyScalar(-t),h.add(e)}})(),N=(()=>{const e=new An;return function(t,r){!0===n.screenSpacePanning?e.setFromMatrixColumn(r,1):(e.setFromMatrixColumn(r,0),e.crossVectors(n.object.up,e)),e.multiplyScalar(t),h.add(e)}})(),D=(()=>{const e=new An;return function(t,r){const i=n.domElement;if(i&&n.object instanceof zi&&n.object.isPerspectiveCamera){const s=n.object.position;e.copy(s).sub(n.target);let a=e.length();a*=Math.tan(n.object.fov/2*Math.PI/180),P(2*t*a/i.clientHeight,n.object.matrix),N(2*r*a/i.clientHeight,n.object.matrix)}else i&&n.object instanceof uu&&n.object.isOrthographicCamera?(P(t*(n.object.right-n.object.left)/n.object.zoom/i.clientWidth,n.object.matrix),N(r*(n.object.top-n.object.bottom)/n.object.zoom/i.clientHeight,n.object.matrix)):n.enablePan=!1}})();function k(e){n.object instanceof zi&&n.object.isPerspectiveCamera||n.object instanceof uu&&n.object.isOrthographicCamera?d=e:n.enableZoom=!1}function O(e){k(d/e)}function F(e){k(d*e)}function U(e){if(!n.zoomToCursor||!n.domElement)return;w=!0;const t=n.domElement.getBoundingClientRect(),r=e.clientX-t.left,i=e.clientY-t.top,s=t.width,a=t.height;A.x=r/s*2-1,A.y=-i/a*2+1,E.set(A.x,A.y,1).unproject(n.object).sub(n.object.position).normalize()}function B(e){return Math.max(n.minDistance,Math.min(n.maxDistance,e))}function V(e){m.set(e.clientX,e.clientY)}function z(e){y.set(e.clientX,e.clientY)}function G(){if(1==M.length)m.set(M[0].pageX,M[0].pageY);else{const e=.5*(M[0].pageX+M[1].pageX),t=.5*(M[0].pageY+M[1].pageY);m.set(e,t)}}function H(){if(1==M.length)y.set(M[0].pageX,M[0].pageY);else{const e=.5*(M[0].pageX+M[1].pageX),t=.5*(M[0].pageY+M[1].pageY);y.set(e,t)}}function $(){const e=M[0].pageX-M[1].pageX,t=M[0].pageY-M[1].pageY,n=Math.sqrt(e*e+t*t);x.set(0,n)}function W(e){if(1==M.length)g.set(e.pageX,e.pageY);else{const t=te(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);g.set(n,r)}v.subVectors(g,m).multiplyScalar(n.rotateSpeed);const t=n.domElement;t&&(I(2*Math.PI*v.x/t.clientHeight),L(2*Math.PI*v.y/t.clientHeight)),m.copy(g)}function j(e){if(1==M.length)b.set(e.pageX,e.pageY);else{const t=te(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);b.set(n,r)}_.subVectors(b,y).multiplyScalar(n.panSpeed),D(_.x,_.y),y.copy(b)}function q(e){const t=te(e),r=e.pageX-t.x,i=e.pageY-t.y,s=Math.sqrt(r*r+i*i);S.set(0,s),T.set(0,Math.pow(S.y/x.y,n.zoomSpeed)),O(T.y),x.copy(S)}function X(e){var t,r;!1!==n.enabled&&(0===M.length&&(null==(t=n.domElement)||t.ownerDocument.addEventListener("pointermove",Y),null==(r=n.domElement)||r.ownerDocument.addEventListener("pointerup",K)),function(e){M.push(e)}(e),"touch"===e.pointerType?function(e){switch(ee(e),M.length){case 1:switch(n.touches.ONE){case p.ROTATE:if(!1===n.enableRotate)return;G(),o=a.TOUCH_ROTATE;break;case p.PAN:if(!1===n.enablePan)return;H(),o=a.TOUCH_PAN;break;default:o=a.NONE}break;case 2:switch(n.touches.TWO){case p.DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;n.enableZoom&&$(),n.enablePan&&H(),o=a.TOUCH_DOLLY_PAN;break;case p.DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;n.enableZoom&&$(),n.enableRotate&&G(),o=a.TOUCH_DOLLY_ROTATE;break;default:o=a.NONE}break;default:o=a.NONE}o!==a.NONE&&n.dispatchEvent(i)}(e):function(e){let t;switch(e.button){case 0:t=n.mouseButtons.LEFT;break;case 1:t=n.mouseButtons.MIDDLE;break;case 2:t=n.mouseButtons.RIGHT;break;default:t=-1}switch(t){case f.DOLLY:if(!1===n.enableZoom)return;!function(e){U(e),x.set(e.clientX,e.clientY)}(e),o=a.DOLLY;break;case f.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enablePan)return;z(e),o=a.PAN}else{if(!1===n.enableRotate)return;V(e),o=a.ROTATE}break;case f.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enableRotate)return;V(e),o=a.ROTATE}else{if(!1===n.enablePan)return;z(e),o=a.PAN}break;default:o=a.NONE}o!==a.NONE&&n.dispatchEvent(i)}(e))}function Y(e){!1!==n.enabled&&("touch"===e.pointerType?function(e){switch(ee(e),o){case a.TOUCH_ROTATE:if(!1===n.enableRotate)return;W(e),n.update();break;case a.TOUCH_PAN:if(!1===n.enablePan)return;j(e),n.update();break;case a.TOUCH_DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&q(e),n.enablePan&&j(e)}(e),n.update();break;case a.TOUCH_DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&q(e),n.enableRotate&&W(e)}(e),n.update();break;default:o=a.NONE}}(e):function(e){if(!1===n.enabled)return;switch(o){case a.ROTATE:if(!1===n.enableRotate)return;!function(e){g.set(e.clientX,e.clientY),v.subVectors(g,m).multiplyScalar(n.rotateSpeed);const t=n.domElement;t&&(I(2*Math.PI*v.x/t.clientHeight),L(2*Math.PI*v.y/t.clientHeight)),m.copy(g),n.update()}(e);break;case a.DOLLY:if(!1===n.enableZoom)return;!function(e){S.set(e.clientX,e.clientY),T.subVectors(S,x),T.y>0?O(C()):T.y<0&&F(C()),x.copy(S),n.update()}(e);break;case a.PAN:if(!1===n.enablePan)return;!function(e){b.set(e.clientX,e.clientY),_.subVectors(b,y).multiplyScalar(n.panSpeed),D(_.x,_.y),y.copy(b),n.update()}(e)}}(e))}function K(e){var t,r,i;!function(e){delete R[e.pointerId];for(let t=0;t<M.length;t++)if(M[t].pointerId==e.pointerId)return void M.splice(t,1)}(e),0===M.length&&(null==(t=n.domElement)||t.releasePointerCapture(e.pointerId),null==(r=n.domElement)||r.ownerDocument.removeEventListener("pointermove",Y),null==(i=n.domElement)||i.ownerDocument.removeEventListener("pointerup",K)),n.dispatchEvent(s),o=a.NONE}function Q(e){!1===n.enabled||!1===n.enableZoom||o!==a.NONE&&o!==a.ROTATE||(e.preventDefault(),n.dispatchEvent(i),function(e){U(e),e.deltaY<0?F(C()):e.deltaY>0&&O(C()),n.update()}(e),n.dispatchEvent(s))}function Z(e){!1!==n.enabled&&!1!==n.enablePan&&function(e){let t=!1;switch(e.code){case n.keys.UP:D(0,n.keyPanSpeed),t=!0;break;case n.keys.BOTTOM:D(0,-n.keyPanSpeed),t=!0;break;case n.keys.LEFT:D(n.keyPanSpeed,0),t=!0;break;case n.keys.RIGHT:D(-n.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),n.update())}(e)}function J(e){!1!==n.enabled&&e.preventDefault()}function ee(e){let t=R[e.pointerId];void 0===t&&(t=new Yt,R[e.pointerId]=t),t.set(e.pageX,e.pageY)}function te(e){const t=e.pointerId===M[0].pointerId?M[1]:M[0];return R[t.pointerId]}this.dollyIn=(e=C())=>{F(e),n.update()},this.dollyOut=(e=C())=>{O(e),n.update()},this.getScale=()=>d,this.setScale=e=>{k(e),n.update()},this.getZoomScale=()=>C(),void 0!==t&&this.connect(t),this.update()}}const Bm=e=>e===Object(e)&&!Array.isArray(e)&&"function"!=typeof e;function Vm(e,t){const n=Hp(e=>e.gl),r=jp(Yl,Bm(e)?Object.values(e):e);a(()=>{null==t||t(r)},[t]),s(()=>{if("initTexture"in n){let e=[];Array.isArray(r)?e=r:r instanceof yn?e=[r]:Bm(r)&&(e=Object.values(r)),e.forEach(e=>{e instanceof yn&&n.initTexture(e)})}},[n,r]);const i=l(()=>{if(Bm(e)){const t={};let n=0;for(const i in e)t[i]=r[n++];return t}return r},[e,r]);return i}Vm.preload=e=>jp.preload(Yl,e),Vm.clear=e=>jp.clear(Yl,e);const zm=e.forwardRef(({makeDefault:t,camera:n,regress:r,domElement:i,enableDamping:s=!0,keyEvents:a=!1,onChange:o,onStart:l,onEnd:u,...d},h)=>{const f=Hp(e=>e.invalidate),p=Hp(e=>e.camera),m=Hp(e=>e.gl),g=Hp(e=>e.events),v=Hp(e=>e.setEvents),y=Hp(e=>e.set),b=Hp(e=>e.get),_=Hp(e=>e.performance),x=n||p,S=i||g.connected||m.domElement,T=e.useMemo(()=>new Um(x),[x]);return function(e,t=0){const n=Gp(),r=n.getState().internal.subscribe,i=op(e);ap(()=>r(i,t,n),[t,r,n])}(()=>{T.enabled&&T.update()},-1),e.useEffect(()=>(a&&T.connect(!0===a?S:a),T.connect(S),()=>{T.dispose()}),[a,S,r,T,f]),e.useEffect(()=>{const e=e=>{f(),r&&_.regress(),o&&o(e)},t=e=>{l&&l(e)},n=e=>{u&&u(e)};return T.addEventListener("change",e),T.addEventListener("start",t),T.addEventListener("end",n),()=>{T.removeEventListener("start",t),T.removeEventListener("end",n),T.removeEventListener("change",e)}},[o,l,u,T,f,v]),e.useEffect(()=>{if(t){const e=b().controls;return y({controls:T}),()=>y({controls:e})}},[t,T]),e.createElement("primitive",c({ref:h,object:T,enableDamping:s},d))}),Gm=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},Hm=Number.isSafeInteger||function(e){return"number"==typeof e&&Math.abs(e)<=$m},$m=Number.MAX_SAFE_INTEGER||9007199254740991;let Wm=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),jm=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",e.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",e.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.ASSET_LIST_LOAD_ERROR="assetListLoadError",e.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",e.ASSET_LIST_PARSING_ERROR="assetListParsingError",e.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.ATTACH_MEDIA_ERROR="attachMediaError",e.UNKNOWN="unknown",e}({}),qm=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.MEDIA_ENDED="hlsMediaEnded",e.STALL_RESOLVED="hlsStallResolved",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFERED_TO_END="hlsBufferedToEnd",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",e.ASSET_LIST_LOADING="hlsAssetListLoading",e.ASSET_LIST_LOADED="hlsAssetListLoaded",e.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",e.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",e.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",e.INTERSTITIAL_STARTED="hlsInterstitialStarted",e.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",e.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",e.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",e.INTERSTITIAL_ENDED="hlsInterstitialEnded",e.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",e.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",e.EVENT_CUE_ENTER="hlsEventCueEnter",e}({});var Xm="manifest",Ym="level",Km="audioTrack",Qm="subtitleTrack",Zm={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class Jm{constructor(e,t=0,n=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=n}sample(e,t){const n=Math.pow(this.alpha_,e);this.estimate_=t*(1-n)+n*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class eg{constructor(e,t,n,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=n,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Jm(e),this.fast_=new Jm(t),this.defaultTTFB_=r,this.ttfb_=new Jm(e)}update(e,t){const{slow_:n,fast_:r,ttfb_:i}=this;n.halfLife!==e&&(this.slow_=new Jm(e,n.getEstimate(),n.getTotalWeight())),r.halfLife!==t&&(this.fast_=new Jm(t,r.getEstimate(),r.getTotalWeight())),i.halfLife!==e&&(this.ttfb_=new Jm(e,i.getEstimate(),i.getTotalWeight()))}sample(e,t){const n=(e=Math.max(e,this.minDelayMs_))/1e3,r=8*t/n;this.fast_.sample(n,r),this.slow_.sample(n,r)}sampleTTFB(e){const t=e/1e3,n=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(n,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function tg(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ng(){return ng=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},ng.apply(null,arguments)}function rg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function ig(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?rg(Object(n),!0).forEach(function(t){tg(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rg(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class sg{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const n=`[${e}]:`;this.trace=ag,this.debug=t.debug.bind(null,n),this.log=t.log.bind(null,n),this.warn=t.warn.bind(null,n),this.info=t.info.bind(null,n),this.error=t.error.bind(null,n)}}const ag=function(){},og={trace:ag,debug:ag,log:ag,warn:ag,info:ag,error:ag};function lg(){return ng({},og)}function ug(e,t,n){return t[e]?t[e].bind(t):function(e,t){const n=self.console[e];return n?n.bind(self.console,`${t?"["+t+"] ":""}[${e}] >`):ag}(e,n)}const cg=lg();const dg=cg;function hg(e=!0){if("undefined"==typeof self)return;return(e||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function fg(e,t){const n=Object.keys(e),r=Object.keys(t),i=n.length,s=r.length;return!i||!s||i===s&&!n.some(e=>-1===r.indexOf(e))}function pg(e,t=!1){if("undefined"!=typeof TextDecoder){const n=new TextDecoder("utf-8").decode(e);if(t){const e=n.indexOf("\0");return-1!==e?n.substring(0,e):n}return n.replace(/\0/g,"")}const n=e.length;let r,i,s,a="",o=0;for(;o<n;){if(r=e[o++],0===r&&t)return a;if(0!==r&&3!==r)switch(r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(r);break;case 12:case 13:i=e[o++],a+=String.fromCharCode((31&r)<<6|63&i);break;case 14:i=e[o++],s=e[o++],a+=String.fromCharCode((15&r)<<12|(63&i)<<6|63&s)}}return a}const mg=function(e){let t="";for(let n=0;n<e.length;n++){let r=e[n].toString(16);r.length<2&&(r="0"+r),t+=r}return t};function gg(e){return Uint8Array.from(e.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function vg(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var yg,bg={exports:{}};var _g,xg,Sg,Tg,Eg,Ag=yg?bg.exports:(yg=1,_g=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,xg=/^(?=([^\/?#]*))\1([^]*)$/,Sg=/(?:\/|^)\.(?=\/)/g,Tg=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,bg.exports=Eg={buildAbsoluteURL:function(e,t,n){if(n=n||{},e=e.trim(),!(t=t.trim())){if(!n.alwaysNormalize)return e;var r=Eg.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");return r.path=Eg.normalizePath(r.path),Eg.buildURLFromParts(r)}var i=Eg.parseURL(t);if(!i)throw new Error("Error trying to parse relative URL.");if(i.scheme)return n.alwaysNormalize?(i.path=Eg.normalizePath(i.path),Eg.buildURLFromParts(i)):t;var s=Eg.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");if(!s.netLoc&&s.path&&"/"!==s.path[0]){var a=xg.exec(s.path);s.netLoc=a[1],s.path=a[2]}s.netLoc&&!s.path&&(s.path="/");var o={scheme:s.scheme,netLoc:i.netLoc,path:null,params:i.params,query:i.query,fragment:i.fragment};if(!i.netLoc&&(o.netLoc=s.netLoc,"/"!==i.path[0]))if(i.path){var l=s.path,u=l.substring(0,l.lastIndexOf("/")+1)+i.path;o.path=Eg.normalizePath(u)}else o.path=s.path,i.params||(o.params=s.params,i.query||(o.query=s.query));return null===o.path&&(o.path=n.alwaysNormalize?Eg.normalizePath(i.path):i.path),Eg.buildURLFromParts(o)},parseURL:function(e){var t=_g.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(Sg,"");e.length!==(e=e.replace(Tg,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}});class wg{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var Mg="audio",Rg="video",Cg="audiovideo";class Ig{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,"string"==typeof e&&(e={url:e}),this.base=e,function(e,t){const n=Dg(e,t);n&&(n.enumerable=!0,Object.defineProperty(e,t,n))}(this,"stats")}setByteRange(e,t){const n=e.split("@",2);let r;r=1===n.length?(null==t?void 0:t.byteRangeEndOffset)||0:parseInt(n[1]),this._byteRange=[r,parseInt(n[0])+r]}get baseurl(){return this.base.url}get byteRange(){return null===this._byteRange?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return null===this._streams&&(this._streams={[Mg]:null,[Rg]:null,[Cg]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return null!==this._stats}get hasStreams(){return null!==this._streams}get stats(){return null===this._stats&&(this._stats=new wg),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Ag.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[Mg]=null,e[Rg]=null,e[Cg]=null}}function Lg(e){return"initSegment"!==e.sn}class Pg extends Ig{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange){const e=this.byteRange[0],t=this.byteRange[1];if(Gm(e)&&Gm(t))return t-e}return null}get bitrate(){return this.byteLength?8*this.byteLength/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const e=Object.keys(this.levelkeys);if(1===e.length)return this._decryptdata=this.levelkeys[e[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;const e=Gm(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),t=e.length;if(t>1||1===t&&this.levelkeys[e[0]].encrypted)return!0}return!1}get programDateTime(){return null===this._programDateTime&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){Gm(e)?this._programDateTime=e:this._programDateTime=this.rawProgramDateTime=null}get ref(){return Lg(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}setElementaryStreamInfo(e,t,n,r,i,s=!1){const{elementaryStreams:a}=this,o=a[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,n),o.startDTS=Math.min(o.startDTS,r),o.endDTS=Math.max(o.endDTS,i)):a[e]={startPTS:t,endPTS:n,startDTS:r,endDTS:i,partial:s}}}class Ng extends Ig{constructor(e,t,n,r,i){super(n),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=r;const s=e.enumeratedString("BYTERANGE");s&&this.setByteRange(s,i),i&&(this.fragOffset=i.fragOffset+i.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function Dg(e,t){const n=Object.getPrototypeOf(e);if(n){const e=Object.getOwnPropertyDescriptor(n,t);return e||Dg(n,t)}}const kg=Math.pow(2,32)-1,Og=[].push,Fg={video:1,audio:2,id3:3,text:4};function Ug(e){return String.fromCharCode.apply(null,e)}function Bg(e,t){const n=e[t]<<8|e[t+1];return n<0?65536+n:n}function Vg(e,t){const n=Gg(e,t);return n<0?4294967296+n:n}function zg(e,t){let n=Vg(e,t);return n*=Math.pow(2,32),n+=Vg(e,t+4),n}function Gg(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function Hg(e,t){const n=[];if(!t.length)return n;const r=e.byteLength;for(let i=0;i<r;){const s=Vg(e,i),a=s>1?i+s:r;if(Ug(e.subarray(i+4,i+8))===t[0])if(1===t.length)n.push(e.subarray(i+8,a));else{const r=Hg(e.subarray(i+8,a),t.slice(1));r.length&&Og.apply(n,r)}i=a}return n}function $g(e){const t=[],n=e[0];let r=8;const i=Vg(e,r);r+=4;let s=0,a=0;0===n?(s=Vg(e,r),a=Vg(e,r+4),r+=8):(s=zg(e,r),a=zg(e,r+8),r+=16),r+=2;let o=e.length+a;const l=Bg(e,r);r+=2;for(let n=0;n<l;n++){let n=r;const s=Vg(e,n);n+=4;const a=2147483647&s;if(1===(2147483648&s)>>>31)return dg.warn("SIDX has hierarchical references (not supported)"),null;const l=Vg(e,n);n+=4,t.push({referenceSize:a,subsegmentDuration:l,info:{duration:l/i,start:o,end:o+a-1}}),o+=a,n+=4,r=n}return{earliestPresentationTime:s,timescale:i,version:n,referencesCount:l,references:t}}function Wg(e){const t=[],n=Hg(e,["moov","trak"]);for(let e=0;e<n.length;e++){const r=n[e],i=Hg(r,["tkhd"])[0];if(i){let e=i[0];const n=Vg(i,0===e?12:20),s=Hg(r,["mdia","mdhd"])[0];if(s){e=s[0];const i=Vg(s,0===e?12:20),a=Hg(r,["mdia","hdlr"])[0];if(a){const e=Ug(a.subarray(8,12)),s={soun:Mg,vide:Rg}[e],o=jg(Hg(r,["mdia","minf","stbl","stsd"])[0]);s?(t[n]={timescale:i,type:s,stsd:o},t[s]=ig({timescale:i,id:n},o)):t[n]={timescale:i,type:e,stsd:o}}}}}return Hg(e,["moov","mvex","trex"]).forEach(e=>{const n=Vg(e,4),r=t[n];r&&(r.default={duration:Vg(e,12),flags:Vg(e,20)})}),t}function jg(e){const t=e.subarray(8),n=t.subarray(86),r=Ug(t.subarray(4,8));let i,s=r;const a="enca"===r||"encv"===r;if(a){const e=Hg(t,[r])[0];Hg(e.subarray("enca"===r?28:78),["sinf"]).forEach(e=>{const t=Hg(e,["schm"])[0];if(t){const n=Ug(t.subarray(4,8));if("cbcs"===n||"cenc"===n){const t=Hg(e,["frma"])[0];t&&(s=Ug(t))}}})}const o=s;switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const e=Hg(n,["avcC"])[0];e&&e.length>3&&(s+="."+Yg(e[1])+Yg(e[2])+Yg(e[3]),i=qg("avc1"===o?"dva1":"dvav",n));break}case"mp4a":{const e=Hg(t,[r])[0],n=Hg(e.subarray(28),["esds"])[0];if(n&&n.length>7){let e=4;if(3!==n[e++])break;e=Xg(n,e),e+=2;const t=n[e++];if(128&t&&(e+=2),64&t&&(e+=n[e++]),4!==n[e++])break;e=Xg(n,e);const r=n[e++];if(64!==r)break;if(s+="."+Yg(r),e+=12,5!==n[e++])break;e=Xg(n,e);const i=n[e++];let a=(248&i)>>3;31===a&&(a+=1+((7&i)<<3)+((224&n[e])>>5)),s+="."+a}break}case"hvc1":case"hev1":{const e=Hg(n,["hvcC"])[0];if(e&&e.length>12){const t=e[1],n=["","A","B","C"][t>>6],r=31&t,i=Vg(e,2),a=(32&t)>>5?"H":"L",o=e[12],l=e.subarray(6,12);s+="."+n+r,s+="."+function(e){let t=0;for(let n=0;n<32;n++)t|=(e>>n&1)<<31-n;return t>>>0}(i).toString(16).toUpperCase(),s+="."+a+o;let u="";for(let e=l.length;e--;){const t=l[e];if(t||u){u="."+t.toString(16).toUpperCase()+u}}s+=u}i=qg("hev1"==o?"dvhe":"dvh1",n);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":s=qg(s,n)||s;break;case"vp09":{const e=Hg(n,["vpcC"])[0];if(e&&e.length>6){const t=e[4],n=e[5],r=e[6]>>4&15;s+="."+Kg(t)+"."+Kg(n)+"."+Kg(r)}break}case"av01":{const e=Hg(n,["av1C"])[0];if(e&&e.length>2){const t=e[1]>>>5,r=31&e[1],a=e[2]>>>7?"H":"M",o=(64&e[2])>>6,l=(32&e[2])>>5,u=2===t&&o?l?12:10:o?10:8,c=(16&e[2])>>4,d=(8&e[2])>>3,h=(4&e[2])>>2,f=3&e[2],p=1,m=1,g=1,v=0;s+="."+t+"."+Kg(r)+a+"."+Kg(u)+"."+c+"."+d+h+f+"."+Kg(p)+"."+Kg(m)+"."+Kg(g)+"."+v,i=qg("dav1",n)}break}}return{codec:s,encrypted:a,supplemental:i}}function qg(e,t){const n=Hg(t,["dvvC"]),r=n.length?n[0]:Hg(t,["dvcC"])[0];if(r){const t=r[2]>>1&127,n=r[2]<<5&32|r[3]>>3&31;return e+"."+Kg(t)+"."+Kg(n)}}function Xg(e,t){const n=t+5;for(;128&e[t++]&&t<n;);return t}function Yg(e){return("0"+e.toString(16).toUpperCase()).slice(-2)}function Kg(e){return(e<10?"0":"")+e}function Qg(e,t){if(!e||!t)return e;const n=t.keyId;if(n&&t.isCommonEncryption){Hg(e,["moov","trak"]).forEach(e=>{const t=Hg(e,["mdia","minf","stbl","stsd"])[0].subarray(8);let r=Hg(t,["enca"]);const i=r.length>0;i||(r=Hg(t,["encv"])),r.forEach(e=>{Hg(i?e.subarray(28):e.subarray(78),["sinf"]).forEach(e=>{const t=function(e){const t=Hg(e,["schm"])[0];if(t){const n=Ug(t.subarray(4,8));if("cbcs"===n||"cenc"===n)return Hg(e,["schi","tenc"])[0]}return null}(e);if(t){const e=t.subarray(8,24);e.some(e=>0!==e)||(dg.log(`[eme] Patching keyId in 'enc${i?"a":"v"}>sinf>>tenc' box: ${mg(e)} -> ${mg(n)}`),t.set(n,8))}})})})}return e}function Zg(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function Jg(e,t){const n=[],r=t.samples,i=t.timescale,s=t.id;let a=!1;return Hg(r,["moof"]).map(o=>{const l=o.byteOffset-8;Hg(o,["traf"]).map(o=>{const u=Hg(o,["tfdt"]).map(e=>{const t=e[0];let n=Vg(e,4);return 1===t&&(n*=Math.pow(2,32),n+=Vg(e,8)),n/i})[0];return void 0!==u&&(e=u),Hg(o,["tfhd"]).map(u=>{const c=Vg(u,4),d=16777215&Vg(u,0);let h=0;const f=!!(16&d);let p=0;const m=!!(32&d);let g=8;c===s&&(!!(1&d)&&(g+=8),!!(2&d)&&(g+=4),!!(8&d)&&(h=Vg(u,g),g+=4),f&&(p=Vg(u,g),g+=4),m&&(g+=4),"video"===t.type&&(a=ev(t.codec)),Hg(o,["trun"]).map(s=>{const o=s[0],u=16777215&Vg(s,0),c=!!(1&u);let d=0;const f=!!(4&u),m=!!(256&u);let g=0;const v=!!(512&u);let y=0;const b=!!(1024&u),_=!!(2048&u);let x=0;const S=Vg(s,4);let T=8;c&&(d=Vg(s,T),T+=4),f&&(T+=4);let E=d+l;for(let l=0;l<S;l++){if(m?(g=Vg(s,T),T+=4):g=h,v?(y=Vg(s,T),T+=4):y=p,b&&(T+=4),_&&(x=0===o?Vg(s,T):Gg(s,T),T+=4),t.type===Rg){let t=0;for(;t<y;){const s=Vg(r,E);if(E+=4,tv(a,r[E])){nv(r.subarray(E,E+s),a?2:1,e+x/i,n)}E+=s,t+=s+4}}e+=g/i}}))})})}),n}function ev(e){if(!e)return!1;const t=e.substring(0,4);return"hvc1"===t||"hev1"===t||"dvh1"===t||"dvhe"===t}function tv(e,t){if(e){const e=t>>1&63;return 39===e||40===e}return 6===(31&t)}function nv(e,t,n,r){const i=rv(e);let s=0;s+=t;let a=0,o=0,l=0;for(;s<i.length;){a=0;do{if(s>=i.length)break;l=i[s++],a+=l}while(255===l);o=0;do{if(s>=i.length)break;l=i[s++],o+=l}while(255===l);const e=i.length-s;let t=s;if(o<e)s+=o;else if(o>e){dg.error(`Malformed SEI payload. ${o} is too small, only ${e} bytes left to parse.`);break}if(4===a){if(181===i[t++]){const e=Bg(i,t);if(t+=2,49===e){const e=Vg(i,t);if(t+=4,1195456820===e){const e=i[t++];if(3===e){const s=i[t++],o=64&s,l=o?2+3*(31&s):0,u=new Uint8Array(l);if(o){u[0]=s;for(let e=1;e<l;e++)u[e]=i[t++]}r.push({type:e,payloadType:a,pts:n,bytes:u})}}}}}else if(5===a&&o>16){const e=[];for(let n=0;n<16;n++){const r=i[t++].toString(16);e.push(1==r.length?"0"+r:r),3!==n&&5!==n&&7!==n&&9!==n||e.push("-")}const s=o-16,l=new Uint8Array(s);for(let e=0;e<s;e++)l[e]=i[t++];r.push({payloadType:a,pts:n,uuid:e.join(""),userData:pg(l),userDataBytes:l})}}}function rv(e){const t=e.byteLength,n=[];let r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(n.push(r+2),r+=2):r++;if(0===n.length)return e;const i=t-n.length,s=new Uint8Array(i);let a=0;for(r=0;r<i;a++,r++)a===n[0]&&(a++,n.shift()),s[r]=e[a];return s}function iv(e,t,n){if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,i,s;r=0,i=new Uint8Array,s=new Uint8Array;const a=new Uint8Array(4);return n&&n.byteLength>0&&new DataView(a.buffer).setUint32(0,n.byteLength,!1),function(e,...t){const n=t.length;let r=8,i=n;for(;i--;)r+=t[i].byteLength;const s=new Uint8Array(r);for(s[0]=r>>24&255,s[1]=r>>16&255,s[2]=r>>8&255,s[3]=255&r,s.set(e,4),i=0,r=8;i<n;i++)s.set(t[i],r),r+=t[i].byteLength;return s}([112,115,115,104],new Uint8Array([0,0,0,0]),e,s,i,a,n||new Uint8Array)}const sv=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),av={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function ov(e,t){const n=av[t];return!!n&&!!n[e.slice(0,4)]}function lv(e,t,n=!0){return!e.split(",").some(e=>!uv(e,t,n))}function uv(e,t,n=!0){var r;const i=hg(n);return null!=(r=null==i?void 0:i.isTypeSupported(cv(e,t)))&&r}function cv(e,t){return`${t}/mp4;codecs=${e}`}function dv(e){if(e){const t=e.substring(0,4);return av.video[t]}return 2}function hv(e){const t=sv();return e.split(",").reduce((e,n)=>{const r=t&&ev(n)?9:av.video[n];return r?(2*r+e)/(e?3:2):(av.audio[n]+e)/(e?2:1)},0)}const fv={};const pv=/flac|opus|mp4a\.40\.34/i;function mv(e,t=!0){return e.replace(pv,e=>function(e,t=!0){if(fv[e])return fv[e];const n={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[e];for(let i=0;i<n.length;i++){var r;if(uv(n[i],"audio",t))return fv[e]=n[i],n[i];if("mp3"===n[i]&&null!=(r=hg(t))&&r.isTypeSupported("audio/mpeg"))return""}return e}(e.toLowerCase(),t))}function gv(e,t){if(e&&(e.length>4||-1!==["ac-3","ec-3","alac","fLaC","Opus"].indexOf(e))&&(vv(e,"audio")||vv(e,"video")))return e;if(t){const n=t.split(",");if(n.length>1){if(e)for(let t=n.length;t--;)if(n[t].substring(0,4)===e.substring(0,4))return n[t];return n[0]}}return t||e}function vv(e,t){return ov(e,t)&&uv(e,t)}function yv(e){if(e.startsWith("av01.")){const t=e.split("."),n=["0","111","01","01","01","0"];for(let e=t.length;e>4&&e<10;e++)t[e]=n[e-4];return t.join(".")}return e}function bv(e){const t=hg(e)||{isTypeSupported:()=>!1};return{mpeg:t.isTypeSupported("audio/mpeg"),mp3:t.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:t.isTypeSupported('audio/mp4; codecs="ac-3"')}}function _v(e){return e.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const xv={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function Sv(e,t){return{supported:!1,configurations:t,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:e}}function Tv(e,t,n,r,i,s){const a=e.videoCodec,o=e.audioCodec?e.audioGroups:null,l=null==s?void 0:s.audioCodec,u=null==s?void 0:s.channels,c=u?parseInt(u):l?1/0:2;let d=null;if(null!=o&&o.length)try{d=1===o.length&&o[0]?t.groups[o[0]].channels:o.reduce((e,n)=>{if(n){const r=t.groups[n];if(!r)throw new Error(`Audio track group ${n} not found`);Object.keys(r.channels).forEach(t=>{e[t]=(e[t]||0)+r.channels[t]})}return e},{2:0})}catch(e){return!0}return void 0!==a&&(a.split(",").some(e=>ev(e))||e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(r,30)||"SDR"!==e.videoRange&&e.videoRange!==n||e.bitrate>Math.max(i,8e6))||!!d&&Gm(c)&&Object.keys(d).some(e=>parseInt(e)>c)}function Ev(e,t,n,r={}){const i=e.videoCodec;if(!i&&!e.audioCodec||!n)return Promise.resolve(xv);const s=[],a=function(e){var t;const n=null==(t=e.videoCodec)?void 0:t.split(","),r=wv(e),i=e.width||640,s=e.height||480,a=e.frameRate||30,o=e.videoRange.toLowerCase();return n?n.map(e=>{const t={contentType:cv(yv(e),"video"),width:i,height:s,bitrate:r,framerate:a};return"sdr"!==o&&(t.transferFunction=o),t}):[]}(e),o=a.length,l=function(e,t,n){var r;const i=null==(r=e.audioCodec)?void 0:r.split(","),s=wv(e);if(i&&e.audioGroups)return e.audioGroups.reduce((e,r)=>{var a;const o=r?null==(a=t.groups[r])?void 0:a.tracks:null;return o?o.reduce((e,t)=>{if(t.groupId===r){const r=parseFloat(t.channels||"");i.forEach(t=>{const i={contentType:cv(t,"audio"),bitrate:n?Av(t,s):s};r&&(i.channels=""+r),e.push(i)})}return e},e):e},[]);return[]}(e,t,o>0),u=l.length;for(let e=o||1*u||1;e--;){const t={type:"media-source"};if(o&&(t.video=a[e%o]),u){t.audio=l[e%u];const n=t.audio.bitrate;t.video&&n&&(t.video.bitrate-=n)}s.push(t)}if(i){const e=navigator.userAgent;if(i.split(",").some(e=>ev(e))&&sv())return Promise.resolve(Sv(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${e})`),s))}return Promise.all(s.map(e=>{const t=function(e){let t="";const{audio:n,video:r}=e;if(r){t+=`${_v(r.contentType)}_r${r.height}x${r.width}f${Math.ceil(r.framerate)}${r.transferFunction||"sd"}_${Math.ceil(r.bitrate/1e5)}`}if(n){t+=`${r?"_":""}${_v(n.contentType)}_c${n.channels}`}return t}(e);return r[t]||(r[t]=n.decodingInfo(e))})).then(e=>({supported:!e.some(e=>!e.supported),configurations:s,decodingInfoResults:e})).catch(e=>({supported:!1,configurations:s,decodingInfoResults:[],error:e}))}function Av(e,t){if(t<=1)return 1;let n=128e3;return"ec-3"===e?n=768e3:"ac-3"===e&&(n=64e4),Math.min(t/2,n)}function wv(e){return 1e3*Math.ceil(Math.max(.9*e.bitrate,e.averageBitrate)/1e3)||1}const Mv=["NONE","TYPE-0","TYPE-1",null];const Rv=["SDR","PQ","HLG"];var Cv={No:"",Yes:"YES",v2:"v2"};function Iv(e){const{canSkipUntil:t,canSkipDateRanges:n,age:r}=e;return t&&r<t/2?n?Cv.v2:Cv.Yes:Cv.No}class Lv{constructor(e,t,n){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=n}addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Pv{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(e=>!!e).map(e=>e.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const n=null==(t=e.supplemental)?void 0:t.videoCodec;n&&n!==e.videoCodec&&(this.codecSet+=`,${n.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Nv(this._audioGroups,e)}hasSubtitleGroup(e){return Nv(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t)if("audio"===e){let e=this._audioGroups;e||(e=this._audioGroups=[]),-1===e.indexOf(t)&&e.push(t)}else if("text"===e){let e=this._subtitleGroups;e||(e=this._subtitleGroups=[]),-1===e.indexOf(t)&&e.push(t)}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return null==(e=this.audioGroups)?void 0:e[0]}get textGroupId(){var e;return null==(e=this.subtitleGroups)?void 0:e[0]}addFallback(){}}function Nv(e,t){return!(!t||!e)&&-1!==e.indexOf(t)}function Dv(e,t){let n=!1,r=[];if(e&&(n="SDR"!==e,r=[e]),t){r=t.allowedVideoRanges||Rv.slice(0);const e="SDR"!==r.join("")&&!t.videoCodec;n=void 0!==t.preferHDR?t.preferHDR:e&&function(){if("function"==typeof matchMedia){const e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return!0===e.matches}return!1}(),n||(r=["SDR"])}return{preferHDR:n,allowedVideoRanges:r}}const kv=(e,t)=>JSON.stringify(e,(e=>{const t=new WeakSet;return(n,r)=>{if(e&&(r=e(n,r)),"object"==typeof r&&null!==r){if(t.has(r))return;t.add(r)}return r}})(t));function Ov(e,t){dg.log(`[abr] start candidates with "${e}" ignored because ${t}`)}function Fv(e){return e.reduce((e,t)=>{let n=e.groups[t.groupId];n||(n=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),n.tracks.push(t);const r=t.channels||"2";return n.channels[r]=(n.channels[r]||0)+1,n.hasDefault=n.hasDefault||t.default,n.hasAutoSelect=n.hasAutoSelect||t.autoselect,n.hasDefault&&(e.hasDefaultAudio=!0),n.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Uv(e){if(!e)return e;const{lang:t,assocLang:n,characteristics:r,channels:i,audioCodec:s}=e;return{lang:t,assocLang:n,characteristics:r,channels:i,audioCodec:s}}function Bv(e,t,n){if("attrs"in e){const n=t.indexOf(e);if(-1!==n)return n}for(let r=0;r<t.length;r++){if(Vv(e,t[r],n))return r}return-1}function Vv(e,t,n){const{groupId:r,name:i,lang:s,assocLang:a,default:o}=e,l=e.forced;return(void 0===r||t.groupId===r)&&(void 0===i||t.name===i)&&(void 0===s||function(e,t="--"){if(e.length===t.length)return e===t;return e.startsWith(t)||t.startsWith(e)}(s,t.lang))&&(void 0===s||t.assocLang===a)&&(void 0===o||t.default===o)&&(void 0===l||t.forced===l)&&(!("characteristics"in e)||function(e,t=""){const n=e.split(","),r=t.split(",");return n.length===r.length&&!n.some(e=>-1===r.indexOf(e))}(e.characteristics||"",t.characteristics))&&(void 0===n||n(e,t))}function zv(e,t){const{audioCodec:n,channels:r}=e;return!(void 0!==n&&(t.audioCodec||"").substring(0,4)!==n.substring(0,4)||void 0!==r&&r!==(t.channels||"2"))}function Gv(e,t,n){for(let r=t;r>-1;r--)if(n(e[r]))return r;for(let r=t+1;r<e.length;r++)if(n(e[r]))return r;return-1}function Hv(e,t){var n;return!!e&&e!==(null==(n=t.loadLevelObj)?void 0:n.uri)}class $v extends sg{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=e=>{var t;const{fragCurrent:n,partCurrent:r,hls:i}=this,{autoLevelEnabled:s,media:a}=i;if(!n||!a)return;const o=performance.now(),l=r?r.stats:n.stats,u=r?r.duration:n.duration,c=o-l.loading.start,d=i.minAutoLevel,h=n.level,f=this._nextAutoLevel;if(l.aborted||l.loaded&&l.loaded===l.total||h<=d)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!s)return;const p=f>-1&&f!==h,m=!!e||p;if(!m&&(a.paused||!a.playbackRate||!a.readyState))return;const g=i.mainForwardBufferInfo;if(!m&&null===g)return;const v=this.bwEstimator.getEstimateTTFB(),y=Math.abs(a.playbackRate);if(c<=Math.max(v,u/(2*y)*1e3))return;const b=g?g.len/y:0,_=l.loading.first?l.loading.first-l.loading.start:-1,x=l.loaded&&_>-1,S=this.getBwEstimate(),T=i.levels,E=T[h],A=Math.max(l.loaded,Math.round(u*(n.bitrate||E.averageBitrate)/8));let w=x?c-_:c;w<1&&x&&(w=Math.min(c,8*l.loaded/S));const M=x?1e3*l.loaded/w:0,R=v/1e3,C=M?(A-l.loaded)/M:8*A/S+R;if(C<=b)return;const I=M?8*M:S,L=!0===(null==(t=(null==e?void 0:e.details)||this.hls.latestLevelDetails)?void 0:t.live),P=this.hls.config.abrBandWidthUpFactor;let N,D=Number.POSITIVE_INFINITY;for(N=h-1;N>d;N--){const e=T[N].maxBitrate,t=!T[N].details||L;if(D=this.getTimeToLoadFrag(R,I,u*e,t),D<Math.min(b,u+R))break}if(D>=C)return;if(D>10*u)return;x?this.bwEstimator.sample(c-Math.min(v,_),l.loaded):this.bwEstimator.sampleTTFB(c);const k=T[N].maxBitrate;this.getBwEstimate()*P>k&&this.resetEstimator(k);const O=this.findBestLevel(k,d,N,0,b,1,1);O>-1&&(N=O),this.warn(`Fragment ${n.sn}${r?" part "+r.index:""} of level ${h} is loading too slowly;\n      Fragment duration: ${n.duration.toFixed(3)}\n      Time to underbuffer: ${b.toFixed(3)} s\n      Estimated load time for current fragment: ${C.toFixed(3)} s\n      Estimated load time for down switch fragment: ${D.toFixed(3)} s\n      TTFB estimate: ${0|_} ms\n      Current BW estimate: ${Gm(S)?0|S:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${N} @ ${0|k} bps`),i.nextLoadLevel=i.nextAutoLevel=N,this.clearTimer();const F=()=>{if(this.clearTimer(),this.fragCurrent===n&&this.hls.loadLevel===N&&N>0){const e=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${N>0?"and switching down":""}\n      Fragment duration: ${n.duration.toFixed(3)} s\n      Time to underbuffer: ${e.toFixed(3)} s`),n.abortRequests(),this.fragCurrent=this.partCurrent=null,N>d){let t=this.findBestLevel(this.hls.levels[d].bitrate,d,N,0,e,1,1);-1===t&&(t=d),this.hls.nextLoadLevel=this.hls.nextAutoLevel=t,this.resetEstimator(this.hls.levels[t].bitrate)}}};p||C>2*D?F():this.timer=self.setInterval(F,1e3*D),i.trigger(qm.FRAG_LOAD_EMERGENCY_ABORTED,{frag:n,part:r,stats:l})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new eg(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.FRAG_LOADING,this.onFragLoading,this),e.on(qm.FRAG_LOADED,this.onFragLoaded,this),e.on(qm.FRAG_BUFFERED,this.onFragBuffered,this),e.on(qm.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.on(qm.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(qm.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(qm.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.FRAG_LOADING,this.onFragLoading,this),e.off(qm.FRAG_LOADED,this.onFragLoaded,this),e.off(qm.FRAG_BUFFERED,this.onFragBuffered,this),e.off(qm.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.off(qm.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(qm.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(qm.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const n=t.frag;if(!this.ignoreFragment(n)){var r;if(!n.bitrateTest)this.fragCurrent=n,this.partCurrent=null!=(r=t.part)?r:null;this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case jm.BUFFER_ADD_CODEC_ERROR:case jm.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case jm.FRAG_LOAD_TIMEOUT:{const e=t.frag,{fragCurrent:n,partCurrent:r}=this;if(e&&n&&e.sn===n.sn&&e.level===n.level){const t=performance.now(),n=r?r.stats:e.stats,i=t-n.loading.start,s=n.loading.first?n.loading.first-n.loading.start:-1;if(n.loaded&&s>-1){const e=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(i-Math.min(e,s),n.loaded)}else this.bwEstimator.sampleTTFB(i)}break}}}getTimeToLoadFrag(e,t,n,r){return e+n/t+(r?e+this.lastLevelLoadSec:0)}onLevelLoaded(e,t){const n=this.hls.config,{loading:r}=t.stats,i=r.end-r.first;Gm(i)&&(this.lastLevelLoadSec=i/1e3),t.details.live?this.bwEstimator.update(n.abrEwmaSlowLive,n.abrEwmaFastLive):this.bwEstimator.update(n.abrEwmaSlowVoD,n.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:n}){const r=n?n.stats:t.stats;if(t.type===Zm.MAIN&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const e=n?n.duration:t.duration,i=this.hls.levels[t.level],s=(i.loaded?i.loaded.bytes:0)+r.loaded,a=(i.loaded?i.loaded.duration:0)+e;i.loaded={bytes:s,duration:a},i.realBitrate=Math.round(8*s/a)}if(t.bitrateTest){const e={stats:r,frag:t,part:n,id:t.type};this.onFragBuffered(qm.FRAG_BUFFERED,e),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:n,part:r}=t,i=null!=r&&r.stats.loaded?r.stats:n.stats;if(i.aborted)return;if(this.ignoreFragment(n))return;const s=i.parsing.end-i.loading.start-Math.min(i.loading.first-i.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(s,i.loaded),i.bwEstimate=this.getBwEstimate(),n.bitrateTest?this.bitrateTestDelay=s/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==Zm.MAIN||"initSegment"===e.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,n=this.getBwEstimate(),r=this.hls.config.maxStarvationDelay,i=this.findBestLevel(n,t,e,0,r,1,1);if(i>-1)return i;const s=this.hls.firstLevel,a=Math.min(Math.max(s,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${s} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(!(-1===e||t&&n&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return e;const r=t&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==e){const t=this.hls.levels;if(t.length>Math.max(e,r)&&t[e].loadError<=t[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:n}=this;if(n.levels.length<=1)return n.loadLevel;const{maxAutoLevel:r,config:i,minAutoLevel:s}=n,a=t?t.duration:e?e.duration:0,o=this.getBwEstimate(),l=this.getStarvationDelay();let u=i.abrBandWidthFactor,c=i.abrBandWidthUpFactor;if(l){const e=this.findBestLevel(o,s,r,l,0,u,c);if(e>=0)return this.rebufferNotice=-1,e}let d=a?Math.min(a,i.maxStarvationDelay):i.maxStarvationDelay;if(!l){const e=this.bitrateTestDelay;if(e){d=(a?Math.min(a,i.maxLoadingDelay):i.maxLoadingDelay)-e,this.info(`bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*d)} ms`),u=c=1}}const h=this.findBestLevel(o,s,r,l,d,u,c);if(this.rebufferNotice!==h&&(this.rebufferNotice=h,this.info(`${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${h}`)),h>-1)return h;const f=n.levels[s],p=n.loadLevelObj;return p&&(null==f?void 0:f.bitrate)<p.bitrate?s:n.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const n=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1,r=e.mainForwardBufferInfo;return(r?r.len:0)/n}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,n,r,i,s,a){var o;const l=r+i,u=this.lastLoadedFragLevel,c=-1===u?this.hls.firstLevel:u,{fragCurrent:d,partCurrent:h}=this,{levels:f,allAudioTracks:p,loadLevel:m,config:g}=this.hls;if(1===f.length)return 0;const v=f[c],y=!(null==(o=this.hls.latestLevelDetails)||!o.live),b=-1===m||-1===u;let _,x="SDR",S=(null==v?void 0:v.frameRate)||0;const{audioPreference:T,videoPreference:E}=g,A=this.audioTracksByGroup||(this.audioTracksByGroup=Fv(p));let w=-1;if(b){if(-1!==this.firstSelection)return this.firstSelection;const r=this.codecTiers||(this.codecTiers=function(e,t,n,r){return e.slice(n,r+1).reduce((e,n,r)=>{if(!n.codecSet)return e;const i=n.audioGroups;let s=e[n.codecSet];s||(e[n.codecSet]=s={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:r,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!i,fragmentError:0}),s.minBitrate=Math.min(s.minBitrate,n.bitrate);const a=Math.min(n.height,n.width);return s.minHeight=Math.min(s.minHeight,a),s.minFramerate=Math.min(s.minFramerate,n.frameRate),s.minIndex=Math.min(s.minIndex,r),s.maxScore=Math.max(s.maxScore,n.score),s.fragmentError+=n.fragmentError,s.videoRanges[n.videoRange]=(s.videoRanges[n.videoRange]||0)+1,i&&i.forEach(e=>{if(!e)return;const n=t.groups[e];n&&(s.hasDefaultAudio=s.hasDefaultAudio||t.hasDefaultAudio?n.hasDefault:n.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(n.channels).forEach(e=>{s.channels[e]=(s.channels[e]||0)+n.channels[e]}))}),e},{})}(f,A,t,n)),i=function(e,t,n,r,i){const s=Object.keys(e),a=null==r?void 0:r.channels,o=null==r?void 0:r.audioCodec,l=null==i?void 0:i.videoCodec,u=a&&2===parseInt(a);let c=!1,d=!1,h=1/0,f=1/0,p=1/0,m=1/0,g=0,v=[];const{preferHDR:y,allowedVideoRanges:b}=Dv(t,i);for(let t=s.length;t--;){const n=e[s[t]];c||(c=n.channels[2]>0),h=Math.min(h,n.minHeight),f=Math.min(f,n.minFramerate),p=Math.min(p,n.minBitrate);const r=b.filter(e=>n.videoRanges[e]>0);r.length>0&&(d=!0)}h=Gm(h)?h:0,f=Gm(f)?f:0;const _=Math.max(1080,h),x=Math.max(30,f);p=Gm(p)?p:n,n=Math.max(p,n),d||(t=void 0);const S=s.length>1,T=s.reduce((t,r)=>{const i=e[r];if(r===t)return t;if(v=d?b.filter(e=>i.videoRanges[e]>0):[],S){if(i.minBitrate>n)return Ov(r,`min bitrate of ${i.minBitrate} > current estimate of ${n}`),t;if(!i.hasDefaultAudio)return Ov(r,"no renditions with default or auto-select sound found"),t;if(o&&r.indexOf(o.substring(0,4))%5!=0)return Ov(r,`audio codec preference "${o}" not found`),t;if(a&&!u){if(!i.channels[a])return Ov(r,`no renditions with ${a} channel sound found (channels options: ${Object.keys(i.channels)})`),t}else if((!o||u)&&c&&0===i.channels[2])return Ov(r,"no renditions with stereo sound found"),t;if(i.minHeight>_)return Ov(r,`min resolution of ${i.minHeight} > maximum of ${_}`),t;if(i.minFramerate>x)return Ov(r,`min framerate of ${i.minFramerate} > maximum of ${x}`),t;if(!v.some(e=>i.videoRanges[e]>0))return Ov(r,`no variants with VIDEO-RANGE of ${kv(v)} found`),t;if(l&&r.indexOf(l.substring(0,4))%5!=0)return Ov(r,`video codec preference "${l}" not found`),t;if(i.maxScore<g)return Ov(r,`max score of ${i.maxScore} < selected max of ${g}`),t}return t&&(hv(r)>=hv(t)||i.fragmentError>e[t].fragmentError)?t:(m=i.minIndex,g=i.maxScore,r)},void 0);return{codecSet:T,videoRanges:v,preferHDR:y,minFramerate:f,minBitrate:p,minIndex:m}}(r,x,e,T,E),{codecSet:s,videoRanges:a,minFramerate:o,minBitrate:l,minIndex:u,preferHDR:c}=i;w=u,_=s,x=c?a[a.length-1]:a[0],S=o,e=Math.max(e,l),this.log(`picked start tier ${kv(i)}`)}else _=null==v?void 0:v.codecSet,x=null==v?void 0:v.videoRange;const M=h?h.duration:d?d.duration:0,R=this.bwEstimator.getEstimateTTFB()/1e3,C=[];for(let o=n;o>=t;o--){var I,L;const t=f[o],d=o>c;if(!t)continue;if(g.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){const n=navigator.mediaCapabilities;"function"==typeof(null==n?void 0:n.decodingInfo)&&Tv(t,A,x,S,e,T)?(t.supportedPromise=Ev(t,A,n,this.supportedCache),t.supportedPromise.then(e=>{if(!this.hls)return;t.supportedResult=e;const n=this.hls.levels,r=n.indexOf(t);e.error?this.warn(`MediaCapabilities decodingInfo error: "${e.error}" for level ${r} ${kv(e)}`):e.supported?e.decodingInfoResults.some(e=>!1===e.smooth||!1===e.powerEfficient)&&this.log(`MediaCapabilities decodingInfo for level ${r} not smooth or powerEfficient: ${kv(e)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${r} ${kv(e)}`),r>-1&&n.length>1&&(this.log(`Removing unsupported level ${r}`),this.hls.removeLevel(r),-1===this.hls.loadLevel&&(this.hls.nextLoadLevel=0)))})):t.supportedResult=xv}if((_&&t.codecSet!==_||x&&t.videoRange!==x||d&&S>t.frameRate||!d&&S>0&&S<t.frameRate||null!=(I=t.supportedResult)&&null!=(L=I.decodingInfoResults)&&L.some(e=>!1===e.smooth))&&(!b||o!==w)){C.push(o);continue}const p=t.details,v=(h?null==p?void 0:p.partTarget:null==p?void 0:p.averagetargetduration)||M;let E;E=d?a*e:s*e;const P=M&&r>=2*M&&0===i?t.averageBitrate:t.maxBitrate,N=this.getTimeToLoadFrag(R,E,P*v,void 0===p);if(E>=P&&(o===u||0===t.loadError&&0===t.fragmentError)&&(N<=R||!Gm(N)||y&&!this.bitrateTestDelay||N<l)){const e=this.forcedAutoLevel;return o===m||-1!==e&&e===m||(C.length&&this.trace(`Skipped level(s) ${C.join(",")} of ${n} max with CODECS and VIDEO-RANGE:"${f[C[0]].codecs}" ${f[C[0]].videoRange}; not compatible with "${_}" ${x}`),this.info(`switch candidate:${c}->${o} adjustedbw(${Math.round(E)})-bitrate=${Math.round(E-P)} ttfb:${R.toFixed(1)} avgDuration:${v.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${N.toFixed(1)} firstSelection:${b} codecSet:${t.codecSet} videoRange:${t.videoRange} hls.loadLevel:${m}`)),b&&(this.firstSelection=o),o}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:n}=this.hls;return Math.min(Math.max(e,n),t)}}const Wv=function(e,t){let n=0,r=e.length-1,i=null,s=null;for(;n<=r;){i=(n+r)/2|0,s=e[i];const a=t(s);if(a>0)n=i+1;else{if(!(a<0))return s;r=i-1}}return null};function jv(e,t,n=0,r=0,i=.005){let s=null;if(e){s=t[1+e.sn-t[0].sn]||null;const r=e.endDTS-n;r>0&&r<15e-7&&(n+=15e-7),s&&e.level!==s.level&&s.end<=e.end&&(s=t[2+e.sn-t[0].sn]||null)}else 0===n&&0===t[0].start&&(s=t[0]);if(s&&((!e||e.level===s.level)&&0===qv(n,r,s)||function(e,t,n){if(t&&0===t.start&&t.level<e.level&&(t.endPTS||0)>0){const r=t.tagList.reduce((e,t)=>("INF"===t[0]&&(e+=parseFloat(t[1])),e),n);return e.start<=r}return!1}(s,e,Math.min(i,r))))return s;const a=Wv(t,qv.bind(null,n,r));return!a||a===e&&s?s:a}function qv(e=0,t=0,n){if(n.start<=e&&n.start+n.duration>e)return 0;const r=Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return n.start+n.duration-r<=e?1:n.start-r>e&&n.start?-1:0}function Xv(e,t,n){const r=1e3*Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return(n.endProgramDateTime||0)-r>e}function Yv(e,t,n){if(e&&e.startCC<=t&&e.endCC>=t){let r=e.fragments;const{fragmentHint:i}=e;let s;return i&&(r=r.concat(i)),Wv(r,e=>e.cc<t?1:e.cc>t?-1:(s=e,e.end<=n?1:e.start>n?-1:0)),s||null}return null}function Kv(e){switch(e.details){case jm.FRAG_LOAD_TIMEOUT:case jm.KEY_LOAD_TIMEOUT:case jm.LEVEL_LOAD_TIMEOUT:case jm.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Qv(e,t){const n=Kv(t);return e.default[(n?"timeout":"error")+"Retry"]}function Zv(e,t){const n="linear"===e.backoff?1:Math.pow(2,t);return Math.min(n*e.retryDelayMs,e.maxRetryDelayMs)}function Jv(e){return ig(ig({},e),{errorRetry:null,timeoutRetry:null})}function ey(e,t,n,r){if(!e)return!1;const i=null==r?void 0:r.code,s=t<e.maxNumRetry&&(function(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}(i)||!!n);return e.shouldRetry?e.shouldRetry(e,t,n,r,s):s}var ty={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},ny={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class ry extends sg{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(qm.ERROR,this.onError,this),e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(qm.ERROR,this.onError,this),e.off(qm.ERROR,this.onErrorOut,this),e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(null==e?void 0:e.type)===Zm.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var n;if(t.fatal)return;const r=this.hls,i=t.context;switch(t.details){case jm.FRAG_LOAD_ERROR:case jm.FRAG_LOAD_TIMEOUT:case jm.KEY_LOAD_ERROR:case jm.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case jm.FRAG_PARSING_ERROR:if(null!=(n=t.frag)&&n.gap)return void(t.errorAction=iy());case jm.FRAG_GAP:case jm.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=ty.SendAlternateToPenaltyBox);case jm.LEVEL_EMPTY_ERROR:case jm.LEVEL_PARSING_ERROR:{var s,a;const e=t.parent===Zm.MAIN?t.level:r.loadLevel;t.details===jm.LEVEL_EMPTY_ERROR&&null!=(s=t.context)&&null!=(a=s.levelDetails)&&a.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case jm.LEVEL_LOAD_ERROR:case jm.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==i?void 0:i.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,i.level)));case jm.AUDIO_TRACK_LOAD_ERROR:case jm.AUDIO_TRACK_LOAD_TIMEOUT:case jm.SUBTITLE_LOAD_ERROR:case jm.SUBTITLE_TRACK_LOAD_TIMEOUT:if(i){const e=r.loadLevelObj;if(e&&(i.type===Km&&e.hasAudioGroup(i.groupId)||i.type===Qm&&e.hasSubtitleGroup(i.groupId)))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.loadLevel),t.errorAction.action=ty.SendAlternateToPenaltyBox,void(t.errorAction.flags=ny.MoveAllAlternatesMatchingHost)}return;case jm.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const e=r.loadLevelObj,n=null==e?void 0:e.attrs["HDCP-LEVEL"];n?t.errorAction={action:ty.SendAlternateToPenaltyBox,flags:ny.MoveAllAlternatesMatchingHDCP,hdcpLevel:n}:this.keySystemError(t)}return;case jm.BUFFER_ADD_CODEC_ERROR:case jm.REMUX_ALLOC_ERROR:case jm.BUFFER_APPEND_ERROR:var o;if(!t.errorAction)t.errorAction=this.getLevelSwitchAction(t,null!=(o=t.level)?o:r.loadLevel);return;case jm.INTERNAL_EXCEPTION:case jm.BUFFER_APPENDING_ERROR:case jm.BUFFER_FULL_ERROR:case jm.LEVEL_SWITCH_ERROR:case jm.BUFFER_STALLED_ERROR:case jm.BUFFER_SEEK_OVER_HOLE:case jm.BUFFER_NUDGE_ON_STALL:return void(t.errorAction=iy())}t.type===Wm.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const n=Qv(this.hls.config.playlistLoadPolicy,e),r=this.playlistError++;if(ey(n,r,Kv(e),e.response))return{action:ty.RetryRequest,flags:ny.None,retryConfig:n,retryCount:r};const i=this.getLevelSwitchAction(e,t);return n&&(i.retryConfig=n,i.retryCount=r),i}getFragRetryOrSwitchAction(e){const t=this.hls,n=this.getVariantLevelIndex(e.frag),r=t.levels[n],{fragLoadPolicy:i,keyLoadPolicy:s}=t.config,a=Qv(e.details.startsWith("key")?s:i,e),o=t.levels.reduce((e,t)=>e+t.fragmentError,0);if(r){e.details!==jm.FRAG_GAP&&r.fragmentError++;if(ey(a,o,Kv(e),e.response))return{action:ty.RetryRequest,flags:ny.None,retryConfig:a,retryCount:o}}const l=this.getLevelSwitchAction(e,n);return a&&(l.retryConfig=a,l.retryCount=o),l}getLevelSwitchAction(e,t){const n=this.hls;null==t&&(t=n.loadLevel);const r=this.hls.levels[t];if(r){var i,s;const t=e.details;r.loadError++,t===jm.BUFFER_APPEND_ERROR&&r.fragmentError++;let l=-1;const{levels:u,loadLevel:c,minAutoLevel:d,maxAutoLevel:h}=n;n.autoLevelEnabled||n.config.preserveManualLevelOnError||(n.loadLevel=-1);const f=null==(i=e.frag)?void 0:i.type,p=(f===Zm.AUDIO&&t===jm.FRAG_PARSING_ERROR||"audio"===e.sourceBufferName&&(t===jm.BUFFER_ADD_CODEC_ERROR||t===jm.BUFFER_APPEND_ERROR))&&u.some(({audioCodec:e})=>r.audioCodec!==e),m="video"===e.sourceBufferName&&(t===jm.BUFFER_ADD_CODEC_ERROR||t===jm.BUFFER_APPEND_ERROR)&&u.some(({codecSet:e,audioCodec:t})=>r.codecSet!==e&&r.audioCodec===t),{type:g,groupId:v}=null!=(s=e.context)?s:{};for(let n=u.length;n--;){const i=(n+c)%u.length;if(i!==c&&i>=d&&i<=h&&0===u[i].loadError){var a,o;const n=u[i];if(t===jm.FRAG_GAP&&f===Zm.MAIN&&e.frag){const t=u[i].details;if(t){const n=jv(e.frag,t.fragments,e.frag.start);if(null!=n&&n.gap)continue}}else{if(g===Km&&n.hasAudioGroup(v)||g===Qm&&n.hasSubtitleGroup(v))continue;if(f===Zm.AUDIO&&null!=(a=r.audioGroups)&&a.some(e=>n.hasAudioGroup(e))||f===Zm.SUBTITLE&&null!=(o=r.subtitleGroups)&&o.some(e=>n.hasSubtitleGroup(e))||p&&r.audioCodec===n.audioCodec||!p&&r.audioCodec!==n.audioCodec||m&&r.codecSet===n.codecSet)continue}l=i;break}}if(l>-1&&n.loadLevel!==l)return e.levelRetry=!0,this.playlistError=0,{action:ty.SendAlternateToPenaltyBox,flags:ny.None,nextAutoLevel:l}}return{action:ty.SendAlternateToPenaltyBox,flags:ny.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var n;switch(null==(n=t.errorAction)?void 0:n.action){case ty.DoNothing:break;case ty.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===jm.FRAG_GAP?/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):t.fatal=!0}t.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(e){const t=this.hls,n=e.errorAction;if(!n)return;const{flags:r,hdcpLevel:i,nextAutoLevel:s}=n;switch(r){case ny.None:this.switchLevel(e,s);break;case ny.MoveAllAlternatesMatchingHDCP:i&&(t.maxHdcpLevel=Mv[Mv.indexOf(i)-1],n.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`)}n.resolved||this.switchLevel(e,s)}switchLevel(e,t){if(void 0!==t&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===jm.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&"audiovideo"!==e.sourceBufferName)){const t=_v(e.mimeType),n=this.hls.levels;for(let r=n.length;r--;)n[r][`${e.sourceBufferName}Codec`]===t&&this.hls.removeLevel(r)}}}function iy(e){const t={action:ty.DoNothing,flags:ny.None};return e&&(t.resolved=!0),t}var sy="NOT_LOADED",ay="APPENDING",oy="PARTIAL",ly="OK";class uy{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.BUFFER_APPENDED,this.onBufferAppended,this),e.on(qm.FRAG_BUFFERED,this.onFragBuffered,this),e.on(qm.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.BUFFER_APPENDED,this.onBufferAppended,this),e.off(qm.FRAG_BUFFERED,this.onFragBuffered,this),e.off(qm.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const n=this.activePartLists[t];if(n)for(let t=n.length;t--;){const r=n[t];if(!r)break;const i=r.end;if(r.start<=e&&null!==i&&e<=i)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,n){const{fragments:r}=this,i=Object.keys(r);for(let s=i.length;s--;){const a=r[i[s]];if((null==a?void 0:a.body.type)===t&&(!n||a.buffered)){const t=a.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,n,r,i){this.timeRanges&&(this.timeRanges[e]=t);const s=(null==r?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach(r=>{const a=this.fragments[r];if(!a)return;if(s>=a.body.sn)return;if(!a.buffered&&(!a.loaded||i))return void(a.body.type===n&&this.removeFragment(a.body));const o=a.range[e];o&&(0!==o.time.length?o.time.some(e=>{const n=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return n&&this.removeFragment(a.body),n}):this.removeFragment(a.body))})}detectPartialFragments(e){const t=this.timeRanges;if(!t||"initSegment"===e.frag.sn)return;const n=e.frag,r=dy(n),i=this.fragments[r];if(!i||i.buffered&&n.gap)return;const s=!n.relurl;if(Object.keys(t).forEach(r=>{const a=n.elementaryStreams[r];if(!a)return;const o=t[r],l=s||!0===a.partial;i.range[r]=this.getBufferedTimes(n,e.part,l,o)}),i.loaded=null,Object.keys(i.range).length){i.buffered=!0;(i.body.endList=n.endList||i.body.endList)&&(this.endListFragments[i.body.type]=i),cy(i)||this.removeParts(n.sn-1,n.type)}else this.removeFragment(i.body)}removeParts(e,t){const n=this.activePartLists[t];n&&(this.activePartLists[t]=hy(n,t=>t.fragment.sn>=e))}fragBuffered(e,t){const n=dy(e);let r=this.fragments[n];!r&&t&&(r=this.fragments[n]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(e,t,n,r){const i={time:[],partial:n},s=e.start,a=e.end,o=e.minEndPTS||a,l=e.maxStartPTS||s;for(let e=0;e<r.length;e++){const t=r.start(e)-this.bufferPadding,n=r.end(e)+this.bufferPadding;if(l>=t&&o<=n){i.time.push({startPTS:Math.max(s,r.start(e)),endPTS:Math.min(a,r.end(e))});break}if(s<n&&a>t){const t=Math.max(s,r.start(e)),n=Math.min(a,r.end(e));n>t&&(i.partial=!0,i.time.push({startPTS:t,endPTS:n}))}else if(a<=t)break}return i}getPartialFragment(e){let t,n,r,i=null,s=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach(l=>{const u=o[l];u&&cy(u)&&(n=u.body.start-a,r=u.body.end+a,e>=n&&e<=r&&(t=Math.min(e-n,r-e),s<=t&&(i=u.body,s=t)))}),i}isEndListAppended(e){const t=this.endListFragments[e];return void 0!==t&&(t.buffered||cy(t))}getState(e){const t=dy(e),n=this.fragments[t];return n?n.buffered?cy(n)?oy:ly:ay:sy}isTimeBuffered(e,t,n){let r,i;for(let s=0;s<n.length;s++){if(r=n.start(s)-this.bufferPadding,i=n.end(s)+this.bufferPadding,e>=r&&t<=i)return!0;if(t<=r)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if("initSegment"===t.frag.sn||t.frag.bitrateTest)return;const n=t.frag,r=t.part?null:t,i=dy(n);this.fragments[i]={body:n,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:n,part:r,timeRanges:i,type:s}=t;if("initSegment"===n.sn)return;const a=n.type;if(r){let e=this.activePartLists[a];e||(this.activePartLists[a]=e=[]),e.push(r)}this.timeRanges=i;const o=i[s];this.detectEvictedFragments(s,o,a,r)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=dy(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,n=Object.keys(t);if(!e)return n.length>0;for(let r=n.length;r--;){const i=t[n[r]];if((null==i?void 0:i.body.type)===e)return!0}return!1}hasParts(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}removeFragmentsInRange(e,t,n,r,i){r&&!this.hasGaps||Object.keys(this.fragments).forEach(s=>{const a=this.fragments[s];if(!a)return;const o=a.body;o.type!==n||r&&!o.gap||o.start<t&&o.end>e&&(a.buffered||i)&&this.removeFragment(o)})}removeFragment(e){const t=dy(e);e.clearElementaryStreamInfo();const n=this.activePartLists[e.type];if(n){const t=e.sn;this.activePartLists[e.type]=hy(n,e=>e.fragment.sn!==t)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e,t;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const n=null==(e=this.hls)||null==(t=e.latestLevelDetails)?void 0:t.partList;n&&n.forEach(e=>e.clearElementaryStreamInfo())}}function cy(e){var t,n,r;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(n=e.range.audio)?void 0:n.partial)||(null==(r=e.range.audiovideo)?void 0:r.partial))}function dy(e){return`${e.type}_${e.level}_${e.sn}`}function hy(e,t){return e.filter(e=>{const n=t(e);return n||e.clearElementaryStreamInfo(),n})}var fy=0,py=1;class my{constructor(e,t,n){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=n}decrypt(e,t){switch(this.aesMode){case fy:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case py:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}class gy{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),n=new Uint32Array(4);for(let e=0;e<4;e++)n[e]=t.getUint32(4*e);return n}initTable(){const e=this.sBox,t=this.invSBox,n=this.subMix,r=n[0],i=n[1],s=n[2],a=n[3],o=this.invSubMix,l=o[0],u=o[1],c=o[2],d=o[3],h=new Uint32Array(256);let f=0,p=0,m=0;for(m=0;m<256;m++)h[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){let n=p^p<<1^p<<2^p<<3^p<<4;n=n>>>8^255&n^99,e[f]=n,t[n]=f;const o=h[f],m=h[o],g=h[m];let v=257*h[n]^16843008*n;r[f]=v<<24|v>>>8,i[f]=v<<16|v>>>16,s[f]=v<<8|v>>>24,a[f]=v,v=16843009*g^65537*m^257*o^16843008*f,l[n]=v<<24|v>>>8,u[n]=v<<16|v>>>16,c[n]=v<<8|v>>>24,d[n]=v,f?(f=o^h[h[h[g^o]]],p^=h[h[p]]):f=p=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let n=!0,r=0;for(;r<t.length&&n;)n=t[r]===this.key[r],r++;if(n)return;this.key=t;const i=this.keySize=t.length;if(4!==i&&6!==i&&8!==i)throw new Error("Invalid aes key size="+i);const s=this.ksRows=4*(i+6+1);let a,o;const l=this.keySchedule=new Uint32Array(s),u=this.invKeySchedule=new Uint32Array(s),c=this.sBox,d=this.rcon,h=this.invSubMix,f=h[0],p=h[1],m=h[2],g=h[3];let v,y;for(a=0;a<s;a++)a<i?v=l[a]=t[a]:(y=v,a%i===0?(y=y<<8|y>>>24,y=c[y>>>24]<<24|c[y>>>16&255]<<16|c[y>>>8&255]<<8|c[255&y],y^=d[a/i|0]<<24):i>6&&a%i===4&&(y=c[y>>>24]<<24|c[y>>>16&255]<<16|c[y>>>8&255]<<8|c[255&y]),l[a]=v=(l[a-i]^y)>>>0);for(o=0;o<s;o++)a=s-o,y=3&o?l[a]:l[a-4],u[o]=o<4||a<=4?y:f[c[y>>>24]]^p[c[y>>>16&255]]^m[c[y>>>8&255]]^g[c[255&y]],u[o]=u[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,n){const r=this.keySize+6,i=this.invKeySchedule,s=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],u=a[2],c=a[3],d=this.uint8ArrayToUint32Array_(n);let h=d[0],f=d[1],p=d[2],m=d[3];const g=new Int32Array(e),v=new Int32Array(g.length);let y,b,_,x,S,T,E,A,w,M,R,C,I,L;const P=this.networkToHostOrderSwap;for(;t<g.length;){for(w=P(g[t]),M=P(g[t+1]),R=P(g[t+2]),C=P(g[t+3]),S=w^i[0],T=C^i[1],E=R^i[2],A=M^i[3],I=4,L=1;L<r;L++)y=o[S>>>24]^l[T>>16&255]^u[E>>8&255]^c[255&A]^i[I],b=o[T>>>24]^l[E>>16&255]^u[A>>8&255]^c[255&S]^i[I+1],_=o[E>>>24]^l[A>>16&255]^u[S>>8&255]^c[255&T]^i[I+2],x=o[A>>>24]^l[S>>16&255]^u[T>>8&255]^c[255&E]^i[I+3],S=y,T=b,E=_,A=x,I+=4;y=s[S>>>24]<<24^s[T>>16&255]<<16^s[E>>8&255]<<8^s[255&A]^i[I],b=s[T>>>24]<<24^s[E>>16&255]<<16^s[A>>8&255]<<8^s[255&S]^i[I+1],_=s[E>>>24]<<24^s[A>>16&255]<<16^s[S>>8&255]<<8^s[255&T]^i[I+2],x=s[A>>>24]<<24^s[S>>16&255]<<16^s[T>>8&255]<<8^s[255&E]^i[I+3],v[t]=P(y^h),v[t+1]=P(x^f),v[t+2]=P(_^p),v[t+3]=P(b^m),h=w,f=M,p=R,m=C,t+=4}return v.buffer}}class vy{constructor(e,t,n){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=n}expandKey(){const e=function(e){switch(e){case fy:return"AES-CBC";case py:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${e}`)}}(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}class yy{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const n=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?function(e){const t=e.byteLength,n=t&&new DataView(e.buffer).getUint8(t-1);return n?e.slice(0,t-n):e}(n):n}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,n,r){return this.useSoftware?new Promise((i,s)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,n,r);const o=this.flush();o?i(o.buffer):s(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,n,r)}softwareDecrypt(e,t,n,r){const{currentIV:i,currentResult:s,remainderData:a}=this;if(r!==fy||16!==t.byteLength)return dg.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=Zg(a,e),this.remainderData=null);const o=this.getValidChunk(e);if(!o.length)return null;i&&(n=i);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new gy),l.expandKey(t);const u=s;return this.currentResult=l.decrypt(o.buffer,0,n),this.currentIV=o.slice(-16).buffer,u||null}webCryptoDecrypt(e,t,n,r){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,n,r));this.key=t,this.fastAesKey=new vy(this.subtle,t,r)}return this.fastAesKey.expandKey().then(t=>{if(!this.subtle)return Promise.reject(new Error("web crypto not initialized"));this.logOnce("WebCrypto AES decrypt");return new my(this.subtle,new Uint8Array(n),r).decrypt(e.buffer,t)}).catch(i=>(dg.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${i.name}: ${i.message}`),this.onWebCryptoError(e,t,n,r)))}onWebCryptoError(e,t,n,r){const i=this.enableSoftwareAES;if(i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,n,r);const i=this.flush();if(i)return i.buffer}throw new Error("WebCrypto"+(i?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const n=e.length-e.length%16;return n!==e.length&&(t=e.slice(0,n),this.remainderData=e.slice(n)),t}logOnce(e){this.logEnabled&&(dg.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const by=Math.pow(2,17);class _y{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const n=e.url;if(!n)return Promise.reject(new Ty({type:Wm.NETWORK_ERROR,details:jm.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(n?"part list":"url")),networkDetails:null}));this.abort();const r=this.config,i=r.fLoader,s=r.loader;return new Promise((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap){if(e.tagList.some(e=>"GAP"===e[0]))return void o(Sy(e));e.gap=!1}const l=this.loader=i?new i(r):new s(r),u=xy(e);e.loader=l;const c=Jv(r.fragLoadPolicy.default),d={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:by};e.stats=l.stats;const h={onSuccess:(t,n,r,i)=>{this.resetLoader(e,l);let s=t.data;r.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(s.slice(0,16)),s=s.slice(16)),a({frag:e,part:null,payload:s,networkDetails:i})},onError:(t,r,i,s)=>{this.resetLoader(e,l),o(new Ty({type:Wm.NETWORK_ERROR,details:jm.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:ig({url:n,data:void 0},t),error:new Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:i,stats:s}))},onAbort:(t,n,r)=>{this.resetLoader(e,l),o(new Ty({type:Wm.NETWORK_ERROR,details:jm.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:r,stats:t}))},onTimeout:(t,n,r)=>{this.resetLoader(e,l),o(new Ty({type:Wm.NETWORK_ERROR,details:jm.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:r,stats:t}))}};t&&(h.onProgress=(n,r,i,s)=>t({frag:e,part:null,payload:i,networkDetails:s})),l.load(u,d,h)})}loadPart(e,t,n){this.abort();const r=this.config,i=r.fLoader,s=r.loader;return new Promise((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap)return void o(Sy(e,t));const l=this.loader=i?new i(r):new s(r),u=xy(e,t);e.loader=l;const c=Jv(r.fragLoadPolicy.default),d={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:by};t.stats=l.stats,l.load(u,d,{onSuccess:(r,i,s,o)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const u={frag:e,part:t,payload:r.data,networkDetails:o};n(u),a(u)},onError:(n,r,i,s)=>{this.resetLoader(e,l),o(new Ty({type:Wm.NETWORK_ERROR,details:jm.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:ig({url:u.url,data:void 0},n),error:new Error(`HTTP Error ${n.code} ${n.text}`),networkDetails:i,stats:s}))},onAbort:(n,r,i)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),o(new Ty({type:Wm.NETWORK_ERROR,details:jm.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:i,stats:n}))},onTimeout:(n,r,i)=>{this.resetLoader(e,l),o(new Ty({type:Wm.NETWORK_ERROR,details:jm.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:i,stats:n}))}})})}updateStatsFromPart(e,t){const n=e.stats,r=t.stats,i=r.total;if(n.loaded+=r.loaded,i){const r=Math.round(e.duration/t.duration),s=Math.min(Math.round(n.loaded/i),r),a=(r-s)*Math.round(n.loaded/s);n.total=n.loaded+a}else n.total=Math.max(n.loaded,n.total);const s=n.loading,a=r.loading;s.start?s.first+=a.first-a.start:(s.start=a.start,s.first=a.first),s.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function xy(e,t=null){const n=t||e,r={frag:e,part:t,responseType:"arraybuffer",url:n.url,headers:{},rangeStart:0,rangeEnd:0},i=n.byteRangeStartOffset,s=n.byteRangeEndOffset;if(Gm(i)&&Gm(s)){var a;let t=i,n=s;if("initSegment"===e.sn&&("AES-128"===(o=null==(a=e.decryptdata)?void 0:a.method)||"AES-256"===o)){const e=s-i;e%16&&(n=s+(16-e%16)),0!==i&&(r.resetIV=!0,t=i-16)}r.rangeStart=t,r.rangeEnd=n}var o;return r}function Sy(e,t){const n=new Error(`GAP ${e.gap?"tag":"attribute"} found`),r={type:Wm.MEDIA_ERROR,details:jm.FRAG_GAP,fatal:!1,frag:e,error:n,networkDetails:null};return t&&(r.part=t),(t||e).stats.aborted=!0,new Ty(r)}class Ty extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Ey extends sg{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Ay{constructor(e,t,n,r=0,i=-1,s=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=n,this.size=r,this.part=i,this.partial=s}}const wy={length:0,start:()=>0,end:()=>0};class My{static isBuffered(e,t){if(e){const n=My.getBuffered(e);for(let e=n.length;e--;)if(t>=n.start(e)&&t<=n.end(e))return!0}return!1}static bufferedRanges(e){if(e){const t=My.getBuffered(e);return My.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let n=0;n<e.length;n++)t.push({start:e.start(n),end:e.end(n)});return t}static bufferInfo(e,t,n){if(e){const r=My.bufferedRanges(e);if(r.length)return My.bufferedInfo(r,t,n)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,n){t=Math.max(0,t),e.length>1&&e.sort((e,t)=>e.start-t.start||t.end-e.end);let r=-1,i=[];if(n)for(let s=0;s<e.length;s++){t>=e[s].start&&t<=e[s].end&&(r=s);const a=i.length;if(a){const t=i[a-1].end;e[s].start-t<n?e[s].end>t&&(i[a-1].end=e[s].end):i.push(e[s])}else i.push(e[s])}else i=e;let s,a=0,o=t,l=t;for(let e=0;e<i.length;e++){const u=i[e].start,c=i[e].end;if(-1===r&&t>=u&&t<=c&&(r=e),t+n>=u&&t<c)o=u,l=c,a=l-t;else if(t+n<u){s=u;break}}return{len:a,start:o||0,end:l||0,nextStart:s,buffered:e,bufferedIndex:r}}static getBuffered(e){try{return e.buffered||wy}catch(e){return dg.log("failed to get media.buffered",e),wy}}}const Ry=/\{\$([a-zA-Z0-9-_]+)\}/g;function Cy(e){return Ry.test(e)}function Iy(e,t){if(null!==e.variableList||e.hasVariableRefs){const n=e.variableList;return t.replace(Ry,t=>{const r=t.substring(2,t.length-1),i=null==n?void 0:n[r];return void 0===i?(e.playlistParsingError||(e.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`)),t):i})}return t}function Ly(e,t,n){let r,i,s=e.variableList;if(s||(e.variableList=s={}),"QUERYPARAM"in t){r=t.QUERYPARAM;try{const e=new self.URL(n).searchParams;if(!e.has(r))throw new Error(`"${r}" does not match any query parameter in URI: "${n}"`);i=e.get(r)}catch(t){e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${t.message}`))}}else r=t.NAME,i=t.VALUE;r in s?e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${r}"`)):s[r]=i||""}function Py(e,t,n){const r=t.IMPORT;if(n&&r in n){let t=e.variableList;t||(e.variableList=t={}),t[r]=n[r]}else e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${r}"`))}const Ny=/^(\d+)x(\d+)$/,Dy=/(.+?)=(".*?"|.*?)(?:,|$)/g;class ky{constructor(e,t){"string"==typeof e&&(e=ky.parseAttrList(e,t)),ng(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>"X-"===e.substring(0,2))}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const n=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)n[e]=parseInt(t.slice(2*e,2*e+2),16);return n}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const n=this[e];return n?parseFloat(n):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const n=this[e];return(n?n.split(/[ ,]+/):[]).reduce((e,t)=>(e[t.toLowerCase()]=!0,e),t)}bool(e){return"YES"===this[e]}decimalResolution(e){const t=Ny.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let n;const r={};for(Dy.lastIndex=0;null!==(n=Dy.exec(e));){const i=n[1].trim();let s=n[2];const a=0===s.indexOf('"')&&s.lastIndexOf('"')===s.length-1;let o=!1;if(a)s=s.slice(1,-1);else switch(i){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":o=!0}if(t&&(a||o))s=Iy(t,s);else if(!o&&!a)switch(i){case"CLOSED-CAPTIONS":if("NONE"===s)break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":dg.warn(`${e}: attribute ${i} is missing quotes`)}r[i]=s}return r}}function Oy(e){return"ID"!==e&&"CLASS"!==e&&"CUE"!==e&&"START-DATE"!==e&&"DURATION"!==e&&"END-DATE"!==e&&"END-ON-NEXT"!==e}function Fy(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e||"SCTE35-CMD"===e}class Uy{constructor(e,t,n=0){var r;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(null==t?void 0:t.tagAnchor)||null,this.tagOrder=null!=(r=null==t?void 0:t.tagOrder)?r:n,t){const n=t.attr;for(const t in n)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==n[t]){dg.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=ng(new ky({}),n,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const e=(null==t?void 0:t.endDate)||new Date(this.attr["END-DATE"]);Gm(e.getTime())&&(this._endDate=e)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return void 0===e?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return null===e||null===e.programDateTime?(dg.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return null!==t?this._dateAtEnd=new Date(this._startDate.getTime()+1e3*t):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(Gm(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return"com.apple.hls.interstitial"===this.class}get isValid(){return!!this.id&&!this._badValueForSameId&&Gm(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}class By{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,n=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!n||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||0===t&&n>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1}get hasProgramDateTime(){return!!this.fragments.length&&Gm(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const e=this.driftEndTime-this.driftStartTime;if(e>0){return 1e3*(this.driftEnd-this.driftStart)/e}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(-1!==t){for(let n=e.length;n--;)if(e[n].index>t)return e[n].index;return t}}return 0}get lastPartSn(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function Vy(e){return"AES-128"===e||"AES-256"===e||"AES-256-CTR"===e}function zy(e){switch(e){case"AES-128":case"AES-256":return fy;case"AES-256-CTR":return py;default:throw new Error(`invalid full segment method ${e}`)}}function Gy(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}function Hy(e){return Uint8Array.from(unescape(encodeURIComponent(e)),e=>e.charCodeAt(0))}function $y(e){const t=e.split(":");let n=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){const t="base64"===r[0],i=r[1];t?(e.splice(-1,1),n=Gy(i)):n=function(e){const t=Hy(e).subarray(0,16),n=new Uint8Array(16);return n.set(t,16-t.length),n}(i)}}return n}const Wy="undefined"!=typeof self?self:void 0;var jy={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},qy={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Xy(e){switch(e){case qy.FAIRPLAY:return jy.FAIRPLAY;case qy.PLAYREADY:return jy.PLAYREADY;case qy.WIDEVINE:return jy.WIDEVINE;case qy.CLEARKEY:return jy.CLEARKEY}}function Yy(e){switch(e){case jy.FAIRPLAY:return qy.FAIRPLAY;case jy.PLAYREADY:return qy.PLAYREADY;case jy.WIDEVINE:return qy.WIDEVINE;case jy.CLEARKEY:return qy.CLEARKEY}}function Ky(e){const{drmSystems:t,widevineLicenseUrl:n}=e,r=t?[jy.FAIRPLAY,jy.WIDEVINE,jy.PLAYREADY,jy.CLEARKEY].filter(e=>!!t[e]):[];return!r[jy.WIDEVINE]&&n&&r.push(jy.WIDEVINE),r}const Qy=null!=Wy&&null!=(Zy=Wy.navigator)&&Zy.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var Zy;let Jy={};class eb{static clearKeyUriToKeyIdMap(){Jy={}}constructor(e,t,n,r=[1],i=null,s){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=n,this.keyFormatVersions=r,this.iv=i,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&!Vy(e),null!=s&&s.startsWith("0x")&&(this.keyId=new Uint8Array(gg(s)))}matches(e){var t,n;return e.uri===this.uri&&e.method===this.method&&e.encrypted===this.encrypted&&e.keyFormat===this.keyFormat&&e.keyFormatVersions.join(",")===this.keyFormatVersions.join(",")&&(null==(t=e.iv)?void 0:t.join(","))===(null==(n=this.iv)?void 0:n.join(","))}isSupported(){if(this.method){if(Vy(this.method)||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case qy.FAIRPLAY:case qy.WIDEVINE:case qy.PLAYREADY:case qy.CLEARKEY:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(Vy(this.method)&&this.uri&&!this.iv){"number"!=typeof e&&(dg.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const t=function(e){const t=new Uint8Array(16);for(let n=12;n<16;n++)t[n]=e>>8*(15-n)&255;return t}(e);return new eb(this.method,this.uri,"identity",this.keyFormatVersions,t)}if(this.pssh&&this.keyId)return this;const t=$y(this.uri);if(t)switch(this.keyFormat){case qy.WIDEVINE:if(this.pssh=t,!this.keyId&&t.length>=22){const e=t.length-22;this.keyId=t.subarray(e,e+16)}break;case qy.PLAYREADY:{const e=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=iv(e,0,t),this.keyId=function(e){const t=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),n=String.fromCharCode.apply(null,Array.from(t)),r=n.substring(n.indexOf("<"),n.length),i=(new DOMParser).parseFromString(r,"text/xml").getElementsByTagName("KID")[0];if(i){const e=i.childNodes[0]?i.childNodes[0].nodeValue:i.getAttribute("VALUE");if(e){const t=Gy(e).subarray(0,16);return function(e){const t=function(e,t,n){const r=e[t];e[t]=e[n],e[n]=r};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}(t),t}}return null}(t);break}default:{let e=t.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=Jy[this.uri];if(!e){const t=Object.keys(Jy).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16);new DataView(e.buffer,12,4).setUint32(0,t),Jy[this.uri]=e}this.keyId=e}return this}}const tb=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,nb=/#EXT-X-MEDIA:(.*)/g,rb=/^#EXT(?:INF|-X-TARGETDURATION):/m,ib=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),sb=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class ab{static findGroup(e,t){for(let n=0;n<e.length;n++){const r=e[n];if(r.id===t)return r}}static resolve(e,t){return Ag.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return rb.test(e)}static parseMasterPlaylist(e,t){const n={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:Cy(e)},r=[];let i;for(tb.lastIndex=0;null!=(i=tb.exec(e));)if(i[1]){var s;const e=new ky(i[1],n),a=Iy(n,i[2]),o={attrs:e,bitrate:e.decimalInteger("BANDWIDTH")||e.decimalInteger("AVERAGE-BANDWIDTH"),name:e.NAME,url:ab.resolve(a,t)},l=e.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),db(e.CODECS,o);const u=e["SUPPLEMENTAL-CODECS"];u&&(o.supplemental={},db(u,o.supplemental)),null!=(s=o.unknownCodecs)&&s.length||r.push(o),n.levels.push(o)}else if(i[3]){const e=i[3],r=i[4];switch(e){case"SESSION-DATA":{const e=new ky(r,n),t=e["DATA-ID"];t&&(null===n.sessionData&&(n.sessionData={}),n.sessionData[t]=e);break}case"SESSION-KEY":{const e=ub(r,t,n);e.encrypted&&e.isSupported()?(null===n.sessionKeys&&(n.sessionKeys=[]),n.sessionKeys.push(e)):dg.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${r}"`);break}case"DEFINE":Ly(n,new ky(r,n),t);break;case"CONTENT-STEERING":{const e=new ky(r,n);n.contentSteering={uri:ab.resolve(e["SERVER-URI"],t),pathwayId:e["PATHWAY-ID"]||"."};break}case"START":n.startTimeOffset=cb(r)}}const a=r.length>0&&r.length<n.levels.length;return n.levels=a?r:n.levels,0===n.levels.length&&(n.playlistParsingError=new Error("no levels found in manifest")),n}static parseMasterPlaylistMedia(e,t,n){let r;const i={},s=n.levels,a={AUDIO:s.map(e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec})),SUBTITLES:s.map(e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec})),"CLOSED-CAPTIONS":[]};let o=0;for(nb.lastIndex=0;null!==(r=nb.exec(e));){const e=new ky(r[1],n),s=e.TYPE;if(s){const n=a[s],r=i[s]||[];i[s]=r;const l=e.LANGUAGE,u=e["ASSOC-LANGUAGE"],c=e.CHANNELS,d=e.CHARACTERISTICS,h=e["INSTREAM-ID"],f={attrs:e,bitrate:0,id:o++,groupId:e["GROUP-ID"]||"",name:e.NAME||l||"",type:s,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:l,url:e.URI?ab.resolve(e.URI,t):""};if(u&&(f.assocLang=u),c&&(f.channels=c),d&&(f.characteristics=d),h&&(f.instreamId=h),null!=n&&n.length){const e=ab.findGroup(n,f.groupId)||n[0];hb(f,e,"audioCodec"),hb(f,e,"textCodec")}r.push(f)}}return i}static parseLevelPlaylist(e,t,n,r,i,s){var a;const o={url:t},l=new By(t),u=l.fragments,c=[];let d,h,f,p,m=null,g=0,v=0,y=0,b=0,_=0,x=null,S=new Pg(r,o),T=-1,E=!1,A=null;if(ib.lastIndex=0,l.m3u8=e,l.hasVariableRefs=Cy(e),"#EXTM3U"!==(null==(a=ib.exec(e))?void 0:a[0]))return l.playlistParsingError=new Error("Missing format identifier #EXTM3U"),l;for(;null!==(d=ib.exec(e));){E&&(E=!1,S=new Pg(r,o),S.playlistOffset=y,S.start=y,S.sn=g,S.cc=b,_&&(S.bitrate=_),S.level=n,m&&(S.initSegment=m,m.rawProgramDateTime&&(S.rawProgramDateTime=m.rawProgramDateTime,m.rawProgramDateTime=null),A&&(S.setByteRange(A),A=null)));const e=d[1];if(e){S.duration=parseFloat(e);const t=(" "+d[2]).slice(1);S.title=t||null,S.tagList.push(t?["INF",e,t]:["INF",e])}else if(d[3]){if(Gm(S.duration)){S.playlistOffset=y,S.start=y,f&&mb(S,f,l),S.sn=g,S.level=n,S.cc=b,u.push(S);const e=(" "+d[3]).slice(1);S.relurl=Iy(l,e),fb(S,x,c),x=S,y+=S.duration,g++,v=0,E=!0}}else{if(d=d[0].match(sb),!d){dg.warn("No matches on slow regex match for level playlist!");continue}for(h=1;h<d.length&&void 0===d[h];h++);const e=(" "+d[h]).slice(1),i=(" "+d[h+1]).slice(1),a=d[h+2]?(" "+d[h+2]).slice(1):null;switch(e){case"BYTERANGE":x?S.setByteRange(i,x):S.setByteRange(i);break;case"PROGRAM-DATE-TIME":S.rawProgramDateTime=i,S.tagList.push(["PROGRAM-DATE-TIME",i]),-1===T&&(T=u.length);break;case"PLAYLIST-TYPE":l.type&&gb(l,e,d),l.type=i.toUpperCase();break;case"MEDIA-SEQUENCE":0!==l.startSN?gb(l,e,d):u.length>0&&vb(l,e,d),g=l.startSN=parseInt(i);break;case"SKIP":{l.skippedSegments&&gb(l,e,d);const t=new ky(i,l),n=t.decimalInteger("SKIPPED-SEGMENTS");if(Gm(n)){l.skippedSegments+=n;for(let e=n;e--;)u.push(null);g+=n}const r=t.enumeratedString("RECENTLY-REMOVED-DATERANGES");r&&(l.recentlyRemovedDateranges=(l.recentlyRemovedDateranges||[]).concat(r.split("\t")));break}case"TARGETDURATION":0!==l.targetduration&&gb(l,e,d),l.targetduration=Math.max(parseInt(i),1);break;case"VERSION":null!==l.version&&gb(l,e,d),l.version=parseInt(i);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":l.live||gb(l,e,d),l.live=!1;break;case"#":(i||a)&&S.tagList.push(a?[i,a]:[i]);break;case"DISCONTINUITY":b++,S.tagList.push(["DIS"]);break;case"GAP":S.gap=!0,S.tagList.push([e]);break;case"BITRATE":S.tagList.push([e,i]),_=1e3*parseInt(i),Gm(_)?S.bitrate=_:_=0;break;case"DATERANGE":{const e=new ky(i,l),t=new Uy(e,l.dateRanges[e.ID],l.dateRangeTagCount);l.dateRangeTagCount++,t.isValid||l.skippedSegments?l.dateRanges[t.id]=t:dg.warn(`Ignoring invalid DATERANGE tag: "${i}"`),S.tagList.push(["EXT-X-DATERANGE",i]);break}case"DEFINE":{const e=new ky(i,l);"IMPORT"in e?Py(l,e,s):Ly(l,e,t)}break;case"DISCONTINUITY-SEQUENCE":0!==l.startCC?gb(l,e,d):u.length>0&&vb(l,e,d),l.startCC=b=parseInt(i);break;case"KEY":{const e=ub(i,t,l);if(e.isSupported()){if("NONE"===e.method){f=void 0;break}f||(f={});const t=f[e.keyFormat];null!=t&&t.matches(e)||(t&&(f=ng({},f)),f[e.keyFormat]=e)}else dg.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${i}"`);break}case"START":l.startTimeOffset=cb(i);break;case"MAP":{const e=new ky(i,l);if(S.duration){const t=new Pg(r,o);pb(t,e,n,f),m=t,S.initSegment=m,m.rawProgramDateTime&&!S.rawProgramDateTime&&(S.rawProgramDateTime=m.rawProgramDateTime)}else{const t=S.byteRangeEndOffset;if(t){const e=S.byteRangeStartOffset;A=`${t-e}@${e}`}else A=null;pb(S,e,n,f),m=S,E=!0}m.cc=b;break}case"SERVER-CONTROL":p&&gb(l,e,d),p=new ky(i),l.canBlockReload=p.bool("CAN-BLOCK-RELOAD"),l.canSkipUntil=p.optionalFloat("CAN-SKIP-UNTIL",0),l.canSkipDateRanges=l.canSkipUntil>0&&p.bool("CAN-SKIP-DATERANGES"),l.partHoldBack=p.optionalFloat("PART-HOLD-BACK",0),l.holdBack=p.optionalFloat("HOLD-BACK",0);break;case"PART-INF":{l.partTarget&&gb(l,e,d);const t=new ky(i);l.partTarget=t.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=l.partList;e||(e=l.partList=[]);const t=v>0?e[e.length-1]:void 0,n=v++,r=new ky(i,l),s=new Ng(r,S,o,n,t);e.push(s),S.duration+=s.duration;break}case"PRELOAD-HINT":{const e=new ky(i,l);l.preloadHint=e;break}case"RENDITION-REPORT":{const e=new ky(i,l);l.renditionReports=l.renditionReports||[],l.renditionReports.push(e);break}default:dg.warn(`line parsed but not handled: ${d}`)}}}x&&!x.relurl?(u.pop(),y-=x.duration,l.partList&&(l.fragmentHint=x)):l.partList&&(fb(S,x,c),S.cc=b,l.fragmentHint=S,f&&mb(S,f,l)),l.targetduration||(l.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));const w=u.length,M=u[0],R=u[w-1];if(y+=l.skippedSegments*l.targetduration,y>0&&w&&R){l.averagetargetduration=y/w;const e=R.sn;l.endSN="initSegment"!==e?e:0,l.live||(R.endList=!0),M&&void 0===l.startCC&&(l.startCC=M.cc),T>0&&(!function(e,t){let n=e[t];for(let r=t;r--;){const t=e[r];if(!t)return;t.programDateTime=n.programDateTime-1e3*t.duration,n=t}}(u,T),M&&c.unshift(M))}else l.endSN=0,l.startCC=0;return l.fragmentHint&&(y+=l.fragmentHint.duration),l.totalduration=y,c.length&&l.dateRangeTagCount&&M&&ob(c,l),l.endCC=b,l}}function ob(e,t){const n=e.length;if(!n)return;const r=e[n-1],i=t.live?1/0:t.totalduration,s=Object.keys(t.dateRanges);for(let a=s.length;a--;){const o=t.dateRanges[s[a]],l=o.startDate.getTime();o.tagAnchor=r.ref;for(let r=n;r--;){const n=lb(t,l,e,r,i);if(-1!==n){o.tagAnchor=t.fragments[n].ref;break}}}}function lb(e,t,n,r,i){const s=n[r];if(s){const o=s.programDateTime;if(t>=o||0===r){var a;if(t<=o+1e3*(((null==(a=n[r+1])?void 0:a.start)||i)-s.start)){const i=n[r].sn-e.startSN,s=e.fragments;if(s.length>n.length){for(let a=(n[r+1]||s[s.length-1]).sn-e.startSN;a>i;a--){const e=s[a].programDateTime;if(t>=e&&t<e+1e3*s[a].duration)return a}}return i}}}return-1}function ub(e,t,n){var r,i;const s=new ky(e,n),a=null!=(r=s.METHOD)?r:"",o=s.URI,l=s.hexadecimalInteger("IV"),u=s.KEYFORMATVERSIONS,c=null!=(i=s.KEYFORMAT)?i:"identity";o&&s.IV&&!l&&dg.error(`Invalid IV: ${s.IV}`);const d=o?ab.resolve(o,t):"",h=(u||"1").split("/").map(Number).filter(Number.isFinite);return new eb(a,d,c,h,l,s.KEYID)}function cb(e){const t=new ky(e).decimalFloatingPoint("TIME-OFFSET");return Gm(t)?t:null}function db(e,t){let n=(e||"").split(/[ ,]+/).filter(e=>e);["video","audio","text"].forEach(e=>{const r=n.filter(t=>ov(t,e));r.length&&(t[`${e}Codec`]=r.map(e=>e.split("/")[0]).join(","),n=n.filter(e=>-1===r.indexOf(e)))}),t.unknownCodecs=n}function hb(e,t,n){const r=t[n];r&&(e[n]=r)}function fb(e,t,n){e.rawProgramDateTime?n.push(e):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime)}function pb(e,t,n,r){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=n,e.sn="initSegment",r&&(e.levelkeys=r),e.initSegment=null}function mb(e,t,n){e.levelkeys=t;const{encryptedFragments:r}=n;r.length&&r[r.length-1].levelkeys===t||!Object.keys(t).some(e=>t[e].isCommonEncryption)||r.push(e)}function gb(e,t,n){e.playlistParsingError=new Error(`#EXT-X-${t} must not appear more than once (${n[0]})`)}function vb(e,t,n){e.playlistParsingError=new Error(`#EXT-X-${t} must appear before the first Media Segment (${n[0]})`)}function yb(e,t){const n=t.startPTS;if(Gm(n)){let r,i=0;t.sn>e.sn?(i=n-e.start,r=e):(i=e.start-n,r=t),r.duration!==i&&r.setDuration(i)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.setStart(e.start+(e.minEndPTS-e.start)):t.setStart(e.start+e.duration)}else t.setStart(Math.max(e.start-t.duration,0))}function bb(e,t,n,r,i,s){r-n<=0&&(dg.warn("Fragment should have a positive duration",t),r=n+t.duration,s=i+t.duration);let a=n,o=r;const l=t.startPTS,u=t.endPTS;if(Gm(l)){const e=Math.abs(l-n);Gm(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,a=Math.max(n,l),n=Math.min(n,l),i=Math.min(i,t.startDTS),o=Math.min(r,u),r=Math.max(r,u),s=Math.max(s,t.endDTS)}const c=n-t.start;0!==t.start&&t.setStart(n),t.setDuration(r-t.start),t.startPTS=n,t.maxStartPTS=a,t.startDTS=i,t.endPTS=r,t.minEndPTS=o,t.endDTS=s;const d=t.sn;if(!e||d<e.startSN||d>e.endSN)return 0;let h;const f=d-e.startSN,p=e.fragments;for(p[f]=t,h=f;h>0;h--)yb(p[h],p[h-1]);for(h=f;h<p.length-1;h++)yb(p[h],p[h+1]);return e.fragmentHint&&yb(p[p.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,c}function _b(e,t){if(e===t)return;let n=null;const r=e.fragments;for(let e=r.length-1;e>=0;e--){const t=r[e].initSegment;if(t){n=t;break}}let i;e.fragmentHint&&delete e.fragmentHint.endPTS,function(e,t,n){const r=t.skippedSegments,i=Math.max(e.startSN,t.startSN)-t.startSN,s=(e.fragmentHint?1:0)+(r?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,a=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let u=i;u<=s;u++){const i=l[a+u];let s=o[u];if(r&&!s&&i&&(s=t.fragments[u]=i),i&&s){if(n(i,s,u,o),i.url&&i.url!==s.url)return void(t.playlistParsingError=xb(`media sequence mismatch ${s.sn}:`,e,t,i,s));if(i.cc!==s.cc)return void(t.playlistParsingError=xb(`discontinuity sequence mismatch (${i.cc}!=${s.cc})`,e,t,i,s))}}}(e,t,(e,r,s,a)=>{if((!t.startCC||t.skippedSegments)&&r.cc!==e.cc){const n=e.cc-r.cc;for(let e=s;e<a.length;e++)a[e].cc+=n;t.endCC=a[a.length-1].cc}Gm(e.startPTS)&&Gm(e.endPTS)&&(r.setStart(r.startPTS=e.startPTS),r.startDTS=e.startDTS,r.maxStartPTS=e.maxStartPTS,r.endPTS=e.endPTS,r.endDTS=e.endDTS,r.minEndPTS=e.minEndPTS,r.setDuration(e.endPTS-e.startPTS),r.duration&&(i=r),t.PTSKnown=t.alignedSliding=!0),e.hasStreams&&(r.elementaryStreams=e.elementaryStreams),r.loader=e.loader,e.hasStats&&(r.stats=e.stats),e.initSegment&&(r.initSegment=e.initSegment,n=e.initSegment)});const s=t.fragments,a=t.fragmentHint?s.concat(t.fragmentHint):s;if(n&&a.forEach(e=>{var t;!e||e.initSegment&&e.initSegment.relurl!==(null==(t=n)?void 0:t.relurl)||(e.initSegment=n)}),t.skippedSegments){if(t.deltaUpdateFailed=s.some(e=>!e),t.deltaUpdateFailed){dg.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)s.shift();t.startSN=s[0].sn}else{t.canSkipDateRanges&&(t.dateRanges=function(e,t){const{dateRanges:n,recentlyRemovedDateranges:r}=t,i=ng({},e);r&&r.forEach(e=>{delete i[e]});const s=Object.keys(i).length;s&&Object.keys(n).forEach(e=>{const t=i[e],r=new Uy(n[e].attr,t);r.isValid?(i[e]=r,t||(r.tagOrder+=s)):dg.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${kv(n[e].attr)}"`)});return i}(e.dateRanges,t));const n=e.fragments.filter(e=>e.rawProgramDateTime);if(e.hasProgramDateTime&&!t.hasProgramDateTime)for(let e=1;e<a.length;e++)null===a[e].programDateTime&&fb(a[e],a[e-1],n);ob(n,t)}t.endCC=s[s.length-1].cc}if(!t.startCC){var o;const n=Ab(e,t.startSN-1);t.startCC=null!=(o=null==n?void 0:n.cc)?o:s[0].cc}!function(e,t,n){if(e&&t){let r=0;for(let i=0,s=e.length;i<=s;i++){const s=e[i],a=t[i+r];s&&a&&s.index===a.index&&s.fragment.sn===a.fragment.sn?n(s,a):r--}}}(e.partList,t.partList,(e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats}),i?bb(t,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS):Sb(e,t),s.length&&(t.totalduration=t.edge-s[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const l=t.advancedDateTime;if(t.advanced&&l){const e=t.edge;t.driftStart||(t.driftStartTime=l,t.driftStart=e),t.driftEndTime=l,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime;-1===t.requestScheduled&&(t.requestScheduled=e.requestScheduled)}function xb(e,t,n,r,i){return new Error(`${e} ${i.url}\nPlaylist starting @${t.startSN}\n${t.m3u8}\n\nPlaylist starting @${n.startSN}\n${n.m3u8}`)}function Sb(e,t,n=!0){const r=t.startSN+t.skippedSegments-e.startSN,i=e.fragments,s=r>=0;let a=0;if(s&&r<i.length)a=i[r].start;else if(s&&t.startSN===e.endSN+1)a=e.fragmentEnd;else if(s&&n)a=e.fragmentStart+r*t.levelTargetDuration;else{if(t.skippedSegments||0!==t.fragmentStart)return;a=e.fragmentStart}Tb(t,a)}function Tb(e,t){if(t){const n=e.fragments;for(let r=e.skippedSegments;r<n.length;r++)n[r].addStart(t);e.fragmentHint&&e.fragmentHint.addStart(t)}}function Eb(e,t=1/0){let n=1e3*e.targetduration;if(e.updated){const r=e.fragments,i=4;if(r.length&&n*i>t){const e=1e3*r[r.length-1].duration;e<n&&(n=e)}}else n/=2;return Math.round(n)}function Ab(e,t,n){if(!e)return null;let r=e.fragments[t-e.startSN];return r||(r=e.fragmentHint,r&&r.sn===t?r:t<e.startSN&&n&&n.sn===t?n:null)}function wb(e,t,n){return e?Mb(e.partList,t,n):null}function Mb(e,t,n){if(e)for(let r=e.length;r--;){const i=e[r];if(i.index===n&&i.fragment.sn===t)return i}return null}function Rb(e){e.forEach((e,t)=>{var n;null==(n=e.details)||n.fragments.forEach(e=>{e.level=t,e.initSegment&&(e.initSegment.level=t)})})}function Cb(e,t){for(let r=0,i=e.length;r<i;r++){var n;if((null==(n=e[r])?void 0:n.cc)===t)return e[r]}return null}function Ib(e,t){if(e){const n=e.start+t;e.start=e.startPTS=n,e.endPTS=n+e.duration}}function Lb(e,t){const n=t.fragments;for(let t=0,r=n.length;t<r;t++)Ib(n[t],e);t.fragmentHint&&Ib(t.fragmentHint,e),t.alignedSliding=!0}function Pb(e,t){if(!function(e,t){return!!(e&&t.startCC<e.endCC&&t.endCC>e.startCC)}(t,e))return;const n=Math.min(t.endCC,e.endCC),r=Cb(t.fragments,n),i=Cb(e.fragments,n);if(!r||!i)return;dg.log(`Aligning playlist at start of dicontinuity sequence ${n}`);Lb(r.start-i.start,e)}function Nb(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;const n=e.fragments,r=t.fragments;if(!n.length||!r.length)return;let i,s;const a=Math.min(t.endCC,e.endCC);t.startCC<a&&e.startCC<a&&(i=Cb(r,a),s=Cb(n,a)),i&&s||(i=r[Math.floor(r.length/2)],s=Cb(n,i.cc)||n[Math.floor(n.length/2)]);const o=i.programDateTime,l=s.programDateTime;if(!o||!l)return;Lb((l-o)/1e3-(s.start-i.start),e)}const Db=function(e){let t="";const n=e.length;for(let r=0;r<n;r++)t+=`[${e.start(r).toFixed(3)}-${e.end(r).toFixed(3)}]`;return t},kb="STOPPED",Ob="IDLE",Fb="KEY_LOADING",Ub="FRAG_LOADING",Bb="FRAG_LOADING_WAITING_RETRY",Vb="WAITING_TRACK",zb="PARSING",Gb="PARSED",Hb="ENDED",$b="ERROR",Wb="WAITING_INIT_PTS",jb="WAITING_LEVEL";class qb extends Ey{constructor(e,t,n,r,i){super(r,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=kb,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:e,fragCurrent:t,media:n,mediaBuffer:r,state:i}=this,s=n?n.currentTime:0,a=My.bufferInfo(r||n,s,e.maxBufferHole),o=!a.len;if(this.log(`Media seeking to ${Gm(s)?s.toFixed(3):s}, state: ${i}, ${o?"out of":"in"} buffer`),this.state===Hb)this.resetLoadingState();else if(t){const n=e.maxFragLookUpTolerance,r=t.start-n,i=t.start+t.duration+n;if(o||i<a.start||r>a.end){const e=s>i;(s<r||e)&&(e&&t.loader&&(this.log(`Cancelling fragment load for seek (sn: ${t.sn})`),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(n){this.fragmentTracker.removeFragmentsInRange(s,1/0,this.playlistType,!0);if(s>this.lastCurrentTime&&(this.lastCurrentTime=s),!this.loadingParts){const e=Math.max(a.end,s),t=this.shouldLoadParts(this.getLevelDetails(),e);t&&(this.log(`LL-Part loading ON after seeking to ${s.toFixed(2)} with buffer @${e.toFixed(2)}`),this.loadingParts=t)}}this.hls.hasEnoughToStart||(this.log(`Setting ${o?"startPosition":"nextLoadPosition"} to ${s} for seek without enough to start`),this.nextLoadPosition=s,o&&(this.startPosition=s)),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=i,this.hls=e,this.fragmentLoader=new _y(e.config),this.keyLoader=n,this.fragmentTracker=t,this.config=e.config,this.decrypter=new yy(e.config)}registerListeners(){const{hls:e}=this;e.on(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(qm.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(qm.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===kb)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=kb}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return-1===t&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const n=e.end||0,r=this.config.timelineOffset||0;if(n<=r)return!1;const i=e.buffered;this.config.maxBufferHole&&i&&i.length>1&&(e=My.bufferedInfo(i,e.start,0));const s=e.nextStart;if(s&&s>r&&s<t.edge)return!1;if(this.media.currentTime<e.start)return!1;const a=t.partList;if(null!=a&&a.length){const e=a[a.length-1];return My.isBuffered(this.media,e.start+e.duration/2)}const o=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(o)}getLevelDetails(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levelLastLoaded)?void 0:e.details}get timelineOffset(){const e=this.config.timelineOffset;var t;return e?(null==(t=this.getLevelDetails())?void 0:t.appliedTimelineOffset)||e:0}onMediaAttached(e,t){const n=this.media=this.mediaBuffer=t.media;n.removeEventListener("seeking",this.onMediaSeeking),n.removeEventListener("ended",this.onMediaEnded),n.addEventListener("seeking",this.onMediaSeeking),n.addEventListener("ended",this.onMediaEnded);const r=this.config;this.levels&&r.autoStartLoad&&this.state===kb&&this.startLoad(r.startPosition)}onMediaDetaching(e,t){const n=!!t.transferMedia,r=this.media;if(null!==r){if(r.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),r.removeEventListener("seeking",this.onMediaSeeking),r.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!n&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,n)return this.resetLoadingState(),void this.resetTransmuxer();this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=kb,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,n){this.startFragRequested=!0,this._loadFragForPlayback(e,t,n)}_loadFragForPlayback(e,t,n){this._doFragLoad(e,t,n,e=>{const t=e.frag;if(this.fragContextChanged(t))return this.warn(`${t.type} sn: ${t.sn}${e.part?" part: "+e.part.index:""} of ${this.fragInfo(t,!1,e.part)}) was dropped during download.`),void this.fragmentTracker.removeFragment(t);t.stats.chunkCount++,this._handleFragmentLoadProgress(e)}).then(e=>{if(!e)return;const t=this.state,n=e.frag;this.fragContextChanged(n)?(t===Ub||!this.fragCurrent&&t===zb)&&(this.fragmentTracker.removeFragment(n),this.state=Ob):("payload"in e&&(this.log(`Loaded ${n.type} sn: ${n.sn} of ${this.playlistLabel()} ${n.level}`),this.hls.trigger(qm.FRAG_LOADED,e)),this._handleFragmentLoadComplete(e))}).catch(t=>{this.state!==kb&&this.state!==$b&&(this.warn(`Frag error: ${(null==t?void 0:t.message)||t}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:n}=this;if(n.getState(e)===ay){const t=e.type,r=this.getFwdBufferInfo(this.mediaBuffer,t),i=Math.max(e.duration,r?r.len:this.config.maxBufferLength),s=this.backtrackFragment;(1===(s?e.sn-s.sn:0)||this.reduceMaxBufferLength(i,e.duration))&&n.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?n.removeAllFragments():n.hasParts(e.type)&&(n.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),n.getState(e)===oy&&n.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return(null==t?void 0:t.live)&&"EVENT"!==t.type&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,n=null){if(!(e-t))return;const r={startOffset:e,endOffset:t,type:n};this.hls.trigger(qm.BUFFER_FLUSHING,r)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(e=>{const t=null==e?void 0:e.frag;if(!t||this.fragContextChanged(t)||!this.levels)throw new Error("init load aborted");return e}).then(e=>{const{hls:t}=this,{frag:n,payload:r}=e,i=n.decryptdata;if(r&&r.byteLength>0&&null!=i&&i.key&&i.iv&&Vy(i.method)){const s=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),i.key.buffer,i.iv.buffer,zy(i.method)).catch(e=>{throw t.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:n}),e}).then(r=>{const i=self.performance.now();return t.trigger(qm.FRAG_DECRYPTED,{frag:n,payload:r,stats:{tstart:s,tdecrypt:i}}),e.payload=r,this.completeInitSegmentLoad(e)})}return this.completeInitSegmentLoad(e)}).catch(t=>{this.state!==kb&&this.state!==$b&&(this.warn(t),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const n=e.frag.stats;this.state!==kb&&(this.state=Ob),e.frag.data=new Uint8Array(e.payload),n.parsing.start=n.buffering.start=self.performance.now(),n.parsing.end=n.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const n=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${n?Db(My.getBuffered(n)):"(detached)"})`),Lg(e)){var r;if(e.type!==Zm.SUBTITLE){const t=e.elementaryStreams;if(!Object.keys(t).some(e=>!!t[e]))return void(this.state=Ob)}const t=null==(r=this.levels)?void 0:r[e.level];null!=t&&t.fragmentError&&(this.log(`Resetting level fragment error count of ${t.fragmentError} on frag buffered`),t.fragmentError=0)}this.state=Ob}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:n,part:r,partsLoaded:i}=e,s=!i||0===i.length||i.some(e=>!e),a=new Ay(n.level,n.sn,n.stats.chunkCount+1,0,r?r.index:-1,!s);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,n=null,r){var i;this.fragCurrent=e;const s=null==t?void 0:t.details;if(!this.levels||!s)throw new Error(`frag load aborted, missing level${s?"":" detail"}s`);let a=null;!e.encrypted||null!=(i=e.decryptdata)&&i.key?e.encrypted||(a=this.keyLoader.loadClear(e,s.encryptedFragments,this.startFragRequested),a&&this.log("[eme] blocking frag load until media-keys acquired")):(this.log(`Loading key for ${e.sn} of [${s.startSN}-${s.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=Fb,this.fragCurrent=e,a=this.keyLoader.load(e).then(e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(qm.KEY_LOADED,e),this.state===Fb&&(this.state=Ob),e}),this.hls.trigger(qm.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING"))));const o=this.fragPrevious;if(Lg(e)&&(!o||e.sn!==o.sn)){const n=this.shouldLoadParts(t.details,e.end);n!==this.loadingParts&&(this.log(`LL-Part loading ${n?"ON":"OFF"} loading sn ${null==o?void 0:o.sn}->${e.sn}`),this.loadingParts=n)}if(n=Math.max(e.start,n||0),this.loadingParts&&Lg(e)){const i=s.partList;if(i&&r){n>e.end&&s.fragmentHint&&(e=s.fragmentHint);const o=this.getNextPart(i,e,n);if(o>-1){const l=i[o];let u;return e=this.fragCurrent=l.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${l.index} (${o}/${i.length-1}) of ${this.fragInfo(e,!1,l)}) cc: ${e.cc} [${s.startSN}-${s.endSN}], target: ${parseFloat(n.toFixed(3))}`),this.nextLoadPosition=l.start+l.duration,this.state=Ub,u=a?a.then(n=>!n||this.fragContextChanged(n.frag)?null:this.doFragPartsLoad(e,l,t,r)).catch(e=>this.handleFragLoadError(e)):this.doFragPartsLoad(e,l,t,r).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(qm.FRAG_LOADING,{frag:e,part:l,targetBufferTime:n}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):u}if(!e.url||this.loadedEndOfParts(i,n))return Promise.resolve(null)}}if(Lg(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${n.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${s?"["+s.startSN+"-"+s.endSN+"]":""}, target: ${parseFloat(n.toFixed(3))}`),Gm(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=Ub;const l=this.config.progressive;let u;return u=l&&a?a.then(t=>!t||this.fragContextChanged(null==t?void 0:t.frag)?null:this.fragmentLoader.load(e,r)).catch(e=>this.handleFragLoadError(e)):Promise.all([this.fragmentLoader.load(e,l?r:void 0),a]).then(([e])=>(!l&&e&&r&&r(e),e)).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(qm.FRAG_LOADING,{frag:e,targetBufferTime:n}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):u}doFragPartsLoad(e,t,n,r){return new Promise((i,s)=>{var a;const o=[],l=null==(a=n.details)?void 0:a.partList,u=t=>{this.fragmentLoader.loadPart(e,t,r).then(r=>{o[t.index]=r;const s=r.part;this.hls.trigger(qm.FRAG_LOADED,r);const a=wb(n.details,e.sn,t.index+1)||Mb(l,e.sn,t.index+1);if(!a)return i({frag:e,part:s,partsLoaded:o});u(a)}).catch(s)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===jm.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(qm.ERROR,t)}else this.hls.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==zb)return void(this.fragCurrent||this.state===kb||this.state===$b||(this.state=Ob));const{frag:n,part:r,level:i}=t,s=self.performance.now();n.stats.parsing.end=s,r&&(r.stats.parsing.end=s);const a=this.getLevelDetails(),o=a&&n.sn>a.endSN||this.shouldLoadParts(a,n.end);o!==this.loadingParts&&(this.log(`LL-Part loading ${o?"ON":"OFF"} after parsing segment ending @${n.end.toFixed(2)}`),this.loadingParts=o),this.updateLevelTiming(n,r,i,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(null!=e&&e.partList){var n;const i=e.partList[0];if(t>=i.end+((null==(n=e.fragmentHint)?void 0:n.duration)||0)){var r;if((this.hls.hasEnoughToStart?(null==(r=this.media)?void 0:r.currentTime)||this.lastCurrentTime:this.getLoadPosition())>i.start-i.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:n}=this,{level:r,sn:i,part:s}=e;if(null==t||!t[r])return this.warn(`Levels object was unset while buffering fragment ${i} of ${this.playlistLabel()} ${r}. The current chunk will not be buffered.`),null;const a=t[r],o=a.details,l=s>-1?wb(o,i,s):null,u=l?l.fragment:Ab(o,i,n);return u?(n&&n!==u&&(u.stats=n.stats),{frag:u,part:l,level:a}):null}bufferFragmentData(e,t,n,r,i){var s;if(!e||this.state!==zb)return;const{data1:a,data2:o}=e;let l=a;if(a&&o&&(l=Zg(a,o)),null==(s=l)||!s.length)return;const u=this.initPTS[t.cc],c=u?-u.baseTime/u.timescale:void 0,d={type:e.type,frag:t,part:n,chunkMeta:r,offset:c,parent:t.type,data:l};if(this.hls.trigger(qm.BUFFER_APPENDING,d),e.dropped&&e.independent&&!n){if(i)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!My.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const n=t.currentTime,r=My.bufferInfo(t,n,0),i=e.duration,s=Math.min(2*this.config.maxFragLookUpTolerance,.25*i),a=Math.max(Math.min(e.start-s,r.end-s),n+s);e.start-a>s&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var n;const r=this.getLoadPosition();if(!Gm(r))return null;const i=this.lastCurrentTime>r||null!=(n=this.media)&&n.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,r,t,i)}getFwdBufferInfoAtPos(e,t,n,r){const i=My.bufferInfo(e,t,r);if(0===i.len&&void 0!==i.nextStart){const s=this.fragmentTracker.getBufferedFrag(t,n);if(s&&(i.nextStart<=s.end||s.gap)){const n=Math.max(Math.min(i.nextStart,s.end)-t,r);return My.bufferInfo(e,t,n)}}return i}getMaxBufferLength(e){const{config:t}=this;let n;return n=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(n,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const n=this.config,r=Math.max(Math.min(e-t,n.maxBufferLength),t),i=Math.max(e-3*t,n.maxMaxBufferLength/2,r);return i>=r&&(n.maxMaxBufferLength=i,this.warn(`Reduce max buffer length to ${i}s`),!0)}getAppendedFrag(e,t=Zm.MAIN){var n;const r=null==(n=this.fragmentTracker)?void 0:n.getAppendedFrag(e,t);return r&&"fragment"in r?r.fragment:r}getNextFragment(e,t){const n=t.fragments,r=n.length;if(!r)return null;const{config:i}=this,s=n[0].start,a=i.lowLatencyMode&&!!t.partList;let o=null;if(t.live){const n=i.initialLiveManifestSize;if(r<n)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${n})`),null;if(!t.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||e<s){var l;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),o=this.getInitialLiveFragment(t);const n=this.hls.startPosition,r=this.hls.liveSyncPosition,i=o?(-1!==n&&n>=s?n:r)||o.start:e;this.log(`Setting startPosition to ${i} to match start frag at live edge. mainStart: ${n} liveSyncPosition: ${r} frag.start: ${null==(l=o)?void 0:l.start}`),this.startPosition=this.nextLoadPosition=i}}else e<=s&&(o=n[0]);if(!o){const n=this.loadingParts?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,n,t)}let u=this.filterReplacedPrimary(o,t);if(!u&&o){const e=o.sn-t.startSN;u=this.filterReplacedPrimary(n[e+1]||null,t)}return this.mapToInitFragWhenRequired(u)}isLoopLoading(e,t){const n=this.fragmentTracker.getState(e);return(n===ly||n===oy&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,n,r,i){let s=null;if(e.gap&&(s=this.getNextFragment(this.nextLoadPosition,t),s&&!s.gap&&n.nextStart)){const e=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,n.nextStart,r,0);if(null!==e&&n.len+e.len>=i){const e=s.sn;return this.loopSn!==e&&(this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${e}`),this.loopSn=e),null}}return this.loopSn=void 0,s}get primaryPrefetch(){if(Xb(this.hls.config)){var e,t;if(null==(e=this.hls.interstitialsManager)||null==(t=e.playingItem)?void 0:t.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(Xb(this.hls.config)&&e.type!==Zm.SUBTITLE){const n=this.hls.interstitialsManager,r=null==n?void 0:n.bufferingItem;if(r){const n=r.event;if(n){if(n.appendInPlace||Math.abs(e.start-r.start)>1||0===r.start)return null}else{if(e.end<=r.start&&!1===(null==t?void 0:t.live))return null;if(e.start>r.end&&r.nextEvent&&(r.nextEvent.appendInPlace||e.start-r.end>1))return null}}const i=null==n?void 0:n.playerQueue;if(i)for(let t=i.length;t--;){const n=i[t].interstitial;if(n.appendInPlace&&e.start>=n.startTime&&e.end<=n.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}getNextPart(e,t,n){let r=-1,i=!1,s=!0;for(let a=0,o=e.length;a<o;a++){const o=e[a];if(s=s&&!o.independent,r>-1&&n<o.start)break;const l=o.loaded;l?r=-1:(i||o.independent||s)&&o.fragment===t&&(r=a),i=l}return r}loadedEndOfParts(e,t){const n=e[e.length-1];return n&&t>n.start&&n.loaded}getInitialLiveFragment(e){const t=e.fragments,n=this.fragPrevious;let r=null;if(n){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${n.programDateTime}`),r=function(e,t,n){if(null===t||!Array.isArray(e)||!e.length||!Gm(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;for(let r=0;r<e.length;++r){const i=e[r];if(Xv(t,n,i))return i}return null}(t,n.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){const i=n.sn+1;if(i>=e.startSN&&i<=e.endSN){const s=t[i-e.startSN];n.cc===s.cc&&(r=s,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=Yv(e,n.cc,n.end),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{const t=this.hls.liveSyncPosition;null!==t&&(r=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return r}getFragmentAtPosition(e,t,n){const{config:r}=this;let{fragPrevious:i}=this,{fragments:s,endSN:a}=n;const{fragmentHint:o}=n,{maxFragLookUpTolerance:l}=r,u=n.partList,c=!!(this.loadingParts&&null!=u&&u.length&&o);let d;if(c&&o&&!this.bitrateTest&&u[u.length-1].fragment.sn===o.sn&&(s=s.concat(o),a=o.sn),e<t){var h;d=jv(i,s,e,e<this.lastCurrentTime||e>t-l||null!=(h=this.media)&&h.paused||!this.startFragRequested?0:l)}else d=s[s.length-1];if(d){const e=d.sn-n.startSN,t=this.fragmentTracker.getState(d);if((t===ly||t===oy&&d.gap)&&(i=d),i&&d.sn===i.sn&&(!c||u[0].fragment.sn>d.sn||!n.live&&!c)){if(i&&d.level===i.level){const t=s[e+1];d=d.sn<a&&this.fragmentTracker.getState(t)!==ly?t:null}}}return d}alignPlaylists(e,t,n){const r=e.fragments.length;if(!r)return this.warn("No fragments in live playlist"),0;const i=e.fragmentStart,s=!t,a=e.alignedSliding&&Gm(i);if(s||!a&&!i){!function(e,t){e&&(Pb(t,e),!t.alignedSliding&&e&&Nb(t,e),t.alignedSliding||!e||t.skippedSegments||Sb(e,t,!1))}(n,e);const i=e.fragmentStart;return this.log(`Live playlist sliding: ${i.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${r}`),i}return i}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let n=this.startPosition;n<t&&(n=-1);const r=this.timelineOffset;if(-1===n){const i=null!==this.startTimeOffset,s=i?this.startTimeOffset:e.startTimeOffset;null!==s&&Gm(s)?(n=t+s,s<0&&(n+=e.edge),n=Math.min(Math.max(t,n),t+e.totalduration),this.log(`Setting startPosition to ${n} for start time offset ${s} found in ${i?"multivariant":"media"} playlist`),this.startPosition=n):e.live?(n=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${n}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=n=0),this.lastCurrentTime=n+r}this.nextLoadPosition=n+r}getLoadPosition(){var e;const{media:t}=this;let n=0;return null!=(e=this.hls)&&e.hasEnoughToStart&&t?n=t.currentTime:this.nextLoadPosition>=0&&(n=this.nextLoadPosition),n}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&Lg(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===Bb)||(this.state=Ob)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}const n=t.frag;if(!n||n.type!==e||!this.levels)return;var r;if(this.fragContextChanged(n))return void this.warn(`Frag load error must match current frag to retry ${n.url} > ${null==(r=this.fragCurrent)?void 0:r.url}`);const i=t.details===jm.FRAG_GAP;i&&this.fragmentTracker.fragBuffered(n,!0);const s=t.errorAction,{action:a,flags:o,retryCount:l=0,retryConfig:u}=s||{},c=!!s&&!!u,d=c&&a===ty.RetryRequest,h=c&&!s.resolved&&o===ny.MoveAllAlternatesMatchingHost;if(!d&&h&&Lg(n)&&!n.endList)this.resetFragmentErrors(e),this.treatAsGap(n),s.resolved=!0;else if((d||h)&&l<u.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const r=Zv(u,l);this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${t.details}, retrying loading ${l+1}/${u.maxNumRetry} in ${r}ms`),s.resolved=!0,this.retryDate=self.performance.now()+r,this.state=Bb}else if(u&&s){if(this.resetFragmentErrors(e),!(l<u.maxNumRetry))return void this.warn(`${t.details} reached or exceeded max retry (${l})`);i||a===ty.RemoveAlternatePermanently||(s.resolved=!0)}else this.state=a===ty.SendAlternateToPenaltyBox?jb:$b;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===zb||this.state===Gb){const t=e.frag,n=e.parent,r=this.getFwdBufferInfo(this.mediaBuffer,n),i=r&&r.len>.5;i&&this.reduceMaxBufferLength(r.len,(null==t?void 0:t.duration)||10);const s=!i;return s&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${n} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(e){e===Zm.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==kb&&(this.state=Ob)}afterBufferFlushed(e,t,n){if(!e)return;const r=My.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,r,n),this.state===Hb&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==kb&&(this.state=Ob)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=e?e.details:null;null!=t&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,n,r){const i=n.details;if(!i)return void this.warn("level.details undefined");var s;if(!Object.keys(e.elementaryStreams).reduce((t,s)=>{const a=e.elementaryStreams[s];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${e.sn} ${s} duration reliably (${o})`),t||!1;const l=r?0:bb(i,e,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(qm.LEVEL_PTS_UPDATED,{details:i,level:n,drift:l,type:s,frag:e,start:a.startPTS,end:a.endPTS}),!0}return t},!1)&&(0===n.fragmentError&&this.treatAsGap(e,n),null===(null==(s=this.transmuxer)?void 0:s.error))){const t=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(t.message),this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${n.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=Gb,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(qm.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===Zm.MAIN?"level":"track"}fragInfo(e,t=!0,n){var r,i;return`${this.playlistLabel()} ${e.level} (${n?"part":"frag"}:[${(null!=(r=t&&!n?e.startPTS:(n||e).start)?r:NaN).toFixed(3)}-${(null!=(i=t&&!n?e.endPTS:(n||e).end)?i:NaN).toFixed(3)}]${n&&"main"===e.type?"INDEPENDENT="+(n.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;null==(e=this.transmuxer)||e.reset()}recoverWorkerError(e){"demuxerWorker"===e.event&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function Xb(e){return!!e.interstitialsController&&!1!==e.enableInterstitialPlayback}class Yb{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let n;return e.length?(n=1===e.length?e[0]:function(e,t){const n=new Uint8Array(t);let r=0;for(let t=0;t<e.length;t++){const i=e[t];n.set(i,r),r+=i.length}return n}(e,t),this.reset(),n):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}var Kb,Qb={exports:{}};var Zb=(Kb||(Kb=1,function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,r,s,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new i(r,s||e,a),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0===--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,s=r.length,a=new Array(s);i<s;i++)a[i]=r[i].fn;return a},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,i,s,a){var o=n?n+e:e;if(!this._events[o])return!1;var l,u,c=this._events[o],d=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),d){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,r),!0;case 4:return c.fn.call(c.context,t,r,i),!0;case 5:return c.fn.call(c.context,t,r,i,s),!0;case 6:return c.fn.call(c.context,t,r,i,s,a),!0}for(u=1,l=new Array(d-1);u<d;u++)l[u-1]=arguments[u];c.fn.apply(c.context,l)}else{var h,f=c.length;for(u=0;u<f;u++)switch(c[u].once&&this.removeListener(e,c[u].fn,void 0,!0),d){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,t);break;case 3:c[u].fn.call(c[u].context,t,r);break;case 4:c[u].fn.call(c[u].context,t,r,i);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];c[u].fn.apply(c[u].context,l)}}return!0},o.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,i){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return a(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||i&&!o.once||r&&o.context!==r||a(this,s);else{for(var l=0,u=[],c=o.length;l<c;l++)(o[l].fn!==t||i&&!o[l].once||r&&o[l].context!==r)&&u.push(o[l]);u.length?this._events[s]=1===u.length?u[0]:u:a(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(Qb)),Qb.exports),Jb=vg(Zb);const e_="1.6.7",t_={};function n_(e,t){return t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}function r_(e,t){return t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}function i_(e,t){let n=0;return n=(127&e[t])<<21,n|=(127&e[t+1])<<14,n|=(127&e[t+2])<<7,n|=127&e[t+3],n}function s_(e,t){const n=t;let r=0;for(;r_(e,t);){r+=10;r+=i_(e,t+6),n_(e,t+10)&&(r+=10),t+=r}if(r>0)return e.subarray(n,n+r)}function a_(e,t){return 255===e[t]&&240==(246&e[t+1])}function o_(e,t){return 1&e[t+1]?7:9}function l_(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function u_(e,t){return t+1<e.length&&a_(e,t)}function c_(e,t){if(u_(e,t)){const n=o_(e,t);if(t+n>=e.length)return!1;const r=l_(e,t);if(r<=n)return!1;const i=t+r;return i===e.length||u_(e,i)}return!1}function d_(e,t,n,r,i){if(!e.samplerate){const s=function(e,t,n,r){const i=t[n+2],s=i>>2&15;if(s>12){const t=new Error(`invalid ADTS sampling index:${s}`);return void e.emit(qm.ERROR,qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.FRAG_PARSING_ERROR,fatal:!0,error:t,reason:t.message})}const a=1+(i>>6&3),o=t[n+3]>>6&3|(1&i)<<2,l="mp4a.40."+a,u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][s];let c=s;5!==a&&29!==a||(c-=3);const d=[a<<3|(14&c)>>1,(1&c)<<7|o<<3];return dg.log(`manifest codec:${r}, parsed codec:${l}, channels:${o}, rate:${u} (ADTS object type:${a} sampling index:${s})`),{config:d,samplerate:u,channelCount:o,codec:l,parsedCodec:l,manifestCodec:r}}(t,n,r,i);if(!s)return;ng(e,s)}}function h_(e){return 9216e4/e}function f_(e,t,n,r,i){const s=r+i*h_(e.samplerate),a=function(e,t){const n=o_(e,t);if(t+n<=e.length){const r=l_(e,t)-n;if(r>0)return{headerLength:n,frameLength:r}}}(t,n);let o;if(a){const{frameLength:r,headerLength:i}=a,l=i+r,u=Math.max(0,n+l-t.length);u?(o=new Uint8Array(l-i),o.set(t.subarray(n+i,t.length),0)):o=t.subarray(n+i,n+l);const c={unit:o,pts:s};return u||e.samples.push(c),{sample:c,length:l,missing:u}}const l=t.length-n;o=new Uint8Array(l),o.set(t.subarray(n,t.length),0);return{sample:{unit:o,pts:s},length:l,missing:-1}}function p_(e,t){return r_(e,t)&&i_(e,t+6)+10<=e.length-t}function m_(e,t=0,n=1/0){return function(e,t,n,r){const i=function(e){return e instanceof ArrayBuffer?e:e.buffer}(e);let s=1;"BYTES_PER_ELEMENT"in r&&(s=r.BYTES_PER_ELEMENT);const a=(d=e,d&&d.buffer instanceof ArrayBuffer&&void 0!==d.byteLength&&void 0!==d.byteOffset?e.byteOffset:0),o=(a+e.byteLength)/s,l=(a+t)/s,u=Math.floor(Math.max(0,Math.min(l,o))),c=Math.floor(Math.min(u+Math.max(n,0),o));var d;return new r(i,u,c-u)}(e,t,n,Uint8Array)}function g_(e){const t={key:e.type,description:"",data:"",mimeType:null,pictureType:null};if(e.size<2)return;if(3!==e.data[0])return;const n=e.data.subarray(1).indexOf(0);if(-1===n)return;const r=pg(m_(e.data,1,n)),i=e.data[2+n],s=e.data.subarray(3+n).indexOf(0);if(-1===s)return;const a=pg(m_(e.data,3+n,s));let o;return o="--\x3e"===r?pg(m_(e.data,4+n+s)):function(e){return e instanceof ArrayBuffer?e:0==e.byteOffset&&e.byteLength==e.buffer.byteLength?e.buffer:new Uint8Array(e).buffer}(e.data.subarray(4+n+s)),t.mimeType=r,t.pictureType=i,t.description=a,t.data=o,t}function v_(e){return"PRIV"===e.type?function(e){if(e.size<2)return;const t=pg(e.data,!0),n=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:n.buffer}}(e):"W"===e.type[0]?function(e){if("WXXX"===e.type){if(e.size<2)return;let t=1;const n=pg(e.data.subarray(t),!0);t+=n.length+1;const r=pg(e.data.subarray(t));return{key:e.type,info:n,data:r}}const t=pg(e.data);return{key:e.type,info:"",data:t}}(e):"APIC"===e.type?g_(e):function(e){if(e.size<2)return;if("TXXX"===e.type){let t=1;const n=pg(e.data.subarray(t),!0);t+=n.length+1;const r=pg(e.data.subarray(t));return{key:e.type,info:n,data:r}}const t=pg(e.data.subarray(1));return{key:e.type,info:"",data:t}}(e)}function y_(e){const t=String.fromCharCode(e[0],e[1],e[2],e[3]),n=i_(e,4);return{type:t,size:n,data:e.subarray(10,10+n)}}function b_(e){let t=0;const n=[];for(;r_(e,t);){const r=i_(e,t+6);e[t+5]>>6&1&&(t+=10),t+=10;const i=t+r;for(;t+10<i;){const r=y_(e.subarray(t)),i=v_(r);i&&n.push(i),t+=r.size+10}n_(e,t)&&(t+=10)}return n}function __(e){return e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info}function x_(e){if(8===e.data.byteLength){const t=new Uint8Array(e.data),n=1&t[3];let r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,n&&(r+=47721858.84),Math.round(r)}}function S_(e){const t=b_(e);for(let e=0;e<t.length;e++){const n=t[e];if(__(n))return x_(n)}}let T_=function(e){return e.audioId3="org.id3",e.dateRange="com.apple.quicktime.HLS",e.emsg="https://aomedia.org/emsg/ID3",e.misbklv="urn:misb:KLV:bin:1910.1",e}({});function E_(e="",t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class A_{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,n,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,n){}demux(e,t){this.cachedData&&(e=Zg(this.cachedData,e),this.cachedData=null);let n,r=s_(e,0),i=r?r.length:0;const s=this._audioTrack,a=this._id3Track,o=r?S_(r):void 0,l=e.length;for((null===this.basePTS||0===this.frameIndex&&Gm(o))&&(this.basePTS=w_(o,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:T_.audioId3,duration:Number.POSITIVE_INFINITY});i<l;){if(this.canParse(e,i)){const t=this.appendFrame(s,e,i);t?(this.frameIndex++,this.lastPTS=t.sample.pts,i+=t.length,n=i):i=l}else p_(e,i)?(r=s_(e,i),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:T_.audioId3,duration:Number.POSITIVE_INFINITY}),i+=r.length,n=i):i++;if(i===l&&n!==l){const t=e.slice(n);this.cachedData?this.cachedData=Zg(this.cachedData,t):this.cachedData=t}}return{audioTrack:s,videoTrack:E_(),id3Track:a,textTrack:E_()}}demuxSampleAes(e,t,n){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:E_(),id3Track:this._id3Track,textTrack:E_()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const w_=(e,t,n)=>{if(Gm(e))return 90*e;return 9e4*t+(n?9e4*n.baseTime/n.timescale:0)};let M_=null;const R_=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],C_=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],I_=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],L_=[0,1,1,4];function P_(e,t,n,r,i){if(n+24>t.length)return;const s=N_(t,n);if(s&&n+s.frameLength<=t.length){const a=r+i*(9e4*s.samplesPerFrame/s.sampleRate),o={unit:t.subarray(n,n+s.frameLength),pts:a,dts:a};return e.config=[],e.channelCount=s.channelCount,e.samplerate=s.sampleRate,e.samples.push(o),{sample:o,length:s.frameLength,missing:0}}}function N_(e,t){const n=e[t+1]>>3&3,r=e[t+1]>>1&3,i=e[t+2]>>4&15,s=e[t+2]>>2&3;if(1!==n&&0!==i&&15!==i&&3!==s){const a=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*R_[14*(3===n?3-r:3===r?3:4)+i-1],u=C_[3*(3===n?0:2===n?1:2)+s],c=3===o?1:2,d=I_[n][r],h=L_[r],f=8*d*h,p=Math.floor(d*l/u+a)*h;if(null===M_){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);M_=e?parseInt(e[1]):0}return!!M_&&M_<=87&&2===r&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:u,channelCount:c,frameLength:p,samplesPerFrame:f}}}function D_(e,t){return!(255!==e[t]||224&~e[t+1]||!(6&e[t+1]))}function k_(e,t){return t+1<e.length&&D_(e,t)}function O_(e,t){if(t+1<e.length&&D_(e,t)){const n=4,r=N_(e,t);let i=n;null!=r&&r.frameLength&&(i=r.frameLength);const s=t+i;return s===e.length||k_(e,s)}return!1}const F_=(e,t)=>{let n=0,r=5;t+=r;const i=new Uint32Array(1),s=new Uint32Array(1),a=new Uint8Array(1);for(;r>0;){a[0]=e[t];const o=Math.min(r,8),l=8-o;s[0]=4278190080>>>24+l<<l,i[0]=(a[0]&s[0])>>l,n=n?n<<o|i[0]:i[0],t+=1,r-=o}return n};class U_ extends A_{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,n){const r=B_(e,t,n,this.basePTS,this.frameIndex);if(-1!==r){return{sample:e.samples[e.samples.length-1],length:r,missing:0}}}static probe(e){if(!e)return!1;const t=s_(e,0);if(!t)return!1;const n=t.length;return 11===e[n]&&119===e[n+1]&&void 0!==S_(t)&&F_(e,n)<16}}function B_(e,t,n,r,i){if(n+8>t.length)return-1;if(11!==t[n]||119!==t[n+1])return-1;const s=t[n+4]>>6;if(s>=3)return-1;const a=[48e3,44100,32e3][s],o=63&t[n+4],l=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*o+s];if(n+l>t.length)return-1;const u=t[n+6]>>5;let c=0;2===u?c+=2:(1&u&&1!==u&&(c+=2),4&u&&(c+=2));const d=(t[n+6]<<8|t[n+7])>>12-c&1,h=[2,1,2,3,3,4,4,5][u]+d,f=t[n+5]>>3,p=7&t[n+5],m=new Uint8Array([s<<6|f<<1|p>>2,(3&p)<<6|u<<3|d<<2|o>>4,o<<4&224]),g=r+i*(1536/a*9e4),v=t.subarray(n,n+l);return e.config=m,e.channelCount=h,e.samplerate=a,e.samples.push({unit:v,pts:g}),l}const V_=/\/emsg[-/]ID3/i;function z_(e,t){return Gm(e.presentationTime)?e.presentationTime/e.timeScale:t+e.presentationTimeDelta/e.timeScale}class G_{constructor(e,t,n){this.keyData=void 0,this.decrypter=void 0,this.keyData=n,this.decrypter=new yy(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,fy)}decryptAacSample(e,t,n){const r=e[t].unit;if(r.length<=16)return;const i=r.subarray(16,r.length-r.length%16),s=i.buffer.slice(i.byteOffset,i.byteOffset+i.length);this.decryptBuffer(s).then(i=>{const s=new Uint8Array(i);r.set(s,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,n)})}decryptAacSamples(e,t,n){for(;;t++){if(t>=e.length)return void n();if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,n),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,n=new Int8Array(t);let r=0;for(let t=32;t<e.length-16;t+=160,r+=16)n.set(e.subarray(t,t+16),r);return n}getAvcDecryptedUnit(e,t){const n=new Uint8Array(t);let r=0;for(let t=32;t<e.length-16;t+=160,r+=16)e.set(n.subarray(r,r+16),t);return e}decryptAvcSample(e,t,n,r,i){const s=rv(i.data),a=this.getAvcEncryptedData(s);this.decryptBuffer(a.buffer).then(a=>{i.data=this.getAvcDecryptedUnit(s,a),this.decrypter.isSync()||this.decryptAvcSamples(e,t,n+1,r)})}decryptAvcSamples(e,t,n,r){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,n=0){if(t>=e.length)return void r();const i=e[t].units;for(;!(n>=i.length);n++){const s=i[n];if(!(s.data.length<=48||1!==s.type&&5!==s.type||(this.decryptAvcSample(e,t,n,r,s),this.decrypter.isSync())))return}}}}class H_{constructor(){this.VideoSample=null}createVideoSample(e,t,n){return{key:e,frame:!1,pts:t,dts:n,units:[],length:0}}getLastNalUnit(e){var t;let n,r=this.VideoSample;if(r&&0!==r.units.length||(r=e[e.length-1]),null!=(t=r)&&t.units){const e=r.units;n=e[e.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const n=t.samples,r=n.length;if(!r)return void t.dropped++;{const t=n[r-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}}parseNALu(e,t,n){const r=t.byteLength;let i=e.naluState||0;const s=i,a=[];let o,l,u,c=0,d=-1,h=0;for(-1===i&&(d=0,h=this.getNALuType(t,0),i=0,c=1);c<r;)if(o=t[c++],i)if(1!==i)if(o)if(1===o){if(l=c-i-1,d>=0){const e={data:t.subarray(d,l),type:h};a.push(e)}else{const n=this.getLastNalUnit(e.samples);n&&(s&&c<=4-s&&n.state&&(n.data=n.data.subarray(0,n.data.byteLength-s)),l>0&&(n.data=Zg(n.data,t.subarray(0,l)),n.state=0))}c<r?(u=this.getNALuType(t,c),d=c,h=u,i=0):i=-1}else i=0;else i=3;else i=o?0:2;else i=o?0:1;if(d>=0&&i>=0){const e={data:t.subarray(d,r),type:h,state:i};a.push(e)}if(0===a.length){const n=this.getLastNalUnit(e.samples);n&&(n.data=Zg(n.data,t))}return e.naluState=i,a}}class $_{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,n=e.byteLength-t,r=new Uint8Array(4),i=Math.min(4,t);if(0===i)throw new Error("no bytes available");r.set(e.subarray(n,n+i)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*i,this.bytesAvailable-=i}skipBits(e){let t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const n=this.word>>>32-t;if(e>32&&dg.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return t=e-t,t>0&&this.bitsAvailable?n<<t|this.readBits(t):n}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class W_ extends H_{parsePES(e,t,n,r){const i=this.parseNALu(e,n.data,r);let s,a=this.VideoSample,o=!1;n.data=null,a&&i.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts)),i.forEach(r=>{var i,l;switch(r.type){case 1:{let t=!1;s=!0;const i=r.data;if(o&&i.length>4){const e=this.readSliceType(i);2!==e&&4!==e&&7!==e&&9!==e||(t=!0)}var u;if(t)null!=(u=a)&&u.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null);a||(a=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),a.frame=!0,a.key=t;break}case 5:s=!0,null!=(i=a)&&i.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),a.key=!0,a.frame=!0;break;case 6:s=!0,nv(r.data,1,n.pts,t.samples);break;case 7:{var c,d;s=!0,o=!0;const t=r.data,n=this.readSPS(t);if(!e.sps||e.width!==n.width||e.height!==n.height||(null==(c=e.pixelRatio)?void 0:c[0])!==n.pixelRatio[0]||(null==(d=e.pixelRatio)?void 0:d[1])!==n.pixelRatio[1]){e.width=n.width,e.height=n.height,e.pixelRatio=n.pixelRatio,e.sps=[t];const r=t.subarray(1,4);let i="avc1.";for(let e=0;e<3;e++){let t=r[e].toString(16);t.length<2&&(t="0"+t),i+=t}e.codec=i}break}case 8:s=!0,e.pps=[r.data];break;case 9:s=!0,e.audFound=!0,null!=(l=a)&&l.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts));break;case 12:s=!0;break;default:s=!1}if(a&&s){a.units.push(r)}}),r&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}getNALuType(e,t){return 31&e[t]}readSliceType(e){const t=new $_(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let n,r=8,i=8;for(let s=0;s<e;s++)0!==i&&(n=t.readEG(),i=(r+n+256)%256),r=0===i?r:i}readSPS(e){const t=new $_(e);let n,r,i,s=0,a=0,o=0,l=0;const u=t.readUByte.bind(t),c=t.readBits.bind(t),d=t.readUEG.bind(t),h=t.readBoolean.bind(t),f=t.skipBits.bind(t),p=t.skipEG.bind(t),m=t.skipUEG.bind(t),g=this.skipScalingList.bind(this);u();const v=u();if(c(5),f(3),u(),m(),100===v||110===v||122===v||244===v||44===v||83===v||86===v||118===v||128===v){const e=d();if(3===e&&f(1),m(),m(),f(1),h())for(r=3!==e?8:12,i=0;i<r;i++)h()&&g(i<6?16:64,t)}m();const y=d();if(0===y)d();else if(1===y)for(f(1),p(),p(),n=d(),i=0;i<n;i++)p();m(),f(1);const b=d(),_=d(),x=c(1);0===x&&f(1),f(1),h()&&(s=d(),a=d(),o=d(),l=d());let S=[1,1];if(h()&&h()){switch(u()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:S=[u()<<8|u(),u()<<8|u()]}}return{width:Math.ceil(16*(b+1)-2*s-2*a),height:(2-x)*(_+1)*16-(x?2:4)*(o+l),pixelRatio:S}}}class j_ extends H_{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,n,r){const i=this.parseNALu(e,n.data,r);let s,a=this.VideoSample,o=!1;n.data=null,a&&i.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts)),i.forEach(r=>{var i,l;switch(r.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:a||(a=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts)),a.frame=!0,s=!0;break;case 16:case 17:case 18:case 21:var u;if(s=!0,o)null!=(u=a)&&u.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null);a||(a=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),a.key=!0,a.frame=!0;break;case 19:case 20:s=!0,null!=(i=a)&&i.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),a.key=!0,a.frame=!0;break;case 39:s=!0,nv(r.data,2,n.pts,t.samples);break;case 32:s=!0,e.vps||("object"!=typeof e.params&&(e.params={}),e.params=ng(e.params,this.readVPS(r.data)),this.initVPS=r.data),e.vps=[r.data];break;case 33:if(s=!0,o=!0,void 0===e.vps||e.vps[0]===this.initVPS||void 0===e.sps||this.matchSPS(e.sps[0],r.data)||(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const t=this.readSPS(r.data);e.width=t.width,e.height=t.height,e.pixelRatio=t.pixelRatio,e.codec=t.codecString,e.sps=[],"object"!=typeof e.params&&(e.params={});for(const n in t.params)e.params[n]=t.params[n]}this.pushParameterSet(e.sps,r.data,e.vps),a||(a=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),a.key=!0;break;case 34:if(s=!0,"object"==typeof e.params){if(!e.pps){e.pps=[];const t=this.readPPS(r.data);for(const n in t)e.params[n]=t[n]}this.pushParameterSet(e.pps,r.data,e.vps)}break;case 35:s=!0,e.audFound=!0,null!=(l=a)&&l.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts));break;default:s=!1}if(a&&s){a.units.push(r)}}),r&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}pushParameterSet(e,t,n){(n&&n[0]===this.initVPS||!n&&!e.length)&&e.push(t)}getNALuType(e,t){return(126&e[t])>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let n=0;for(let r=0;r<e.byteLength;r++)r>=2&&3===e[r]&&0===e[r-1]&&0===e[r-2]||(t[n]=e[r],n++);return new Uint8Array(t.buffer,0,n)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new $_(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);return{numTemporalLayers:t.readBits(3)+1,temporalIdNested:t.readBoolean()}}readSPS(e){const t=new $_(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const n=t.readBits(3);t.readBoolean();const r=t.readBits(2),i=t.readBoolean(),s=t.readBits(5),a=t.readUByte(),o=t.readUByte(),l=t.readUByte(),u=t.readUByte(),c=t.readUByte(),d=t.readUByte(),h=t.readUByte(),f=t.readUByte(),p=t.readUByte(),m=t.readUByte(),g=t.readUByte(),v=[],y=[];for(let e=0;e<n;e++)v.push(t.readBoolean()),y.push(t.readBoolean());if(n>0)for(let e=n;e<8;e++)t.readBits(2);for(let e=0;e<n;e++)v[e]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),y[e]&&t.readUByte();t.readUEG();const b=t.readUEG();3==b&&t.skipBits(1);const _=t.readUEG(),x=t.readUEG(),S=t.readBoolean();let T=0,E=0,A=0,w=0;S&&(T+=t.readUEG(),E+=t.readUEG(),A+=t.readUEG(),w+=t.readUEG());const M=t.readUEG(),R=t.readUEG(),C=t.readUEG();for(let e=t.readBoolean()?0:n;e<=n;e++)t.skipUEG(),t.skipUEG(),t.skipUEG();t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.readBoolean()){if(t.readBoolean())for(let e=0;e<4;e++)for(let n=0;n<(3===e?2:6);n++){if(t.readBoolean()){const n=Math.min(64,1<<4+(e<<1));e>1&&t.readEG();for(let e=0;e<n;e++)t.readEG()}else t.readUEG()}}t.readBoolean(),t.readBoolean();t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const I=t.readUEG();let L=0;for(let e=0;e<I;e++){let n=!1;if(0!==e&&(n=t.readBoolean()),n){e===I&&t.readUEG(),t.readBoolean(),t.readUEG();let n=0;for(let e=0;e<=L;e++){const e=t.readBoolean();let r=!1;e||(r=t.readBoolean()),(e||r)&&n++}L=n}else{const e=t.readUEG(),n=t.readUEG();L=e+n;for(let n=0;n<e;n++)t.readUEG(),t.readBoolean();for(let e=0;e<n;e++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const e=t.readUEG();for(let n=0;n<e;n++){for(let e=0;e<C+4;e++)t.readBits(1);t.readBits(1)}}let P=0,N=1,D=1,k=!0,O=1,F=0;t.readBoolean(),t.readBoolean();let U=!1;if(t.readBoolean()){if(t.readBoolean()){const e=t.readUByte();e>0&&e<16?(N=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][e-1],D=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][e-1]):255===e&&(N=t.readBits(16),D=t.readBits(16))}t.readBoolean()&&t.readBoolean();if(t.readBoolean()){t.readBits(3),t.readBoolean();t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())}t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),U=t.readBoolean(),U&&(T+=t.readUEG(),E+=t.readUEG(),A+=t.readUEG(),w+=t.readUEG());if(t.readBoolean()){O=t.readBits(32),F=t.readBits(32);t.readBoolean()&&t.readUEG();if(t.readBoolean()){const e=t.readBoolean(),r=t.readBoolean();let i=!1;(e||r)&&(i=t.readBoolean(),i&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),i&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let s=0;s<=n;s++){k=t.readBoolean();let n=!1;k||t.readBoolean()?t.readEG():n=t.readBoolean();const s=n?1:t.readUEG()+1;if(e)for(let e=0;e<s;e++)t.readUEG(),t.readUEG(),i&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(r)for(let e=0;e<s;e++)t.readUEG(),t.readUEG(),i&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),P=t.readUEG())}let B=_,V=x;if(S||U){let e=1,t=1;1===b?e=t=2:2==b&&(e=2),B=_-e*E-e*T,V=x-t*w-t*A}const z=r?["A","B","C"][r]:"",G=a<<24|o<<16|l<<8|u;let H=0;for(let e=0;e<32;e++)H=(H|(G>>e&1)<<31-e)>>>0;let $=H.toString(16);1===s&&"2"===$&&($="6");return{codecString:`hvc1.${z}${s}.${$}.${i?"H":"L"}${g}.B0`,params:{general_tier_flag:i,general_profile_idc:s,general_profile_space:r,general_profile_compatibility_flags:[a,o,l,u],general_constraint_indicator_flags:[c,d,h,f,p,m],general_level_idc:g,bit_depth:M+8,bit_depth_luma_minus8:M,bit_depth_chroma_minus8:R,min_spatial_segmentation_idc:P,chroma_format_idc:b,frame_rate:{fixed:k,fps:F/O}},width:B,height:V,pixelRatio:[N,D]}}readPPS(e){const t=new $_(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2);t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const n=t.readBoolean(),r=t.readBoolean();let i=1;return r&&n?i=0:r?i=3:n&&(i=2),{parallelismType:i}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const q_=188;class X_{constructor(e,t,n,r){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=n,this.logger=r,this.videoParser=null}static probe(e,t){const n=X_.syncOffset(e);return n>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${n}`),-1!==n}static syncOffset(e){const t=e.length;let n=Math.min(940,t-q_)+1,r=0;for(;r<n;){let i=!1,s=-1,a=0;for(let o=r;o<t;o+=q_){if(71!==e[o]||t-o!==q_&&71!==e[o+q_]){if(a)return-1;break}if(a++,-1===s&&(s=o,0!==s&&(n=Math.min(s+18612,e.length-q_)+1)),i||(i=0===Y_(e,o)),i&&a>1&&(0===s&&a>2||o+q_>n))return s}r++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:Fg[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,n,r){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=X_.createTrack("video"),this._videoTrack.duration=r,this._audioTrack=X_.createTrack("audio",r),this._id3Track=X_.createTrack("id3"),this._txtTrack=X_.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=n}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:n}=this;e&&(e.pesData=null),t&&(t.pesData=null),n&&(n.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,n=!1,r=!1){let i;n||(this.sampleAes=null);const s=this._videoTrack,a=this._audioTrack,o=this._id3Track,l=this._txtTrack;let u=s.pid,c=s.pesData,d=a.pid,h=o.pid,f=a.pesData,p=o.pesData,m=null,g=this.pmtParsed,v=this._pmtId,y=e.length;if(this.remainderData&&(y=(e=Zg(this.remainderData,e)).length,this.remainderData=null),y<q_&&!r)return this.remainderData=e,{audioTrack:a,videoTrack:s,id3Track:o,textTrack:l};const b=Math.max(0,X_.syncOffset(e));y-=(y-b)%q_,y<e.byteLength&&!r&&(this.remainderData=new Uint8Array(e.buffer,y,e.buffer.byteLength-y));let _=0;for(let t=b;t<y;t+=q_)if(71===e[t]){const r=!!(64&e[t+1]),y=Y_(e,t);let _;if((48&e[t+3])>>4>1){if(_=t+5+e[t+4],_===t+q_)continue}else _=t+4;switch(y){case u:if(r){if(c&&(i=ex(c,this.logger))){if(null===this.videoParser)switch(s.segmentCodec){case"avc":this.videoParser=new W_;break;case"hevc":this.videoParser=new j_}null!==this.videoParser&&this.videoParser.parsePES(s,l,i,!1)}c={data:[],size:0}}c&&(c.data.push(e.subarray(_,t+q_)),c.size+=t+q_-_);break;case d:if(r){if(f&&(i=ex(f,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,i);break;case"mp3":this.parseMPEGPES(a,i);break;case"ac3":this.parseAC3PES(a,i)}f={data:[],size:0}}f&&(f.data.push(e.subarray(_,t+q_)),f.size+=t+q_-_);break;case h:r&&(p&&(i=ex(p,this.logger))&&this.parseID3PES(o,i),p={data:[],size:0}),p&&(p.data.push(e.subarray(_,t+q_)),p.size+=t+q_-_);break;case 0:r&&(_+=e[_]+1),v=this._pmtId=K_(e,_);break;case v:{r&&(_+=e[_]+1);const i=Q_(e,_,this.typeSupported,n,this.observer,this.logger);u=i.videoPid,u>0&&(s.pid=u,s.segmentCodec=i.segmentVideoCodec),d=i.audioPid,d>0&&(a.pid=d,a.segmentCodec=i.segmentAudioCodec),h=i.id3Pid,h>0&&(o.pid=h),null===m||g||(this.logger.warn(`MPEG-TS PMT found at ${t} after unknown PID '${m}'. Backtracking to sync byte @${b} to parse all TS packets.`),m=null,t=b-188),g=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=y}}else _++;_>0&&Z_(this.observer,new Error(`Found ${_} TS packet/s that do not start with 0x47`),void 0,this.logger),s.pesData=c,a.pesData=f,o.pesData=p;const x={audioTrack:a,videoTrack:s,id3Track:o,textTrack:l};return r&&this.extractRemainingSamples(x),x}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:n,id3Track:r,textTrack:i}=e,s=n.pesData,a=t.pesData,o=r.pesData;let l;if(s&&(l=ex(s,this.logger))){if(null===this.videoParser)switch(n.segmentCodec){case"avc":this.videoParser=new W_;break;case"hevc":this.videoParser=new j_}null!==this.videoParser&&(this.videoParser.parsePES(n,i,l,!0),n.pesData=null)}else n.pesData=s;if(a&&(l=ex(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l)}t.pesData=null}else null!=a&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;o&&(l=ex(o,this.logger))?(this.parseID3PES(r,l),r.pesData=null):r.pesData=o}demuxSampleAes(e,t,n){const r=this.demux(e,n,!0,!this.config.progressive),i=this.sampleAes=new G_(this.observer,this.config,t);return this.decrypt(r,i)}decrypt(e,t){return new Promise(n=>{const{audioTrack:r,videoTrack:i}=e;r.samples&&"aac"===r.segmentCodec?t.decryptAacSamples(r.samples,0,()=>{i.samples?t.decryptAvcSamples(i.samples,0,0,()=>{n(e)}):n(e)}):i.samples&&t.decryptAvcSamples(i.samples,0,0,()=>{n(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let n=0;const r=this.aacOverFlow;let i,s,a,o=t.data;if(r){this.aacOverFlow=null;const t=r.missing,i=r.sample.unit.byteLength;if(-1===t)o=Zg(r.sample.unit,o);else{const s=i-t;r.sample.unit.set(o.subarray(0,t),s),e.samples.push(r.sample),n=r.missing}}for(i=n,s=o.length;i<s-1&&!u_(o,i);i++);if(i!==n){let e;const t=i<s-1;if(e=t?`AAC PES did not start with ADTS header,offset:${i}`:"No ADTS header found in AAC PES",Z_(this.observer,new Error(e),t,this.logger),!t)return}if(d_(e,this.observer,o,i,this.audioCodec),void 0!==t.pts)a=t.pts;else{if(!r)return void this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");{const t=h_(e.samplerate);a=r.sample.pts+t}}let l,u=0;for(;i<s;){if(l=f_(e,o,i,a,u),i+=l.length,l.missing){this.aacOverFlow=l;break}for(u++;i<s-1&&!u_(o,i);i++);}}parseMPEGPES(e,t){const n=t.data,r=n.length;let i=0,s=0;const a=t.pts;if(void 0!==a)for(;s<r;)if(k_(n,s)){const t=P_(e,n,s,a,i);if(!t)break;s+=t.length,i++}else s++;else this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(e,t){{const n=t.data,r=t.pts;if(void 0===r)return void this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");const i=n.length;let s,a=0,o=0;for(;o<i&&(s=B_(e,n,o,r,a++))>0;)o+=s}}parseID3PES(e,t){if(void 0===t.pts)return void this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");const n=ng({},t,{type:this._videoTrack?T_.emsg:T_.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(n)}}function Y_(e,t){return((31&e[t+1])<<8)+e[t+2]}function K_(e,t){return(31&e[t+10])<<8|e[t+11]}function Q_(e,t,n,r,i,s){const a={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},o=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<o;){const o=Y_(e,t),l=(15&e[t+3])<<8|e[t+4];switch(e[t]){case 207:if(!r){J_("ADTS AAC",s);break}case 15:-1===a.audioPid&&(a.audioPid=o);break;case 21:-1===a.id3Pid&&(a.id3Pid=o);break;case 219:if(!r){J_("H.264",s);break}case 27:-1===a.videoPid&&(a.videoPid=o);break;case 3:case 4:n.mpeg||n.mp3?-1===a.audioPid&&(a.audioPid=o,a.segmentAudioCodec="mp3"):s.log("MPEG audio found, not supported in this browser");break;case 193:if(!r){J_("AC-3",s);break}case 129:n.ac3?-1===a.audioPid&&(a.audioPid=o,a.segmentAudioCodec="ac3"):s.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===a.audioPid&&l>0){let r=t+5,i=l;for(;i>2;){if(106===e[r])!0!==n.ac3?s.log("AC-3 audio found, not supported in this browser for now"):(a.audioPid=o,a.segmentAudioCodec="ac3");const t=e[r+1]+2;r+=t,i-=t}}break;case 194:case 135:return Z_(i,new Error("Unsupported EC-3 in M2TS found"),void 0,s),a;case 36:-1===a.videoPid&&(a.videoPid=o,a.segmentVideoCodec="hevc",s.log("HEVC in M2TS found"))}t+=l+5}return a}function Z_(e,t,n,r){r.warn(`parsing error: ${t.message}`),e.emit(qm.ERROR,qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.FRAG_PARSING_ERROR,fatal:!1,levelRetry:n,error:t,reason:t.message})}function J_(e,t){t.log(`${e} with AES-128-CBC encryption found in unencrypted stream`)}function ex(e,t){let n,r,i,s,a,o=0;const l=e.data;if(!e||0===e.size)return null;for(;l[0].length<19&&l.length>1;)l[0]=Zg(l[0],l[1]),l.splice(1,1);n=l[0];if(1===(n[0]<<16)+(n[1]<<8)+n[2]){if(r=(n[4]<<8)+n[5],r&&r>e.size-6)return null;const u=n[7];192&u&&(s=536870912*(14&n[9])+4194304*(255&n[10])+16384*(254&n[11])+128*(255&n[12])+(254&n[13])/2,64&u?(a=536870912*(14&n[14])+4194304*(255&n[15])+16384*(254&n[16])+128*(255&n[17])+(254&n[18])/2,s-a>54e5&&(t.warn(`${Math.round((s-a)/9e4)}s delta between PTS and DTS, align them`),s=a)):a=s),i=n[8];let c=i+9;if(e.size<=c)return null;e.size-=c;const d=new Uint8Array(e.size);for(let e=0,t=l.length;e<t;e++){n=l[e];let t=n.byteLength;if(c){if(c>t){c-=t;continue}n=n.subarray(c),t-=c,c=0}d.set(n,o),o+=t}return r&&(r-=i+3),{data:d,pts:s,dts:a,len:r}}return null}class tx{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const nx=Math.pow(2,32)-1;class rx{static init(){let e;for(e in rx.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},rx.types)rx.types.hasOwnProperty(e)&&(rx.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);rx.HDLR_TYPES={video:t,audio:n};const r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),i=new Uint8Array([0,0,0,0,0,0,0,0]);rx.STTS=rx.STSC=rx.STCO=i,rx.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),rx.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),rx.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),rx.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const s=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);rx.FTYP=rx.box(rx.types.ftyp,s,o,s,a),rx.DINF=rx.box(rx.types.dinf,rx.box(rx.types.dref,r))}static box(e,...t){let n=8,r=t.length;const i=r;for(;r--;)n+=t[r].byteLength;const s=new Uint8Array(n);for(s[0]=n>>24&255,s[1]=n>>16&255,s[2]=n>>8&255,s[3]=255&n,s.set(e,4),r=0,n=8;r<i;r++)s.set(t[r],n),n+=t[r].byteLength;return s}static hdlr(e){return rx.box(rx.types.hdlr,rx.HDLR_TYPES[e])}static mdat(e){return rx.box(rx.types.mdat,e)}static mdhd(e,t){t*=e;const n=Math.floor(t/(nx+1)),r=Math.floor(t%(nx+1));return rx.box(rx.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,n>>24,n>>16&255,n>>8&255,255&n,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(e){return rx.box(rx.types.mdia,rx.mdhd(e.timescale||0,e.duration||0),rx.hdlr(e.type),rx.minf(e))}static mfhd(e){return rx.box(rx.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?rx.box(rx.types.minf,rx.box(rx.types.smhd,rx.SMHD),rx.DINF,rx.stbl(e)):rx.box(rx.types.minf,rx.box(rx.types.vmhd,rx.VMHD),rx.DINF,rx.stbl(e))}static moof(e,t,n){return rx.box(rx.types.moof,rx.mfhd(e),rx.traf(n,t))}static moov(e){let t=e.length;const n=[];for(;t--;)n[t]=rx.trak(e[t]);return rx.box.apply(null,[rx.types.moov,rx.mvhd(e[0].timescale||0,e[0].duration||0)].concat(n).concat(rx.mvex(e)))}static mvex(e){let t=e.length;const n=[];for(;t--;)n[t]=rx.trex(e[t]);return rx.box.apply(null,[rx.types.mvex,...n])}static mvhd(e,t){t*=e;const n=Math.floor(t/(nx+1)),r=Math.floor(t%(nx+1)),i=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,n>>24,n>>16&255,n>>8&255,255&n,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return rx.box(rx.types.mvhd,i)}static sdtp(e){const t=e.samples||[],n=new Uint8Array(4+t.length);let r,i;for(r=0;r<t.length;r++)i=t[r].flags,n[r+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy;return rx.box(rx.types.sdtp,n)}static stbl(e){return rx.box(rx.types.stbl,rx.stsd(e),rx.box(rx.types.stts,rx.STTS),rx.box(rx.types.stsc,rx.STSC),rx.box(rx.types.stsz,rx.STSZ),rx.box(rx.types.stco,rx.STCO))}static avc1(e){let t,n,r,i=[],s=[];for(t=0;t<e.sps.length;t++)n=e.sps[t],r=n.byteLength,i.push(r>>>8&255),i.push(255&r),i=i.concat(Array.prototype.slice.call(n));for(t=0;t<e.pps.length;t++)n=e.pps[t],r=n.byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(n));const a=rx.box(rx.types.avcC,new Uint8Array([1,i[3],i[4],i[5],255,224|e.sps.length].concat(i).concat([e.pps.length]).concat(s))),o=e.width,l=e.height,u=e.pixelRatio[0],c=e.pixelRatio[1];return rx.box(rx.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,rx.box(rx.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),rx.box(rx.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,255&u,c>>24,c>>16&255,c>>8&255,255&c])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static mp4a(e){return rx.box(rx.types.mp4a,rx.audioStsd(e),rx.box(rx.types.esds,rx.esds(e)))}static mp3(e){return rx.box(rx.types[".mp3"],rx.audioStsd(e))}static ac3(e){return rx.box(rx.types["ac-3"],rx.audioStsd(e),rx.box(rx.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if("audio"===e.type){if("aac"===t)return rx.box(rx.types.stsd,rx.STSD,rx.mp4a(e));if("ac3"===t&&e.config)return rx.box(rx.types.stsd,rx.STSD,rx.ac3(e));if("mp3"===t&&"mp3"===e.codec)return rx.box(rx.types.stsd,rx.STSD,rx.mp3(e))}else{if(!e.pps||!e.sps)throw new Error("video track missing pps or sps");if("avc"===t)return rx.box(rx.types.stsd,rx.STSD,rx.avc1(e));if("hevc"===t&&e.vps)return rx.box(rx.types.stsd,rx.STSD,rx.hvc1(e))}throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,n=(e.duration||0)*(e.timescale||0),r=e.width||0,i=e.height||0,s=Math.floor(n/(nx+1)),a=Math.floor(n%(nx+1));return rx.box(rx.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,i>>8&255,255&i,0,0]))}static traf(e,t){const n=rx.sdtp(e),r=e.id,i=Math.floor(t/(nx+1)),s=Math.floor(t%(nx+1));return rx.box(rx.types.traf,rx.box(rx.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),rx.box(rx.types.tfdt,new Uint8Array([1,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,s>>24,s>>16&255,s>>8&255,255&s])),rx.trun(e,n.length+16+20+8+16+8+8),n)}static trak(e){return e.duration=e.duration||4294967295,rx.box(rx.types.trak,rx.tkhd(e),rx.mdia(e))}static trex(e){const t=e.id;return rx.box(rx.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const n=e.samples||[],r=n.length,i=12+16*r,s=new Uint8Array(i);let a,o,l,u,c,d;for(t+=8+i,s.set(["video"===e.type?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<r;a++)o=n[a],l=o.duration,u=o.size,c=o.flags,d=o.cts,s.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,u>>>24&255,u>>>16&255,u>>>8&255,255&u,c.isLeading<<2|c.dependsOn,c.isDependedOn<<6|c.hasRedundancy<<4|c.paddingValue<<1|c.isNonSync,61440&c.degradPrio,15&c.degradPrio,d>>>24&255,d>>>16&255,d>>>8&255,255&d],12+16*a);return rx.box(rx.types.trun,s)}static initSegment(e){rx.types||rx.init();const t=rx.moov(e);return Zg(rx.FTYP,t)}static hvc1(e){const t=e.params,n=[e.vps,e.sps,e.pps],r=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),3|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),n.length]);let i=r.length;for(let e=0;e<n.length;e+=1){i+=3;for(let t=0;t<n[e].length;t+=1)i+=2+n[e][t].length}const s=new Uint8Array(i);s.set(r,0),i=r.length;const a=n.length-1;for(let e=0;e<n.length;e+=1){s.set(new Uint8Array([32+e|(e===a?128:0),0,n[e].length]),i),i+=3;for(let t=0;t<n[e].length;t+=1)s.set(new Uint8Array([n[e][t].length>>8,255&n[e][t].length]),i),i+=2,s.set(n[e][t],i),i+=n[e][t].length}const o=rx.box(rx.types.hvcC,s),l=e.width,u=e.height,c=e.pixelRatio[0],d=e.pixelRatio[1];return rx.box(rx.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,u>>8&255,255&u,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,rx.box(rx.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),rx.box(rx.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,d>>24,d>>16&255,d>>8&255,255&d])))}}rx.types=void 0,rx.HDLR_TYPES=void 0,rx.STTS=void 0,rx.STSC=void 0,rx.STCO=void 0,rx.STSZ=void 0,rx.VMHD=void 0,rx.SMHD=void 0,rx.STSD=void 0,rx.FTYP=void 0,rx.DINF=void 0;function ix(e,t,n=1,r=!1){const i=e*t*n;return r?Math.round(i):i}function sx(e,t=!1){return ix(e,1e3,1/9e4,t)}let ax,ox=null,lx=null;function ux(e,t,n,r){return{duration:t,size:n,cts:r,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}class cx extends sg{constructor(e,t,n,r){if(super("mp4-remuxer",r),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=n,this.ISGenerated=!1,null===ox){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);ox=e?parseInt(e[1]):0}if(null===lx){const e=navigator.userAgent.match(/Safari\/(\d+)/i);lx=e?parseInt(e[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.log("initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const n=e[0].pts,r=e.reduce((e,r)=>{let i=r.pts,s=i-e;return s<-4294967296&&(t=!0,i=dx(i,n),s=i-e),s>0?e:i},n);return t&&this.debug("PTS rollover detected"),r}remux(e,t,n,r,i,s,a,o){let l,u,c,d,h,f,p=i,m=i;const g=e.pid>-1,v=t.pid>-1,y=t.samples.length,b=e.samples.length>0,_=a&&y>0||y>1;if((!g||b)&&(!v||_)||this.ISGenerated||a){if(this.ISGenerated){var x,S,T,E;const e=this.videoTrackConfig;(e&&(t.width!==e.width||t.height!==e.height||(null==(x=t.pixelRatio)?void 0:x[0])!==(null==(S=e.pixelRatio)?void 0:S[0])||(null==(T=t.pixelRatio)?void 0:T[1])!==(null==(E=e.pixelRatio)?void 0:E[1]))||!e&&_||null===this.nextAudioTs&&b)&&this.resetInitSegment()}this.ISGenerated||(c=this.generateIS(e,t,i,s));const n=this.isVideoContiguous;let r,a=-1;if(_&&(a=function(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!n&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,a>0){this.warn(`Dropped ${a} out of ${y} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(a),t.dropped+=a,m+=(t.samples[0].pts-e)/t.inputTimeScale,r=m}else-1===a&&(this.warn(`No keyframe found out of ${y} video samples`),f=!1);if(this.ISGenerated){if(b&&_){const n=this.getVideoStartPts(t.samples),r=(dx(e.samples[0].pts,n)-n)/t.inputTimeScale;p+=Math.max(0,r),m+=Math.max(0,-r)}if(b){if(e.samplerate||(this.warn("regenerate InitSegment as audio detected"),c=this.generateIS(e,t,i,s)),u=this.remuxAudio(e,p,this.isAudioContiguous,s,v||_||o===Zm.AUDIO?m:void 0),_){const r=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),c=this.generateIS(e,t,i,s)),l=this.remuxVideo(t,m,n,r)}}else _&&(l=this.remuxVideo(t,m,n,0));l&&(l.firstKeyFrame=a,l.independent=-1!==a,l.firstKeyFramePTS=r)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(n.samples.length&&(h=hx(n,i,this._initPTS,this._initDTS)),r.samples.length&&(d=fx(r,i,this._initPTS))),{audio:u,video:l,initSegment:c,independent:f,text:d,id3:h}}generateIS(e,t,n,r){const i=e.samples,s=t.samples,a=this.typeSupported,o={},l=this._initPTS;let u,c,d,h,f=!l||r,p="audio/mp4";if(f&&(u=c=1/0),e.config&&i.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(p="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3"}o.audio={id:"audio",container:p,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&a.mpeg?new Uint8Array(0):rx.initSegment([e]),metadata:{channelCount:e.channelCount}},f&&(h=e.id,d=e.inputTimeScale,l&&d===l.timescale?f=!1:u=c=i[0].pts-Math.round(d*n))}if(t.sps&&t.pps&&s.length){if(t.timescale=t.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:rx.initSegment([t]),metadata:{width:t.width,height:t.height}},f)if(h=t.id,d=t.inputTimeScale,l&&d===l.timescale)f=!1;else{const e=this.getVideoStartPts(s),t=Math.round(d*n);c=Math.min(c,dx(s[0].dts,e)-t),u=Math.min(u,e-t)}this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(o).length)return this.ISGenerated=!0,f?(this._initPTS={baseTime:u,timescale:d},this._initDTS={baseTime:c,timescale:d}):u=d=void 0,{tracks:o,initPTS:u,timescale:d,trackId:h}}remuxVideo(e,t,n,r){const i=e.inputTimeScale,s=e.samples,a=[],o=s.length,l=this._initPTS,u=l.baseTime*i/l.timescale;let c,d,h=this.nextVideoTs,f=8,p=this.videoSampleDuration,m=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,v=!1;if(!n||null===h){const e=u+t*i,r=s[0].pts-dx(s[0].dts,s[0].pts);ox&&null!==h&&Math.abs(e-r-(h+u))<15e3?n=!0:h=e-r-u}const y=h+u;for(let e=0;e<o;e++){const t=s[e];t.pts=dx(t.pts,y),t.dts=dx(t.dts,y),t.dts<s[e>0?e-1:e].dts&&(v=!0)}v&&s.sort(function(e,t){const n=e.dts-t.dts,r=e.pts-t.pts;return n||r}),c=s[0].dts,d=s[s.length-1].dts;const b=d-c,_=b?Math.round(b/(o-1)):p||e.inputTimeScale/30;if(n){const n=c-y,r=n>_,i=n<-1;if((r||i)&&(r?this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${sx(n,!0)} ms (${n}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${sx(-n,!0)} ms (${n}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!i||y>=s[0].pts||ox)){c=y;const e=s[0].pts-n;if(r)s[0].dts=c,s[0].pts=e;else{let t=!0;for(let r=0;r<s.length&&!(s[r].dts>e&&t);r++){const e=s[r].pts;if(s[r].dts-=n,s[r].pts-=n,r<s.length-1){const n=s[r+1].pts;t=n<=s[r].pts==n<=e}}}this.log(`Video: Initial PTS/DTS adjusted: ${sx(e,!0)}/${sx(c,!0)}, delta: ${sx(n,!0)} ms`)}}c=Math.max(0,c);let x=0,S=0,T=c;for(let e=0;e<o;e++){const t=s[e],n=t.units,r=n.length;let i=0;for(let e=0;e<r;e++)i+=n[e].data.length;S+=i,x+=r,t.length=i,t.dts<T?(t.dts=T,T+=_/4|0||1):T=t.dts,m=Math.min(t.pts,m),g=Math.max(t.pts,g)}d=s[o-1].dts;const E=S+4*x+8;let A;try{A=new Uint8Array(E)}catch(e){return void this.observer.emit(qm.ERROR,qm.ERROR,{type:Wm.MUX_ERROR,details:jm.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:E,reason:`fail allocating video mdat ${E}`})}const w=new DataView(A.buffer);w.setUint32(0,E),A.set(rx.types.mdat,4);let M=!1,R=Number.POSITIVE_INFINITY,C=Number.POSITIVE_INFINITY,I=Number.NEGATIVE_INFINITY,L=Number.NEGATIVE_INFINITY;for(let e=0;e<o;e++){const t=s[e],n=t.units;let l,c=0;for(let e=0,t=n.length;e<t;e++){const t=n[e],r=t.data,i=t.data.byteLength;w.setUint32(f,i),f+=4,A.set(r,f),f+=i,c+=4+i}if(e<o-1)p=s[e+1].dts-t.dts,l=s[e+1].pts-t.pts;else{const n=this.config,a=e>0?t.dts-s[e-1].dts:_;if(l=e>0?t.pts-s[e-1].pts:_,n.stretchShortVideoTrack&&null!==this.nextAudioTs){const e=Math.floor(n.maxBufferHole*i),s=(r?m+r*i:this.nextAudioTs+u)-t.pts;s>e?(p=s-a,p<0?p=a:M=!0,this.log(`It is approximately ${s/90} ms to the next segment; using duration ${p/90} ms for the last video frame.`)):p=a}else p=a}const d=Math.round(t.pts-t.dts);R=Math.min(R,p),I=Math.max(I,p),C=Math.min(C,l),L=Math.max(L,l),a.push(ux(t.key,p,c,d))}if(a.length)if(ox){if(ox<70){const e=a[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(lx&&L-C<I-R&&_/I<.025&&0===a[0].cts){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let e=c;for(let t=0,n=a.length;t<n;t++){const r=e+a[t].duration,i=e+a[t].cts;if(t<n-1){const e=r+a[t+1].cts;a[t].duration=e-i}else a[t].duration=t?a[t-1].duration:_;a[t].cts=0,e=r}}p=M||!p?_:p;const P=d+p;this.nextVideoTs=h=P-u,this.videoSampleDuration=p,this.isVideoContiguous=!0;const N={data1:rx.moof(e.sequenceNumber++,c,ng(e,{samples:a})),data2:A,startPTS:(m-u)/i,endPTS:(g+p-u)/i,startDTS:(c-u)/i,endDTS:h/i,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,N}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(e,t,n,r,i){const s=e.inputTimeScale,a=s/(e.samplerate?e.samplerate:s),o=this.getSamplesPerFrame(e),l=o*a,u=this._initPTS,c="mp3"===e.segmentCodec&&this.typeSupported.mpeg,d=[],h=void 0!==i;let f=e.samples,p=c?0:8,m=this.nextAudioTs||-1;const g=u.baseTime*s/u.timescale,v=g+t*s;if(this.isAudioContiguous=n=n||f.length&&m>0&&(r&&Math.abs(v-(m+g))<9e3||Math.abs(dx(f[0].pts,v)-(m+g))<20*l),f.forEach(function(e){e.pts=dx(e.pts,v)}),!n||m<0){if(f=f.filter(e=>e.pts>=0),!f.length)return;m=0===i?0:r&&!h?Math.max(0,v-g):f[0].pts-g}if("aac"===e.segmentCodec){const t=this.config.maxAudioFramesDrift;for(let n=0,r=m+g;n<f.length;n++){const i=f[n],a=i.pts,o=a-r,u=Math.abs(1e3*o/s);if(o<=-t*l&&h)0===n&&(this.warn(`Audio frame @ ${(a/s).toFixed(3)}s overlaps marker by ${Math.round(1e3*o/s)} ms.`),this.nextAudioTs=m=a-g,r=a);else if(o>=t*l&&u<1e4&&h){let t=Math.round(o/l);for(r=a-t*l;r<0&&t&&l;)t--,r+=l;0===n&&(this.nextAudioTs=m=r-g),this.warn(`Injecting ${t} audio frames @ ${((r-g)/s).toFixed(3)}s due to ${Math.round(1e3*o/s)} ms gap.`);for(let s=0;s<t;s++){let t=tx.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);t||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),t=i.unit.subarray()),f.splice(n,0,{unit:t,pts:r}),r+=l,n++}}i.pts=r,r+=l}}let y,b=null,_=null,x=0,S=f.length;for(;S--;)x+=f[S].unit.byteLength;for(let t=0,r=f.length;t<r;t++){const r=f[t],i=r.unit;let s=r.pts;if(null!==_){d[t-1].duration=Math.round((s-_)/a)}else{if(n&&"aac"===e.segmentCodec&&(s=m+g),b=s,!(x>0))return;x+=p;try{y=new Uint8Array(x)}catch(e){return void this.observer.emit(qm.ERROR,qm.ERROR,{type:Wm.MUX_ERROR,details:jm.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:x,reason:`fail allocating audio mdat ${x}`})}if(!c){new DataView(y.buffer).setUint32(0,x),y.set(rx.types.mdat,4)}}y.set(i,p);const l=i.byteLength;p+=l,d.push(ux(!0,o,l,0)),_=s}const T=d.length;if(!T)return;const E=d[d.length-1];m=_-g,this.nextAudioTs=m+a*E.duration;const A=c?new Uint8Array(0):rx.moof(e.sequenceNumber++,b/a,ng({},e,{samples:d}));e.samples=[];const w=(b-g)/s,M=m/s,R={data1:A,data2:y,startPTS:w,endPTS:M,startDTS:w,endDTS:M,type:"audio",hasAudio:!0,hasVideo:!1,nb:T};return this.isAudioContiguous=!0,R}}function dx(e,t){let n;if(null===t)return e;for(n=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=n;return e}function hx(e,t,n,r){const i=e.samples.length;if(!i)return;const s=e.inputTimeScale;for(let a=0;a<i;a++){const i=e.samples[a];i.pts=dx(i.pts-n.baseTime*s/n.timescale,t*s)/s,i.dts=dx(i.dts-r.baseTime*s/r.timescale,t*s)/s}const a=e.samples;return e.samples=[],{samples:a}}function fx(e,t,n){const r=e.samples.length;if(!r)return;const i=e.inputTimeScale;for(let s=0;s<r;s++){const r=e.samples[s];r.pts=dx(r.pts-n.baseTime*i/n.timescale,t*i)/i}e.samples.sort((e,t)=>e.pts-t.pts);const s=e.samples;return e.samples=[],{samples:s}}function px(e,t,n=!1){return void 0!==(null==e?void 0:e.start)?(e.start+(n?e.duration:0))/e.timescale:t}function mx(e,t,n){const r=null==e?void 0:e.codec;if(r&&r.length>4)return r;if(t===Mg){if("ec-3"===r||"ac-3"===r||"alac"===r)return r;if("fLaC"===r||"Opus"===r){return mv(r,!1)}return n.warn(`Unhandled audio codec "${r}" in mp4 MAP`),r||"mp4a"}return n.warn(`Unhandled video codec "${r}" in mp4 MAP`),r||"avc1"}try{ax=self.performance.now.bind(self.performance)}catch(e){ax=Date.now}const gx=[{demux:class{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,n,r){const i=this.videoTrack=E_("video",1),s=this.audioTrack=E_("audio",1),a=this.txtTrack=E_("text",1);if(this.id3Track=E_("id3",1),this.timeOffset=0,null==e||!e.byteLength)return;const o=Wg(e);if(o.video){const{id:e,timescale:t,codec:n,supplemental:r}=o.video;i.id=e,i.timescale=a.timescale=t,i.codec=n,i.supplemental=r}if(o.audio){const{id:e,timescale:t,codec:n}=o.audio;s.id=e,s.timescale=t,s.codec=n}a.id=Fg.text,i.sampleDuration=0,i.duration=s.duration=r}resetContiguity(){this.remainderData=null}static probe(e){return function(e){const t=e.byteLength;for(let n=0;n<t;){const r=Vg(e,n);if(r>8&&109===e[n+4]&&111===e[n+5]&&111===e[n+6]&&102===e[n+7])return!0;n=r>1?n+r:t}return!1}(e)}demux(e,t){this.timeOffset=t;let n=e;const r=this.videoTrack,i=this.txtTrack;if(this.config.progressive){this.remainderData&&(n=Zg(this.remainderData,e));const t=function(e){const t={valid:null,remainder:null},n=Hg(e,["moof"]);if(n.length<2)return t.remainder=e,t;const r=n[n.length-1];return t.valid=e.slice(0,r.byteOffset-8),t.remainder=e.slice(r.byteOffset-8),t}(n);this.remainderData=t.remainder,r.samples=t.valid||new Uint8Array}else r.samples=n;const s=this.extractID3Track(r,t);return i.samples=Jg(t,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:s,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,n=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const r=this.extractID3Track(t,this.timeOffset);return n.samples=Jg(e,t),{videoTrack:t,audioTrack:E_(),id3Track:r,textTrack:E_()}}extractID3Track(e,t){const n=this.id3Track;if(e.samples.length){const r=Hg(e.samples,["emsg"]);r&&r.forEach(e=>{const r=function(e){const t=e[0];let n="",r="",i=0,s=0,a=0,o=0,l=0,u=0;if(0===t){for(;"\0"!==Ug(e.subarray(u,u+1));)n+=Ug(e.subarray(u,u+1)),u+=1;for(n+=Ug(e.subarray(u,u+1)),u+=1;"\0"!==Ug(e.subarray(u,u+1));)r+=Ug(e.subarray(u,u+1)),u+=1;r+=Ug(e.subarray(u,u+1)),u+=1,i=Vg(e,12),s=Vg(e,16),o=Vg(e,20),l=Vg(e,24),u=28}else if(1===t){u+=4,i=Vg(e,u),u+=4;const t=Vg(e,u);u+=4;const s=Vg(e,u);for(u+=4,a=2**32*t+s,Hm(a)||(a=Number.MAX_SAFE_INTEGER,dg.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=Vg(e,u),u+=4,l=Vg(e,u),u+=4;"\0"!==Ug(e.subarray(u,u+1));)n+=Ug(e.subarray(u,u+1)),u+=1;for(n+=Ug(e.subarray(u,u+1)),u+=1;"\0"!==Ug(e.subarray(u,u+1));)r+=Ug(e.subarray(u,u+1)),u+=1;r+=Ug(e.subarray(u,u+1)),u+=1}return{schemeIdUri:n,value:r,timeScale:i,presentationTime:a,presentationTimeDelta:s,eventDuration:o,id:l,payload:e.subarray(u,e.byteLength)}}(e);if(V_.test(r.schemeIdUri)){const e=z_(r,t);let i=4294967295===r.eventDuration?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;i<=.001&&(i=Number.POSITIVE_INFINITY);const s=r.payload;n.samples.push({data:s,len:s.byteLength,dts:e,pts:e,type:T_.emsg,duration:i})}else if(this.config.enableEmsgKLVMetadata&&r.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const e=z_(r,t);n.samples.push({data:r.payload,len:r.payload.byteLength,dts:e,pts:e,type:T_.misbklv,duration:Number.POSITIVE_INFINITY})}})}return n}demuxSampleAes(e,t,n){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}},remux:class extends sg{constructor(e,t,n,r){super("passthrough-remuxer",r),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(e){this.lastEndTime=null;const t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,n,r){this.audioCodec=t,this.videoCodec=n,this.generateInitSegment(Qg(e,r)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:n}=this;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const r=this.initData=Wg(e);r.audio&&(t=mx(r.audio,Mg,this)),r.video&&(n=mx(r.video,Rg,this));const i={};r.audio&&r.video?i.audiovideo={container:"video/mp4",codec:t+","+n,supplemental:r.video.supplemental,initSegment:e,id:"main"}:r.audio?i.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:r.video?i.video={container:"video/mp4",codec:n,supplemental:r.video.supplemental,initSegment:e,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=i}remux(e,t,n,r,i,s){var a,o;let{initPTS:l,lastEndTime:u}=this;const c={audio:void 0,video:void 0,text:r,id3:n,initSegment:void 0};Gm(u)||(u=this.lastEndTime=i||0);const d=t.samples;if(null==d||!d.length)return c;const h={initPTS:void 0,timescale:void 0,trackId:void 0};let f=this.initData;if(null!=(a=f)&&a.length||(this.generateInitSegment(d),f=this.initData),null==(o=f)||!o.length)return this.warn("Failed to generate initSegment."),c;this.emitInitSegment&&(h.tracks=this.initTracks,this.emitInitSegment=!1);const p=function(e,t,n){const r={},i=Hg(e,["moof","traf"]);for(let e=0;e<i.length;e++){const s=i[e],a=Hg(s,["tfhd"])[0],o=Vg(a,4),l=t[o];if(!l)continue;const u=r[o]||(r[o]={start:NaN,duration:0,sampleCount:0,timescale:l.timescale,type:l.type}),c=Hg(s,["tfdt"])[0];if(c){const e=c[0];let t=Vg(c,4);1===e&&(t===kg?n.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(t*=kg+1,t+=Vg(c,8))),Gm(t)&&(!Gm(u.start)||t<u.start)&&(u.start=t)}const d=l.default,h=Vg(a,0)|(null==d?void 0:d.flags);let f=(null==d?void 0:d.duration)||0;8&h&&(f=Vg(a,2&h?12:8));const p=Hg(s,["trun"]);let m=u.start||0,g=0,v=f;for(let e=0;e<p.length;e++){const t=p[e],n=Vg(t,4),r=u.sampleCount;u.sampleCount+=n;const i=1&t[3],s=4&t[3],a=1&t[2],o=2&t[2],l=4&t[2],c=8&t[2];let d=8,h=n;for(i&&(d+=4),s&&n&&(1&t[d+1]||void 0!==u.keyFrameIndex||(u.keyFrameIndex=r),d+=4,a?(v=Vg(t,d),d+=4):v=f,o&&(d+=4),c&&(d+=4),m+=v,g+=v,h--);h--;)a?(v=Vg(t,d),d+=4):v=f,o&&(d+=4),l&&(1&t[d+1]||void 0===u.keyFrameIndex&&(u.keyFrameIndex=u.sampleCount-(h+1),u.keyFrameStart=m),d+=4),c&&(d+=4),m+=v,g+=v;!g&&f&&(g+=f*n)}u.duration+=g}if(!Object.keys(r).some(e=>r[e].duration)){let t=1/0,n=0;const i=Hg(e,["sidx"]);for(let e=0;e<i.length;e++){const r=$g(i[e]);if(null!=r&&r.references){t=Math.min(t,r.earliestPresentationTime/r.timescale);const e=r.references.reduce((e,t)=>e+t.info.duration||0,0);n=Math.max(n,e+r.earliestPresentationTime/r.timescale)}}n&&Gm(n)&&Object.keys(r).forEach(e=>{r[e].duration||(r[e].duration=n*r[e].timescale-r[e].start)})}return r}(d,f,this),m=f.audio?p[f.audio.id]:null,g=f.video?p[f.video.id]:null,v=px(g,1/0),y=px(m,1/0),b=px(g,0,!0),_=px(m,0,!0);let x,S=i,T=0;if(m&&(!g||!l&&y<v||l&&l.trackId===f.audio.id)?(h.trackId=f.audio.id,x=m,T=_-y):g&&(h.trackId=f.video.id,x=g,T=b-v),x){const e=x.timescale;S=x.start/e,h.initPTS=x.start-i*e,h.timescale=e,l||(this.initPTS=l={baseTime:h.initPTS,timescale:e,trackId:h.trackId})}!s&&l||!function(e,t,n,r){if(null===e)return!0;const i=Math.max(r,1),s=t-e.baseTime/e.timescale;return Math.abs(s-n)>i}(l,S,i,T)&&h.timescale===l.timescale||(h.initPTS=S-i,h.timescale=1,l&&1===l.timescale&&this.warn(`Adjusting initPTS @${i} from ${l.baseTime/l.timescale} to ${h.initPTS}`),this.initPTS=l={baseTime:h.initPTS,timescale:1});const E=e?S-l.baseTime/l.timescale:u,A=E+T;T>0?this.lastEndTime=A:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const w=!!f.audio,M=!!f.video;let R="";w&&(R+="audio"),M&&(R+="video");const C={data1:d,startPTS:E,startDTS:E,endPTS:A,endDTS:A,type:R,hasAudio:w,hasVideo:M,nb:1,dropped:0};c.audio=w&&!M?C:void 0,c.video=M?C:void 0;const I=null==g?void 0:g.sampleCount;if(I){const e=g.keyFrameIndex,t=-1!==e;C.nb=I,C.dropped=0===e||this.isVideoContiguous?0:t?e:I,C.independent=t,C.firstKeyFrame=e,t&&g.keyFrameStart&&(C.firstKeyFramePTS=(g.keyFrameStart-l.baseTime)/l.timescale),this.isVideoContiguous||(c.independent=t),this.isVideoContiguous||(this.isVideoContiguous=t),C.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${e}/${I} dropped: ${C.dropped} start: ${C.firstKeyFramePTS||"NA"}`)}return c.initSegment=h,c.id3=hx(n,i,l,l),r.samples.length&&(c.text=fx(r,i,l)),c}}},{demux:X_,remux:cx},{demux:class extends A_{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const n=s_(e,0);let r=(null==n?void 0:n.length)||0;if(O_(e,r))return!1;for(let n=e.length;r<n;r++)if(c_(e,r))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&a_(e,t)&&l_(e,t)<=e.length-t}(e,t)}appendFrame(e,t,n){d_(e,this.observer,t,n,e.manifestCodec);const r=f_(e,t,n,this.basePTS,this.frameIndex);if(r&&0===r.missing)return r}},remux:cx},{demux:class extends A_{resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=s_(e,0);let n=(null==t?void 0:t.length)||0;if(t&&11===e[n]&&119===e[n+1]&&void 0!==S_(t)&&F_(e,n)<=16)return!1;for(let t=e.length;n<t;n++)if(O_(e,n))return dg.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return D_(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,n){if(null!==this.basePTS)return P_(e,t,n,this.basePTS,this.frameIndex)}},remux:cx}];gx.splice(2,0,{demux:U_,remux:cx});class vx{constructor(e,t,n,r,i,s){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=n,this.id=i,this.logger=s}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,n,r){const i=n.transmuxing;i.executeStart=ax();let s=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:o}=this;r&&(this.currentTransmuxState=r);const{contiguous:l,discontinuity:u,trackSwitch:c,accurateTimeOffset:d,timeOffset:h,initSegmentChange:f}=r||a,{audioCodec:p,videoCodec:m,defaultInitPts:g,duration:v,initSegmentData:y}=o,b=function(e,t){let n=null;e.byteLength>0&&null!=(null==t?void 0:t.key)&&null!==t.iv&&null!=t.method&&(n=t);return n}(s,t);if(b&&Vy(b.method)){const e=this.getDecrypter(),t=zy(b.method);if(!e.isSync())return this.asyncResult=!0,this.decryptionPromise=e.webCryptoDecrypt(s,b.key.buffer,b.iv.buffer,t).then(e=>{const t=this.push(e,null,n);return this.decryptionPromise=null,t}),this.decryptionPromise;{let r=e.softwareDecrypt(s,b.key.buffer,b.iv.buffer,t);if(n.part>-1){const t=e.flush();r=t?t.buffer:t}if(!r)return i.executeEnd=ax(),yx(n);s=new Uint8Array(r)}}const _=this.needsProbing(u,c);if(_){const e=this.configureTransmuxer(s);if(e)return this.logger.warn(`[transmuxer] ${e.message}`),this.observer.emit(qm.ERROR,qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),i.executeEnd=ax(),yx(n)}(u||c||f||_)&&this.resetInitSegment(y,p,m,v,t),(u||f||_)&&this.resetInitialTimestamp(g),l||this.resetContiguity();const x=this.transmux(s,b,h,d,n);this.asyncResult=bx(x);const S=this.currentTransmuxState;return S.contiguous=!0,S.discontinuity=!1,S.trackSwitch=!1,i.executeEnd=ax(),x}flush(e){const t=e.transmuxing;t.executeStart=ax();const{decrypter:n,currentTransmuxState:r,decryptionPromise:i}=this;if(i)return this.asyncResult=!0,i.then(()=>this.flush(e));const s=[],{timeOffset:a}=r;if(n){const t=n.flush();t&&s.push(this.push(t.buffer,null,e))}const{demuxer:o,remuxer:l}=this;if(!o||!l){t.executeEnd=ax();const n=[yx(e)];return this.asyncResult?Promise.resolve(n):n}const u=o.flush(a);return bx(u)?(this.asyncResult=!0,u.then(t=>(this.flushRemux(s,t,e),s))):(this.flushRemux(s,u,e),this.asyncResult?Promise.resolve(s):s)}flushRemux(e,t,n){const{audioTrack:r,videoTrack:i,id3Track:s,textTrack:a}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${n.sn}${n.part>-1?" part: "+n.part:""} of ${this.id===Zm.MAIN?"level":"track"} ${n.level}`);const u=this.remuxer.remux(r,i,s,a,l,o,!0,this.id);e.push({remuxResult:u,chunkMeta:n}),n.transmuxing.executeEnd=ax()}resetInitialTimestamp(e){const{demuxer:t,remuxer:n}=this;t&&n&&(t.resetTimeStamp(e),n.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,n,r,i){const{demuxer:s,remuxer:a}=this;s&&a&&(s.resetInitSegment(e,t,n,r),a.resetInitSegment(e,t,n,i))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,n,r,i){let s;return s=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,n,r,i):this.transmuxUnencrypted(e,n,r,i),s}transmuxUnencrypted(e,t,n,r){const{audioTrack:i,videoTrack:s,id3Track:a,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(i,s,a,o,t,n,!1,this.id),chunkMeta:r}}transmuxSampleAes(e,t,n,r,i){return this.demuxer.demuxSampleAes(e,t,n).then(e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,n,r,!1,this.id),chunkMeta:i}))}configureTransmuxer(e){const{config:t,observer:n,typeSupported:r}=this;let i;for(let t=0,n=gx.length;t<n;t++){var s;if(null!=(s=gx[t].demux)&&s.probe(e,this.logger)){i=gx[t];break}}if(!i)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,o=this.remuxer,l=i.remux,u=i.demux;o&&o instanceof l||(this.remuxer=new l(n,t,r,this.logger)),a&&a instanceof u||(this.demuxer=new u(n,t,r,this.logger),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new yy(this.config)),e}}const yx=e=>({remuxResult:{},chunkMeta:e});function bx(e){return"then"in e&&e.then instanceof Function}class _x{constructor(e,t,n,r,i){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=n,this.duration=r,this.defaultInitPts=i||null}}class xx{constructor(e,t,n,r,i,s){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=n,this.trackSwitch=r,this.timeOffset=i,this.initSegmentChange=s}}let Sx=0;class Tx{constructor(e,t,n,r){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=Sx++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=e=>{const t=e.data,n=this.hls;if(n&&null!=t&&t.event&&t.instanceNo===this.instanceNo)switch(t.event){case"init":{var r;const e=null==(r=this.workerContext)?void 0:r.objectURL;e&&self.URL.revokeObjectURL(e);break}case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;case"workerLog":n.logger[t.data.logType]&&n.logger[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.part=this.part,t.data.id=this.id,n.trigger(t.event,t.data)}},this.onWorkerError=e=>{if(!this.hls)return;const t=new Error(`${e.message}  (${e.filename}:${e.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:t})};const i=e.config;this.hls=e,this.id=t,this.useWorker=!!i.enableWorker,this.onTransmuxComplete=n,this.onFlush=r;const s=(e,t)=>{(t=t||{}).frag=this.frag||void 0,e===qm.ERROR&&(t.parent=this.id,t.part=this.part,this.error=t.error),this.hls.trigger(e,t)};this.observer=new Jb,this.observer.on(qm.FRAG_DECRYPTED,s),this.observer.on(qm.ERROR,s);const a=bv(i.preferManagedMediaSource);if(this.useWorker&&"undefined"!=typeof Worker){const n=this.hls.logger;if(i.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__){try{i.workerPath?(n.log(`loading Web Worker ${i.workerPath} for "${t}"`),this.workerContext=function(e){const t=t_[e];if(t)return t.clientCount++,t;const n=new self.URL(e,self.location.href).href,r={worker:new self.Worker(n),scriptURL:n,clientCount:1};return t_[e]=r,r}(i.workerPath)):(n.log(`injecting Web Worker for "${t}"`),this.workerContext=function(){const e=t_[e_];if(e)return e.clientCount++,e;const t=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),n=self.URL.createObjectURL(t),r={worker:new self.Worker(n),objectURL:n,clientCount:1};return t_[e_]=r,r}());const{worker:e}=this.workerContext;e.addEventListener("message",this.onWorkerMessage),e.addEventListener("error",this.onWorkerError),e.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:kv(i)})}catch(r){n.warn(`Error setting up "${t}" Web Worker, fallback to inline`,r),this.terminateWorker(),this.error=null,this.transmuxer=new vx(this.observer,a,i,"",t,e.logger)}return}}this.transmuxer=new vx(this.observer,a,i,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=Sx++;const t=this.hls.config,n=bv(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:n,id:this.id,config:kv(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),function(e){const t=t_[e||e_];if(t&&1===t.clientCount--){const{worker:n,objectURL:r}=t;delete t_[e||e_],r&&self.URL.revokeObjectURL(r),n.terminate()}}(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,n,r,i,s,a,o,l,u){var c,d;l.transmuxing.start=self.performance.now();const{instanceNo:h,transmuxer:f}=this,p=s?s.start:i.start,m=i.decryptdata,g=this.frag,v=!(g&&i.cc===g.cc),y=!(g&&l.level===g.level),b=g?l.sn-g.sn:-1,_=this.part?l.part-this.part.index:-1,x=0===b&&l.id>1&&l.id===(null==g?void 0:g.stats.chunkCount),S=!y&&(1===b||0===b&&(1===_||x&&_<=0)),T=self.performance.now();(y||b||0===i.stats.parsing.start)&&(i.stats.parsing.start=T),!s||!_&&S||(s.stats.parsing.start=T);const E=!(g&&(null==(c=i.initSegment)?void 0:c.url)===(null==(d=g.initSegment)?void 0:d.url)),A=new xx(v,S,o,y,p,E);if(!S||v||E){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${i.type} sn: ${l.sn}${l.part>-1?" part: "+l.part:""} ${this.id===Zm.MAIN?"level":"track"}: ${l.level} id: ${l.id}\n        discontinuity: ${v}\n        trackSwitch: ${y}\n        contiguous: ${S}\n        accurateTimeOffset: ${o}\n        timeOffset: ${p}\n        initSegmentChange: ${E}`);const e=new _x(n,r,t,a,u);this.configureTransmuxer(e)}if(this.frag=i,this.part=s,this.workerContext)this.workerContext.worker.postMessage({instanceNo:h,cmd:"demux",data:e,decryptdata:m,chunkMeta:l,state:A},e instanceof ArrayBuffer?[e]:[]);else if(f){const t=f.push(e,m,l,A);bx(t)?t.then(e=>{this.handleTransmuxComplete(e)}).catch(e=>{this.transmuxerError(e,l,"transmuxer-interface push error")}):this.handleTransmuxComplete(t)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:n}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(n){const t=n.flush(e);bx(t)?t.then(t=>{this.handleFlushResult(t,e)}).catch(t=>{this.transmuxerError(t,e,"transmuxer-interface flush error")}):this.handleFlushResult(t,e)}}transmuxerError(e,t,n){this.hls&&(this.error=e,this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:n}))}handleFlushResult(e,t){e.forEach(e=>{this.handleTransmuxComplete(e)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:n}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):n&&n.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}class Ex extends qb{constructor(e,t,n){super(e,t,n,"audio-stream-controller",Zm.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.on(qm.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(qm.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(qm.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(qm.BUFFER_RESET,this.onBufferReset,this),e.on(qm.BUFFER_CREATED,this.onBufferCreated,this),e.on(qm.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(qm.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(qm.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(qm.FRAG_LOADING,this.onFragLoading,this),e.on(qm.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.off(qm.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(qm.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(qm.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(qm.BUFFER_RESET,this.onBufferReset,this),e.off(qm.BUFFER_CREATED,this.onBufferCreated,this),e.off(qm.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(qm.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(qm.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(qm.FRAG_LOADING,this.onFragLoading,this),e.off(qm.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:n,initPTS:r,timescale:i}){if(n===Zm.MAIN){const e=t.cc,n=this.fragCurrent;if(this.initPTS[e]={baseTime:r,timescale:i},this.log(`InitPTS for cc: ${e} found from main: ${r}/${i}`),this.mainAnchor=t,this.state===Wb){const n=this.waitingData;(!n&&!this.loadingParts||n&&n.frag.cc!==e)&&this.syncWithAnchor(t,null==n?void 0:n.frag)}else!this.hls.hasEnoughToStart&&n&&n.cc!==e?(n.abortRequests(),this.syncWithAnchor(t,n)):this.state===Ob&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var n;const r=(null==(n=this.mainFragLoading)?void 0:n.frag)||null;if(t&&(null==r?void 0:r.cc)===t.cc)return;const i=(r||e).cc,s=Yv(this.getLevelDetails(),i,this.getLoadPosition());s&&(this.log(`Syncing with main frag at ${s.start} cc ${s.cc}`),this.startFragRequested=!1,this.nextLoadPosition=s.start,this.resetLoadingState(),this.state===Ob&&this.doTickIdle())}startLoad(e,t){if(!this.levels)return this.startPosition=e,void(this.state=kb);const n=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),n>0&&-1===e?(this.log(`Override startPosition with lastCurrentTime @${n.toFixed(3)}`),e=n,this.state=Ob):this.state=Vb,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case Ob:this.doTickIdle();break;case Vb:{const{levels:e,trackId:t}=this,n=null==e?void 0:e[t],r=null==n?void 0:n.details;if(r&&!this.waitForLive(n)){if(this.waitForCdnTuneIn(r))break;this.state=Wb}break}case Bb:{var e;const t=performance.now(),n=this.retryDate;if(!n||t>=n||null!=(e=this.media)&&e.seeking){const{levels:e,trackId:t}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==e?void 0:e[t])||null),this.state=Ob}break}case Wb:{const e=this.waitingData;if(e){const{frag:t,part:n,cache:r,complete:i}=e,s=this.mainAnchor;if(void 0!==this.initPTS[t.cc]){this.waitingData=null,this.state=Ub;const e={frag:t,part:n,payload:r.flush().buffer,networkDetails:null};this._handleFragmentLoadProgress(e),i&&super._handleFragmentLoadComplete(e)}else s&&s.cc!==e.frag.cc&&this.syncWithAnchor(s,e.frag)}else this.state=Ob}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:n,media:r,trackId:i}=this,s=t.config;if(!this.buffering||!r&&!this.primaryPrefetch&&(this.startFragRequested||!s.startFragPrefetch)||null==n||!n[i])return;const a=n[i],o=a.details;if(!o||this.waitForLive(a)||this.waitForCdnTuneIn(o))return this.state=Vb,void(this.startFragRequested=!1);const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,Mg,Zm.AUDIO));const u=this.getFwdBufferInfo(l,Zm.AUDIO);if(null===u)return;if(!this.switchingTrack&&this._streamEnded(u,o))return t.trigger(qm.BUFFER_EOS,{type:"audio"}),void(this.state=Hb);const c=u.len,d=t.maxBufferLength,h=o.fragments,f=h[0].start,p=this.getLoadPosition(),m=this.flushing?p:u.end;if(this.switchingTrack&&r){const e=p;o.PTSKnown&&e<f&&(u.end>f||u.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),r.currentTime=f+.05)}if(c>=d&&!this.switchingTrack&&m<h[h.length-1].start)return;let g=this.getNextFragment(m,o);if(g&&this.isLoopLoading(g,m)&&(g=this.getNextFragmentLoopLoading(g,o,u,Zm.MAIN,d)),!g)return void(this.bufferFlushed=!0);let v=(null==(e=this.mainFragLoading)?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&v&&Lg(g)&&!g.endList&&(!o.live||!this.loadingParts&&m<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(v)===ly&&(this.mainFragLoading=v=null),v&&Lg(v))){if(g.start>v.end){const e=this.fragmentTracker.getFragAtPos(m,Zm.MAIN);e&&e.end>v.end&&(v=e,this.mainFragLoading={frag:e,targetBufferTime:null})}if(g.start>v.end)return}this.loadFragment(g,a,m)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(e=>new Pv(e))}onAudioTrackSwitching(e,t){const n=!!t.url;this.trackId=t.id;const{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),n?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==kb&&(this.setInterval(100),this.state=Ob,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const n=this.cachedTrackLoadedData;n&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(qm.AUDIO_TRACK_LOADED,n))}onAudioTrackLoaded(e,t){var n;const{levels:r}=this,{details:i,id:s,groupId:a,track:o}=t;if(!r)return void this.warn(`Audio tracks reset while loading track ${s} "${o.name}" of "${a}"`);const l=this.mainDetails;if(!l||i.endCC>l.endCC||l.expired)return this.cachedTrackLoadedData=t,void(this.state!==kb&&(this.state=Vb));this.cachedTrackLoadedData=null,this.log(`Audio track ${s} "${o.name}" of "${a}" loaded [${i.startSN},${i.endSN}]${i.lastPartSn?`[part-${i.lastPartSn}-${i.lastPartIndex}]`:""},duration:${i.totalduration}`);const u=r[s];let c=0;if(i.live||null!=(n=u.details)&&n.live){if(this.checkLiveUpdate(i),i.deltaUpdateFailed)return;var d;if(u.details)c=this.alignPlaylists(i,u.details,null==(d=this.levelLastLoaded)?void 0:d.details);i.alignedSliding||(Pb(i,l),i.alignedSliding||Nb(i,l),c=i.fragmentStart)}u.details=i,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(l,c),this.hls.trigger(qm.AUDIO_TRACK_UPDATED,{details:i,id:s,groupId:t.groupId}),this.state!==Vb||this.waitForCdnTuneIn(i)||(this.state=Ob),this.tick()}_handleFragmentLoadProgress(e){var t;const n=e.frag,{part:r,payload:i}=e,{config:s,trackId:a,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);const l=o[a];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const u=l.details;if(!u)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(n.start);const c=s.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new Tx(this.hls,Zm.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const h=this.initPTS[n.cc],f=null==(t=n.initSegment)?void 0:t.data;if(void 0!==h){const e=!1,t=r?r.index:-1,s=-1!==t,a=new Ay(n.level,n.sn,n.stats.chunkCount,i.byteLength,t,s);d.push(i,f,c,"",n,r,u.totalduration,e,a,h)}else{this.log(`Unknown video PTS for cc ${n.cc}, waiting for video PTS before demuxing audio frag ${n.sn} of [${u.startSN} ,${u.endSN}],track ${a}`);const{cache:e}=this.waitingData=this.waitingData||{frag:n,part:r,cache:new Yb,complete:!1};e.push(new Uint8Array(i)),this.state!==kb&&(this.state=Wb)}}_handleFragmentLoadComplete(e){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const n=t.tracks.audio;n&&(this.mediaBuffer=n.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===Zm.MAIN&&Lg(t.frag)&&(this.mainFragLoading=t,this.state===Ob&&this.tick())}onFragBuffered(e,t){const{frag:n,part:r}=t;if(n.type===Zm.AUDIO)if(this.fragContextChanged(n))this.warn(`Fragment ${n.sn}${r?" p: "+r.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if(Lg(n)){this.fragPrevious=n;const e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(qm.AUDIO_TRACK_SWITCHED,ig({},e)))}this.fragBufferedComplete(n,r),this.media&&this.tick()}else this.audioOnly||n.type!==Zm.MAIN||n.elementaryStreams.video||n.elementaryStreams.audiovideo||(this.audioOnly=!0,this.mainFragLoading=null)}onError(e,t){var n;if(t.fatal)this.state=$b;else switch(t.details){case jm.FRAG_GAP:case jm.FRAG_PARSING_ERROR:case jm.FRAG_DECRYPT_ERROR:case jm.FRAG_LOAD_ERROR:case jm.FRAG_LOAD_TIMEOUT:case jm.KEY_LOAD_ERROR:case jm.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(Zm.AUDIO,t);break;case jm.AUDIO_TRACK_LOAD_ERROR:case jm.AUDIO_TRACK_LOAD_TIMEOUT:case jm.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==Vb||(null==(n=t.context)?void 0:n.type)!==Km||(this.state=Ob);break;case jm.BUFFER_ADD_CODEC_ERROR:case jm.BUFFER_APPEND_ERROR:if("audio"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case jm.BUFFER_FULL_ERROR:if("audio"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case jm.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onBufferFlushing(e,{type:t}){t!==Rg&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==Rg){this.flushing=!1,this.bufferFlushed=!0,this.state===Hb&&(this.state=Ob);const e=this.mediaBuffer||this.media;e&&(this.afterBufferFlushed(e,t,Zm.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const n="audio",{hls:r}=this,{remuxResult:i,chunkMeta:s}=e,a=this.getCurrentContext(s);if(!a)return void this.resetWhenMissingContext(s);const{frag:o,part:l,level:u}=a,{details:c}=u,{audio:d,text:h,id3:f,initSegment:p}=i;if(!this.fragContextChanged(o)&&c){if(this.state=zb,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),null!=p&&p.tracks){const e=o.initSegment||o;this._bufferInitSegment(u,p.tracks,e,s),r.trigger(qm.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:p.tracks})}if(d){const{startPTS:e,endPTS:t,startDTS:n,endDTS:r}=d;l&&(l.elementaryStreams[Mg]={startPTS:e,endPTS:t,startDTS:n,endDTS:r}),o.setElementaryStreamInfo(Mg,e,t,n,r),this.bufferFragmentData(d,o,l,s)}if(null!=f&&null!=(t=f.samples)&&t.length){const e=ng({id:n,frag:o,details:c},f);r.trigger(qm.FRAG_PARSING_METADATA,e)}if(h){const e=ng({id:n,frag:o,details:c},h);r.trigger(qm.FRAG_PARSING_USERDATA,e)}}else this.fragmentTracker.removeFragment(o)}_bufferInitSegment(e,t,n,r){if(this.state!==zb)return;if(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio)return;const i=t.audio;i.id=Zm.AUDIO;const s=e.audioCodec;this.log(`Init audio buffer, container:${i.container}, codecs[level/parsed]=[${s}/${i.codec}]`),s&&1===s.split(",").length&&(i.levelCodec=s),this.hls.trigger(qm.BUFFER_CODECS,t);const a=i.initSegment;if(null!=a&&a.byteLength){const e={type:"audio",frag:n,part:null,chunkMeta:r,parent:n.type,data:a};this.hls.trigger(qm.BUFFER_APPENDING,e)}this.tickImmediate()}loadFragment(e,t,n){const r=this.fragmentTracker.getState(e);var i;if(this.switchingTrack||r===sy||r===oy)if(Lg(e))if(null!=(i=t.details)&&i.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=Wb;const n=this.mainDetails;n&&n.fragmentStart!==t.details.fragmentStart&&Nb(t.details,n)}else super.loadFragment(e,t,n);else this._loadInitSegment(e,t);else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:n,assocLang:r,characteristics:i,audioCodec:s,channels:a}=this.bufferedTrack;Vv({name:t,lang:n,assocLang:r,characteristics:i,audioCodec:s,channels:a},e,zv)||(Hv(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(qm.AUDIO_TRACK_SWITCHED,ig({},e))}}class Ax extends sg{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,n){const r=null==t?void 0:t.renditionReports;if(r){let i=-1;for(let n=0;n<r.length;n++){const s=r[n];let a;try{a=new self.URL(s.URI,t.url).href}catch(e){this.warn(`Could not construct new URL for Rendition Report: ${e}`),a=s.URI||""}if(a===e){i=n;break}a===e.substring(0,a.length)&&(i=n)}if(-1!==i){const e=r[i],s=parseInt(e["LAST-MSN"])||(null==t?void 0:t.lastPartSn);let a=parseInt(e["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);a>=0&&e>t.partTarget&&(a+=1)}const o=n&&Iv(n);return new Lv(s,a>=0?a:void 0,o)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}return e}playlistLoaded(e,t,n){const{details:r,stats:i}=t,s=self.performance.now(),a=i.loading.first?Math.max(0,s-i.loading.first):0;r.advancedDateTime=Date.now()-a;const o=this.hls.config.timelineOffset;if(o!==r.appliedTimelineOffset){const e=Math.max(o||0,0);r.appliedTimelineOffset=e,r.fragments.forEach(t=>{t.start=t.playlistOffset+e})}if(r.live||null!=n&&n.live){const o="levelInfo"in t?t.levelInfo:t.track;if(r.reloaded(n),n&&r.fragments.length>0){_b(n,r);const e=r.playlistParsingError;if(e){this.warn(e);const n=this.hls;if(!n.config.ignorePlaylistParsingErrors){var l;const{networkDetails:s}=t;return void n.trigger(qm.ERROR,{type:Wm.NETWORK_ERROR,details:jm.LEVEL_PARSING_ERROR,fatal:!1,url:r.url,error:e,reason:e.message,level:t.level||void 0,parent:null==(l=r.fragments[0])?void 0:l.type,networkDetails:s,stats:i})}r.playlistParsingError=null}}-1===r.requestScheduled&&(r.requestScheduled=i.loading.start);const u=this.hls.mainForwardBufferInfo,c=u?u.end-u.len:0,d=Eb(r,1e3*(r.edge-c));if(r.requestScheduled+d<s?r.requestScheduled=s:r.requestScheduled+=d,this.log(`live playlist ${e} ${r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:r.updated?"UPDATED":"MISSED"}`),!this.canLoad||!r.live)return;let h,f,p;if(r.canBlockReload&&r.endSN&&r.advanced){const e=this.hls.config.lowLatencyMode,i=r.lastPartSn,a=r.endSN,l=r.lastPartIndex,u=i===a;-1!==l?u?(f=a+1,p=e?0:l):(f=i,p=e?l+1:r.maxPartIndex):f=a+1;const c=r.age,d=c+r.ageHeader;let m=Math.min(d-r.partTarget,1.5*r.targetduration);if(m>0){if(d>3*r.targetduration)this.log(`Playlist last advanced ${c.toFixed(2)}s ago. Omitting segment and part directives.`),f=void 0,p=void 0;else if(null!=n&&n.tuneInGoal&&d-r.partTarget>n.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${n.tuneInGoal} to: ${m} with playlist age: ${r.age}`),m=0;else{const e=Math.floor(m/r.targetduration);if(f+=e,void 0!==p){p+=Math.round(m%r.targetduration/r.partTarget)}this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${c.toFixed(2)}s goal: ${m} skip sn ${e} to part ${p}`)}r.tuneInGoal=m}if(h=this.getDeliveryDirectives(r,t.deliveryDirectives,f,p),e||!u)return r.requestScheduled=s,void this.loadingPlaylist(o,h)}else(r.canBlockReload||r.canSkipUntil)&&(h=this.getDeliveryDirectives(r,t.deliveryDirectives,f,p));h&&void 0!==f&&r.canBlockReload&&(r.requestScheduled=i.loading.first+Math.max(d-2*a,d/2)),this.scheduleLoading(o,h,r)}else this.clearTimer()}scheduleLoading(e,t,n){const r=n||e.details;if(!r)return void this.loadingPlaylist(e,t);const i=self.performance.now(),s=r.requestScheduled;if(i>=s)return void this.loadingPlaylist(e,t);const a=s-i;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,n,r){let i=Iv(e);return null!=t&&t.skip&&e.deltaUpdateFailed&&(n=t.msn,r=t.part,i=Cv.No),new Lv(n,r,i)}checkRetry(e){const t=e.details,n=Kv(e),r=e.errorAction,{action:i,retryCount:s=0,retryConfig:a}=r||{},o=!!r&&!!a&&(i===ty.RetryRequest||!r.resolved&&i===ty.SendAlternateToPenaltyBox);if(o){var l;if(s>=a.maxNumRetry)return!1;if(n&&null!=(l=e.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${s+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const e=Zv(a,s);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),e),this.warn(`Retrying playlist loading ${s+1}/${a.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,r.resolved=!0}return o}}function wx(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Mx(e[n].attrs,t[n].attrs))return!1;return!0}function Mx(e,t,n){const r=e["STABLE-RENDITION-ID"];return r&&!n?r===t["STABLE-RENDITION-ID"]:!(n||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(n=>e[n]!==t[n])}function Rx(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||"").toLowerCase())}class Cx extends Ax{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.on(qm.LEVEL_LOADING,this.onLevelLoading,this),e.on(qm.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(qm.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(qm.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.off(qm.LEVEL_LOADING,this.onLevelLoading,this),e.off(qm.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(qm.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(qm.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:n,groupId:r,details:i}=t,s=this.tracksInGroup[n];if(!s||s.groupId!==r)return void this.warn(`Audio track with id:${n} and group:${r} not found in active group ${null==s?void 0:s.groupId}`);const a=s.details;s.details=t.details,this.log(`Audio track ${n} "${s.name}" lang:${s.lang} group:${r} loaded [${i.startSN}-${i.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const n=t.audioGroups||null,r=this.groupIds;let i=this.currentTrack;if(!n||(null==r?void 0:r.length)!==(null==n?void 0:n.length)||null!=n&&n.some(e=>-1===(null==r?void 0:r.indexOf(e)))){this.groupIds=n,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter(e=>!n||-1!==n.indexOf(e.groupId));if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!i&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.audioPreference;if(!i&&t){const n=Bv(t,e,zv);if(n>-1)i=e[n];else{const e=Bv(t,this.tracks);i=this.tracks[e]}}let r=this.findTrackId(i);-1===r&&i&&(r=this.findTrackId(null));const a={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group(s): ${null==n?void 0:n.join(",")}`),this.hls.trigger(qm.AUDIO_TRACKS_UPDATED,a);const o=this.trackId;if(-1!==r&&-1===o)this.setAudioTrack(r);else if(e.length&&-1===o){var s;const t=new Error(`No audio track selected for current audio group-ID(s): ${null==(s=this.groupIds)?void 0:s.join(",")} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}}onError(e,t){!t.fatal&&t.context&&(t.context.type!==Km||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const n=this.allAudioTracks;if(this.selectDefaultTrack=!1,n.length){const r=this.currentTrack;if(r&&Vv(e,r,zv))return r;const i=Bv(e,this.tracksInGroup,zv);if(i>-1){const e=this.tracksInGroup[i];return this.setAudioTrack(i),e}if(r){let r=t.loadLevel;-1===r&&(r=t.firstAutoLevel);const i=function(e,t,n,r,i){const s=t[r],a=t.reduce((e,t,n)=>{const r=t.uri;return(e[r]||(e[r]=[])).push(n),e},{})[s.uri];a.length>1&&(r=Math.max.apply(Math,a));const o=s.videoRange,l=s.frameRate,u=s.codecSet.substring(0,4),c=Gv(t,r,t=>{if(t.videoRange!==o||t.frameRate!==l||t.codecSet.substring(0,4)!==u)return!1;const r=t.audioGroups,s=n.filter(e=>!r||-1!==r.indexOf(e.groupId));return Bv(e,s,i)>-1});return c>-1?c:Gv(t,r,t=>{const r=t.audioGroups,s=n.filter(e=>!r||-1!==r.indexOf(e.groupId));return Bv(e,s,i)>-1})}(e,t.levels,n,r,zv);if(-1===i)return null;t.nextLoadLevel=i}if(e.channels||e.audioCodec){const t=Bv(e,n);if(t>-1)return n[t]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length)return void this.warn(`Invalid audio track id: ${e}`);this.selectDefaultTrack=!1;const n=this.currentTrack,r=t[e],i=r.details&&!r.details.live;if(e===this.trackId&&r===n&&i)return;if(this.log(`Switching to audio-track ${e} "${r.name}" lang:${r.lang} group:${r.groupId} channels:${r.channels}`),this.trackId=e,this.currentTrack=r,this.hls.trigger(qm.AUDIO_TRACK_SWITCHING,ig({},r)),i)return;const s=this.switchParams(r.url,null==n?void 0:n.details,r.details);this.loadPlaylist(s)}findTrackId(e){const t=this.tracksInGroup;for(let n=0;n<t.length;n++){const r=t[n];if((!this.selectDefaultTrack||r.default)&&(!e||Vv(e,r,zv)))return n}if(e){const{name:n,lang:r,assocLang:i,characteristics:s,audioCodec:a,channels:o}=e;for(let e=0;e<t.length;e++){if(Vv({name:n,lang:r,assocLang:i,characteristics:s,audioCodec:a,channels:o},t[e],zv))return e}for(let n=0;n<t.length;n++){const r=t[n];if(Mx(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const r=t[n];if(Mx(e.attrs,r.attrs,["LANGUAGE"]))return n}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&Hv(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const n=e.id,r=e.groupId,i=this.getUrlWithDirectives(e.url,t),s=e.details,a=null==s?void 0:s.age;this.log(`Loading audio-track ${n} "${e.name}" lang:${e.lang} group:${r}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${a&&s.live?" age "+a.toFixed(1)+(s.type&&" "+s.type||""):""} ${i}`),this.hls.trigger(qm.AUDIO_TRACK_LOADING,{url:i,id:n,groupId:r,deliveryDirectives:t||null,track:e})}}class Ix{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,n){if(null===this.queues||null===this.tracks)return;const r=this.queues[t];r.push(e),1!==r.length||n||this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const n={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(n,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const n={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(n)}})}removeBlockers(){null!==this.queues&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const n=null==(t=e[0])?void 0:t.label;"async-blocker"!==n&&"async-blocker-prepend"!==n||(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(null===this.queues)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(null===this.queues||null===this.tracks)return;const t=this.queues[e];if(t.length){const r=t[0];try{r.execute()}catch(t){var n;if(r.onError(t),null===this.queues||null===this.tracks)return;const i=null==(n=this.tracks[e])?void 0:n.buffer;null!=i&&i.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){null!==this.queues&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return(null==(t=this.queues)?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return null===e||null===t?"<destroyed>":`\n${this.list("video")}\n${this.list("audio")}\n${this.list("audiovideo")}}`}list(e){var t,n;return null!=(t=this.queues)&&t[e]||null!=(n=this.tracks)&&n[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const n=null==(t=this.tracks)?void 0:t[e],r=null==n?void 0:n.buffer;return r?`SourceBuffer${r.updating?" updating":""}${n.ended?" ended":""}${n.ending?" ending":""}`:"none"}listOps(e){var t;return(null==(t=this.queues)?void 0:t[e].map(e=>e.label).join(", "))||""}}const Lx=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Px="HlsJsTrackRemovedError";class Nx extends Error{constructor(e){super(e),this.name=Px}}class Dx extends sg{constructor(e,t){var n;super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=e=>{var t;this.hls&&"open"===(null==(t=this.mediaSource)?void 0:t.readyState)&&this.hls.pauseBuffering()},this._onStartStreaming=e=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=e=>{const{media:t,mediaSource:n}=this;e&&this.log("Media source opened"),t&&n&&(n.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(qm.MEDIA_ATTACHED,{media:t,mediaSource:n}),null!==this.mediaSource&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:e,_objectUrl:t}=this;e!==t&&this.error(`Media element src was set while attaching MediaSource (${t} > ${e})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=(n=hg(e.config.preferManagedMediaSource),"undefined"!=typeof self&&n===self.ManagedMediaSource),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.on(qm.BUFFER_RESET,this.onBufferReset,this),e.on(qm.BUFFER_APPENDING,this.onBufferAppending,this),e.on(qm.BUFFER_CODECS,this.onBufferCodecs,this),e.on(qm.BUFFER_EOS,this.onBufferEos,this),e.on(qm.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(qm.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(qm.FRAG_PARSED,this.onFragParsed,this),e.on(qm.FRAG_CHANGED,this.onFragChanged,this),e.on(qm.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.off(qm.BUFFER_RESET,this.onBufferReset,this),e.off(qm.BUFFER_APPENDING,this.onBufferAppending,this),e.off(qm.BUFFER_CODECS,this.onBufferCodecs,this),e.off(qm.BUFFER_EOS,this.onBufferEos,this),e.off(qm.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(qm.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(qm.FRAG_PARSED,this.onFragParsed,this),e.off(qm.FRAG_CHANGED,this.onFragChanged,this),e.off(qm.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const n={};if(this.operationQueue){const e=this.isUpdating();e||this.operationQueue.removeBlockers();const t=this.isQueued();(e||t)&&this.warn(`Transfering MediaSource with${t?" operations in queue":""}${e?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const r=this.transferData;return!this.sourceBufferCount&&r&&r.mediaSource===t?ng(n,r.tracks):this.sourceBuffers.forEach(e=>{const[t]=e;t&&(n[t]=ng({},this.tracks[t]),this.removeBuffer(t)),e[0]=e[1]=null}),{media:e,mediaSource:t,tracks:n}}initTracks(){this.sourceBuffers=[[null,null],[null,null]],this.tracks={},this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var n;let r=2;(t.audio&&!t.video||!t.altAudio)&&(r=1),this.bufferCodecEventsTotal=r,this.log(`${r} bufferCodec event(s) expected.`),null!=(n=this.transferData)&&n.mediaSource&&this.sourceBufferCount&&r&&this.bufferCreated()}onMediaAttaching(e,t){const n=this.media=t.media,r=hg(this.appendSource);if(this.transferData=this.overrides=void 0,n&&r){const e=!!t.mediaSource;(e||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const i=this.mediaSource=t.mediaSource||new r;if(this.assignMediaSource(i),e)this._objectUrl=n.src,this.attachTransferred();else{const e=this._objectUrl=self.URL.createObjectURL(i);if(this.appendSource)try{n.removeAttribute("src");const t=self.ManagedMediaSource;n.disableRemotePlayback=n.disableRemotePlayback||t&&i instanceof t,kx(n),function(e,t){const n=self.document.createElement("source");n.type="video/mp4",n.src=t,e.appendChild(n)}(n,e),n.load()}catch(t){n.src=e}else n.src=e}n.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,n;this.log(`${(null==(t=this.transferData)?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${null==(n=e.constructor)?void 0:n.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const n=this.tracks,r=t.tracks,i=r?Object.keys(r):null,s=i?i.length:0,a=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(r&&i&&s){if(!this.tracksReady)return this.hls.config.startFragPrefetch=!0,void this.log("attachTransferred: waiting for SourceBuffer track info");if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})\nrequired tracks: ${kv(n,(e,t)=>"initSegment"===e?void 0:t)};\ntransfer tracks: ${kv(r,(e,t)=>"initSegment"===e?void 0:t)}}`),!fg(r,n)){t.mediaSource=null,t.tracks=void 0;const i=e.currentTime,s=this.details,a=Math.max(i,(null==s?void 0:s.fragments[0].start)||0);return a-i>1?void this.log(`attachTransferred: waiting for playback to reach new tracks start time ${i} -> ${a}`):(this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(r)}"->"${Object.keys(n)}") start time: ${a} currentTime: ${i}`),this.onMediaDetaching(qm.MEDIA_DETACHING,{}),this.onMediaAttaching(qm.MEDIA_ATTACHING,t),void(e.currentTime=a))}this.transferData=void 0,i.forEach(e=>{const t=e,n=r[t];if(n){const e=n.buffer;if(e){const r=this.fragmentTracker,i=n.id;if(r.hasFragments(i)||r.hasParts(i)){const n=My.getBuffered(e);r.detectEvictedFragments(t,n,i,null,!0)}const s=Ox(t),a=[t,e];this.sourceBuffers[s]=a,e.updating&&this.operationQueue&&this.operationQueue.prependBlocker(t),this.trackSourceBuffer(t,n)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=null==(e=this.mediaSource)?void 0:e.readyState;return"open"===t||"ended"===t}onMediaDetaching(e,t){const n=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:r,mediaSource:i,_objectUrl:s}=this;if(i){if(this.log("media source "+(n?"transferring":"detaching")),n)this.sourceBuffers.forEach(([e])=>{e&&this.removeBuffer(e)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const e="open"===i.readyState;try{const t=i.sourceBuffers;for(let n=t.length;n--;)e&&t[n].abort(),i.removeSourceBuffer(t[n]);e&&i.endOfStream()}catch(e){this.warn(`onMediaDetaching: ${e.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}i.removeEventListener("sourceopen",this._onMediaSourceOpen),i.removeEventListener("sourceended",this._onMediaSourceEnded),i.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(i.removeEventListener("startstreaming",this._onStartStreaming),i.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}r&&(r.removeEventListener("emptied",this._onMediaEmptied),n||(s&&self.URL.revokeObjectURL(s),this.mediaSrc===s?(r.removeAttribute("src"),this.appendSource&&kx(r),r.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(qm.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const n=null==(t=this.tracks[e])?void 0:t.buffer;if(this.removeBuffer(e),n)try{var r;null!=(r=this.mediaSource)&&r.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(n)}catch(t){this.warn(`onBufferReset ${e}`,t)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Ox(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new Ix(this.tracks)}onBufferCodecs(e,t){const n=this.tracks,r=Object.keys(t);this.log(`BUFFER_CODECS: "${r}" (current SB count ${this.sourceBufferCount})`);const i="audiovideo"in t&&(n.audio||n.video)||n.audiovideo&&("audio"in t||"video"in t),s=!i&&this.sourceBufferCount&&this.media&&r.some(e=>!n[e]);i||s?this.warn(`Unsupported transition between "${Object.keys(n)}" and "${r}" SourceBuffers`):(r.forEach(e=>{var r,i,s;const a=t[e],{id:o,codec:l,levelCodec:u,container:c,metadata:d,supplemental:h}=a;let f=n[e];const p=null==(r=this.transferData)||null==(i=r.tracks)?void 0:i[e],m=null!=p&&p.buffer?p:f,g=(null==m?void 0:m.pendingCodec)||(null==m?void 0:m.codec),v=null==m?void 0:m.levelCodec;f||(f=n[e]={buffer:void 0,listeners:[],codec:l,supplemental:h,container:c,levelCodec:u,metadata:d,id:o});const y=gv(g,v),b=null==y?void 0:y.replace(Lx,"$1");let _=gv(l,u);const x=null==(s=_)?void 0:s.replace(Lx,"$1");_&&y&&b!==x&&("audio"===e.slice(0,5)&&(_=mv(_,this.appendSource)),this.log(`switching codec ${g} to ${_}`),_!==(f.pendingCodec||f.codec)&&(f.pendingCodec=_),f.container=c,this.appendChangeType(e,c,_))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),this.sourceBufferCount||this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const n=this.tracks[t];return e[t]={id:n.id,container:n.container,codec:n.codec,levelCodec:n.levelCodec},e},{})}appendChangeType(e,t,n){const r=`${t};codecs=${n}`,i={label:`change-type=${r}`,execute:()=>{const i=this.tracks[e];if(i){const s=i.buffer;null!=s&&s.changeType&&(this.log(`changing ${e} sourceBuffer type to ${r}`),s.changeType(r),i.codec=n,i.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn(`Failed to change ${e} SourceBuffer type`,t)}};this.append(i,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const n=e.start,r=n+.05*e.duration;if(!0===(null==(t=this.fragmentTracker.getAppendedFrag(n,Zm.MAIN))?void 0:t.gap))return;const i={label:"block-audio",execute:()=>{var e;const t=this.tracks.video;(this.lastVideoAppendEnd>r||null!=t&&t.buffer&&My.isBuffered(t.buffer,r)||!0===(null==(e=this.fragmentTracker.getAppendedFrag(r,Zm.MAIN))?void 0:e.gap))&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:e=>{this.warn("Error executing block-audio operation",e)}};this.blockedAudioAppend={op:i,frag:e},this.append(i,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:n}=this,{data:r,type:i,parent:s,frag:a,part:o,chunkMeta:l,offset:u}=t,c=l.buffering[i],{sn:d,cc:h}=a,f=self.performance.now();c.start=f;const p=a.stats.buffering,m=o?o.stats.buffering:null;0===p.start&&(p.start=f),m&&0===m.start&&(m.start=f);const g=n.audio;let v=!1;"audio"===i&&"audio/mpeg"===(null==g?void 0:g.container)&&(v=!this.lastMpegAudioChunk||1===l.id||this.lastMpegAudioChunk.sn!==l.sn,this.lastMpegAudioChunk=l);const y=n.video,b=null==y?void 0:y.buffer;if(b&&"initSegment"!==d){const e=o||a,t=this.blockedAudioAppend;if("audio"!==i||"main"===s||this.blockedAudioAppend){if("video"===i){const n=e.end;if(t){const e=t.frag.start;(n>e||n<this.lastVideoAppendEnd||My.isBuffered(b,e))&&this.unblockAudio()}this.lastVideoAppendEnd=n}}else{const t=e.start+.05*e.duration,n=b.buffered,r=this.currentOp("video");n.length||r?!r&&!My.isBuffered(b,t)&&this.lastVideoAppendEnd<t&&this.blockAudio(e):this.blockAudio(e)}}const _=(o||a).start,x={label:`append-${i}`,execute:()=>{var e;c.executeStart=self.performance.now();const t=null==(e=this.tracks[i])?void 0:e.buffer;t&&(v?this.updateTimestampOffset(t,_,.1,i,d,h):void 0!==u&&Gm(u)&&this.updateTimestampOffset(t,u,1e-6,i,d,h)),this.appendExecutor(r,i)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();c.executeEnd=c.end=e,0===p.first&&(p.first=e),m&&0===m.first&&(m.first=e);const t={};this.sourceBuffers.forEach(([e,n])=>{e&&(t[e]=My.getBuffered(n))}),this.appendErrors[i]=0,"audio"===i||"video"===i?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(qm.BUFFER_APPENDED,{type:i,frag:a,part:o,chunkMeta:l,parent:a.type,timeRanges:t})},onError:e=>{var t;const n={type:Wm.MEDIA_ERROR,parent:a.type,details:jm.BUFFER_APPEND_ERROR,sourceBufferName:i,frag:a,part:o,chunkMeta:l,error:e,err:e,fatal:!1},r=null==(t=this.media)?void 0:t.error;if(e.code===DOMException.QUOTA_EXCEEDED_ERR||"QuotaExceededError"==e.name||"quota"in e)n.details=jm.BUFFER_FULL_ERROR;else if(e.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!r)n.errorAction=iy(!0);else if(e.name===Px&&0===this.sourceBufferCount)n.errorAction=iy(!0);else{const e=++this.appendErrors[i];this.warn(`Failed ${e}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${i}" sourceBuffer (${r||"no media error"})`),(e>=this.hls.config.appendErrorMaxRetry||r)&&(n.fatal=!0)}this.hls.trigger(qm.ERROR,n)}};this.append(x,i,this.isPending(this.tracks[i]))}getFlushOp(e,t,n){return this.log(`queuing "${e}" remove ${t}-${n}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,n)},onStart:()=>{},onComplete:()=>{this.hls.trigger(qm.BUFFER_FLUSHED,{type:e})},onError:r=>{this.warn(`Failed to remove ${t}-${n} from "${e}" SourceBuffer`,r)}}}onBufferFlushing(e,t){const{type:n,startOffset:r,endOffset:i}=t;n?this.append(this.getFlushOp(n,r,i),n):this.sourceBuffers.forEach(([e])=>{e&&this.append(this.getFlushOp(e,r,i),e)})}onFragParsed(e,t){const{frag:n,part:r}=t,i=[],s=r?r.elementaryStreams:n.elementaryStreams;s[Cg]?i.push("audiovideo"):(s[Mg]&&i.push("audio"),s[Rg]&&i.push("video"));0===i.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${n.type} level: ${n.level} sn: ${n.sn}`),this.blockBuffers(()=>{const e=self.performance.now();n.stats.buffering.end=e,r&&(r.stats.buffering.end=e);const t=r?r.stats:n.stats;this.hls.trigger(qm.FRAG_BUFFERED,{frag:n,part:r,stats:t,id:n.type})},i).catch(e=>{this.warn(`Fragment buffered callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t,n;return e&&(!(null!=(t=this.tracks[e])&&t.ended)||(null==(n=this.tracks[e])?void 0:n.ending))})}onBufferEos(e,t){var n;this.sourceBuffers.forEach(([e])=>{if(e){const n=this.tracks[e];t.type&&t.type!==e||(n.ending=!0,n.ended||(n.ended=!0,this.log(`${e} buffer reached EOS`)))}});const r=!1!==(null==(n=this.overrides)?void 0:n.endOfStream);this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t;return e&&!(null!=(t=this.tracks[e])&&t.ended)})&&(r?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:e}=this;e&&"open"===e.readyState?(this.log("Calling mediaSource.endOfStream()"),e.endOfStream(),this.hls.trigger(qm.BUFFERED_TO_END,void 0)):e&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${e.readyState}`)})):(this.tracksEnded(),this.hls.trigger(qm.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(null!==e){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{const e=this.getDurationAndRange();e&&this.updateMediaSource(e)})}onError(e,t){if(t.details===jm.BUFFER_APPEND_ERROR&&t.frag){var n;const e=null==(n=t.errorAction)?void 0:n.nextAutoLevel;Gm(e)&&e!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:n}=this;if(!n||null===t)return;if(!this.sourceBufferCount)return;const r=e.config,i=n.currentTime,s=t.levelTargetDuration,a=t.live&&null!==r.liveBackBufferLength?r.liveBackBufferLength:r.backBufferLength;if(Gm(a)&&a>=0){const e=Math.max(a,s),t=Math.floor(i/s)*s-e;this.flushBackBuffer(i,s,t)}if(Gm(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){const e=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),t=Math.max(e,s),n=Math.floor(i/s)*s+t;this.flushFrontBuffer(i,s,n)}}flushBackBuffer(e,t,n){this.sourceBuffers.forEach(([e,t])=>{if(t){const i=My.getBuffered(t);if(i.length>0&&n>i.start(0)){var r;this.hls.trigger(qm.BACK_BUFFER_REACHED,{bufferEnd:n});const t=this.tracks[e];if(null!=(r=this.details)&&r.live)this.hls.trigger(qm.LIVE_BACK_BUFFER_REACHED,{bufferEnd:n});else if(null!=t&&t.ended)return void this.log(`Cannot flush ${e} back buffer while SourceBuffer is in ended state`);this.hls.trigger(qm.BUFFER_FLUSHING,{startOffset:0,endOffset:n,type:e})}}})}flushFrontBuffer(e,t,n){this.sourceBuffers.forEach(([t,r])=>{if(r){const i=My.getBuffered(r),s=i.length;if(s<2)return;const a=i.start(s-1),o=i.end(s-1);if(n>a||e>=a&&e<=o)return;this.hls.trigger(qm.BUFFER_FLUSHING,{startOffset:a,endOffset:1/0,type:t})}})}getDurationAndRange(){var e;const{details:t,mediaSource:n}=this;if(!t||!this.media||"open"!==(null==n?void 0:n.readyState))return null;const r=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&t.live&&n.setLiveSeekableRange){const e=Math.max(0,t.fragmentStart);return{duration:1/0,start:e,end:Math.max(e,r)}}return{duration:1/0}}const i=null==(e=this.overrides)?void 0:e.duration;if(i)return Gm(i)?{duration:i}:null;const s=this.media.duration;return r>(Gm(n.duration)?n.duration:0)&&r>s||!Gm(s)?{duration:r}:null}updateMediaSource({duration:e,start:t,end:n}){const r=this.mediaSource;this.media&&r&&"open"===r.readyState&&(r.duration!==e&&(Gm(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),r.duration=e),void 0!==t&&void 0!==n&&(this.log(`MediaSource duration is set to ${r.duration}. Setting seekable range to ${t}-${n}.`),r.setLiveSeekableRange(t,n)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:n}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${kv(n)}`),this.tracksReady){var r;const e=null==(r=this.transferData)?void 0:r.tracks;e&&Object.keys(e).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,n])=>{if(t){const r=this.tracks[t];e[t]={buffer:n,container:r.container,codec:r.codec,supplemental:r.supplemental,levelCodec:r.levelCodec,id:r.id,metadata:r.metadata}}}),this.hls.trigger(qm.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([e])=>{this.executeNext(e)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:n}=this;if(!n)throw new Error("createSourceBuffers called when mediaSource was null");for(const i in e){const s=i,a=e[s];if(this.isPending(a)){const e=this.getTrackCodec(a,s),i=`${a.container};codecs=${e}`;a.codec=e,this.log(`creating sourceBuffer(${i})${this.currentOp(s)?" Queued":""} ${kv(a)}`);try{const e=n.addSourceBuffer(i),r=Ox(s),o=[s,e];t[r]=o,a.buffer=e}catch(e){var r;return this.error(`error while trying to add sourceBuffer: ${e.message}`),this.shiftAndExecuteNext(s),null==(r=this.operationQueue)||r.removeBlockers(),delete this.tracks[s],void this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,sourceBufferName:s,mimeType:i,parent:a.id})}this.trackSourceBuffer(s,a)}}this.bufferCreated()}getTrackCodec(e,t){const n=e.supplemental;let r=e.codec;n&&("video"===t||"audiovideo"===t)&&lv(n,"video")&&(r=function(e,t){const n=[];if(e){const t=e.split(",");for(let e=0;e<t.length;e++)ov(t[e],"video")||n.push(t[e])}return t&&n.push(t),n.join(",")}(r,n));const i=gv(r,e.levelCodec);return i?"audio"===t.slice(0,5)?mv(i,this.appendSource):i:""}trackSourceBuffer(e,t){const n=t.buffer;if(!n)return;const r=this.getTrackCodec(t,e);this.tracks[e]={buffer:n,codec:r,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(e,t)=>{const n=t.removedRanges;null!=n&&n.length&&this.hls.trigger(qm.BUFFER_FLUSHED,{type:e})})}get mediaSrc(){var e,t;const n=(null==(e=this.media)||null==(t=e.querySelector)?void 0:t.call(e,"source"))||this.media;return null==n?void 0:n.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if("closed"===(null==(t=this.mediaSource)?void 0:t.readyState))return void this.resetBuffer(e);const n=this.currentOp(e);n&&(n.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var n;const r=new Error(`${e} SourceBuffer error. MediaSource readyState: ${null==(n=this.mediaSource)?void 0:n.readyState}`);this.error(`${r}`,t),this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:r,fatal:!1});const i=this.currentOp(e);i&&i.onError(r)}updateTimestampOffset(e,t,n,r,i,s){const a=t-e.timestampOffset;Math.abs(a)>=n&&(this.log(`Updating ${r} SourceBuffer timestampOffset to ${t} (sn: ${i} cc: ${s})`),e.timestampOffset=t)}removeExecutor(e,t,n){const{media:r,mediaSource:i}=this,s=this.tracks[e],a=null==s?void 0:s.buffer;if(!r||!i||!a)return this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void this.shiftAndExecuteNext(e);const o=Gm(r.duration)?r.duration:1/0,l=Gm(i.duration)?i.duration:1/0,u=Math.max(0,t),c=Math.min(n,o,l);c>u&&(!s.ending||s.ended)?(s.ended=!1,this.log(`Removing [${u},${c}] from the ${e} SourceBuffer`),a.remove(u,c)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const n=this.tracks[t],r=null==n?void 0:n.buffer;if(!r)throw new Nx(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);n.ending=!1,n.ended=!1,r.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(e=>{this.warn(`SourceBuffer blocked callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(e){this.warn(`Callback run without blocking ${this.operationQueue} ${e}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:n}=this,r=t.map(e=>this.appendBlocker(e));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(r).then(t=>{n===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(e=>{var t;const n=null==(t=this.tracks[e])?void 0:t.buffer;n&&!n.updating&&this.shiftAndExecuteNext(e)})}append(e,t,n){this.operationQueue&&this.operationQueue.append(e,t,n)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,n){const r=this.tracks[e];if(!r)return;const i=r.buffer;if(!i)return;const s=n.bind(this,e);r.listeners.push({event:t,listener:s}),i.addEventListener(t,s)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const n=t.buffer;n&&(t.listeners.forEach(e=>{n.removeEventListener(e.event,e.listener)}),t.listeners.length=0)}}function kx(e){const t=e.querySelectorAll("source");[].slice.call(t).forEach(t=>{e.removeChild(t)})}function Ox(e){return"audio"===e?1:0}class Fx{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(qm.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.on(qm.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(qm.BUFFER_CODECS,this.onBufferCodecs,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(qm.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.off(qm.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(qm.BUFFER_CODECS,this.onBufferCodecs,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const n=this.hls.levels[t.droppedLevel];this.isLevelAllowed(n)&&this.restrictedLevels.push({bitrate:n.bitrate,height:n.height,width:n.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const n=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,n.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&Gm(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const e=this.hls.levels;if(e.length){const t=this.hls,n=this.getMaxLevel(e.length-1);n!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${n}: ${e[n].height}p@${e[n].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=n,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const n=t.filter((t,n)=>this.isLevelAllowed(t)&&n<=e);return this.clientRect=null,Fx.getMaxLevelByMediaSize(n,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const n=e.getBoundingClientRect();t.width=n.width,t.height=n.height,t.width||t.height||(t.width=n.right-n.left||e.width||0,t.height=n.bottom-n.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(e){}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height)}static getMaxLevelByMediaSize(e,t,n){if(null==e||!e.length)return-1;const r=(e,t)=>!t||(e.width!==t.width||e.height!==t.height);let i=e.length-1;const s=Math.max(t,n);for(let t=0;t<e.length;t+=1){const n=e[t];if((n.width>=s||n.height>=s)&&r(n,e[t+1])){i=t;break}}return i}}const Ux={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},Bx={HLS:"h"},Vx="CMCD-Object",zx="CMCD-Request",Gx="CMCD-Session",Hx="CMCD-Status",$x={[Vx]:["br","ab","d","ot","tb","tpb","lb","tab","lab","url"],[zx]:["pb","bl","tbl","dl","ltc","mtp","nor","nrr","rc","sn","sta","su","ttfb","ttfbb","ttlb","cmsdd","cmsds","smrt","df","cs"],[Gx]:["cid","pr","sf","sid","st","v","msd"],[Hx]:["bs","bsd","cdn","rtp","bg","pt","ec","e"]};class Wx{constructor(e,t){Array.isArray(e)&&(e=e.map(e=>e instanceof Wx?e:new Wx(e))),this.value=e,this.params=t}}function jx(e,t,n,r){return new Error(`failed to ${e} "${i=t,Array.isArray(i)?JSON.stringify(i):i instanceof Map?"Map{}":i instanceof Set?"Set{}":"object"==typeof i?JSON.stringify(i):String(i)}" as ${n}`,{cause:r});var i}function qx(e,t,n){return jx("serialize",e,t,n)}class Xx{constructor(e){this.description=e}}const Yx="Bare Item";function Kx(e){if(!1===ArrayBuffer.isView(e))throw qx(e,"Byte Sequence");return`:${t=e,btoa(String.fromCharCode(...t))}:`;var t}function Qx(e){if(function(e){return e<-999999999999999||999999999999999<e}(e))throw qx(e,"Integer");return e.toString()}function Zx(e,t){if(e<0)return-Zx(-e,t);const n=Math.pow(10,t);if(Math.abs(e*n%1-.5)<Number.EPSILON){const t=Math.floor(e*n);return(t%2==0?t:t+1)/n}return Math.round(e*n)/n}function Jx(e){const t=Zx(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw qx(e,"Decimal");const n=t.toString();return n.includes(".")?n:`${n}.0`}const eS=/[\x00-\x1f\x7f]+/;function tS(e){const t=(n=e).description||n.toString().slice(7,-1);var n;if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t))throw qx(t,"Token");return t}function nS(e){switch(typeof e){case"number":if(!Gm(e))throw qx(e,Yx);return Number.isInteger(e)?Qx(e):Jx(e);case"string":return function(e){if(eS.test(e))throw qx(e,"String");return`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}(e);case"symbol":return tS(e);case"boolean":return function(e){if("boolean"!=typeof e)throw qx(e,"Boolean");return e?"?1":"?0"}(e);case"object":if(e instanceof Date)return function(e){return`@${Qx(e.getTime()/1e3)}`}(e);if(e instanceof Uint8Array)return Kx(e);if(e instanceof Xx)return tS(e);default:throw qx(e,Yx)}}function rS(e){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(e))throw qx(e,"Key");return e}function iS(e){return null==e?"":Object.entries(e).map(([e,t])=>!0===t?`;${rS(e)}`:`;${rS(e)}=${nS(t)}`).join("")}function sS(e){return e instanceof Wx?`${nS(e.value)}${iS(e.params)}`:nS(e)}function aS(e,t={whitespace:!0}){if("object"!=typeof e)throw qx(e,"Dict");const n=e instanceof Map?e.entries():Object.entries(e),r=(null==t?void 0:t.whitespace)?" ":"";return Array.from(n).map(([e,t])=>{t instanceof Wx==!1&&(t=new Wx(t));let n=rS(e);var r;return!0===t.value?n+=iS(t.params):(n+="=",Array.isArray(t.value)?n+=`(${(r=t).value.map(sS).join(" ")})${iS(r.params)}`:n+=sS(t)),n}).join(`,${r}`)}const oS=e=>Math.round(e),lS=e=>100*oS(e/100),uS={br:oS,d:oS,bl:lS,dl:lS,mtp:lS,nor:(e,t)=>((null==t?void 0:t.baseUrl)&&(e=function(e,t){const n=new URL(e),r=new URL(t);if(n.origin!==r.origin)return e;const i=n.pathname.split("/").slice(1),s=r.pathname.split("/").slice(1,-1);for(;i[0]===s[0];)i.shift(),s.shift();for(;s.length;)s.shift(),i.unshift("..");return i.join("/")}(e,t.baseUrl)),encodeURIComponent(e)),rtp:lS,tb:oS};function cS(e,t){const n={};if(null==e||"object"!=typeof e)return n;const r=Object.keys(e).sort(),i=ng({},uS,null==t?void 0:t.formatters),s=null==t?void 0:t.filter;return r.forEach(r=>{if(!1===(null==s?void 0:s(r)))return;let a=e[r];const o=i[r];o&&(a=o(a,t)),"v"===r&&1===a||"pr"==r&&1===a||function(e){return"number"==typeof e?Gm(e):null!=e&&""!==e&&!1!==e}(a)&&(function(e){return["ot","sf","st","e","sta"].includes(e)}(r)&&"string"==typeof a&&(a=new Xx(a)),n[r]=a)}),n}function dS(e,t={}){return e?function(e,t){return aS(e,t)}(cS(e,t),ng({whitespace:!1},t)):""}function hS(e,t,n){return ng(e,function(e,t={}){const n={};if(!e)return n;const r=Object.entries(e),i=Object.entries($x).concat(Object.entries((null==t?void 0:t.customHeaderMap)||{})),s=r.reduce((e,t)=>{var n,r;const[s,a]=t,o=(null===(n=i.find(e=>e[1].includes(s)))||void 0===n?void 0:n[0])||zx;return null!==(r=e[o])&&void 0!==r||(e[o]={}),e[o][s]=a,e},{});return Object.entries(s).reduce((e,[n,r])=>(e[n]=dS(r,t),e),n)}(t,n))}const fS=/CMCD=[^&#]+/;function pS(e,t,n){const r=function(e,t={}){if(!e)return"";const n=dS(e,t);return`CMCD=${encodeURIComponent(n)}`}(t,n);if(!r)return e;if(fS.test(e))return e.replace(fS,r);const i=e.includes("?")?"&":"?";return`${e}${i}${r}`}class mS{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:Ux.MANIFEST,su:!this.initialized})}catch(e){this.hls.logger.warn("Could not generate manifest CMCD data.",e)}},this.applyFragmentData=e=>{try{const{frag:t,part:n}=e,r=this.hls.levels[t.level],i=this.getObjectType(t),s={d:1e3*(n||t).duration,ot:i};i!==Ux.VIDEO&&i!==Ux.AUDIO&&i!=Ux.MUXED||(s.br=r.bitrate/1e3,s.tb=this.getTopBandwidth(i)/1e3,s.bl=this.getBufferLength(i));const a=n?this.getNextPart(n):this.getNextFrag(t);null!=a&&a.url&&a.url!==t.url&&(s.nor=a.url),this.apply(e,s)}catch(e){this.hls.logger.warn("Could not generate segment CMCD data.",e)}},this.hls=e;const t=this.config=e.config,{cmcd:n}=t;null!=n&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=n.sessionId||e.sessionId,this.cid=n.contentId,this.useHeaders=!0===n.useHeaders,this.includeKeys=n.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(qm.MEDIA_DETACHED,this.onMediaDetached,this),e.on(qm.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(qm.MEDIA_DETACHED,this.onMediaDetached,this),e.off(qm.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var n,r;this.audioBuffer=null==(n=t.tracks.audio)?void 0:n.buffer,this.videoBuffer=null==(r=t.tracks.video)?void 0:r.buffer}createData(){var e;return{v:1,sf:Bx.HLS,sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){ng(t,this.createData());const n=t.ot===Ux.INIT||t.ot===Ux.VIDEO||t.ot===Ux.MUXED;this.starved&&n&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering);const{includeKeys:r}=this;r&&(t=Object.keys(t).reduce((e,n)=>(r.includes(n)&&(e[n]=t[n]),e),{}));const i={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),hS(e.headers,t,i)):e.url=pS(e.url,t,i)}getNextFrag(e){var t;const n=null==(t=this.hls.levels[e.level])?void 0:t.details;if(n){const t=e.sn-n.startSN;return n.fragments[t+1]}}getNextPart(e){var t,n;const{index:r,fragment:i}=e,s=null==(t=this.hls.levels[i.level])||null==(n=t.details)?void 0:n.partList;if(s){const{sn:e}=i;for(let t=s.length-1;t>=0;t--){const n=s[t];if(n.index===r&&n.fragment.sn===e)return s[t+1]}}}getObjectType(e){const{type:t}=e;return"subtitle"===t?Ux.TIMED_TEXT:"initSegment"===e.sn?Ux.INIT:"audio"===t?Ux.AUDIO:"main"===t?this.hls.audioTracks.length?Ux.VIDEO:Ux.MUXED:void 0}getTopBandwidth(e){let t,n=0;const r=this.hls;if(e===Ux.AUDIO)t=r.audioTracks;else{const e=r.maxAutoLevel,n=e>-1?e+1:r.levels.length;t=r.levels.slice(0,n)}return t.forEach(e=>{e.bitrate>n&&(n=e.bitrate)}),n>0?n:NaN}getBufferLength(e){const t=this.media,n=e===Ux.AUDIO?this.audioBuffer:this.videoBuffer;if(!n||!t)return NaN;return 1e3*My.bufferInfo(n,t.currentTime,this.config.maxBufferHole).len}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,n=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new n(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,r){t(e),this.loader.load(e,n,r)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,n=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new n(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,r){t(e),this.loader.load(e,n,r)}}}}class gS extends sg{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.on(qm.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.off(qm.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=1e3*this.timeToLoad-(performance.now()-this.updated);if(e>0)return void this.scheduleRefresh(this.uri,e)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(t=>t!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:n}=t;null!==n&&(this.pathwayId=n.pathwayId,this.uri=n.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:n}=t;if((null==n?void 0:n.action)===ty.SendAlternateToPenaltyBox&&n.flags===ny.MoveAllAlternatesMatchingHost){const e=this.levels;let r=this._pathwayPriority,i=this.pathwayId;if(t.context){const{groupId:n,pathwayId:r,type:s}=t.context;n&&e?i=this.getPathwayForGroupId(n,s,i):r&&(i=r)}i in this.penalizedPathways||(this.penalizedPathways[i]=performance.now()),!r&&e&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),n.resolved=this.pathwayId!==i),t.details!==jm.BUFFER_APPEND_ERROR||t.fatal?n.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${i} levels: ${e?e.length:e} priorities: ${kv(r)} penalized: ${kv(this.penalizedPathways)}`):n.resolved=!0}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){const n=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${n}"`),t=this.getLevelsForPathway(n),this.pathwayId=n}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return null===this.levels?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){let t;this._pathwayPriority=e;const n=this.penalizedPathways,r=performance.now();Object.keys(n).forEach(e=>{r-n[e]>3e5&&delete n[e]});for(let r=0;r<e.length;r++){const i=e[r];if(i in n)continue;if(i===this.pathwayId)return;const s=this.hls.nextLoadLevel,a=this.hls.levels[s];if(t=this.getLevelsForPathway(i),t.length>0){this.log(`Setting Pathway to "${i}"`),this.pathwayId=i,Rb(t),this.hls.trigger(qm.LEVELS_UPDATED,{levels:t});const e=this.hls.levels[s];a&&e&&this.levels&&(e.attrs["STABLE-VARIANT-ID"]!==a.attrs["STABLE-VARIANT-ID"]&&e.bitrate!==a.bitrate&&this.log(`Unstable Pathways change from bitrate ${a.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=s);break}}}getPathwayForGroupId(e,t,n){const r=this.getLevelsForPathway(n).concat(this.levels||[]);for(let n=0;n<r.length;n++)if(t===Km&&r[n].hasAudioGroup(e)||t===Qm&&r[n].hasSubtitleGroup(e))return r[n].pathwayId;return n}clonePathways(e){const t=this.levels;if(!t)return;const n={},r={};e.forEach(e=>{const{ID:i,"BASE-ID":s,"URI-REPLACEMENT":a}=e;if(t.some(e=>e.pathwayId===i))return;const o=this.getLevelsForPathway(s).map(e=>{const t=new ky(e.attrs);t["PATHWAY-ID"]=i;const s=t.AUDIO&&`${t.AUDIO}_clone_${i}`,o=t.SUBTITLES&&`${t.SUBTITLES}_clone_${i}`;s&&(n[t.AUDIO]=s,t.AUDIO=s),o&&(r[t.SUBTITLES]=o,t.SUBTITLES=o);const l=yS(e.uri,t["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",a),u=new Pv({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:l,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(let t=1;t<e.audioGroups.length;t++)u.addGroupId("audio",`${e.audioGroups[t]}_clone_${i}`);if(e.subtitleGroups)for(let t=1;t<e.subtitleGroups.length;t++)u.addGroupId("text",`${e.subtitleGroups[t]}_clone_${i}`);return u});t.push(...o),vS(this.audioTracks,n,a,i),vS(this.subtitleTracks,r,a,i)})}loadSteeringManifest(e){const t=this.hls.config,n=t.loader;let r;this.loader&&this.loader.destroy(),this.loader=new n(t);try{r=new self.URL(e)}catch(t){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${e}`)}if("data:"!==r.protocol){const e=0|(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate);r.searchParams.set("_HLS_pathway",this.pathwayId),r.searchParams.set("_HLS_throughput",""+e)}const i={responseType:"json",url:r.href},s=t.steeringManifestLoadPolicy.default,a=s.errorRetry||s.timeoutRetry||{},o={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(e,t,n,i)=>{this.log(`Loaded steering manifest: "${r}"`);const s=e.data;if(1!==(null==s?void 0:s.VERSION))return void this.log(`Steering VERSION ${s.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=s.TTL;const{"RELOAD-URI":a,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":l}=s;if(a)try{this.uri=new self.URL(a,r).href}catch(e){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${a}`)}this.scheduleRefresh(this.uri||n.url),o&&this.clonePathways(o);const u={steeringManifest:s,url:r.toString()};this.hls.trigger(qm.STEERING_MANIFEST_LOADED,u),l&&this.updatePathwayPriority(l)},onError:(e,t,n,r)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),410===e.code)return this.enabled=!1,void this.log(`Steering manifest ${t.url} no longer available`);let i=1e3*this.timeToLoad;if(429===e.code){const e=this.loader;if("function"==typeof(null==e?void 0:e.getResponseHeader)){const t=e.getResponseHeader("Retry-After");t&&(i=1e3*parseFloat(t))}return void this.log(`Steering manifest ${t.url} rate limited`)}this.scheduleRefresh(this.uri||t.url,i)},onTimeout:(e,t,n)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}};this.log(`Requesting steering manifest: ${r}`),this.loader.load(i,o,l)}scheduleRefresh(e,t=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var t;const n=null==(t=this.hls)?void 0:t.media;!n||n.ended?this.scheduleRefresh(e,1e3*this.timeToLoad):this.loadSteeringManifest(e)},t)}}function vS(e,t,n,r){e&&Object.keys(t).forEach(i=>{const s=e.filter(e=>e.groupId===i).map(e=>{const s=ng({},e);return s.details=void 0,s.attrs=new ky(s.attrs),s.url=s.attrs.URI=yS(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",n),s.groupId=s.attrs["GROUP-ID"]=t[i],s.attrs["PATHWAY-ID"]=r,s});e.push(...s)})}function yS(e,t,n,r){const{HOST:i,PARAMS:s,[n]:a}=r;let o;t&&(o=null==a?void 0:a[t],o&&(e=o));const l=new self.URL(e);return i&&!o&&(l.host=i),s&&Object.keys(s).sort().forEach(e=>{e&&l.searchParams.set(e,s[e])}),l.href}function bS(e,t,n){_S(e,t,n),e.addEventListener(t,n)}function _S(e,t,n){e.removeEventListener(t,n)}class xS extends sg{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=xS.CDMCleanupPromise?[xS.CDMCleanupPromise]:[],this.onWaitingForKey=e=>{this.log(`"${e.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onWaitingForKey=null}registerListeners(){this.hls.on(qm.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(qm.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(qm.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(qm.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(qm.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(qm.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(qm.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(qm.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:n}=this.config,r=t[e];return r?r.licenseUrl:e===jy.WIDEVINE&&n?n:void 0}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(void 0===t)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,n=t[e];if(n)return n.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,n=(e,t,n)=>!!e&&n.indexOf(e)===t,r=t.map(e=>e.audioCodec).filter(n),i=t.map(e=>e.videoCodec).filter(n);return r.length+i.length===0&&i.push("avc1.42e01e"),new Promise((t,n)=>{const s=e=>{const a=e.shift();this.getMediaKeysPromise(a,r,i).then(e=>t({keySystem:a,mediaKeys:e})).catch(t=>{e.length?s(e):n(t instanceof SS?t:new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))})};s(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:n}=this.config;if("function"!=typeof n){let e=`Configured requestMediaKeySystemAccess is not a function ${n}`;return null===Qy&&"http:"===self.location.protocol&&(e=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(e))}return n(e,t)}getMediaKeysPromise(e,t,n){const r=function(e,t,n,r){let i;switch(e){case jy.FAIRPLAY:i=["cenc","sinf"];break;case jy.WIDEVINE:case jy.PLAYREADY:i=["cenc"];break;case jy.CLEARKEY:i=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${e}`)}return function(e,t,n,r){return[{initDataTypes:e,persistentState:r.persistentState||"optional",distinctiveIdentifier:r.distinctiveIdentifier||"optional",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:t.map(e=>({contentType:`audio/mp4; codecs=${e}`,robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null})),videoCapabilities:n.map(e=>({contentType:`video/mp4; codecs=${e}`,robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null}))}]}(i,t,n,r)}(e,t,n,this.config.drmSystemOptions),i=this.keySystemAccessPromises[e];let s=null==i?void 0:i.keySystemAccess;if(!s){this.log(`Requesting encrypted media "${e}" key-system access with config: ${kv(r)}`),s=this.requestMediaKeySystemAccess(e,r);const t=this.keySystemAccessPromises[e]={keySystemAccess:s};return s.catch(t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)}),s.then(n=>{this.log(`Access for key-system "${n.keySystem}" obtained`);const r=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),t.mediaKeys=n.createMediaKeys().then(n=>(this.log(`Media-keys created for "${e}"`),t.hasMediaKeys=!0,r.then(t=>t?this.setMediaKeysServerCertificate(n,e,t):n))),t.mediaKeys.catch(t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)}),t.mediaKeys})}return s.then(()=>i.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:n}){this.log(`Creating key-system session "${t}" keyId: ${mg(e.keyId||[])}`);const r=n.createSession(),i={decryptdata:e,keySystem:t,mediaKeys:n,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(i),i}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const n=this.createMediaKeySessionContext(e),r=this.getKeyIdString(t),i="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(n,i,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return mg(e.keyId)}updateKeySession(e,t){var n;const r=e.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${mg((null==(n=e.decryptdata)?void 0:n.keyId)||[])}\n      } (data length: ${t?t.byteLength:t})`),r.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>Yy(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:e,mediaKeys:t})=>this.attemptSetMediaKeys(e,t))}selectKeySystem(e){return new Promise((t,n)=>this.getKeySystemSelectionPromise(e).then(({keySystem:e})=>{const r=Yy(e);r?t(r):n(new Error(`Unable to find format for key-system "${e}"`))}).catch(n))}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=Ky(this.config),n=e.map(Xy).filter(e=>!!e&&-1!==t.indexOf(e));return this.selectKeySystem(n)}loadKey(e){const t=e.keyInfo.decryptdata,n=this.getKeyIdString(t),r=`(keyId: ${n} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${r}`);let i=this.keyIdToKeySessionPromise[n];if(!i){i=this.getKeySystemForKeyPromise(t).then(({keySystem:n,mediaKeys:i})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${r}`),this.attemptSetMediaKeys(n,i).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:n,mediaKeys:i,decryptdata:t})))));(this.keyIdToKeySessionPromise[n]=i.then(e=>{const n=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(e,"cenc",n,"playlist-key")})).catch(e=>this.handleError(e))}return i}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof SS?this.hls.trigger(qm.ERROR,e.data):this.hls.trigger(qm.ERROR,{type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),n=this.keyIdToKeySessionPromise[t];if(!n){const t=Xy(e.keyFormat),n=t?[t]:Ky(this.config);return this.attemptKeySystemAccess(n)}return n}getKeySystemSelectionPromise(e){if(e.length||(e=Ky(this.config)),0===e.length)throw new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${kv({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaKeys===t)return Promise.resolve();const n=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const r=Promise.all(n).then(()=>{if(!this.media)throw this.mediaKeys=null,new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.mediaKeys=t,this.setMediaKeysQueue.push(r),r.then(()=>{this.log(`Media-keys set for "${e}"`),n.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(e=>-1===n.indexOf(e))})}generateRequestWithPreferredKeySession(e,t,n,r){var i,s;const a=null==(i=this.config.drmSystems)||null==(s=i[e.keySystem])?void 0:s.generateRequest;if(a)try{const r=a.call(this.hls,t,n,e);if(!r)throw new Error("Invalid response from configured generateRequest filter");t=r.initDataType,n=r.initData?r.initData:null,e.decryptdata.pssh=n?new Uint8Array(n):null}catch(e){var o;if(this.warn(e.message),null!=(o=this.hls)&&o.config.debug)throw e}if(null===n)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(e);const l=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${r}": ${l} (init data type: ${t} length: ${n?n.byteLength:null})`);const u=new Jb,c=e._onmessage=t=>{const n=e.mediaKeysSession;if(!n)return void u.emit("error",new Error("invalid state"));const{messageType:r,message:i}=t;this.log(`"${r}" message event for session "${n.sessionId}" message size: ${i.byteLength}`),"license-request"===r||"license-renewal"===r?this.renewLicense(e,i).catch(e=>{u.eventNames().length?u.emit("error",e):this.handleError(e)}):"license-release"===r?e.keySystem===jy.FAIRPLAY&&(this.updateKeySession(e,Hy("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${r}"`)},d=e._onkeystatuseschange=t=>{if(!e.mediaKeysSession)return void u.emit("error",new Error("invalid state"));this.onKeyStatusChange(e);const n=e.keyStatus;u.emit("keyStatus",n),"expired"===n&&(this.warn(`${e.keySystem} expired for key ${l}`),this.renewKeySession(e))};bS(e.mediaKeysSession,"message",c),bS(e.mediaKeysSession,"keystatuseschange",d);const h=new Promise((e,t)=>{u.on("error",t),u.on("keyStatus",n=>{n.startsWith("usable")?e():"output-restricted"===n?t(new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===n?t(new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${n}"`)):"expired"===n?t(new Error("key expired while generating request")):this.warn(`unhandled key status change "${n}"`)})});return e.mediaKeysSession.generateRequest(t,n).then(()=>{var t;this.log(`Request generated for key-session "${null==(t=e.mediaKeysSession)?void 0:t.sessionId}" keyId: ${l}`)}).catch(e=>{throw new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},`Error generating key-session request: ${e}`)}).then(()=>h).catch(t=>{throw u.removeAllListeners(),this.removeSession(e),t}).then(()=>(u.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,n)=>{if("string"==typeof n&&"object"==typeof t){const e=n;n=t,t=e}this.log(`key status change "${t}" for keyStatuses keyId: ${mg("buffer"in n?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n))} session keyId: ${mg(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,n=new(0,t.loader)(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((i,s)=>{const a={responseType:"arraybuffer",url:r},o=t.certLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(e,t,n,r)=>{i(e.data)},onError:(t,n,i,o)=>{s(new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:i,response:ig({url:a.url,data:void 0},t)},`"${e}" certificate request failed (${r}). Status: ${t.code} (${t.text})`))},onTimeout:(t,n,i)=>{s(new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:i,response:{url:a.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(e,t,n)=>{s(new Error("aborted"))}};n.load(a,l,u)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,n){return new Promise((r,i)=>{e.setServerCertificate(n).then(i=>{this.log(`setServerCertificate ${i?"success":"not supported by CDM"} (${null==n?void 0:n.byteLength}) on "${t}"`),r(e)}).catch(e=>{i(new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(t=>this.updateKeySession(e,new Uint8Array(t)).catch(e=>{throw new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))}unpackPlayReadyKeyMessage(e,t){const n=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!n.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const r=(new DOMParser).parseFromString(n,"application/xml"),i=r.querySelectorAll("HttpHeader");if(i.length>0){let t;for(let n=0,r=i.length;n<r;n++){var s,a;t=i[n];const r=null==(s=t.querySelector("name"))?void 0:s.textContent,o=null==(a=t.querySelector("value"))?void 0:a.textContent;r&&o&&e.setRequestHeader(r,o)}}const o=r.querySelector("Challenge"),l=null==o?void 0:o.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return Hy(atob(l))}setupLicenseXHR(e,t,n,r){const i=this.config.licenseXhrSetup;return i?Promise.resolve().then(()=>{if(!n.decryptdata)throw new Error("Key removed");return i.call(this.hls,e,t,n,r)}).catch(s=>{if(!n.decryptdata)throw s;return e.open("POST",t,!0),i.call(this.hls,e,t,n,r)}).then(n=>{e.readyState||e.open("POST",t,!0);return{xhr:e,licenseChallenge:n||r}}):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:r}))}requestLicense(e,t){const n=this.config.keyLoadPolicy.default;return new Promise((r,i)=>{const s=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${s}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return i(new Error("invalid state"));if(4===a.readyState)if(200===a.status){this._requestLicenseFailureCount=0;let t=a.response;this.log(`License received ${t instanceof ArrayBuffer?t.byteLength:t}`);const n=this.config.licenseResponseCallback;if(n)try{t=n.call(this.hls,a,s,e)}catch(e){this.error(e)}r(t)}else{const o=n.errorRetry,l=o?o.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)i(new SS({type:Wm.KEY_SYSTEM_ERROR,details:jm.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:s,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${s}). Status: ${a.status} (${a.statusText})`));else{const n=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${n} attempts left`),this.requestLicense(e,t).then(r,i)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,s,e,t).then(({xhr:t,licenseChallenge:n})=>{e.keySystem==jy.PLAYREADY&&(n=this.unpackPlayReadyKeyMessage(t,n)),t.send(n)})})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const n=t.media;this.media=n,bS(n,"waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(_S(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;if(this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},!this.mediaKeys&&!this.mediaKeySessions.length)return;const t=this.media,n=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,eb.clearKeyUriToKeyIdMap();const r=n.length;xS.CDMCleanupPromise=Promise.all(n.map(e=>this.removeSession(e)).concat(null==t||null==(e=t.setMediaKeys(null))?void 0:e.catch(e=>{var t;this.log(`Could not clear media keys: ${e}`),null==(t=this.hls)||t.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${e}`)})}))).catch(e=>{var t;this.log(`Could not close sessions and clear media keys: ${e}`),null==(t=this.hls)||t.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${e}`)})}).then(()=>{r&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(t&&this.config.emeEnabled&&!this.keyFormatPromise){const e=t.reduce((e,t)=>(-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e),[]);this.log(`Selecting key-system from session-keys ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:n}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),n&&n.readyState!==XMLHttpRequest.DONE&&n.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(e);r>-1&&this.mediaKeySessions.splice(r,1);const{drmSystemOptions:i}=this.config,s=function(e){var t;return"persistent-license"===e.sessionType||!(null==(t=e.sessionTypes)||!t.some(e=>"persistent-license"===e))}(i)?new Promise((e,n)=>{self.setTimeout(()=>n(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(e)}):Promise.resolve();return s.catch(e=>{var t;this.log(`Could not remove session: ${e}`),null==(t=this.hls)||t.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${e}`)})}).then(()=>t.close()).catch(e=>{var t;this.log(`Could not close session: ${e}`),null==(t=this.hls)||t.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${e}`)})})}}}xS.CDMCleanupPromise=void 0;class SS extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}class TS{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const n=this.hls.config;if(n.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),n.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,n){const r=performance.now();if(t){if(this.lastTime){const e=r-this.lastTime,i=n-this.lastDroppedFrames,s=t-this.lastDecodedFrames,a=1e3*i/e,o=this.hls;if(o.trigger(qm.FPS_DROP,{currentDropped:i,currentDecoded:s,totalDroppedFrames:n}),a>0&&i>o.config.fpsDroppedMonitoringThreshold*s){let e=o.currentLevel;o.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=e)&&(e-=1,o.trigger(qm.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:o.currentLevel}),o.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=n,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function ES(e,t){let n;try{n=new Event("addtrack")}catch(e){n=document.createEvent("Event"),n.initEvent("addtrack",!1,!1)}n.track=e,t.dispatchEvent(n)}function AS(e,t){const n=e.mode;if("disabled"===n&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(n){dg.debug(`[texttrack-utils]: ${n}`);try{const n=new self.TextTrackCue(t.startTime,t.endTime,t.text);n.id=t.id,e.addCue(n)}catch(e){dg.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${e}`)}}"disabled"===n&&(e.mode=n)}function wS(e,t){const n=e.mode;if("disabled"===n&&(e.mode="hidden"),e.cues)for(let n=e.cues.length;n--;)t&&e.cues[n].removeEventListener("enter",t),e.removeCue(e.cues[n]);"disabled"===n&&(e.mode=n)}function MS(e,t,n,r){const i=e.mode;if("disabled"===i&&(e.mode="hidden"),e.cues&&e.cues.length>0){const i=function(e,t,n){const r=[],i=function(e,t){if(t<=e[0].startTime)return 0;const n=e.length-1;if(t>e[n].endTime)return-1;let r,i=0,s=n;for(;i<=s;)if(r=Math.floor((s+i)/2),t<e[r].startTime)s=r-1;else{if(!(t>e[r].startTime&&i<n))return r;i=r+1}return e[i].startTime-t<t-e[s].startTime?i:s}(e,t);if(i>-1)for(let s=i,a=e.length;s<a;s++){const i=e[s];if(i.startTime>=t&&i.endTime<=n)r.push(i);else if(i.startTime>n)return r}return r}(e.cues,t,n);for(let t=0;t<i.length;t++)r&&!r(i[t])||e.removeCue(i[t])}"disabled"===i&&(e.mode=i)}function RS(e){const t=[];for(let n=0;n<e.length;n++){const r=e[n];"subtitles"!==r.kind&&"captions"!==r.kind||!r.label||t.push(e[n])}return t}class CS extends Ax{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const t=RS(this.media.textTracks);for(let n=0;n<t.length;n++)if("hidden"===t[n].mode)e=t[n];else if("showing"===t[n].mode){e=t[n];break}const n=this.findTrackForTextTrack(e);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.on(qm.LEVEL_LOADING,this.onLevelLoading,this),e.on(qm.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(qm.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(qm.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.off(qm.LEVEL_LOADING,this.onLevelLoading,this),e.off(qm.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(qm.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(qm.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const n=this.media;if(!n)return;const r=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||n.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,r)return;RS(n.textTracks).forEach(e=>{wS(e)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:n,groupId:r,details:i}=t,s=this.tracksInGroup[n];if(!s||s.groupId!==r)return void this.warn(`Subtitle track with id:${n} and group:${r} not found in active group ${null==s?void 0:s.groupId}`);const a=s.details;s.details=t.details,this.log(`Subtitle track ${n} "${s.name}" lang:${s.lang} group:${r} loaded [${i.startSN}-${i.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const n=t.subtitleGroups||null,r=this.groupIds;let i=this.currentTrack;if(!n||(null==r?void 0:r.length)!==(null==n?void 0:n.length)||null!=n&&n.some(e=>-1===(null==r?void 0:r.indexOf(e)))){this.groupIds=n,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter(e=>!n||-1!==n.indexOf(e.groupId));if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!i&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.subtitlePreference;if(!i&&t){this.selectDefaultTrack=!1;const n=Bv(t,e);if(n>-1)i=e[n];else{const e=Bv(t,this.tracks);i=this.tracks[e]}}let r=this.findTrackId(i);-1===r&&i&&(r=this.findTrackId(null));const s={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${null==n?void 0:n.join(",")}" group-id`),this.hls.trigger(qm.SUBTITLE_TRACKS_UPDATED,s),-1!==r&&-1===this.trackId&&this.setSubtitleTrack(r)}}findTrackId(e){const t=this.tracksInGroup,n=this.selectDefaultTrack;for(let r=0;r<t.length;r++){const i=t[r];if((!n||i.default)&&(n||e)&&(!e||Vv(i,e)))return r}if(e){for(let n=0;n<t.length;n++){const r=t[n];if(Mx(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const r=t[n];if(Mx(e.attrs,r.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let n=0;n<t.length;n++){if(Rx(t[n],e))return n}}return-1}onError(e,t){!t.fatal&&t.context&&(t.context.type!==Qm||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(-1===e.id)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const n=this.currentTrack;if(n&&Vv(e,n))return n;const r=Bv(e,this.tracksInGroup);if(r>-1){const e=this.tracksInGroup[r];return this.setSubtitleTrack(r),e}if(n)return null;{const n=Bv(e,t);if(n>-1)return t[n]}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const n=e.id,r=e.groupId,i=this.getUrlWithDirectives(e.url,t),s=e.details,a=null==s?void 0:s.age;this.log(`Loading subtitle ${n} "${e.name}" lang:${e.lang} group:${r}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${a&&s.live?" age "+a.toFixed(1)+(s.type&&" "+s.type||""):""} ${i}`),this.hls.trigger(qm.SUBTITLE_TRACK_LOADING,{url:i,id:n,groupId:r,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=RS(e.textTracks),n=this.currentTrack;let r;if(n&&(r=t.filter(e=>Rx(n,e))[0],r||this.warn(`Unable to find subtitle TextTrack with name "${n.name}" and language "${n.lang}"`)),[].slice.call(t).forEach(e=>{"disabled"!==e.mode&&e!==r&&(e.mode="disabled")}),r){const e=this.subtitleDisplay?"showing":"hidden";r.mode!==e&&(r.mode=e)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=e);if(e<-1||e>=t.length||!Gm(e))return void this.warn(`Invalid subtitle track id: ${e}`);this.selectDefaultTrack=!1;const n=this.currentTrack,r=t[e]||null;if(this.trackId=e,this.currentTrack=r,this.toggleTrackModes(),!r)return void this.hls.trigger(qm.SUBTITLE_TRACK_SWITCH,{id:e});const i=!!r.details&&!r.details.live;if(e===this.trackId&&r===n&&i)return;this.log(`Switching to subtitle-track ${e}`+(r?` "${r.name}" lang:${r.lang} group:${r.groupId}`:""));const{id:s,groupId:a="",name:o,type:l,url:u}=r;this.hls.trigger(qm.SUBTITLE_TRACK_SWITCH,{id:s,groupId:a,name:o,type:l,url:u});const c=this.switchParams(r.url,null==n?void 0:n.details,r.details);this.loadPlaylist(c)}}function IS(e){let t=5381,n=e.length;for(;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString()}const LS=.025;let PS=function(e){return e[e.Point=0]="Point",e[e.Range=1]="Range",e}({});function NS(e,t,n){return`${e.identifier}-${n+1}-${IS(t)}`}class DS{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,null==(e=this.assetListLoader)||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const n=this.playoutLimit;if(e<=0||isNaN(n))return!1;if(0===n)return!0;return((null==(t=this.assetList[e])?void 0:t.startOffset)||0)>n}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return kS(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(0===this.startTime||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime;return t-kS(t,e)<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=Gm(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return kS(e,t)}return e}get appendInPlace(){return!!this.appendInPlaceStarted||!this.appendInPlaceDisabled&&!(this.cue.once||this.cue.pre||!this.startIsAligned||!(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<LS))}set appendInPlace(e){this.appendInPlaceStarted?this.resetOnResume=!e:this.appendInPlaceDisabled=!e}get timelineStart(){return null!==this._timelineStart?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return t=null!==this._duration?this._duration:this.dateRange.duration?this.dateRange.duration:this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return"RANGE"===this.dateRange.attr["X-TIMELINE-OCCUPIES"]?PS.Range:PS.Point}get supplementsPrimary(){return"PRIMARY"===this.dateRange.attr["X-TIMELINE-STYLE"]}get contentMayVary(){return"NO"!==this.dateRange.attr["X-CONTENT-MAY-VARY"]}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||null!==this.assetListResponse}toString(){return`["${(e=this).identifier}" ${e.cue.pre?"<pre>":e.cue.post?"<post>":""}${e.timelineStart.toFixed(2)}-${e.resumeTime.toFixed(2)}]`;var e}}function kS(e,t){return e-t.start<t.duration/2&&!(Math.abs(e-(t.start+t.duration))<LS)?t.start:t.start+t.duration}function OS(e,t,n){const r=new self.URL(e,n);return"data:"!==r.protocol&&r.searchParams.set("_HLS_primary_id",t),r}function FS(e,t){for(;null!=(n=e.assetList[++t])&&n.error;)var n;return t}function US(e){const t=e.timelineStart,n=e.duration||0;return`["${e.identifier}" ${t.toFixed(2)}-${(t+n).toFixed(2)}]`}class BS{constructor(e,t,n,r){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls.trigger(qm.PLAYOUT_LIMIT_REACHED,{})};const i=this.hls=new e(t);this.interstitial=n,this.assetItem=r;let s=r.uri;try{s=OS(s,t.primarySessionId).href}catch(e){}i.loadSource(s);const a=()=>{this.hasDetails=!0};i.once(qm.LEVEL_LOADED,a),i.once(qm.AUDIO_TRACK_LOADED,a),i.once(qm.SUBTITLE_TRACK_LOADED,a),i.on(qm.MEDIA_ATTACHING,(e,{media:t})=>{this.removeMediaListeners(),this.mediaAttached=t;this.interstitial.playoutLimit&&(t.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&i.on(qm.BUFFER_APPENDED,()=>{const e=this.bufferedEnd;this.reachedPlayout(e)&&(this._bufferedEosTime=e,i.trigger(qm.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){var e;return(null==(e=this.interstitial)?void 0:e.appendInPlace)||!1}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if(null!=(t=this.hls)&&t.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;const n=this.timelineOffset,r=My.bufferInfo(e,n,0);return this.getAssetTime(r.end)>=this._bufferedEosTime-.02}reachedPlayout(e){const t=this.interstitial.playoutLimit;return this.startOffset+e>=t}get destroyed(){var e;return!(null!=(e=this.hls)&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return(null==(e=this.hls)?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=My.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;return e||0}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return(null==(e=this.hls)?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const n=e-t;if(Math.abs(n)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,n=this.duration;return Math.min(Math.max(0,e-t),n)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){var e;this.mediaAttached&&(null!=(e=this.hls)&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd))}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}resetDetails(){const e=this.hls;if(this.hasDetails){e.stopLoad();const t=e=>delete e.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,n){this.hls.on(e,t)}once(e,t,n){this.hls.once(e,t)}off(e,t,n){this.hls.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${US(this.assetItem)} ${null==(e=this.hls)?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}class VS extends sg{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((n,r)=>e<=r.startOffset&&t>r.startOffset?(delete r.error,n+1):n,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let n=-1;e.nextEvent?n=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(n=this.findEventIndex(e.previousEvent.identifier)+1);const r=this.items;if(r)for(r[n]||(void 0===t&&(t=e.start),n=this.findItemIndexAtTime(t));n>=0&&null!=(i=r[n])&&i.event;){var i;n--}return n}findItemIndexAtTime(e,t){const n=this.items;if(n)for(let r=0;r<n.length;r++){let i=n[r];if(t&&"primary"!==t&&(i=i[t]),e===i.start||e>i.start&&e<i.end)return r}return-1}findJumpRestrictedIndex(e,t){const n=this.items;if(n)for(let r=e;r<=t&&n[r];r++){const e=n[r].event;if(null!=e&&e.restrictions.jump&&!e.appendInPlace)return r}return-1}findEventIndex(e){const t=this.items;if(t)for(let r=t.length;r--;){var n;if((null==(n=t[r].event)?void 0:n.identifier)===e)return r}return-1}findAssetIndex(e,t){const n=e.assetList,r=n.length;if(r>1)for(let e=0;e<r;e++){const r=n[e];if(!r.error){const n=r.timelineStart;if(t===n||t>n&&t<n+(r.duration||0))return e}}return 0}get assetIdAtEnd(){var e,t;const n=null==(e=this.items)||null==(t=e[this.length-1])?void 0:t.event;if(n){const e=n.assetList,t=e[e.length-1];if(t)return t.identifier}return null}parseInterstitialDateRanges(e,t){const n=e.main.details,{dateRanges:r}=n,i=this.events,s=this.parseDateRanges(r,{url:n.url},t),a=Object.keys(r),o=i?i.filter(e=>!a.includes(e.identifier)):[];s.length&&s.sort((e,t)=>{const n=e.cue.pre,r=e.cue.post,i=t.cue.pre,s=t.cue.post;if(n&&!i)return-1;if(i&&!n)return 1;if(r&&!s)return 1;if(s&&!r)return-1;if(!(n||i||r||s)){const n=e.startTime,r=t.startTime;if(n!==r)return n-r}return e.dateRange.tagOrder-t.dateRange.tagOrder}),this.events=s,o.forEach(e=>{this.removeEvent(e)}),this.updateSchedule(e,o)}updateSchedule(e,t=[]){const n=this.events||[];if(n.length||t.length||this.length<2){const r=this.items,i=this.parseSchedule(n,e),s=t.length||(null==r?void 0:r.length)!==i.length||i.some((e,t)=>Math.abs(e.playout.start-r[t].playout.start)>.005||Math.abs(e.playout.end-r[t].playout.end)>.005);s&&(this.items=i,this.onScheduleUpdate(t,r))}}parseDateRanges(e,t,n){const r=[],i=Object.keys(e);for(let s=0;s<i.length;s++){const a=i[s],o=e[a];if(o.isInterstitial){let e=this.eventMap[a];e?e.setDateRange(o):(e=new DS(o,t),this.eventMap[a]=e,!1===n&&(e.appendInPlace=n)),r.push(e)}}return r}parseSchedule(e,t){const n=[],r=t.main.details,i=r.live?1/0:r.edge;let s=0;if((e=e.filter(e=>!(e.error||e.cue.once&&e.hasPlayed))).length){this.resolveOffsets(e,t);let r=0,o=0;if(e.forEach((t,a)=>{const l=t.cue.pre,u=t.cue.post,c=e[a-1]||null,d=t.appendInPlace,h=u?i:t.startOffset,f=t.duration,p=t.timelineOccupancy===PS.Range?f:0,m=t.resumptionOffset,g=(null==c?void 0:c.startTime)===h,v=h+t.cumulativeDuration;let y=d?v+f:h+m;if(l||!u&&h<=0){const e=o;o+=p,t.timelineStart=v;const r=s;s+=f,n.push({event:t,start:v,end:y,playout:{start:r,end:s},integrated:{start:e,end:o}})}else{if(!(h<=i))return;{if(!g){const i=h-r;if(i>.033){const l=r,u=o;o+=i;const c=s;s+=i;const d={previousEvent:e[a-1]||null,nextEvent:t,start:l,end:l+i,playout:{start:c,end:s},integrated:{start:u,end:o}};n.push(d)}else i>0&&c&&(c.cumulativeDuration+=i,n[n.length-1].end=h)}u&&(y=v),t.timelineStart=v;const i=o;o+=p;const l=s;s+=f,n.push({event:t,start:v,end:y,playout:{start:l,end:s},integrated:{start:i,end:o}})}}const b=t.resumeTime;r=u||b>i?i:b}),r<i){var a;const e=r,t=o,l=i-r;o+=l;const u=s;s+=l,n.push({previousEvent:(null==(a=n[n.length-1])?void 0:a.event)||null,nextEvent:null,start:r,end:e+l,playout:{start:u,end:s},integrated:{start:t,end:o}})}this.setDurations(i,s,o)}else{const e=0;n.push({previousEvent:null,nextEvent:null,start:e,end:i,playout:{start:e,end:i},integrated:{start:e,end:i}}),this.setDurations(i,i,i)}return n}setDurations(e,t,n){this.durations={primary:e,playout:t,integrated:n}}resolveOffsets(e,t){const n=t.main.details,r=n.live?1/0:n.edge;let i=0,s=-1;e.forEach((a,o)=>{const l=a.cue.pre,u=a.cue.post,c=l?0:u?r:a.startTime;this.updateAssetDurations(a);if(s===c?a.cumulativeDuration=i:(i=0,s=c),!u&&a.snapOptions.in&&(a.resumeAnchor=jv(null,n.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted){this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)}if(!a.appendInPlace&&o+1<e.length){e[o+1].startTime-e[o].resumeTime<.033&&(e[o+1].appendInPlace=!1,e[o+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`))}const d=Gm(a.resumeOffset)?a.resumeOffset:a.duration;i+=d})}primaryCanResumeInPlaceAt(e,t){const n=e.resumeTime,r=e.startTime+e.resumptionOffset;if(Math.abs(n-r)>LS)return this.log(`"${e.identifier}" resumption ${n} not aligned with estimated timeline end ${r}`),!1;if(!t)return this.log(`"${e.identifier}" resumption ${n} can not be aligned with media (none selected)`),!1;return!Object.keys(t).some(r=>{const i=t[r].details,s=i.edge;if(n>=s)return this.log(`"${e.identifier}" resumption ${n} past ${r} playlist end ${s}`),!1;const a=jv(null,i.fragments,n);if(!a)return this.log(`"${e.identifier}" resumption ${n} does not align with any fragments in ${r} playlist (${i.fragStart}-${i.fragmentEnd})`),!0;const o="audio"===r?.175:0;return!(Math.abs(a.start-n)<LS+o||Math.abs(a.end-n)<LS+o)&&(this.log(`"${e.identifier}" resumption ${n} not aligned with ${r} fragment bounds (${a.start}-${a.end} sn: ${a.sn} cc: ${a.cc})`),!0)})}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let n=0,r=!1,i=!1;e.assetList.forEach((e,s)=>{const a=t+n;e.startOffset=n,e.timelineStart=a,r||(r=null===e.duration),i||(i=!!e.error);const o=e.error?0:e.duration||0;n+=o}),e.duration=r&&!i?Math.max(n,e.duration):n}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function zS(e){return`[${e.event?'"'+e.event.identifier+'"':"primary"}: ${e.start.toFixed(2)}-${e.end.toFixed(2)}]`}class GS{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const n=e.assetListUrl;let r;try{r=OS(n,this.hls.sessionId,e.baseUrl)}catch(t){const r=this.assignAssetListError(e,jm.ASSET_LIST_LOAD_ERROR,t,n);return void this.hls.trigger(qm.ERROR,r)}t&&"data:"!==r.protocol&&r.searchParams.set("_HLS_start_offset",""+t);const i=this.hls.config,s=new(0,i.loader)(i),a={responseType:"json",url:r.href},o=i.interstitialAssetListLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(t,n,r,i)=>{const s=t.data,a=null==s?void 0:s.ASSETS;if(!Array.isArray(a)){const t=this.assignAssetListError(e,jm.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),r.url,n,i);return void this.hls.trigger(qm.ERROR,t)}e.assetListResponse=s,this.hls.trigger(qm.ASSET_LIST_LOADED,{event:e,assetListResponse:s,networkDetails:i})},onError:(t,n,r,i)=>{const s=this.assignAssetListError(e,jm.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${t.code} ${t.text} (${n.url})`),n.url,i,r);this.hls.trigger(qm.ERROR,s)},onTimeout:(t,n,r)=>{const i=this.assignAssetListError(e,jm.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${n.url})`),n.url,t,r);this.hls.trigger(qm.ERROR,i)}};return s.load(a,l,u),this.hls.trigger(qm.ASSET_LIST_LOADING,{event:e}),s}assignAssetListError(e,t,n,r,i,s){return e.error=n,{type:Wm.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:r,error:n,networkDetails:s,stats:i}}}function HS(e){null==e||e.play().catch(()=>{})}class $S extends qb{constructor(e,t,n){super(e,t,n,"subtitle-stream-controller",Zm.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.on(qm.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(qm.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(qm.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(qm.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(qm.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.off(qm.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(qm.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(qm.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(qm.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(qm.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=Ob,this.setInterval(500),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:n,success:r}=t;if(this.fragContextChanged(n)||(Lg(n)&&(this.fragPrevious=n),this.state=Ob),!r)return;const i=this.tracksBuffered[this.currentTrackId];if(!i)return;let s;const a=n.start;for(let e=0;e<i.length;e++)if(a>=i[e].start&&a<=i[e].end){s=i[e];break}const o=n.start+n.duration;s?s.end=o:(s={start:a,end:o},i.push(s)),this.fragmentTracker.fragBuffered(n),this.fragBufferedComplete(n,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:n,endOffset:r}=t;if(0===n&&r!==Number.POSITIVE_INFINITY){const e=r-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach(t=>{for(let n=0;n<t.length;)if(t[n].end<=e)t.shift();else{if(!(t[n].start<e))break;t[n].start=e,n++}}),this.fragmentTracker.removeFragmentsInRange(n,e,Zm.SUBTITLE)}}onError(e,t){const n=t.frag;(null==n?void 0:n.type)===Zm.SUBTITLE&&(t.details===jm.FRAG_GAP&&this.fragmentTracker.fragBuffered(n,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==kb&&(this.state=Ob))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){this.levels&&wx(this.levels,t)?this.levels=t.map(e=>new Pv(e)):(this.tracksBuffered=[],this.levels=t.map(e=>{const t=new Pv(e);return this.tracksBuffered[t.id]=[],t}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,Zm.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(e,t){var n;if(this.currentTrackId=t.id,null==(n=this.levels)||!n.length||-1===this.currentTrackId)return void this.clearInterval();const r=this.levels[this.currentTrackId];null!=r&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.state!==kb&&this.setInterval(500)}onSubtitleTrackLoaded(e,t){var n;const{currentTrackId:r,levels:i}=this,{details:s,id:a}=t;if(!i)return void this.warn(`Subtitle tracks were reset while loading level ${a}`);const o=i[a];if(a>=i.length||!o)return;this.log(`Subtitle track ${a} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(s.live||null!=(n=o.details)&&n.live){if(s.deltaUpdateFailed)return;const e=this.mainDetails;if(!e)return void(this.startFragRequested=!1);const t=e.fragments[0];var u;if(o.details)l=this.alignPlaylists(s,o.details,null==(u=this.levelLastLoaded)?void 0:u.details),0===l&&t&&(l=t.start,Tb(s,l));else s.hasProgramDateTime&&e.hasProgramDateTime?(Nb(s,e),l=s.fragmentStart):t&&(l=t.start,Tb(s,l));e&&!this.startFragRequested&&this.setStartPosition(e,l)}if(o.details=s,this.levelLastLoaded=o,a===r&&(this.hls.trigger(qm.SUBTITLE_TRACK_UPDATED,{details:s,id:a,groupId:t.groupId}),this.tick(),s.live&&!this.fragCurrent&&this.media&&this.state===Ob)){jv(null,s.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)}}_handleFragmentLoadComplete(e){const{frag:t,payload:n}=e,r=t.decryptdata,i=this.hls;if(!this.fragContextChanged(t)&&n&&n.byteLength>0&&null!=r&&r.key&&r.iv&&Vy(r.method)){const e=performance.now();this.decrypter.decrypt(new Uint8Array(n),r.key.buffer,r.iv.buffer,zy(r.method)).catch(e=>{throw i.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e}).then(n=>{const r=performance.now();i.trigger(qm.FRAG_DECRYPTED,{frag:t,payload:n,stats:{tstart:e,tdecrypt:r}})}).catch(e=>{this.warn(`${e.name}: ${e.message}`),this.state=Ob})}}doTick(){if(this.media){if(this.state===Ob){const{currentTrackId:e,levels:t}=this,n=null==t?void 0:t[e];if(!n||!t.length||!n.details)return;if(this.waitForLive(n))return;const{config:r}=this,i=this.getLoadPosition(),s=My.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],i,r.maxBufferHole),{end:a,len:o}=s,l=n.details;if(o>this.hls.maxBufferLength+l.levelTargetDuration)return;const u=l.fragments,c=u.length,d=l.edge;let h=null;const f=this.fragPrevious;if(a<d){const e=r.maxFragLookUpTolerance,t=a>d-e?0:e;h=jv(f,u,Math.max(u[0].start,a),t),!h&&f&&f.start<u[0].start&&(h=u[0])}else h=u[c-1];if(h=this.filterReplacedPrimary(h,n.details),!h)return;const p=u[h.sn-l.startSN-1];if(p&&p.cc===h.cc&&this.fragmentTracker.getState(p)===sy&&(h=p),this.fragmentTracker.getState(h)===sy){const e=this.mapToInitFragWhenRequired(h);e&&this.loadFragment(e,n,a)}}}else this.state=Ob}loadFragment(e,t,n){Lg(e)?super.loadFragment(e,t,n):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new WS(this.tracksBuffered[this.currentTrackId]||[])}}class WS{constructor(e){this.buffered=void 0;const t=(t,n,r)=>{if((n>>>=0)>r-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${r})`);return e[n][t]};this.buffered={get length(){return e.length},end:n=>t("end",n,e.length),start:n=>t("start",n,e.length)}}}const jS={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},qS=e=>String.fromCharCode(jS[e]||e),XS=15,YS=100,KS={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},QS={17:2,18:4,21:6,22:8,23:10,19:13,20:15},ZS={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},JS={25:2,26:4,29:6,30:8,31:10,27:13,28:15},eT=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class tT{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const n="function"==typeof t?t():t;dg.log(`${this.time} [${e}] ${n}`)}}}const nT=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].toString(16));return t};class rT{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let n=0;n<t.length;n++){const r=t[n];e.hasOwnProperty(r)&&(this[r]=e[r])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class iT{constructor(){this.uchar=" ",this.penState=new rT}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class sT{constructor(e){this.chars=[],this.pos=0,this.currPenState=new rT,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<YS;e++)this.chars.push(new iT);this.logger=e}equals(e){for(let t=0;t<YS;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<YS;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<YS;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>YS&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=YS)}moveCursor(e){const t=this.pos+e;if(e>1)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=qS(e);this.pos>=YS?this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<YS;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let n=0;n<YS;n++){const r=this.chars[n].uchar;" "!==r&&(t=!1),e.push(r)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e);this.chars[this.pos].setPenState(this.currPenState)}}class aT{constructor(e){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<XS;t++)this.rows.push(new sT(e));this.logger=e}reset(){for(let e=0;e<XS;e++)this.rows[e].clear();this.currRow=14}equals(e){let t=!0;for(let n=0;n<XS;n++)if(!this.rows[n].equals(e.rows[n])){t=!1;break}return t}copy(e){for(let t=0;t<XS;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<XS;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e);this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+kv(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<XS;e++)this.rows[e].clear();const e=this.currRow+1-this.nrRollUpRows,n=this.lastOutputScreen;if(n){const r=n.rows[e].cueStartTime,i=this.logger.time;if(null!==r&&null!==i&&r<i)for(let r=0;r<this.nrRollUpRows;r++)this.rows[t-this.nrRollUpRows+r+1].copy(n.rows[e+r])}}this.currRow=t;const n=this.rows[this.currRow];if(null!==e.indent){const t=e.indent,r=Math.max(t-1,0);n.setCursor(e.indent),e.color=n.chars[r].penState.foreground}const r={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+kv(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let n="",r=-1;for(let n=0;n<XS;n++){const i=this.rows[n].getTextString();i&&(r=n+1,e?t.push("Row "+r+": '"+i+"'"):t.push(i.trim()))}return t.length>0&&(n=e?"["+t.join(" | ")+"]":t.join("\n")),n}getTextAndFormat(){return this.rows}}class oT{constructor(e,t,n){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new aT(n),this.nonDisplayedMemory=new aT(n),this.lastOutputScreen=new aT(n),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=n}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{const n=Math.floor(e/2)-16,r=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=r[n]}this.logger.log(2,"MIDROW: "+kv(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class lT{constructor(e,t,n){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const r=this.logger=new tT;this.channels=[null,new oT(e,t,r),new oT(e+1,n,r)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let e=0;e<t.length;e+=2){const n=127&t[e],r=127&t[e+1];let i=!1,s=null;if(0===n&&0===r)continue;this.logger.log(3,()=>"["+nT([t[e],t[e+1]])+"] -> ("+nT([n,r])+")");const a=this.cmdHistory;if(n>=16&&n<=31){if(cT(n,r,a)){uT(null,null,a),this.logger.log(3,()=>"Repeated command ("+nT([n,r])+") is dropped");continue}uT(n,r,this.cmdHistory),i=this.parseCmd(n,r),i||(i=this.parseMidrow(n,r)),i||(i=this.parsePAC(n,r)),i||(i=this.parseBackgroundAttributes(n,r))}else uT(null,null,a);if(!i&&(s=this.parseChars(n,r),s)){const e=this.currentChannel;if(e&&e>0){this.channels[e].insertChars(s)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}i||s||this.logger.log(2,()=>"Couldn't parse cleaned data "+nT([n,r])+" orig: "+nT([t[e],t[e+1]]))}}parseCmd(e,t){if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=33&&t<=35))return!1;const n=20===e||21===e||23===e?1:2,r=this.channels[n];return 20===e||21===e||28===e||29===e?32===t?r.ccRCL():33===t?r.ccBS():34===t?r.ccAOF():35===t?r.ccAON():36===t?r.ccDER():37===t?r.ccRU(2):38===t?r.ccRU(3):39===t?r.ccRU(4):40===t?r.ccFON():41===t?r.ccRDC():42===t?r.ccTR():43===t?r.ccRTD():44===t?r.ccEDM():45===t?r.ccCR():46===t?r.ccENM():47===t&&r.ccEOC():r.ccTO(t-32),this.currentChannel=n,!0}parseMidrow(e,t){let n=0;if((17===e||25===e)&&t>=32&&t<=47){if(n=17===e?1:2,n!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const r=this.channels[n];return!!r&&(r.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+nT([e,t])+")"),!0)}return!1}parsePAC(e,t){let n;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127)&&!((16===e||24===e)&&t>=64&&t<=95))return!1;const r=e<=23?1:2;n=t>=64&&t<=95?1===r?KS[e]:ZS[e]:1===r?QS[e]:JS[e];const i=this.channels[r];return!!i&&(i.setPAC(this.interpretPAC(n,t)),this.currentChannel=r,!0)}interpretPAC(e,t){let n;const r={color:null,italics:!1,indent:null,underline:!1,row:e};return n=t>95?t-96:t-64,r.underline=!(1&~n),n<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(n/2)]:n<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((n-16)/2),r}parseChars(e,t){let n,r=null,i=null;if(e>=25?(n=2,i=e-8):(n=1,i=e),i>=17&&i<=19){let e;e=17===i?t+80:18===i?t+112:t+144,this.logger.log(2,()=>"Special char '"+qS(e)+"' in channel "+n),r=[e]}else e>=32&&e<=127&&(r=0===t?[e]:[e,t]);return r&&this.logger.log(3,()=>"Char codes =  "+nT(r).join(",")),r}parseBackgroundAttributes(e,t){if(!((16===e||24===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=45&&t<=47))return!1;let n;const r={};16===e||24===e?(n=Math.floor((t-32)/2),r.background=eT[n],t%2==1&&(r.background=r.background+"_semi")):45===t?r.background="transparent":(r.foreground="black",47===t&&(r.underline=!0));const i=e<=23?1:2;return this.channels[i].setBkgData(r),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}uT(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const n=this.channels[t];n&&n.cueSplitAtTime(e)}}}function uT(e,t,n){n.a=e,n.b=t}function cT(e,t,n){return n.a===e&&n.b===t}var dT=function(){if(null!=Wy&&Wy.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function n(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const n=t.toLowerCase();return!!~e.indexOf(n)&&n}function r(e){return n(t,e)}function i(e,...t){let n=1;for(;n<arguments.length;n++){const t=arguments[n];for(const n in t)e[n]=t[n]}return e}function s(t,s,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let u="",c=!1,d=t,h=s,f=a,p=null,m="",g=!0,v="auto",y="start",b=50,_="middle",x=50,S="middle";Object.defineProperty(o,"id",i({},l,{get:function(){return u},set:function(e){u=""+e}})),Object.defineProperty(o,"pauseOnExit",i({},l,{get:function(){return c},set:function(e){c=!!e}})),Object.defineProperty(o,"startTime",i({},l,{get:function(){return d},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");d=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",i({},l,{get:function(){return h},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");h=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",i({},l,{get:function(){return f},set:function(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",i({},l,{get:function(){return p},set:function(e){p=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",i({},l,{get:function(){return m},set:function(t){const r=function(t){return n(e,t)}(t);if(!1===r)throw new SyntaxError("An invalid or illegal string was specified.");m=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",i({},l,{get:function(){return g},set:function(e){g=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",i({},l,{get:function(){return v},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");v=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",i({},l,{get:function(){return y},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");y=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",i({},l,{get:function(){return b},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");b=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",i({},l,{get:function(){return _},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");_=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",i({},l,{get:function(){return x},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");x=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",i({},l,{get:function(){return S},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");S=t,this.hasBeenReset=!0}})),o.displayState=void 0}return s.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},s}();class hT{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function fT(e){function t(e,t,n,r){return 3600*(0|e)+60*(0|t)+(0|n)+parseFloat(r||0)}const n=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return n?parseFloat(n[2])>59?t(n[2],n[3],0,n[4]):t(n[1],n[2],n[3],n[4]):null}class pT{constructor(){this.values=Object.create(null)}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,n){return n?this.has(e)?this.values[e]:t[n]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,n){for(let r=0;r<n.length;++r)if(t===n[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const n=parseFloat(t);if(n>=0&&n<=100)return this.set(e,n),!0}return!1}}function mT(e,t,n,r){const i=r?e.split(r):[e];for(const e in i){if("string"!=typeof i[e])continue;const r=i[e].split(n);if(2!==r.length)continue;t(r[0],r[1])}}const gT=new dT(0,0,""),vT="middle"===gT.align?"middle":"center";function yT(e,t,n){const r=e;function i(){const t=fT(e);if(null===t)throw new Error("Malformed timestamp: "+r);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function s(){e=e.replace(/^\s+/,"")}if(s(),t.startTime=i(),s(),"--\x3e"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);e=e.slice(3),s(),t.endTime=i(),s(),function(e,t){const r=new pT;mT(e,function(e,t){let i;switch(e){case"region":for(let i=n.length-1;i>=0;i--)if(n[i].id===t){r.set(e,n[i].region);break}break;case"vertical":r.alt(e,t,["rl","lr"]);break;case"line":i=t.split(","),r.integer(e,i[0]),r.percent(e,i[0])&&r.set("snapToLines",!1),r.alt(e,i[0],["auto"]),2===i.length&&r.alt("lineAlign",i[1],["start",vT,"end"]);break;case"position":i=t.split(","),r.percent(e,i[0]),2===i.length&&r.alt("positionAlign",i[1],["start",vT,"end","line-left","line-right","auto"]);break;case"size":r.percent(e,t);break;case"align":r.alt(e,t,["start",vT,"end","left","right"])}},/:/,/\s/),t.region=r.get("region",null),t.vertical=r.get("vertical","");let i=r.get("line","auto");"auto"===i&&-1===gT.line&&(i=-1),t.line=i,t.lineAlign=r.get("lineAlign","start"),t.snapToLines=r.get("snapToLines",!0),t.size=r.get("size",100),t.align=r.get("align",vT);let s=r.get("position","auto");"auto"===s&&50===gT.position&&(s="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=s}(e,t)}function bT(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class _T{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new hT,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;function n(){let e=t.buffer,n=0;for(e=bT(e);n<e.length&&"\r"!==e[n]&&"\n"!==e[n];)++n;const r=e.slice(0,n);return"\r"===e[n]&&++n,"\n"===e[n]&&++n,t.buffer=e.slice(n),r}function r(e){mT(e,function(e,t){},/:/)}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{let e="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;e=n();const r=e.match(/^()?WEBVTT([ \t].*)?$/);if(null==r||!r[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let i=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(i?i=!1:e=n(),t.state){case"HEADER":/:/.test(e)?r(e):e||(t.state="ID");continue;case"NOTE":e||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){t.state="NOTE";break}if(!e)continue;if(t.cue=new dT(0,0,""),t.state="CUE",-1===e.indexOf("--\x3e")){t.cue.id=e;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{yT(e,t.cue,t.regionList)}catch(e){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const n=-1!==e.indexOf("--\x3e");if(!e||n&&(i=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=e}continue;case"BADCUE":e||(t.state="ID")}}}catch(e){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const xT=/\r\n|\n\r|\n|\r/g,ST=function(e,t,n=0){return e.slice(n,n+t.length)===t};function TT(e,t,n){return IS(e.toString())+IS(t.toString())+IS(n)}function ET(e,t,n,r,i,s,a){const o=new _T,l=pg(new Uint8Array(e)).trim().replace(xT,"\n").split("\n"),u=[],c=t?function(e,t=1){return ix(e,9e4,1/t)}(t.baseTime,t.timescale):0;let d,h="00:00.000",f=0,p=0,m=!0;o.oncue=function(e){const s=n[r];let a=n.ccOffset;const o=(f-c)/9e4;if(null!=s&&s.new&&(void 0!==p?a=n.ccOffset=s.start:function(e,t,n){let r=e[t],i=e[r.prevCC];if(!i||!i.new&&r.new)return e.ccOffset=e.presentationOffset=r.start,void(r.new=!1);for(;null!=(s=i)&&s.new;){var s;e.ccOffset+=r.start-i.start,r.new=!1,r=i,i=e[r.prevCC]}e.presentationOffset=n}(n,r,o)),o){if(!t)return void(d=new Error("Missing initPTS for VTT MPEGTS"));a=o-n.presentationOffset}const l=e.endTime-e.startTime,h=dx(9e4*(e.startTime+a-p),9e4*i)/9e4;e.startTime=Math.max(h,0),e.endTime=Math.max(h+l,0);const m=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(m)),e.id||(e.id=TT(e.startTime,e.endTime,m)),e.endTime>0&&u.push(e)},o.onparsingerror=function(e){d=e},o.onflush=function(){d?a(d):s(u)},l.forEach(e=>{if(m){if(ST(e,"X-TIMESTAMP-MAP=")){m=!1,e.slice(16).split(",").forEach(e=>{ST(e,"LOCAL:")?h=e.slice(6):ST(e,"MPEGTS:")&&(f=parseInt(e.slice(7)))});try{p=function(e){let t=parseInt(e.slice(-3));const n=parseInt(e.slice(-6,-4)),r=parseInt(e.slice(-9,-7)),i=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(Gm(t)&&Gm(n)&&Gm(r)&&Gm(i)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*n,t+=6e4*r,t+=36e5*i,t}(h)/1e3}catch(e){d=e}return}""===e&&(m=!1)}o.parse(e+"\n")}),o.flush()}const AT="stpp.ttml.im1t",wT=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,MT=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,RT={left:"start",center:"center",right:"end",start:"start",end:"end"};function CT(e,t,n,r){const i=Hg(new Uint8Array(e),["mdat"]);if(0===i.length)return void r(new Error("Could not parse IMSC1 mdat"));const s=i.map(e=>pg(e)),a=function(e,t,n=1,r=!1){return ix(e,t,1/n,r)}(t.baseTime,1,t.timescale);try{s.forEach(e=>n(function(e,t){const n=(new DOMParser).parseFromString(e,"text/xml"),r=n.getElementsByTagName("tt")[0];if(!r)throw new Error("Invalid ttml");const i={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},s=Object.keys(i).reduce((e,t)=>(e[t]=r.getAttribute(`ttp:${t}`)||i[t],e),{}),a="preserve"!==r.getAttribute("xml:space"),o=LT(IT(r,"styling","style")),l=LT(IT(r,"layout","region")),u=IT(r,"body","[begin]");return[].map.call(u,e=>{const n=PT(e,a);if(!n||!e.hasAttribute("begin"))return null;const r=kT(e.getAttribute("begin"),s),i=kT(e.getAttribute("dur"),s);let u=kT(e.getAttribute("end"),s);if(null===r)throw DT(e);if(null===u){if(null===i)throw DT(e);u=r+i}const c=new dT(r-t,u-t,n);c.id=TT(c.startTime,c.endTime,c.text);const d=function(e,t,n){const r="http://www.w3.org/ns/ttml#styling";let i=null;const s=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;a&&n.hasOwnProperty(a)&&(i=n[a]);return s.reduce((n,s)=>{const a=NT(t,r,s)||NT(e,r,s)||NT(i,r,s);return a&&(n[s]=a),n},{})}(l[e.getAttribute("region")],o[e.getAttribute("style")],o),{textAlign:h}=d;if(h){const e=RT[h];e&&(c.lineAlign=e),c.align=h}return ng(c,d),c}).filter(e=>null!==e)}(e,a)))}catch(e){r(e)}}function IT(e,t,n){const r=e.getElementsByTagName(t)[0];return r?[].slice.call(r.querySelectorAll(n)):[]}function LT(e){return e.reduce((e,t)=>{const n=t.getAttribute("xml:id");return n&&(e[n]=t),e},{})}function PT(e,t){return[].slice.call(e.childNodes).reduce((e,n,r)=>{var i;return"br"===n.nodeName&&r?e+"\n":null!=(i=n.childNodes)&&i.length?PT(n,t):t?e+n.textContent.trim().replace(/\s+/g," "):e+n.textContent},"")}function NT(e,t,n){return e&&e.hasAttributeNS(t,n)?e.getAttributeNS(t,n):null}function DT(e){return new Error(`Could not parse ttml timestamp ${e}`)}function kT(e,t){if(!e)return null;let n=fT(e);return null===n&&(wT.test(e)?n=function(e,t){const n=wT.exec(e),r=(0|n[4])+(0|n[5])/t.subFrameRate;return 3600*(0|n[1])+60*(0|n[2])+(0|n[3])+r/t.frameRate}(e,t):MT.test(e)&&(n=function(e,t){const n=MT.exec(e),r=Number(n[1]);switch(n[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/t.frameRate;case"t":return r/t.tickRate}return r}(e,t))),n}class OT{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,n){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=n,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class FT{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(qm.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(qm.FRAG_LOADING,this.onFragLoading,this),e.on(qm.FRAG_LOADED,this.onFragLoaded,this),e.on(qm.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(qm.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(qm.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(qm.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(qm.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(qm.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(qm.FRAG_LOADING,this.onFragLoading,this),e.off(qm.FRAG_LOADED,this.onFragLoaded,this),e.off(qm.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(qm.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(qm.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(qm.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(qm.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new OT(this,"textTrack1"),t=new OT(this,"textTrack2"),n=new OT(this,"textTrack3"),r=new OT(this,"textTrack4");this.cea608Parser1=new lT(1,e,t),this.cea608Parser2=new lT(3,n,r)}addCues(e,t,n,r,i){let s=!1;for(let e=i.length;e--;){const r=i[e],a=VT(r[0],r[1],t,n);if(a>=0&&(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],n),s=!0,a/(n-t)>.5))return}if(s||i.push([t,n]),this.config.renderTextTracksNatively){const i=this.captionsTracks[e];this.Cues.newCue(i,t,n,r)}else{const i=this.Cues.newCue(null,t,n,r);this.hls.trigger(qm.CUES_PARSED,{type:"captions",cues:i,track:e})}}onInitPtsFound(e,{frag:t,id:n,initPTS:r,timescale:i}){const{unparsedVttFrags:s}=this;n===Zm.MAIN&&(this.initPTS[t.cc]={baseTime:r,timescale:i}),s.length&&(this.unparsedVttFrags=[],s.forEach(e=>{this.initPTS[e.frag.cc]?this.onFragLoaded(qm.FRAG_LOADED,e):this.hls.trigger(qm.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e.frag,error:new Error("Subtitle discontinuity domain does not match main")})}))}getExistingTrack(e,t){const{media:n}=this;if(n)for(let r=0;r<n.textTracks.length;r++){const i=n.textTracks[r];if(BT(i,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return i}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:n,media:r}=this,{label:i,languageCode:s}=t[e],a=this.getExistingTrack(i,s);if(a)n[e]=a,wS(n[e]),ES(n[e],r);else{const t=this.createTextTrack("captions",i,s);t&&(t[e]=!0,n[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const n={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(qm.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,n){const r=this.media;if(r)return r.addTextTrack(e,t,n)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const n=!!t.transferMedia;if(this.media=null,n)return;const{captionsTracks:r}=this;Object.keys(r).forEach(e=>{wS(r[e]),delete r[e]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)wS(t[e])}onSubtitleTracksUpdated(e,t){const n=t.subtitleTracks||[],r=n.some(e=>e.textCodec===AT);if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(wx(this.tracks,n))return void(this.tracks=n);if(this.textTracks=[],this.tracks=n,this.config.renderTextTracksNatively){const e=this.media,t=e?RS(e.textTracks):null;if(this.tracks.forEach((e,n)=>{let r;if(t){let n=null;for(let r=0;r<t.length;r++)if(t[r]&&BT(t[r],e)){n=t[r],t[r]=null;break}n&&(r=n)}if(r)wS(r);else{const t=UT(e);r=this.createTextTrack(t,e.name,e.lang),r&&(r.mode="disabled")}r&&this.textTracks.push(r)}),null!=t&&t.length){const e=t.filter(e=>null!==e).map(e=>e.label);e.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${e.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const e=this.tracks.map(e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e}));this.hls.trigger(qm.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(e=>{const t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;const n=`textTrack${t[1]}`,r=this.captionsProperties[n];r&&(r.label=e.name,e.lang&&(r.languageCode=e.lang),r.media=e)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===Zm.MAIN){var n,r;const{cea608Parser1:e,cea608Parser2:i,lastSn:s}=this,{cc:a,sn:o}=t.frag,l=null!=(n=null==(r=t.part)?void 0:r.index)?n:-1;e&&i&&(o!==s+1||o===s&&l!==this.lastPartIndex+1||a!==this.lastCc)&&(e.reset(),i.reset()),this.lastCc=a,this.lastSn=o,this.lastPartIndex=l}}onFragLoaded(e,t){const{frag:n,payload:r}=t;if(n.type===Zm.SUBTITLE)if(r.byteLength){const e=n.decryptdata,i="stats"in t;if(null==e||!e.encrypted||i){const e=this.tracks[n.level],i=this.vttCCs;i[n.cc]||(i[n.cc]={start:n.start,prevCC:this.prevCC,new:!0},this.prevCC=n.cc),e&&e.textCodec===AT?this._parseIMSC1(n,r):this._parseVTTs(t)}}else this.hls.trigger(qm.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const n=this.hls;CT(t,this.initPTS[e.cc],t=>{this._appendCues(t,e.level),n.trigger(qm.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},t=>{n.logger.log(`Failed to parse IMSC1: ${t}`),n.trigger(qm.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})}_parseVTTs(e){var t;const{frag:n,payload:r}=e,{initPTS:i,unparsedVttFrags:s}=this,a=i.length-1;if(!i[n.cc]&&-1===a)return void s.push(e);const o=this.hls;ET(null!=(t=n.initSegment)&&t.data?Zg(n.initSegment.data,new Uint8Array(r)).buffer:r,this.initPTS[n.cc],this.vttCCs,n.cc,n.start,e=>{this._appendCues(e,n.level),o.trigger(qm.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:n})},t=>{const i="Missing initPTS for VTT MPEGTS"===t.message;i?s.push(e):this._fallbackToIMSC1(n,r),o.logger.log(`Failed to parse VTT cue: ${t}`),i&&a>n.cc||o.trigger(qm.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:t})})}_fallbackToIMSC1(e,t){const n=this.tracks[e.level];n.textCodec||CT(t,this.initPTS[e.cc],()=>{n.textCodec=AT,this._parseIMSC1(e,t)},()=>{n.textCodec="wvtt"})}_appendCues(e,t){const n=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||"disabled"===n.mode)return;e.forEach(e=>AS(n,e))}else{const r=this.tracks[t];if(!r)return;const i=r.default?"default":"subtitles"+t;n.trigger(qm.CUES_PARSED,{type:"subtitles",cues:e,track:i})}}onFragDecrypted(e,t){const{frag:n}=t;n.type===Zm.SUBTITLE&&this.onFragLoaded(qm.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:n,samples:r}=t;if(n.type!==Zm.MAIN||"NONE"!==this.closedCaptionsForLevel(n))for(let e=0;e<r.length;e++){const t=r[e].bytes;if(t){this.cea608Parser1||this.initCea608Parsers();const n=this.extractCea608Data(t);this.cea608Parser1.addData(r[e].pts,n[0]),this.cea608Parser2.addData(r[e].pts,n[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:n,endOffsetSubtitles:r,type:i}){const{media:s}=this;if(s&&!(s.currentTime<n)){if(!i||"video"===i){const{captionsTracks:e}=this;Object.keys(e).forEach(r=>MS(e[r],t,n))}if(this.config.renderTextTracksNatively&&0===t&&void 0!==r){const{textTracks:e}=this;Object.keys(e).forEach(n=>MS(e[n],t,r))}}}extractCea608Data(e){const t=[[],[]],n=31&e[0];let r=2;for(let i=0;i<n;i++){const n=e[r++],i=127&e[r++],s=127&e[r++];if(0===i&&0===s)continue;if(!!(4&n)){const e=3&n;0!==e&&1!==e||(t[e].push(i),t[e].push(s))}}return t}}function UT(e){return e.characteristics&&/transcribes-spoken-dialog/gi.test(e.characteristics)&&/describes-music-and-sound/gi.test(e.characteristics)?"captions":"subtitles"}function BT(e,t){return!!e&&e.kind===UT(t)&&Rx(t,e)}function VT(e,t,n,r){return Math.min(t,r)-Math.max(e,n)}const zT=/\s/,GT={newCue(e,t,n,r){const i=[];let s,a,o,l,u;const c=self.VTTCue||self.TextTrackCue;for(let h=0;h<r.rows.length;h++)if(s=r.rows[h],o=!0,l=0,u="",!s.isEmpty()){var d;for(let e=0;e<s.chars.length;e++)zT.test(s.chars[e].uchar)&&o?l++:(u+=s.chars[e].uchar,o=!1);s.cueStartTime=t,t===n&&(n+=1e-4),l>=16?l--:l++;const r=bT(u.trim()),f=TT(t,n,r);null!=e&&null!=(d=e.cues)&&d.getCueById(f)||(a=new c(t,n,r),a.id=f,a.line=h+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),i.push(a))}return e&&i.length&&(i.sort((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line),i.forEach(t=>AS(e,t))),i}};function HT(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1}const $T=/(\d+)-(\d+)\/(\d+)/;class WT{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||jT,this.controller=new self.AbortController,this.stats=new wg}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,n){const r=this.stats;if(r.loading.start)throw new Error("Loader can only be used once.");r.loading.start=self.performance.now();const i=function(e,t){const n={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(ng({},e.headers))};e.rangeEnd&&n.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1));return n}(e,this.controller.signal),s="arraybuffer"===e.responseType,a=s?"byteLength":"length",{maxTimeToFirstByteMs:o,maxLoadTimeMs:l}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=n,this.request=this.fetchSetup(e,i),self.clearTimeout(this.requestTimeout),t.timeout=o&&Gm(o)?o:l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(r,e,this.response))},t.timeout);(bx(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(n=>{var i;this.response=this.loader=n;const a=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(r,e,this.response))},l-(a-r.loading.start)),!n.ok){const{status:e,statusText:t}=n;throw new qT(t||"fetch, bad network response",e,n)}r.loading.first=a,r.total=function(e){const t=e.get("Content-Range");if(t){const e=function(e){const t=$T.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}(t);if(Gm(e))return e}const n=e.get("Content-Length");if(n)return parseInt(n)}(n.headers)||r.total;const o=null==(i=this.callbacks)?void 0:i.onProgress;return o&&Gm(t.highWaterMark)?this.loadProgressively(n,r,e,t.highWaterMark,o):s?n.arrayBuffer():"json"===e.responseType?n.json():n.text()}).then(n=>{var i,s;const o=this.response;if(!o)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);const l=n[a];l&&(r.loaded=r.total=l);const u={url:o.url,data:n,code:o.status},c=null==(i=this.callbacks)?void 0:i.onProgress;c&&!Gm(t.highWaterMark)&&c(r,e,n,o),null==(s=this.callbacks)||s.onSuccess(u,r,e,o)}).catch(t=>{var n;if(self.clearTimeout(this.requestTimeout),r.aborted)return;const i=t&&t.code||0,s=t?t.message:null;null==(n=this.callbacks)||n.onError({code:i,text:s},e,t?t.details:null,r)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,n,r=0,i){const s=new Yb,a=e.body.getReader(),o=()=>a.read().then(a=>{if(a.done)return s.dataLength&&i(t,n,s.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const l=a.value,u=l.length;return t.loaded+=u,u<r||s.dataLength?(s.push(l),s.dataLength>=r&&i(t,n,s.flush().buffer,e)):i(t,n,l.buffer,e),o()}).catch(()=>Promise.reject());return o()}}function jT(e,t){return new self.Request(e.url,t)}class qT extends Error{constructor(e,t,n){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=n}}const XT=/^age:\s*[\d.]+\s*$/im;class YT{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new wg,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,n){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=n,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const n=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;const i=this.xhrSetup;i?Promise.resolve().then(()=>{if(this.loader===n&&!this.stats.aborted)return i(n,t.url)}).catch(e=>{if(this.loader===n&&!this.stats.aborted)return n.open("GET",t.url,!0),i(n,t.url)}).then(()=>{this.loader!==n||this.stats.aborted||this.openAndSendXhr(n,t,e)}).catch(e=>{var i;null==(i=this.callbacks)||i.onError({code:n.status,text:e.message},t,n,r)}):this.openAndSendXhr(n,t,e)}openAndSendXhr(e,t,n){e.readyState||e.open("GET",t.url,!0);const r=t.headers,{maxTimeToFirstByteMs:i,maxLoadTimeMs:s}=n.loadPolicy;if(r)for(const t in r)e.setRequestHeader(t,r[t]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),n.timeout=i&&Gm(i)?i:s,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:n}=this;if(!e||!t)return;const r=t.readyState,i=this.config;if(!n.aborted&&r>=2&&(0===n.loading.first&&(n.loading.first=Math.max(self.performance.now(),n.loading.start),i.timeout!==i.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),i.timeout=i.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.loadPolicy.maxLoadTimeMs-(n.loading.first-n.loading.start)))),4===r)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const r=t.status,l="text"===t.responseType?t.responseText:null;if(r>=200&&r<300){const i=null!=l?l:t.response;if(null!=i){var s,a;n.loading.end=Math.max(self.performance.now(),n.loading.first);const o="arraybuffer"===t.responseType?i.byteLength:i.length;n.loaded=n.total=o,n.bwEstimate=8e3*n.total/(n.loading.end-n.loading.first);const l=null==(s=this.callbacks)?void 0:s.onProgress;l&&l(n,e,i,t);const u={url:t.responseURL,data:i,code:r};return void(null==(a=this.callbacks)||a.onSuccess(u,n,e,t))}}const u=i.loadPolicy.errorRetry;var o;if(ey(u,n.retry,!1,{url:e.url,data:void 0,code:r}))this.retry(u);else dg.error(`${r} while loading ${e.url}`),null==(o=this.callbacks)||o.onError({code:r,text:t.statusText},e,t,n)}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry;if(ey(e,this.stats.retry,!0))this.retry(e);else{var t;dg.warn(`timeout while loading ${null==(t=this.context)?void 0:t.url}`);const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:n}=this;this.retryDelay=Zv(e,n.retry),n.retry++,dg.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==t?void 0:t.url}, retrying ${n.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&XT.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const KT=ig(ig({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:6e7,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:YT,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:$v,bufferController:Dx,capLevelController:Fx,errorController:ry,fpsController:TS,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Qy,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:GT,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:$S,subtitleTrackController:CS,timelineController:FT,audioStreamController:Ex,audioTrackController:Cx,emeController:xS,cmcdController:mS,contentSteeringController:gS,interstitialsController:class extends sg{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const e=this.currentTime;if(void 0===e||this.playbackDisabled)return;const t=e-this.timelinePos;if(Math.abs(t)<1/7056e5)return;const n=t<=-.01;this.timelinePos=e,this.bufferedPos=e;const r=this.playingItem;if(!r)return void this.checkBuffer();if(n){this.schedule.resetErrorsInRange(e,e-t)&&this.updateSchedule()}if(this.checkBuffer(),n&&e<r.start||e>=r.end){var i;const e=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(r)&&null!=(i=this.media)&&i.paused&&(this.shouldPlay=!1),!n){const t=this.findItemIndex(r);if(e>t){const n=this.schedule.findJumpRestrictedIndex(t+1,e);if(n>t)return void this.setSchedulePosition(n)}}return void this.setSchedulePosition(e)}const s=this.playingAsset;if(!s){if(this.playingLastItem&&this.isInterstitial(r)){const t=r.event.assetList[0];t&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(e,t))}return}const a=s.timelineStart,o=s.duration||0;(n&&e<a||e>=a+o)&&this.setScheduleToAssetAtTime(e,s)},this.onTimeupdate=()=>{const e=this.currentTime;if(void 0===e||this.playbackDisabled)return;if(!(e>this.timelinePos))return;this.timelinePos=e,e>this.bufferedPos&&this.checkBuffer();const t=this.playingItem;if(!t||this.playingLastItem)return;if(e>=t.end){this.timelinePos=t.end;const e=this.findItemIndex(t);this.setSchedulePosition(e+1)}const n=this.playingAsset;if(!n)return;e>=n.timelineStart+(n.duration||0)&&this.setScheduleToAssetAtTime(e,n)},this.onScheduleUpdate=(e,t)=>{const n=this.schedule,r=this.playingItem,i=n.events||[],s=n.items||[],a=n.durations,o=e.map(e=>e.identifier),l=!(!i.length&&!o.length);(l||t)&&this.log(`INTERSTITIALS_UPDATED (${i.length}): ${i}\nSchedule: ${s.map(e=>zS(e))} pos: ${this.timelinePos}`),o.length&&this.log(`Removed events ${o}`),this.playerQueue.forEach(e=>{if(e.interstitial.appendInPlace){const t=e.assetItem.timelineStart,n=e.timelineOffset-t;if(n)try{e.timelineOffset=t}catch(r){Math.abs(n)>LS&&this.warn(`${r} ("${e.assetId}" ${e.timelineOffset}->${t})`)}}});let u=null;if(r){const e=this.updateItem(r,this.timelinePos);this.itemsMatch(r,e)&&(this.playingItem=e,this.waitingItem=this.endedItem=null,u=()=>this.trimInPlace(e,r))}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const c=this.bufferingItem;if(c){const e=this.updateItem(c,this.bufferedPos);this.itemsMatch(c,e)?(this.bufferingItem=e,u||(u=()=>this.trimInPlace(e,c))):c.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(c.event,null))}if(e.forEach(e=>{e.assetList.forEach(e=>{this.clearAssetPlayer(e.identifier,null)})}),l||t){if(this.hls.trigger(qm.INTERSTITIALS_UPDATED,{events:i.slice(0),schedule:s.slice(0),durations:a,removedIds:o}),this.isInterstitial(r)&&o.includes(r.event.identifier))return this.warn(`Interstitial "${r.event.identifier}" removed while playing`),void this.primaryFallback(r.event);u&&u(),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new GS(e),this.schedule=new VS(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e.on(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(qm.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(qm.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(qm.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(qm.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(qm.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(qm.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(qm.BUFFER_APPENDED,this.onBufferAppended,this),e.on(qm.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(qm.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(qm.MEDIA_ENDED,this.onMediaEnded,this),e.on(qm.ERROR,this.onError,this),e.on(qm.DESTROYING,this.onDestroying,this)}unregisterListeners(){const e=this.hls;e&&(e.off(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(qm.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(qm.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(qm.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(qm.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(qm.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(qm.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(qm.BUFFER_CODECS,this.onBufferCodecs,this),e.off(qm.BUFFER_APPENDED,this.onBufferAppended,this),e.off(qm.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(qm.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(qm.MEDIA_ENDED,this.onMediaEnded,this),e.off(qm.ERROR,this.onError,this),e.off(qm.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;null==(e=this.getBufferingPlayer())||e.resumeBuffering()}pauseBuffering(){var e;null==(e=this.getBufferingPlayer())||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){_S(e,"play",this.onPlay),_S(e,"pause",this.onPause),_S(e,"seeking",this.onSeeking),_S(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const n=this.media=t.media;bS(n,"seeking",this.onSeeking),bS(n,"timeupdate",this.onTimeupdate),bS(n,"play",this.onPlay),bS(n,"pause",this.onPause)}onMediaAttached(e,t){const n=this.effectivePlayingItem,r=this.detachedData;if(this.detachedData=null,null===n)this.checkStart();else if(!r){this.clearScheduleState();const e=this.findItemIndex(n);this.setSchedulePosition(e)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const n=!!t.transferMedia,r=this.media;if(this.media=null,!n&&(r&&this.removeMediaListeners(r),this.detachedData)){const e=this.getBufferingPlayer();e&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,e.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;const e=this,t=()=>e.bufferingItem||e.waitingItem,n=t=>t?e.getAssetPlayer(t.identifier):t,r=(t,r,i,a,o)=>{if(t){let l=t[r].start;const u=t.event;if(u){if("playout"===r||u.timelineOccupancy!==PS.Point){const e=n(i);(null==e?void 0:e.interstitial)===u&&(l+=e.assetItem.startOffset+e[o])}}else{l+=("bufferedPos"===a?s():e[a])-t.start}return l}return 0},i=(t,n)=>{if(0!==t&&"primary"!==n&&e.schedule.length){var r;const i=e.schedule.findItemIndexAtTime(t),s=null==(r=e.schedule.items)?void 0:r[i];if(s){return t+(s[n].start-s.start)}}return t},s=()=>{const t=e.bufferedPos;return t===Number.MAX_VALUE?a("primary"):Math.max(t,0)},a=t=>{var n;return null!=(n=e.primaryDetails)&&n.live?e.primaryDetails.edge:e.schedule.durations[t]},o=(t,i)=>{var s,a;const o=e.effectivePlayingItem;if(null!=o&&null!=(s=o.event)&&s.restrictions.skip)return;e.log(`seek to ${t} "${i}"`);const l=e.effectivePlayingItem,u=e.schedule.findItemIndexAtTime(t,i),c=null==(a=e.schedule.items)?void 0:a[u],d=e.getBufferingPlayer(),h=null==d?void 0:d.interstitial,f=null==h?void 0:h.appendInPlace,p=l&&e.itemsMatch(l,c);if(l&&(f||p)){const s=n(e.playingAsset),a=(null==s?void 0:s.media)||e.primaryMedia;if(a){const n="primary"===i?a.currentTime:r(l,i,e.playingAsset,"timelinePos","currentTime"),o=t-n,u=(f?n:a.currentTime)+o;if(u>=0&&(!s||f||u<=s.duration))return void(a.currentTime=u)}}if(c){let n=t;if("primary"!==i){const e=t-c[i].start;n=c.start+e}const r=!e.isInterstitial(c);if(e.isInterstitial(l)&&!l.event.appendInPlace||!r&&!c.event.appendInPlace){if(l){const s=e.findItemIndex(l);if(u>s){const t=e.schedule.findJumpRestrictedIndex(s+1,u);if(t>s)return void e.setSchedulePosition(t)}let a=0;if(r)e.timelinePos=n,e.checkBuffer();else{var m;const e=null==c||null==(m=c.event)?void 0:m.assetList;if(e){const n=t-(c[i]||c).start;for(let t=e.length;t--;){const r=e[t];if(r.duration&&n>=r.startOffset&&n<r.startOffset+r.duration){a=t;break}}}}e.setSchedulePosition(u,a)}}else{const t=e.media||(f?null==d?void 0:d.media:null);t&&(t.currentTime=n)}}},l=()=>{const n=e.effectivePlayingItem;if(e.isInterstitial(n))return n;const r=t();return e.isInterstitial(r)?r:null},u={get currentTime(){const t=l(),n=e.effectivePlayingItem;return n&&n===t?r(n,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-n.playout.start:0},set currentTime(t){const n=l(),r=e.effectivePlayingItem;r&&r===n&&o(t+r.playout.start,"playout")},get duration(){const e=l();return e?e.playout.end-e.playout.start:0},get assetPlayers(){var t;const n=null==(t=l())?void 0:t.event.assetList;return n?n.map(t=>e.getAssetPlayer(t.identifier)):[]},get playingIndex(){var t;const n=null==(t=l())?void 0:t.event;return n&&e.effectivePlayingAsset?n.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return l()}};this.manager={get events(){var t,n;return(null==(t=e.schedule)||null==(n=t.events)?void 0:n.slice(0))||[]},get schedule(){var t,n;return(null==(t=e.schedule)||null==(n=t.items)?void 0:n.slice(0))||[]},get interstitialPlayer(){return l()?u:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const n=t();return e.findItemIndex(n)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const t=e.effectivePlayingItem;return e.findItemIndex(t)},primary:{get bufferedEnd(){return s()},get currentTime(){const t=e.timelinePos;return t>0?t:0},set currentTime(e){o(e,"primary")},get duration(){return a("primary")},get seekableStart(){var t;return(null==(t=e.primaryDetails)?void 0:t.fragmentStart)||0}},integrated:{get bufferedEnd(){return r(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return r(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(e){o(e,"integrated")},get duration(){return a("integrated")},get seekableStart(){var t;return i((null==(t=e.primaryDetails)?void 0:t.fragmentStart)||0,"integrated")}},skip:()=>{const t=e.effectivePlayingItem,n=null==t?void 0:t.event;if(n&&!n.restrictions.skip){const r=e.findItemIndex(t);if(n.appendInPlace){const e=t.playout.start+t.event.duration;o(e+.001,"playout")}else e.advanceAfterAssetEnded(n,r,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,n=null==(e=this.schedule)?void 0:e.items;return!!(this.playbackStarted&&t&&n)&&this.findItemIndex(t)===n.length-1}get playbackStarted(){return null!==this.effectivePlayingItem}get currentTime(){var e,t,n;if(null===this.mediaSelection)return;const r=this.waitingItem||this.playingItem;if(this.isInterstitial(r)&&!r.event.appendInPlace)return;let i=this.media;!i&&null!=(e=this.bufferingItem)&&null!=(t=e.event)&&t.appendInPlace&&(i=this.primaryMedia);const s=null==(n=i)?void 0:n.currentTime;return void 0!==s&&Gm(s)?s:void 0}get primaryMedia(){var e;return this.media||(null==(e=this.detachedData)?void 0:e.media)||null}isInterstitial(e){return!(null==e||!e.event)}retreiveMediaSource(e,t){const n=this.getAssetPlayer(e);n&&this.transferMediaFromPlayer(n,t)}transferMediaFromPlayer(e,t){const n=e.interstitial.appendInPlace,r=e.media;if(n&&r===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&r)return void(this.detachedData={media:r});const n=e.transferMedia();this.log(`transfer MediaSource from ${e} ${kv(n)}`),this.detachedData=n}else t&&r&&(this.shouldPlay||(this.shouldPlay=!r.paused))}transferMediaTo(e,t){var n,r;if(e.media===t)return;let i=null;const s=this.hls,a=e!==s,o=a&&e.interstitial.appendInPlace,l=null==(n=this.detachedData)?void 0:n.mediaSource;let u;if(s.media)o&&(i=s.transferMedia(),this.detachedData=i),u="Primary";else if(l){const e=this.getBufferingPlayer();e?(i=e.transferMedia(),u=`${e}`):u="detached MediaSource"}else u="detached media";if(!i)if(l)i=this.detachedData,this.log(`using detachedData: MediaSource ${kv(i)}`);else if(!this.detachedData||s.media===t){const e=this.playerQueue;e.length>1&&e.forEach(e=>{if(a&&e.interstitial.appendInPlace!==o){const t=e.interstitial;this.clearInterstitial(e.interstitial,null),t.appendInPlace=!1,t.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${t}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}const c=i&&"mediaSource"in i&&"closed"!==(null==(r=i.mediaSource)?void 0:r.readyState),d=c&&i?i:t;if(this.log(`${c?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${u}`),d===i){const t=a&&e.assetId===this.schedule.assetIdAtEnd;d.overrides={duration:this.schedule.duration,endOfStream:!a||t,cueRemoval:!a}}e.attachMedia(d)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e.events;if(!t||this.playbackDisabled||!this.media)return;-1===this.bufferedPos&&(this.bufferedPos=0);const n=this.timelinePos,r=this.effectivePlayingItem;if(-1===n){const n=this.hls.startPosition;if(this.timelinePos=n,t.length&&t[0].cue.pre){const n=e.findEventIndex(t[0].identifier);this.setSchedulePosition(n)}else if(n>=0||!this.primaryLive){const t=this.timelinePos=n>0?n:0,r=e.findItemIndexAtTime(t);this.setSchedulePosition(r)}}else if(r&&!this.playingItem){const t=e.findItemIndex(r);this.setSchedulePosition(t)}}advanceAfterAssetEnded(e,t,n){const r=FS(e,n);if(e.isAssetPastPlayoutLimit(r)){const n=this.schedule.items;if(n){const r=t+1;if(r>=n.length)return void this.setSchedulePosition(-1);const i=e.resumeTime;this.timelinePos<i&&(this.timelinePos=i,this.checkBuffer()),this.setSchedulePosition(r)}}else this.setSchedulePosition(t,r)}setScheduleToAssetAtTime(e,t){const n=this.schedule,r=t.parentIdentifier,i=n.getEvent(r);if(i){const t=n.findEventIndex(r),s=n.findAssetIndex(i,e);this.advanceAfterAssetEnded(i,t,s-1)}}setSchedulePosition(e,t){const n=this.schedule.items;if(!n||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${t}`);const r=e>=0?n[e]:null,i=this.playingItem,s=this.playingLastItem;if(this.isInterstitial(i)){var a;const l=i.event,u=this.playingAsset,c=null==u?void 0:u.identifier,d=c?this.getAssetPlayer(c):null;if(d&&c&&(!this.eventItemsMatch(i,r)||void 0!==t&&c!==(null==(a=l.assetList)?void 0:a[t].identifier))){var o;const t=l.findAssetIndex(u);if(this.log(`INTERSTITIAL_ASSET_ENDED ${t+1}/${l.assetList.length} ${US(u)}`),this.endedAsset=u,this.playingAsset=null,this.hls.trigger(qm.INTERSTITIAL_ASSET_ENDED,{asset:u,assetListIndex:t,event:l,schedule:n.slice(0),scheduleIndex:e,player:d}),i!==this.playingItem)return void(this.itemsMatch(i,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(l,this.findItemIndex(this.playingItem),t));this.retreiveMediaSource(c,r),!d.media||null!=(o=this.detachedData)&&o.mediaSource||d.detachMedia()}if(!this.eventItemsMatch(i,r)&&(this.endedItem=i,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${l} ${zS(i)}`),l.hasPlayed=!0,this.hls.trigger(qm.INTERSTITIAL_ENDED,{event:l,schedule:n.slice(0),scheduleIndex:e}),l.cue.once)){this.updateSchedule();const e=this.schedule.items;if(r&&e){const n=this.findItemIndex(r);this.advanceSchedule(n,e,t,i,s)}return}}this.advanceSchedule(e,n,t,i,s)}advanceSchedule(e,t,n,r,i){const s=e>=0?t[e]:null,a=this.primaryMedia,o=this.playerQueue;if(o.length&&o.forEach(t=>{const n=t.interstitial,r=this.schedule.findEventIndex(n.identifier);(r<e||r>e+1)&&this.clearInterstitial(n,s)}),this.isInterstitial(s)){this.timelinePos=Math.min(Math.max(this.timelinePos,s.start),s.end);const i=s.event;if(void 0===n){const t=FS(i,(n=this.schedule.findAssetIndex(i,this.timelinePos))-1);if(i.isAssetPastPlayoutLimit(t))return void this.advanceAfterAssetEnded(i,e,n);n=t}const o=this.waitingItem;this.assetsBuffered(s,a)||this.setBufferingItem(s);let l=this.preloadAssets(i,n);if(this.eventItemsMatch(s,o||r)||(this.waitingItem=s,this.log(`INTERSTITIAL_STARTED ${zS(s)} ${i.appendInPlace?"append in place":""}`),this.hls.trigger(qm.INTERSTITIAL_STARTED,{event:i,schedule:t.slice(0),scheduleIndex:e})),!i.assetListLoaded)return void this.log(`Waiting for ASSET-LIST to complete loading ${i}`);if(i.assetListLoader&&(i.assetListLoader.destroy(),i.assetListLoader=void 0),!a)return void this.log(`Waiting for attachMedia to start Interstitial ${i}`);this.waitingItem=this.endedItem=null,this.playingItem=s;const u=i.assetList[n];if(!u){const r=t[e+1],s=this.media;return r&&s&&!this.isInterstitial(r)&&s.currentTime<r.start&&(s.currentTime=this.timelinePos=r.start),void this.advanceAfterAssetEnded(i,e,n||0)}if(l||(l=this.getAssetPlayer(u.identifier)),null===l||l.destroyed){const e=i.assetList.length;this.warn(`asset ${n+1}/${e} player destroyed ${i}`),l=this.createAssetPlayer(i,u,n)}if(!this.eventItemsMatch(s,this.bufferingItem)&&i.appendInPlace&&this.isAssetBuffered(u))return;this.startAssetPlayer(l,n,t,e,a),this.shouldPlay&&HS(l.media)}else null!==s?(this.resumePrimary(s,e,r),this.shouldPlay&&HS(this.hls.media)):i&&this.isInterstitial(r)&&(this.endedItem=null,this.playingItem=r,r.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return!1===this.hls.config.enableInterstitialPlayback}get primaryDetails(){var e,t;return null==(e=this.mediaSelection)||null==(t=e.main)?void 0:t.details}get primaryLive(){var e;return!(null==(e=this.primaryDetails)||!e.live)}resumePrimary(e,t,n){var r;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${zS(e)}`),null==(r=this.detachedData)||!r.mediaSource){let n=this.timelinePos;(n<e.start||n>=e.end)&&(n=this.getPrimaryResumption(e,t),this.timelinePos=n),this.attachPrimary(n,e)}if(!n)return;const i=this.schedule.items;i&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${zS(e)}`),this.hls.trigger(qm.INTERSTITIALS_PRIMARY_RESUMED,{schedule:i.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const n=e.start;if(this.primaryLive){const e=this.primaryDetails;if(0===t)return this.hls.startPosition;if(e&&(n<e.fragmentStart||n>e.edge))return this.hls.liveSyncPosition||-1}return n}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);if(null!=t&&t.hls)return t.hls.bufferedToEnd;return My.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,n){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const r=this.primaryMedia;if(!r)return;const i=this.hls;i.media?this.checkBuffer():(this.transferMediaTo(i,r),n&&this.startLoadingPrimaryAt(e,n)),n||(this.timelinePos=e,this.startLoadingPrimaryAt(e,n))}startLoadingPrimaryAt(e,t){var n;const r=this.hls;!r.loadingEnabled||!r.media||Math.abs(((null==(n=r.mainForwardBufferInfo)?void 0:n.start)||r.media.currentTime)-e)>.5?r.startLoad(e,t):r.bufferingEnabled||r.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(qm.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(qm.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(-1===t.level)return;const n=this.hls.levels[t.level],r=ig(ig({},this.mediaSelection||this.altSelection),{},{main:n});this.mediaSelection=r,this.schedule.parseInterstitialDateRanges(r,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const n=this.hls.audioTracks[t.id],r=this.mediaSelection;if(!r)return void(this.altSelection=ig(ig({},this.altSelection),{},{audio:n}));const i=ig(ig({},r),{},{audio:n});this.mediaSelection=i}onSubtitleTrackUpdated(e,t){const n=this.hls.subtitleTracks[t.id],r=this.mediaSelection;if(!r)return void(this.altSelection=ig(ig({},this.altSelection),{},{subtitles:n}));const i=ig(ig({},r),{},{subtitles:n});this.mediaSelection=i}onAudioTrackSwitching(e,t){const n=Uv(t);this.playerQueue.forEach(e=>e.hls.setAudioOption(t)||e.hls.setAudioOption(n))}onSubtitleTrackSwitch(e,t){const n=Uv(t);this.playerQueue.forEach(e=>e.hls.setSubtitleOption(t)||-1!==t.id&&e.hls.setSubtitleOption(n))}onBufferCodecs(e,t){const n=t.tracks;n&&(this.requiredTracks=n)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const n=this.playingItem;if(n&&!this.itemsMatch(n,this.bufferingItem)&&!this.isInterstitial(n)){const e=this.timelinePos;this.bufferedPos=e,this.checkBuffer()}}onBufferedToEnd(e){const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let e=0;e<t.length;e++){const r=t[e];if(r.cue.post){var n;const e=this.schedule.findEventIndex(r.identifier),t=null==(n=this.schedule.items)?void 0:n[e];this.isInterstitial(t)&&this.eventItemsMatch(t,this.bufferingItem)&&this.bufferedToItem(t,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const e=this.findItemIndex(t);this.setSchedulePosition(e+1)}else this.shouldPlay=!1}updateItem(e,t){const n=this.schedule.items;if(e&&n){return n[this.findItemIndex(e,t)]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((t,n)=>{e.event.isAssetPastPlayoutLimit(n)&&this.clearAssetPlayer(t.identifier,null)});const t=e.end+.25,n=My.bufferInfo(this.primaryMedia,t,0);(n.end>t||(n.nextStart||0)>t)&&(this.attachPrimary(t,null),this.flushFrontBuffer(t))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var n;return!!t&&(e===t||e.event.identifier===(null==(n=t.event)?void 0:n.identifier))}findItemIndex(e,t){return e?this.schedule.findItemIndex(e,t):-1}updateSchedule(){const e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){const t=this.schedule.items;if(!t)return;const n=My.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=n.len<1),this.updateBufferedPos(n.end,t,e)}updateBufferedPos(e,t,n){const r=this.schedule,i=this.bufferingItem;if(this.bufferedPos>e)return;if(1===t.length&&this.itemsMatch(t[0],i))return void(this.bufferedPos=e);const s=this.playingItem,a=this.findItemIndex(s);let o=r.findItemIndexAtTime(e);if(this.bufferedPos<e){var l,u;const n=this.findItemIndex(i),r=Math.min(n+1,t.length-1),s=t[r];if((-1===o&&i&&e>=i.end||null!=(l=s.event)&&l.appendInPlace&&e+.01>=s.start)&&(o=r),r-a>1&&!1===(null==i||null==(u=i.event)?void 0:u.appendInPlace))return;if(this.bufferedPos=e,o>n&&o>a)this.bufferedToItem(s);else{const t=this.primaryDetails;this.primaryLive&&t&&e>t.edge-t.targetduration&&s.start<t.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(s)&&this.preloadAssets(s.event,0)}}else n&&s&&!this.itemsMatch(s,i)&&(o===a?this.bufferedToItem(s):o===a+1&&this.bufferedToItem(t[o]))}assetsBuffered(e,t){return 0!==e.event.assetList.length&&!e.event.assetList.some(e=>{const n=this.getAssetPlayer(e.identifier);return!(null!=n&&n.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,n=this.schedule;if(this.itemsMatch(e,t))this.bufferingItem!==e&&(this.bufferingItem=e);else{const{items:r,events:i}=n;if(!r||!i)return t;const s=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const o=a?a.remaining:t?t.end-this.timelinePos:0;this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${zS(e)}`+(t?` (${o.toFixed(2)} remaining)`:"")),this.playbackDisabled||(s?e.event.assetList.forEach(e=>{const t=this.getAssetPlayer(e.identifier);t&&t.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(e=>e.pauseBuffering()))),this.hls.trigger(qm.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:i.slice(0),schedule:r.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return t}bufferedToItem(e,t=0){const n=this.setBufferingItem(e);if(!this.playbackDisabled)if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(null!==n){this.bufferingAsset=null;const t=this.detachedData;if(t)if(t.mediaSource){const t=!0;this.attachPrimary(e.start,e,t)}else this.preloadPrimary(e);else this.preloadPrimary(e)}}preloadPrimary(e){const t=this.findItemIndex(e),n=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(n)}bufferedToEvent(e,t){const n=e.event,r=0===n.assetList.length&&!n.assetListLoader,i=n.cue.once;if(r||!i){const e=this.preloadAssets(n,t);if(null!=e&&e.interstitial.appendInPlace){const r=n.assetList[t],i=this.primaryMedia;r&&i&&this.bufferAssetPlayer(e,i)}}}preloadAssets(e,t){const n=e.assetUrl,r=e.assetList.length,i=0===r&&!e.assetListLoader,s=e.cue.once;if(i){const i=e.timelineStart;if(e.appendInPlace){var a;const t=this.playingItem;this.isInterstitial(t)||(null==t||null==(a=t.nextEvent)?void 0:a.identifier)!==e.identifier||this.flushFrontBuffer(i+.25)}let s,o=0;if(!this.playingItem&&this.primaryLive&&(o=this.hls.startPosition,-1===o&&(o=this.hls.liveSyncPosition||0)),o&&!e.cue.pre&&!e.cue.post){const e=o-i;e>0&&(s=Math.round(1e3*e)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${n?1:r} ${e}${s?` live-start: ${o} start-offset: ${s}`:""}`),n)return this.createAsset(e,0,0,i,e.duration,n);const l=this.assetListLoader.loadAssetList(e,s);l&&(e.assetListLoader=l)}else if(!s&&r){for(let n=t;n<r;n++){const t=e.assetList[n],r=this.getAssetPlayerQueueIndex(t.identifier);-1!==r&&!this.playerQueue[r].destroyed||t.error||this.createAssetPlayer(e,t,n)}return this.getAssetPlayer(e.assetList[t].identifier)}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`);Object.keys(t).forEach(t=>{this.hls.trigger(qm.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:t})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let n=0;n<t.length;n++)if(e===t[n].assetId)return n;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t)for(let n=0;n<e.length;n++)if(e[n].media===t)return e[n];return null}createAsset(e,t,n,r,i,s){const a={parentIdentifier:e.identifier,identifier:NS(e,s,t),duration:i,startOffset:n,timelineStart:r,uri:s};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,n){const r=this.hls,i=r.userConfig;let s=i.videoPreference;const a=r.loadLevelObj||r.levels[r.currentLevel];(s||a)&&(s=ng({},s),a.videoCodec&&(s.videoCodec=a.videoCodec),a.videoRange&&(s.allowedVideoRanges=[a.videoRange]));const o=r.audioTracks[r.audioTrack],l=r.subtitleTracks[r.subtitleTrack];let u=0;if(this.primaryLive||e.appendInPlace){const e=this.timelinePos-t.timelineStart;if(e>1){const n=t.duration;n&&e<n&&(u=e)}}const c=t.identifier,d=ig(ig({},i),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:r.sessionId,assetPlayerId:c,abrEwmaDefaultEstimate:r.bandwidthEstimate,interstitialsController:void 0,startPosition:u,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:s,audioPreference:o||i.audioPreference,subtitlePreference:l||i.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(d.timelineOffset=t.timelineStart));const h=d.cmcd;null!=h&&h.sessionId&&h.contentId&&(d.cmcd=ng({},h,{contentId:IS(t.uri)})),this.getAssetPlayer(c)&&this.warn(`Duplicate date range identifier ${e} and asset ${c}`);const f=new BS(this.HlsPlayerClass,d,e,t);this.playerQueue.push(f),e.assetList[n]=t;const p=r=>{if(r.live){const t=new Error(`Interstitials MUST be VOD assets ${e}`),r={fatal:!0,type:Wm.OTHER_ERROR,details:jm.INTERSTITIAL_ASSET_ITEM_ERROR,error:t};return void this.handleAssetItemError(r,e,this.schedule.findEventIndex(e.identifier),n,t.message)}const i=r.edge-r.fragmentStart,s=t.duration;(null===s||i>s)&&(this.log(`Interstitial asset "${c}" duration change ${s} > ${i}`),t.duration=i,this.updateSchedule())};f.on(qm.LEVEL_UPDATED,(e,{details:t})=>p(t)),f.on(qm.LEVEL_PTS_UPDATED,(e,{details:t})=>p(t));const m=(e,t)=>{const n=this.getAssetPlayer(c);if(n&&t.tracks){n.off(qm.BUFFER_CODECS,m),n.tracks=t.tracks;const e=this.primaryMedia;this.bufferingAsset===n.assetItem&&e&&!n.media&&this.bufferAssetPlayer(n,e)}};f.on(qm.BUFFER_CODECS,m);const g=()=>{var n;const r=this.getAssetPlayer(c);if(this.log(`buffered to end of asset ${r}`),!r)return;const i=this.schedule.findEventIndex(e.identifier),s=null==(n=this.schedule.items)?void 0:n[i];if(this.isInterstitial(s)){const n=e.findAssetIndex(t),r=FS(e,n);if(e.isAssetPastPlayoutLimit(r)){var a;const e=null==(a=this.schedule.items)?void 0:a[i+1];e&&this.bufferedToItem(e)}else this.bufferedToItem(s,r)}};f.on(qm.BUFFERED_TO_END,g);const v=t=>()=>{if(!this.getAssetPlayer(c))return;this.shouldPlay=!0;const n=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,n,t)};return f.once(qm.MEDIA_ENDED,v(n)),f.once(qm.PLAYOUT_LIMIT_REACHED,v(1/0)),f.on(qm.ERROR,(t,r)=>{const i=this.getAssetPlayer(c);if(r.details!==jm.BUFFER_STALLED_ERROR)this.handleAssetItemError(r,e,this.schedule.findEventIndex(e.identifier),n,`Asset player error ${r.error} ${e}`);else if(null!=i&&i.media){const t=i.currentTime,n=i.duration-t;t&&e.appendInPlace&&n/i.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${c} ${e} at ${i.media.currentTime}`),g()):(this.warn(`Stalled at ${t} of ${t+n} in asset ${c} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}}),f.on(qm.DESTROYING,()=>{if(!this.getAssetPlayer(c))return;const t=new Error(`Asset player destroyed unexpectedly ${c}`),r={fatal:!0,type:Wm.OTHER_ERROR,details:jm.INTERSTITIAL_ASSET_ITEM_ERROR,error:t};this.handleAssetItemError(r,e,this.schedule.findEventIndex(e.identifier),n,t.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${US(t)}`),this.hls.trigger(qm.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:n,event:e,player:f}),f}clearInterstitial(e,t){e.assetList.forEach(e=>{this.clearAssetPlayer(e.identifier,t)}),e.reset()}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(-1!==t){this.log(`reset asset player "${e}" after error`);const n=this.playerQueue[t];this.transferMediaFromPlayer(n,null),n.resetDetails()}}clearAssetPlayer(e,t){const n=this.getAssetPlayerQueueIndex(e);if(-1!==n){this.log(`clear asset player "${e}" toSegment: ${t?zS(t):t}`);const r=this.playerQueue[n];this.transferMediaFromPlayer(r,t),this.playerQueue.splice(n,1),r.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,n,r,i){const{interstitial:s,assetItem:a,assetId:o}=e,l=s.assetList.length,u=this.playingAsset;this.endedAsset=null,this.playingAsset=a,u&&u.identifier===o||(u&&(this.clearAssetPlayer(u.identifier,n[r]),delete u.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${l} ${US(a)}`),this.hls.trigger(qm.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:s,schedule:n.slice(0),scheduleIndex:r,player:e})),this.bufferAssetPlayer(e,i)}bufferAssetPlayer(e,t){var n,r;const{interstitial:i,assetItem:s}=e,a=this.schedule.findEventIndex(i.identifier),o=null==(n=this.schedule.items)?void 0:n[a];if(!o)return;this.setBufferingItem(o),this.bufferingAsset=s;const l=this.getBufferingPlayer();if(l===e)return;const u=i.appendInPlace;if(u&&!1===(null==l?void 0:l.interstitial.appendInPlace))return;const c=(null==l?void 0:l.tracks)||(null==(r=this.detachedData)?void 0:r.tracks)||this.requiredTracks;if(u&&s!==this.playingAsset){if(!e.tracks)return;if(c&&!fg(c,e.tracks)){const t=new Error(`Asset ${US(s)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(c)}')`),n={fatal:!0,type:Wm.OTHER_ERROR,details:jm.INTERSTITIAL_ASSET_ITEM_ERROR,error:t},r=i.findAssetIndex(s);return void this.handleAssetItemError(n,i,a,r,t.message)}}this.transferMediaTo(e,t)}handleAssetItemError(e,t,n,r,i){if(e.details===jm.BUFFER_STALLED_ERROR)return;const s=t.assetList[r];this.warn(`INTERSTITIAL_ASSET_ERROR ${s?US(s):s} ${e.error}`);const a=null==s?void 0:s.identifier,o=this.getAssetPlayerQueueIndex(a),l=this.playerQueue[o]||null,u=this.schedule.items,c=ng({},e,{fatal:!1,errorAction:iy(!0),asset:s,assetListIndex:r,event:t,schedule:u,scheduleIndex:n,player:l});if(this.hls.trigger(qm.INTERSTITIAL_ASSET_ERROR,c),!e.fatal)return;const d=this.playingAsset,h=new Error(i);if(s&&(this.clearAssetPlayer(a,null),s.error=h),t.assetList.some(e=>!e.error)){for(let e=r;e<t.assetList.length;e++)this.resetAssetPlayer(t.assetList[e].identifier);this.updateSchedule()}else t.error=h;t.error?this.primaryFallback(t):d&&d.identifier===a&&this.advanceAfterAssetEnded(t,n,r)}primaryFallback(e){const t=e.timelineStart,n=this.effectivePlayingItem;if(this.updateSchedule(),n){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${n?zS(n):"<none>"} error: ${e.error}`);let r=this.timelinePos;-1===r&&(r=this.hls.startPosition);const i=this.updateItem(n,r);this.itemsMatch(n,i)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));const s=this.schedule.findItemIndexAtTime(r);this.setSchedulePosition(s)}else this.checkStart()}onAssetListLoaded(e,t){var n;const r=t.event,i=r.identifier,s=t.assetListResponse.ASSETS;if(!this.schedule.hasEvent(i))return;const a=r.timelineStart,o=r.duration;let l=0;s.forEach((e,t)=>{const n=parseFloat(e.DURATION);this.createAsset(r,t,l,a+l,n,e.URI),l+=n}),r.duration=l,this.log(`Loaded asset-list with duration: ${l} (was: ${o}) ${r}`);const u=this.waitingItem,c=(null==u?void 0:u.event.identifier)===i;this.updateSchedule();const d=null==(n=this.bufferingItem)?void 0:n.event;if(c){var h;const e=this.schedule.findEventIndex(i),t=null==(h=this.schedule.items)?void 0:h[e];if(t){if(!this.playingItem&&this.timelinePos>t.end){if(this.schedule.findItemIndexAtTime(this.timelinePos)!==e)return r.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${r}`),void this.primaryFallback(r)}this.setBufferingItem(t)}this.setSchedulePosition(e)}else if((null==d?void 0:d.identifier)===i&&d.appendInPlace){const e=r.assetList[0],t=this.getAssetPlayer(e.identifier),n=this.primaryMedia;e&&t&&n&&this.bufferAssetPlayer(t,n)}}onError(e,t){switch(t.details){case jm.ASSET_LIST_PARSING_ERROR:case jm.ASSET_LIST_LOAD_ERROR:case jm.ASSET_LIST_LOAD_TIMEOUT:{const e=t.interstitial;e&&this.primaryFallback(e);break}case jm.BUFFER_STALLED_ERROR:this.onTimeupdate(),this.checkBuffer(!0)}}}});function QT(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(QT):Object.keys(e).reduce((t,n)=>(t[n]=QT(e[n]),t),{}):e}class ZT extends Ey{constructor(e,t){super("gap-controller",e.logger),this.hls=null,this.fragmentTracker=null,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var e;null!=(e=this.media)&&e.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{var e;this.hls&&(this.ended=(null==(e=this.media)?void 0:e.currentTime)||1,this.hls.trigger(qm.MEDIA_ENDED,{stalled:!1}))},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(qm.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(qm.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(100),this.mediaSource=t.mediaSource;const n=this.media=t.media;bS(n,"playing",this.onMediaPlaying),bS(n,"waiting",this.onMediaWaiting),bS(n,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:n}=this;n&&(_S(n,"playing",this.onMediaPlaying),_S(n,"waiting",this.onMediaWaiting),_S(n,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(null==(e=this.media)||!e.readyState||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var n,r;const i=null==(n=this.hls)?void 0:n.config;if(!i)return;const s=this.media;if(!s)return;const{seeking:a}=s,o=this.seeking&&!a,l=!this.seeking&&a,u=s.paused&&!a||s.ended||0===s.playbackRate;if(this.seeking=a,e!==t)return t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,i.nudgeOnVideoHole&&!u&&e>t&&this.nudgeOnVideoHole(e,t)),void(0===this.waiting&&this.stallResolved(e));if(l||o)return void(o&&this.stallResolved(e));if(u)return this.nudgeRetry=0,this.stallResolved(e),void(!this.ended&&s.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(qm.MEDIA_ENDED,{stalled:!1})));if(!My.getBuffered(s).length)return void(this.nudgeRetry=0);const c=My.bufferInfo(s,e,0),d=c.nextStart||0,h=this.fragmentTracker;if(a&&h&&this.hls){const t=JT(this.hls.inFlightFragments,e),n=c.len>2,r=!d||t||d-e>2&&!h.getPartialFragment(e);if(n||r)return;this.moved=!1}const f=null==(r=this.hls)?void 0:r.latestLevelDetails;if(!this.moved&&null!==this.stalled&&h){if(!(c.len>0)&&!d)return;const t=Math.max(d,c.start||0)-e,n=!(null==f||!f.live)?2*f.targetduration:2,r=h.getPartialFragment(e);if(t>0&&(t<=n||r))return void(s.paused||this._trySkipBufferHole(r))}const p=i.detectStallWithCurrentTimeMs,m=self.performance.now(),g=this.waiting;let v=this.stalled;if(null===v){if(!(g>0&&m-g<p))return void(this.stalled=m);v=this.stalled=g}const y=m-v;if(!a&&(y>=p||g)&&this.hls){var b;if("ended"===(null==(b=this.mediaSource)?void 0:b.readyState)&&(null==f||!f.live)&&Math.abs(e-((null==f?void 0:f.edge)||0))<1){if(this.ended)return;return this.ended=e||1,void this.hls.trigger(qm.MEDIA_ENDED,{stalled:!0})}if(this._reportStall(c),!this.media||!this.hls)return}const _=My.bufferInfo(s,e,i.maxBufferHole);this._tryFixBufferStall(_,y,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const n=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(n)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(qm.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var n;const r=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&null!=(n=this.buffered.audio)&&n.length&&r&&r.length>1&&e>r.end(0)){const n=My.bufferedInfo(My.timeRangesToArray(this.buffered.audio),e,0);if(n.len>1&&t>=n.start){const n=My.timeRangesToArray(r),i=My.bufferedInfo(n,t,0).bufferedIndex;if(i>-1&&i<n.length-1){const t=My.bufferedInfo(n,e,0).bufferedIndex,r=n[i].end,s=n[i+1].start;if((-1===t||t>i)&&s-r<1&&e-r<2){const n=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${r} -> ${s} buffered index: ${t}`);this.warn(n.message),this.media.currentTime+=1e-6;const i=this.fragmentTracker.getPartialFragment(e)||void 0,a=My.bufferInfo(this.media,e,0);this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:n,reason:n.message,frag:i,buffer:a.len,bufferInfo:a})}}}}}_tryFixBufferStall(e,t,n){var r,i;const{fragmentTracker:s,media:a}=this,o=null==(r=this.hls)?void 0:r.config;if(!a||!s||!o)return;const l=null==(i=this.hls)?void 0:i.latestLevelDetails,u=s.getPartialFragment(n);if(u||null!=l&&l.live&&n<l.fragmentStart){if(this._trySkipBufferHole(u)||!this.media)return}const c=e.buffered,d=this.adjacentTraversal(e,n);(c&&c.length>1&&e.len>o.maxBufferHole||e.nextStart&&(e.nextStart-n<o.maxBufferHole||d))&&(t>1e3*o.highBufferWatchdogPeriod||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const n=this.fragmentTracker,r=e.nextStart;if(n&&r){const e=n.getFragAtPos(t,Zm.MAIN),i=n.getFragAtPos(r,Zm.MAIN);if(e&&i)return i.sn-e.sn<2}return!1}_reportStall(e){const{hls:t,media:n,stallReported:r,stalled:i}=this;if(!r&&null!==i&&n&&t){this.stallReported=!0;const r=new Error(`Playback stalling at @${n.currentTime} due to low buffer (${kv(e)})`);this.warn(r.message),t.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len,bufferInfo:e,stalled:{start:i}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:n,media:r}=this,i=null==(t=this.hls)?void 0:t.config;if(!r||!n||!i)return 0;const s=r.currentTime,a=My.bufferInfo(r,s,0),o=s<a.start?a.start:a.nextStart;if(o&&this.hls){const t=a.len<=i.maxBufferHole,u=a.len>0&&a.len<1&&r.readyState<3,c=o-s;if(c>0&&(t||u)){if(c>i.maxBufferHole){let t=!1;if(0===s){const e=n.getAppendedFrag(0,Zm.MAIN);e&&o<e.end&&(t=!0)}if(!t){const t=e||n.getAppendedFrag(s,Zm.MAIN);if(t){var l;if(null==(l=this.hls.loadLevelObj)||!l.details)return 0;if(JT(this.hls.inFlightFragments,o))return 0;let e=!1,r=t.end;for(;r<o;){const t=n.getAppendedFrag(r,Zm.MAIN)||n.getPartialFragment(r);if(!t){e=!0;break}r+=t.duration}if(e)return 0}}}const t=Math.max(o+.05,s+.1);if(this.warn(`skipping hole, adjusting currentTime from ${s} to ${t}`),this.moved=!0,r.currentTime=t,null==e||!e.gap){const n=new Error(`fragment loaded with buffer holes, seeking from ${s} to ${t}`);this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:n,reason:n.message,frag:e||void 0,buffer:a.len,bufferInfo:a})}return t}}return 0}_tryNudgeBuffer(e){const{hls:t,media:n,nudgeRetry:r}=this,i=null==t?void 0:t.config;if(!n||!i)return 0;const s=n.currentTime;if(this.nudgeRetry++,r<i.nudgeMaxRetry){const a=s+(r+1)*i.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${s} to ${a}`);this.warn(o.message),n.currentTime=a,t.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1,buffer:e.len,bufferInfo:e})}else{const n=new Error(`Playhead still not moving while enough data buffered @${s} after ${i.nudgeMaxRetry} nudges`);this.error(n.message),t.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.BUFFER_STALLED_ERROR,error:n,fatal:!0,buffer:e.len,bufferInfo:e})}}}function JT(e,t){const n=eE(e.main);if(n&&n.start<=t)return n;const r=eE(e.audio);return r&&r.start<=t?r:null}function eE(e){if(!e)return null;switch(e.state){case Ob:case kb:case Hb:case $b:return null}return e.frag}function tE(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function nE(e,t,n,r,i){let s=new e(t,n,"");try{s.value=r,i&&(s.type=i)}catch(a){s=new e(t,n,kv(i?ig({type:i},r):r))}return s}const rE=(()=>{const e=tE();try{e&&new e(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class iE{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(qm.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e.on(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(qm.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(qm.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(qm.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(qm.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(qm.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(qm.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(qm.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}onMediaAttaching(e,t){var n;this.media=t.media,!1===(null==(n=t.overrides)?void 0:n.cueRemoval)&&(this.removeCues=!1)}onMediaAttached(){const e=this.hls.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(e,t){this.media=null;!!t.transferMedia||(this.id3Track&&(this.removeCues&&wS(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const n=e[t];if("metadata"===n.kind&&"id3"===n.label)return ES(n,this.media),n}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:n,enableID3MetadataCues:r}}}=this;if(!n&&!r)return;const{samples:i}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const s=tE();if(s)for(let e=0;e<i.length;e++){const t=i[e].type;if(t===T_.emsg&&!n||!r)continue;const a=b_(i[e].data);if(a){const n=i[e].pts;let r=n+i[e].duration;r>rE&&(r=rE);r-n<=0&&(r=n+.25);for(let e=0;e<a.length;e++){const i=a[e];if(!__(i)){this.updateId3CueEnds(n,t);const e=nE(s,n,r,i,t);e&&this.id3Track.addCue(e)}}}}}updateId3CueEnds(e,t){var n;const r=null==(n=this.id3Track)?void 0:n.cues;if(r)for(let n=r.length;n--;){const i=r[n];i.type===t&&i.startTime<e&&i.endTime===rE&&(i.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:n,type:r}){const{id3Track:i,hls:s}=this;if(!s)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:o}}=s;if(i&&(a||o)){let e;e="audio"===r?e=>e.type===T_.audioId3&&o:"video"===r?e=>e.type===T_.emsg&&a:e=>e.type===T_.audioId3&&o||e.type===T_.emsg&&a,MS(i,t,n,e)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{id3Track:n}=this,{dateRanges:r}=e,i=Object.keys(r);let s=this.dateRangeCuesAppended;var a;if(n&&t)if(null!=(a=n.cues)&&a.length){const e=Object.keys(s).filter(e=>!i.includes(e));for(let t=e.length;t--;){const r=e[t],i=s[r].cues;delete s[r],Object.keys(i).forEach(e=>{try{const t=i[e];t.removeEventListener("enter",this.onEventCueEnter),n.removeCue(t)}catch(e){}})}}else s=this.dateRangeCuesAppended={};const o=e.fragments[e.fragments.length-1];if(0===i.length||!Gm(null==o?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const l=tE();for(let e=0;e<i.length;e++){const t=i[e],n=r[t],a=n.startTime,o=s[t],u=(null==o?void 0:o.cues)||{};let c=(null==o?void 0:o.durationKnown)||!1,d=rE;const{duration:h,endDate:f}=n;if(f&&null!==h)d=a+h,c=!0;else if(n.endOnNext&&!c){const e=i.reduce((e,t)=>{if(t!==n.id){const i=r[t];if(i.class===n.class&&i.startDate>n.startDate&&(!e||n.startDate<e.startDate))return i}return e},null);e&&(d=e.startTime,c=!0)}const p=Object.keys(n.attr);for(let e=0;e<p.length;e++){const r=p[e];if(!Oy(r))continue;const i=u[r];if(i)c&&!o.durationKnown?i.endTime=d:Math.abs(i.startTime-a)>.01&&(i.startTime=a,i.endTime=d);else if(l){let e=n.attr[r];Fy(r)&&(e=gg(e));const i=nE(l,a,d,{key:r,data:e},T_.dateRange);i&&(i.id=t,this.id3Track.addCue(i),u[r]=i,this.hls.config.interstitialsController&&("X-ASSET-LIST"!==r&&"X-ASSET-URL"!==r||i.addEventListener("enter",this.onEventCueEnter)))}}s[t]={cues:u,dateRange:n,durationKnown:c}}}}class sE{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:e}=this,t=this.levelDetails;if(!e||!t)return;this.currentTime=e.currentTime;const n=this.computeLatency();if(null===n)return;this._latency=n;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:i}=this.config;if(!r||1===i||!t.live)return;const s=this.targetLatency;if(null===s)return;const a=n-s;if(a<Math.min(this.maxLatency,s+t.targetduration)&&a>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,i)),n=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20,r=Math.min(t,Math.max(1,n));this.changeMediaPlaybackRate(e,r)}else 1!==e.playbackRate&&0!==e.playbackRate&&this.changeMediaPlaybackRate(e,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return(null==(e=this.hls)?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(void 0!==e.liveMaxLatencyDuration)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(null===e||null===this.hls)return null;const{holdBack:t,partHoldBack:n,targetduration:r}=e,{liveSyncDuration:i,liveSyncDurationCount:s,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&n||t;(this._targetLatencyUpdated||o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==i?i:s*r);const u=r;return l+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,u)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(null===e||null===t)return null;const n=this.levelDetails;if(null===n)return null;const r=n.edge,i=e-t-this.edgeStalled,s=r-n.totalduration,a=r-(this.config.lowLatencyMode&&n.partTarget||n.targetduration);return Math.min(Math.max(s,i),a)}get drift(){const e=this.levelDetails;return null===e?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const n=e.buffered.length;return(n?e.buffered.end(n-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(qm.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(qm.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(qm.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(qm.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var n;t.details===jm.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&null!=(n=this.levelDetails)&&n.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var n,r;e.playbackRate!==t&&(null==(n=this.hls)||n.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${null==(r=this.targetLatency)?void 0:r.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}class aE extends Ax{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.on(qm.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(qm.FRAG_BUFFERED,this.onFragBuffered,this),e.on(qm.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.off(qm.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(qm.FRAG_BUFFERED,this.onFragBuffered,this),e.off(qm.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(e=>{e.loadError=0,e.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const n=this.hls.config.preferManagedMediaSource,r=[],i={},s={};let a=!1,o=!1,l=!1;t.levels.forEach(e=>{const t=e.attrs;let{audioCodec:u,videoCodec:c}=e;u&&(e.audioCodec=u=mv(u,n)||void 0),c&&(c=e.videoCodec=function(e){const t=e.split(",");for(let e=0;e<t.length;e++){const n=t[e].split(".");n.length>2&&"avc1"===n[0]&&(t[e]=`avc1.${parseInt(n[1]).toString(16)}${("000"+parseInt(n[2]).toString(16)).slice(-4)}`)}return t.join(",")}(c));const{width:d,height:h,unknownCodecs:f}=e;let p=f?f.length:0;if(f)for(let t=p;t--;){const n=f[t];this.isAudioSupported(n)?(e.audioCodec=u=u?`${u},${n}`:n,p--,av.audio[u.substring(0,4)]=2):this.isVideoSupported(n)&&(e.videoCodec=c=c?`${c},${n}`:n,p--,av.video[c.substring(0,4)]=2)}if(a||(a=!(!d||!h)),o||(o=!!c),l||(l=!!u),p||u&&!this.isAudioSupported(u)||c&&!this.isVideoSupported(c))return void this.log(`Some or all CODECS not supported "${t.CODECS}"`);const{CODECS:m,"FRAME-RATE":g,"HDCP-LEVEL":v,"PATHWAY-ID":y,RESOLUTION:b,"VIDEO-RANGE":_}=t,x=`${`${y||"."}-`}${e.bitrate}-${b}-${g}-${m}-${_}-${v}`;if(i[x])if(i[x].uri===e.url||e.attrs["PATHWAY-ID"])i[x].addGroupId("audio",t.AUDIO),i[x].addGroupId("text",t.SUBTITLES);else{const t=s[x]+=1;e.attrs["PATHWAY-ID"]=new Array(t+1).join(".");const n=this.createLevel(e);i[x]=n,r.push(n)}else{const t=this.createLevel(e);i[x]=t,s[x]=1,r.push(t)}}),this.filterAndSortMediaOptions(r,t,a,o,l)}createLevel(e){const t=new Pv(e),n=e.supplemental;if(null!=n&&n.videoCodec&&!this.isVideoSupported(n.videoCodec)){const e=new Error(`SUPPLEMENTAL-CODECS not supported "${n.videoCodec}"`);this.log(e.message),t.supportedResult=Sv(e,[])}return t}isAudioSupported(e){return lv(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return lv(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,n,r,i){let s=[],a=[],o=e;if((n||r)&&i&&(o=o.filter(({videoCodec:e,videoRange:t,width:n,height:r})=>{return(!!e||!(!n||!r))&&(!!(i=t)&&Rv.indexOf(i)>-1);var i})),0===o.length)return void Promise.resolve().then(()=>{if(this.hls){let e="no level with compatible codecs found in manifest",n=e;t.levels.length&&(n=`one or more CODECS in variant not supported: ${kv(t.levels.map(e=>e.attrs.CODECS).filter((e,t,n)=>n.indexOf(e)===t))}`,this.warn(n),e+=` (${n})`);const r=new Error(e);this.hls.trigger(qm.ERROR,{type:Wm.MEDIA_ERROR,details:jm.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:r,reason:n})}});t.audioTracks&&(s=t.audioTracks.filter(e=>!e.audioCodec||this.isAudioSupported(e.audioCodec)),oE(s)),t.subtitles&&(a=t.subtitles,oE(a));const l=o.slice(0);o.sort((e,t)=>{if(e.attrs["HDCP-LEVEL"]!==t.attrs["HDCP-LEVEL"])return(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1;if(n&&e.height!==t.height)return e.height-t.height;if(e.frameRate!==t.frameRate)return e.frameRate-t.frameRate;if(e.videoRange!==t.videoRange)return Rv.indexOf(e.videoRange)-Rv.indexOf(t.videoRange);if(e.videoCodec!==t.videoCodec){const n=dv(e.videoCodec),r=dv(t.videoCodec);if(n!==r)return r-n}if(e.uri===t.uri&&e.codecSet!==t.codecSet){const n=hv(e.codecSet),r=hv(t.codecSet);if(n!==r)return r-n}return e.averageBitrate!==t.averageBitrate?e.averageBitrate-t.averageBitrate:0});let u=l[0];if(this.steering&&(o=this.steering.filterParsedLevels(o),o.length!==l.length))for(let e=0;e<l.length;e++)if(l[e].pathwayId===o[0].pathwayId){u=l[e];break}this._levels=o;for(let e=0;e<o.length;e++)if(o[e]===u){var c;this._firstLevel=e;const t=u.bitrate,n=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${o.length} level(s) found, first bitrate: ${t}`),void 0===(null==(c=this.hls.userConfig)?void 0:c.abrEwmaDefaultEstimate)){const e=Math.min(t,this.hls.config.abrEwmaDefaultEstimateMax);e>n&&n===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=e)}break}const d=i&&!r,h=this.hls.config,f=!(!h.audioStreamController||!h.audioTrackController),p={levels:o,audioTracks:s,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:i,video:r,altAudio:f&&!d&&s.some(e=>!!e.url)};this.hls.trigger(qm.MANIFEST_PARSED,p)}get levels(){return 0===this._levels.length?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(0===t.length)return;if(e<0||e>=t.length){const n=new Error("invalid level idx"),r=e<0;if(this.hls.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.LEVEL_SWITCH_ERROR,level:e,fatal:r,error:n,reason:n.message}),r)return;e=Math.min(e,t.length-1)}const n=this.currentLevelIndex,r=this.currentLevel,i=r?r.attrs["PATHWAY-ID"]:void 0,s=t[e],a=s.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=s,n===e&&r&&i===a)return;this.log(`Switching to level ${e} (${s.height?s.height+"p ":""}${s.videoRange?s.videoRange+" ":""}${s.codecSet?s.codecSet+" ":""}@${s.bitrate})${a?" with Pathway "+a:""} from level ${n}${i?" with Pathway "+i:""}`);const o={level:e,attrs:s.attrs,details:s.details,bitrate:s.bitrate,averageBitrate:s.averageBitrate,maxBitrate:s.maxBitrate,realBitrate:s.realBitrate,width:s.width,height:s.height,codecSet:s.codecSet,audioCodec:s.audioCodec,videoCodec:s.videoCodec,audioGroups:s.audioGroups,subtitleGroups:s.subtitleGroups,loaded:s.loaded,loadError:s.loadError,fragmentError:s.fragmentError,name:s.name,id:s.id,uri:s.uri,url:s.url,urlId:0,audioGroupIds:s.audioGroupIds,textGroupIds:s.textGroupIds};this.hls.trigger(qm.LEVEL_SWITCHING,o);const l=s.details;if(!l||l.live){const e=this.switchParams(s.uri,null==r?void 0:r.details,l);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),n=e.filter(e=>-1!==t.indexOf(e));if(e.length<1)return void this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);this.steering.pathwayPriority=n}}onError(e,t){!t.fatal&&t.context&&t.context.type===Ym&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(void 0!==t&&t.type===Zm.MAIN){const e=t.elementaryStreams;if(!Object.keys(e).some(t=>!!e[t]))return;const n=this._levels[t.level];null!=n&&n.loadError&&(this.log(`Resetting level error count of ${n.loadError} on frag buffered`),n.loadError=0)}}onLevelLoaded(e,t){var n;const{level:r,details:i}=t,s=t.levelInfo;var a;if(!s)return this.warn(`Invalid level index ${r}`),void(null!=(a=t.deliveryDirectives)&&a.skip&&(i.deltaUpdateFailed=!0));if(s===this.currentLevel||t.withoutMultiVariant){0===s.fragmentError&&(s.loadError=0);let e=s.details;e===t.details&&e.advanced&&(e=void 0),this.playlistLoaded(r,t,e)}else null!=(n=t.deliveryDirectives)&&n.skip&&(i.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const n=this.getUrlWithDirectives(e.uri,t),r=this.currentLevelIndex,i=e.attrs["PATHWAY-ID"],s=e.details,a=null==s?void 0:s.age;this.log(`Loading level index ${r}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${i?" Pathway "+i:""}${a&&s.live?" age "+a.toFixed(1)+(s.type&&" "+s.type||""):""} ${n}`),this.hls.trigger(qm.LEVEL_LOADING,{url:n,level:r,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(1===this._levels.length)return;const n=this._levels.filter((t,n)=>n!==e||(this.steering&&this.steering.removeLevel(t),t===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,t.details&&t.details.fragments.forEach(e=>e.level=-1)),!1));Rb(n),this._levels=n,this.currentLevelIndex>-1&&null!=(t=this.currentLevel)&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const r=n.length-1;this._firstLevel=Math.min(this._firstLevel,r),this._startLevel&&(this._startLevel=Math.min(this._startLevel,r)),this.hls.trigger(qm.LEVELS_UPDATED,{levels:n})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:n}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(qm.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:n}))}}function oE(e){const t={};e.forEach(e=>{const n=e.groupId||"";e.id=t[n]=t[n]||0,t[n]++})}function lE(){return self.SourceBuffer||self.WebKitSourceBuffer}function uE(){if(!hg())return!1;const e=lE();return!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove}function cE(){if(!uE())return!1;const e=hg();return"function"==typeof(null==e?void 0:e.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(t=>e.isTypeSupported(cv(t,"video")))||["mp4a.40.2","fLaC"].some(t=>e.isTypeSupported(cv(t,"audio"))))}class dE extends qb{constructor(e,t,n){super(e,t,n,"stream-controller",Zm.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const e=this.media,t=e?e.currentTime:null;if(null===t||!Gm(t))return;if(this.log(`Media seeked to ${t.toFixed(3)}`),!this.getBufferedFrag(t))return;const n=this.getFwdBufferInfoAtPos(e,t,Zm.MAIN,0);null!==n&&0!==n.len?this.tick():this.warn(`Main forward buffer length at ${t} on "seeked" event ${n?n.len:"empty"})`)},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.on(qm.LEVEL_LOADING,this.onLevelLoading,this),e.on(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.on(qm.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(qm.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(qm.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(qm.BUFFER_CREATED,this.onBufferCreated,this),e.on(qm.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(qm.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(qm.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(qm.MANIFEST_PARSED,this.onManifestParsed,this),e.off(qm.LEVEL_LOADED,this.onLevelLoaded,this),e.off(qm.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(qm.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(qm.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(qm.BUFFER_CREATED,this.onBufferCreated,this),e.off(qm.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(qm.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(qm.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:n,hls:r}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let e=r.startLevel;-1===e&&(r.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=r.firstAutoLevel),r.nextLoadLevel=e,this.level=r.loadLevel,this._hasEnoughToStart=!!t}n>0&&-1===e&&!t&&(this.log(`Override startPosition with lastCurrentTime @${n.toFixed(3)}`),e=n),this.state=Ob,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=kb}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case jb:{const{levels:e,level:t}=this,n=null==e?void 0:e[t],r=null==n?void 0:n.details;if(r&&(!r.live||this.levelLastLoaded===n&&!this.waitForLive(n))){if(this.waitForCdnTuneIn(r))break;this.state=Ob;break}if(this.hls.nextLoadLevel!==this.level){this.state=Ob;break}break}case Bb:{var e;const t=self.performance.now(),n=this.retryDate;if(!n||t>=n||null!=(e=this.media)&&e.seeking){const{levels:e,level:t}=this,n=null==e?void 0:e[t];this.resetStartWhenNotLoaded(n||null),this.state=Ob}}}this.state===Ob&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),null!=(e=this.media)&&e.readyState&&!1===this.media.seeking&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:n,media:r}=this;if(null===t||!r&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;const i=this.buffering?e.nextLoadLevel:e.loadLevel;if(null==n||!n[i])return;const s=n[i],a=this.getMainFwdBufferInfo();if(null===a)return;const o=this.getLevelDetails();if(o&&this._streamEnded(a,o)){const e={};return 2===this.altAudio&&(e.type="video"),this.hls.trigger(qm.BUFFER_EOS,e),void(this.state=Hb)}if(!this.buffering)return;e.loadLevel!==i&&-1===e.manualLevel&&this.log(`Adapting to level ${i} from level ${this.level}`),this.level=e.nextLoadLevel=i;const l=s.details;if(!l||this.state===jb||this.waitForLive(s))return this.level=i,this.state=jb,void(this.startFragRequested=!1);const u=a.len,c=this.getMaxBufferLength(s.maxBitrate);if(u>=c)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const d=this.backtrackFragment?this.backtrackFragment.start:a.end;let h=this.getNextFragment(d,l);if(this.couldBacktrack&&!this.fragPrevious&&h&&Lg(h)&&this.fragmentTracker.getState(h)!==ly){var f;const e=(null!=(f=this.backtrackFragment)?f:h).sn-l.startSN,t=l.fragments[e-1];t&&h.cc===t.cc&&(h=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(h&&this.isLoopLoading(h,d)){if(!h.gap){const e=this.audioOnly&&!this.altAudio?Mg:Rg,t=(e===Rg?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,Zm.MAIN)}h=this.getNextFragmentLoopLoading(h,l,a,Zm.MAIN,c)}h&&(!h.initSegment||h.initSegment.data||this.bitrateTest||(h=h.initSegment),this.loadFragment(h,s,d))}loadFragment(e,t,n){const r=this.fragmentTracker.getState(e);r===sy||r===oy?Lg(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,n):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,Zm.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null!=t&&t.readyState){let n;const r=this.getAppendedFrag(t.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);const i=this.getLevelDetails();if(null!=i&&i.live){const e=this.getMainFwdBufferInfo();if(!e||e.len<2*i.targetduration)return}if(!t.paused&&e){const t=e[this.hls.nextLoadLevel],r=this.fragLastKbps;n=r&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*r)+1:0}else n=0;const s=this.getBufferedFrag(t.currentTime+n);if(s){const e=this.followingBufferedFrag(s);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,n=e.duration,r=Math.max(s.end,t+Math.min(Math.max(n-this.config.maxFragLookUpTolerance,n*(this.couldBacktrack?.5:.125)),n*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(r,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case Fb:case Ub:case Bb:case zb:case Gb:this.state=Ob}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,2===this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const n=t.media;bS(n,"playing",this.onMediaPlaying),bS(n,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:n}=this;n&&(_S(n,"playing",this.onMediaPlaying),_S(n,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t);!!t.transferMedia||(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(qm.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let n=!1,r=!1;t.levels.forEach(e=>{const t=e.audioCodec;t&&(n=n||-1!==t.indexOf("mp4a.40.2"),r=r||-1!==t.indexOf("mp4a.40.5"))}),this.audioCodecSwitch=n&&r&&!function(){var e;const t=lE();return"function"==typeof(null==t||null==(e=t.prototype)?void 0:e.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:n}=this;if(!n||this.state!==Ob)return;const r=t.levelInfo;(!r.details||r.details.live&&(this.levelLastLoaded!==r||r.details.expired)||this.waitForCdnTuneIn(r.details))&&(this.state=jb)}onLevelLoaded(e,t){var n;const{levels:r,startFragRequested:i}=this,s=t.level,a=t.details,o=a.totalduration;if(!r)return void this.warn(`Levels were reset while loading level ${s}`);this.log(`Level ${s} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${o}`);const l=t.levelInfo,u=this.fragCurrent;!u||this.state!==Ub&&this.state!==Bb||u.level!==t.level&&u.loader&&this.abortCurrentFrag();let c=0;if(a.live||null!=(n=l.details)&&n.live){var d;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;c=this.alignPlaylists(a,l.details,null==(d=this.levelLastLoaded)?void 0:d.details)}if(l.details=a,this.levelLastLoaded=l,i||this.setStartPosition(a,c),this.hls.trigger(qm.LEVEL_UPDATED,{details:a,level:s}),this.state===jb){if(this.waitForCdnTuneIn(a))return;this.state=Ob}i&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:n}=this;if(!n)return;const r=this.hls.liveSyncPosition,i=this.getLoadPosition(),s=e.fragmentStart,a=e.edge,o=i>=s-t.maxFragLookUpTolerance&&i<=a;if(null!==r&&n.duration>r&&(i<r||!o)){const s=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!o&&n.readyState<4||i<a-s)&&(this._hasEnoughToStart||(this.nextLoadPosition=r),n.readyState))if(this.warn(`Playback: ${i.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${r.toFixed(3)}`),"buffered"===this.config.liveSyncMode){var l;const e=My.bufferInfo(n,r,0);if(null==e||null==(l=e.buffered)||!l.length)return void(n.currentTime=r);if(e.start<=i)return void(n.currentTime=r);const{nextStart:t}=My.bufferedInfo(e.buffered,i,0);t&&(n.currentTime=t)}else n.currentTime=r}}_handleFragmentLoadProgress(e){var t;const n=e.frag,{part:r,payload:i}=e,{levels:s}=this;if(!s)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);const a=s[n.level];if(!a)return void this.warn(`Level ${n.level} not found on progress`);const o=a.details;if(!o)return this.warn(`Dropping fragment ${n.sn} of level ${n.level} after level details were reset`),void this.fragmentTracker.removeFragment(n);const l=a.videoCodec,u=o.PTSKnown||!o.live,c=null==(t=n.initSegment)?void 0:t.data,d=this._getAudioCodec(a),h=this.transmuxer=this.transmuxer||new Tx(this.hls,Zm.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=r?r.index:-1,p=-1!==f,m=new Ay(n.level,n.sn,n.stats.chunkCount,i.byteLength,f,p),g=this.initPTS[n.cc];h.push(i,c,d,l,n,r,o.totalduration,u,m,g)}onAudioTrackSwitching(e,t){const n=this.hls,r=2===this.altAudio;if(Hv(t.url,n))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;e&&(this.log("Switching to main audio track, cancel main fragment load"),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(r)return this.fragmentTracker.removeAllFragments(),n.once(qm.BUFFER_FLUSHED,()=>{var e;null==(e=this.hls)||e.trigger(qm.AUDIO_TRACK_SWITCHED,t)}),void n.trigger(qm.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});n.trigger(qm.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const n=Hv(t.url,this.hls);if(n){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=n?2:0,this.tick()}onBufferCreated(e,t){const n=t.tracks;let r,i,s=!1;for(const e in n){const t=n[e];if("main"===t.id){if(i=e,r=t,"video"===e){const t=n[e];t&&(this.videoBuffer=t.buffer)}}else s=!0}s&&r?(this.log(`Alternate track found, use ${i}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:n,part:r}=t,i=n.type===Zm.MAIN;if(i){if(this.fragContextChanged(n))return this.warn(`Fragment ${n.sn}${r?" p: "+r.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===Gb&&(this.state=Ob));const e=r?r.stats:n.stats;this.fragLastKbps=Math.round(8*e.total/(e.buffering.end-e.loading.first)),Lg(n)&&(this.fragPrevious=n),this.fragBufferedComplete(n,r)}const s=this.media;s&&(!this._hasEnoughToStart&&My.getBuffered(s).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),i&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var n;if(t.fatal)this.state=$b;else switch(t.details){case jm.FRAG_GAP:case jm.FRAG_PARSING_ERROR:case jm.FRAG_DECRYPT_ERROR:case jm.FRAG_LOAD_ERROR:case jm.FRAG_LOAD_TIMEOUT:case jm.KEY_LOAD_ERROR:case jm.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(Zm.MAIN,t);break;case jm.LEVEL_LOAD_ERROR:case jm.LEVEL_LOAD_TIMEOUT:case jm.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==jb||(null==(n=t.context)?void 0:n.type)!==Ym||(this.state=Ob);break;case jm.BUFFER_ADD_CODEC_ERROR:case jm.BUFFER_APPEND_ERROR:if("main"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&this.resetLoadingState();break;case jm.BUFFER_FULL_ERROR:if("main"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case jm.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onFragLoadEmergencyAborted(){this.state=Ob,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==Mg||!this.altAudio){const e=(t===Rg?this.videoBuffer:this.mediaBuffer)||this.media;e&&(this.afterBufferFlushed(e,t,Zm.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,-1===this.level&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let n=this.startPosition;if(n>=0&&t<n){if(e.seeking)return void this.log(`could not seek to ${n}, already seeking at ${t}`);const r=this.timelineOffset;r&&n&&(n+=r);const i=this.getLevelDetails(),s=My.getBuffered(e),a=s.length?s.start(0):0,o=a-n,l=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||o>0&&(o<l||this.loadingParts&&o<2*((null==i?void 0:i.partTarget)||0)))&&(this.log(`adjusting start position by ${o} to match buffer start`),n+=o,this.startPosition=n),t<n&&(this.log(`seek to target start position ${n} from current time ${t} buffer start ${a}`),e.currentTime=n)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(e=>{const{hls:n}=this,r=null==e?void 0:e.frag;if(!r||this.fragContextChanged(r))return;t.fragmentError=0,this.state=Ob,this.startFragRequested=!1,this.bitrateTest=!1;const i=r.stats;i.parsing.start=i.parsing.end=i.buffering.start=i.buffering.end=self.performance.now(),n.trigger(qm.FRAG_LOADED,e),r.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const n=this.playlistType,{hls:r}=this,{remuxResult:i,chunkMeta:s}=e,a=this.getCurrentContext(s);if(!a)return void this.resetWhenMissingContext(s);const{frag:o,part:l,level:u}=a,{video:c,text:d,id3:h,initSegment:f}=i,{details:p}=u,m=this.altAudio?void 0:i.audio;if(this.fragContextChanged(o))this.fragmentTracker.removeFragment(o);else{if(this.state=zb,f){if(null!=f&&f.tracks){const e=o.initSegment||o;this._bufferInitSegment(u,f.tracks,e,s),r.trigger(qm.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:f.tracks})}const e=f.initPTS,t=f.timescale,i=this.initPTS[o.cc];!Gm(e)||i&&i.baseTime===e&&i.timescale===t||(this.initPTS[o.cc]={baseTime:e,timescale:t},r.trigger(qm.INIT_PTS_FOUND,{frag:o,id:n,initPTS:e,timescale:t}))}if(c&&p){m&&"audiovideo"===c.type&&this.logMuxedErr(o);const e=p.fragments[o.sn-1-p.startSN],t=o.sn===p.startSN,n=!e||o.cc>e.cc;if(!1!==i.independent){const{startPTS:e,endPTS:r,startDTS:i,endDTS:a}=c;if(l)l.elementaryStreams[c.type]={startPTS:e,endPTS:r,startDTS:i,endDTS:a};else if(c.firstKeyFrame&&c.independent&&1===s.id&&!n&&(this.couldBacktrack=!0),c.dropped&&c.independent){const i=this.getMainFwdBufferInfo(),s=(i?i.end:this.getLoadPosition())+this.config.maxBufferHole,l=c.firstKeyFramePTS?c.firstKeyFramePTS:e;if(!t&&s<l-this.config.maxBufferHole&&!n)return void this.backtrack(o);n&&(o.gap=!0),o.setElementaryStreamInfo(c.type,o.start,r,o.start,a,!0)}else t&&e-(p.appliedTimelineOffset||0)>2&&(o.gap=!0);o.setElementaryStreamInfo(c.type,e,r,i,a),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(c,o,l,s,t||n)}else{if(!t&&!n)return void this.backtrack(o);o.gap=!0}}if(m){const{startPTS:e,endPTS:t,startDTS:n,endDTS:r}=m;l&&(l.elementaryStreams[Mg]={startPTS:e,endPTS:t,startDTS:n,endDTS:r}),o.setElementaryStreamInfo(Mg,e,t,n,r),this.bufferFragmentData(m,o,l,s)}if(p&&null!=h&&null!=(t=h.samples)&&t.length){const e={id:n,frag:o,details:p,samples:h.samples};r.trigger(qm.FRAG_PARSING_METADATA,e)}if(p&&d){const e={id:n,frag:o,details:p,samples:d.samples};r.trigger(qm.FRAG_PARSING_USERDATA,e)}}}logMuxedErr(e){this.warn(`${Lg(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,n,r){if(this.state!==zb)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(n));const{audio:i,video:s,audiovideo:a}=t;if(i){const n=e.audioCodec;let r=gv(i.codec,n);"mp4a"===r&&(r="mp4a.40.5");const s=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){r&&(r=-1!==r.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");const e=i.metadata;e&&"channelCount"in e&&1!==(e.channelCount||1)&&-1===s.indexOf("firefox")&&(r="mp4a.40.5")}r&&-1!==r.indexOf("mp4a.40.5")&&-1!==s.indexOf("android")&&"audio/mpeg"!==i.container&&(r="mp4a.40.2",this.log(`Android: force audio codec to ${r}`)),n&&n!==r&&this.log(`Swapping manifest audio codec "${n}" for "${r}"`),i.levelCodec=r,i.id=Zm.MAIN,this.log(`Init audio buffer, container:${i.container}, codecs[selected/level/parsed]=[${r||""}/${n||""}/${i.codec}]`),delete t.audiovideo}if(s){s.levelCodec=e.videoCodec,s.id=Zm.MAIN;const n=s.codec;if(4===(null==n?void 0:n.length))switch(n){case"hvc1":case"hev1":s.codec="hvc1.1.6.L120.90";break;case"av01":s.codec="av01.0.04M.08";break;case"avc1":s.codec="avc1.42e01e"}this.log(`Init video buffer, container:${s.container}, codecs[level/parsed]=[${e.videoCodec||""}/${n}]${s.codec!==n?" parsed-corrected="+s.codec:""}${s.supplemental?" supplemental="+s.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const o=Object.keys(t);if(o.length){if(this.hls.trigger(qm.BUFFER_CODECS,t),!this.hls)return;o.forEach(e=>{const i=t[e].initSegment;null!=i&&i.byteLength&&this.hls.trigger(qm.BUFFER_APPENDING,{type:e,data:i,frag:n,part:null,chunkMeta:r,parent:n.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&2===this.altAudio?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,Zm.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,n=null==e?void 0:e[t];return n?this.getMaxBufferLength(n.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=Ob}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const n=e.currentTime;if(My.isBuffered(e,n)?t=this.getAppendedFrag(n):My.isBuffered(e,n+.1)&&(t=this.getAppendedFrag(n+.1)),t){this.backtrackFragment=null;const e=this.fragPlaying,n=t.level;e&&t.sn===e.sn&&e.level===n||(this.fragPlaying=t,this.hls.trigger(qm.FRAG_CHANGED,{frag:t}),e&&e.level===n||this.hls.trigger(qm.LEVEL_SWITCHED,{level:n}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=(null==(e=this.media)?void 0:e.currentTime)||this.lastCurrentTime;return Gm(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=(null==(e=this.media)?void 0:e.currentTime)||this.lastCurrentTime;if(Gm(t)){const e=this.getLevelDetails(),n=this.currentFrag||(e?jv(null,e.fragments,t):null);if(n){const e=n.programDateTime;if(null!==e){const r=e+1e3*(t-n.start);return new Date(r)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class hE{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const n in this.keyUriToKeyInfo){const r=this.keyUriToKeyInfo[n].loader;if(r){var t;if(e&&e!==(null==(t=r.context)?void 0:t.frag.type))return;r.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=jm.KEY_LOAD_ERROR,n,r,i){return new Ty({type:Wm.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:i,error:n,networkDetails:r})}loadClear(e,t,n){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length)for(let r=0,i=t.length;r<i;r++){const s=t[r];if(e.cc<=s.cc&&(!Lg(e)||!Lg(s)||e.sn<s.sn)||!n&&r==i-1)return this.emeController.selectKeySystemFormat(s).then(e=>{if(!this.emeController)return;s.setKeyFormat(e);const t=Xy(e);return t?this.emeController.getKeySystemAccess([t]):void 0})}if(this.config.requireKeySystemAccessOnStart){const e=Ky(this.config);if(e.length)return this.emeController.getKeySystemAccess(e)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var n,r;t&&e.setKeyFormat(t);const i=e.decryptdata;if(!i){const n=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,jm.KEY_LOAD_ERROR,n))}const s=i.uri;if(!s)return Promise.reject(this.createKeyLoadError(e,jm.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${s}"`)));let a=this.keyUriToKeyInfo[s];if(null!=(n=a)&&n.decryptdata.key)return i.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});var o;if(null!=(r=a)&&r.keyLoadPromise)switch(null==(o=a.mediaKeySessionContext)?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(t=>(i.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}switch(a=this.keyUriToKeyInfo[s]={decryptdata:i,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},i.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===i.keyFormat?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,jm.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${i.method}"`)))}}loadKeyEME(e,t){const n={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const t=this.emeController.loadKey(n);if(t)return(e.keyLoadPromise=t.then(t=>(e.mediaKeySessionContext=t,n))).catch(t=>{throw e.keyLoadPromise=null,t})}return Promise.resolve(n)}loadKeyHTTP(e,t){const n=this.config,r=new(0,n.loader)(n);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((i,s)=>{const a={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},o=n.keyLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(e,t,n,r)=>{const{frag:a,keyInfo:o,url:l}=n;if(!a.decryptdata||o!==this.keyUriToKeyInfo[l])return s(this.createKeyLoadError(a,jm.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),r));o.decryptdata.key=a.decryptdata.key=new Uint8Array(e.data),a.keyLoader=null,o.loader=null,i({frag:a,keyInfo:o})},onError:(e,n,r,i)=>{this.resetLoader(n),s(this.createKeyLoadError(t,jm.KEY_LOAD_ERROR,new Error(`HTTP Error ${e.code} loading key ${e.text}`),r,ig({url:a.url,data:void 0},e)))},onTimeout:(e,n,r)=>{this.resetLoader(n),s(this.createKeyLoadError(t,jm.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),r))},onAbort:(e,n,r)=>{this.resetLoader(n),s(this.createKeyLoadError(t,jm.INTERNAL_ABORTED,new Error("key loading aborted"),r))}};r.load(a,l,u)})}resetLoader(e){const{frag:t,keyInfo:n,url:r}=e,i=n.loader;t.keyLoader===i&&(t.keyLoader=null,n.loader=null),delete this.keyUriToKeyInfo[r],i&&i.destroy()}}function fE(e){const{type:t}=e;switch(t){case Km:return Zm.AUDIO;case Qm:return Zm.SUBTITLE;default:return Zm.MAIN}}function pE(e,t){let n=e.url;return void 0!==n&&0!==n.indexOf("data:")||(n=t.url),n}class mE{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.on(qm.LEVEL_LOADING,this.onLevelLoading,this),e.on(qm.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(qm.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(qm.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(qm.MANIFEST_LOADING,this.onManifestLoading,this),e.off(qm.LEVEL_LOADING,this.onLevelLoading,this),e.off(qm.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(qm.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(qm.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,n=t.pLoader,r=t.loader,i=new(n||r)(t);return this.loaders[e.type]=i,i}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:n}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Xm,url:n,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:n,level:r,pathwayId:i,url:s,deliveryDirectives:a,levelInfo:o}=t;this.load({id:n,level:r,pathwayId:i,responseType:"text",type:Ym,url:s,deliveryDirectives:a,levelOrTrack:o})}onAudioTrackLoading(e,t){const{id:n,groupId:r,url:i,deliveryDirectives:s,track:a}=t;this.load({id:n,groupId:r,level:null,responseType:"text",type:Km,url:i,deliveryDirectives:s,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:n,groupId:r,url:i,deliveryDirectives:s,track:a}=t;this.load({id:n,groupId:r,level:null,responseType:"text",type:Qm,url:i,deliveryDirectives:s,levelOrTrack:a})}onLevelsUpdated(e,t){const n=this.loaders[Ym];if(n){const e=n.context;e&&!t.levels.some(t=>t===e.levelOrTrack)&&(n.abort(),delete this.loaders[Ym])}}load(e){var t;const n=this.hls.config;let r,i=this.getInternalLoader(e);if(i){const t=this.hls.logger,n=i.context;if(n&&n.levelOrTrack===e.levelOrTrack&&(n.url===e.url||n.deliveryDirectives&&!e.deliveryDirectives))return void(n.url===e.url?t.log(`[playlist-loader]: ignore ${e.url} ongoing request`):t.log(`[playlist-loader]: ignore ${e.url} in favor of ${n.url}`));t.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),i.abort()}if(r=e.type===Xm?n.manifestLoadPolicy.default:ng({},n.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),i=this.createInternalLoader(e),Gm(null==(t=e.deliveryDirectives)?void 0:t.part)){let t;if(e.type===Ym&&null!==e.level?t=this.hls.levels[e.level].details:e.type===Km&&null!==e.id?t=this.hls.audioTracks[e.id].details:e.type===Qm&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,n=t.targetduration;if(e&&n){const t=1e3*Math.max(3*e,.8*n);r=ng({},r,{maxTimeToFirstByteMs:Math.min(t,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,r.maxTimeToFirstByteMs)})}}}const s=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:s.maxNumRetry||0,retryDelay:s.retryDelayMs||0,maxRetryDelay:s.maxRetryDelayMs||0},o={onSuccess:(e,t,n,r)=>{const i=this.getInternalLoader(n);this.resetInternalLoader(n.type);const s=e.data;0===s.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),ab.isMediaPlaylist(s)||n.type!==Xm?this.handleTrackOrLevelPlaylist(e,t,n,r||null,i):this.handleMasterPlaylist(e,t,n,r)):this.handleManifestParsingError(e,n,new Error("no EXTM3U delimiter"),r||null,t)},onError:(e,t,n,r)=>{this.handleNetworkError(t,n,!1,e,r)},onTimeout:(e,t,n)=>{this.handleNetworkError(t,n,!0,void 0,e)}};i.load(e,a,o)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:n}=this.hls;(e||n)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,n,r){const i=this.hls,s=e.data,a=pE(e,n),o=ab.parseMasterPlaylist(s,a);if(o.playlistParsingError)return void this.handleManifestParsingError(e,n,o.playlistParsingError,r,t);const{contentSteering:l,levels:u,sessionData:c,sessionKeys:d,startTimeOffset:h,variableList:f}=o;this.variableList=f;const{AUDIO:p=[],SUBTITLES:m,"CLOSED-CAPTIONS":g}=ab.parseMasterPlaylistMedia(s,a,o);if(p.length){p.some(e=>!e.url)||!u[0].audioCodec||u[0].attrs.AUDIO||(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),p.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new ky({}),bitrate:0,url:""}))}i.trigger(qm.MANIFEST_LOADED,{levels:u,audioTracks:p,subtitles:m,captions:g,contentSteering:l,url:a,stats:t,networkDetails:r,sessionData:c,sessionKeys:d,startTimeOffset:h,variableList:f})}handleTrackOrLevelPlaylist(e,t,n,r,i){const s=this.hls,{id:a,level:o,type:l}=n,u=pE(e,n),c=Gm(o)?o:Gm(a)?a:0,d=fE(n),h=ab.parseLevelPlaylist(e.data,u,c,d,0,this.variableList);if(l===Xm){const e={attrs:new ky({}),bitrate:0,details:h,name:"",url:u};h.requestScheduled=t.loading.start+Eb(h,0),s.trigger(qm.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:u,stats:t,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),n.levelDetails=h,this.handlePlaylistLoaded(h,e,t,n,r,i)}handleManifestParsingError(e,t,n,r,i){this.hls.trigger(qm.ERROR,{type:Wm.NETWORK_ERROR,details:jm.MANIFEST_PARSING_ERROR,fatal:t.type===Xm,url:e.url,err:n,error:n,reason:n.message,response:e,context:t,networkDetails:r,stats:i})}handleNetworkError(e,t,n=!1,r,i){let s=`A network ${n?"timeout":"error"+(r?" (status "+r.code+")":"")} occurred while loading ${e.type}`;e.type===Ym?s+=`: ${e.level} id: ${e.id}`:e.type!==Km&&e.type!==Qm||(s+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(s);this.hls.logger.warn(`[playlist-loader]: ${s}`);let o=jm.UNKNOWN,l=!1;const u=this.getInternalLoader(e);switch(e.type){case Xm:o=n?jm.MANIFEST_LOAD_TIMEOUT:jm.MANIFEST_LOAD_ERROR,l=!0;break;case Ym:o=n?jm.LEVEL_LOAD_TIMEOUT:jm.LEVEL_LOAD_ERROR,l=!1;break;case Km:o=n?jm.AUDIO_TRACK_LOAD_TIMEOUT:jm.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case Qm:o=n?jm.SUBTITLE_TRACK_LOAD_TIMEOUT:jm.SUBTITLE_LOAD_ERROR,l=!1}u&&this.resetInternalLoader(e.type);const c={type:Wm.NETWORK_ERROR,details:o,fatal:l,url:e.url,loader:u,context:e,error:a,networkDetails:t,stats:i};if(r){const n=(null==t?void 0:t.url)||e.url;c.response=ig({url:n,data:void 0},r)}this.hls.trigger(qm.ERROR,c)}handlePlaylistLoaded(e,t,n,r,i,s){const a=this.hls,{type:o,level:l,id:u,groupId:c,deliveryDirectives:d}=r,h=pE(t,r),f=fE(r),p="number"==typeof r.level&&f===Zm.MAIN?l:void 0;if(!e.fragments.length){const s=e.playlistParsingError=new Error("No Segments found in Playlist");return void a.trigger(qm.ERROR,{type:Wm.NETWORK_ERROR,details:jm.LEVEL_EMPTY_ERROR,fatal:!1,url:h,error:s,reason:s.message,response:t,context:r,level:p,parent:f,networkDetails:i,stats:n})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const m=e.playlistParsingError;if(m){if(this.hls.logger.warn(m),!a.config.ignorePlaylistParsingErrors)return void a.trigger(qm.ERROR,{type:Wm.NETWORK_ERROR,details:jm.LEVEL_PARSING_ERROR,fatal:!1,url:h,error:m,reason:m.message,response:t,context:r,level:p,parent:f,networkDetails:i,stats:n});e.playlistParsingError=null}switch(e.live&&s&&(s.getCacheAge&&(e.ageHeader=s.getCacheAge()||0),s.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),o){case Xm:case Ym:a.trigger(qm.LEVEL_LOADED,{details:e,levelInfo:r.levelOrTrack||a.levels[0],level:p||0,id:u||0,stats:n,networkDetails:i,deliveryDirectives:d,withoutMultiVariant:o===Xm});break;case Km:a.trigger(qm.AUDIO_TRACK_LOADED,{details:e,track:r.levelOrTrack,id:u||0,groupId:c||"",stats:n,networkDetails:i,deliveryDirectives:d});break;case Qm:a.trigger(qm.SUBTITLE_TRACK_LOADED,{details:e,track:r.levelOrTrack,id:u||0,groupId:c||"",stats:n,networkDetails:i,deliveryDirectives:d})}}}class gE{static get version(){return e_}static isMSESupported(){return uE()}static isSupported(){return cE()}static getMediaSource(){return hg()}static get Events(){return qm}static get MetadataSchema(){return T_}static get ErrorTypes(){return Wm}static get ErrorDetails(){return jm}static get DefaultConfig(){return gE.defaultConfig?gE.defaultConfig:KT}static set DefaultConfig(e){gE.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Jb,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=function(e,t,n){const r=lg();if("object"==typeof console&&!0===e||"object"==typeof e){const i=["debug","log","info","warn","error"];i.forEach(t=>{r[t]=ug(t,e,n)});try{r.log(`Debug logs enabled for "${t}" in hls.js version 1.6.7`)}catch(e){return lg()}i.forEach(t=>{cg[t]=ug(t,e)})}else ng(cg,r);return r}(e.debug||!1,"Hls instance",e.assetPlayerId),n=this.config=function(e,t,n){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const r=QT(e),i=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach(e=>{const s=`${"level"===e?"playlist":e}LoadPolicy`,a=void 0===t[s],o=[];i.forEach(n=>{const i=`${e}Loading${n}`,l=t[i];if(void 0!==l&&a){o.push(i);const e=r[s].default;switch(t[s]={default:e},n){case"TimeOut":e.maxLoadTimeMs=l,e.maxTimeToFirstByteMs=l;break;case"MaxRetry":e.errorRetry.maxNumRetry=l,e.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":e.errorRetry.retryDelayMs=l,e.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":e.errorRetry.maxRetryDelayMs=l,e.timeoutRetry.maxRetryDelayMs=l}}}),o.length&&n.warn(`hls.js config: "${o.join('", "')}" setting(s) are deprecated, use "${s}": ${kv(t[s])}`)}),ig(ig({},r),t)}(gE.DefaultConfig,e,t);this.userConfig=e,n.progressive&&function(e,t){const n=e.loader;n!==WT&&n!==YT?(t.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1):HT()&&(e.loader=WT,e.progressive=!0,e.enableSoftwareAES=!0,t.log("[config]: Progressive streaming enabled, using FetchLoader"))}(n,t);const{abrController:r,bufferController:i,capLevelController:s,errorController:a,fpsController:o}=n,l=new a(this),u=this.abrController=new r(this),c=new uy(this),d=n.interstitialsController,h=d?this.interstitialsController=new d(this,gE):null,f=this.bufferController=new i(this,c),p=this.capLevelController=new s(this),m=new o(this),g=new mE(this),v=n.contentSteeringController,y=v?new v(this):null,b=this.levelController=new aE(this,y),_=new iE(this),x=new hE(this.config),S=this.streamController=new dE(this,c,x),T=this.gapController=new ZT(this,c);p.setStreamController(S),m.setStreamController(S);const E=[g,b,S];h&&E.splice(1,0,h),y&&E.splice(1,0,y),this.networkControllers=E;const A=[u,f,T,p,m,_,c];this.audioTrackController=this.createController(n.audioTrackController,E);const w=n.audioStreamController;w&&E.push(this.audioStreamController=new w(this,c,x)),this.subtitleTrackController=this.createController(n.subtitleTrackController,E);const M=n.subtitleStreamController;M&&E.push(this.subtititleStreamController=new M(this,c,x)),this.createController(n.timelineController,A),x.emeController=this.emeController=this.createController(n.emeController,A),this.cmcdController=this.createController(n.cmcdController,A),this.latencyController=this.createController(sE,A),this.coreComponents=A,E.push(l);const R=l.onErrorOut;"function"==typeof R&&this.on(qm.ERROR,R,l),this.on(qm.MANIFEST_LOADED,g.onManifestLoaded,g)}createController(e,t){if(e){const n=new e(this);return t&&t.push(n),n}return null}on(e,t,n=this){this._emitter.on(e,t,n)}once(e,t,n=this){this._emitter.once(e,t,n)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,n=this,r){this._emitter.off(e,t,n,r)}listeners(e){return this._emitter.listeners(e)}emit(e,t,n){return this._emitter.emit(e,t,n)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+t.message+'". Here is a stacktrace:',t),!this.triggeringException){this.triggeringException=!0;const n=e===qm.ERROR;this.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.INTERNAL_EXCEPTION,fatal:n,event:e,error:t}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(qm.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const t=new Error(`attachMedia failed: invalid argument (${e})`);return void this.trigger(qm.ERROR,{type:Wm.OTHER_ERROR,details:jm.ATTACH_MEDIA_ERROR,fatal:!0,error:t})}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,n=t?e.media:e,r=t?e:{media:n};this._media=n,this.trigger(qm.MEDIA_ATTACHING,r)}detachMedia(){this.logger.log("detachMedia"),this.trigger(qm.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(qm.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,n=this._url,r=this._url=Ag.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${r}`),t&&n&&(n!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(qm.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let n=0;n<this.networkControllers.length&&(this.networkControllers[n].startLoad(e,t),this.started&&this.networkControllers);n++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!this.started&&this.networkControllers);e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[Zm.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[Zm.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[Zm.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=null==e?void 0:e.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=function(){try{return crypto.randomUUID()}catch(e){try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch(e){let t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)})}}}()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return-1===e&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){(function(e){return Mv.indexOf(e)>-1})(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const n=e.length;for(let r=0;r<n;r++)if(e[r].maxBitrate>=t)return r;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:n}=this;let r;if(r=-1===t&&null!=e&&e.length?e.length-1:t,n)for(let t=r;t--;){const r=e[t].attrs["HDCP-LEVEL"];if(r&&r<=n)return t}return r}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return(null==(t=this.audioTrackController)?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return(null==(t=this.subtitleTrackController)?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!(null==(e=this.bufferController)||!e.bufferedToEnd)}get interstitialsManager(){var e;return(null==(e=this.interstitialsController)?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){return Ev(e,Fv(t),navigator.mediaCapabilities)}}gE.defaultConfig=void 0;var vE=Object.freeze({__proto__:null,AbrController:$v,AttrList:ky,AudioStreamController:Ex,AudioTrackController:Cx,BasePlaylistController:Ax,BaseSegment:Ig,BaseStreamController:qb,BufferController:Dx,CMCDController:mS,CapLevelController:Fx,ChunkMetadata:Ay,ContentSteeringController:gS,Cues:GT,DateRange:Uy,EMEController:xS,ErrorActionFlags:ny,ErrorController:ry,ErrorDetails:jm,ErrorTypes:Wm,Events:qm,FPSController:TS,FetchLoader:WT,Fragment:Pg,Hls:gE,HlsSkip:Cv,HlsUrlParameters:Lv,KeySystemFormats:qy,KeySystems:jy,Level:Pv,LevelDetails:By,LevelKey:eb,LoadStats:wg,M3U8Parser:ab,MetadataSchema:T_,NetworkErrorAction:ty,Part:Ng,PlaylistLevelType:Zm,SubtitleStreamController:$S,SubtitleTrackController:CS,TimelineController:FT,XhrLoader:YT,default:gE,fetchSupported:HT,getMediaSource:hg,isMSESupported:uE,isSupported:cE,requestMediaKeySystemAccess:Qy});const yE=((e,t)=>"undefined"!=typeof window&&"function"==typeof(null==(e=window.document)?void 0:e.createElement)&&"string"==typeof(null==(t=window.navigator)?void 0:t.userAgent))();let bE=null;async function _E(...e){var t;null!==(t=bE)&&void 0!==t||(bE=await Promise.resolve().then(function(){return vE}));const n=bE.default;return n.isSupported()?new n(...e):null}function xE(e,{unsuspend:t="loadedmetadata",start:n=!0,hls:i={},crossOrigin:a="anonymous",muted:o=!0,loop:l=!0,playsInline:u=!0,onVideoFrame:c,...d}={}){const h=Hp(e=>e.gl),f=r(null),p=Mf(()=>new Promise(async n=>{let r,s;"string"==typeof e?r=e:s=e;const c=Object.assign(document.createElement("video"),{src:r,srcObject:s,crossOrigin:a,loop:l,muted:o,playsInline:u,...d});if(r&&yE&&r.endsWith(".m3u8")){const e=f.current=await _E(i);e&&(e.on(qm.MEDIA_ATTACHED,()=>{e.loadSource(r)}),e.attachMedia(c))}const p=new Da(c);"colorSpace"in p?p.colorSpace=h.outputColorSpace:p.encoding=h.outputEncoding,c.addEventListener(t,()=>n(p))}),[e]),m=p.source.data;return SE(m,c),s(()=>(n&&p.image.play(),()=>{f.current&&(f.current.destroy(),f.current=null)}),[p,n]),p}const SE=(e,t)=>{s(()=>{if(!t)return;if(!e.requestVideoFrameCallback)return;let n;const r=(...i)=>{t(...i),n=e.requestVideoFrameCallback(r)};return e.requestVideoFrameCallback(r),()=>e.cancelVideoFrameCallback(n)},[e,t])},TE=["alphaMap","alphaTest","anisotropy","anisotropyMap","anisotropyRotation","aoMap","attenuationColor","attenuationDistance","bumpMap","clearcoat","clearcoatMap","clearcoatNormalMap","clearcoatNormalScale","clearcoatRoughness","color","dispersion","displacementMap","emissive","emissiveMap","envMap","gradientMap","ior","iridescence","iridescenceIOR","iridescenceMap","iridescenceThicknessMap","lightMap","map","matcap","metalness","metalnessMap","normalMap","normalScale","opacity","roughness","roughnessMap","sheen","sheenColor","sheenColorMap","sheenRoughnessMap","shininess","specular","specularColor","specularColorMap","specularIntensity","specularIntensityMap","specularMap","thickness","transmission","transmissionMap"];class EE{constructor(e){this.renderObjects=new WeakMap,this.hasNode=this.containsNode(e),this.hasAnimation=!0===e.object.isSkinnedMesh,this.refreshUniforms=TE,this.renderId=0}firstInitialization(e){return!1===this.renderObjects.has(e)&&(this.getRenderObjectData(e),!0)}getRenderObjectData(e){let t=this.renderObjects.get(e);if(void 0===t){const{geometry:n,material:r,object:i}=e;if(t={material:this.getMaterialData(r),geometry:{attributes:this.getAttributesData(n.attributes),indexVersion:n.index?n.index.version:null,drawRange:{start:n.drawRange.start,count:n.drawRange.count}},worldMatrix:i.matrixWorld.clone()},i.center&&(t.center=i.center.clone()),i.morphTargetInfluences&&(t.morphTargetInfluences=i.morphTargetInfluences.slice()),null!==e.bundle&&(t.version=e.bundle.version),t.material.transmission>0){const{width:n,height:r}=e.context;t.bufferWidth=n,t.bufferHeight=r}this.renderObjects.set(e,t)}return t}getAttributesData(e){const t={};for(const n in e){const r=e[n];t[n]={version:r.version}}return t}containsNode(e){const t=e.material;for(const e in t)if(t[e]&&t[e].isNode)return!0;return null!==e.renderer.nodes.modelViewMatrix||null!==e.renderer.nodes.modelNormalViewMatrix}getMaterialData(e){const t={};for(const n of this.refreshUniforms){const r=e[n];null!=r&&("object"==typeof r&&void 0!==r.clone?!0===r.isTexture?t[n]={id:r.id,version:r.version}:t[n]=r.clone():t[n]=r)}return t}equals(e){const{object:t,material:n,geometry:r}=e,i=this.getRenderObjectData(e);if(!0!==i.worldMatrix.equals(t.matrixWorld))return i.worldMatrix.copy(t.matrixWorld),!1;const s=i.material;for(const e in s){const t=s[e],r=n[e];if(void 0!==t.equals){if(!1===t.equals(r))return t.copy(r),!1}else if(!0===r.isTexture){if(t.id!==r.id||t.version!==r.version)return t.id=r.id,t.version=r.version,!1}else if(t!==r)return s[e]=r,!1}if(s.transmission>0){const{width:t,height:n}=e.context;if(i.bufferWidth!==t||i.bufferHeight!==n)return i.bufferWidth=t,i.bufferHeight=n,!1}const a=i.geometry,o=r.attributes,l=a.attributes,u=Object.keys(l),c=Object.keys(o);if(u.length!==c.length)return i.geometry.attributes=this.getAttributesData(o),!1;for(const e of u){const t=l[e],n=o[e];if(void 0===n)return delete l[e],!1;if(t.version!==n.version)return t.version=n.version,!1}const d=r.index,h=a.indexVersion,f=d?d.version:null;if(h!==f)return a.indexVersion=f,!1;if(a.drawRange.start!==r.drawRange.start||a.drawRange.count!==r.drawRange.count)return a.drawRange.start=r.drawRange.start,a.drawRange.count=r.drawRange.count,!1;if(i.morphTargetInfluences){let e=!1;for(let n=0;n<i.morphTargetInfluences.length;n++)i.morphTargetInfluences[n]!==t.morphTargetInfluences[n]&&(e=!0);if(e)return!0}return i.center&&!1===i.center.equals(t.center)?(i.center.copy(t.center),!0):(null!==e.bundle&&(i.version=e.bundle.version),!0)}needsRefresh(e,t){if(this.hasNode||this.hasAnimation||this.firstInitialization(e))return!0;const{renderId:n}=t;if(this.renderId!==n)return this.renderId=n,!0;const r=!0===e.object.static,i=null!==e.bundle&&!0===e.bundle.static&&this.getRenderObjectData(e).version===e.bundle.version;if(r||i)return!1;return!0!==this.equals(e)}}function AE(e,t=0){let n=3735928559^t,r=1103547991^t;if(e instanceof Array)for(let t,i=0;i<e.length;i++)t=e[i],n=Math.imul(n^t,2654435761),r=Math.imul(r^t,1597334677);else for(let t,i=0;i<e.length;i++)t=e.charCodeAt(i),n=Math.imul(n^t,2654435761),r=Math.imul(r^t,1597334677);return n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(r^r>>>13,3266489909),r=Math.imul(r^r>>>16,2246822507),r^=Math.imul(n^n>>>13,3266489909),4294967296*(2097151&r)+(n>>>0)}const wE=e=>AE(e),ME=e=>AE(e),RE=(...e)=>AE(e);function CE(e,t=!1){const n=[];!0===e.isNode&&(n.push(e.id),e=e.getSelf());for(const{property:r,childNode:i}of IE(e))n.push(n,AE(r.slice(0,-4)),i.getCacheKey(t));return AE(n)}function*IE(e,t=!1){for(const n in e){if(!0===n.startsWith("_"))continue;const r=e[n];if(!0===Array.isArray(r))for(let e=0;e<r.length;e++){const i=r[e];i&&(!0===i.isNode||t&&"function"==typeof i.toJSON)&&(yield{property:n,index:e,childNode:i})}else if(r&&!0===r.isNode)yield{property:n,childNode:r};else if("object"==typeof r)for(const e in r){const i=r[e];i&&(!0===i.isNode||t&&"function"==typeof i.toJSON)&&(yield{property:n,index:e,childNode:i})}}}const LE=new Map([[1,"float"],[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),PE=new WeakMap;function NE(e){return LE.get(e)}function DE(e){if(/[iu]?vec\d/.test(e))return e.startsWith("ivec")?Int32Array:e.startsWith("uvec")?Uint32Array:Float32Array;if(/mat\d/.test(e))return Float32Array;if(/float/.test(e))return Float32Array;if(/uint/.test(e))return Uint32Array;if(/int/.test(e))return Int32Array;throw new Error(`THREE.NodeUtils: Unsupported type: ${e}`)}function kE(e){return/float|int|uint/.test(e)?1:/vec2/.test(e)?2:/vec3/.test(e)?3:/vec4/.test(e)?4:/mat3/.test(e)?9:/mat4/.test(e)?16:void 0}function OE(e){if(null==e)return null;const t=typeof e;return!0===e.isNode?"node":"number"===t?"float":"boolean"===t?"bool":"string"===t?"string":"function"===t?"shader":!0===e.isVector2?"vec2":!0===e.isVector3?"vec3":!0===e.isVector4?"vec4":!0===e.isMatrix3?"mat3":!0===e.isMatrix4?"mat4":!0===e.isColor?"color":e instanceof ArrayBuffer?"ArrayBuffer":null}function FE(e,...t){const n=e?e.slice(-4):void 0;return 1===t.length&&("vec2"===n?t=[t[0],t[0]]:"vec3"===n?t=[t[0],t[0],t[0]]:"vec4"===n&&(t=[t[0],t[0],t[0],t[0]])),"color"===e?new qr(...t):"vec2"===n?new Yt(...t):"vec3"===n?new An(...t):"vec4"===n?new bn(...t):"mat3"===n?new Kt(...t):"mat4"===n?new tr(...t):"bool"===e?t[0]||!1:"float"===e||"int"===e||"uint"===e?t[0]||0:"string"===e?t[0]||"":"ArrayBuffer"===e?VE(t[0]):null}function UE(e){let t=PE.get(e);return void 0===t&&(t={},PE.set(e,t)),t}function BE(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return btoa(t)}function VE(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0)).buffer}const zE={VERTEX:"vertex",FRAGMENT:"fragment"},GE={NONE:"none",FRAME:"frame",RENDER:"render",OBJECT:"object"},HE={READ_ONLY:"readOnly",WRITE_ONLY:"writeOnly",READ_WRITE:"readWrite"},$E=["fragment","vertex"],WE=["setup","analyze","generate"],jE=[...$E,"compute"],qE=["x","y","z","w"];let XE=0;class YE extends Ft{static get type(){return"Node"}constructor(e=null){super(),this.nodeType=e,this.updateType=GE.NONE,this.updateBeforeType=GE.NONE,this.updateAfterType=GE.NONE,this.uuid=Xt.generateUUID(),this.version=0,this.global=!1,this.isNode=!0,this._cacheKey=null,this._cacheKeyVersion=0,Object.defineProperty(this,"id",{value:XE++})}set needsUpdate(e){!0===e&&this.version++}get type(){return this.constructor.type}onUpdate(e,t){return this.updateType=t,this.update=e.bind(this.getSelf()),this}onFrameUpdate(e){return this.onUpdate(e,GE.FRAME)}onRenderUpdate(e){return this.onUpdate(e,GE.RENDER)}onObjectUpdate(e){return this.onUpdate(e,GE.OBJECT)}onReference(e){return this.updateReference=e.bind(this.getSelf()),this}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(const{childNode:e}of IE(this))yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){e(this);for(const t of this.getChildren())t.traverse(e)}getCacheKey(e=!1){return!0!==(e=e||this.version!==this._cacheKeyVersion)&&null!==this._cacheKey||(this._cacheKey=RE(CE(this,e),this.customCacheKey()),this._cacheKeyVersion=this.version),this._cacheKey}customCacheKey(){return 0}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(e){const t=this.getNodeType(e);return e.getElementType(t)}getNodeType(e){const t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){const t=this.getHash(e);return e.getNodeFromHash(t)||this}setup(e){const t=e.getNodeProperties(this);let n=0;for(const e of this.getChildren())t["node"+n++]=e;return t.outputNode||null}analyze(e){if(1===e.increaseUsage(this)){const t=e.getNodeProperties(this);for(const n of Object.values(t))n&&!0===n.isNode&&n.build(e)}}generate(e,t){const{outputNode:n}=e.getNodeProperties(this);if(n&&!0===n.isNode)return n.build(e,t)}updateBefore(){}updateAfter(){}update(){}build(e,t=null){const n=this.getShared(e);if(this!==n)return n.build(e,t);e.addNode(this),e.addChain(this);let r=null;const i=e.getBuildStage();if("setup"===i){this.updateReference(e);const t=e.getNodeProperties(this);if(!0!==t.initialized){t.initialized=!0;const n=this.setup(e),r=n&&!0===n.isNode;for(const n of Object.values(t))n&&!0===n.isNode&&n.build(e);r&&n.build(e),t.outputNode=n}}else if("analyze"===i)this.analyze(e);else if("generate"===i){if(1===this.generate.length){const n=this.getNodeType(e),i=e.getDataFromNode(this);r=i.snippet,void 0===r?(r=this.generate(e)||"",i.snippet=r):void 0!==i.flowCodes&&void 0!==e.context.nodeBlock&&e.addFlowCodeHierarchy(this,e.context.nodeBlock),r=e.format(r,n,t)}else r=this.generate(e,t)||""}return e.removeChain(this),e.addSequentialNode(this),r}getSerializeChildren(){return IE(this)}serialize(e){const t=this.getSerializeChildren(),n={};for(const{property:r,index:i,childNode:s}of t)void 0!==i?(void 0===n[r]&&(n[r]=Number.isInteger(i)?[]:{}),n[r][i]=s.toJSON(e.meta).uuid):n[r]=s.toJSON(e.meta).uuid;Object.keys(n).length>0&&(e.inputNodes=n)}deserialize(e){if(void 0!==e.inputNodes){const t=e.meta.nodes;for(const n in e.inputNodes)if(Array.isArray(e.inputNodes[n])){const r=[];for(const i of e.inputNodes[n])r.push(t[i]);this[n]=r}else if("object"==typeof e.inputNodes[n]){const r={};for(const i in e.inputNodes[n]){const s=e.inputNodes[n][i];r[i]=t[s]}this[n]=r}else{const r=e.inputNodes[n];this[n]=t[r]}}}toJSON(e){const{uuid:t,type:n}=this,r=void 0===e||"string"==typeof e;r&&(e={textures:{},images:{},nodes:{}});let i=e.nodes[t];function s(e){const t=[];for(const n in e){const r=e[n];delete r.metadata,t.push(r)}return t}if(void 0===i&&(i={uuid:t,type:n,meta:e,metadata:{version:4.6,type:"Node",generator:"Node.toJSON"}},!0!==r&&(e.nodes[i.uuid]=i),this.serialize(i),delete i.meta),r){const t=s(e.textures),n=s(e.images),r=s(e.nodes);t.length>0&&(i.textures=t),n.length>0&&(i.images=n),r.length>0&&(i.nodes=r)}return i}}class KE extends YE{static get type(){return"ArrayElementNode"}constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){return`${this.node.build(e)}[ ${this.indexNode.build(e,"uint")} ]`}}class QE extends YE{static get type(){return"ConvertNode"}constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){const t=this.node.getNodeType(e);let n=null;for(const r of this.convertTo.split("|"))null!==n&&e.getTypeLength(t)!==e.getTypeLength(r)||(n=r);return n}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){const n=this.node,r=this.getNodeType(e),i=n.build(e,r);return e.format(i,r,t)}}class ZE extends YE{static get type(){return"TempNode"}constructor(e=null){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).usageCount>1}build(e,t){if("generate"===e.getBuildStage()){const n=e.getVectorType(this.getNodeType(e,t)),r=e.getDataFromNode(this);if(void 0!==r.propertyName)return e.format(r.propertyName,n,t);if("void"!==n&&"void"!==t&&this.hasDependencies(e)){const i=super.build(e,n),s=e.getVarFromNode(this,null,n),a=e.getPropertyName(s);return e.addLineFlowCode(`${a} = ${i}`,this),r.snippet=i,r.propertyName=a,e.format(r.propertyName,n,t)}}return super.build(e,t)}}class JE extends ZE{static get type(){return"JoinNode"}constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return null!==this.nodeType?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce((t,n)=>t+e.getTypeLength(n.getNodeType(e)),0))}generate(e,t){const n=this.getNodeType(e),r=this.nodes,i=e.getComponentType(n),s=[];for(const t of r){let n=t.build(e);const r=e.getComponentType(t.getNodeType(e));r!==i&&(n=e.format(n,r,i)),s.push(n)}const a=`${e.getType(n)}( ${s.join(", ")} )`;return e.format(a,n,t)}}const eA=qE.join("");class tA extends YE{static get type(){return"SplitNode"}constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(const t of this.components)e=Math.max(qE.indexOf(t)+1,e);return e}getComponentType(e){return e.getComponentType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getComponentType(e))}generate(e,t){const n=this.node,r=e.getTypeLength(n.getNodeType(e));let i=null;if(r>1){let s=null;this.getVectorLength()>=r&&(s=e.getTypeFromLength(this.getVectorLength(),this.getComponentType(e)));const a=n.build(e,s);i=this.components.length===r&&this.components===eA.slice(0,this.components.length)?e.format(a,s,t):e.format(`${a}.${this.components}`,this.getNodeType(e),t)}else i=n.build(e,t);return i}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}}class nA extends ZE{static get type(){return"SetNode"}constructor(e,t,n){super(),this.sourceNode=e,this.components=t,this.targetNode=n}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{sourceNode:t,components:n,targetNode:r}=this,i=this.getNodeType(e),s=e.getComponentType(r.getNodeType(e)),a=e.getTypeFromLength(n.length,s),o=r.build(e,a),l=t.build(e,i),u=e.getTypeLength(i),c=[];for(let e=0;e<u;e++){const t=qE[e];t===n[0]?(c.push(o),e+=n.length-1):c.push(l+"."+t)}return`${e.getType(i)}( ${c.join(", ")} )`}}class rA extends ZE{static get type(){return"FlipNode"}constructor(e,t){super(),this.sourceNode=e,this.components=t}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{components:t,sourceNode:n}=this,r=this.getNodeType(e),i=n.build(e),s=e.getVarFromNode(this),a=e.getPropertyName(s);e.addLineFlowCode(a+" = "+i,this);const o=e.getTypeLength(r),l=[];let u=0;for(let e=0;e<o;e++){const n=qE[e];n===t[u]?(l.push("1.0 - "+a+"."+n),u++):l.push(a+"."+n)}return`${e.getType(r)}( ${l.join(", ")} )`}}class iA extends YE{static get type(){return"InputNode"}constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return null===this.nodeType?OE(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=OE(this.value),e.nodeType=this.nodeType,"ArrayBuffer"===e.valueType&&(e.value=BE(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?FE(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){}}class sA extends iA{static get type(){return"ConstNode"}constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){const n=this.getNodeType(e);return e.format(this.generateConst(e),n,t)}}let aA=null;const oA=new Map;function lA(e,t){if(!oA.has(e)){if("function"!=typeof t)throw new Error(`Node element ${e} is not a function`);oA.set(e,t)}}const uA=e=>e.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),cA=e=>uA(e).split("").sort().join(""),dA={setup(e,t){const n=t.shift();return e(OA(n),...t)},get(e,t,n){if("string"==typeof t&&void 0===e[t]){if(!0!==e.isStackNode&&"assign"===t)return(...e)=>(aA.assign(n,...e),n);if(oA.has(t)){const r=oA.get(t);return e.isStackNode?(...e)=>n.add(r(...e)):(...e)=>r(n,...e)}if("self"===t)return e;if(t.endsWith("Assign")&&oA.has(t.slice(0,t.length-6))){const r=oA.get(t.slice(0,t.length-6));return e.isStackNode?(...e)=>n.assign(e[0],r(...e)):(...e)=>n.assign(r(n,...e))}if(!0===/^[xyzwrgbastpq]{1,4}$/.test(t))return t=uA(t),kA(new tA(n,t));if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(t))return t=cA(t.slice(3).toLowerCase()),n=>kA(new nA(e,t,n));if(!0===/^flip[XYZWRGBASTPQ]{1,4}$/.test(t))return t=cA(t.slice(4).toLowerCase()),()=>kA(new rA(kA(e),t));if("width"===t||"height"===t||"depth"===t)return"width"===t?t="x":"height"===t?t="y":"depth"===t&&(t="z"),kA(new tA(e,t));if(!0===/^\d+$/.test(t))return kA(new KE(n,new sA(Number(t),"uint")))}return Reflect.get(e,t,n)},set:(e,t,n,r)=>"string"!=typeof t||void 0!==e[t]||!0!==/^[xyzwrgbastpq]{1,4}$/.test(t)&&"width"!==t&&"height"!==t&&"depth"!==t&&!0!==/^\d+$/.test(t)?Reflect.set(e,t,n,r):(r[t].assign(n),!0)},hA=new WeakMap,fA=new WeakMap,pA=function(e,t=null){for(const n in e)e[n]=kA(e[n],t);return e},mA=function(e,t=null){const n=e.length;for(let r=0;r<n;r++)e[r]=kA(e[r],t);return e},gA=function(e,t=null,n=null,r=null){const i=e=>kA(null!==r?Object.assign(e,r):e);return null===t?(...t)=>i(new e(...FA(t))):null!==n?(n=kA(n),(...r)=>i(new e(t,...FA(r),n))):(...n)=>i(new e(t,...FA(n)))},vA=function(e,...t){return kA(new e(...FA(t)))};class yA extends YE{constructor(e,t){super(),this.shaderNode=e,this.inputNodes=t}getNodeType(e){return this.shaderNode.nodeType||this.getOutputNode(e).getNodeType(e)}call(e){const{shaderNode:t,inputNodes:n}=this,r=e.getNodeProperties(t);if(r.onceOutput)return r.onceOutput;let i=null;if(t.layout){let r=fA.get(e.constructor);void 0===r&&(r=new WeakMap,fA.set(e.constructor,r));let s=r.get(t);void 0===s&&(s=kA(e.buildFunctionNode(t)),r.set(t,s)),null!==e.currentFunctionNode&&e.currentFunctionNode.includes.push(s),i=kA(s.call(n))}else{const r=t.jsFunc,s=null!==n?r(n,e):r(e);i=kA(s)}return t.once&&(r.onceOutput=i),i}getOutputNode(e){const t=e.getNodeProperties(this);return null===t.outputNode&&(t.outputNode=this.setupOutput(e)),t.outputNode}setup(e){return this.getOutputNode(e)}setupOutput(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}generate(e,t){return this.getOutputNode(e).build(e,t)}}class bA extends YE{constructor(e,t){super(t),this.jsFunc=e,this.layout=null,this.global=!0,this.once=!1}setLayout(e){return this.layout=e,this}call(e=null){return OA(e),kA(new yA(this,e))}setup(){return this.call()}}const _A=[!1,!0],xA=[0,1,2,3],SA=[-1,-2],TA=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],EA=new Map;for(const e of _A)EA.set(e,new sA(e));const AA=new Map;for(const e of xA)AA.set(e,new sA(e,"uint"));const wA=new Map([...AA].map(e=>new sA(e.value,"int")));for(const e of SA)wA.set(e,new sA(e,"int"));const MA=new Map([...wA].map(e=>new sA(e.value)));for(const e of TA)MA.set(e,new sA(e));for(const e of TA)MA.set(-e,new sA(-e));const RA={bool:EA,uint:AA,ints:wA,float:MA},CA=new Map([...EA,...MA]),IA=(e,t)=>CA.has(e)?CA.get(e):!0===e.isNode?e:new sA(e,t),LA=function(e,t=null){return(...n)=>{if((0===n.length||!["bool","float","int","uint"].includes(e)&&n.every(e=>"object"!=typeof e))&&(n=[FE(e,...n)]),1===n.length&&null!==t&&t.has(n[0]))return kA(t.get(n[0]));if(1===n.length){const t=IA(n[0],e);return(e=>{try{return e.getNodeType()}catch(e){return}})(t)===e?kA(t):kA(new QE(t,e))}const r=n.map(e=>IA(e));return kA(new JE(r,e))}},PA=e=>"object"==typeof e&&null!==e?e.value:e,NA=e=>null!=e?e.nodeType||e.convertTo||("string"==typeof e?e:null):null;function DA(e,t){return new Proxy(new bA(e,t),dA)}const kA=(e,t=null)=>function(e,t=null){const n=OE(e);if("node"===n){let t=hA.get(e);return void 0===t&&(t=new Proxy(e,dA),hA.set(e,t),hA.set(t,t)),t}return null===t&&("float"===n||"boolean"===n)||n&&"shader"!==n&&"string"!==n?kA(IA(e,t)):"shader"===n?VA(e):e}(e,t),OA=(e,t=null)=>new pA(e,t),FA=(e,t=null)=>new mA(e,t),UA=(...e)=>new gA(...e),BA=(...e)=>new vA(...e),VA=(e,t)=>{const n=new DA(e,t),r=(...e)=>{let t;return OA(e),t=e[0]&&e[0].isNode?[...e]:e[0],n.call(t)};return r.shaderNode=n,r.setLayout=e=>(n.setLayout(e),r),r.once=()=>(n.once=!0,r),r};lA("toGlobal",e=>(e.global=!0,e));const zA=e=>{aA=e},GA=()=>aA,HA=(...e)=>aA.If(...e);function $A(e){return aA&&aA.add(e),e}lA("append",$A);const WA=new LA("color"),jA=new LA("float",RA.float),qA=new LA("int",RA.ints),XA=new LA("uint",RA.uint),YA=new LA("bool",RA.bool),KA=new LA("vec2"),QA=new LA("ivec2"),ZA=new LA("uvec2"),JA=new LA("bvec2"),ew=new LA("vec3"),tw=new LA("ivec3"),nw=new LA("uvec3"),rw=new LA("bvec3"),iw=new LA("vec4"),sw=new LA("ivec4"),aw=new LA("uvec4"),ow=new LA("bvec4"),lw=new LA("mat2"),uw=new LA("mat3"),cw=new LA("mat4");lA("toColor",WA),lA("toFloat",jA),lA("toInt",qA),lA("toUint",XA),lA("toBool",YA),lA("toVec2",KA),lA("toIVec2",QA),lA("toUVec2",ZA),lA("toBVec2",JA),lA("toVec3",ew),lA("toIVec3",tw),lA("toUVec3",nw),lA("toBVec3",rw),lA("toVec4",iw),lA("toIVec4",sw),lA("toUVec4",aw),lA("toBVec4",ow),lA("toMat2",lw),lA("toMat3",uw),lA("toMat4",cw);const dw=UA(KE),hw=(e,t)=>kA(new QE(kA(e),t));lA("element",dw),lA("convert",hw);class fw extends YE{static get type(){return"UniformGroupNode"}constructor(e,t=!1,n=1){super("string"),this.name=e,this.shared=t,this.order=n,this.isUniformGroup=!0}serialize(e){super.serialize(e),e.name=this.name,e.version=this.version,e.shared=this.shared}deserialize(e){super.deserialize(e),this.name=e.name,this.version=e.version,this.shared=e.shared}}const pw=e=>new fw(e),mw=(e,t=0)=>new fw(e,!0,t),gw=mw("frame"),vw=mw("render"),yw=pw("object");class bw extends iA{static get type(){return"UniformNode"}constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.name="",this.groupNode=yw}label(e){return this.name=e,this}setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}onUpdate(e,t){const n=this.getSelf();return e=e.bind(n),super.onUpdate(t=>{const r=e(t,n);void 0!==r&&(this.value=r)},t)}generate(e,t){const n=this.getNodeType(e),r=this.getUniformHash(e);let i=e.getNodeFromHash(r);void 0===i&&(e.setHashNode(this,r),i=this);const s=i.getInputType(e),a=e.getUniformFromNode(i,s,e.shaderStage,this.name||e.context.label),o=e.getPropertyName(a);return void 0!==e.context.label&&delete e.context.label,e.format(o,n,t)}}const _w=(e,t)=>{const n=NA(t||e),r=e&&!0===e.isNode?e.node&&e.node.value||e.value:e;return kA(new bw(r,n))};class xw extends YE{static get type(){return"PropertyNode"}constructor(e,t=null,n=!1){super(e),this.name=t,this.varying=n,this.isPropertyNode=!0}getHash(e){return this.name||super.getHash(e)}isGlobal(){return!0}generate(e){let t;return!0===this.varying?(t=e.getVaryingFromNode(this,this.name),t.needsInterpolation=!0):t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}}const Sw=(e,t)=>kA(new xw(e,t)),Tw=(e,t)=>kA(new xw(e,t,!0)),Ew=BA(xw,"vec4","DiffuseColor"),Aw=BA(xw,"vec3","EmissiveColor"),ww=BA(xw,"float","Roughness"),Mw=BA(xw,"float","Metalness"),Rw=BA(xw,"float","Clearcoat"),Cw=BA(xw,"float","ClearcoatRoughness"),Iw=BA(xw,"vec3","Sheen"),Lw=BA(xw,"float","SheenRoughness"),Pw=BA(xw,"float","Iridescence"),Nw=BA(xw,"float","IridescenceIOR"),Dw=BA(xw,"float","IridescenceThickness"),kw=BA(xw,"float","AlphaT"),Ow=BA(xw,"float","Anisotropy"),Fw=BA(xw,"vec3","AnisotropyT"),Uw=BA(xw,"vec3","AnisotropyB"),Bw=BA(xw,"color","SpecularColor"),Vw=BA(xw,"float","SpecularF90"),zw=BA(xw,"float","Shininess"),Gw=BA(xw,"vec4","Output"),Hw=BA(xw,"float","dashSize"),$w=BA(xw,"float","gapSize"),Ww=BA(xw,"float","pointWidth"),jw=BA(xw,"float","IOR"),qw=BA(xw,"float","Transmission"),Xw=BA(xw,"float","Thickness"),Yw=BA(xw,"float","AttenuationDistance"),Kw=BA(xw,"color","AttenuationColor"),Qw=BA(xw,"float","Dispersion");class Zw extends ZE{static get type(){return"AssignNode"}constructor(e,t){super(),this.targetNode=e,this.sourceNode=t}hasDependencies(){return!1}getNodeType(e,t){return"void"!==t?this.targetNode.getNodeType(e):"void"}needsSplitAssign(e){const{targetNode:t}=this;if(!1===e.isAvailable("swizzleAssign")&&t.isSplitNode&&t.components.length>1){const n=e.getTypeLength(t.node.getNodeType(e));return qE.join("").slice(0,n)!==t.components}return!1}generate(e,t){const{targetNode:n,sourceNode:r}=this,i=this.needsSplitAssign(e),s=n.getNodeType(e),a=n.context({assign:!0}).build(e),o=r.build(e,s),l=r.getNodeType(e),u=e.getDataFromNode(this);let c;if(!0===u.initialized)"void"!==t&&(c=a);else if(i){const r=e.getVarFromNode(this,null,s),i=e.getPropertyName(r);e.addLineFlowCode(`${i} = ${o}`,this);const l=n.node.context({assign:!0}).build(e);for(let t=0;t<n.components.length;t++){const r=n.components[t];e.addLineFlowCode(`${l}.${r} = ${i}[ ${t} ]`,this)}"void"!==t&&(c=a)}else c=`${a} = ${o}`,"void"!==t&&"void"!==l||(e.addLineFlowCode(c,this),"void"!==t&&(c=a));return u.initialized=!0,e.format(c,s,t)}}const Jw=UA(Zw);lA("assign",Jw);class eM extends ZE{static get type(){return"FunctionCallNode"}constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}generate(e){const t=[],n=this.functionNode,r=n.getInputs(e),i=this.parameters,s=(t,n)=>{const r=n.type;let i;return i="pointer"===r?"&"+t.build(e):t.build(e,r),i};if(Array.isArray(i))for(let e=0;e<i.length;e++)t.push(s(i[e],r[e]));else for(const e of r){const n=i[e.name];if(void 0===n)throw new Error(`FunctionCallNode: Input '${e.name}' not found in FunctionNode.`);t.push(s(n,e))}return`${n.build(e,"property")}( ${t.join(", ")} )`}}const tM=(e,...t)=>(t=t.length>1||t[0]&&!0===t[0].isNode?FA(t):OA(t[0]),kA(new eM(kA(e),t)));lA("call",tM);class nM extends ZE{static get type(){return"OperatorNode"}constructor(e,t,n,...r){if(super(),r.length>0){let i=new nM(e,t,n);for(let t=0;t<r.length-1;t++)i=new nM(e,i,r[t]);t=i,n=r[r.length-1]}this.op=e,this.aNode=t,this.bNode=n}getNodeType(e,t){const n=this.op,r=this.aNode,i=this.bNode,s=r.getNodeType(e),a=void 0!==i?i.getNodeType(e):null;if("void"===s||"void"===a)return"void";if("%"===n)return s;if("~"===n||"&"===n||"|"===n||"^"===n||">>"===n||"<<"===n)return e.getIntegerType(s);if("!"===n||"=="===n||"&&"===n||"||"===n||"^^"===n)return"bool";if("<"===n||">"===n||"<="===n||">="===n){const n=t?e.getTypeLength(t):Math.max(e.getTypeLength(s),e.getTypeLength(a));return n>1?`bvec${n}`:"bool"}return"float"===s&&e.isMatrix(a)?a:e.isMatrix(s)&&e.isVector(a)?e.getVectorFromMatrix(s):e.isVector(s)&&e.isMatrix(a)?e.getVectorFromMatrix(a):e.getTypeLength(a)>e.getTypeLength(s)?a:s}generate(e,t){const n=this.op,r=this.aNode,i=this.bNode,s=this.getNodeType(e,t);let a=null,o=null;"void"!==s?(a=r.getNodeType(e),o=void 0!==i?i.getNodeType(e):null,"<"===n||">"===n||"<="===n||">="===n||"=="===n?e.isVector(a)?o=a:a!==o&&(a=o="float"):">>"===n||"<<"===n?(a=s,o=e.changeComponentType(o,"uint")):e.isMatrix(a)&&e.isVector(o)?o=e.getVectorFromMatrix(a):a=e.isVector(a)&&e.isMatrix(o)?e.getVectorFromMatrix(o):o=s):a=o=s;const l=r.build(e,a),u=void 0!==i?i.build(e,o):null,c=e.getTypeLength(t),d=e.getFunctionOperator(n);return"void"!==t?"<"===n&&c>1?e.useComparisonMethod?e.format(`${e.getMethod("lessThan",t)}( ${l}, ${u} )`,s,t):e.format(`( ${l} < ${u} )`,s,t):"<="===n&&c>1?e.useComparisonMethod?e.format(`${e.getMethod("lessThanEqual",t)}( ${l}, ${u} )`,s,t):e.format(`( ${l} <= ${u} )`,s,t):">"===n&&c>1?e.useComparisonMethod?e.format(`${e.getMethod("greaterThan",t)}( ${l}, ${u} )`,s,t):e.format(`( ${l} > ${u} )`,s,t):">="===n&&c>1?e.useComparisonMethod?e.format(`${e.getMethod("greaterThanEqual",t)}( ${l}, ${u} )`,s,t):e.format(`( ${l} >= ${u} )`,s,t):"!"===n||"~"===n?e.format(`(${n}${l})`,a,t):d?e.format(`${d}( ${l}, ${u} )`,s,t):e.format(`( ${l} ${n} ${u} )`,s,t):"void"!==a?d?e.format(`${d}( ${l}, ${u} )`,s,t):e.format(`${l} ${n} ${u}`,s,t):void 0}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}}const rM=UA(nM,"+"),iM=UA(nM,"-"),sM=UA(nM,"*"),aM=UA(nM,"/"),oM=UA(nM,"%"),lM=UA(nM,"=="),uM=UA(nM,"!="),cM=UA(nM,"<"),dM=UA(nM,">"),hM=UA(nM,"<="),fM=UA(nM,">="),pM=UA(nM,"&&"),mM=UA(nM,"||"),gM=UA(nM,"!"),vM=UA(nM,"^^"),yM=UA(nM,"&"),bM=UA(nM,"~"),_M=UA(nM,"|"),xM=UA(nM,"^"),SM=UA(nM,"<<"),TM=UA(nM,">>");lA("add",rM),lA("sub",iM),lA("mul",sM),lA("div",aM),lA("modInt",oM),lA("equal",lM),lA("notEqual",uM),lA("lessThan",cM),lA("greaterThan",dM),lA("lessThanEqual",hM),lA("greaterThanEqual",fM),lA("and",pM),lA("or",mM),lA("not",gM),lA("xor",vM),lA("bitAnd",yM),lA("bitNot",bM),lA("bitOr",_M),lA("bitXor",xM),lA("shiftLeft",SM),lA("shiftRight",TM);const EM=(...e)=>oM(...e);lA("remainder",EM);class AM extends ZE{static get type(){return"MathNode"}constructor(e,t,n=null,r=null){super(),this.method=e,this.aNode=t,this.bNode=n,this.cNode=r}getInputType(e){const t=this.aNode.getNodeType(e),n=this.bNode?this.bNode.getNodeType(e):null,r=this.cNode?this.cNode.getNodeType(e):null,i=e.isMatrix(t)?0:e.getTypeLength(t),s=e.isMatrix(n)?0:e.getTypeLength(n),a=e.isMatrix(r)?0:e.getTypeLength(r);return i>s&&i>a?t:s>a?n:a>i?r:t}getNodeType(e){const t=this.method;return t===AM.LENGTH||t===AM.DISTANCE||t===AM.DOT?"float":t===AM.CROSS?"vec3":t===AM.ALL?"bool":t===AM.EQUALS?e.changeComponentType(this.aNode.getNodeType(e),"bool"):t===AM.MOD?this.aNode.getNodeType(e):this.getInputType(e)}generate(e,t){let n=this.method;const r=this.getNodeType(e),i=this.getInputType(e),s=this.aNode,a=this.bNode,o=this.cNode,l=e.renderer.coordinateSystem;if(n===AM.TRANSFORM_DIRECTION){let n=s,r=a;e.isMatrix(n.getNodeType(e))?r=iw(ew(r),0):n=iw(ew(n),0);const i=sM(n,r).xyz;return GM(i).build(e,t)}if(n===AM.NEGATE)return e.format("( - "+s.build(e,i)+" )",r,t);if(n===AM.ONE_MINUS)return iM(1,s).build(e,t);if(n===AM.RECIPROCAL)return aM(1,s).build(e,t);if(n===AM.DIFFERENCE)return KM(iM(s,a)).build(e,t);{const u=[];return n===AM.CROSS||n===AM.MOD?u.push(s.build(e,r),a.build(e,r)):l===kt&&n===AM.STEP?u.push(s.build(e,1===e.getTypeLength(s.getNodeType(e))?"float":i),a.build(e,i)):l===kt&&(n===AM.MIN||n===AM.MAX)||n===AM.MOD?u.push(s.build(e,i),a.build(e,1===e.getTypeLength(a.getNodeType(e))?"float":i)):n===AM.REFRACT?u.push(s.build(e,i),a.build(e,i),o.build(e,"float")):n===AM.MIX?u.push(s.build(e,i),a.build(e,i),o.build(e,1===e.getTypeLength(o.getNodeType(e))?"float":i)):(l===Ot&&n===AM.ATAN&&null!==a&&(n="atan2"),u.push(s.build(e,i)),null!==a&&u.push(a.build(e,i)),null!==o&&u.push(o.build(e,i))),e.format(`${e.getMethod(n,r)}( ${u.join(", ")} )`,r,t)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}AM.ALL="all",AM.ANY="any",AM.RADIANS="radians",AM.DEGREES="degrees",AM.EXP="exp",AM.EXP2="exp2",AM.LOG="log",AM.LOG2="log2",AM.SQRT="sqrt",AM.INVERSE_SQRT="inversesqrt",AM.FLOOR="floor",AM.CEIL="ceil",AM.NORMALIZE="normalize",AM.FRACT="fract",AM.SIN="sin",AM.COS="cos",AM.TAN="tan",AM.ASIN="asin",AM.ACOS="acos",AM.ATAN="atan",AM.ABS="abs",AM.SIGN="sign",AM.LENGTH="length",AM.NEGATE="negate",AM.ONE_MINUS="oneMinus",AM.DFDX="dFdx",AM.DFDY="dFdy",AM.ROUND="round",AM.RECIPROCAL="reciprocal",AM.TRUNC="trunc",AM.FWIDTH="fwidth",AM.TRANSPOSE="transpose",AM.BITCAST="bitcast",AM.EQUALS="equals",AM.MIN="min",AM.MAX="max",AM.MOD="mod",AM.STEP="step",AM.REFLECT="reflect",AM.DISTANCE="distance",AM.DIFFERENCE="difference",AM.DOT="dot",AM.CROSS="cross",AM.POW="pow",AM.TRANSFORM_DIRECTION="transformDirection",AM.MIX="mix",AM.CLAMP="clamp",AM.REFRACT="refract",AM.SMOOTHSTEP="smoothstep",AM.FACEFORWARD="faceforward";const wM=jA(1e-6),MM=jA(1e6),RM=jA(Math.PI),CM=jA(2*Math.PI),IM=UA(AM,AM.ALL),LM=UA(AM,AM.ANY),PM=UA(AM,AM.RADIANS),NM=UA(AM,AM.DEGREES),DM=UA(AM,AM.EXP),kM=UA(AM,AM.EXP2),OM=UA(AM,AM.LOG),FM=UA(AM,AM.LOG2),UM=UA(AM,AM.SQRT),BM=UA(AM,AM.INVERSE_SQRT),VM=UA(AM,AM.FLOOR),zM=UA(AM,AM.CEIL),GM=UA(AM,AM.NORMALIZE),HM=UA(AM,AM.FRACT),$M=UA(AM,AM.SIN),WM=UA(AM,AM.COS),jM=UA(AM,AM.TAN),qM=UA(AM,AM.ASIN),XM=UA(AM,AM.ACOS),YM=UA(AM,AM.ATAN),KM=UA(AM,AM.ABS),QM=UA(AM,AM.SIGN),ZM=UA(AM,AM.LENGTH),JM=UA(AM,AM.NEGATE),eR=UA(AM,AM.ONE_MINUS),tR=UA(AM,AM.DFDX),nR=UA(AM,AM.DFDY),rR=UA(AM,AM.ROUND),iR=UA(AM,AM.RECIPROCAL),sR=UA(AM,AM.TRUNC),aR=UA(AM,AM.FWIDTH),oR=UA(AM,AM.TRANSPOSE),lR=UA(AM,AM.BITCAST),uR=UA(AM,AM.EQUALS),cR=UA(AM,AM.MIN),dR=UA(AM,AM.MAX),hR=UA(AM,AM.MOD),fR=UA(AM,AM.STEP),pR=UA(AM,AM.REFLECT),mR=UA(AM,AM.DISTANCE),gR=UA(AM,AM.DIFFERENCE),vR=UA(AM,AM.DOT),yR=UA(AM,AM.CROSS),bR=UA(AM,AM.POW),_R=UA(AM,AM.POW,2),xR=UA(AM,AM.POW,3),SR=UA(AM,AM.POW,4),TR=UA(AM,AM.TRANSFORM_DIRECTION),ER=e=>sM(QM(e),bR(KM(e),1/3)),AR=e=>vR(e,e),wR=UA(AM,AM.MIX),MR=(e,t=0,n=1)=>kA(new AM(AM.CLAMP,kA(e),kA(t),kA(n))),RR=e=>MR(e),CR=UA(AM,AM.REFRACT),IR=UA(AM,AM.SMOOTHSTEP),LR=UA(AM,AM.FACEFORWARD),PR=VA(([e])=>{const t=vR(e.xy,KA(12.9898,78.233)),n=hR(t,RM);return HM($M(n).mul(43758.5453))}),NR=(e,t,n)=>wR(t,n,e),DR=(e,t,n)=>IR(t,n,e),kR=(e,t)=>YM(e,t),OR=LR,FR=BM;lA("all",IM),lA("any",LM),lA("equals",uR),lA("radians",PM),lA("degrees",NM),lA("exp",DM),lA("exp2",kM),lA("log",OM),lA("log2",FM),lA("sqrt",UM),lA("inverseSqrt",BM),lA("floor",VM),lA("ceil",zM),lA("normalize",GM),lA("fract",HM),lA("sin",$M),lA("cos",WM),lA("tan",jM),lA("asin",qM),lA("acos",XM),lA("atan",YM),lA("abs",KM),lA("sign",QM),lA("length",ZM),lA("lengthSq",AR),lA("negate",JM),lA("oneMinus",eR),lA("dFdx",tR),lA("dFdy",nR),lA("round",rR),lA("reciprocal",iR),lA("trunc",sR),lA("fwidth",aR),lA("atan2",kR),lA("min",cR),lA("max",dR),lA("mod",hR),lA("step",fR),lA("reflect",pR),lA("distance",mR),lA("dot",vR),lA("cross",yR),lA("pow",bR),lA("pow2",_R),lA("pow3",xR),lA("pow4",SR),lA("transformDirection",TR),lA("mix",NR),lA("clamp",MR),lA("refract",CR),lA("smoothstep",DR),lA("faceForward",LR),lA("difference",gR),lA("saturate",RR),lA("cbrt",ER),lA("transpose",oR),lA("rand",PR);class UR extends YE{static get type(){return"ConditionalNode"}constructor(e,t,n=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=n}getNodeType(e){const{ifNode:t,elseNode:n}=e.getNodeProperties(this);if(void 0===t)return this.setup(e),this.getNodeType(e);const r=t.getNodeType(e);if(null!==n){const t=n.getNodeType(e);if(e.getTypeLength(t)>e.getTypeLength(r))return t}return r}setup(e){const t=this.condNode.cache(),n=this.ifNode.cache(),r=this.elseNode?this.elseNode.cache():null,i=e.context.nodeBlock;e.getDataFromNode(n).parentNodeBlock=i,null!==r&&(e.getDataFromNode(r).parentNodeBlock=i);const s=e.getNodeProperties(this);s.condNode=t,s.ifNode=n.context({nodeBlock:n}),s.elseNode=r?r.context({nodeBlock:r}):null}generate(e,t){const n=this.getNodeType(e),r=e.getDataFromNode(this);if(void 0!==r.nodeProperty)return r.nodeProperty;const{condNode:i,ifNode:s,elseNode:a}=e.getNodeProperties(this),o="void"!==t,l=o?Sw(n).build(e):"";r.nodeProperty=l;const u=i.build(e,"bool");e.addFlowCode(`\n${e.tab}if ( ${u} ) {\n\n`).addFlowTab();let c=s.build(e,n);if(c&&(c=o?l+" = "+c+";":"return "+c+";"),e.removeFlowTab().addFlowCode(e.tab+"\t"+c+"\n\n"+e.tab+"}"),null!==a){e.addFlowCode(" else {\n\n").addFlowTab();let t=a.build(e,n);t&&(t=o?l+" = "+t+";":"return "+t+";"),e.removeFlowTab().addFlowCode(e.tab+"\t"+t+"\n\n"+e.tab+"}\n\n")}else e.addFlowCode("\n\n");return e.format(l,n,t)}}const BR=UA(UR);lA("select",BR);const VR=(...e)=>BR(...e);lA("cond",VR);class zR extends YE{static get type(){return"ContextNode"}constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.value=t}getScope(){return this.node.getScope()}getNodeType(e){return this.node.getNodeType(e)}analyze(e){this.node.build(e)}setup(e){const t=e.getContext();e.setContext({...e.context,...this.value});const n=this.node.build(e);return e.setContext(t),n}generate(e,t){const n=e.getContext();e.setContext({...e.context,...this.value});const r=this.node.build(e,t);return e.setContext(n),r}}const GR=UA(zR),HR=(e,t)=>GR(e,{label:t});lA("context",GR),lA("label",HR);class $R extends YE{static get type(){return"VarNode"}constructor(e,t=null){super(),this.node=e,this.name=t,this.global=!0,this.isVarNode=!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){const{node:t,name:n}=this,r=e.getVarFromNode(this,n,e.getVectorType(this.getNodeType(e))),i=e.getPropertyName(r),s=t.build(e,r.type);return e.addLineFlowCode(`${i} = ${s}`,this),i}}const WR=UA($R);lA("toVar",(...e)=>WR(...e).append());const jR=e=>WR(e);lA("temp",jR);class qR extends YE{static get type(){return"VaryingNode"}constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0}isGlobal(){return!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}setupVarying(e){const t=e.getNodeProperties(this);let n=t.varying;if(void 0===n){const r=this.name,i=this.getNodeType(e);t.varying=n=e.getVaryingFromNode(this,r,i),t.node=this.node}return n.needsInterpolation||(n.needsInterpolation="fragment"===e.shaderStage),n}setup(e){this.setupVarying(e)}analyze(e){return this.setupVarying(e),this.node.analyze(e)}generate(e){const t=e.getNodeProperties(this),n=this.setupVarying(e),r="fragment"===e.shaderStage&&!0===t.reassignPosition&&e.context.needsPositionReassign;if(void 0===t.propertyName||r){const i=this.getNodeType(e),s=e.getPropertyName(n,zE.VERTEX);e.flowNodeFromShaderStage(zE.VERTEX,this.node,i,s),t.propertyName=s,r?t.reassignPosition=!1:void 0===t.reassignPosition&&e.context.isPositionNodeInput&&(t.reassignPosition=!0)}return e.getPropertyName(n)}}const XR=UA(qR),YR=e=>XR(e);lA("varying",XR),lA("vertexStage",YR);const KR=VA(([e])=>{const t=e.mul(.9478672986).add(.0521327014).pow(2.4),n=e.mul(.0773993808),r=e.lessThanEqual(.04045);return wR(t,n,r)}).setLayout({name:"sRGBTransferEOTF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),QR=VA(([e])=>{const t=e.pow(.41666).mul(1.055).sub(.055),n=e.mul(12.92),r=e.lessThanEqual(.0031308);return wR(t,n,r)}).setLayout({name:"sRGBTransferOETF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),ZR="WorkingColorSpace",JR="OutputColorSpace";class eC extends ZE{static get type(){return"ColorSpaceNode"}constructor(e,t,n){super("vec4"),this.colorNode=e,this.source=t,this.target=n}resolveColorSpace(e,t){return t===ZR?un.workingColorSpace:t===JR?e.context.outputColorSpace||e.renderer.outputColorSpace:t}setup(e){const{colorNode:t}=this,n=this.resolveColorSpace(e,this.source),r=this.resolveColorSpace(e,this.target);let i=t;return!1!==un.enabled&&n!==r&&n&&r?(un.getTransfer(n)===xt&&(i=iw(KR(i.rgb),i.a)),un.getPrimaries(n)!==un.getPrimaries(r)&&(i=iw(uw(un._getMatrix(new Kt,n,r)).mul(i.rgb),i.a)),un.getTransfer(r)===xt&&(i=iw(QR(i.rgb),i.a)),i):i}}const tC=e=>kA(new eC(kA(e),ZR,JR)),nC=e=>kA(new eC(kA(e),JR,ZR)),rC=(e,t)=>kA(new eC(kA(e),ZR,t)),iC=(e,t)=>kA(new eC(kA(e),t,ZR));lA("toOutputColorSpace",tC),lA("toWorkingColorSpace",nC),lA("workingToColorSpace",rC),lA("colorSpaceToWorking",iC);let sC=class extends KE{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),n=this.referenceNode.getNodeType(),r=this.getNodeType();return e.format(t,n,r)}};class aC extends YE{static get type(){return"ReferenceBaseNode"}constructor(e,t,n=null,r=null){super(),this.property=e,this.uniformType=t,this.object=n,this.count=r,this.properties=e.split("."),this.reference=n,this.node=null,this.group=null,this.updateType=GE.OBJECT}setGroup(e){return this.group=e,this}element(e){return kA(new sC(this,kA(e)))}setNodeType(e){const t=_w(null,e).getSelf();null!==this.group&&t.setGroup(this.group),this.node=t}getNodeType(e){return null===this.node&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let n=e[t[0]];for(let e=1;e<t.length;e++)n=n[t[e]];return n}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}class oC extends aC{static get type(){return"RendererReferenceNode"}constructor(e,t,n=null){super(e,t,n),this.renderer=n,this.setGroup(vw)}updateReference(e){return this.reference=null!==this.renderer?this.renderer:e.renderer,this.reference}}const lC=(e,t,n=null)=>kA(new oC(e,t,n));class uC extends ZE{static get type(){return"ToneMappingNode"}constructor(e,t=dC,n=null){super("vec3"),this.toneMapping=e,this.exposureNode=t,this.colorNode=n}customCacheKey(){return RE(this.toneMapping)}setup(e){const t=this.colorNode||e.context.color,n=this.toneMapping;if(0===n)return t;let r=null;const i=e.renderer.library.getToneMappingFunction(n);return r=null!==i?iw(i(t.rgb,this.exposureNode),t.a):t,r}}const cC=(e,t,n)=>kA(new uC(e,kA(t),kA(n))),dC=lC("toneMappingExposure","float");lA("toneMapping",(e,t,n)=>cC(t,n,e));class hC extends iA{static get type(){return"BufferAttributeNode"}constructor(e,t=null,n=0,r=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=n,this.bufferOffset=r,this.usage=Pt,this.instanced=!1,this.attribute=null,this.global=!0,e&&!0===e.isBufferAttribute&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getHash(e){if(0===this.bufferStride&&0===this.bufferOffset){let t=e.globalCache.getData(this.value);return void 0===t&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getNodeType(e){return null===this.bufferType&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(null!==this.attribute)return;const t=this.getNodeType(e),n=this.value,r=e.getTypeLength(t),i=this.bufferStride||r,s=this.bufferOffset,a=!0===n.isInterleavedBuffer?n:new Yi(n,i),o=new Qi(a,r,s);a.setUsage(this.usage),this.attribute=o,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){const t=this.getNodeType(e),n=e.getBufferAttributeFromNode(this,t),r=e.getPropertyName(n);let i=null;if("vertex"===e.shaderStage||"compute"===e.shaderStage)this.name=r,i=r;else{i=XR(this).build(e,t)}return i}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this.attribute&&!0===this.attribute.isBufferAttribute&&(this.attribute.usage=e),this}setInstanced(e){return this.instanced=e,this}}const fC=(e,t=null,n=0,r=0)=>kA(new hC(e,t,n,r)),pC=(e,t=null,n=0,r=0)=>fC(e,t,n,r).setUsage(Nt),mC=(e,t=null,n=0,r=0)=>fC(e,t,n,r).setInstanced(!0),gC=(e,t=null,n=0,r=0)=>pC(e,t,n,r).setInstanced(!0);lA("toAttribute",e=>fC(e.value));class vC extends YE{static get type(){return"ComputeNode"}constructor(e,t,n=[64]){super("void"),this.isComputeNode=!0,this.computeNode=e,this.count=t,this.workgroupSize=n,this.dispatchCount=0,this.version=1,this.name="",this.updateBeforeType=GE.OBJECT,this.onInitFunction=null,this.updateDispatchCount()}dispose(){this.dispatchEvent({type:"dispose"})}label(e){return this.name=e,this}updateDispatchCount(){const{count:e,workgroupSize:t}=this;let n=t[0];for(let e=1;e<t.length;e++)n*=t[e];this.dispatchCount=Math.ceil(e/n)}onInit(e){return this.onInitFunction=e,this}updateBefore({renderer:e}){e.compute(this)}generate(e){const{shaderStage:t}=e;if("compute"===t){const t=this.computeNode.build(e,"void");""!==t&&e.addLineFlowCode(t,this)}}}const yC=(e,t,n)=>kA(new vC(kA(e),t,n));lA("compute",yC);class bC extends YE{static get type(){return"CacheNode"}constructor(e,t=!0){super(),this.node=e,this.parent=t,this.isCacheNode=!0}getNodeType(e){const t=e.getCache(),n=e.getCacheFromNode(this,this.parent);e.setCache(n);const r=this.node.getNodeType(e);return e.setCache(t),r}build(e,...t){const n=e.getCache(),r=e.getCacheFromNode(this,this.parent);e.setCache(r);const i=this.node.build(e,...t);return e.setCache(n),i}}const _C=(e,t)=>kA(new bC(kA(e),t));lA("cache",_C);class xC extends YE{static get type(){return"BypassNode"}constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){const t=this.callNode.build(e,"void");return""!==t&&e.addLineFlowCode(t,this),this.outputNode.build(e)}}const SC=UA(xC);lA("bypass",SC);class TC extends YE{static get type(){return"RemapNode"}constructor(e,t,n,r=jA(0),i=jA(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=n,this.outLowNode=r,this.outHighNode=i,this.doClamp=!0}setup(){const{node:e,inLowNode:t,inHighNode:n,outLowNode:r,outHighNode:i,doClamp:s}=this;let a=e.sub(t).div(n.sub(t));return!0===s&&(a=a.clamp()),a.mul(i.sub(r)).add(r)}}const EC=UA(TC,null,null,{doClamp:!1}),AC=UA(TC);lA("remap",EC),lA("remapClamp",AC);class wC extends YE{static get type(){return"ExpressionNode"}constructor(e="",t="void"){super(t),this.snippet=e}generate(e,t){const n=this.getNodeType(e),r=this.snippet;if("void"!==n)return e.format(`( ${r} )`,n,t);e.addLineFlowCode(r,this)}}const MC=UA(wC),RC=e=>(e?BR(e,MC("discard")):MC("discard")).append();lA("discard",RC);class CC extends ZE{static get type(){return"RenderOutputNode"}constructor(e,t,n){super("vec4"),this.colorNode=e,this.toneMapping=t,this.outputColorSpace=n,this.isRenderOutputNode=!0}setup({context:e}){let t=this.colorNode||e.color;const n=(null!==this.toneMapping?this.toneMapping:e.toneMapping)||0,r=(null!==this.outputColorSpace?this.outputColorSpace:e.outputColorSpace)||vt;return 0!==n&&(t=t.toneMapping(n)),r!==vt&&r!==un.workingColorSpace&&(t=t.workingToColorSpace(r)),t}}const IC=(e,t=null,n=null)=>kA(new CC(kA(e),t,n));lA("renderOutput",IC);class LC extends YE{static get type(){return"AttributeNode"}constructor(e,t=null){super(t),this.global=!0,this._attributeName=e}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=this.nodeType;if(null===t){const n=this.getAttributeName(e);if(e.hasGeometryAttribute(n)){const r=e.geometry.getAttribute(n);t=e.getTypeFromAttribute(r)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){const t=this.getAttributeName(e),n=this.getNodeType(e);if(!0===e.hasGeometryAttribute(t)){const r=e.geometry.getAttribute(t),i=e.getTypeFromAttribute(r),s=e.getAttribute(t,i);if("vertex"===e.shaderStage)return e.format(s.name,i,n);return XR(this).build(e,n)}return e.generateConst(n)}serialize(e){super.serialize(e),e.global=this.global,e._attributeName=this._attributeName}deserialize(e){super.deserialize(e),this.global=e.global,this._attributeName=e._attributeName}}const PC=(e,t)=>kA(new LC(e,t)),NC=(e=0)=>PC("uv"+(e>0?e:""),"vec2");class DC extends YE{static get type(){return"TextureSizeNode"}constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){const n=this.textureNode.build(e,"property"),r=null===this.levelNode?"0":this.levelNode.build(e,"int");return e.format(`${e.getMethod("textureDimensions")}( ${n}, ${r} )`,this.getNodeType(e),t)}}const kC=UA(DC);class OC extends bw{static get type(){return"MaxMipLevelNode"}constructor(e){super(0),this._textureNode=e,this.updateType=GE.FRAME}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){const e=this.texture,t=e.images,n=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(n&&void 0!==n.width){const{width:e,height:t}=n;this.value=Math.log2(Math.max(e,t))}}}const FC=UA(OC);class UC extends bw{static get type(){return"TextureNode"}constructor(e,t=null,n=null,r=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=n,this.biasNode=r,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=GE.NONE,this.referenceNode=null,this._value=e,this._matrixUniform=null,this.setUpdateMatrix(null===t)}set value(e){this.referenceNode?this.referenceNode.value=e:this._value=e}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":this.value.type===he?"uvec4":this.value.type===de?"ivec4":"vec4"}getInputType(){return"texture"}getDefaultUV(){return NC(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){return null===this._matrixUniform&&(this._matrixUniform=_w(this.value.matrix)),this._matrixUniform.mul(ew(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?GE.RENDER:GE.NONE,this}setupUV(e,t){const n=this.value;return e.isFlipY()&&(n.image instanceof ImageBitmap&&!0===n.flipY||!0===n.isRenderTargetTexture||!0===n.isFramebufferTexture||!0===n.isDepthTexture)&&(t=this.sampler?t.flipY():t.setY(qA(kC(this,this.levelNode).y).sub(t.y).sub(1))),t}setup(e){const t=e.getNodeProperties(this);t.referenceNode=this.referenceNode;const n=this.value;if(!n||!0!==n.isTexture)throw new Error("THREE.TSL: `texture( value )` function expects a valid instance of THREE.Texture().");let r=this.uvNode;null!==r&&!0!==e.context.forceUVContext||!e.context.getUV||(r=e.context.getUV(this)),r||(r=this.getDefaultUV()),!0===this.updateMatrix&&(r=this.getTransformedUV(r)),r=this.setupUV(e,r);let i=this.levelNode;null===i&&e.context.getTextureLevel&&(i=e.context.getTextureLevel(this)),t.uvNode=r,t.levelNode=i,t.biasNode=this.biasNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t.depthNode=this.depthNode}generateUV(e,t){return t.build(e,!0===this.sampler?"vec2":"ivec2")}generateSnippet(e,t,n,r,i,s,a,o){const l=this.value;let u;return u=r?e.generateTextureLevel(l,t,n,r,s):i?e.generateTextureBias(l,t,n,i,s):o?e.generateTextureGrad(l,t,n,o,s):a?e.generateTextureCompare(l,t,n,a,s):!1===this.sampler?e.generateTextureLoad(l,t,n,s):e.generateTexture(l,t,n,s),u}generate(e,t){const n=this.value,r=e.getNodeProperties(this),i=super.generate(e,"property");if("sampler"===t)return i+"_sampler";if(e.isReference(t))return i;{const s=e.getDataFromNode(this);let a=s.propertyName;if(void 0===a){const{uvNode:t,levelNode:n,biasNode:o,compareNode:l,depthNode:u,gradNode:c}=r,d=this.generateUV(e,t),h=n?n.build(e,"float"):null,f=o?o.build(e,"float"):null,p=u?u.build(e,"int"):null,m=l?l.build(e,"float"):null,g=c?[c[0].build(e,"vec2"),c[1].build(e,"vec2")]:null,v=e.getVarFromNode(this);a=e.getPropertyName(v);const y=this.generateSnippet(e,i,d,h,f,p,m,g);e.addLineFlowCode(`${a} = ${y}`,this),s.snippet=y,s.propertyName=a}let o=a;const l=this.getNodeType(e);return e.needsToWorkingColorSpace(n)&&(o=iC(MC(o,l),n.colorSpace).setup(e).build(e,l)),e.format(o,l,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){return this.sample(e)}sample(e){const t=this.clone();return t.uvNode=kA(e),t.referenceNode=this.getSelf(),kA(t)}blur(e){const t=this.clone();return t.biasNode=kA(e).mul(FC(t)),t.referenceNode=this.getSelf(),kA(t)}level(e){const t=this.clone();return t.levelNode=kA(e),t.referenceNode=this.getSelf(),kA(t)}size(e){return kC(this,e)}bias(e){const t=this.clone();return t.biasNode=kA(e),t.referenceNode=this.getSelf(),kA(t)}compare(e){const t=this.clone();return t.compareNode=kA(e),t.referenceNode=this.getSelf(),kA(t)}grad(e,t){const n=this.clone();return n.gradNode=[kA(e),kA(t)],n.referenceNode=this.getSelf(),kA(n)}depth(e){const t=this.clone();return t.depthNode=kA(e),t.referenceNode=this.getSelf(),kA(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid,e.sampler=this.sampler,e.updateMatrix=this.updateMatrix,e.updateType=this.updateType}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value],this.sampler=e.sampler,this.updateMatrix=e.updateMatrix,this.updateType=e.updateType}update(){const e=this.value,t=this._matrixUniform;null!==t&&(t.value=e.matrix),!0===e.matrixAutoUpdate&&e.updateMatrix()}clone(){const e=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return e.sampler=this.sampler,e}}const BC=UA(UC),VC=(...e)=>BC(...e).setSampler(!1),zC=_w("float").label("cameraNear").setGroup(vw).onRenderUpdate(({camera:e})=>e.near),GC=_w("float").label("cameraFar").setGroup(vw).onRenderUpdate(({camera:e})=>e.far),HC=_w("mat4").label("cameraProjectionMatrix").setGroup(vw).onRenderUpdate(({camera:e})=>e.projectionMatrix),$C=_w("mat4").label("cameraProjectionMatrixInverse").setGroup(vw).onRenderUpdate(({camera:e})=>e.projectionMatrixInverse),WC=_w("mat4").label("cameraViewMatrix").setGroup(vw).onRenderUpdate(({camera:e})=>e.matrixWorldInverse),jC=_w("mat4").label("cameraWorldMatrix").setGroup(vw).onRenderUpdate(({camera:e})=>e.matrixWorld),qC=_w("mat3").label("cameraNormalMatrix").setGroup(vw).onRenderUpdate(({camera:e})=>e.normalMatrix),XC=_w(new An).label("cameraPosition").setGroup(vw).onRenderUpdate(({camera:e},t)=>t.value.setFromMatrixPosition(e.matrixWorld));class YC extends YE{static get type(){return"Object3DNode"}constructor(e,t=null){super(),this.scope=e,this.object3d=t,this.updateType=GE.OBJECT,this._uniformNode=new bw(null)}getNodeType(){const e=this.scope;return e===YC.WORLD_MATRIX?"mat4":e===YC.POSITION||e===YC.VIEW_POSITION||e===YC.DIRECTION||e===YC.SCALE?"vec3":void 0}update(e){const t=this.object3d,n=this._uniformNode,r=this.scope;if(r===YC.WORLD_MATRIX)n.value=t.matrixWorld;else if(r===YC.POSITION)n.value=n.value||new An,n.value.setFromMatrixPosition(t.matrixWorld);else if(r===YC.SCALE)n.value=n.value||new An,n.value.setFromMatrixScale(t.matrixWorld);else if(r===YC.DIRECTION)n.value=n.value||new An,t.getWorldDirection(n.value);else if(r===YC.VIEW_POSITION){const r=e.camera;n.value=n.value||new An,n.value.setFromMatrixPosition(t.matrixWorld),n.value.applyMatrix4(r.matrixWorldInverse)}}generate(e){const t=this.scope;return t===YC.WORLD_MATRIX?this._uniformNode.nodeType="mat4":t!==YC.POSITION&&t!==YC.VIEW_POSITION&&t!==YC.DIRECTION&&t!==YC.SCALE||(this._uniformNode.nodeType="vec3"),this._uniformNode.build(e)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}YC.WORLD_MATRIX="worldMatrix",YC.POSITION="position",YC.SCALE="scale",YC.VIEW_POSITION="viewPosition",YC.DIRECTION="direction";const KC=UA(YC,YC.DIRECTION),QC=UA(YC,YC.WORLD_MATRIX),ZC=UA(YC,YC.POSITION),JC=UA(YC,YC.SCALE),eI=UA(YC,YC.VIEW_POSITION);class tI extends YC{static get type(){return"ModelNode"}constructor(e){super(e)}update(e){this.object3d=e.object,super.update(e)}}const nI=BA(tI,tI.DIRECTION),rI=BA(tI,tI.WORLD_MATRIX),iI=BA(tI,tI.POSITION),sI=BA(tI,tI.SCALE),aI=BA(tI,tI.VIEW_POSITION),oI=_w(new Kt).onObjectUpdate(({object:e},t)=>t.value.getNormalMatrix(e.matrixWorld)),lI=_w(new tr).onObjectUpdate(({object:e},t)=>t.value.copy(e.matrixWorld).invert()),uI=VA(e=>e.renderer.nodes.modelViewMatrix||cI).once()().toVar("modelViewMatrix"),cI=WC.mul(rI),dI=VA(e=>(e.context.isHighPrecisionModelViewMatrix=!0,_w("mat4").onObjectUpdate(({object:e,camera:t})=>e.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld)))).once()().toVar("highpModelViewMatrix"),hI=VA(e=>{const t=e.context.isHighPrecisionModelViewMatrix;return _w("mat3").onObjectUpdate(({object:e,camera:n})=>(!0!==t&&e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix)))}).once()().toVar("highpModelNormalViewMatrix"),fI=PC("position","vec3"),pI=fI.varying("positionLocal"),mI=fI.varying("positionPrevious"),gI=rI.mul(pI).xyz.varying("v_positionWorld").context({needsPositionReassign:!0}),vI=pI.transformDirection(rI).varying("v_positionWorldDirection").normalize().toVar("positionWorldDirection").context({needsPositionReassign:!0}),yI=VA(e=>e.context.setupPositionView(),"vec3").once()().varying("v_positionView").context({needsPositionReassign:!0}),bI=yI.negate().varying("v_positionViewDirection").normalize().toVar("positionViewDirection");class _I extends YE{static get type(){return"FrontFacingNode"}constructor(){super("bool"),this.isFrontFacingNode=!0}generate(e){const{renderer:t,material:n}=e;return t.coordinateSystem===kt&&1===n.side?"false":e.getFrontFacing()}}const xI=BA(_I),SI=jA(xI).mul(2).sub(1),TI=PC("normal","vec3"),EI=VA(e=>!1===e.geometry.hasAttribute("normal")?ew(0,1,0):TI,"vec3").once()().toVar("normalLocal"),AI=yI.dFdx().cross(yI.dFdy()).normalize().toVar("normalFlat"),wI=VA(e=>{let t;return t=!0===e.material.flatShading?AI:XR(PI(EI),"v_normalView").normalize(),t},"vec3").once()().toVar("normalView"),MI=XR(wI.transformDirection(WC),"v_normalWorld").normalize().toVar("normalWorld"),RI=VA(e=>e.context.setupNormal(),"vec3").once()().mul(SI).toVar("transformedNormalView"),CI=RI.transformDirection(WC).toVar("transformedNormalWorld"),II=VA(e=>e.context.setupClearcoatNormal(),"vec3").once()().mul(SI).toVar("transformedClearcoatNormalView"),LI=VA(([e,t=rI])=>{const n=uw(t),r=e.div(ew(n[0].dot(n[0]),n[1].dot(n[1]),n[2].dot(n[2])));return n.mul(r).xyz}),PI=VA(([e],t)=>{const n=t.renderer.nodes.modelNormalViewMatrix;if(null!==n)return n.transformDirection(e);const r=oI.mul(e);return WC.transformDirection(r)}),NI=_w(0).onReference(({material:e})=>e).onRenderUpdate(({material:e})=>e.refractionRatio),DI=bI.negate().reflect(RI),kI=bI.negate().refract(RI,NI),OI=DI.transformDirection(WC).toVar("reflectVector"),FI=kI.transformDirection(WC).toVar("reflectVector");class UI extends UC{static get type(){return"CubeTextureNode"}constructor(e,t=null,n=null,r=null){super(e,t,n,r),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){const e=this.value;return e.mapping===q?OI:e.mapping===X?FI:ew(0,0,0)}setUpdateMatrix(){}setupUV(e,t){const n=this.value;return e.renderer.coordinateSystem!==Ot&&n.isRenderTargetTexture?t:ew(t.x.negate(),t.yz)}generateUV(e,t){return t.build(e,"vec3")}}const BI=UA(UI);class VI extends bw{static get type(){return"BufferNode"}constructor(e,t,n=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=n}getElementType(e){return this.getNodeType(e)}getInputType(){return"buffer"}}const zI=(e,t,n)=>kA(new VI(e,t,n));class GI extends KE{static get type(){return"UniformArrayElementNode"}constructor(e,t){super(e,t),this.isArrayBufferElementNode=!0}generate(e){const t=super.generate(e),n=this.getNodeType(),r=this.node.getPaddedType();return e.format(t,r,n)}}class HI extends VI{static get type(){return"UniformArrayNode"}constructor(e,t=null){super(null),this.array=e,this.elementType=null===t?OE(e[0]):t,this.paddedType=this.getPaddedType(),this.updateType=GE.RENDER,this.isArrayBufferNode=!0}getNodeType(){return this.paddedType}getElementType(){return this.elementType}getPaddedType(){const e=this.elementType;let t="vec4";return"mat2"===e?t="mat2":!0===/mat/.test(e)?t="mat4":"i"===e.charAt(0)?t="ivec4":"u"===e.charAt(0)&&(t="uvec4"),t}update(){const{array:e,value:t}=this,n=this.elementType;if("float"===n||"int"===n||"uint"===n)for(let n=0;n<e.length;n++){t[4*n]=e[n]}else if("color"===n)for(let n=0;n<e.length;n++){const r=4*n,i=e[n];t[r]=i.r,t[r+1]=i.g,t[r+2]=i.b||0}else if("mat2"===n)for(let n=0;n<e.length;n++){const r=4*n,i=e[n];t[r]=i.elements[0],t[r+1]=i.elements[1],t[r+2]=i.elements[2],t[r+3]=i.elements[3]}else if("mat3"===n)for(let n=0;n<e.length;n++){const r=16*n,i=e[n];t[r]=i.elements[0],t[r+1]=i.elements[1],t[r+2]=i.elements[2],t[r+4]=i.elements[3],t[r+5]=i.elements[4],t[r+6]=i.elements[5],t[r+8]=i.elements[6],t[r+9]=i.elements[7],t[r+10]=i.elements[8],t[r+15]=1}else if("mat4"===n)for(let n=0;n<e.length;n++){const r=16*n,i=e[n];for(let e=0;e<i.elements.length;e++)t[r+e]=i.elements[e]}else for(let n=0;n<e.length;n++){const r=4*n,i=e[n];t[r]=i.x,t[r+1]=i.y,t[r+2]=i.z||0,t[r+3]=i.w||0}}setup(e){const t=this.array.length,n=this.elementType;let r=Float32Array;const i=this.paddedType,s=e.getTypeLength(i);return"i"===n.charAt(0)&&(r=Int32Array),"u"===n.charAt(0)&&(r=Uint32Array),this.value=new r(t*s),this.bufferCount=t,this.bufferType=i,super.setup(e)}element(e){return kA(new GI(this,kA(e)))}}const $I=(e,t)=>kA(new HI(e,t));class WI extends KE{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),n=this.referenceNode.getNodeType(),r=this.getNodeType();return e.format(t,n,r)}}class jI extends YE{static get type(){return"ReferenceNode"}constructor(e,t,n=null,r=null){super(),this.property=e,this.uniformType=t,this.object=n,this.count=r,this.properties=e.split("."),this.reference=n,this.node=null,this.group=null,this.name=null,this.updateType=GE.OBJECT}element(e){return kA(new WI(this,kA(e)))}setGroup(e){return this.group=e,this}label(e){return this.name=e,this}setNodeType(e){let t=null;t=null!==this.count?zI(null,e,this.count):Array.isArray(this.getValueFromReference())?$I(null,e):"texture"===e?BC(null):"cubeTexture"===e?BI(null):_w(null,e),null!==this.group&&t.setGroup(this.group),null!==this.name&&t.label(this.name),this.node=t.getSelf()}getNodeType(e){return null===this.node&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let n=e[t[0]];for(let e=1;e<t.length;e++)n=n[t[e]];return n}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}const qI=(e,t,n)=>kA(new jI(e,t,n)),XI=(e,t,n,r)=>kA(new jI(e,t,r,n));class YI extends jI{static get type(){return"MaterialReferenceNode"}constructor(e,t,n=null){super(e,t,n),this.material=n,this.isMaterialReferenceNode=!0}updateReference(e){return this.reference=null!==this.material?this.material:e.material,this.reference}}const KI=(e,t,n=null)=>kA(new YI(e,t,n)),QI=VA(e=>(!1===e.geometry.hasAttribute("tangent")&&e.geometry.computeTangents(),PC("tangent","vec4")))(),ZI=QI.xyz.toVar("tangentLocal"),JI=uI.mul(iw(ZI,0)).xyz.varying("v_tangentView").normalize().toVar("tangentView"),eL=JI.transformDirection(WC).varying("v_tangentWorld").normalize().toVar("tangentWorld"),tL=JI.toVar("transformedTangentView"),nL=tL.transformDirection(WC).normalize().toVar("transformedTangentWorld"),rL=e=>e.mul(QI.w).xyz,iL=XR(rL(TI.cross(QI)),"v_bitangentGeometry").normalize().toVar("bitangentGeometry"),sL=XR(rL(EI.cross(ZI)),"v_bitangentLocal").normalize().toVar("bitangentLocal"),aL=XR(rL(wI.cross(JI)),"v_bitangentView").normalize().toVar("bitangentView"),oL=XR(rL(MI.cross(eL)),"v_bitangentWorld").normalize().toVar("bitangentWorld"),lL=rL(RI.cross(tL)).normalize().toVar("transformedBitangentView"),uL=lL.transformDirection(WC).normalize().toVar("transformedBitangentWorld"),cL=uw(JI,aL,wI),dL=bI.mul(cL),hL=(()=>{let e=Uw.cross(bI);return e=e.cross(Uw).normalize(),e=wR(e,RI,Ow.mul(ww.oneMinus()).oneMinus().pow2().pow2()).normalize(),e})(),fL=VA(e=>{const{eye_pos:t,surf_norm:n,mapN:r,uv:i}=e,s=t.dFdx(),a=t.dFdy(),o=i.dFdx(),l=i.dFdy(),u=n,c=a.cross(u),d=u.cross(s),h=c.mul(o.x).add(d.mul(l.x)),f=c.mul(o.y).add(d.mul(l.y)),p=h.dot(h).max(f.dot(f)),m=SI.mul(p.inverseSqrt());return rM(h.mul(r.x,m),f.mul(r.y,m),u.mul(r.z)).normalize()});class pL extends ZE{static get type(){return"NormalMapNode"}constructor(e,t=null){super("vec3"),this.node=e,this.scaleNode=t,this.normalMapType=0}setup(e){const{normalMapType:t,scaleNode:n}=this;let r=this.node.mul(2).sub(1);null!==n&&(r=ew(r.xy.mul(n),r.z));let i=null;if(1===t)i=PI(r);else if(0===t){i=!0===e.hasGeometryAttribute("tangent")?cL.mul(r).normalize():fL({eye_pos:yI,surf_norm:wI,mapN:r,uv:NC()})}return i}}const mL=UA(pL),gL=VA(({textureNode:e,bumpScale:t})=>{const n=t=>e.cache().context({getUV:e=>t(e.uvNode||NC()),forceUVContext:!0}),r=jA(n(e=>e));return KA(jA(n(e=>e.add(e.dFdx()))).sub(r),jA(n(e=>e.add(e.dFdy()))).sub(r)).mul(t)}),vL=VA(e=>{const{surf_pos:t,surf_norm:n,dHdxy:r}=e,i=t.dFdx().normalize(),s=n,a=t.dFdy().normalize().cross(s),o=s.cross(i),l=i.dot(a).mul(SI),u=l.sign().mul(r.x.mul(a).add(r.y.mul(o)));return l.abs().mul(n).sub(u).normalize()});class yL extends ZE{static get type(){return"BumpMapNode"}constructor(e,t=null){super("vec3"),this.textureNode=e,this.scaleNode=t}setup(){const e=null!==this.scaleNode?this.scaleNode:1,t=gL({textureNode:this.textureNode,bumpScale:e});return vL({surf_pos:yI,surf_norm:wI,dHdxy:t})}}const bL=UA(yL),_L=new Map;class xL extends YE{static get type(){return"MaterialNode"}constructor(e){super(),this.scope=e}getCache(e,t){let n=_L.get(e);return void 0===n&&(n=KI(e,t),_L.set(e,n)),n}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache("map"===e?"map":e+"Map","texture")}setup(e){const t=e.context.material,n=this.scope;let r=null;if(n===xL.COLOR){const e=void 0!==t.color?this.getColor(n):ew();r=t.map&&!0===t.map.isTexture?e.mul(this.getTexture("map")):e}else if(n===xL.OPACITY){const e=this.getFloat(n);r=t.alphaMap&&!0===t.alphaMap.isTexture?e.mul(this.getTexture("alpha")):e}else if(n===xL.SPECULAR_STRENGTH)r=t.specularMap&&!0===t.specularMap.isTexture?this.getTexture("specular").r:jA(1);else if(n===xL.SPECULAR_INTENSITY){const e=this.getFloat(n);r=t.specularIntensityMap&&!0===t.specularIntensityMap.isTexture?e.mul(this.getTexture(n).a):e}else if(n===xL.SPECULAR_COLOR){const e=this.getColor(n);r=t.specularColorMap&&!0===t.specularColorMap.isTexture?e.mul(this.getTexture(n).rgb):e}else if(n===xL.ROUGHNESS){const e=this.getFloat(n);r=t.roughnessMap&&!0===t.roughnessMap.isTexture?e.mul(this.getTexture(n).g):e}else if(n===xL.METALNESS){const e=this.getFloat(n);r=t.metalnessMap&&!0===t.metalnessMap.isTexture?e.mul(this.getTexture(n).b):e}else if(n===xL.EMISSIVE){const e=this.getFloat("emissiveIntensity"),i=this.getColor(n).mul(e);r=t.emissiveMap&&!0===t.emissiveMap.isTexture?i.mul(this.getTexture(n)):i}else if(n===xL.NORMAL)t.normalMap?(r=mL(this.getTexture("normal"),this.getCache("normalScale","vec2")),r.normalMapType=t.normalMapType):r=t.bumpMap?bL(this.getTexture("bump").r,this.getFloat("bumpScale")):wI;else if(n===xL.CLEARCOAT){const e=this.getFloat(n);r=t.clearcoatMap&&!0===t.clearcoatMap.isTexture?e.mul(this.getTexture(n).r):e}else if(n===xL.CLEARCOAT_ROUGHNESS){const e=this.getFloat(n);r=t.clearcoatRoughnessMap&&!0===t.clearcoatRoughnessMap.isTexture?e.mul(this.getTexture(n).r):e}else if(n===xL.CLEARCOAT_NORMAL)r=t.clearcoatNormalMap?mL(this.getTexture(n),this.getCache(n+"Scale","vec2")):wI;else if(n===xL.SHEEN){const e=this.getColor("sheenColor").mul(this.getFloat("sheen"));r=t.sheenColorMap&&!0===t.sheenColorMap.isTexture?e.mul(this.getTexture("sheenColor").rgb):e}else if(n===xL.SHEEN_ROUGHNESS){const e=this.getFloat(n);r=t.sheenRoughnessMap&&!0===t.sheenRoughnessMap.isTexture?e.mul(this.getTexture(n).a):e,r=r.clamp(.07,1)}else if(n===xL.ANISOTROPY)if(t.anisotropyMap&&!0===t.anisotropyMap.isTexture){const e=this.getTexture(n);r=lw(sP.x,sP.y,sP.y.negate(),sP.x).mul(e.rg.mul(2).sub(KA(1)).normalize().mul(e.b))}else r=sP;else if(n===xL.IRIDESCENCE_THICKNESS){const e=qI("1","float",t.iridescenceThicknessRange);if(t.iridescenceThicknessMap){const i=qI("0","float",t.iridescenceThicknessRange);r=e.sub(i).mul(this.getTexture(n).g).add(i)}else r=e}else if(n===xL.TRANSMISSION){const e=this.getFloat(n);r=t.transmissionMap?e.mul(this.getTexture(n).r):e}else if(n===xL.THICKNESS){const e=this.getFloat(n);r=t.thicknessMap?e.mul(this.getTexture(n).g):e}else if(n===xL.IOR)r=this.getFloat(n);else if(n===xL.LIGHT_MAP)r=this.getTexture(n).rgb.mul(this.getFloat("lightMapIntensity"));else if(n===xL.AO)r=this.getTexture(n).r.sub(1).mul(this.getFloat("aoMapIntensity")).add(1);else{const t=this.getNodeType(e);r=this.getCache(n,t)}return r}}xL.ALPHA_TEST="alphaTest",xL.COLOR="color",xL.OPACITY="opacity",xL.SHININESS="shininess",xL.SPECULAR="specular",xL.SPECULAR_STRENGTH="specularStrength",xL.SPECULAR_INTENSITY="specularIntensity",xL.SPECULAR_COLOR="specularColor",xL.REFLECTIVITY="reflectivity",xL.ROUGHNESS="roughness",xL.METALNESS="metalness",xL.NORMAL="normal",xL.CLEARCOAT="clearcoat",xL.CLEARCOAT_ROUGHNESS="clearcoatRoughness",xL.CLEARCOAT_NORMAL="clearcoatNormal",xL.EMISSIVE="emissive",xL.ROTATION="rotation",xL.SHEEN="sheen",xL.SHEEN_ROUGHNESS="sheenRoughness",xL.ANISOTROPY="anisotropy",xL.IRIDESCENCE="iridescence",xL.IRIDESCENCE_IOR="iridescenceIOR",xL.IRIDESCENCE_THICKNESS="iridescenceThickness",xL.IOR="ior",xL.TRANSMISSION="transmission",xL.THICKNESS="thickness",xL.ATTENUATION_DISTANCE="attenuationDistance",xL.ATTENUATION_COLOR="attenuationColor",xL.LINE_SCALE="scale",xL.LINE_DASH_SIZE="dashSize",xL.LINE_GAP_SIZE="gapSize",xL.LINE_WIDTH="linewidth",xL.LINE_DASH_OFFSET="dashOffset",xL.POINT_WIDTH="pointWidth",xL.DISPERSION="dispersion",xL.LIGHT_MAP="light",xL.AO="ao";const SL=BA(xL,xL.ALPHA_TEST),TL=BA(xL,xL.COLOR),EL=BA(xL,xL.SHININESS),AL=BA(xL,xL.EMISSIVE),wL=BA(xL,xL.OPACITY),ML=BA(xL,xL.SPECULAR),RL=BA(xL,xL.SPECULAR_INTENSITY),CL=BA(xL,xL.SPECULAR_COLOR),IL=BA(xL,xL.SPECULAR_STRENGTH),LL=BA(xL,xL.REFLECTIVITY),PL=BA(xL,xL.ROUGHNESS),NL=BA(xL,xL.METALNESS),DL=BA(xL,xL.NORMAL).context({getUV:null}),kL=BA(xL,xL.CLEARCOAT),OL=BA(xL,xL.CLEARCOAT_ROUGHNESS),FL=BA(xL,xL.CLEARCOAT_NORMAL).context({getUV:null}),UL=BA(xL,xL.ROTATION),BL=BA(xL,xL.SHEEN),VL=BA(xL,xL.SHEEN_ROUGHNESS),zL=BA(xL,xL.ANISOTROPY),GL=BA(xL,xL.IRIDESCENCE),HL=BA(xL,xL.IRIDESCENCE_IOR),$L=BA(xL,xL.IRIDESCENCE_THICKNESS),WL=BA(xL,xL.TRANSMISSION),jL=BA(xL,xL.THICKNESS),qL=BA(xL,xL.IOR),XL=BA(xL,xL.ATTENUATION_DISTANCE),YL=BA(xL,xL.ATTENUATION_COLOR),KL=BA(xL,xL.LINE_SCALE),QL=BA(xL,xL.LINE_DASH_SIZE),ZL=BA(xL,xL.LINE_GAP_SIZE),JL=BA(xL,xL.LINE_WIDTH),eP=BA(xL,xL.LINE_DASH_OFFSET),tP=BA(xL,xL.POINT_WIDTH),nP=BA(xL,xL.DISPERSION),rP=BA(xL,xL.LIGHT_MAP),iP=BA(xL,xL.AO),sP=_w(new Yt).onReference(function(e){return e.material}).onRenderUpdate(function({material:e}){this.value.set(e.anisotropy*Math.cos(e.anisotropyRotation),e.anisotropy*Math.sin(e.anisotropyRotation))}),aP=VA(e=>e.context.setupModelViewProjection(),"vec4").once()().varying("v_modelViewProjection");class oP extends YE{static get type(){return"IndexNode"}constructor(e){super("uint"),this.scope=e,this.isIndexNode=!0}generate(e){const t=this.getNodeType(e),n=this.scope;let r,i;if(n===oP.VERTEX)r=e.getVertexIndex();else if(n===oP.INSTANCE)r=e.getInstanceIndex();else if(n===oP.DRAW)r=e.getDrawIndex();else if(n===oP.INVOCATION_LOCAL)r=e.getInvocationLocalIndex();else if(n===oP.INVOCATION_SUBGROUP)r=e.getInvocationSubgroupIndex();else{if(n!==oP.SUBGROUP)throw new Error("THREE.IndexNode: Unknown scope: "+n);r=e.getSubgroupIndex()}if("vertex"===e.shaderStage||"compute"===e.shaderStage)i=r;else{i=XR(this).build(e,t)}return i}}oP.VERTEX="vertex",oP.INSTANCE="instance",oP.SUBGROUP="subgroup",oP.INVOCATION_LOCAL="invocationLocal",oP.INVOCATION_SUBGROUP="invocationSubgroup",oP.DRAW="draw";const lP=BA(oP,oP.VERTEX),uP=BA(oP,oP.INSTANCE),cP=BA(oP,oP.SUBGROUP),dP=BA(oP,oP.INVOCATION_SUBGROUP),hP=BA(oP,oP.INVOCATION_LOCAL),fP=BA(oP,oP.DRAW);class pP extends YE{static get type(){return"InstanceNode"}constructor(e,t,n){super("void"),this.count=e,this.instanceMatrix=t,this.instanceColor=n,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=GE.FRAME,this.buffer=null,this.bufferColor=null}setup(e){const{count:t,instanceMatrix:n,instanceColor:r}=this;let{instanceMatrixNode:i,instanceColorNode:s}=this;if(null===i){if(t<=1e3)i=zI(n.array,"mat4",Math.max(t,1)).element(uP);else{const e=new Ju(n.array,16,1);this.buffer=e;const t=n.usage===Nt?gC:mC,r=[t(e,"vec4",16,0),t(e,"vec4",16,4),t(e,"vec4",16,8),t(e,"vec4",16,12)];i=cw(...r)}this.instanceMatrixNode=i}if(r&&null===s){const e=new Ps(r.array,3),t=r.usage===Nt?gC:mC;this.bufferColor=e,s=ew(t(e,"vec3",3,0)),this.instanceColorNode=s}const a=i.mul(pI).xyz;if(pI.assign(a),e.hasGeometryAttribute("normal")){const e=LI(EI,i);EI.assign(e)}null!==this.instanceColorNode&&Tw("vec3","vInstanceColor").assign(this.instanceColorNode)}update(){this.instanceMatrix.usage!==Nt&&null!==this.buffer&&this.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMatrix.version),this.instanceColor&&this.instanceColor.usage!==Nt&&null!==this.bufferColor&&this.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceColor.version)}}const mP=UA(pP);class gP extends pP{static get type(){return"InstancedMeshNode"}constructor(e){const{count:t,instanceMatrix:n,instanceColor:r}=e;super(t,n,r),this.instancedMesh=e}}const vP=UA(gP);class yP extends YE{static get type(){return"BatchNode"}constructor(e){super("void"),this.batchMesh=e,this.batchingIdNode=null}setup(e){null===this.batchingIdNode&&(null===e.getDrawIndex()?this.batchingIdNode=uP:this.batchingIdNode=fP);const t=VA(([e])=>{const t=kC(VC(this.batchMesh._indirectTexture),0),n=qA(e).modInt(qA(t)),r=qA(e).div(qA(t));return VC(this.batchMesh._indirectTexture,QA(n,r)).x}).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]}),n=t(qA(this.batchingIdNode)),r=this.batchMesh._matricesTexture,i=kC(VC(r),0),s=jA(n).mul(4).toInt().toVar(),a=s.modInt(i),o=s.div(qA(i)),l=cw(VC(r,QA(a,o)),VC(r,QA(a.add(1),o)),VC(r,QA(a.add(2),o)),VC(r,QA(a.add(3),o))),u=this.batchMesh._colorsTexture;if(null!==u){const e=VA(([e])=>{const t=kC(VC(u),0).x,n=e,r=n.modInt(t),i=n.div(t);return VC(u,QA(r,i)).rgb}).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]}),t=e(n);Tw("vec3","vBatchColor").assign(t)}const c=uw(l);pI.assign(l.mul(pI));const d=EI.div(ew(c[0].dot(c[0]),c[1].dot(c[1]),c[2].dot(c[2]))),h=c.mul(d).xyz;EI.assign(h),e.hasGeometryAttribute("tangent")&&ZI.mulAssign(c)}}const bP=UA(yP),_P=new WeakMap;class xP extends YE{static get type(){return"SkinningNode"}constructor(e,t=!1){let n,r,i;super("void"),this.skinnedMesh=e,this.useReference=t,this.updateType=GE.OBJECT,this.skinIndexNode=PC("skinIndex","uvec4"),this.skinWeightNode=PC("skinWeight","vec4"),t?(n=qI("bindMatrix","mat4"),r=qI("bindMatrixInverse","mat4"),i=XI("skeleton.boneMatrices","mat4",e.skeleton.bones.length)):(n=_w(e.bindMatrix,"mat4"),r=_w(e.bindMatrixInverse,"mat4"),i=zI(e.skeleton.boneMatrices,"mat4",e.skeleton.bones.length)),this.bindMatrixNode=n,this.bindMatrixInverseNode=r,this.boneMatricesNode=i,this.previousBoneMatricesNode=null}getSkinnedPosition(e=this.boneMatricesNode,t=pI){const{skinIndexNode:n,skinWeightNode:r,bindMatrixNode:i,bindMatrixInverseNode:s}=this,a=e.element(n.x),o=e.element(n.y),l=e.element(n.z),u=e.element(n.w),c=i.mul(t),d=rM(a.mul(r.x).mul(c),o.mul(r.y).mul(c),l.mul(r.z).mul(c),u.mul(r.w).mul(c));return s.mul(d).xyz}getSkinnedNormal(e=this.boneMatricesNode,t=EI){const{skinIndexNode:n,skinWeightNode:r,bindMatrixNode:i,bindMatrixInverseNode:s}=this,a=e.element(n.x),o=e.element(n.y),l=e.element(n.z),u=e.element(n.w);let c=rM(r.x.mul(a),r.y.mul(o),r.z.mul(l),r.w.mul(u));return c=s.mul(c).mul(i),c.transformDirection(t).xyz}getPreviousSkinnedPosition(e){const t=e.object;return null===this.previousBoneMatricesNode&&(t.skeleton.previousBoneMatrices=new Float32Array(t.skeleton.boneMatrices),this.previousBoneMatricesNode=XI("skeleton.previousBoneMatrices","mat4",t.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,mI)}needsPreviousBoneMatrices(e){const t=e.renderer.getMRT();return t&&t.has("velocity")||!0===UE(e.object).useVelocity}setup(e){this.needsPreviousBoneMatrices(e)&&mI.assign(this.getPreviousSkinnedPosition(e));const t=this.getSkinnedPosition();if(pI.assign(t),e.hasGeometryAttribute("normal")){const t=this.getSkinnedNormal();EI.assign(t),e.hasGeometryAttribute("tangent")&&ZI.assign(t)}}generate(e,t){if("void"!==t)return pI.build(e,t)}update(e){const t=(this.useReference?e.object:this.skinnedMesh).skeleton;_P.get(t)!==e.frameId&&(_P.set(t,e.frameId),null!==this.previousBoneMatricesNode&&t.previousBoneMatrices.set(t.boneMatrices),t.update())}}const SP=e=>kA(new xP(e,!0));class TP extends YE{static get type(){return"LoopNode"}constructor(e=[]){super(),this.params=e}getVarName(e){return String.fromCharCode("i".charCodeAt(0)+e)}getProperties(e){const t=e.getNodeProperties(this);if(void 0!==t.stackNode)return t;const n={};for(let e=0,t=this.params.length-1;e<t;e++){const t=this.params[e],r=!0!==t.isNode&&t.name||this.getVarName(e),i=!0!==t.isNode&&t.type||"int";n[r]=MC(r,i)}const r=e.addStack();return t.returnsNode=this.params[this.params.length-1](n,r,e),t.stackNode=r,e.removeStack(),t}getNodeType(e){const{returnsNode:t}=this.getProperties(e);return t?t.getNodeType(e):"void"}setup(e){this.getProperties(e)}generate(e){const t=this.getProperties(e),n=this.params,r=t.stackNode;for(let t=0,r=n.length-1;t<r;t++){const r=n[t];let i=null,s=null,a=null,o=null,l=null,u=null;r.isNode?(o="int",a=this.getVarName(t),i="0",s=r.build(e,o),l="<"):(o=r.type||"int",a=r.name||this.getVarName(t),i=r.start,s=r.end,l=r.condition,u=r.update,"number"==typeof i?i=e.generateConst(o,i):i&&i.isNode&&(i=i.build(e,o)),"number"==typeof s?s=e.generateConst(o,s):s&&s.isNode&&(s=s.build(e,o)),void 0!==i&&void 0===s?(i+=" - 1",s="0",l=">="):void 0!==s&&void 0===i&&(i="0",l="<"),void 0===l&&(l=Number(i)>Number(s)?">=":"<"));const c={start:i,end:s,condition:l},d=c.start,h=c.end;let f="",p="",m="";u||(u="int"===o||"uint"===o?l.includes("<")?"++":"--":l.includes("<")?"+= 1.":"-= 1."),f+=e.getVar(o,a)+" = "+d,p+=a+" "+l+" "+h,m+=a+" "+u;const g=`for ( ${f}; ${p}; ${m} )`;e.addFlowCode((0===t?"\n":"")+e.tab+g+" {\n\n").addFlowTab()}const i=r.build(e,"void"),s=t.returnsNode?t.returnsNode.build(e):"";e.removeFlowTab().addFlowCode("\n"+e.tab+i);for(let t=0,n=this.params.length-1;t<n;t++)e.addFlowCode((0===t?"":e.tab)+"}\n\n").removeFlowTab();return e.addFlowTab(),s}}const EP=(...e)=>kA(new TP(FA(e,"int"))).append(),AP=()=>MC("break").append(),wP=new WeakMap,MP=new bn,RP=VA(({bufferMap:e,influence:t,stride:n,width:r,depth:i,offset:s})=>{const a=qA(lP).mul(n).add(s),o=a.div(r),l=a.sub(o.mul(r));return VC(e,QA(l,o)).depth(i).mul(t)});class CP extends YE{static get type(){return"MorphNode"}constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=_w(1),this.updateType=GE.OBJECT}setup(e){const{geometry:t}=e,n=void 0!==t.morphAttributes.position,r=t.hasAttribute("normal")&&void 0!==t.morphAttributes.normal,i=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,s=void 0!==i?i.length:0,{texture:a,stride:o,size:l}=function(e){const t=void 0!==e.morphAttributes.position,n=void 0!==e.morphAttributes.normal,r=void 0!==e.morphAttributes.color,i=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,s=void 0!==i?i.length:0;let a=wP.get(e);if(void 0===a||a.count!==s){void 0!==a&&a.texture.dispose();const o=e.morphAttributes.position||[],l=e.morphAttributes.normal||[],u=e.morphAttributes.color||[];let c=0;!0===t&&(c=1),!0===n&&(c=2),!0===r&&(c=3);let d=e.attributes.position.count*c,h=1;const f=4096;d>f&&(h=Math.ceil(d/f),d=f);const p=new Float32Array(d*h*4*s),m=new Sn(p,d,h,s);m.type=fe,m.needsUpdate=!0;const g=4*c;for(let y=0;y<s;y++){const b=o[y],_=l[y],x=u[y],S=d*h*4*y;for(let T=0;T<b.count;T++){const E=T*g;!0===t&&(MP.fromBufferAttribute(b,T),p[S+E+0]=MP.x,p[S+E+1]=MP.y,p[S+E+2]=MP.z,p[S+E+3]=0),!0===n&&(MP.fromBufferAttribute(_,T),p[S+E+4]=MP.x,p[S+E+5]=MP.y,p[S+E+6]=MP.z,p[S+E+7]=0),!0===r&&(MP.fromBufferAttribute(x,T),p[S+E+8]=MP.x,p[S+E+9]=MP.y,p[S+E+10]=MP.z,p[S+E+11]=4===x.itemSize?MP.w:1)}}function v(){m.dispose(),wP.delete(e),e.removeEventListener("dispose",v)}a={count:s,texture:m,stride:c,size:new Yt(d,h)},wP.set(e,a),e.addEventListener("dispose",v)}return a}(t);!0===n&&pI.mulAssign(this.morphBaseInfluence),!0===r&&EI.mulAssign(this.morphBaseInfluence);const u=qA(l.width);EP(s,({i:e})=>{const t=jA(0).toVar();this.mesh.count>1&&null!==this.mesh.morphTexture&&void 0!==this.mesh.morphTexture?t.assign(VC(this.mesh.morphTexture,QA(qA(e).add(1),qA(uP))).r):t.assign(qI("morphTargetInfluences","float").element(e).toVar()),!0===n&&pI.addAssign(RP({bufferMap:a,influence:t,stride:o,width:u,depth:e,offset:qA(0)})),!0===r&&EI.addAssign(RP({bufferMap:a,influence:t,stride:o,width:u,depth:e,offset:qA(1)}))})}update(){const e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce((e,t)=>e+t,0)}}const IP=UA(CP);class LP extends YE{static get type(){return"LightingNode"}constructor(){super("vec3"),this.isLightingNode=!0}}class PP extends LP{static get type(){return"AONode"}constructor(e=null){super(),this.aoNode=e}setup(e){e.context.ambientOcclusion.mulAssign(this.aoNode)}}class NP extends zR{static get type(){return"LightingContextNode"}constructor(e,t=null,n=null,r=null){super(e),this.lightingModel=t,this.backdropNode=n,this.backdropAlphaNode=r,this._value=null}getContext(){const{backdropNode:e,backdropAlphaNode:t}=this,n={directDiffuse:ew().toVar("directDiffuse"),directSpecular:ew().toVar("directSpecular"),indirectDiffuse:ew().toVar("indirectDiffuse"),indirectSpecular:ew().toVar("indirectSpecular")};return{radiance:ew().toVar("radiance"),irradiance:ew().toVar("irradiance"),iblIrradiance:ew().toVar("iblIrradiance"),ambientOcclusion:jA(1).toVar("ambientOcclusion"),reflectedLight:n,backdrop:e,backdropAlpha:t}}setup(e){return this.value=this._value||(this._value=this.getContext()),this.value.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}}const DP=UA(NP);class kP extends LP{static get type(){return"IrradianceNode"}constructor(e){super(),this.node=e}setup(e){e.context.irradiance.addAssign(this.node)}}let OP,FP;class UP extends YE{static get type(){return"ScreenNode"}constructor(e){super(),this.scope=e,this.isViewportNode=!0}getNodeType(){return this.scope===UP.VIEWPORT?"vec4":"vec2"}getUpdateType(){let e=GE.NONE;return this.scope!==UP.SIZE&&this.scope!==UP.VIEWPORT||(e=GE.RENDER),this.updateType=e,e}update({renderer:e}){const t=e.getRenderTarget();this.scope===UP.VIEWPORT?null!==t?FP.copy(t.viewport):(e.getViewport(FP),FP.multiplyScalar(e.getPixelRatio())):null!==t?(OP.width=t.width,OP.height=t.height):e.getDrawingBufferSize(OP)}setup(){const e=this.scope;let t=null;return t=e===UP.SIZE?_w(OP||(OP=new Yt)):e===UP.VIEWPORT?_w(FP||(FP=new bn)):KA(zP.div(VP)),t}generate(e){if(this.scope===UP.COORDINATE){let t=e.getFragCoord();if(e.isFlipY()){const n=e.getNodeProperties(VP).outputNode.build(e);t=`${e.getType("vec2")}( ${t}.x, ${n}.y - ${t}.y )`}return t}return super.generate(e)}}UP.COORDINATE="coordinate",UP.VIEWPORT="viewport",UP.SIZE="size",UP.UV="uv";const BP=BA(UP,UP.UV),VP=BA(UP,UP.SIZE),zP=BA(UP,UP.COORDINATE),GP=BA(UP,UP.VIEWPORT),HP=GP.zw,$P=zP.sub(GP.xy),WP=$P.div(HP),jP=VA(()=>VP,"vec2").once()(),qP=VA(()=>BP,"vec2").once()(),XP=VA(()=>BP.flipY(),"vec2").once()(),YP=new Yt;class KP extends UC{static get type(){return"ViewportTextureNode"}constructor(e=BP,t=null,n=null){null===n&&((n=new ka).minFilter=ae),super(n,e,t),this.generateMipmaps=!1,this.isOutputTextureNode=!0,this.updateBeforeType=GE.FRAME}updateBefore(e){const t=e.renderer;t.getDrawingBufferSize(YP);const n=this.value;n.image.width===YP.width&&n.image.height===YP.height||(n.image.width=YP.width,n.image.height=YP.height,n.needsUpdate=!0);const r=n.generateMipmaps;n.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(n),n.generateMipmaps=r}clone(){const e=new this.constructor(this.uvNode,this.levelNode,this.value);return e.generateMipmaps=this.generateMipmaps,e}}const QP=UA(KP),ZP=UA(KP,null,null,{generateMipmaps:!0});let JP=null;class eN extends KP{static get type(){return"ViewportDepthTextureNode"}constructor(e=BP,t=null){null===JP&&(JP=new Fa),super(e,t,JP)}}const tN=UA(eN);class nN extends YE{static get type(){return"ViewportDepthNode"}constructor(e,t=null){super("float"),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}generate(e){const{scope:t}=this;return t===nN.DEPTH_BASE?e.getFragDepth():super.generate(e)}setup({camera:e}){const{scope:t}=this,n=this.valueNode;let r=null;if(t===nN.DEPTH_BASE)null!==n&&(r=oN().assign(n));else if(t===nN.DEPTH)r=e.isPerspectiveCamera?iN(yI.z,zC,GC):rN(yI.z,zC,GC);else if(t===nN.LINEAR_DEPTH)if(null!==n)if(e.isPerspectiveCamera){const e=sN(n,zC,GC);r=rN(e,zC,GC)}else r=n;else r=rN(yI.z,zC,GC);return r}}nN.DEPTH_BASE="depthBase",nN.DEPTH="depth",nN.LINEAR_DEPTH="linearDepth";const rN=(e,t,n)=>e.add(t).div(t.sub(n)),iN=(e,t,n)=>t.add(e).mul(n).div(n.sub(t).mul(e)),sN=(e,t,n)=>t.mul(n).div(n.sub(t).mul(e).sub(n)),aN=(e,t,n)=>{t=t.max(1e-6).toVar();const r=FM(e.negate().div(t)),i=FM(n.div(t));return r.div(i)},oN=UA(nN,nN.DEPTH_BASE),lN=BA(nN,nN.DEPTH),uN=UA(nN,nN.LINEAR_DEPTH),cN=uN(tN());lN.assign=e=>oN(e);const dN=UA(class extends YE{constructor(e){super("float"),this.name=e,this.isBuiltinNode=!0}generate(){return this.name}});class hN extends YE{static get type(){return"ClippingNode"}constructor(e=hN.DEFAULT){super(),this.scope=e}setup(e){super.setup(e);const t=e.clippingContext,{intersectionPlanes:n,unionPlanes:r}=t;return this.hardwareClipping=e.material.hardwareClipping,this.scope===hN.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(n,r):this.scope===hN.HARDWARE?this.setupHardwareClipping(r,e):this.setupDefault(n,r)}setupAlphaToCoverage(e,t){return VA(()=>{const n=jA().toVar("distanceToPlane"),r=jA().toVar("distanceToGradient"),i=jA(1).toVar("clipOpacity"),s=t.length;if(!1===this.hardwareClipping&&s>0){const e=$I(t);EP(s,({i:t})=>{const s=e.element(t);n.assign(yI.dot(s.xyz).negate().add(s.w)),r.assign(n.fwidth().div(2)),i.mulAssign(IR(r.negate(),r,n))})}const a=e.length;if(a>0){const t=$I(e),s=jA(1).toVar("intersectionClipOpacity");EP(a,({i:e})=>{const i=t.element(e);n.assign(yI.dot(i.xyz).negate().add(i.w)),r.assign(n.fwidth().div(2)),s.mulAssign(IR(r.negate(),r,n).oneMinus())}),i.mulAssign(s.oneMinus())}Ew.a.mulAssign(i),Ew.a.equal(0).discard()})()}setupDefault(e,t){return VA(()=>{const n=t.length;if(!1===this.hardwareClipping&&n>0){const e=$I(t);EP(n,({i:t})=>{const n=e.element(t);yI.dot(n.xyz).greaterThan(n.w).discard()})}const r=e.length;if(r>0){const t=$I(e),n=YA(!0).toVar("clipped");EP(r,({i:e})=>{const r=t.element(e);n.assign(yI.dot(r.xyz).greaterThan(r.w).and(n))}),n.discard()}})()}setupHardwareClipping(e,t){const n=e.length;return t.enableHardwareClipping(n),VA(()=>{const r=$I(e),i=dN(t.getClipDistance());EP(n,({i:e})=>{const t=r.element(e),n=yI.dot(t.xyz).sub(t.w).negate();i.element(e).assign(n)})})()}}hN.ALPHA_TO_COVERAGE="alphaToCoverage",hN.DEFAULT="default",hN.HARDWARE="hardware";const fN=VA(([e])=>HM(sM(1e4,$M(sM(17,e.x).add(sM(.1,e.y)))).mul(rM(.1,KM($M(sM(13,e.y).add(e.x))))))),pN=VA(([e])=>fN(KA(fN(e.xy),e.z))),mN=VA(([e])=>{const t=dR(ZM(tR(e.xyz)),ZM(nR(e.xyz))),n=jA(1).div(jA(.05).mul(t)).toVar("pixScale"),r=KA(kM(VM(FM(n))),kM(zM(FM(n)))),i=KA(pN(VM(r.x.mul(e.xyz))),pN(VM(r.y.mul(e.xyz)))),s=HM(FM(n)),a=rM(sM(s.oneMinus(),i.x),sM(s,i.y)),o=cR(s,s.oneMinus()),l=ew(a.mul(a).div(sM(2,o).mul(iM(1,o))),a.sub(sM(.5,o)).div(iM(1,o)),iM(1,iM(1,a).mul(iM(1,a)).div(sM(2,o).mul(iM(1,o))))),u=a.lessThan(o.oneMinus()).select(a.lessThan(o).select(l.x,l.y),l.z);return MR(u,1e-6,1)}).setLayout({name:"getAlphaHashThreshold",type:"float",inputs:[{name:"position",type:"vec3"}]});class gN extends Kr{static get type(){return"NodeMaterial"}get type(){return this.constructor.type}set type(e){}constructor(){super(),this.isNodeMaterial=!0,this.fog=!0,this.lights=!1,this.hardwareClipping=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.positionNode=null,this.geometryNode=null,this.depthNode=null,this.shadowPositionNode=null,this.receivedShadowNode=null,this.castShadowNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null}customProgramCacheKey(){return this.type+CE(this)}build(e){this.setup(e)}setupObserver(e){return new EE(e)}setup(e){e.context.setupNormal=()=>this.setupNormal(e),e.context.setupPositionView=()=>this.setupPositionView(e),e.context.setupModelViewProjection=()=>this.setupModelViewProjection(e);const t=e.renderer,n=t.getRenderTarget();e.addStack();const r=this.vertexNode||this.setupVertex(e);let i;e.stack.outputNode=r,this.setupHardwareClipping(e),null!==this.geometryNode&&(e.stack.outputNode=e.stack.outputNode.bypass(this.geometryNode)),e.addFlow("vertex",e.removeStack()),e.addStack();const s=this.setupClipping(e);if(!0!==this.depthWrite&&!0!==this.depthTest||(null!==n?!0===n.depthBuffer&&this.setupDepth(e):!0===t.depth&&this.setupDepth(e)),null===this.fragmentNode){this.setupDiffuseColor(e),this.setupVariants(e);const r=this.setupLighting(e);null!==s&&e.stack.add(s);const a=iw(r,Ew.a).max(0);if(i=this.setupOutput(e,a),Gw.assign(i),null!==this.outputNode&&(i=this.outputNode),null!==n){const e=t.getMRT(),n=this.mrtNode;null!==e?(i=e,null!==n&&(i=e.merge(n))):null!==n&&(i=n)}}else{let t=this.fragmentNode;!0!==t.isOutputStructNode&&(t=iw(t)),i=this.setupOutput(e,t)}e.stack.outputNode=i,e.addFlow("fragment",e.removeStack()),e.monitor=this.setupObserver(e)}setupClipping(e){if(null===e.clippingContext)return null;const{unionPlanes:t,intersectionPlanes:n}=e.clippingContext;let r=null;if(t.length>0||n.length>0){const t=e.renderer.samples;this.alphaToCoverage&&t>1?r=kA(new hN(hN.ALPHA_TO_COVERAGE)):e.stack.add(kA(new hN))}return r}setupHardwareClipping(e){if(this.hardwareClipping=!1,null===e.clippingContext)return;const t=e.clippingContext.unionPlanes.length;t>0&&t<=8&&e.isAvailable("clipDistance")&&(e.stack.add(kA(new hN(hN.HARDWARE))),this.hardwareClipping=!0)}setupDepth(e){const{renderer:t,camera:n}=e;let r=this.depthNode;if(null===r){const e=t.getMRT();e&&e.has("depth")?r=e.get("depth"):!0===t.logarithmicDepthBuffer&&(r=n.isPerspectiveCamera?aN(yI.z,zC,GC):rN(yI.z,zC,GC))}null!==r&&lN.assign(r).append()}setupPositionView(){return uI.mul(pI).xyz}setupModelViewProjection(){return HC.mul(yI)}setupVertex(e){return e.addStack(),this.setupPosition(e),e.context.vertex=e.removeStack(),aP}setupPosition(e){const{object:t,geometry:n}=e;if((n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color)&&IP(t).append(),!0===t.isSkinnedMesh&&SP(t).append(),this.displacementMap){const e=KI("displacementMap","texture"),t=KI("displacementScale","float"),n=KI("displacementBias","float");pI.addAssign(EI.normalize().mul(e.x.mul(t).add(n)))}return t.isBatchedMesh&&bP(t).append(),t.isInstancedMesh&&t.instanceMatrix&&!0===t.instanceMatrix.isInstancedBufferAttribute&&vP(t).append(),null!==this.positionNode&&pI.assign(this.positionNode.context({isPositionNodeInput:!0})),pI}setupDiffuseColor({object:e,geometry:t}){let n=this.colorNode?iw(this.colorNode):TL;if(!0===this.vertexColors&&t.hasAttribute("color")&&(n=iw(n.xyz.mul(PC("color","vec3")),n.a)),e.instanceColor){n=Tw("vec3","vInstanceColor").mul(n)}if(e.isBatchedMesh&&e._colorsTexture){n=Tw("vec3","vBatchColor").mul(n)}Ew.assign(n);const r=this.opacityNode?jA(this.opacityNode):wL;if(Ew.a.assign(Ew.a.mul(r)),null!==this.alphaTestNode||this.alphaTest>0){const e=null!==this.alphaTestNode?jA(this.alphaTestNode):SL;Ew.a.lessThanEqual(e).discard()}!0===this.alphaHash&&Ew.a.lessThan(mN(pI)).discard(),!1===this.transparent&&1===this.blending&&!1===this.alphaToCoverage&&Ew.a.assign(1)}setupVariants(){}setupOutgoingLight(){return!0===this.lights?ew(0):Ew.rgb}setupNormal(){return this.normalNode?ew(this.normalNode):DL}setupEnvironment(){let e=null;return this.envNode?e=this.envNode:this.envMap&&(e=this.envMap.isCubeTexture?KI("envMap","cubeTexture"):KI("envMap","texture")),e}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new kP(rP)),t}setupLights(e){const t=[],n=this.setupEnvironment(e);n&&n.isLightingNode&&t.push(n);const r=this.setupLightMap(e);if(r&&r.isLightingNode&&t.push(r),null!==this.aoNode||e.material.aoMap){const e=null!==this.aoNode?this.aoNode:iP;t.push(new PP(e))}let i=this.lightsNode||e.lightsNode;return t.length>0&&(i=e.renderer.lighting.createNode([...i.getLights(),...t])),i}setupLightingModel(){}setupLighting(e){const{material:t}=e,{backdropNode:n,backdropAlphaNode:r,emissiveNode:i}=this,s=!0===this.lights||null!==this.lightsNode?this.setupLights(e):null;let a=this.setupOutgoingLight(e);if(s&&s.getScope().hasLights){const t=this.setupLightingModel(e);a=DP(s,t,n,r)}else null!==n&&(a=ew(null!==r?wR(a,n,r):n));return(i&&!0===i.isNode||t.emissive&&!0===t.emissive.isColor)&&(Aw.assign(ew(i||AL)),a=a.add(Aw)),a}setupOutput(e,t){if(!0===this.fog){const n=e.fogNode;n&&(Gw.assign(t),t=iw(n))}return t}setDefaultValues(e){for(const t in e){const n=e[t];void 0===this[t]&&(this[t]=n,n&&n.clone&&(this[t]=n.clone()))}const t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(const e in t)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,e)&&void 0!==t[e].get&&Object.defineProperty(this.constructor.prototype,e,t[e])}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{},nodes:{}});const n=Kr.prototype.toJSON.call(this,e),r=IE(this);n.inputNodes={};for(const{property:t,childNode:i}of r)n.inputNodes[t]=i.toJSON(e).uuid;function i(e){const t=[];for(const n in e){const r=e[n];delete r.metadata,t.push(r)}return t}if(t){const t=i(e.textures),r=i(e.images),s=i(e.nodes);t.length>0&&(n.textures=t),r.length>0&&(n.images=r),s.length>0&&(n.nodes=s)}return n}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.positionNode=e.positionNode,this.geometryNode=e.geometryNode,this.depthNode=e.depthNode,this.shadowPositionNode=e.shadowPositionNode,this.receivedShadowNode=e.receivedShadowNode,this.castShadowNode=e.castShadowNode,this.outputNode=e.outputNode,this.mrtNode=e.mrtNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}}const vN=new ha;class yN extends gN{static get type(){return"LineBasicNodeMaterial"}constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.setDefaultValues(vN),this.setValues(e)}}const bN=new _l;class _N extends gN{static get type(){return"LineDashedNodeMaterial"}constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.setDefaultValues(bN),this.dashOffset=0,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setupVariants(){const e=this.offsetNode?jA(this.offsetNode):eP,t=this.dashScaleNode?jA(this.dashScaleNode):KL,n=this.dashSizeNode?jA(this.dashSizeNode):QL,r=this.gapSizeNode?jA(this.gapSizeNode):ZL;Hw.assign(n),$w.assign(r);const i=XR(PC("lineDistance").mul(t));(e?i.add(e):i).mod(Hw.add($w)).greaterThan(Hw).discard()}}let xN=null;class SN extends KP{static get type(){return"ViewportSharedTextureNode"}constructor(e=BP,t=null){null===xN&&(xN=new ka),super(e,t,xN)}updateReference(){return this}}const TN=UA(SN),EN=e=>kA(e).mul(.5).add(.5),AN=new ml;class wN extends gN{static get type(){return"MeshNormalNodeMaterial"}constructor(e){super(),this.isMeshNormalNodeMaterial=!0,this.setDefaultValues(AN),this.setValues(e)}setupDiffuseColor(){const e=this.opacityNode?jA(this.opacityNode):wL;Ew.assign(iw(EN(RI),e))}}class MN extends ZE{static get type(){return"EquirectUVNode"}constructor(e=vI){super("vec2"),this.dirNode=e}setup(){const e=this.dirNode,t=e.z.atan(e.x).mul(1/(2*Math.PI)).add(.5),n=e.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5);return KA(t,n)}}const RN=UA(MN);class CN extends Wi{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){const n=t.minFilter,r=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i=new Li(5,5,5),s=RN(vI),a=new gN;a.colorNode=BC(t,s,0),a.side=1,a.blending=0;const o=new Ci(i,a),l=new Xi;l.add(o),t.minFilter===ae&&(t.minFilter=ie);const u=new Hi(1,10,this),c=e.getMRT();return e.setMRT(null),u.update(e,l),e.setMRT(c),t.minFilter=n,t.currentGenerateMipmaps=r,o.geometry.dispose(),o.material.dispose(),this}}const IN=new WeakMap;class LN extends ZE{static get type(){return"CubeMapNode"}constructor(e){super("vec3"),this.envNode=e,this._cubeTexture=null,this._cubeTextureNode=BI();const t=new $i;t.isRenderTargetTexture=!0,this._defaultTexture=t,this.updateBeforeType=GE.RENDER}updateBefore(e){const{renderer:t,material:n}=e,r=this.envNode;if(r.isTextureNode||r.isMaterialReferenceNode){const e=r.isTextureNode?r.value:n[r.property];if(e&&e.isTexture){const n=e.mapping;if(n===Y||n===K){if(IN.has(e)){const t=IN.get(e);NN(t,e.mapping),this._cubeTexture=t}else{const n=e.image;if(function(e){return null!=e&&e.height>0}(n)){const r=new CN(n.height);r.fromEquirectangularTexture(t,e),NN(r.texture,e.mapping),this._cubeTexture=r.texture,IN.set(e,r.texture),e.addEventListener("dispose",PN)}else this._cubeTexture=this._defaultTexture}this._cubeTextureNode.value=this._cubeTexture}else this._cubeTextureNode=this.envNode}}}setup(e){return this.updateBefore(e),this._cubeTextureNode}}function PN(e){const t=e.target;t.removeEventListener("dispose",PN);const n=IN.get(t);void 0!==n&&(IN.delete(t),n.dispose())}function NN(e,t){t===Y?e.mapping=q:t===K&&(e.mapping=X)}const DN=UA(LN);class kN extends LP{static get type(){return"BasicEnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){e.context.environment=DN(this.envNode)}}class ON extends LP{static get type(){return"BasicLightMapNode"}constructor(e=null){super(),this.lightMapNode=e}setup(e){const t=jA(1/Math.PI);e.context.irradianceLightMap=this.lightMapNode.mul(t)}}class FN{start(){}finish(){}direct(){}directRectArea(){}indirect(){}ambientOcclusion(){}}class UN extends FN{constructor(){super()}indirect(e,t,n){const r=e.ambientOcclusion,i=e.reflectedLight,s=n.context.irradianceLightMap;i.indirectDiffuse.assign(iw(0)),s?i.indirectDiffuse.addAssign(s):i.indirectDiffuse.addAssign(iw(1,1,1,0)),i.indirectDiffuse.mulAssign(r),i.indirectDiffuse.mulAssign(Ew.rgb)}finish(e,t,n){const r=n.material,i=e.outgoingLight,s=n.context.environment;if(s)switch(r.combine){case 0:i.rgb.assign(wR(i.rgb,i.rgb.mul(s.rgb),IL.mul(LL)));break;case 1:i.rgb.assign(wR(i.rgb,s.rgb,IL.mul(LL)));break;case 2:i.rgb.addAssign(s.rgb.mul(IL.mul(LL)))}}}const BN=new Qr;class VN extends gN{static get type(){return"MeshBasicNodeMaterial"}constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!0,this.setDefaultValues(BN),this.setValues(e)}setupNormal(){return wI}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new kN(t):null}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new ON(rP)),t}setupOutgoingLight(){return Ew.rgb}setupLightingModel(){return new UN}}const zN=VA(({f0:e,f90:t,dotVH:n})=>{const r=n.mul(-5.55473).sub(6.98316).mul(n).exp2();return e.mul(r.oneMinus()).add(t.mul(r))}),GN=VA(e=>e.diffuseColor.mul(1/Math.PI)),HN=VA(({dotNH:e})=>zw.mul(jA(.5)).add(1).mul(jA(1/Math.PI)).mul(e.pow(zw))),$N=VA(({lightDirection:e})=>{const t=e.add(bI).normalize(),n=RI.dot(t).clamp(),r=bI.dot(t).clamp(),i=zN({f0:Bw,f90:1,dotVH:r}),s=jA(.25),a=HN({dotNH:n});return i.mul(s).mul(a)});class WN extends UN{constructor(e=!0){super(),this.specular=e}direct({lightDirection:e,lightColor:t,reflectedLight:n}){const r=RI.dot(e).clamp().mul(t);n.directDiffuse.addAssign(r.mul(GN({diffuseColor:Ew.rgb}))),!0===this.specular&&n.directSpecular.addAssign(r.mul($N({lightDirection:e})).mul(IL))}indirect({ambientOcclusion:e,irradiance:t,reflectedLight:n}){n.indirectDiffuse.addAssign(t.mul(GN({diffuseColor:Ew}))),n.indirectDiffuse.mulAssign(e)}}const jN=new gl;class qN extends gN{static get type(){return"MeshLambertNodeMaterial"}constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(jN),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new kN(t):null}setupLightingModel(){return new WN(!1)}}const XN=new fl;class YN extends gN{static get type(){return"MeshPhongNodeMaterial"}constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(XN),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new kN(t):null}setupLightingModel(){return new WN}setupVariants(){const e=(this.shininessNode?jA(this.shininessNode):EL).max(1e-4);zw.assign(e);const t=this.specularNode||ML;Bw.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}}const KN=VA(e=>{if(!1===e.geometry.hasAttribute("normal"))return jA(0);const t=wI.dFdx().abs().max(wI.dFdy().abs());return t.x.max(t.y).max(t.z)}),QN=VA(e=>{const{roughness:t}=e,n=KN();let r=t.max(.0525);return r=r.add(n),r=r.min(1),r}),ZN=VA(({alpha:e,dotNL:t,dotNV:n})=>{const r=e.pow2(),i=t.mul(r.add(r.oneMinus().mul(n.pow2())).sqrt()),s=n.mul(r.add(r.oneMinus().mul(t.pow2())).sqrt());return aM(.5,i.add(s).max(wM))}).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),JN=VA(({alphaT:e,alphaB:t,dotTV:n,dotBV:r,dotTL:i,dotBL:s,dotNV:a,dotNL:o})=>{const l=o.mul(ew(e.mul(n),t.mul(r),a).length()),u=a.mul(ew(e.mul(i),t.mul(s),o).length());return aM(.5,l.add(u)).saturate()}).setLayout({name:"V_GGX_SmithCorrelated_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotTV",type:"float",qualifier:"in"},{name:"dotBV",type:"float",qualifier:"in"},{name:"dotTL",type:"float",qualifier:"in"},{name:"dotBL",type:"float",qualifier:"in"},{name:"dotNV",type:"float",qualifier:"in"},{name:"dotNL",type:"float",qualifier:"in"}]}),eD=VA(({alpha:e,dotNH:t})=>{const n=e.pow2(),r=t.pow2().mul(n.oneMinus()).oneMinus();return n.div(r.pow2()).mul(1/Math.PI)}).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),tD=jA(1/Math.PI),nD=VA(({alphaT:e,alphaB:t,dotNH:n,dotTH:r,dotBH:i})=>{const s=e.mul(t),a=ew(t.mul(r),e.mul(i),s.mul(n)),o=a.dot(a),l=s.div(o);return tD.mul(s.mul(l.pow2()))}).setLayout({name:"D_GGX_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotNH",type:"float",qualifier:"in"},{name:"dotTH",type:"float",qualifier:"in"},{name:"dotBH",type:"float",qualifier:"in"}]}),rD=VA(e=>{const{lightDirection:t,f0:n,f90:r,roughness:i,f:s,USE_IRIDESCENCE:a,USE_ANISOTROPY:o}=e,l=e.normalView||RI,u=i.pow2(),c=t.add(bI).normalize(),d=l.dot(t).clamp(),h=l.dot(bI).clamp(),f=l.dot(c).clamp(),p=bI.dot(c).clamp();let m,g,v=zN({f0:n,f90:r,dotVH:p});if(PA(a)&&(v=Pw.mix(v,s)),PA(o)){const e=Fw.dot(t),n=Fw.dot(bI),r=Fw.dot(c),i=Uw.dot(t),s=Uw.dot(bI),a=Uw.dot(c);m=JN({alphaT:kw,alphaB:u,dotTV:n,dotBV:s,dotTL:e,dotBL:i,dotNV:h,dotNL:d}),g=nD({alphaT:kw,alphaB:u,dotNH:f,dotTH:r,dotBH:a})}else m=ZN({alpha:u,dotNL:d,dotNV:h}),g=eD({alpha:u,dotNH:f});return v.mul(m).mul(g)}),iD=VA(({roughness:e,dotNV:t})=>{const n=iw(-1,-.0275,-.572,.022),r=iw(1,.0425,1.04,-.04),i=e.mul(n).add(r),s=i.x.mul(i.x).min(t.mul(-9.28).exp2()).mul(i.x).add(i.y);return KA(-1.04,1.04).mul(s).add(i.zw)}).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),sD=VA(e=>{const{dotNV:t,specularColor:n,specularF90:r,roughness:i}=e,s=iD({dotNV:t,roughness:i});return n.mul(s.x).add(r.mul(s.y))}),aD=VA(({f:e,f90:t,dotVH:n})=>{const r=n.oneMinus().saturate(),i=r.mul(r),s=r.mul(i,i).clamp(0,.9999);return e.sub(ew(t).mul(s)).div(s.oneMinus())}).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),oD=VA(({roughness:e,dotNH:t})=>{const n=e.pow2(),r=jA(1).div(n),i=t.pow2().oneMinus().max(.0078125);return jA(2).add(r).mul(i.pow(r.mul(.5))).div(2*Math.PI)}).setLayout({name:"D_Charlie",type:"float",inputs:[{name:"roughness",type:"float"},{name:"dotNH",type:"float"}]}),lD=VA(({dotNV:e,dotNL:t})=>jA(1).div(jA(4).mul(t.add(e).sub(t.mul(e))))).setLayout({name:"V_Neubelt",type:"float",inputs:[{name:"dotNV",type:"float"},{name:"dotNL",type:"float"}]}),uD=VA(({lightDirection:e})=>{const t=e.add(bI).normalize(),n=RI.dot(e).clamp(),r=RI.dot(bI).clamp(),i=RI.dot(t).clamp(),s=oD({roughness:Lw,dotNH:i}),a=lD({dotNV:r,dotNL:n});return Iw.mul(s).mul(a)}),cD=VA(({N:e,V:t,roughness:n})=>{const r=e.dot(t).saturate(),i=KA(n,r.oneMinus().sqrt());return i.assign(i.mul(.984375).add(.0078125)),i}).setLayout({name:"LTC_Uv",type:"vec2",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"roughness",type:"float"}]}),dD=VA(({f:e})=>{const t=e.length();return dR(t.mul(t).add(e.z).div(t.add(1)),0)}).setLayout({name:"LTC_ClippedSphereFormFactor",type:"float",inputs:[{name:"f",type:"vec3"}]}),hD=VA(({v1:e,v2:t})=>{const n=e.dot(t),r=n.abs().toVar(),i=r.mul(.0145206).add(.4965155).mul(r).add(.8543985).toVar(),s=r.add(4.1616724).mul(r).add(3.417594).toVar(),a=i.div(s),o=n.greaterThan(0).select(a,dR(n.mul(n).oneMinus(),1e-7).inverseSqrt().mul(.5).sub(a));return e.cross(t).mul(o)}).setLayout({name:"LTC_EdgeVectorFormFactor",type:"vec3",inputs:[{name:"v1",type:"vec3"},{name:"v2",type:"vec3"}]}),fD=VA(({N:e,V:t,P:n,mInv:r,p0:i,p1:s,p2:a,p3:o})=>{const l=s.sub(i).toVar(),u=o.sub(i).toVar(),c=l.cross(u),d=ew().toVar();return HA(c.dot(n.sub(i)).greaterThanEqual(0),()=>{const l=t.sub(e.mul(t.dot(e))).normalize(),u=e.cross(l).negate(),c=r.mul(uw(l,u,e).transpose()).toVar(),h=c.mul(i.sub(n)).normalize().toVar(),f=c.mul(s.sub(n)).normalize().toVar(),p=c.mul(a.sub(n)).normalize().toVar(),m=c.mul(o.sub(n)).normalize().toVar(),g=ew(0).toVar();g.addAssign(hD({v1:h,v2:f})),g.addAssign(hD({v1:f,v2:p})),g.addAssign(hD({v1:p,v2:m})),g.addAssign(hD({v1:m,v2:h})),d.assign(ew(dD({f:g})))}),d}).setLayout({name:"LTC_Evaluate",type:"vec3",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"P",type:"vec3"},{name:"mInv",type:"mat3"},{name:"p0",type:"vec3"},{name:"p1",type:"vec3"},{name:"p2",type:"vec3"},{name:"p3",type:"vec3"}]}),pD=1/6,mD=e=>sM(pD,sM(e,sM(e,e.negate().add(3)).sub(3)).add(1)),gD=e=>sM(pD,sM(e,sM(e,sM(3,e).sub(6))).add(4)),vD=e=>sM(pD,sM(e,sM(e,sM(-3,e).add(3)).add(3)).add(1)),yD=e=>sM(pD,bR(e,3)),bD=e=>mD(e).add(gD(e)),_D=e=>vD(e).add(yD(e)),xD=e=>rM(-1,gD(e).div(mD(e).add(gD(e)))),SD=e=>rM(1,yD(e).div(vD(e).add(yD(e)))),TD=(e,t,n)=>{const r=e.uvNode,i=sM(r,t.zw).add(.5),s=VM(i),a=HM(i),o=bD(a.x),l=_D(a.x),u=xD(a.x),c=SD(a.x),d=xD(a.y),h=SD(a.y),f=KA(s.x.add(u),s.y.add(d)).sub(.5).mul(t.xy),p=KA(s.x.add(c),s.y.add(d)).sub(.5).mul(t.xy),m=KA(s.x.add(u),s.y.add(h)).sub(.5).mul(t.xy),g=KA(s.x.add(c),s.y.add(h)).sub(.5).mul(t.xy),v=bD(a.y).mul(rM(o.mul(e.sample(f).level(n)),l.mul(e.sample(p).level(n)))),y=_D(a.y).mul(rM(o.mul(e.sample(m).level(n)),l.mul(e.sample(g).level(n))));return v.add(y)},ED=VA(([e,t=jA(3)])=>{const n=KA(e.size(qA(t))),r=KA(e.size(qA(t.add(1)))),i=aM(1,n),s=aM(1,r),a=TD(e,iw(i,n),VM(t)),o=TD(e,iw(s,r),zM(t));return HM(t).mix(a,o)}),AD=VA(([e,t,n,r,i])=>{const s=ew(CR(t.negate(),GM(e),aM(1,r))),a=ew(ZM(i[0].xyz),ZM(i[1].xyz),ZM(i[2].xyz));return GM(s).mul(n.mul(a))}).setLayout({name:"getVolumeTransmissionRay",type:"vec3",inputs:[{name:"n",type:"vec3"},{name:"v",type:"vec3"},{name:"thickness",type:"float"},{name:"ior",type:"float"},{name:"modelMatrix",type:"mat4"}]}),wD=VA(([e,t])=>e.mul(MR(t.mul(2).sub(2),0,1))).setLayout({name:"applyIorToRoughness",type:"float",inputs:[{name:"roughness",type:"float"},{name:"ior",type:"float"}]}),MD=ZP(),RD=ZP(),CD=VA(([e,t,n],{material:r})=>{const i=(1===r.side?MD:RD).sample(e),s=FM(VP.x).mul(wD(t,n));return ED(i,s)}),ID=VA(([e,t,n])=>(HA(n.notEqual(0),()=>{const r=OM(t).negate().div(n);return DM(r.negate().mul(e))}),ew(1))).setLayout({name:"volumeAttenuation",type:"vec3",inputs:[{name:"transmissionDistance",type:"float"},{name:"attenuationColor",type:"vec3"},{name:"attenuationDistance",type:"float"}]}),LD=VA(([e,t,n,r,i,s,a,o,l,u,c,d,h,f,p])=>{let m,g;if(p){m=iw().toVar(),g=ew().toVar();const i=c.sub(1).mul(p.mul(.025)),s=ew(c.sub(i),c,c.add(i));EP({start:0,end:3},({i:i})=>{const c=s.element(i),p=AD(e,t,d,c,o),v=a.add(p),y=u.mul(l.mul(iw(v,1))),b=KA(y.xy.div(y.w)).toVar();b.addAssign(1),b.divAssign(2),b.assign(KA(b.x,b.y.oneMinus()));const _=CD(b,n,c);m.element(i).assign(_.element(i)),m.a.addAssign(_.a),g.element(i).assign(r.element(i).mul(ID(ZM(p),h,f).element(i)))}),m.a.divAssign(3)}else{const i=AD(e,t,d,c,o),s=a.add(i),p=u.mul(l.mul(iw(s,1))),v=KA(p.xy.div(p.w)).toVar();v.addAssign(1),v.divAssign(2),v.assign(KA(v.x,v.y.oneMinus())),m=CD(v,n,c),g=r.mul(ID(ZM(i),h,f))}const v=g.rgb.mul(m.rgb),y=e.dot(t).clamp(),b=ew(sD({dotNV:y,specularColor:i,specularF90:s,roughness:n})),_=g.r.add(g.g,g.b).div(3);return iw(b.oneMinus().mul(v),m.a.oneMinus().mul(_).oneMinus())}),PD=uw(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),ND=(e,t)=>e.sub(t).div(e.add(t)).pow2(),DD=VA(({outsideIOR:e,eta2:t,cosTheta1:n,thinFilmThickness:r,baseF0:i})=>{const s=wR(e,t,IR(0,.03,r)),a=e.div(s).pow2().mul(n.pow2().oneMinus()).oneMinus();HA(a.lessThan(0),()=>ew(1));const o=a.sqrt(),l=ND(s,e),u=zN({f0:l,f90:1,dotVH:n}),c=u.oneMinus(),d=s.lessThan(e).select(Math.PI,0),h=jA(Math.PI).sub(d),f=(e=>{const t=e.sqrt();return ew(1).add(t).div(ew(1).sub(t))})(i.clamp(0,.9999)),p=ND(f,s.toVec3()),m=zN({f0:p,f90:1,dotVH:o}),g=ew(f.x.lessThan(s).select(Math.PI,0),f.y.lessThan(s).select(Math.PI,0),f.z.lessThan(s).select(Math.PI,0)),v=s.mul(r,o,2),y=ew(h).add(g),b=u.mul(m).clamp(1e-5,.9999),_=b.sqrt(),x=c.pow2().mul(m).div(ew(1).sub(b)),S=u.add(x).toVar(),T=x.sub(c).toVar();return EP({start:1,end:2,condition:"<=",name:"m"},({m:e})=>{T.mulAssign(_);const t=((e,t)=>{const n=e.mul(2*Math.PI*1e-9),r=ew(54856e-17,44201e-17,52481e-17),i=ew(1681e3,1795300,2208400),s=ew(43278e5,93046e5,66121e5),a=jA(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(n.mul(2239900).add(t.x).cos()).mul(n.pow2().mul(-45282e5).exp());let o=r.mul(s.mul(2*Math.PI).sqrt()).mul(i.mul(n).add(t).cos()).mul(n.pow2().negate().mul(s).exp());return o=ew(o.x.add(a),o.y,o.z).div(1.0685e-7),PD.mul(o)})(jA(e).mul(v),jA(e).mul(y)).mul(2);S.addAssign(T.mul(t))}),S.max(ew(0))}).setLayout({name:"evalIridescence",type:"vec3",inputs:[{name:"outsideIOR",type:"float"},{name:"eta2",type:"float"},{name:"cosTheta1",type:"float"},{name:"thinFilmThickness",type:"float"},{name:"baseF0",type:"vec3"}]}),kD=VA(({normal:e,viewDir:t,roughness:n})=>{const r=e.dot(t).saturate(),i=n.pow2(),s=BR(n.lessThan(.25),jA(-339.2).mul(i).add(jA(161.4).mul(n)).sub(25.9),jA(-8.48).mul(i).add(jA(14.3).mul(n)).sub(9.95)),a=BR(n.lessThan(.25),jA(44).mul(i).sub(jA(23.7).mul(n)).add(3.26),jA(1.97).mul(i).sub(jA(3.27).mul(n)).add(.72));return BR(n.lessThan(.25),0,jA(.1).mul(n).sub(.025)).add(s.mul(r).add(a).exp()).mul(1/Math.PI).saturate()}),OD=ew(.04),FD=jA(1);class UD extends FN{constructor(e=!1,t=!1,n=!1,r=!1,i=!1,s=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=n,this.anisotropy=r,this.transmission=i,this.dispersion=s,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}start(e){if(!0===this.clearcoat&&(this.clearcoatRadiance=ew().toVar("clearcoatRadiance"),this.clearcoatSpecularDirect=ew().toVar("clearcoatSpecularDirect"),this.clearcoatSpecularIndirect=ew().toVar("clearcoatSpecularIndirect")),!0===this.sheen&&(this.sheenSpecularDirect=ew().toVar("sheenSpecularDirect"),this.sheenSpecularIndirect=ew().toVar("sheenSpecularIndirect")),!0===this.iridescence){const e=RI.dot(bI).clamp();this.iridescenceFresnel=DD({outsideIOR:jA(1),eta2:Nw,cosTheta1:e,thinFilmThickness:Dw,baseF0:Bw}),this.iridescenceF0=aD({f:this.iridescenceFresnel,f90:1,dotVH:e})}if(!0===this.transmission){const t=gI,n=XC.sub(gI).normalize(),r=CI;e.backdrop=LD(r,n,ww,Ew,Bw,Vw,t,rI,WC,HC,jw,Xw,Kw,Yw,this.dispersion?Qw:null),e.backdropAlpha=qw,Ew.a.mulAssign(wR(1,e.backdrop.a,qw))}}computeMultiscattering(e,t,n){const r=RI.dot(bI).clamp(),i=iD({roughness:ww,dotNV:r}),s=(this.iridescenceF0?Pw.mix(Bw,this.iridescenceF0):Bw).mul(i.x).add(n.mul(i.y)),a=i.x.add(i.y).oneMinus(),o=Bw.add(Bw.oneMinus().mul(.047619)),l=s.mul(o).div(a.mul(o).oneMinus());e.addAssign(s),t.addAssign(l.mul(a))}direct({lightDirection:e,lightColor:t,reflectedLight:n}){const r=RI.dot(e).clamp().mul(t);if(!0===this.sheen&&this.sheenSpecularDirect.addAssign(r.mul(uD({lightDirection:e}))),!0===this.clearcoat){const n=II.dot(e).clamp().mul(t);this.clearcoatSpecularDirect.addAssign(n.mul(rD({lightDirection:e,f0:OD,f90:FD,roughness:Cw,normalView:II})))}n.directDiffuse.addAssign(r.mul(GN({diffuseColor:Ew.rgb}))),n.directSpecular.addAssign(r.mul(rD({lightDirection:e,f0:Bw,f90:1,roughness:ww,iridescence:this.iridescence,f:this.iridescenceFresnel,USE_IRIDESCENCE:this.iridescence,USE_ANISOTROPY:this.anisotropy})))}directRectArea({lightColor:e,lightPosition:t,halfWidth:n,halfHeight:r,reflectedLight:i,ltc_1:s,ltc_2:a}){const o=t.add(n).sub(r),l=t.sub(n).sub(r),u=t.sub(n).add(r),c=t.add(n).add(r),d=RI,h=bI,f=yI.toVar(),p=cD({N:d,V:h,roughness:ww}),m=s.sample(p).toVar(),g=a.sample(p).toVar(),v=uw(ew(m.x,0,m.y),ew(0,1,0),ew(m.z,0,m.w)).toVar(),y=Bw.mul(g.x).add(Bw.oneMinus().mul(g.y)).toVar();i.directSpecular.addAssign(e.mul(y).mul(fD({N:d,V:h,P:f,mInv:v,p0:o,p1:l,p2:u,p3:c}))),i.directDiffuse.addAssign(e.mul(Ew).mul(fD({N:d,V:h,P:f,mInv:uw(1,0,0,0,1,0,0,0,1),p0:o,p1:l,p2:u,p3:c})))}indirect(e,t,n){this.indirectDiffuse(e,t,n),this.indirectSpecular(e,t,n),this.ambientOcclusion(e,t,n)}indirectDiffuse({irradiance:e,reflectedLight:t}){t.indirectDiffuse.addAssign(e.mul(GN({diffuseColor:Ew})))}indirectSpecular({radiance:e,iblIrradiance:t,reflectedLight:n}){if(!0===this.sheen&&this.sheenSpecularIndirect.addAssign(t.mul(Iw,kD({normal:RI,viewDir:bI,roughness:Lw}))),!0===this.clearcoat){const e=II.dot(bI).clamp(),t=sD({dotNV:e,specularColor:OD,specularF90:FD,roughness:Cw});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(t))}const r=ew().toVar("singleScattering"),i=ew().toVar("multiScattering"),s=t.mul(1/Math.PI);this.computeMultiscattering(r,i,Vw);const a=r.add(i),o=Ew.mul(a.r.max(a.g).max(a.b).oneMinus());n.indirectSpecular.addAssign(e.mul(r)),n.indirectSpecular.addAssign(i.mul(s)),n.indirectDiffuse.addAssign(o.mul(s))}ambientOcclusion({ambientOcclusion:e,reflectedLight:t}){const n=RI.dot(bI).clamp().add(e),r=ww.mul(-16).oneMinus().negate().exp2(),i=e.sub(n.pow(r).oneMinus()).clamp();!0===this.clearcoat&&this.clearcoatSpecularIndirect.mulAssign(e),!0===this.sheen&&this.sheenSpecularIndirect.mulAssign(e),t.indirectDiffuse.mulAssign(e),t.indirectSpecular.mulAssign(i)}finish(e){const{outgoingLight:t}=e;if(!0===this.clearcoat){const e=II.dot(bI).clamp(),n=zN({dotVH:e,f0:OD,f90:FD}),r=t.mul(Rw.mul(n).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(Rw));t.assign(r)}if(!0===this.sheen){const e=Iw.r.max(Iw.g).max(Iw.b).mul(.157).oneMinus(),n=t.mul(e).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(n)}}}const BD=jA(1),VD=jA(-2),zD=jA(.8),GD=jA(-1),HD=jA(.4),$D=jA(2),WD=jA(.305),jD=jA(3),qD=jA(.21),XD=jA(4),YD=jA(4),KD=jA(16),QD=VA(([e])=>{const t=ew(KM(e)).toVar(),n=jA(-1).toVar();return HA(t.x.greaterThan(t.z),()=>{HA(t.x.greaterThan(t.y),()=>{n.assign(BR(e.x.greaterThan(0),0,3))}).Else(()=>{n.assign(BR(e.y.greaterThan(0),1,4))})}).Else(()=>{HA(t.z.greaterThan(t.y),()=>{n.assign(BR(e.z.greaterThan(0),2,5))}).Else(()=>{n.assign(BR(e.y.greaterThan(0),1,4))})}),n}).setLayout({name:"getFace",type:"float",inputs:[{name:"direction",type:"vec3"}]}),ZD=VA(([e,t])=>{const n=KA().toVar();return HA(t.equal(0),()=>{n.assign(KA(e.z,e.y).div(KM(e.x)))}).ElseIf(t.equal(1),()=>{n.assign(KA(e.x.negate(),e.z.negate()).div(KM(e.y)))}).ElseIf(t.equal(2),()=>{n.assign(KA(e.x.negate(),e.y).div(KM(e.z)))}).ElseIf(t.equal(3),()=>{n.assign(KA(e.z.negate(),e.y).div(KM(e.x)))}).ElseIf(t.equal(4),()=>{n.assign(KA(e.x.negate(),e.z).div(KM(e.y)))}).Else(()=>{n.assign(KA(e.x,e.y).div(KM(e.z)))}),sM(.5,n.add(1))}).setLayout({name:"getUV",type:"vec2",inputs:[{name:"direction",type:"vec3"},{name:"face",type:"float"}]}),JD=VA(([e])=>{const t=jA(0).toVar();return HA(e.greaterThanEqual(zD),()=>{t.assign(BD.sub(e).mul(GD.sub(VD)).div(BD.sub(zD)).add(VD))}).ElseIf(e.greaterThanEqual(HD),()=>{t.assign(zD.sub(e).mul($D.sub(GD)).div(zD.sub(HD)).add(GD))}).ElseIf(e.greaterThanEqual(WD),()=>{t.assign(HD.sub(e).mul(jD.sub($D)).div(HD.sub(WD)).add($D))}).ElseIf(e.greaterThanEqual(qD),()=>{t.assign(WD.sub(e).mul(XD.sub(jD)).div(WD.sub(qD)).add(jD))}).Else(()=>{t.assign(jA(-2).mul(FM(sM(1.16,e))))}),t}).setLayout({name:"roughnessToMip",type:"float",inputs:[{name:"roughness",type:"float"}]}),ek=VA(([e,t])=>{const n=e.toVar();n.assign(sM(2,n).sub(1));const r=ew(n,1).toVar();return HA(t.equal(0),()=>{r.assign(r.zyx)}).ElseIf(t.equal(1),()=>{r.assign(r.xzy),r.xz.mulAssign(-1)}).ElseIf(t.equal(2),()=>{r.x.mulAssign(-1)}).ElseIf(t.equal(3),()=>{r.assign(r.zyx),r.xz.mulAssign(-1)}).ElseIf(t.equal(4),()=>{r.assign(r.xzy),r.xy.mulAssign(-1)}).ElseIf(t.equal(5),()=>{r.z.mulAssign(-1)}),r}).setLayout({name:"getDirection",type:"vec3",inputs:[{name:"uv",type:"vec2"},{name:"face",type:"float"}]}),tk=VA(([e,t,n,r,i,s])=>{const a=jA(n),o=ew(t),l=MR(JD(a),VD,s),u=HM(l),c=VM(l),d=ew(nk(e,o,c,r,i,s)).toVar();return HA(u.notEqual(0),()=>{const t=ew(nk(e,o,c.add(1),r,i,s)).toVar();d.assign(wR(d,t,u))}),d}),nk=VA(([e,t,n,r,i,s])=>{const a=jA(n).toVar(),o=ew(t),l=jA(QD(o)).toVar(),u=jA(dR(YD.sub(a),0)).toVar();a.assign(dR(a,YD));const c=jA(kM(a)).toVar(),d=KA(ZD(o,l).mul(c.sub(2)).add(1)).toVar();return HA(l.greaterThan(2),()=>{d.y.addAssign(c),l.subAssign(3)}),d.x.addAssign(l.mul(c)),d.x.addAssign(u.mul(sM(3,KD))),d.y.addAssign(sM(4,kM(s).sub(c))),d.x.mulAssign(r),d.y.mulAssign(i),e.sample(d).grad(KA(),KA())}),rk=VA(({envMap:e,mipInt:t,outputDirection:n,theta:r,axis:i,CUBEUV_TEXEL_WIDTH:s,CUBEUV_TEXEL_HEIGHT:a,CUBEUV_MAX_MIP:o})=>{const l=WM(r),u=n.mul(l).add(i.cross(n).mul($M(r))).add(i.mul(i.dot(n).mul(l.oneMinus())));return nk(e,u,t,s,a,o)}),ik=VA(({n:e,latitudinal:t,poleAxis:n,outputDirection:r,weights:i,samples:s,dTheta:a,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:u,CUBEUV_TEXEL_HEIGHT:c,CUBEUV_MAX_MIP:d})=>{const h=ew(BR(t,n,yR(n,r))).toVar();HA(IM(h.equals(ew(0))),()=>{h.assign(ew(r.z,0,r.x.negate()))}),h.assign(GM(h));const f=ew().toVar();return f.addAssign(i.element(qA(0)).mul(rk({theta:0,axis:h,outputDirection:r,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:u,CUBEUV_TEXEL_HEIGHT:c,CUBEUV_MAX_MIP:d}))),EP({start:qA(1),end:e},({i:e})=>{HA(e.greaterThanEqual(s),()=>{AP()});const t=jA(a.mul(jA(e))).toVar();f.addAssign(i.element(e).mul(rk({theta:t.mul(-1),axis:h,outputDirection:r,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:u,CUBEUV_TEXEL_HEIGHT:c,CUBEUV_MAX_MIP:d}))),f.addAssign(i.element(e).mul(rk({theta:t,axis:h,outputDirection:r,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:u,CUBEUV_TEXEL_HEIGHT:c,CUBEUV_MAX_MIP:d})))}),iw(f,1)});let sk=null;const ak=new WeakMap;function ok(e){let t=ak.get(e);if((void 0!==t?t.pmremVersion:-1)!==e.pmremVersion){const n=e.image;if(e.isCubeTexture){if(!function(e){if(null==e)return!1;let t=0;const n=6;for(let r=0;r<n;r++)void 0!==e[r]&&t++;return t===n}(n))return null;t=sk.fromCubemap(e,t)}else{if(!function(e){return null!=e&&e.height>0}(n))return null;t=sk.fromEquirectangular(e,t)}t.pmremVersion=e.pmremVersion,ak.set(e,t)}return t.texture}class lk extends ZE{static get type(){return"PMREMNode"}constructor(e,t=null,n=null){super("vec3"),this._value=e,this._pmrem=null,this.uvNode=t,this.levelNode=n,this._generator=null;const r=new yn;r.isRenderTargetTexture=!0,this._texture=BC(r),this._width=_w(0),this._height=_w(0),this._maxMip=_w(0),this.updateBeforeType=GE.RENDER}set value(e){this._value=e,this._pmrem=null}get value(){return this._value}updateFromTexture(e){const t=function(e){const t=Math.log2(e)-2,n=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,t),112)),texelHeight:n,maxMip:t}}(e.image.height);this._texture.value=e,this._width.value=t.texelWidth,this._height.value=t.texelHeight,this._maxMip.value=t.maxMip}updateBefore(){let e=this._pmrem;const t=e?e.pmremVersion:-1,n=this._value;t!==n.pmremVersion&&(e=!0===n.isPMREMTexture?n:ok(n),null!==e&&(this._pmrem=e,this.updateFromTexture(e)))}setup(e){null===sk&&(sk=e.createPMREMGenerator()),this.updateBefore(e);let t=this.uvNode;null===t&&e.context.getUV&&(t=e.context.getUV(this));const n=this.value;e.renderer.coordinateSystem===kt&&!0!==n.isPMREMTexture&&!0===n.isRenderTargetTexture&&(t=ew(t.x.negate(),t.yz)),t=ew(t.x,t.y.negate(),t.z);let r=this.levelNode;return null===r&&e.context.getTextureLevel&&(r=e.context.getTextureLevel(this)),tk(this._texture,t,r,this._width,this._height,this._maxMip)}}const uk=UA(lk),ck=new WeakMap;class dk extends LP{static get type(){return"EnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){const{material:t}=e;let n=this.envNode;if(n.isTextureNode||n.isMaterialReferenceNode){const e=n.isTextureNode?n.value:t[n.property];let r=ck.get(e);void 0===r&&(r=uk(e),ck.set(e,r)),n=r}const r=t.envMap?qI("envMapIntensity","float",e.material):qI("environmentIntensity","float",e.scene),i=!0===t.useAnisotropy||t.anisotropy>0?hL:RI,s=n.context(hk(ww,i)).mul(r),a=n.context(fk(CI)).mul(Math.PI).mul(r),o=_C(s),l=_C(a);e.context.radiance.addAssign(o),e.context.iblIrradiance.addAssign(l);const u=e.context.lightingModel.clearcoatRadiance;if(u){const e=n.context(hk(Cw,II)).mul(r),t=_C(e);u.addAssign(t)}}}const hk=(e,t)=>{let n=null;return{getUV:()=>(null===n&&(n=bI.negate().reflect(t),n=e.mul(e).mix(n,t).normalize(),n=n.transformDirection(WC)),n),getTextureLevel:()=>e}},fk=e=>({getUV:()=>e,getTextureLevel:()=>jA(1)}),pk=new dl;class mk extends gN{static get type(){return"MeshStandardNodeMaterial"}constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.lights=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(pk),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return null===t&&e.environmentNode&&(t=e.environmentNode),t?new dk(t):null}setupLightingModel(){return new UD}setupSpecular(){const e=wR(ew(.04),Ew.rgb,Mw);Bw.assign(e),Vw.assign(1)}setupVariants(){const e=this.metalnessNode?jA(this.metalnessNode):NL;Mw.assign(e);let t=this.roughnessNode?jA(this.roughnessNode):PL;t=QN({roughness:t}),ww.assign(t),this.setupSpecular(),Ew.assign(iw(Ew.rgb.mul(e.oneMinus()),Ew.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}}const gk=new hl;class vk extends mk{static get type(){return"MeshPhysicalNodeMaterial"}constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.iorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.dispersionNode=null,this.anisotropyNode=null,this.setDefaultValues(gk),this.setValues(e)}get useClearcoat(){return this.clearcoat>0||null!==this.clearcoatNode}get useIridescence(){return this.iridescence>0||null!==this.iridescenceNode}get useSheen(){return this.sheen>0||null!==this.sheenNode}get useAnisotropy(){return this.anisotropy>0||null!==this.anisotropyNode}get useTransmission(){return this.transmission>0||null!==this.transmissionNode}get useDispersion(){return this.dispersion>0||null!==this.dispersionNode}setupSpecular(){const e=this.iorNode?jA(this.iorNode):qL;jw.assign(e),Bw.assign(wR(cR(_R(jw.sub(1).div(jw.add(1))).mul(CL),ew(1)).mul(RL),Ew.rgb,Mw)),Vw.assign(wR(RL,1,Mw))}setupLightingModel(){return new UD(this.useClearcoat,this.useSheen,this.useIridescence,this.useAnisotropy,this.useTransmission,this.useDispersion)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){const e=this.clearcoatNode?jA(this.clearcoatNode):kL,t=this.clearcoatRoughnessNode?jA(this.clearcoatRoughnessNode):OL;Rw.assign(e),Cw.assign(QN({roughness:t}))}if(this.useSheen){const e=this.sheenNode?ew(this.sheenNode):BL,t=this.sheenRoughnessNode?jA(this.sheenRoughnessNode):VL;Iw.assign(e),Lw.assign(t)}if(this.useIridescence){const e=this.iridescenceNode?jA(this.iridescenceNode):GL,t=this.iridescenceIORNode?jA(this.iridescenceIORNode):HL,n=this.iridescenceThicknessNode?jA(this.iridescenceThicknessNode):$L;Pw.assign(e),Nw.assign(t),Dw.assign(n)}if(this.useAnisotropy){const e=(this.anisotropyNode?KA(this.anisotropyNode):zL).toVar();Ow.assign(e.length()),HA(Ow.equal(0),()=>{e.assign(KA(1,0))}).Else(()=>{e.divAssign(KA(Ow)),Ow.assign(Ow.saturate())}),kw.assign(Ow.pow2().mix(ww.pow2(),1)),Fw.assign(cL[0].mul(e.x).add(cL[1].mul(e.y))),Uw.assign(cL[1].mul(e.x).sub(cL[0].mul(e.y)))}if(this.useTransmission){const e=this.transmissionNode?jA(this.transmissionNode):WL,t=this.thicknessNode?jA(this.thicknessNode):jL,n=this.attenuationDistanceNode?jA(this.attenuationDistanceNode):XL,r=this.attenuationColorNode?ew(this.attenuationColorNode):YL;if(qw.assign(e),Xw.assign(t),Yw.assign(n),Kw.assign(r),this.useDispersion){const e=this.dispersionNode?jA(this.dispersionNode):nP;Qw.assign(e)}}}setupClearcoatNormal(){return this.clearcoatNormalNode?ew(this.clearcoatNormalNode):FL}setup(e){e.context.setupClearcoatNormal=()=>this.setupClearcoatNormal(e),super.setup(e)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,this.dispersionNode=e.dispersionNode,this.anisotropyNode=e.anisotropyNode,super.copy(e)}}const yk=VA(({normal:e,lightDirection:t,builder:n})=>{const r=e.dot(t),i=KA(r.mul(.5).add(.5),0);if(n.material.gradientMap){const e=KI("gradientMap","texture").context({getUV:()=>i});return ew(e.r)}{const e=i.fwidth().mul(.5);return wR(ew(.7),ew(1),IR(jA(.7).sub(e.x),jA(.7).add(e.x),i.x))}});class bk extends FN{direct({lightDirection:e,lightColor:t,reflectedLight:n},r,i){const s=yk({normal:TI,lightDirection:e,builder:i}).mul(t);n.directDiffuse.addAssign(s.mul(GN({diffuseColor:Ew.rgb})))}indirect({ambientOcclusion:e,irradiance:t,reflectedLight:n}){n.indirectDiffuse.addAssign(t.mul(GN({diffuseColor:Ew}))),n.indirectDiffuse.mulAssign(e)}}const _k=new pl;class xk extends gN{static get type(){return"MeshToonNodeMaterial"}constructor(e){super(),this.isMeshToonNodeMaterial=!0,this.lights=!0,this.setDefaultValues(_k),this.setValues(e)}setupLightingModel(){return new bk}}class Sk extends ZE{static get type(){return"MatcapUVNode"}constructor(){super("vec2")}setup(){const e=ew(bI.z,0,bI.x.negate()).normalize(),t=bI.cross(e);return KA(e.dot(RI),t.dot(RI)).mul(.495).add(.5)}}const Tk=BA(Sk),Ek=new bl;class Ak extends gN{static get type(){return"MeshMatcapNodeMaterial"}constructor(e){super(),this.isMeshMatcapNodeMaterial=!0,this.setDefaultValues(Ek),this.setValues(e)}setupVariants(e){const t=Tk;let n;n=e.material.matcap?KI("matcap","texture").context({getUV:()=>t}):ew(wR(.2,.8,t.y)),Ew.rgb.mulAssign(n.rgb)}}const wk=new wa;class Mk extends gN{static get type(){return"PointsNodeMaterial"}constructor(e){super(),this.isPointsNodeMaterial=!0,this.setDefaultValues(wk),this.setValues(e)}}class Rk extends ZE{static get type(){return"RotateNode"}constructor(e,t){super(),this.positionNode=e,this.rotationNode=t}getNodeType(e){return this.positionNode.getNodeType(e)}setup(e){const{rotationNode:t,positionNode:n}=this;if("vec2"===this.getNodeType(e)){const e=t.cos(),r=t.sin();return lw(e,r,r.negate(),e).mul(n)}{const e=t,r=cw(iw(1,0,0,0),iw(0,WM(e.x),$M(e.x).negate(),0),iw(0,$M(e.x),WM(e.x),0),iw(0,0,0,1)),i=cw(iw(WM(e.y),0,$M(e.y),0),iw(0,1,0,0),iw($M(e.y).negate(),0,WM(e.y),0),iw(0,0,0,1)),s=cw(iw(WM(e.z),$M(e.z).negate(),0,0),iw($M(e.z),WM(e.z),0,0),iw(0,0,1,0),iw(0,0,0,1));return r.mul(i).mul(s).mul(iw(n,1)).xyz}}}const Ck=UA(Rk),Ik=new Zi;class Lk extends gN{static get type(){return"SpriteNodeMaterial"}constructor(e){super(),this.isSpriteNodeMaterial=!0,this._useSizeAttenuation=!0,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.setDefaultValues(Ik),this.setValues(e)}setupPositionView(e){const{object:t,camera:n}=e,r=this.sizeAttenuation,{positionNode:i,rotationNode:s,scaleNode:a}=this,o=uI.mul(ew(i||0));let l=KA(rI[0].xyz.length(),rI[1].xyz.length());if(null!==a&&(l=l.mul(a)),!1===r)if(n.isPerspectiveCamera)l=l.mul(o.z.negate());else{const e=jA(2).div(HC.element(1).element(1));l=l.mul(e.mul(2))}let u=fI.xy;if(t.center&&!0===t.center.isVector2){const e=((e,t,n)=>kA(new aC(e,t,n)))("center","vec2",t);u=u.sub(e.sub(.5))}u=u.mul(l);const c=jA(s||UL),d=Ck(u,c);return iw(o.xy.add(d),o.zw)}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}get sizeAttenuation(){return this._useSizeAttenuation}set sizeAttenuation(e){this._useSizeAttenuation!==e&&(this._useSizeAttenuation=e,this.needsUpdate=!0)}}class Pk extends FN{constructor(){super(),this.shadowNode=jA(1).toVar("shadowMask")}direct({shadowMask:e}){this.shadowNode.mulAssign(e)}finish(e){Ew.a.mulAssign(this.shadowNode.oneMinus()),e.outgoingLight.rgb.assign(Ew.rgb)}}const Nk=new ul;class Dk extends gN{static get type(){return"ShadowNodeMaterial"}constructor(e){super(),this.isShadowNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Nk),this.setValues(e)}setupLightingModel(){return new Pk}}const kk=VA(({texture:e,uv:t})=>{const n=1e-4,r=ew().toVar();return HA(t.x.lessThan(n),()=>{r.assign(ew(1,0,0))}).ElseIf(t.y.lessThan(n),()=>{r.assign(ew(0,1,0))}).ElseIf(t.z.lessThan(n),()=>{r.assign(ew(0,0,1))}).ElseIf(t.x.greaterThan(.9999),()=>{r.assign(ew(-1,0,0))}).ElseIf(t.y.greaterThan(.9999),()=>{r.assign(ew(0,-1,0))}).ElseIf(t.z.greaterThan(.9999),()=>{r.assign(ew(0,0,-1))}).Else(()=>{const n=.01,i=e.sample(t.add(ew(-.01,0,0))).r.sub(e.sample(t.add(ew(n,0,0))).r),s=e.sample(t.add(ew(0,-.01,0))).r.sub(e.sample(t.add(ew(0,n,0))).r),a=e.sample(t.add(ew(0,0,-.01))).r.sub(e.sample(t.add(ew(0,0,n))).r);r.assign(ew(i,s,a))}),r.normalize()});class Ok extends UC{static get type(){return"Texture3DNode"}constructor(e,t=null,n=null){super(e,t,n),this.isTexture3DNode=!0}getInputType(){return"texture3D"}getDefaultUV(){return ew(.5,.5,.5)}setUpdateMatrix(){}setupUV(e,t){const n=this.value;return!e.isFlipY()||!0!==n.isRenderTargetTexture&&!0!==n.isFramebufferTexture||(t=this.sampler?t.flipY():t.setY(qA(kC(this,this.levelNode).y).sub(t.y).sub(1))),t}generateUV(e,t){return t.build(e,"vec3")}normal(e){return kk({texture:this,uv:e})}}const Fk=UA(Ok);class Uk{constructor(e,t){this.nodes=e,this.info=t,this._context=self,this._animationLoop=null,this._requestId=null}start(){const e=(t,n)=>{this._requestId=this._context.requestAnimationFrame(e),!0===this.info.autoReset&&this.info.reset(),this.nodes.nodeFrame.update(),this.info.frame=this.nodes.nodeFrame.frameId,null!==this._animationLoop&&this._animationLoop(t,n)};e()}stop(){this._context.cancelAnimationFrame(this._requestId),this._requestId=null}setAnimationLoop(e){this._animationLoop=e}setContext(e){this._context=e}dispose(){this.stop()}}class Bk{constructor(){this.weakMap=new WeakMap}get(e){let t=this.weakMap;for(let n=0;n<e.length;n++)if(t=t.get(e[n]),void 0===t)return;return t.get(e[e.length-1])}set(e,t){let n=this.weakMap;for(let t=0;t<e.length;t++){const r=e[t];!1===n.has(r)&&n.set(r,new WeakMap),n=n.get(r)}return n.set(e[e.length-1],t),this}delete(e){let t=this.weakMap;for(let n=0;n<e.length;n++)if(t=t.get(e[n]),void 0===t)return!1;return t.delete(e[e.length-1])}}let Vk=0;class zk{constructor(e,t,n,r,i,s,a,o,l,u){this.id=Vk++,this._nodes=e,this._geometries=t,this.renderer=n,this.object=r,this.material=i,this.scene=s,this.camera=a,this.lightsNode=o,this.context=l,this.geometry=r.geometry,this.version=i.version,this.drawRange=null,this.attributes=null,this.pipeline=null,this.vertexBuffers=null,this.drawParams=null,this.bundle=null,this.clippingContext=u,this.clippingContextCacheKey=null!==u?u.cacheKey:"",this.initialNodesCacheKey=this.getDynamicCacheKey(),this.initialCacheKey=this.getCacheKey(),this._nodeBuilderState=null,this._bindings=null,this._monitor=null,this.onDispose=null,this.isRenderObject=!0,this.onMaterialDispose=()=>{this.dispose()},this.material.addEventListener("dispose",this.onMaterialDispose)}updateClipping(e){this.clippingContext=e}get clippingNeedsUpdate(){return null!==this.clippingContext&&this.clippingContext.cacheKey!==this.clippingContextCacheKey&&(this.clippingContextCacheKey=this.clippingContext.cacheKey,!0)}get hardwareClippingPlanes(){return!0===this.material.hardwareClipping?this.clippingContext.unionClippingCount:0}getNodeBuilderState(){return this._nodeBuilderState||(this._nodeBuilderState=this._nodes.getForRender(this))}getMonitor(){return this._monitor||(this._monitor=this.getNodeBuilderState().monitor)}getBindings(){return this._bindings||(this._bindings=this.getNodeBuilderState().createBindings())}getIndex(){return this._geometries.getIndex(this)}getIndirect(){return this._geometries.getIndirect(this)}getChainArray(){return[this.object,this.material,this.context,this.lightsNode]}setGeometry(e){this.geometry=e,this.attributes=null}getAttributes(){if(null!==this.attributes)return this.attributes;const e=this.getNodeBuilderState().nodeAttributes,t=this.geometry,n=[],r=new Set;for(const i of e){const e=i.node&&i.node.attribute?i.node.attribute:t.getAttribute(i.name);if(void 0===e)continue;n.push(e);const s=e.isInterleavedBufferAttribute?e.data:e;r.add(s)}return this.attributes=n,this.vertexBuffers=Array.from(r.values()),n}getVertexBuffers(){return null===this.vertexBuffers&&this.getAttributes(),this.vertexBuffers}getDrawParameters(){const{object:e,material:t,geometry:n,group:r,drawRange:i}=this,s=this.drawParams||(this.drawParams={vertexCount:0,firstVertex:0,instanceCount:0,firstInstance:0}),a=this.getIndex(),o=null!==a,l=n.isInstancedBufferGeometry?n.instanceCount:e.count>1?e.count:1;if(0===l)return null;if(s.instanceCount=l,!0===e.isBatchedMesh)return s;let u=1;!0!==t.wireframe||e.isPoints||e.isLineSegments||e.isLine||e.isLineLoop||(u=2);let c=i.start*u,d=(i.start+i.count)*u;null!==r&&(c=Math.max(c,r.start*u),d=Math.min(d,(r.start+r.count)*u));const h=n.attributes.position;let f=1/0;o?f=a.count:null!=h&&(f=h.count),c=Math.max(c,0),d=Math.min(d,f);const p=d-c;return p<0||p===1/0?null:(s.vertexCount=p,s.firstVertex=c,s)}getGeometryCacheKey(){const{geometry:e}=this;let t="";for(const n of Object.keys(e.attributes).sort()){const r=e.attributes[n];t+=n+",",r.data&&(t+=r.data.stride+","),r.offset&&(t+=r.offset+","),r.itemSize&&(t+=r.itemSize+","),r.normalized&&(t+="n,")}return e.index&&(t+="index,"),t}getMaterialCacheKey(){const{object:e,material:t}=this;let n=t.customProgramCacheKey();for(const e of function(e){const t=Object.keys(e);let n=Object.getPrototypeOf(e);for(;n;){const e=Object.getOwnPropertyDescriptors(n);for(const n in e)if(void 0!==e[n]){const r=e[n];r&&"function"==typeof r.get&&t.push(n)}n=Object.getPrototypeOf(n)}return t}(t)){if(/^(is[A-Z]|_)|^(visible|version|uuid|name|opacity|userData)$/.test(e))continue;const r=t[e];let i;if(null!==r){const e=typeof r;"number"===e?i=0!==r?"1":"0":"object"===e?(i="{",r.isTexture&&(i+=r.mapping),i+="}"):i=String(r)}else i=String(r);n+=i+","}return n+=this.clippingContextCacheKey+",",e.geometry&&(n+=this.getGeometryCacheKey()),e.skeleton&&(n+=e.skeleton.bones.length+","),e.morphTargetInfluences&&(n+=e.morphTargetInfluences.length+","),e.isBatchedMesh&&(n+=e._matricesTexture.uuid+",",null!==e._colorsTexture&&(n+=e._colorsTexture.uuid+",")),e.count>1&&(n+=e.uuid+","),n+=e.receiveShadow+",",wE(n)}get needsGeometryUpdate(){return this.geometry.id!==this.object.geometry.id}get needsUpdate(){return this.initialNodesCacheKey!==this.getDynamicCacheKey()||this.clippingNeedsUpdate}getDynamicCacheKey(){let e=this._nodes.getCacheKey(this.scene,this.lightsNode);return this.object.receiveShadow&&(e+=1),e}getCacheKey(){return this.getMaterialCacheKey()+this.getDynamicCacheKey()}dispose(){this.material.removeEventListener("dispose",this.onMaterialDispose),this.onDispose()}}const Gk=[];class Hk{constructor(e,t,n,r,i,s){this.renderer=e,this.nodes=t,this.geometries=n,this.pipelines=r,this.bindings=i,this.info=s,this.chainMaps={}}get(e,t,n,r,i,s,a,o){const l=this.getChainMap(o);Gk[0]=e,Gk[1]=t,Gk[2]=s,Gk[3]=i;let u=l.get(Gk);return void 0===u?(u=this.createRenderObject(this.nodes,this.geometries,this.renderer,e,t,n,r,i,s,a,o),l.set(Gk,u)):(u.updateClipping(a),u.needsGeometryUpdate&&u.setGeometry(e.geometry),(u.version!==t.version||u.needsUpdate)&&(u.initialCacheKey!==u.getCacheKey()?(u.dispose(),u=this.get(e,t,n,r,i,s,a,o)):u.version=t.version)),u}getChainMap(e="default"){return this.chainMaps[e]||(this.chainMaps[e]=new Bk)}dispose(){this.chainMaps={}}createRenderObject(e,t,n,r,i,s,a,o,l,u,c){const d=this.getChainMap(c),h=new zk(e,t,n,r,i,s,a,o,l,u);return h.onDispose=()=>{this.pipelines.delete(h),this.bindings.delete(h),this.nodes.delete(h),d.delete(h.getChainArray())},h}}class $k{constructor(){this.data=new WeakMap}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}delete(e){let t=null;return this.data.has(e)&&(t=this.data.get(e),this.data.delete(e)),t}has(e){return this.data.has(e)}dispose(){this.data=new WeakMap}}const Wk=1,jk=2,qk=3,Xk=4,Yk=16;class Kk extends $k{constructor(e){super(),this.backend=e}delete(e){const t=super.delete(e);return void 0!==t&&this.backend.destroyAttribute(e),t}update(e,t){const n=this.get(e);if(void 0===n.version)t===Wk?this.backend.createAttribute(e):t===jk?this.backend.createIndexAttribute(e):t===qk?this.backend.createStorageAttribute(e):t===Xk&&this.backend.createIndirectStorageAttribute(e),n.version=this._getBufferAttribute(e).version;else{const t=this._getBufferAttribute(e);(n.version<t.version||t.usage===Nt)&&(this.backend.updateAttribute(e),n.version=t.version)}}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}function Qk(e){return null!==e.index?e.index.version:e.attributes.position.version}function Zk(e){const t=[],n=e.index,r=e.attributes.position;if(null!==n){const e=n.array;for(let n=0,r=e.length;n<r;n+=3){const r=e[n+0],i=e[n+1],s=e[n+2];t.push(r,i,i,s,s,r)}}else{for(let e=0,n=r.array.length/3-1;e<n;e+=3){const n=e+0,r=e+1,i=e+2;t.push(n,r,r,i,i,n)}}const i=new(function(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}(t)?oi:ai)(t,1);return i.version=Qk(e),i}class Jk extends $k{constructor(e,t){super(),this.attributes=e,this.info=t,this.wireframes=new WeakMap,this.attributeCall=new WeakMap}has(e){const t=e.geometry;return super.has(t)&&!0===this.get(t).initialized}updateForRender(e){!1===this.has(e)&&this.initGeometry(e),this.updateAttributes(e)}initGeometry(e){const t=e.geometry;this.get(t).initialized=!0,this.info.memory.geometries++;const n=()=>{this.info.memory.geometries--;const r=t.index,i=e.getAttributes();null!==r&&this.attributes.delete(r);for(const e of i)this.attributes.delete(e);const s=this.wireframes.get(t);void 0!==s&&this.attributes.delete(s),t.removeEventListener("dispose",n)};t.addEventListener("dispose",n)}updateAttributes(e){const t=e.getAttributes();for(const e of t)e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute?this.updateAttribute(e,qk):this.updateAttribute(e,Wk);const n=this.getIndex(e);null!==n&&this.updateAttribute(n,jk);const r=e.geometry.indirect;null!==r&&this.updateAttribute(r,Xk)}updateAttribute(e,t){const n=this.info.render.calls;e.isInterleavedBufferAttribute?void 0===this.attributeCall.get(e)?(this.attributes.update(e,t),this.attributeCall.set(e,n)):this.attributeCall.get(e.data)!==n&&(this.attributes.update(e,t),this.attributeCall.set(e.data,n),this.attributeCall.set(e,n)):this.attributeCall.get(e)!==n&&(this.attributes.update(e,t),this.attributeCall.set(e,n))}getIndirect(e){return e.geometry.indirect}getIndex(e){const{geometry:t,material:n}=e;let r=t.index;if(!0===n.wireframe){const e=this.wireframes;let n=e.get(t);void 0===n?(n=Zk(t),e.set(t,n)):n.version!==Qk(t)&&(this.attributes.delete(n),n=Zk(t),e.set(t,n)),r=n}return r}}class eO{constructor(){this.autoReset=!0,this.frame=0,this.calls=0,this.render={calls:0,frameCalls:0,drawCalls:0,triangles:0,points:0,lines:0,timestamp:0,previousFrameCalls:0,timestampCalls:0},this.compute={calls:0,frameCalls:0,timestamp:0,previousFrameCalls:0,timestampCalls:0},this.memory={geometries:0,textures:0}}update(e,t,n){this.render.drawCalls++,e.isMesh||e.isSprite?this.render.triangles+=n*(t/3):e.isPoints?this.render.points+=n*t:e.isLineSegments?this.render.lines+=n*(t/2):e.isLine&&(this.render.lines+=n*(t-1))}updateTimestamp(e,t){0===this[e].timestampCalls&&(this[e].timestamp=0),this[e].timestamp+=t,this[e].timestampCalls++,this[e].timestampCalls>=this[e].previousFrameCalls&&(this[e].timestampCalls=0)}reset(){const e=this.render.frameCalls;this.render.previousFrameCalls=e;const t=this.compute.frameCalls;this.compute.previousFrameCalls=t,this.render.drawCalls=0,this.render.frameCalls=0,this.compute.frameCalls=0,this.render.triangles=0,this.render.points=0,this.render.lines=0}dispose(){this.reset(),this.calls=0,this.render.calls=0,this.compute.calls=0,this.render.timestamp=0,this.compute.timestamp=0,this.memory.geometries=0,this.memory.textures=0}}class tO{constructor(e){this.cacheKey=e,this.usedTimes=0}}class nO extends tO{constructor(e,t,n){super(e),this.vertexProgram=t,this.fragmentProgram=n}}class rO extends tO{constructor(e,t){super(e),this.computeProgram=t,this.isComputePipeline=!0}}let iO=0;class sO{constructor(e,t,n,r=null,i=null){this.id=iO++,this.code=e,this.stage=t,this.name=n,this.transforms=r,this.attributes=i,this.usedTimes=0}}class aO extends $k{constructor(e,t){super(),this.backend=e,this.nodes=t,this.bindings=null,this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}getForCompute(e,t){const{backend:n}=this,r=this.get(e);if(this._needsComputeUpdate(e)){const i=r.pipeline;i&&(i.usedTimes--,i.computeProgram.usedTimes--);const s=this.nodes.getForCompute(e);let a=this.programs.compute.get(s.computeShader);void 0===a&&(i&&0===i.computeProgram.usedTimes&&this._releaseProgram(i.computeProgram),a=new sO(s.computeShader,"compute",e.name,s.transforms,s.nodeAttributes),this.programs.compute.set(s.computeShader,a),n.createProgram(a));const o=this._getComputeCacheKey(e,a);let l=this.caches.get(o);void 0===l&&(i&&0===i.usedTimes&&this._releasePipeline(i),l=this._getComputePipeline(e,a,o,t)),l.usedTimes++,a.usedTimes++,r.version=e.version,r.pipeline=l}return r.pipeline}getForRender(e,t=null){const{backend:n}=this,r=this.get(e);if(this._needsRenderUpdate(e)){const i=r.pipeline;i&&(i.usedTimes--,i.vertexProgram.usedTimes--,i.fragmentProgram.usedTimes--);const s=e.getNodeBuilderState(),a=e.material?e.material.name:"";let o=this.programs.vertex.get(s.vertexShader);void 0===o&&(i&&0===i.vertexProgram.usedTimes&&this._releaseProgram(i.vertexProgram),o=new sO(s.vertexShader,"vertex",a),this.programs.vertex.set(s.vertexShader,o),n.createProgram(o));let l=this.programs.fragment.get(s.fragmentShader);void 0===l&&(i&&0===i.fragmentProgram.usedTimes&&this._releaseProgram(i.fragmentProgram),l=new sO(s.fragmentShader,"fragment",a),this.programs.fragment.set(s.fragmentShader,l),n.createProgram(l));const u=this._getRenderCacheKey(e,o,l);let c=this.caches.get(u);void 0===c?(i&&0===i.usedTimes&&this._releasePipeline(i),c=this._getRenderPipeline(e,o,l,u,t)):e.pipeline=c,c.usedTimes++,o.usedTimes++,l.usedTimes++,r.pipeline=c}return r.pipeline}delete(e){const t=this.get(e).pipeline;return t&&(t.usedTimes--,0===t.usedTimes&&this._releasePipeline(t),t.isComputePipeline?(t.computeProgram.usedTimes--,0===t.computeProgram.usedTimes&&this._releaseProgram(t.computeProgram)):(t.fragmentProgram.usedTimes--,t.vertexProgram.usedTimes--,0===t.vertexProgram.usedTimes&&this._releaseProgram(t.vertexProgram),0===t.fragmentProgram.usedTimes&&this._releaseProgram(t.fragmentProgram))),super.delete(e)}dispose(){super.dispose(),this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}updateForRender(e){this.getForRender(e)}_getComputePipeline(e,t,n,r){n=n||this._getComputeCacheKey(e,t);let i=this.caches.get(n);return void 0===i&&(i=new rO(n,t),this.caches.set(n,i),this.backend.createComputePipeline(i,r)),i}_getRenderPipeline(e,t,n,r,i){r=r||this._getRenderCacheKey(e,t,n);let s=this.caches.get(r);return void 0===s&&(s=new nO(r,t,n),this.caches.set(r,s),e.pipeline=s,this.backend.createRenderPipeline(e,i)),s}_getComputeCacheKey(e,t){return e.id+","+t.id}_getRenderCacheKey(e,t,n){return t.id+","+n.id+","+this.backend.getRenderCacheKey(e)}_releasePipeline(e){this.caches.delete(e.cacheKey)}_releaseProgram(e){const t=e.code,n=e.stage;this.programs[n].delete(t)}_needsComputeUpdate(e){const t=this.get(e);return void 0===t.pipeline||t.version!==e.version}_needsRenderUpdate(e){return void 0===this.get(e).pipeline||this.backend.needsRenderUpdate(e)}}class oO extends $k{constructor(e,t,n,r,i,s){super(),this.backend=e,this.textures=n,this.pipelines=i,this.attributes=r,this.nodes=t,this.info=s,this.pipelines.bindings=this}getForRender(e){const t=e.getBindings();for(const e of t){const n=this.get(e);void 0===n.bindGroup&&(this._init(e),this.backend.createBindings(e,t,0),n.bindGroup=e)}return t}getForCompute(e){const t=this.nodes.getForCompute(e).bindings;for(const e of t){const n=this.get(e);void 0===n.bindGroup&&(this._init(e),this.backend.createBindings(e,t,0),n.bindGroup=e)}return t}updateForCompute(e){this._updateBindings(this.getForCompute(e))}updateForRender(e){this._updateBindings(this.getForRender(e))}_updateBindings(e){for(const t of e)this._update(t,e)}_init(e){for(const t of e.bindings)if(t.isSampledTexture)this.textures.updateTexture(t.texture);else if(t.isStorageBuffer){const e=t.attribute,n=e.isIndirectStorageBufferAttribute?Xk:qk;this.attributes.update(e,n)}}_update(e,t){const{backend:n}=this;let r=!1,i=!0,s=0,a=0;for(const t of e.bindings){if(t.isNodeUniformsGroup){if(!1===this.nodes.updateGroup(t))continue}if(t.isUniformBuffer){t.update()&&n.updateBinding(t)}else if(t.isSampler)t.update();else if(t.isSampledTexture){const e=this.textures.get(t.texture);t.needsBindingsUpdate(e.generation)&&(r=!0);const o=t.update(),l=t.texture;o&&this.textures.updateTexture(l);const u=n.get(l);if(void 0!==u.externalTexture||e.isDefaultTexture?i=!1:(s=10*s+l.id,a+=l.version),!0===n.isWebGPUBackend&&void 0===u.texture&&void 0===u.externalTexture&&(this.textures.updateTexture(l),r=!0),!0===l.isStorageTexture){const e=this.get(l);!0===t.store?e.needsMipmap=!0:this.textures.needsMipmaps(l)&&!0===e.needsMipmap&&(this.backend.generateMipmaps(l),e.needsMipmap=!1)}}}!0===r&&this.backend.updateBindings(e,t,i?s:0,a)}}function lO(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function uO(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function cO(e){return(e.transmission>0||e.transmissionNode)&&2===e.side&&!1===e.forceSinglePass}class dO{constructor(e,t,n){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparentDoublePass=[],this.transparent=[],this.bundles=[],this.lightsNode=e.getNode(t,n),this.lightsArray=[],this.scene=t,this.camera=n,this.occlusionQueryCount=0}begin(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparentDoublePass.length=0,this.transparent.length=0,this.bundles.length=0,this.lightsArray.length=0,this.occlusionQueryCount=0,this}getNextRenderItem(e,t,n,r,i,s,a){let o=this.renderItems[this.renderItemsIndex];return void 0===o?(o={id:e.id,object:e,geometry:t,material:n,groupOrder:r,renderOrder:e.renderOrder,z:i,group:s,clippingContext:a},this.renderItems[this.renderItemsIndex]=o):(o.id=e.id,o.object=e,o.geometry=t,o.material=n,o.groupOrder=r,o.renderOrder=e.renderOrder,o.z=i,o.group=s,o.clippingContext=a),this.renderItemsIndex++,o}push(e,t,n,r,i,s,a){const o=this.getNextRenderItem(e,t,n,r,i,s,a);!0===e.occlusionTest&&this.occlusionQueryCount++,!0===n.transparent||n.transmission>0?(cO(n)&&this.transparentDoublePass.push(o),this.transparent.push(o)):this.opaque.push(o)}unshift(e,t,n,r,i,s,a){const o=this.getNextRenderItem(e,t,n,r,i,s,a);!0===n.transparent||n.transmission>0?(cO(n)&&this.transparentDoublePass.unshift(o),this.transparent.unshift(o)):this.opaque.unshift(o)}pushBundle(e){this.bundles.push(e)}pushLight(e){this.lightsArray.push(e)}sort(e,t){this.opaque.length>1&&this.opaque.sort(e||lO),this.transparentDoublePass.length>1&&this.transparentDoublePass.sort(t||uO),this.transparent.length>1&&this.transparent.sort(t||uO)}finish(){this.lightsNode.setLights(this.lightsArray);for(let e=this.renderItemsIndex,t=this.renderItems.length;e<t;e++){const t=this.renderItems[e];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.groupOrder=null,t.renderOrder=null,t.z=null,t.group=null,t.clippingContext=null}}}class hO{constructor(e){this.lighting=e,this.lists=new Bk}get(e,t){const n=this.lists,r=[e,t];let i=n.get(r);return void 0===i&&(i=new dO(this.lighting,e,t),n.set(r,i)),i}dispose(){this.lists=new Bk}}let fO=0;class pO{constructor(){this.id=fO++,this.color=!0,this.clearColor=!0,this.clearColorValue={r:0,g:0,b:0,a:1},this.depth=!0,this.clearDepth=!0,this.clearDepthValue=1,this.stencil=!1,this.clearStencil=!0,this.clearStencilValue=1,this.viewport=!1,this.viewportValue=new bn,this.scissor=!1,this.scissorValue=new bn,this.textures=null,this.depthTexture=null,this.activeCubeFace=0,this.sampleCount=1,this.width=0,this.height=0,this.isRenderContext=!0}getCacheKey(){return mO(this)}}function mO(e){const{textures:t,activeCubeFace:n}=e,r=[n];for(const e of t)r.push(e.id);return ME(r)}class gO{constructor(){this.chainMaps={}}get(e=null,t=null,n=null){const r=[];let i;if(null!==e&&r.push(e),null!==t&&r.push(t),0===r.length&&r.push({id:"default"}),null===n)i="default";else{const e=n.texture.format;i=`${n.textures.length}:${e}:${n.samples}:${n.depthBuffer}:${n.stencilBuffer}`}const s=this.getChainMap(i);let a=s.get(r);return void 0===a&&(a=new pO,s.set(r,a)),null!==n&&(a.sampleCount=0===n.samples?1:n.samples),a}getChainMap(e){return this.chainMaps[e]||(this.chainMaps[e]=new Bk)}dispose(){this.chainMaps={}}}const vO=new An;class yO extends $k{constructor(e,t,n){super(),this.renderer=e,this.backend=t,this.info=n}updateRenderTarget(e,t=0){const n=this.get(e),r=0===e.samples?1:e.samples,i=n.depthTextureMips||(n.depthTextureMips={}),s=e.textures,a=this.getSize(s[0]),o=a.width>>t,l=a.height>>t;let u=e.depthTexture||i[t];const c=!0===e.depthBuffer||!0===e.stencilBuffer;let d=!1;void 0===u&&c&&(u=new Fa,u.format=e.stencilBuffer?Ae:Ee,u.type=e.stencilBuffer?ve:he,u.image.width=o,u.image.height=l,i[t]=u),n.width===a.width&&a.height===n.height||(d=!0,u&&(u.needsUpdate=!0,u.image.width=o,u.image.height=l)),n.width=a.width,n.height=a.height,n.textures=s,n.depthTexture=u||null,n.depth=e.depthBuffer,n.stencil=e.stencilBuffer,n.renderTarget=e,n.sampleCount!==r&&(d=!0,u&&(u.needsUpdate=!0),n.sampleCount=r);const h={sampleCount:r};for(let e=0;e<s.length;e++){const t=s[e];d&&(t.needsUpdate=!0),this.updateTexture(t,h)}if(u&&this.updateTexture(u,h),!0!==n.initialized){n.initialized=!0;const t=()=>{e.removeEventListener("dispose",t);for(let e=0;e<s.length;e++)this._destroyTexture(s[e]);u&&this._destroyTexture(u),this.delete(e)};e.addEventListener("dispose",t)}}updateTexture(e,t={}){const n=this.get(e);if(!0===n.initialized&&n.version===e.version)return;const r=e.isRenderTargetTexture||e.isDepthTexture||e.isFramebufferTexture,i=this.backend;if(r&&!0===n.initialized&&(i.destroySampler(e),i.destroyTexture(e)),e.isFramebufferTexture){const t=this.renderer.getRenderTarget();e.type=t?t.texture.type:oe}const{width:s,height:a,depth:o}=this.getSize(e);if(t.width=s,t.height=a,t.depth=o,t.needsMipmaps=this.needsMipmaps(e),t.levels=t.needsMipmaps?this.getMipLevels(e,s,a):1,r||!0===e.isStorageTexture)i.createSampler(e),i.createTexture(e,t),n.generation=e.version;else{if(!0!==n.initialized&&i.createSampler(e),e.version>0){const r=e.image;if(void 0===r);else if(!1===r.complete);else{if(e.images){const n=[];for(const t of e.images)n.push(t);t.images=n}else t.image=r;void 0!==n.isDefaultTexture&&!0!==n.isDefaultTexture||(i.createTexture(e,t),n.isDefaultTexture=!1,n.generation=e.version),!0===e.source.dataReady&&i.updateTexture(e,t),t.needsMipmaps&&0===e.mipmaps.length&&i.generateMipmaps(e)}}else i.createDefaultTexture(e),n.isDefaultTexture=!0,n.generation=e.version}if(!0!==n.initialized){n.initialized=!0,n.generation=e.version,this.info.memory.textures++;const t=()=>{e.removeEventListener("dispose",t),this._destroyTexture(e),this.info.memory.textures--};e.addEventListener("dispose",t)}n.version=e.version}getSize(e,t=vO){let n=e.images?e.images[0]:e.image;return n?(void 0!==n.image&&(n=n.image),t.width=n.width||1,t.height=n.height||1,t.depth=e.isCubeTexture?6:n.depth||1):t.width=t.height=t.depth=1,t}getMipLevels(e,t,n){let r;return r=e.isCompressedTexture?e.mipmaps?e.mipmaps.length:1:Math.floor(Math.log2(Math.max(t,n)))+1,r}needsMipmaps(e){return this.isEnvironmentTexture(e)||!0===e.isCompressedTexture||e.generateMipmaps}isEnvironmentTexture(e){const t=e.mapping;return t===Y||t===K||t===q||t===X}_destroyTexture(e){this.backend.destroySampler(e),this.backend.destroyTexture(e),this.delete(e)}}class bO extends qr{constructor(e,t,n,r=1){super(e,t,n),this.a=r}set(e,t,n,r=1){return this.a=r,super.set(e,t,n)}copy(e){return void 0!==e.a&&(this.a=e.a),super.copy(e)}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}}class _O extends xw{static get type(){return"ParameterNode"}constructor(e,t=null){super(e,t),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}}class xO extends YE{static get type(){return"StackNode"}constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this.isStackNode=!0}getNodeType(e){return this.outputNode?this.outputNode.getNodeType(e):"void"}add(e){return this.nodes.push(e),this}If(e,t){const n=new DA(t);return this._currentCond=BR(e,n),this.add(this._currentCond)}ElseIf(e,t){const n=new DA(t),r=BR(e,n);return this._currentCond.elseNode=r,this._currentCond=r,this}Else(e){return this._currentCond.elseNode=new DA(e),this}build(e,...t){const n=GA();zA(this);for(const t of this.nodes)t.build(e,"void");return zA(n),this.outputNode?this.outputNode.build(e,...t):super.build(e,...t)}else(...e){return this.Else(...e)}elseif(...e){return this.ElseIf(...e)}}const SO=UA(xO);class TO extends YE{static get type(){return"OutputStructNode"}constructor(...e){super(),this.members=e,this.isOutputStructNode=!0}setup(e){super.setup(e);const t=this.members,n=[];for(let r=0;r<t.length;r++)n.push(t[r].getNodeType(e));this.nodeType=e.getStructTypeFromNode(this,n).name}generate(e,t){const n=e.getOutputStructName(),r=this.members,i=""!==n?n+".":"";for(let n=0;n<r.length;n++){const s=r[n].build(e,t);e.addLineFlowCode(`${i}m${n} = ${s}`,this)}return n}}const EO=UA(TO);function AO(e,t){for(let n=0;n<e.length;n++)if(e[n].name===t)return n;return-1}class wO extends TO{static get type(){return"MRTNode"}constructor(e){super(),this.outputNodes=e,this.isMRTNode=!0}has(e){return void 0!==this.outputNodes[e]}get(e){return this.outputNodes[e]}merge(e){const t={...this.outputNodes,...e.outputNodes};return MO(t)}setup(e){const t=this.outputNodes,n=[],r=e.renderer.getRenderTarget().textures;for(const e in t){n[AO(r,e)]=iw(t[e])}return this.members=n,super.setup(e)}}const MO=UA(wO),RO=VA(([e])=>{const t=e.toUint().mul(747796405).add(2891336453),n=t.shiftRight(t.shiftRight(28).add(4)).bitXor(t).mul(277803737);return n.shiftRight(22).bitXor(n).toFloat().mul(1/2**32)}),CO=(e,t)=>bR(sM(4,e.mul(iM(1,e))),t),IO=VA(([e])=>e.fract().sub(.5).abs()).setLayout({name:"tri",type:"float",inputs:[{name:"x",type:"float"}]}),LO=VA(([e])=>ew(IO(e.z.add(IO(e.y.mul(1)))),IO(e.z.add(IO(e.x.mul(1)))),IO(e.y.add(IO(e.x.mul(1)))))).setLayout({name:"tri3",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),PO=VA(([e,t,n])=>{const r=ew(e).toVar(),i=jA(1.4).toVar(),s=jA(0).toVar(),a=ew(r).toVar();return EP({start:jA(0),end:jA(3),type:"float",condition:"<="},()=>{const e=ew(LO(a.mul(2))).toVar();r.addAssign(e.add(n.mul(jA(.1).mul(t)))),a.mulAssign(1.8),i.mulAssign(1.5),r.mulAssign(1.2);const o=jA(IO(r.z.add(IO(r.x.add(IO(r.y)))))).toVar();s.addAssign(o.div(i)),a.addAssign(.14)}),s}).setLayout({name:"triNoise3D",type:"float",inputs:[{name:"position",type:"vec3"},{name:"speed",type:"float"},{name:"time",type:"float"}]});class NO extends YE{static get type(){return"FunctionOverloadingNode"}constructor(e=[],...t){super(),this.functionNodes=e,this.parametersNodes=t,this._candidateFnCall=null,this.global=!0}getNodeType(){return this.functionNodes[0].shaderNode.layout.type}setup(e){const t=this.parametersNodes;let n=this._candidateFnCall;if(null===n){let r=null,i=-1;for(const n of this.functionNodes){const s=n.shaderNode.layout;if(null===s)throw new Error("FunctionOverloadingNode: FunctionNode must be a layout.");const a=s.inputs;if(t.length===a.length){let s=0;for(let n=0;n<t.length;n++){const r=t[n],i=a[n];r.getNodeType(e)===i.type?s++:s=0}s>i&&(r=n,i=s)}}this._candidateFnCall=n=r(...t)}return n}}const DO=UA(NO),kO=e=>(...t)=>DO(e,...t),OO=_w(0).setGroup(vw).onRenderUpdate(e=>e.time),FO=_w(0).setGroup(vw).onRenderUpdate(e=>e.deltaTime),UO=_w(0,"uint").setGroup(vw).onRenderUpdate(e=>e.frameId),BO=VA(([e,t,n=KA(.5)])=>Ck(e.sub(n),t).add(n)),VO=VA(([e,t,n=KA(.5)])=>{const r=e.sub(n),i=r.dot(r),s=i.mul(i).mul(t);return e.add(r.mul(s))}),zO=VA(({position:e=null,horizontal:t=!0,vertical:n=!1})=>{let r;null!==e?(r=rI.toVar(),r[3][0]=e.x,r[3][1]=e.y,r[3][2]=e.z):r=rI;const i=WC.mul(r);return PA(t)&&(i[0][0]=rI[0].length(),i[0][1]=0,i[0][2]=0),PA(n)&&(i[1][0]=0,i[1][1]=rI[1].length(),i[1][2]=0),i[2][0]=0,i[2][1]=0,i[2][2]=1,HC.mul(i).mul(pI)}),GO=VA(([e=null])=>{const t=uN();return uN(tN(e)).sub(t).lessThan(0).select(BP,e)});class HO extends YE{static get type(){return"SpriteSheetUVNode"}constructor(e,t=NC(),n=jA(0)){super("vec2"),this.countNode=e,this.uvNode=t,this.frameNode=n}setup(){const{frameNode:e,uvNode:t,countNode:n}=this,{width:r,height:i}=n,s=e.mod(r.mul(i)).floor(),a=s.mod(r),o=i.sub(s.add(1).div(r).ceil()),l=n.reciprocal(),u=KA(a,o);return t.add(u).mul(l)}}const $O=UA(HO);class WO extends YE{static get type(){return"TriplanarTexturesNode"}constructor(e,t=null,n=null,r=jA(1),i=pI,s=EI){super("vec4"),this.textureXNode=e,this.textureYNode=t,this.textureZNode=n,this.scaleNode=r,this.positionNode=i,this.normalNode=s}setup(){const{textureXNode:e,textureYNode:t,textureZNode:n,scaleNode:r,positionNode:i,normalNode:s}=this;let a=s.abs().normalize();a=a.div(a.dot(ew(1)));const o=i.yz.mul(r),l=i.zx.mul(r),u=i.xy.mul(r),c=e.value,d=null!==t?t.value:c,h=null!==n?n.value:c,f=BC(c,o).mul(a.x),p=BC(d,l).mul(a.y),m=BC(h,u).mul(a.z);return rM(f,p,m)}}const jO=UA(WO),qO=new $s,XO=new An,YO=new An,KO=new An,QO=new tr,ZO=new An(0,0,-1),JO=new bn,eF=new An,tF=new An,nF=new bn,rF=new Yt,iF=new _n,sF=BP.flipX();iF.depthTexture=new Fa(1,1);let aF=!1;class oF extends UC{static get type(){return"ReflectorNode"}constructor(e={}){super(e.defaultTexture||iF.texture,sF),this._reflectorBaseNode=e.reflector||new lF(this,e),this._depthNode=null,this.setUpdateMatrix(!1)}get reflector(){return this._reflectorBaseNode}get target(){return this._reflectorBaseNode.target}getDepthNode(){if(null===this._depthNode){if(!0!==this._reflectorBaseNode.depth)throw new Error("THREE.ReflectorNode: Depth node can only be requested when the reflector is created with { depth: true }. ");this._depthNode=kA(new oF({defaultTexture:iF.depthTexture,reflector:this._reflectorBaseNode}))}return this._depthNode}setup(e){return e.object.isQuadMesh||this._reflectorBaseNode.build(e),super.setup(e)}clone(){const e=new this.constructor(this.reflectorNode);return e._reflectorBaseNode=this._reflectorBaseNode,e}}class lF extends YE{static get type(){return"ReflectorBaseNode"}constructor(e,t={}){super();const{target:n=new Rr,resolution:r=1,generateMipmaps:i=!1,bounces:s=!0,depth:a=!1}=t;this.textureNode=e,this.target=n,this.resolution=r,this.generateMipmaps=i,this.bounces=s,this.depth=a,this.updateBeforeType=s?GE.RENDER:GE.FRAME,this.virtualCameras=new WeakMap,this.renderTargets=new WeakMap}_updateResolution(e,t){const n=this.resolution;t.getDrawingBufferSize(rF),e.setSize(Math.round(rF.width*n),Math.round(rF.height*n))}setup(e){return this._updateResolution(iF,e.renderer),super.setup(e)}getVirtualCamera(e){let t=this.virtualCameras.get(e);return void 0===t&&(t=e.clone(),this.virtualCameras.set(e,t)),t}getRenderTarget(e){let t=this.renderTargets.get(e);return void 0===t&&(t=new _n(0,0,{type:pe}),!0===this.generateMipmaps&&(t.texture.minFilter=1008,t.texture.generateMipmaps=!0),!0===this.depth&&(t.depthTexture=new Fa),this.renderTargets.set(e,t)),t}updateBefore(e){if(!1===this.bounces&&aF)return!1;aF=!0;const{scene:t,camera:n,renderer:r,material:i}=e,{target:s}=this,a=this.getVirtualCamera(n),o=this.getRenderTarget(a);if(r.getDrawingBufferSize(rF),this._updateResolution(o,r),YO.setFromMatrixPosition(s.matrixWorld),KO.setFromMatrixPosition(n.matrixWorld),QO.extractRotation(s.matrixWorld),XO.set(0,0,1),XO.applyMatrix4(QO),eF.subVectors(YO,KO),eF.dot(XO)>0)return;eF.reflect(XO).negate(),eF.add(YO),QO.extractRotation(n.matrixWorld),ZO.set(0,0,-1),ZO.applyMatrix4(QO),ZO.add(KO),tF.subVectors(YO,ZO),tF.reflect(XO).negate(),tF.add(YO),a.coordinateSystem=n.coordinateSystem,a.position.copy(eF),a.up.set(0,1,0),a.up.applyMatrix4(QO),a.up.reflect(XO),a.lookAt(tF),a.near=n.near,a.far=n.far,a.updateMatrixWorld(),a.projectionMatrix.copy(n.projectionMatrix),qO.setFromNormalAndCoplanarPoint(XO,YO),qO.applyMatrix4(a.matrixWorldInverse),JO.set(qO.normal.x,qO.normal.y,qO.normal.z,qO.constant);const l=a.projectionMatrix;nF.x=(Math.sign(JO.x)+l.elements[8])/l.elements[0],nF.y=(Math.sign(JO.y)+l.elements[9])/l.elements[5],nF.z=-1,nF.w=(1+l.elements[10])/l.elements[14],JO.multiplyScalar(1/JO.dot(nF));l.elements[2]=JO.x,l.elements[6]=JO.y,l.elements[10]=r.coordinateSystem===Ot?JO.z-0:JO.z+1-0,l.elements[14]=JO.w,this.textureNode.value=o.texture,!0===this.depth&&(this.textureNode.getDepthNode().value=o.depthTexture),i.visible=!1;const u=r.getRenderTarget(),c=r.getMRT(),d=r.autoClear;r.setMRT(null),r.setRenderTarget(o),r.autoClear=!0,r.render(t,a),r.setMRT(c),r.setRenderTarget(u),r.autoClear=d,i.visible=!0,aF=!1}}const uF=new uu(-1,1,1,-1,0,1);class cF extends vi{constructor(e=!1){super();const t=!1===e?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute("position",new ui([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new ui(t,2))}}const dF=new cF;class hF extends Ci{constructor(e=null){super(dF,e),this.camera=uF,this.isQuadMesh=!0}async renderAsync(e){return e.renderAsync(this,uF)}render(e){e.render(this,uF)}}const fF=new Yt;class pF extends UC{static get type(){return"RTTNode"}constructor(e,t=null,n=null,r={type:pe}){const i=new _n(t,n,r);super(i.texture,NC()),this.node=e,this.width=t,this.height=n,this.pixelRatio=1,this.renderTarget=i,this.textureNeedsUpdate=!0,this.autoUpdate=!0,this._rttNode=null,this._quadMesh=new hF(new gN),this.updateBeforeType=GE.RENDER}get autoSize(){return null===this.width}setup(e){return this._rttNode=this.node.context(e.getSharedContext()),this._quadMesh.material.name="RTT",this._quadMesh.material.needsUpdate=!0,super.setup(e)}setSize(e,t){this.width=e,this.height=t;const n=e*this.pixelRatio,r=t*this.pixelRatio;this.renderTarget.setSize(n,r),this.textureNeedsUpdate=!0}setPixelRatio(e){this.pixelRatio=e,this.setSize(this.width,this.height)}updateBefore({renderer:e}){if(!1===this.textureNeedsUpdate&&!1===this.autoUpdate)return;if(this.textureNeedsUpdate=!1,!0===this.autoSize){this.pixelRatio=e.getPixelRatio();const t=e.getSize(fF);this.setSize(t.width,t.height)}this._quadMesh.material.fragmentNode=this._rttNode;const t=e.getRenderTarget();e.setRenderTarget(this.renderTarget),this._quadMesh.render(e),e.setRenderTarget(t)}clone(){const e=new UC(this.value,this.uvNode,this.levelNode);return e.sampler=this.sampler,e.referenceNode=this,e}}const mF=(e,...t)=>kA(new pF(kA(e),...t)),gF=VA(([e,t,n],r)=>{let i;r.renderer.coordinateSystem===Ot?(e=KA(e.x,e.y.oneMinus()).mul(2).sub(1),i=iw(ew(e,t),1)):i=iw(ew(e.x,e.y.oneMinus(),t).mul(2).sub(1),1);const s=iw(n.mul(i));return s.xyz.div(s.w)}),vF=VA(([e,t])=>{const n=t.mul(iw(e,1)),r=n.xy.div(n.w).mul(.5).add(.5).toVar();return KA(r.x,r.y.oneMinus())}),yF=VA(([e,t,n])=>{const r=kC(VC(t)),i=QA(e.mul(r)).toVar(),s=VC(t,i).toVar(),a=VC(t,i.sub(QA(2,0))).toVar(),o=VC(t,i.sub(QA(1,0))).toVar(),l=VC(t,i.add(QA(1,0))).toVar(),u=VC(t,i.add(QA(2,0))).toVar(),c=VC(t,i.add(QA(0,2))).toVar(),d=VC(t,i.add(QA(0,1))).toVar(),h=VC(t,i.sub(QA(0,1))).toVar(),f=VC(t,i.sub(QA(0,2))).toVar(),p=KM(iM(jA(2).mul(o).sub(a),s)).toVar(),m=KM(iM(jA(2).mul(l).sub(u),s)).toVar(),g=KM(iM(jA(2).mul(d).sub(c),s)).toVar(),v=KM(iM(jA(2).mul(h).sub(f),s)).toVar(),y=gF(e,s,n).toVar(),b=p.lessThan(m).select(y.sub(gF(e.sub(KA(jA(1).div(r.x),0)),o,n)),y.negate().add(gF(e.add(KA(jA(1).div(r.x),0)),l,n))),_=g.lessThan(v).select(y.sub(gF(e.add(KA(0,jA(1).div(r.y))),d,n)),y.negate().add(gF(e.sub(KA(0,jA(1).div(r.y))),h,n)));return GM(yR(b,_))});class bF extends Ps{constructor(e,t,n=Float32Array){super(ArrayBuffer.isView(e)?e:new n(e*t),t),this.isStorageInstancedBufferAttribute=!0}}class _F extends si{constructor(e,t,n=Float32Array){super(ArrayBuffer.isView(e)?e:new n(e*t),t),this.isStorageBufferAttribute=!0}}class xF extends KE{static get type(){return"StorageArrayElementNode"}constructor(e,t){super(e,t),this.isStorageArrayElementNode=!0}set storageBufferNode(e){this.node=e}get storageBufferNode(){return this.node}setup(e){return!1===e.isAvailable("storageBuffer")&&!0===this.node.isPBO&&e.setupPBO(this.node),super.setup(e)}generate(e,t){let n;const r=e.context.assign;if(n=!1===e.isAvailable("storageBuffer")?!0!==this.node.isPBO||!0===r||!this.node.value.isInstancedBufferAttribute&&"compute"===e.shaderStage?this.node.build(e):e.generatePBO(this):super.generate(e),!0!==r){const r=this.getNodeType(e);n=e.format(n,r,t)}return n}}const SF=UA(xF);class TF extends VI{static get type(){return"StorageBufferNode"}constructor(e,t=null,n=0){null===t&&(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute)&&(t=NE(e.itemSize),n=e.count),super(e,t,n),this.isStorageBufferNode=!0,this.access=HE.READ_WRITE,this.isAtomic=!1,this.isPBO=!1,this._attribute=null,this._varying=null,this.global=!0,!0!==e.isStorageBufferAttribute&&!0!==e.isStorageInstancedBufferAttribute&&(e.isInstancedBufferAttribute?e.isStorageInstancedBufferAttribute=!0:e.isStorageBufferAttribute=!0)}getHash(e){if(0===this.bufferCount){let t=e.globalCache.getData(this.value);return void 0===t&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getInputType(){return this.value.isIndirectStorageBufferAttribute?"indirectStorageBuffer":"storageBuffer"}element(e){return SF(this,e)}setPBO(e){return this.isPBO=e,this}getPBO(){return this.isPBO}setAccess(e){return this.access=e,this}toReadOnly(){return this.setAccess(HE.READ_ONLY)}setAtomic(e){return this.isAtomic=e,this}toAtomic(){return this.setAtomic(!0)}getAttributeData(){return null===this._attribute&&(this._attribute=fC(this.value),this._varying=XR(this._attribute)),{attribute:this._attribute,varying:this._varying}}getNodeType(e){if(e.isAvailable("storageBuffer")||e.isAvailable("indirectStorageBuffer"))return super.getNodeType(e);const{attribute:t}=this.getAttributeData();return t.getNodeType(e)}generate(e){if(e.isAvailable("storageBuffer")||e.isAvailable("indirectStorageBuffer"))return super.generate(e);const{attribute:t,varying:n}=this.getAttributeData(),r=n.build(e);return e.registerTransform(r,t),r}}const EF=(e,t=null,n=0)=>kA(new TF(e,t,n));class AF extends LC{static get type(){return"VertexColorNode"}constructor(e=0){super(null,"vec4"),this.isVertexColorNode=!0,this.index=e}getAttributeName(){const e=this.index;return"color"+(e>0?e:"")}generate(e){const t=this.getAttributeName(e);let n;return n=!0===e.hasGeometryAttribute(t)?super.generate(e):e.generateConst(this.nodeType,new bn(1,1,1,1)),n}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}}class wF extends YE{static get type(){return"PointUVNode"}constructor(){super("vec2"),this.isPointUVNode=!0}generate(){return"vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y )"}}const MF=BA(wF),RF=new dr,CF=new tr;class IF extends YE{static get type(){return"SceneNode"}constructor(e=IF.BACKGROUND_BLURRINESS,t=null){super(),this.scope=e,this.scene=t}setup(e){const t=this.scope,n=null!==this.scene?this.scene:e.scene;let r;return t===IF.BACKGROUND_BLURRINESS?r=qI("backgroundBlurriness","float",n):t===IF.BACKGROUND_INTENSITY?r=qI("backgroundIntensity","float",n):t===IF.BACKGROUND_ROTATION&&(r=_w("mat4").label("backgroundRotation").setGroup(vw).onRenderUpdate(()=>{const e=n.background;return null!==e&&e.isTexture&&e.mapping!==j?(RF.copy(n.backgroundRotation),RF.x*=-1,RF.y*=-1,RF.z*=-1,CF.makeRotationFromEuler(RF)):CF.identity(),CF})),r}}IF.BACKGROUND_BLURRINESS="backgroundBlurriness",IF.BACKGROUND_INTENSITY="backgroundIntensity",IF.BACKGROUND_ROTATION="backgroundRotation";const LF=BA(IF,IF.BACKGROUND_BLURRINESS),PF=BA(IF,IF.BACKGROUND_INTENSITY),NF=BA(IF,IF.BACKGROUND_ROTATION);class DF extends UC{static get type(){return"StorageTextureNode"}constructor(e,t,n=null){super(e,t),this.storeNode=n,this.isStorageTextureNode=!0,this.access=HE.WRITE_ONLY}getInputType(){return"storageTexture"}setup(e){super.setup(e);e.getNodeProperties(this).storeNode=this.storeNode}setAccess(e){return this.access=e,this}generate(e,t){let n;return n=null!==this.storeNode?this.generateStore(e):super.generate(e,t),n}toReadWrite(){return this.setAccess(HE.READ_WRITE)}toReadOnly(){return this.setAccess(HE.READ_ONLY)}toWriteOnly(){return this.setAccess(HE.WRITE_ONLY)}generateStore(e){const t=e.getNodeProperties(this),{uvNode:n,storeNode:r}=t,i=super.generate(e,"property"),s=n.build(e,"uvec2"),a=r.build(e,"vec4"),o=e.generateTextureStore(e,i,s,a);e.addLineFlowCode(o,this)}}const kF=UA(DF);class OF extends jI{static get type(){return"UserDataNode"}constructor(e,t,n=null){super(e,t,n),this.userData=n}updateReference(e){return this.reference=null!==this.userData?this.userData:e.object.userData,this.reference}}const FF=new WeakMap;class UF extends ZE{static get type(){return"VelocityNode"}constructor(){super("vec2"),this.projectionMatrix=null,this.updateType=GE.OBJECT,this.updateAfterType=GE.OBJECT,this.previousModelWorldMatrix=_w(new tr),this.previousProjectionMatrix=_w(new tr).setGroup(vw),this.previousCameraViewMatrix=_w(new tr)}setProjectionMatrix(e){this.projectionMatrix=e}update({frameId:e,camera:t,object:n}){const r=VF(n);this.previousModelWorldMatrix.value.copy(r);const i=BF(t);i.frameId!==e&&(i.frameId=e,void 0===i.previousProjectionMatrix?(i.previousProjectionMatrix=new tr,i.previousCameraViewMatrix=new tr,i.currentProjectionMatrix=new tr,i.currentCameraViewMatrix=new tr,i.previousProjectionMatrix.copy(this.projectionMatrix||t.projectionMatrix),i.previousCameraViewMatrix.copy(t.matrixWorldInverse)):(i.previousProjectionMatrix.copy(i.currentProjectionMatrix),i.previousCameraViewMatrix.copy(i.currentCameraViewMatrix)),i.currentProjectionMatrix.copy(this.projectionMatrix||t.projectionMatrix),i.currentCameraViewMatrix.copy(t.matrixWorldInverse),this.previousProjectionMatrix.value.copy(i.previousProjectionMatrix),this.previousCameraViewMatrix.value.copy(i.previousCameraViewMatrix))}updateAfter({object:e}){VF(e).copy(e.matrixWorld)}setup(){const e=null===this.projectionMatrix?HC:_w(this.projectionMatrix),t=this.previousCameraViewMatrix.mul(this.previousModelWorldMatrix),n=e.mul(uI).mul(pI),r=this.previousProjectionMatrix.mul(t).mul(mI),i=n.xy.div(n.w),s=r.xy.div(r.w);return iM(i,s)}}function BF(e){let t=FF.get(e);return void 0===t&&(t={},FF.set(e,t)),t}function VF(e,t=0){const n=BF(e);let r=n[t];return void 0===r&&(n[t]=r=new tr),r}const zF=BA(UF),GF=VA(([e,t])=>cR(1,e.oneMinus().div(t)).oneMinus()).setLayout({name:"blendBurn",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),HF=VA(([e,t])=>cR(e.div(t.oneMinus()),1)).setLayout({name:"blendDodge",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),$F=VA(([e,t])=>e.oneMinus().mul(t.oneMinus()).oneMinus()).setLayout({name:"blendScreen",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),WF=VA(([e,t])=>wR(e.mul(2).mul(t),e.oneMinus().mul(2).mul(t.oneMinus()).oneMinus(),fR(.5,e))).setLayout({name:"blendOverlay",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),jF=VA(([e,t])=>{const n=t.a.add(e.a.mul(t.a.oneMinus()));return iw(t.rgb.mul(t.a).add(e.rgb.mul(e.a).mul(t.a.oneMinus())).div(n),n)}).setLayout({name:"blendColor",type:"vec4",inputs:[{name:"base",type:"vec4"},{name:"blend",type:"vec4"}]}),qF=VA(([e])=>QF(e.rgb)),XF=VA(([e,t=jA(1)])=>t.mix(QF(e.rgb),e.rgb)),YF=VA(([e,t=jA(1)])=>{const n=rM(e.r,e.g,e.b).div(3),r=e.r.max(e.g.max(e.b)),i=r.sub(n).mul(t).mul(-3);return wR(e.rgb,r,i)}),KF=VA(([e,t=jA(1)])=>{const n=ew(.57735,.57735,.57735),r=t.cos();return ew(e.rgb.mul(r).add(n.cross(e.rgb).mul(t.sin()).add(n.mul(vR(n,e.rgb).mul(r.oneMinus())))))}),QF=(e,t=ew(un.getLuminanceCoefficients(new An)))=>vR(e,t),ZF=VA(([e,t=ew(1),n=ew(0),r=ew(1),i=jA(1),s=ew(un.getLuminanceCoefficients(new An,bt))])=>{const a=e.rgb.dot(ew(s)),o=dR(e.rgb.mul(t).add(n),0).toVar(),l=o.pow(r).toVar();return HA(o.r.greaterThan(0),()=>{o.r.assign(l.r)}),HA(o.g.greaterThan(0),()=>{o.g.assign(l.g)}),HA(o.b.greaterThan(0),()=>{o.b.assign(l.b)}),o.assign(a.add(o.sub(a).mul(i))),iw(o.rgb,e.a)});class JF extends ZE{static get type(){return"PosterizeNode"}constructor(e,t){super(),this.sourceNode=e,this.stepsNode=t}setup(){const{sourceNode:e,stepsNode:t}=this;return e.mul(t).floor().div(t)}}const eU=UA(JF),tU=new Yt;class nU extends UC{static get type(){return"PassTextureNode"}constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}setup(e){return e.object.isQuadMesh&&this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}}class rU extends nU{static get type(){return"PassMultipleTextureNode"}constructor(e,t,n=!1){super(e,null),this.textureName=t,this.previousTexture=n}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(e){return this.updateTexture(),super.setup(e)}clone(){return new this.constructor(this.passNode,this.textureName,this.previousTexture)}}class iU extends ZE{static get type(){return"PassNode"}constructor(e,t,n,r={}){super("vec4"),this.scope=e,this.scene=t,this.camera=n,this.options=r,this._pixelRatio=1,this._width=1,this._height=1;const i=new Fa;i.isRenderTargetTexture=!0,i.name="depth";const s=new _n(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:pe,...r});s.texture.name="output",s.depthTexture=i,this.renderTarget=s,this._textures={output:s.texture,depth:i},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=_w(0),this._cameraFar=_w(0),this._mrt=null,this.isPassNode=!0,this.updateBeforeType=GE.FRAME}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}isGlobal(){return!0}getTexture(e){let t=this._textures[e];if(void 0===t){t=this.renderTarget.texture.clone(),t.name=e,this._textures[e]=t,this.renderTarget.textures.push(t)}return t}getPreviousTexture(e){let t=this._previousTextures[e];return void 0===t&&(t=this.getTexture(e).clone(),this._previousTextures[e]=t),t}toggleTexture(e){const t=this._previousTextures[e];if(void 0!==t){const n=this._textures[e],r=this.renderTarget.textures.indexOf(n);this.renderTarget.textures[r]=t,this._textures[e]=t,this._previousTextures[e]=n,this._textureNodes[e].updateTexture(),this._previousTextureNodes[e].updateTexture()}}getTextureNode(e="output"){let t=this._textureNodes[e];return void 0===t&&(t=kA(new rU(this,e)),t.updateTexture(),this._textureNodes[e]=t),t}getPreviousTextureNode(e="output"){let t=this._previousTextureNodes[e];return void 0===t&&(void 0===this._textureNodes[e]&&this.getTextureNode(e),t=kA(new rU(this,e,!0)),t.updateTexture(),this._previousTextureNodes[e]=t),t}getViewZNode(e="depth"){let t=this._viewZNodes[e];if(void 0===t){const n=this._cameraNear,r=this._cameraFar;this._viewZNodes[e]=t=sN(this.getTextureNode(e),n,r)}return t}getLinearDepthNode(e="depth"){let t=this._linearDepthNodes[e];if(void 0===t){const n=this._cameraNear,r=this._cameraFar,i=this.getViewZNode(e);this._linearDepthNodes[e]=t=rN(i,n,r)}return t}setup({renderer:e}){return this.renderTarget.samples=void 0===this.options.samples?e.samples:this.options.samples,!0===e.backend.isWebGLBackend&&(this.renderTarget.samples=0),this.scope===iU.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(e){const{renderer:t}=e,{scene:n,camera:r}=this;this._pixelRatio=t.getPixelRatio();const i=t.getSize(tU);this.setSize(i.width,i.height);const s=t.getRenderTarget(),a=t.getMRT();this._cameraNear.value=r.near,this._cameraFar.value=r.far;for(const e in this._previousTextures)this.toggleTexture(e);t.setRenderTarget(this.renderTarget),t.setMRT(this._mrt),t.render(n,r),t.setRenderTarget(s),t.setMRT(a)}setSize(e,t){this._width=e,this._height=t;const n=this._width*this._pixelRatio,r=this._height*this._pixelRatio;this.renderTarget.setSize(n,r)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}}iU.COLOR="color",iU.DEPTH="depth";class sU extends iU{static get type(){return"ToonOutlinePassNode"}constructor(e,t,n,r,i){super(iU.COLOR,e,t),this.colorNode=n,this.thicknessNode=r,this.alphaNode=i,this._materialCache=new WeakMap}updateBefore(e){const{renderer:t}=e,n=t.getRenderObjectFunction();t.setRenderObjectFunction((e,n,r,i,s,a,o,l)=>{if((s.isMeshToonMaterial||s.isMeshToonNodeMaterial)&&!1===s.wireframe){const u=this._getOutlineMaterial(s);t.renderObject(e,n,r,i,u,a,o,l)}t.renderObject(e,n,r,i,s,a,o,l)}),super.updateBefore(e),t.setRenderObjectFunction(n)}_createMaterial(){const e=new gN;e.isMeshToonOutlineMaterial=!0,e.name="Toon_Outline",e.side=1;const t=EI.negate(),n=HC.mul(uI),r=jA(1),i=n.mul(iw(pI,1)),s=n.mul(iw(pI.add(t),1)),a=GM(i.sub(s));return e.vertexNode=i.add(a.mul(this.thicknessNode).mul(i.w).mul(r)),e.colorNode=iw(this.colorNode,this.alphaNode),e}_getOutlineMaterial(e){let t=this._materialCache.get(e);return void 0===t&&(t=this._createMaterial(),this._materialCache.set(e,t)),t}}const aU=VA(([e,t])=>e.mul(t).clamp()).setLayout({name:"linearToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),oU=VA(([e,t])=>(e=e.mul(t)).div(e.add(1)).clamp()).setLayout({name:"reinhardToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),lU=VA(([e,t])=>{const n=(e=(e=e.mul(t)).sub(.004).max(0)).mul(e.mul(6.2).add(.5)),r=e.mul(e.mul(6.2).add(1.7)).add(.06);return n.div(r).pow(2.2)}).setLayout({name:"cineonToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),uU=VA(([e])=>{const t=e.mul(e.add(.0245786)).sub(90537e-9),n=e.mul(e.add(.432951).mul(.983729)).add(.238081);return t.div(n)}),cU=VA(([e,t])=>{const n=uw(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),r=uw(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return e=e.mul(t).div(.6),e=n.mul(e),e=uU(e),(e=r.mul(e)).clamp()}).setLayout({name:"acesFilmicToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),dU=uw(ew(1.6605,-.1246,-.0182),ew(-.5876,1.1329,-.1006),ew(-.0728,-.0083,1.1187)),hU=uw(ew(.6274,.0691,.0164),ew(.3293,.9195,.088),ew(.0433,.0113,.8956)),fU=VA(([e])=>{const t=ew(e).toVar(),n=ew(t.mul(t)).toVar(),r=ew(n.mul(n)).toVar();return jA(15.5).mul(r.mul(n)).sub(sM(40.14,r.mul(t))).add(sM(31.96,r).sub(sM(6.868,n.mul(t))).add(sM(.4298,n).add(sM(.1191,t).sub(.00232))))}),pU=VA(([e,t])=>{const n=ew(e).toVar(),r=uw(ew(.856627153315983,.137318972929847,.11189821299995),ew(.0951212405381588,.761241990602591,.0767994186031903),ew(.0482516061458583,.101439036467562,.811302368396859)),i=uw(ew(1.1271005818144368,-.1413297634984383,-.14132976349843826),ew(-.11060664309660323,1.157823702216272,-.11060664309660294),ew(-.016493938717834573,-.016493938717834257,1.2519364065950405)),s=jA(-12.47393),a=jA(4.026069);return n.mulAssign(t),n.assign(hU.mul(n)),n.assign(r.mul(n)),n.assign(dR(n,1e-10)),n.assign(FM(n)),n.assign(n.sub(s).div(a.sub(s))),n.assign(MR(n,0,1)),n.assign(fU(n)),n.assign(i.mul(n)),n.assign(bR(dR(ew(0),n),ew(2.2))),n.assign(dU.mul(n)),n.assign(MR(n,0,1)),n}).setLayout({name:"agxToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),mU=VA(([e,t])=>{const n=jA(.76),r=jA(.15);e=e.mul(t);const i=cR(e.r,cR(e.g,e.b)),s=BR(i.lessThan(.08),i.sub(sM(6.25,i.mul(i))),.04);e.subAssign(s);const a=dR(e.r,dR(e.g,e.b));HA(a.lessThan(n),()=>e);const o=iM(1,n),l=iM(1,o.mul(o).div(a.add(o.sub(n))));e.mulAssign(l.div(a));const u=iM(1,aM(1,r.mul(a.sub(l)).add(1)));return wR(e,ew(l),u)}).setLayout({name:"neutralToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]});class gU extends YE{static get type(){return"CodeNode"}constructor(e="",t=[],n=""){super("code"),this.isCodeNode=!0,this.code=e,this.includes=t,this.language=n}isGlobal(){return!0}setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){const t=this.getIncludes(e);for(const n of t)n.build(e);const n=e.getCodeFromNode(this,this.getNodeType(e));return n.code=this.code,n.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}}const vU=UA(gU);class yU extends gU{static get type(){return"FunctionNode"}constructor(e="",t=[],n=""){super(e,t,n)}getNodeType(e){return this.getNodeFunction(e).type}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){const t=e.getDataFromNode(this);let n=t.nodeFunction;return void 0===n&&(n=e.parser.parseFunction(this.code),t.nodeFunction=n),n}generate(e,t){super.generate(e);const n=this.getNodeFunction(e),r=n.name,i=n.type,s=e.getCodeFromNode(this,i);""!==r&&(s.name=r);const a=e.getPropertyName(s),o=this.getNodeFunction(e).getCode(a);return s.code=o+"\n","property"===t?a:e.format(`${a}()`,i,t)}}const bU=(e,t=[],n="")=>{for(let e=0;e<t.length;e++){const n=t[e];"function"==typeof n&&(t[e]=n.functionNode)}const r=kA(new yU(e,t,n)),i=(...e)=>r.call(...e);return i.functionNode=r,i};class _U extends YE{static get type(){return"ScriptableValueNode"}constructor(e=null){super(),this._value=e,this._cache=null,this.inputType=null,this.outputType=null,this.events=new Ft,this.isScriptableValueNode=!0}get isScriptableOutputNode(){return null!==this.outputType}set value(e){this._value!==e&&(this._cache&&"URL"===this.inputType&&this.value.value instanceof ArrayBuffer&&(URL.revokeObjectURL(this._cache),this._cache=null),this._value=e,this.events.dispatchEvent({type:"change"}),this.refresh())}get value(){return this._value}refresh(){this.events.dispatchEvent({type:"refresh"})}getValue(){const e=this.value;if(e&&null===this._cache&&"URL"===this.inputType&&e.value instanceof ArrayBuffer)this._cache=URL.createObjectURL(new Blob([e.value]));else if(e&&null!==e.value&&void 0!==e.value&&(("URL"===this.inputType||"String"===this.inputType)&&"string"==typeof e.value||"Number"===this.inputType&&"number"==typeof e.value||"Vector2"===this.inputType&&e.value.isVector2||"Vector3"===this.inputType&&e.value.isVector3||"Vector4"===this.inputType&&e.value.isVector4||"Color"===this.inputType&&e.value.isColor||"Matrix3"===this.inputType&&e.value.isMatrix3||"Matrix4"===this.inputType&&e.value.isMatrix4))return e.value;return this._cache||e}getNodeType(e){return this.value&&this.value.isNode?this.value.getNodeType(e):"float"}setup(){return this.value&&this.value.isNode?this.value:jA()}serialize(e){super.serialize(e),null!==this.value?"ArrayBuffer"===this.inputType?e.value=BE(this.value):e.value=this.value?this.value.toJSON(e.meta).uuid:null:e.value=null,e.inputType=this.inputType,e.outputType=this.outputType}deserialize(e){super.deserialize(e);let t=null;null!==e.value&&(t="ArrayBuffer"===e.inputType?VE(e.value):"Texture"===e.inputType?e.meta.textures[e.value]:e.meta.nodes[e.value]||null),this.value=t,this.inputType=e.inputType,this.outputType=e.outputType}}const xU=UA(_U);class SU extends Map{get(e,t=null,...n){if(this.has(e))return super.get(e);if(null!==t){const r=t(...n);return this.set(e,r),r}}}class TU{constructor(e){this.scriptableNode=e}get parameters(){return this.scriptableNode.parameters}get layout(){return this.scriptableNode.getLayout()}getInputLayout(e){return this.scriptableNode.getInputLayout(e)}get(e){const t=this.parameters[e];return t?t.getValue():null}}const EU=new SU;class AU extends YE{static get type(){return"ScriptableNode"}constructor(e=null,t={}){super(),this.codeNode=e,this.parameters=t,this._local=new SU,this._output=xU(),this._outputs={},this._source=this.source,this._method=null,this._object=null,this._value=null,this._needsOutputUpdate=!0,this.onRefresh=this.onRefresh.bind(this),this.isScriptableNode=!0}get source(){return this.codeNode?this.codeNode.code:""}setLocal(e,t){return this._local.set(e,t)}getLocal(e){return this._local.get(e)}onRefresh(){this._refresh()}getInputLayout(e){for(const t of this.getLayout())if(t.inputType&&(t.id===e||t.name===e))return t}getOutputLayout(e){for(const t of this.getLayout())if(t.outputType&&(t.id===e||t.name===e))return t}setOutput(e,t){const n=this._outputs;return void 0===n[e]?n[e]=xU(t):n[e].value=t,this}getOutput(e){return this._outputs[e]}getParameter(e){return this.parameters[e]}setParameter(e,t){const n=this.parameters;return t&&t.isScriptableNode?(this.deleteParameter(e),n[e]=t,n[e].getDefaultOutput().events.addEventListener("refresh",this.onRefresh)):t&&t.isScriptableValueNode?(this.deleteParameter(e),n[e]=t,n[e].events.addEventListener("refresh",this.onRefresh)):void 0===n[e]?(n[e]=xU(t),n[e].events.addEventListener("refresh",this.onRefresh)):n[e].value=t,this}getValue(){return this.getDefaultOutput().getValue()}deleteParameter(e){let t=this.parameters[e];return t&&(t.isScriptableNode&&(t=t.getDefaultOutput()),t.events.removeEventListener("refresh",this.onRefresh)),this}clearParameters(){for(const e of Object.keys(this.parameters))this.deleteParameter(e);return this.needsUpdate=!0,this}call(e,...t){const n=this.getObject()[e];if("function"==typeof n)return n(...t)}async callAsync(e,...t){const n=this.getObject()[e];if("function"==typeof n)return"AsyncFunction"===n.constructor.name?await n(...t):n(...t)}getNodeType(e){return this.getDefaultOutputNode().getNodeType(e)}refresh(e=null){null!==e?this.getOutput(e).refresh():this._refresh()}getObject(){if(this.needsUpdate&&this.dispose(),null!==this._object)return this._object;const e=new TU(this),t=EU.get("THREE"),n=EU.get("TSL"),r=this.getMethod(),i=[e,this._local,EU,()=>this.refresh(),(e,t)=>this.setOutput(e,t),t,n];this._object=r(...i);const s=this._object.layout;if(s&&(!1===s.cache&&this._local.clear(),this._output.outputType=s.outputType||null,Array.isArray(s.elements)))for(const e of s.elements){const t=e.id||e.name;e.inputType&&(void 0===this.getParameter(t)&&this.setParameter(t,null),this.getParameter(t).inputType=e.inputType),e.outputType&&(void 0===this.getOutput(t)&&this.setOutput(t,null),this.getOutput(t).outputType=e.outputType)}return this._object}deserialize(e){super.deserialize(e);for(const e in this.parameters){let t=this.parameters[e];t.isScriptableNode&&(t=t.getDefaultOutput()),t.events.addEventListener("refresh",this.onRefresh)}}getLayout(){return this.getObject().layout}getDefaultOutputNode(){const e=this.getDefaultOutput().value;return e&&e.isNode?e:jA()}getDefaultOutput(){return this._exec()._output}getMethod(){if(this.needsUpdate&&this.dispose(),null!==this._method)return this._method;const e=["layout","init","main","dispose"].join(", "),t="\nreturn { ...output, "+e+" };",n="var "+e+"; var output = {};\n"+this.codeNode.code+t;return this._method=new Function(...["parameters","local","global","refresh","setOutput","THREE","TSL"],n),this._method}dispose(){null!==this._method&&(this._object&&"function"==typeof this._object.dispose&&this._object.dispose(),this._method=null,this._object=null,this._source=null,this._value=null,this._needsOutputUpdate=!0,this._output.value=null,this._outputs={})}setup(){return this.getDefaultOutputNode()}getCacheKey(e){const t=[wE(this.source),this.getDefaultOutputNode().getCacheKey(e)];for(const n in this.parameters)t.push(this.parameters[n].getCacheKey(e));return ME(t)}set needsUpdate(e){!0===e&&this.dispose()}get needsUpdate(){return this.source!==this._source}_exec(){return null===this.codeNode||(!0===this._needsOutputUpdate&&(this._value=this.call("main"),this._needsOutputUpdate=!1),this._output.value=this._value),this}_refresh(){this.needsUpdate=!0,this._exec(),this._output.refresh()}}const wU=UA(AU);function MU(e){let t;const n=e.context.getViewZ;return void 0!==n&&(t=n(this)),(t||yI.z).negate()}const RU=VA(([e,t],n)=>{const r=MU(n);return IR(e,t,r)}),CU=VA(([e],t)=>{const n=MU(t);return e.mul(e,n,n).negate().exp().oneMinus()}),IU=VA(([e,t])=>iw(t.toFloat().mix(Gw.rgb,e.toVec3()),Gw.a));let LU=null,PU=null;class NU extends YE{static get type(){return"RangeNode"}constructor(e=jA(),t=jA()){super(),this.minNode=e,this.maxNode=t}getVectorLength(e){const t=e.getTypeLength(OE(this.minNode.value)),n=e.getTypeLength(OE(this.maxNode.value));return t>n?t:n}getNodeType(e){return e.object.count>1?e.getTypeFromLength(this.getVectorLength(e)):"float"}setup(e){const t=e.object;let n=null;if(t.count>1){const r=this.minNode.value,i=this.maxNode.value,s=e.getTypeLength(OE(r)),a=e.getTypeLength(OE(i));LU=LU||new bn,PU=PU||new bn,LU.setScalar(0),PU.setScalar(0),1===s?LU.setScalar(r):r.isColor?LU.set(r.r,r.g,r.b,1):LU.set(r.x,r.y,r.z||0,r.w||0),1===a?PU.setScalar(i):i.isColor?PU.set(i.r,i.g,i.b,1):PU.set(i.x,i.y,i.z||0,i.w||0);const o=4,l=o*t.count,u=new Float32Array(l);for(let e=0;e<l;e++){const t=e%o,n=LU.getComponent(t),r=PU.getComponent(t);u[e]=Xt.lerp(n,r,Math.random())}const c=this.getNodeType(e);if(t.count<=4096)n=zI(u,"vec4",t.count).element(uP).convert(c);else{const t=new Ps(u,4);e.geometry.setAttribute("__range"+this.id,t),n=mC(t).convert(c)}}else n=jA(0);return n}}const DU=UA(NU);class kU extends YE{static get type(){return"ComputeBuiltinNode"}constructor(e,t){super(t),this._builtinName=e}getHash(e){return this.getBuiltinName(e)}getNodeType(){return this.nodeType}setBuiltinName(e){return this._builtinName=e,this}getBuiltinName(){return this._builtinName}hasBuiltin(e){e.hasBuiltin(this._builtinName)}generate(e,t){const n=this.getBuiltinName(e),r=this.getNodeType(e);return"compute"===e.shaderStage?e.format(n,r,t):e.generateConst(r)}serialize(e){super.serialize(e),e.global=this.global,e._builtinName=this._builtinName}deserialize(e){super.deserialize(e),this.global=e.global,this._builtinName=e._builtinName}}const OU=(e,t)=>kA(new kU(e,t)),FU=OU("numWorkgroups","uvec3"),UU=OU("workgroupId","uvec3"),BU=OU("localId","uvec3"),VU=OU("subgroupSize","uint");const zU=UA(class extends YE{constructor(e){super(),this.scope=e}generate(e){const{scope:t}=this,{renderer:n}=e;!0===n.backend.isWebGLBackend?e.addFlowCode(`\t// ${t}Barrier \n`):e.addLineFlowCode(`${t}Barrier()`,this)}});class GU extends KE{constructor(e,t){super(e,t),this.isWorkgroupInfoElementNode=!0}generate(e,t){let n;const r=e.context.assign;if(n=super.generate(e),!0!==r){const r=this.getNodeType(e);n=e.format(n,r,t)}return n}}class HU extends YE{constructor(e,t,n=0){super(t),this.bufferType=t,this.bufferCount=n,this.isWorkgroupInfoNode=!0,this.elementType=t,this.scope=e}label(e){return this.name=e,this}setScope(e){return this.scope=e,this}getElementType(){return this.elementType}getInputType(){return`${this.scope}Array`}element(e){return kA(new GU(this,e))}generate(e){return e.getScopedArray(this.name||`${this.scope}Array_${this.id}`,this.scope.toLowerCase(),this.bufferType,this.bufferCount)}}class $U extends ZE{static get type(){return"AtomicFunctionNode"}constructor(e,t,n,r=null){super("uint"),this.method=e,this.pointerNode=t,this.valueNode=n,this.storeNode=r}getInputType(e){return this.pointerNode.getNodeType(e)}getNodeType(e){return this.getInputType(e)}generate(e){const t=this.method,n=this.getNodeType(e),r=this.getInputType(e),i=this.pointerNode,s=this.valueNode,a=[];a.push(`&${i.build(e,r)}`),a.push(s.build(e,r));const o=`${e.getMethod(t,n)}( ${a.join(", ")} )`;if(null!==this.storeNode){const t=this.storeNode.build(e,r);e.addLineFlowCode(`${t} = ${o}`,this)}else e.addLineFlowCode(o,this)}}$U.ATOMIC_LOAD="atomicLoad",$U.ATOMIC_STORE="atomicStore",$U.ATOMIC_ADD="atomicAdd",$U.ATOMIC_SUB="atomicSub",$U.ATOMIC_MAX="atomicMax",$U.ATOMIC_MIN="atomicMin",$U.ATOMIC_AND="atomicAnd",$U.ATOMIC_OR="atomicOr",$U.ATOMIC_XOR="atomicXor";const WU=UA($U),jU=(e,t,n,r=null)=>{const i=WU(e,t,n,r);return i.append(),i};let qU;function XU(e){qU=qU||new WeakMap;let t=qU.get(e);return void 0===t&&qU.set(e,t={}),t}function YU(e){const t=XU(e);return t.shadowMatrix||(t.shadowMatrix=_w("mat4").setGroup(vw).onRenderUpdate(()=>(!0!==e.castShadow&&e.shadow.updateMatrices(e),e.shadow.matrix)))}function KU(e){const t=XU(e);if(void 0===t.projectionUV){const n=YU(e).mul(gI);t.projectionUV=n.xyz.div(n.w)}return t.projectionUV}function QU(e){const t=XU(e);return t.position||(t.position=_w(new An).setGroup(vw).onRenderUpdate((t,n)=>n.value.setFromMatrixPosition(e.matrixWorld)))}function ZU(e){const t=XU(e);return t.targetPosition||(t.targetPosition=_w(new An).setGroup(vw).onRenderUpdate((t,n)=>n.value.setFromMatrixPosition(e.target.matrixWorld)))}function JU(e){const t=XU(e);return t.viewPosition||(t.viewPosition=_w(new An).setGroup(vw).onRenderUpdate(({camera:t},n)=>{n.value=n.value||new An,n.value.setFromMatrixPosition(e.matrixWorld),n.value.applyMatrix4(t.matrixWorldInverse)}))}const eB=e=>WC.transformDirection(QU(e).sub(ZU(e))),tB=(e,t)=>{for(const n of t)if(n.isAnalyticLightNode&&n.light.id===e)return n;return null},nB=new WeakMap;class rB extends YE{static get type(){return"LightsNode"}constructor(){super("vec3"),this.totalDiffuseNode=ew().toVar("totalDiffuse"),this.totalSpecularNode=ew().toVar("totalSpecular"),this.outgoingLightNode=ew().toVar("outgoingLight"),this._lights=[],this._lightNodes=null,this._lightNodesHash=null,this.global=!0}customCacheKey(){const e=[],t=this._lights;for(let n=0;n<t.length;n++)e.push(t[n].id);return ME(e)}getHash(e){if(null===this._lightNodesHash){null===this._lightNodes&&this.setupLightsNode(e);const t=[];for(const e of this._lightNodes)t.push(e.getSelf().getHash());this._lightNodesHash="lights-"+t.join(",")}return this._lightNodesHash}analyze(e){const t=e.getDataFromNode(this);for(const n of t.nodes)n.build(e)}setupLightsNode(e){const t=[],n=this._lightNodes,r=(e=>e.sort((e,t)=>e.id-t.id))(this._lights),i=e.renderer.library;for(const e of r)if(e.isNode)t.push(kA(e));else{let r=null;if(null!==n&&(r=tB(e.id,n)),null===r){const n=i.getLightNodeClass(e.constructor);if(null===n)continue;let r=null;nB.has(e)?r=nB.get(e):(r=kA(new n(e)),nB.set(e,r)),t.push(r)}}this._lightNodes=t}setupLights(e,t){for(const n of t)n.build(e)}setup(e){null===this._lightNodes&&this.setupLightsNode(e);const t=e.context,n=t.lightingModel;let r=this.outgoingLightNode;if(n){const{_lightNodes:i,totalDiffuseNode:s,totalSpecularNode:a}=this;t.outgoingLight=r;const o=e.addStack();e.getDataFromNode(this).nodes=o.nodes,n.start(t,o,e),this.setupLights(e,i),n.indirect(t,o,e);const{backdrop:l,backdropAlpha:u}=t,{directDiffuse:c,directSpecular:d,indirectDiffuse:h,indirectSpecular:f}=t.reflectedLight;let p=c.add(h);null!==l&&(p=ew(null!==u?u.mix(p,l):l),t.material.transparent=!0),s.assign(p),a.assign(d.add(f)),r.assign(s.add(a)),n.finish(t,o,e),r=r.bypass(e.removeStack())}return r}setLights(e){return this._lights=e,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}get hasLights(){return this._lights.length>0}}class iB extends YE{static get type(){return"ShadowBaseNode"}constructor(e){super(),this.light=e,this.updateBeforeType=GE.RENDER,this.isShadowBaseNode=!0}setupShadowPosition({material:e}){sB.assign(e.shadowPositionNode||gI)}dispose(){this.updateBeforeType=GE.NONE}}const sB=ew().toVar("shadowPositionWorld");function aB(e,t){return t=function(e,t={}){return t.toneMapping=e.toneMapping,t.toneMappingExposure=e.toneMappingExposure,t.outputColorSpace=e.outputColorSpace,t.renderTarget=e.getRenderTarget(),t.activeCubeFace=e.getActiveCubeFace(),t.activeMipmapLevel=e.getActiveMipmapLevel(),t.renderObjectFunction=e.getRenderObjectFunction(),t.pixelRatio=e.getPixelRatio(),t.mrt=e.getMRT(),t.clearColor=e.getClearColor(t.clearColor||new qr),t.clearAlpha=e.getClearAlpha(),t.autoClear=e.autoClear,t.scissorTest=e.getScissorTest(),t}(e,t),e.setMRT(null),e.setRenderObjectFunction(null),e.setClearColor(0,1),e.autoClear=!0,t}const oB=new WeakMap,lB=VA(([e,t,n])=>{let r=gI.sub(e).length();return r=r.sub(t).div(n.sub(t)),r=r.saturate(),r}),uB=e=>{let t=oB.get(e);if(void 0===t){const n=e.isPointLight?(e=>{const t=e.shadow.camera,n=qI("near","float",t).setGroup(vw),r=qI("far","float",t).setGroup(vw),i=ZC(e);return lB(i,n,r)})(e):null;t=new gN,t.colorNode=iw(0,0,0,1),t.depthNode=n,t.isShadowNodeMaterial=!0,t.name="ShadowMaterial",t.fog=!1,oB.set(e,t)}return t},cB=VA(({depthTexture:e,shadowCoord:t})=>BC(e,t.xy).compare(t.z)),dB=VA(({depthTexture:e,shadowCoord:t,shadow:n})=>{const r=(t,n)=>BC(e,t).compare(n),i=qI("mapSize","vec2",n).setGroup(vw),s=qI("radius","float",n).setGroup(vw),a=KA(1).div(i),o=a.x.negate().mul(s),l=a.y.negate().mul(s),u=a.x.mul(s),c=a.y.mul(s),d=o.div(2),h=l.div(2),f=u.div(2),p=c.div(2);return rM(r(t.xy.add(KA(o,l)),t.z),r(t.xy.add(KA(0,l)),t.z),r(t.xy.add(KA(u,l)),t.z),r(t.xy.add(KA(d,h)),t.z),r(t.xy.add(KA(0,h)),t.z),r(t.xy.add(KA(f,h)),t.z),r(t.xy.add(KA(o,0)),t.z),r(t.xy.add(KA(d,0)),t.z),r(t.xy,t.z),r(t.xy.add(KA(f,0)),t.z),r(t.xy.add(KA(u,0)),t.z),r(t.xy.add(KA(d,p)),t.z),r(t.xy.add(KA(0,p)),t.z),r(t.xy.add(KA(f,p)),t.z),r(t.xy.add(KA(o,c)),t.z),r(t.xy.add(KA(0,c)),t.z),r(t.xy.add(KA(u,c)),t.z)).mul(1/17)}),hB=VA(({depthTexture:e,shadowCoord:t,shadow:n})=>{const r=(t,n)=>BC(e,t).compare(n),i=qI("mapSize","vec2",n).setGroup(vw),s=KA(1).div(i),a=s.x,o=s.y,l=t.xy,u=HM(l.mul(i).add(.5));return l.subAssign(u.mul(s)),rM(r(l,t.z),r(l.add(KA(a,0)),t.z),r(l.add(KA(0,o)),t.z),r(l.add(s),t.z),wR(r(l.add(KA(a.negate(),0)),t.z),r(l.add(KA(a.mul(2),0)),t.z),u.x),wR(r(l.add(KA(a.negate(),o)),t.z),r(l.add(KA(a.mul(2),o)),t.z),u.x),wR(r(l.add(KA(0,o.negate())),t.z),r(l.add(KA(0,o.mul(2))),t.z),u.y),wR(r(l.add(KA(a,o.negate())),t.z),r(l.add(KA(a,o.mul(2))),t.z),u.y),wR(wR(r(l.add(KA(a.negate(),o.negate())),t.z),r(l.add(KA(a.mul(2),o.negate())),t.z),u.x),wR(r(l.add(KA(a.negate(),o.mul(2))),t.z),r(l.add(KA(a.mul(2),o.mul(2))),t.z),u.x),u.y)).mul(1/9)}),fB=VA(({depthTexture:e,shadowCoord:t})=>{const n=jA(1).toVar(),r=BC(e).sample(t.xy).rg,i=fR(t.z,r.x);return HA(i.notEqual(jA(1)),()=>{const e=t.z.sub(r.x),s=dR(0,r.y.mul(r.y));let a=s.div(s.add(e.mul(e)));a=MR(iM(a,.3).div(.95-.3)),n.assign(MR(dR(i,a)))}),n}),pB=VA(({samples:e,radius:t,size:n,shadowPass:r})=>{const i=jA(0).toVar(),s=jA(0).toVar(),a=e.lessThanEqual(jA(1)).select(jA(0),jA(2).div(e.sub(1))),o=e.lessThanEqual(jA(1)).select(jA(0),jA(-1));EP({start:qA(0),end:qA(e),type:"int",condition:"<"},({i:e})=>{const l=o.add(jA(e).mul(a)),u=r.sample(rM(zP.xy,KA(0,l).mul(t)).div(n)).x;i.addAssign(u),s.addAssign(u.mul(u))}),i.divAssign(e),s.divAssign(e);const l=UM(s.sub(i.mul(i)));return KA(i,l)}),mB=VA(({samples:e,radius:t,size:n,shadowPass:r})=>{const i=jA(0).toVar(),s=jA(0).toVar(),a=e.lessThanEqual(jA(1)).select(jA(0),jA(2).div(e.sub(1))),o=e.lessThanEqual(jA(1)).select(jA(0),jA(-1));EP({start:qA(0),end:qA(e),type:"int",condition:"<"},({i:e})=>{const l=o.add(jA(e).mul(a)),u=r.sample(rM(zP.xy,KA(l,0).mul(t)).div(n));i.addAssign(u.x),s.addAssign(rM(u.y.mul(u.y),u.x.mul(u.x)))}),i.divAssign(e),s.divAssign(e);const l=UM(s.sub(i.mul(i)));return KA(i,l)}),gB=[cB,dB,hB,fB];let vB;const yB=new hF;class bB extends iB{static get type(){return"ShadowNode"}constructor(e,t=null){super(e),this.shadow=t||e.shadow,this.shadowMap=null,this.vsmShadowMapVertical=null,this.vsmShadowMapHorizontal=null,this.vsmMaterialVertical=null,this.vsmMaterialHorizontal=null,this._node=null,this.isShadowNode=!0}setupShadowFilter(e,{filterFn:t,depthTexture:n,shadowCoord:r,shadow:i}){const s=r.x.greaterThanEqual(0).and(r.x.lessThanEqual(1)).and(r.y.greaterThanEqual(0)).and(r.y.lessThanEqual(1)).and(r.z.lessThanEqual(1)),a=t({depthTexture:n,shadowCoord:r,shadow:i});return s.select(a,jA(1))}setupShadowCoord(e,t){const{shadow:n}=this,{renderer:r}=e,i=qI("bias","float",n).setGroup(vw);let s,a=t;if(n.camera.isOrthographicCamera||!0!==r.logarithmicDepthBuffer)a=a.xyz.div(a.w),s=a.z,r.coordinateSystem===Ot&&(s=s.mul(2).sub(1));else{const e=a.w;a=a.xy.div(e);const t=qI("near","float",n.camera).setGroup(vw),r=qI("far","float",n.camera).setGroup(vw);s=aN(e.negate(),t,r)}return a=ew(a.x,a.y.oneMinus(),s.add(i)),a}getShadowFilterFn(e){return gB[e]}setupShadow(e){const{renderer:t}=e,{light:n,shadow:r}=this,i=t.shadowMap.type,s=new Fa(r.mapSize.width,r.mapSize.height);s.compareFunction=At;const a=e.createRenderTarget(r.mapSize.width,r.mapSize.height);if(a.depthTexture=s,r.camera.updateProjectionMatrix(),3===i){s.compareFunction=null,this.vsmShadowMapVertical=e.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:Re,type:pe}),this.vsmShadowMapHorizontal=e.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:Re,type:pe});const t=BC(s),n=BC(this.vsmShadowMapVertical.texture),i=qI("blurSamples","float",r).setGroup(vw),a=qI("radius","float",r).setGroup(vw),o=qI("mapSize","vec2",r).setGroup(vw);let l=this.vsmMaterialVertical||(this.vsmMaterialVertical=new gN);l.fragmentNode=pB({samples:i,radius:a,size:o,shadowPass:t}).context(e.getSharedContext()),l.name="VSMVertical",l=this.vsmMaterialHorizontal||(this.vsmMaterialHorizontal=new gN),l.fragmentNode=mB({samples:i,radius:a,size:o,shadowPass:n}).context(e.getSharedContext()),l.name="VSMHorizontal"}const o=qI("intensity","float",r).setGroup(vw),l=qI("normalBias","float",r).setGroup(vw),u=YU(n).mul(sB.add(CI.mul(l))),c=this.setupShadowCoord(e,u),d=r.filterNode||this.getShadowFilterFn(t.shadowMap.type)||null;if(null===d)throw new Error("THREE.WebGPURenderer: Shadow map type not supported yet.");const h=3===i?this.vsmShadowMapHorizontal.texture:s,f=this.setupShadowFilter(e,{filterFn:d,shadowTexture:a.texture,depthTexture:h,shadowCoord:c,shadow:r}),p=BC(a.texture,c),m=wR(1,f.rgb.mix(p,1),o.mul(p.a)).toVar();return this.shadowMap=a,this.shadow.map=a,m}setup(e){if(!1!==e.renderer.shadowMap.enabled)return VA(()=>{let t=this._node;return this.setupShadowPosition(e),null===t&&(this._node=t=this.setupShadow(e)),e.material.shadowNode,e.material.receivedShadowNode&&(t=e.material.receivedShadowNode(t)),t})()}renderShadow(e){const{shadow:t,shadowMap:n,light:r}=this,{renderer:i,scene:s}=e;t.updateMatrices(r),n.setSize(t.mapSize.width,t.mapSize.height),i.render(s,t.camera)}updateShadow(e){const{shadowMap:t,light:n,shadow:r}=this,{renderer:i,scene:s,camera:a}=e,o=i.shadowMap.type,l=t.depthTexture.version;this._depthVersionCached=l,r.camera.layers.mask=a.layers.mask;const u=i.getRenderObjectFunction(),c=i.getMRT(),d=!!c&&c.has("velocity");vB=function(e,t,n){return n=function(e,t){return t=function(e,t={}){return t.background=e.background,t.backgroundNode=e.backgroundNode,t.overrideMaterial=e.overrideMaterial,t}(e,t),e.background=null,e.backgroundNode=null,e.overrideMaterial=null,t}(t,n=aB(e,n)),n}(i,s,vB),s.overrideMaterial=uB(n),i.setRenderObjectFunction((e,t,n,s,l,u,...c)=>{(!0===e.castShadow||e.receiveShadow&&3===o)&&(d&&(UE(e).useVelocity=!0),e.onBeforeShadow(i,e,a,r.camera,s,t.overrideMaterial,u),i.renderObject(e,t,n,s,l,u,...c),e.onAfterShadow(i,e,a,r.camera,s,t.overrideMaterial,u))}),i.setRenderTarget(t),this.renderShadow(e),i.setRenderObjectFunction(u),!0!==n.isPointLight&&3===o&&this.vsmPass(i),function(e,t,n){!function(e,t){e.toneMapping=t.toneMapping,e.toneMappingExposure=t.toneMappingExposure,e.outputColorSpace=t.outputColorSpace,e.setRenderTarget(t.renderTarget,t.activeCubeFace,t.activeMipmapLevel),e.setRenderObjectFunction(t.renderObjectFunction),e.setPixelRatio(t.pixelRatio),e.setMRT(t.mrt),e.setClearColor(t.clearColor,t.clearAlpha),e.autoClear=t.autoClear,e.setScissorTest(t.scissorTest)}(e,n),function(e,t){e.background=t.background,e.backgroundNode=t.backgroundNode,e.overrideMaterial=t.overrideMaterial}(t,n)}(i,s,vB)}vsmPass(e){const{shadow:t}=this;this.vsmShadowMapVertical.setSize(t.mapSize.width,t.mapSize.height),this.vsmShadowMapHorizontal.setSize(t.mapSize.width,t.mapSize.height),e.setRenderTarget(this.vsmShadowMapVertical),yB.material=this.vsmMaterialVertical,yB.render(e),e.setRenderTarget(this.vsmShadowMapHorizontal),yB.material=this.vsmMaterialHorizontal,yB.render(e)}dispose(){this.shadowMap.dispose(),this.shadowMap=null,null!==this.vsmShadowMapVertical&&(this.vsmShadowMapVertical.dispose(),this.vsmShadowMapVertical=null,this.vsmMaterialVertical.dispose(),this.vsmMaterialVertical=null),null!==this.vsmShadowMapHorizontal&&(this.vsmShadowMapHorizontal.dispose(),this.vsmShadowMapHorizontal=null,this.vsmMaterialHorizontal.dispose(),this.vsmMaterialHorizontal=null),super.dispose()}updateBefore(e){const{shadow:t}=this;(t.needsUpdate||t.autoUpdate)&&(this.updateShadow(e),this.shadowMap.depthTexture.version===this._depthVersionCached&&(t.needsUpdate=!1))}}const _B=(e,t)=>kA(new bB(e,t));class xB extends LP{static get type(){return"AnalyticLightNode"}constructor(e=null){super(),this.light=e,this.color=new qr,this.colorNode=e&&e.colorNode||_w(this.color).setGroup(vw),this.baseColorNode=null,this.shadowNode=null,this.shadowColorNode=null,this.isAnalyticLightNode=!0,this.updateType=GE.FRAME}customCacheKey(){return RE(this.light.id,this.light.castShadow?1:0)}getHash(){return this.light.uuid}setupShadowNode(){return _B(this.light)}setupShadow(e){const{renderer:t}=e;if(!1===t.shadowMap.enabled)return;let n=this.shadowColorNode;if(null===n){const t=this.light.shadow.shadowNode;let r;r=void 0!==t?kA(t):this.setupShadowNode(e),this.shadowNode=r,this.shadowColorNode=n=this.colorNode.mul(r),this.baseColorNode=this.colorNode}this.colorNode=n}setup(e){this.colorNode=this.baseColorNode||this.colorNode,this.light.castShadow?e.object.receiveShadow&&this.setupShadow(e):null!==this.shadowNode&&(this.shadowNode.dispose(),this.shadowNode=null,this.shadowColorNode=null)}update(){const{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}}const SB=VA(e=>{const{lightDistance:t,cutoffDistance:n,decayExponent:r}=e,i=t.pow(r).max(.01).reciprocal();return n.greaterThan(0).select(i.mul(t.div(n).pow4().oneMinus().clamp().pow2()),i)}),TB=new qr,EB=VA(([e,t])=>{const n=e.toVar(),r=KM(n),i=aM(1,dR(r.x,dR(r.y,r.z)));r.mulAssign(i),n.mulAssign(i.mul(t.mul(2).oneMinus()));const s=KA(n.xy).toVar(),a=t.mul(1.5).oneMinus();return HA(r.z.greaterThanEqual(a),()=>{HA(n.z.greaterThan(0),()=>{s.x.assign(iM(4,n.x))})}).ElseIf(r.x.greaterThanEqual(a),()=>{const e=QM(n.x);s.x.assign(n.z.mul(e).add(e.mul(2)))}).ElseIf(r.y.greaterThanEqual(a),()=>{const e=QM(n.y);s.x.assign(n.x.add(e.mul(2)).add(2)),s.y.assign(n.z.mul(e).sub(2))}),KA(.125,.25).mul(s).add(KA(.375,.75)).flipY()}).setLayout({name:"cubeToUV",type:"vec2",inputs:[{name:"pos",type:"vec3"},{name:"texelSizeY",type:"float"}]}),AB=VA(({depthTexture:e,bd3D:t,dp:n,texelSize:r})=>BC(e,EB(t,r.y)).compare(n)),wB=VA(({depthTexture:e,bd3D:t,dp:n,texelSize:r,shadow:i})=>{const s=qI("radius","float",i).setGroup(vw),a=KA(-1,1).mul(s).mul(r.y);return BC(e,EB(t.add(a.xyy),r.y)).compare(n).add(BC(e,EB(t.add(a.yyy),r.y)).compare(n)).add(BC(e,EB(t.add(a.xyx),r.y)).compare(n)).add(BC(e,EB(t.add(a.yyx),r.y)).compare(n)).add(BC(e,EB(t,r.y)).compare(n)).add(BC(e,EB(t.add(a.xxy),r.y)).compare(n)).add(BC(e,EB(t.add(a.yxy),r.y)).compare(n)).add(BC(e,EB(t.add(a.xxx),r.y)).compare(n)).add(BC(e,EB(t.add(a.yxx),r.y)).compare(n)).mul(1/9)}),MB=VA(({filterFn:e,depthTexture:t,shadowCoord:n,shadow:r})=>{const i=n.xyz.toVar(),s=i.length(),a=_w("float").setGroup(vw).onRenderUpdate(()=>r.camera.near),o=_w("float").setGroup(vw).onRenderUpdate(()=>r.camera.far),l=qI("bias","float",r).setGroup(vw),u=_w(r.mapSize).setGroup(vw),c=jA(1).toVar();return HA(s.sub(o).lessThanEqual(0).and(s.sub(a).greaterThanEqual(0)),()=>{const n=s.sub(a).div(o.sub(a)).toVar();n.addAssign(l);const d=i.normalize(),h=KA(1).div(u.mul(KA(4,2)));c.assign(e({depthTexture:t,bd3D:d,dp:n,texelSize:h,shadow:r}))}),c}),RB=new bn,CB=new Yt,IB=new Yt;class LB extends bB{static get type(){return"PointShadowNode"}constructor(e,t=null){super(e,t)}getShadowFilterFn(e){return 0===e?AB:wB}setupShadowCoord(e,t){return t}setupShadowFilter(e,{filterFn:t,shadowTexture:n,depthTexture:r,shadowCoord:i,shadow:s}){return MB({filterFn:t,shadowTexture:n,depthTexture:r,shadowCoord:i,shadow:s})}renderShadow(e){const{shadow:t,shadowMap:n,light:r}=this,{renderer:i,scene:s}=e,a=t.getFrameExtents();IB.copy(t.mapSize),IB.multiply(a),n.setSize(IB.width,IB.height),CB.copy(t.mapSize);const o=i.autoClear,l=i.getClearColor(TB),u=i.getClearAlpha();i.autoClear=!1,i.setClearColor(t.clearColor,t.clearAlpha),i.clear();const c=t.getViewportCount();for(let e=0;e<c;e++){const a=t.getViewport(e),o=CB.x*a.x,l=IB.y-CB.y-CB.y*a.y;RB.set(o,l,CB.x*a.z,CB.y*a.w),n.viewport.copy(RB),t.updateMatrices(r,e),i.render(s,t.camera)}i.autoClear=o,i.setClearColor(l,u)}}const PB=VA(({color:e,lightViewPosition:t,cutoffDistance:n,decayExponent:r},i)=>{const s=i.context.lightingModel,a=t.sub(yI),o=a.normalize(),l=a.length(),u=SB({lightDistance:l,cutoffDistance:n,decayExponent:r}),c=e.mul(u),d=i.context.reflectedLight;s.direct({lightDirection:o,lightColor:c,reflectedLight:d},i.stack,i)});class NB extends xB{static get type(){return"PointLightNode"}constructor(e=null){super(e),this.cutoffDistanceNode=_w(0).setGroup(vw),this.decayExponentNode=_w(2).setGroup(vw)}update(e){const{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setupShadowNode(){return((e,t)=>kA(new LB(e,t)))(this.light)}setup(e){super.setup(e),PB({color:this.colorNode,lightViewPosition:JU(this.light),cutoffDistance:this.cutoffDistanceNode,decayExponent:this.decayExponentNode}).append()}}const DB=VA(([e=NC()])=>{const t=e.mul(2),n=t.x.floor(),r=t.y.floor();return n.add(r).mod(2).sign()}),kB=VA(([e,t,n])=>{const r=jA(n).toVar(),i=jA(t).toVar(),s=YA(e).toVar();return BR(s,i,r)}).setLayout({name:"mx_select",type:"float",inputs:[{name:"b",type:"bool"},{name:"t",type:"float"},{name:"f",type:"float"}]}),OB=VA(([e,t])=>{const n=YA(t).toVar(),r=jA(e).toVar();return BR(n,r.negate(),r)}).setLayout({name:"mx_negate_if",type:"float",inputs:[{name:"val",type:"float"},{name:"b",type:"bool"}]}),FB=VA(([e])=>{const t=jA(e).toVar();return qA(VM(t))}).setLayout({name:"mx_floor",type:"int",inputs:[{name:"x",type:"float"}]}),UB=VA(([e,t])=>{const n=jA(e).toVar();return t.assign(FB(n)),n.sub(jA(t))}),BB=kO([VA(([e,t,n,r,i,s])=>{const a=jA(s).toVar(),o=jA(i).toVar(),l=jA(r).toVar(),u=jA(n).toVar(),c=jA(t).toVar(),d=jA(e).toVar(),h=jA(iM(1,o)).toVar();return iM(1,a).mul(d.mul(h).add(c.mul(o))).add(a.mul(u.mul(h).add(l.mul(o))))}).setLayout({name:"mx_bilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"}]}),VA(([e,t,n,r,i,s])=>{const a=jA(s).toVar(),o=jA(i).toVar(),l=ew(r).toVar(),u=ew(n).toVar(),c=ew(t).toVar(),d=ew(e).toVar(),h=jA(iM(1,o)).toVar();return iM(1,a).mul(d.mul(h).add(c.mul(o))).add(a.mul(u.mul(h).add(l.mul(o))))}).setLayout({name:"mx_bilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"}]})]),VB=kO([VA(([e,t,n,r,i,s,a,o,l,u,c])=>{const d=jA(c).toVar(),h=jA(u).toVar(),f=jA(l).toVar(),p=jA(o).toVar(),m=jA(a).toVar(),g=jA(s).toVar(),v=jA(i).toVar(),y=jA(r).toVar(),b=jA(n).toVar(),_=jA(t).toVar(),x=jA(e).toVar(),S=jA(iM(1,f)).toVar(),T=jA(iM(1,h)).toVar();return jA(iM(1,d)).toVar().mul(T.mul(x.mul(S).add(_.mul(f))).add(h.mul(b.mul(S).add(y.mul(f))))).add(d.mul(T.mul(v.mul(S).add(g.mul(f))).add(h.mul(m.mul(S).add(p.mul(f))))))}).setLayout({name:"mx_trilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"v4",type:"float"},{name:"v5",type:"float"},{name:"v6",type:"float"},{name:"v7",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]}),VA(([e,t,n,r,i,s,a,o,l,u,c])=>{const d=jA(c).toVar(),h=jA(u).toVar(),f=jA(l).toVar(),p=ew(o).toVar(),m=ew(a).toVar(),g=ew(s).toVar(),v=ew(i).toVar(),y=ew(r).toVar(),b=ew(n).toVar(),_=ew(t).toVar(),x=ew(e).toVar(),S=jA(iM(1,f)).toVar(),T=jA(iM(1,h)).toVar();return jA(iM(1,d)).toVar().mul(T.mul(x.mul(S).add(_.mul(f))).add(h.mul(b.mul(S).add(y.mul(f))))).add(d.mul(T.mul(v.mul(S).add(g.mul(f))).add(h.mul(m.mul(S).add(p.mul(f))))))}).setLayout({name:"mx_trilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"v4",type:"vec3"},{name:"v5",type:"vec3"},{name:"v6",type:"vec3"},{name:"v7",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]})]),zB=VA(([e,t,n])=>{const r=jA(n).toVar(),i=jA(t).toVar(),s=XA(e).toVar(),a=XA(s.bitAnd(XA(7))).toVar(),o=jA(kB(a.lessThan(XA(4)),i,r)).toVar(),l=jA(sM(2,kB(a.lessThan(XA(4)),r,i))).toVar();return OB(o,YA(a.bitAnd(XA(1)))).add(OB(l,YA(a.bitAnd(XA(2)))))}).setLayout({name:"mx_gradient_float_0",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"}]}),GB=VA(([e,t,n,r])=>{const i=jA(r).toVar(),s=jA(n).toVar(),a=jA(t).toVar(),o=XA(e).toVar(),l=XA(o.bitAnd(XA(15))).toVar(),u=jA(kB(l.lessThan(XA(8)),a,s)).toVar(),c=jA(kB(l.lessThan(XA(4)),s,kB(l.equal(XA(12)).or(l.equal(XA(14))),a,i))).toVar();return OB(u,YA(l.bitAnd(XA(1)))).add(OB(c,YA(l.bitAnd(XA(2)))))}).setLayout({name:"mx_gradient_float_1",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),HB=kO([zB,GB]),$B=VA(([e,t,n])=>{const r=jA(n).toVar(),i=jA(t).toVar(),s=nw(e).toVar();return ew(HB(s.x,i,r),HB(s.y,i,r),HB(s.z,i,r))}).setLayout({name:"mx_gradient_vec3_0",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"}]}),WB=VA(([e,t,n,r])=>{const i=jA(r).toVar(),s=jA(n).toVar(),a=jA(t).toVar(),o=nw(e).toVar();return ew(HB(o.x,a,s,i),HB(o.y,a,s,i),HB(o.z,a,s,i))}).setLayout({name:"mx_gradient_vec3_1",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),jB=kO([$B,WB]),qB=VA(([e])=>{const t=jA(e).toVar();return sM(.6616,t)}).setLayout({name:"mx_gradient_scale2d_0",type:"float",inputs:[{name:"v",type:"float"}]}),XB=VA(([e])=>{const t=jA(e).toVar();return sM(.982,t)}).setLayout({name:"mx_gradient_scale3d_0",type:"float",inputs:[{name:"v",type:"float"}]}),YB=kO([qB,VA(([e])=>{const t=ew(e).toVar();return sM(.6616,t)}).setLayout({name:"mx_gradient_scale2d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),KB=kO([XB,VA(([e])=>{const t=ew(e).toVar();return sM(.982,t)}).setLayout({name:"mx_gradient_scale3d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),QB=VA(([e,t])=>{const n=qA(t).toVar(),r=XA(e).toVar();return r.shiftLeft(n).bitOr(r.shiftRight(qA(32).sub(n)))}).setLayout({name:"mx_rotl32",type:"uint",inputs:[{name:"x",type:"uint"},{name:"k",type:"int"}]}),ZB=VA(([e,t,n])=>{e.subAssign(n),e.bitXorAssign(QB(n,qA(4))),n.addAssign(t),t.subAssign(e),t.bitXorAssign(QB(e,qA(6))),e.addAssign(n),n.subAssign(t),n.bitXorAssign(QB(t,qA(8))),t.addAssign(e),e.subAssign(n),e.bitXorAssign(QB(n,qA(16))),n.addAssign(t),t.subAssign(e),t.bitXorAssign(QB(e,qA(19))),e.addAssign(n),n.subAssign(t),n.bitXorAssign(QB(t,qA(4))),t.addAssign(e)}),JB=VA(([e,t,n])=>{const r=XA(n).toVar(),i=XA(t).toVar(),s=XA(e).toVar();return r.bitXorAssign(i),r.subAssign(QB(i,qA(14))),s.bitXorAssign(r),s.subAssign(QB(r,qA(11))),i.bitXorAssign(s),i.subAssign(QB(s,qA(25))),r.bitXorAssign(i),r.subAssign(QB(i,qA(16))),s.bitXorAssign(r),s.subAssign(QB(r,qA(4))),i.bitXorAssign(s),i.subAssign(QB(s,qA(14))),r.bitXorAssign(i),r.subAssign(QB(i,qA(24))),r}).setLayout({name:"mx_bjfinal",type:"uint",inputs:[{name:"a",type:"uint"},{name:"b",type:"uint"},{name:"c",type:"uint"}]}),eV=VA(([e])=>{const t=XA(e).toVar();return jA(t).div(jA(XA(qA(4294967295))))}).setLayout({name:"mx_bits_to_01",type:"float",inputs:[{name:"bits",type:"uint"}]}),tV=VA(([e])=>{const t=jA(e).toVar();return t.mul(t).mul(t).mul(t.mul(t.mul(6).sub(15)).add(10))}).setLayout({name:"mx_fade",type:"float",inputs:[{name:"t",type:"float"}]}),nV=kO([VA(([e])=>{const t=qA(e).toVar(),n=XA(XA(1)).toVar(),r=XA(XA(qA(3735928559)).add(n.shiftLeft(XA(2))).add(XA(13))).toVar();return JB(r.add(XA(t)),r,r)}).setLayout({name:"mx_hash_int_0",type:"uint",inputs:[{name:"x",type:"int"}]}),VA(([e,t])=>{const n=qA(t).toVar(),r=qA(e).toVar(),i=XA(XA(2)).toVar(),s=XA().toVar(),a=XA().toVar(),o=XA().toVar();return s.assign(a.assign(o.assign(XA(qA(3735928559)).add(i.shiftLeft(XA(2))).add(XA(13))))),s.addAssign(XA(r)),a.addAssign(XA(n)),JB(s,a,o)}).setLayout({name:"mx_hash_int_1",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),VA(([e,t,n])=>{const r=qA(n).toVar(),i=qA(t).toVar(),s=qA(e).toVar(),a=XA(XA(3)).toVar(),o=XA().toVar(),l=XA().toVar(),u=XA().toVar();return o.assign(l.assign(u.assign(XA(qA(3735928559)).add(a.shiftLeft(XA(2))).add(XA(13))))),o.addAssign(XA(s)),l.addAssign(XA(i)),u.addAssign(XA(r)),JB(o,l,u)}).setLayout({name:"mx_hash_int_2",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]}),VA(([e,t,n,r])=>{const i=qA(r).toVar(),s=qA(n).toVar(),a=qA(t).toVar(),o=qA(e).toVar(),l=XA(XA(4)).toVar(),u=XA().toVar(),c=XA().toVar(),d=XA().toVar();return u.assign(c.assign(d.assign(XA(qA(3735928559)).add(l.shiftLeft(XA(2))).add(XA(13))))),u.addAssign(XA(o)),c.addAssign(XA(a)),d.addAssign(XA(s)),ZB(u,c,d),u.addAssign(XA(i)),JB(u,c,d)}).setLayout({name:"mx_hash_int_3",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"}]}),VA(([e,t,n,r,i])=>{const s=qA(i).toVar(),a=qA(r).toVar(),o=qA(n).toVar(),l=qA(t).toVar(),u=qA(e).toVar(),c=XA(XA(5)).toVar(),d=XA().toVar(),h=XA().toVar(),f=XA().toVar();return d.assign(h.assign(f.assign(XA(qA(3735928559)).add(c.shiftLeft(XA(2))).add(XA(13))))),d.addAssign(XA(u)),h.addAssign(XA(l)),f.addAssign(XA(o)),ZB(d,h,f),d.addAssign(XA(a)),h.addAssign(XA(s)),JB(d,h,f)}).setLayout({name:"mx_hash_int_4",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"},{name:"yy",type:"int"}]})]),rV=kO([VA(([e,t])=>{const n=qA(t).toVar(),r=qA(e).toVar(),i=XA(nV(r,n)).toVar(),s=nw().toVar();return s.x.assign(i.bitAnd(qA(255))),s.y.assign(i.shiftRight(qA(8)).bitAnd(qA(255))),s.z.assign(i.shiftRight(qA(16)).bitAnd(qA(255))),s}).setLayout({name:"mx_hash_vec3_0",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),VA(([e,t,n])=>{const r=qA(n).toVar(),i=qA(t).toVar(),s=qA(e).toVar(),a=XA(nV(s,i,r)).toVar(),o=nw().toVar();return o.x.assign(a.bitAnd(qA(255))),o.y.assign(a.shiftRight(qA(8)).bitAnd(qA(255))),o.z.assign(a.shiftRight(qA(16)).bitAnd(qA(255))),o}).setLayout({name:"mx_hash_vec3_1",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]})]),iV=VA(([e])=>{const t=KA(e).toVar(),n=qA().toVar(),r=qA().toVar(),i=jA(UB(t.x,n)).toVar(),s=jA(UB(t.y,r)).toVar(),a=jA(tV(i)).toVar(),o=jA(tV(s)).toVar(),l=jA(BB(HB(nV(n,r),i,s),HB(nV(n.add(qA(1)),r),i.sub(1),s),HB(nV(n,r.add(qA(1))),i,s.sub(1)),HB(nV(n.add(qA(1)),r.add(qA(1))),i.sub(1),s.sub(1)),a,o)).toVar();return YB(l)}).setLayout({name:"mx_perlin_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"}]}),sV=VA(([e])=>{const t=ew(e).toVar(),n=qA().toVar(),r=qA().toVar(),i=qA().toVar(),s=jA(UB(t.x,n)).toVar(),a=jA(UB(t.y,r)).toVar(),o=jA(UB(t.z,i)).toVar(),l=jA(tV(s)).toVar(),u=jA(tV(a)).toVar(),c=jA(tV(o)).toVar(),d=jA(VB(HB(nV(n,r,i),s,a,o),HB(nV(n.add(qA(1)),r,i),s.sub(1),a,o),HB(nV(n,r.add(qA(1)),i),s,a.sub(1),o),HB(nV(n.add(qA(1)),r.add(qA(1)),i),s.sub(1),a.sub(1),o),HB(nV(n,r,i.add(qA(1))),s,a,o.sub(1)),HB(nV(n.add(qA(1)),r,i.add(qA(1))),s.sub(1),a,o.sub(1)),HB(nV(n,r.add(qA(1)),i.add(qA(1))),s,a.sub(1),o.sub(1)),HB(nV(n.add(qA(1)),r.add(qA(1)),i.add(qA(1))),s.sub(1),a.sub(1),o.sub(1)),l,u,c)).toVar();return KB(d)}).setLayout({name:"mx_perlin_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"}]}),aV=kO([iV,sV]),oV=VA(([e])=>{const t=KA(e).toVar(),n=qA().toVar(),r=qA().toVar(),i=jA(UB(t.x,n)).toVar(),s=jA(UB(t.y,r)).toVar(),a=jA(tV(i)).toVar(),o=jA(tV(s)).toVar(),l=ew(BB(jB(rV(n,r),i,s),jB(rV(n.add(qA(1)),r),i.sub(1),s),jB(rV(n,r.add(qA(1))),i,s.sub(1)),jB(rV(n.add(qA(1)),r.add(qA(1))),i.sub(1),s.sub(1)),a,o)).toVar();return YB(l)}).setLayout({name:"mx_perlin_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),lV=VA(([e])=>{const t=ew(e).toVar(),n=qA().toVar(),r=qA().toVar(),i=qA().toVar(),s=jA(UB(t.x,n)).toVar(),a=jA(UB(t.y,r)).toVar(),o=jA(UB(t.z,i)).toVar(),l=jA(tV(s)).toVar(),u=jA(tV(a)).toVar(),c=jA(tV(o)).toVar(),d=ew(VB(jB(rV(n,r,i),s,a,o),jB(rV(n.add(qA(1)),r,i),s.sub(1),a,o),jB(rV(n,r.add(qA(1)),i),s,a.sub(1),o),jB(rV(n.add(qA(1)),r.add(qA(1)),i),s.sub(1),a.sub(1),o),jB(rV(n,r,i.add(qA(1))),s,a,o.sub(1)),jB(rV(n.add(qA(1)),r,i.add(qA(1))),s.sub(1),a,o.sub(1)),jB(rV(n,r.add(qA(1)),i.add(qA(1))),s,a.sub(1),o.sub(1)),jB(rV(n.add(qA(1)),r.add(qA(1)),i.add(qA(1))),s.sub(1),a.sub(1),o.sub(1)),l,u,c)).toVar();return KB(d)}).setLayout({name:"mx_perlin_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),uV=kO([oV,lV]),cV=kO([VA(([e])=>{const t=jA(e).toVar(),n=qA(FB(t)).toVar();return eV(nV(n))}).setLayout({name:"mx_cell_noise_float_0",type:"float",inputs:[{name:"p",type:"float"}]}),VA(([e])=>{const t=KA(e).toVar(),n=qA(FB(t.x)).toVar(),r=qA(FB(t.y)).toVar();return eV(nV(n,r))}).setLayout({name:"mx_cell_noise_float_1",type:"float",inputs:[{name:"p",type:"vec2"}]}),VA(([e])=>{const t=ew(e).toVar(),n=qA(FB(t.x)).toVar(),r=qA(FB(t.y)).toVar(),i=qA(FB(t.z)).toVar();return eV(nV(n,r,i))}).setLayout({name:"mx_cell_noise_float_2",type:"float",inputs:[{name:"p",type:"vec3"}]}),VA(([e])=>{const t=iw(e).toVar(),n=qA(FB(t.x)).toVar(),r=qA(FB(t.y)).toVar(),i=qA(FB(t.z)).toVar(),s=qA(FB(t.w)).toVar();return eV(nV(n,r,i,s))}).setLayout({name:"mx_cell_noise_float_3",type:"float",inputs:[{name:"p",type:"vec4"}]})]),dV=kO([VA(([e])=>{const t=jA(e).toVar(),n=qA(FB(t)).toVar();return ew(eV(nV(n,qA(0))),eV(nV(n,qA(1))),eV(nV(n,qA(2))))}).setLayout({name:"mx_cell_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"float"}]}),VA(([e])=>{const t=KA(e).toVar(),n=qA(FB(t.x)).toVar(),r=qA(FB(t.y)).toVar();return ew(eV(nV(n,r,qA(0))),eV(nV(n,r,qA(1))),eV(nV(n,r,qA(2))))}).setLayout({name:"mx_cell_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),VA(([e])=>{const t=ew(e).toVar(),n=qA(FB(t.x)).toVar(),r=qA(FB(t.y)).toVar(),i=qA(FB(t.z)).toVar();return ew(eV(nV(n,r,i,qA(0))),eV(nV(n,r,i,qA(1))),eV(nV(n,r,i,qA(2))))}).setLayout({name:"mx_cell_noise_vec3_2",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),VA(([e])=>{const t=iw(e).toVar(),n=qA(FB(t.x)).toVar(),r=qA(FB(t.y)).toVar(),i=qA(FB(t.z)).toVar(),s=qA(FB(t.w)).toVar();return ew(eV(nV(n,r,i,s,qA(0))),eV(nV(n,r,i,s,qA(1))),eV(nV(n,r,i,s,qA(2))))}).setLayout({name:"mx_cell_noise_vec3_3",type:"vec3",inputs:[{name:"p",type:"vec4"}]})]),hV=VA(([e,t,n,r])=>{const i=jA(r).toVar(),s=jA(n).toVar(),a=qA(t).toVar(),o=ew(e).toVar(),l=jA(0).toVar(),u=jA(1).toVar();return EP(a,()=>{l.addAssign(u.mul(aV(o))),u.mulAssign(i),o.mulAssign(s)}),l}).setLayout({name:"mx_fractal_noise_float",type:"float",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),fV=VA(([e,t,n,r])=>{const i=jA(r).toVar(),s=jA(n).toVar(),a=qA(t).toVar(),o=ew(e).toVar(),l=ew(0).toVar(),u=jA(1).toVar();return EP(a,()=>{l.addAssign(u.mul(uV(o))),u.mulAssign(i),o.mulAssign(s)}),l}).setLayout({name:"mx_fractal_noise_vec3",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),pV=VA(([e,t,n,r])=>{const i=jA(r).toVar(),s=jA(n).toVar(),a=qA(t).toVar(),o=ew(e).toVar();return KA(hV(o,a,s,i),hV(o.add(ew(qA(19),qA(193),qA(17))),a,s,i))}).setLayout({name:"mx_fractal_noise_vec2",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),mV=VA(([e,t,n,r])=>{const i=jA(r).toVar(),s=jA(n).toVar(),a=qA(t).toVar(),o=ew(e).toVar(),l=ew(fV(o,a,s,i)).toVar(),u=jA(hV(o.add(ew(qA(19),qA(193),qA(17))),a,s,i)).toVar();return iw(l,u)}).setLayout({name:"mx_fractal_noise_vec4",type:"vec4",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),gV=VA(([e,t,n,r,i,s,a])=>{const o=qA(a).toVar(),l=jA(s).toVar(),u=qA(i).toVar(),c=qA(r).toVar(),d=qA(n).toVar(),h=qA(t).toVar(),f=KA(e).toVar(),p=ew(dV(KA(h.add(c),d.add(u)))).toVar(),m=KA(p.x,p.y).toVar();m.subAssign(.5),m.mulAssign(l),m.addAssign(.5);const g=KA(KA(jA(h),jA(d)).add(m)).toVar(),v=KA(g.sub(f)).toVar();return HA(o.equal(qA(2)),()=>KM(v.x).add(KM(v.y))),HA(o.equal(qA(3)),()=>dR(KM(v.x),KM(v.y))),vR(v,v)}).setLayout({name:"mx_worley_distance_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),vV=kO([gV,VA(([e,t,n,r,i,s,a,o,l])=>{const u=qA(l).toVar(),c=jA(o).toVar(),d=qA(a).toVar(),h=qA(s).toVar(),f=qA(i).toVar(),p=qA(r).toVar(),m=qA(n).toVar(),g=qA(t).toVar(),v=ew(e).toVar(),y=ew(dV(ew(g.add(f),m.add(h),p.add(d)))).toVar();y.subAssign(.5),y.mulAssign(c),y.addAssign(.5);const b=ew(ew(jA(g),jA(m),jA(p)).add(y)).toVar(),_=ew(b.sub(v)).toVar();return HA(u.equal(qA(2)),()=>KM(_.x).add(KM(_.y)).add(KM(_.z))),HA(u.equal(qA(3)),()=>dR(dR(KM(_.x),KM(_.y)),KM(_.z))),vR(_,_)}).setLayout({name:"mx_worley_distance_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"zoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),yV=VA(([e,t,n])=>{const r=qA(n).toVar(),i=jA(t).toVar(),s=KA(e).toVar(),a=qA().toVar(),o=qA().toVar(),l=KA(UB(s.x,a),UB(s.y,o)).toVar(),u=jA(1e6).toVar();return EP({start:-1,end:qA(1),name:"x",condition:"<="},({x:e})=>{EP({start:-1,end:qA(1),name:"y",condition:"<="},({y:t})=>{const n=jA(vV(l,e,t,a,o,i,r)).toVar();u.assign(cR(u,n))})}),HA(r.equal(qA(0)),()=>{u.assign(UM(u))}),u}).setLayout({name:"mx_worley_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),bV=VA(([e,t,n])=>{const r=qA(n).toVar(),i=jA(t).toVar(),s=KA(e).toVar(),a=qA().toVar(),o=qA().toVar(),l=KA(UB(s.x,a),UB(s.y,o)).toVar(),u=KA(1e6,1e6).toVar();return EP({start:-1,end:qA(1),name:"x",condition:"<="},({x:e})=>{EP({start:-1,end:qA(1),name:"y",condition:"<="},({y:t})=>{const n=jA(vV(l,e,t,a,o,i,r)).toVar();HA(n.lessThan(u.x),()=>{u.y.assign(u.x),u.x.assign(n)}).ElseIf(n.lessThan(u.y),()=>{u.y.assign(n)})})}),HA(r.equal(qA(0)),()=>{u.assign(UM(u))}),u}).setLayout({name:"mx_worley_noise_vec2_0",type:"vec2",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),_V=VA(([e,t,n])=>{const r=qA(n).toVar(),i=jA(t).toVar(),s=KA(e).toVar(),a=qA().toVar(),o=qA().toVar(),l=KA(UB(s.x,a),UB(s.y,o)).toVar(),u=ew(1e6,1e6,1e6).toVar();return EP({start:-1,end:qA(1),name:"x",condition:"<="},({x:e})=>{EP({start:-1,end:qA(1),name:"y",condition:"<="},({y:t})=>{const n=jA(vV(l,e,t,a,o,i,r)).toVar();HA(n.lessThan(u.x),()=>{u.z.assign(u.y),u.y.assign(u.x),u.x.assign(n)}).ElseIf(n.lessThan(u.y),()=>{u.z.assign(u.y),u.y.assign(n)}).ElseIf(n.lessThan(u.z),()=>{u.z.assign(n)})})}),HA(r.equal(qA(0)),()=>{u.assign(UM(u))}),u}).setLayout({name:"mx_worley_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),xV=VA(([e,t,n])=>{const r=qA(n).toVar(),i=jA(t).toVar(),s=ew(e).toVar(),a=qA().toVar(),o=qA().toVar(),l=qA().toVar(),u=ew(UB(s.x,a),UB(s.y,o),UB(s.z,l)).toVar(),c=jA(1e6).toVar();return EP({start:-1,end:qA(1),name:"x",condition:"<="},({x:e})=>{EP({start:-1,end:qA(1),name:"y",condition:"<="},({y:t})=>{EP({start:-1,end:qA(1),name:"z",condition:"<="},({z:n})=>{const s=jA(vV(u,e,t,n,a,o,l,i,r)).toVar();c.assign(cR(c,s))})})}),HA(r.equal(qA(0)),()=>{c.assign(UM(c))}),c}).setLayout({name:"mx_worley_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),SV=kO([yV,xV]),TV=VA(([e,t,n])=>{const r=qA(n).toVar(),i=jA(t).toVar(),s=ew(e).toVar(),a=qA().toVar(),o=qA().toVar(),l=qA().toVar(),u=ew(UB(s.x,a),UB(s.y,o),UB(s.z,l)).toVar(),c=KA(1e6,1e6).toVar();return EP({start:-1,end:qA(1),name:"x",condition:"<="},({x:e})=>{EP({start:-1,end:qA(1),name:"y",condition:"<="},({y:t})=>{EP({start:-1,end:qA(1),name:"z",condition:"<="},({z:n})=>{const s=jA(vV(u,e,t,n,a,o,l,i,r)).toVar();HA(s.lessThan(c.x),()=>{c.y.assign(c.x),c.x.assign(s)}).ElseIf(s.lessThan(c.y),()=>{c.y.assign(s)})})})}),HA(r.equal(qA(0)),()=>{c.assign(UM(c))}),c}).setLayout({name:"mx_worley_noise_vec2_1",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),EV=kO([bV,TV]),AV=VA(([e,t,n])=>{const r=qA(n).toVar(),i=jA(t).toVar(),s=ew(e).toVar(),a=qA().toVar(),o=qA().toVar(),l=qA().toVar(),u=ew(UB(s.x,a),UB(s.y,o),UB(s.z,l)).toVar(),c=ew(1e6,1e6,1e6).toVar();return EP({start:-1,end:qA(1),name:"x",condition:"<="},({x:e})=>{EP({start:-1,end:qA(1),name:"y",condition:"<="},({y:t})=>{EP({start:-1,end:qA(1),name:"z",condition:"<="},({z:n})=>{const s=jA(vV(u,e,t,n,a,o,l,i,r)).toVar();HA(s.lessThan(c.x),()=>{c.z.assign(c.y),c.y.assign(c.x),c.x.assign(s)}).ElseIf(s.lessThan(c.y),()=>{c.z.assign(c.y),c.y.assign(s)}).ElseIf(s.lessThan(c.z),()=>{c.z.assign(s)})})})}),HA(r.equal(qA(0)),()=>{c.assign(UM(c))}),c}).setLayout({name:"mx_worley_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),wV=kO([_V,AV]),MV=VA(([e])=>{const t=e.y,n=e.z,r=ew().toVar();return HA(t.lessThan(1e-4),()=>{r.assign(ew(n,n,n))}).Else(()=>{let i=e.x;i=i.sub(VM(i)).mul(6).toVar();const s=qA(sR(i)),a=i.sub(jA(s)),o=n.mul(t.oneMinus()),l=n.mul(t.mul(a).oneMinus()),u=n.mul(t.mul(a.oneMinus()).oneMinus());HA(s.equal(qA(0)),()=>{r.assign(ew(n,u,o))}).ElseIf(s.equal(qA(1)),()=>{r.assign(ew(l,n,o))}).ElseIf(s.equal(qA(2)),()=>{r.assign(ew(o,n,u))}).ElseIf(s.equal(qA(3)),()=>{r.assign(ew(o,l,n))}).ElseIf(s.equal(qA(4)),()=>{r.assign(ew(u,o,n))}).Else(()=>{r.assign(ew(n,o,l))})}),r}).setLayout({name:"mx_hsvtorgb",type:"vec3",inputs:[{name:"hsv",type:"vec3"}]}),RV=VA(([e])=>{const t=ew(e).toVar(),n=jA(t.x).toVar(),r=jA(t.y).toVar(),i=jA(t.z).toVar(),s=jA(cR(n,cR(r,i))).toVar(),a=jA(dR(n,dR(r,i))).toVar(),o=jA(a.sub(s)).toVar(),l=jA().toVar(),u=jA().toVar(),c=jA().toVar();return c.assign(a),HA(a.greaterThan(0),()=>{u.assign(o.div(a))}).Else(()=>{u.assign(0)}),HA(u.lessThanEqual(0),()=>{l.assign(0)}).Else(()=>{HA(n.greaterThanEqual(a),()=>{l.assign(r.sub(i).div(o))}).ElseIf(r.greaterThanEqual(a),()=>{l.assign(rM(2,i.sub(n).div(o)))}).Else(()=>{l.assign(rM(4,n.sub(r).div(o)))}),l.mulAssign(1/6),HA(l.lessThan(0),()=>{l.addAssign(1)})}),ew(l,u,c)}).setLayout({name:"mx_rgbtohsv",type:"vec3",inputs:[{name:"c",type:"vec3"}]}),CV=VA(([e])=>{const t=ew(e).toVar(),n=rw(dM(t,ew(.04045))).toVar(),r=ew(t.div(12.92)).toVar(),i=ew(bR(dR(t.add(ew(.055)),ew(0)).div(1.055),ew(2.4))).toVar();return wR(r,i,n)}).setLayout({name:"mx_srgb_texture_to_lin_rec709",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),IV=(e,t)=>{e=jA(e),t=jA(t);const n=KA(t.dFdx(),t.dFdy()).length().mul(.7071067811865476);return IR(e.sub(n),e.add(n),t)},LV=(e,t,n,r)=>wR(e,t,n[r].clamp()),PV=(e,t,n,r,i)=>wR(e,t,IV(n,r[i])),NV=VA(([e,t,n])=>{const r=GM(e).toVar("nDir"),i=iM(jA(.5).mul(t.sub(n)),gI).div(r).toVar("rbmax"),s=iM(jA(-.5).mul(t.sub(n)),gI).div(r).toVar("rbmin"),a=ew().toVar("rbminmax");a.x=r.x.greaterThan(jA(0)).select(i.x,s.x),a.y=r.y.greaterThan(jA(0)).select(i.y,s.y),a.z=r.z.greaterThan(jA(0)).select(i.z,s.z);const o=cR(cR(a.x,a.y),a.z).toVar("correction");return gI.add(r.mul(o)).toVar("boxIntersection").sub(n)}),DV=VA(([e,t])=>{const n=e.x,r=e.y,i=e.z;let s=t.element(0).mul(.886227);return s=s.add(t.element(1).mul(1.023328).mul(r)),s=s.add(t.element(2).mul(1.023328).mul(i)),s=s.add(t.element(3).mul(1.023328).mul(n)),s=s.add(t.element(4).mul(.858086).mul(n).mul(r)),s=s.add(t.element(5).mul(.858086).mul(r).mul(i)),s=s.add(t.element(6).mul(i.mul(i).mul(.743125).sub(.247708))),s=s.add(t.element(7).mul(.858086).mul(n).mul(i)),s=s.add(t.element(8).mul(.429043).mul(sM(n,n).sub(sM(r,r)))),s});var kV=Object.freeze({__proto__:null,BRDF_GGX:rD,BRDF_Lambert:GN,BasicShadowFilter:cB,Break:AP,Continue:()=>MC("continue").append(),DFGApprox:iD,D_GGX:eD,Discard:RC,EPSILON:wM,F_Schlick:zN,Fn:VA,INFINITY:MM,If:HA,Loop:EP,NodeAccess:HE,NodeShaderStage:zE,NodeType:{BOOLEAN:"bool",INTEGER:"int",FLOAT:"float",VECTOR2:"vec2",VECTOR3:"vec3",VECTOR4:"vec4",MATRIX2:"mat2",MATRIX3:"mat3",MATRIX4:"mat4"},NodeUpdateType:GE,PCFShadowFilter:dB,PCFSoftShadowFilter:hB,PI:RM,PI2:CM,Return:()=>MC("return").append(),Schlick_to_F0:aD,ScriptableNodeResources:EU,ShaderNode:DA,TBNViewMatrix:cL,VSMShadowFilter:fB,V_GGX_SmithCorrelated:ZN,abs:KM,acesFilmicToneMapping:cU,acos:XM,add:rM,addMethodChaining:lA,addNodeElement:function(e){},agxToneMapping:pU,all:IM,alphaT:kw,and:pM,anisotropy:Ow,anisotropyB:Uw,anisotropyT:Fw,any:LM,append:$A,arrayBuffer:e=>kA(new sA(e,"ArrayBuffer")),asin:qM,assign:Jw,atan:YM,atan2:kR,atomicAdd:(e,t,n=null)=>jU($U.ATOMIC_ADD,e,t,n),atomicAnd:(e,t,n=null)=>jU($U.ATOMIC_AND,e,t,n),atomicFunc:jU,atomicMax:(e,t,n=null)=>jU($U.ATOMIC_MAX,e,t,n),atomicMin:(e,t,n=null)=>jU($U.ATOMIC_MIN,e,t,n),atomicOr:(e,t,n=null)=>jU($U.ATOMIC_OR,e,t,n),atomicStore:(e,t,n=null)=>jU($U.ATOMIC_STORE,e,t,n),atomicSub:(e,t,n=null)=>jU($U.ATOMIC_SUB,e,t,n),atomicXor:(e,t,n=null)=>jU($U.ATOMIC_XOR,e,t,n),attenuationColor:Kw,attenuationDistance:Yw,attribute:PC,attributeArray:(e,t="float")=>{const n=kE(t),r=DE(t),i=new _F(e,n,r);return EF(i,t,e)},backgroundBlurriness:LF,backgroundIntensity:PF,backgroundRotation:NF,batch:bP,billboarding:zO,bitAnd:yM,bitNot:bM,bitOr:_M,bitXor:xM,bitangentGeometry:iL,bitangentLocal:sL,bitangentView:aL,bitangentWorld:oL,bitcast:lR,blendBurn:GF,blendColor:jF,blendDodge:HF,blendOverlay:WF,blendScreen:$F,blur:ik,bool:YA,buffer:zI,bufferAttribute:fC,bumpMap:bL,burn:(...e)=>GF(e),bvec2:JA,bvec3:rw,bvec4:ow,bypass:SC,cache:_C,call:tM,cameraFar:GC,cameraNear:zC,cameraNormalMatrix:qC,cameraPosition:XC,cameraProjectionMatrix:HC,cameraProjectionMatrixInverse:$C,cameraViewMatrix:WC,cameraWorldMatrix:jC,cbrt:ER,cdl:ZF,ceil:zM,checker:DB,cineonToneMapping:lU,clamp:MR,clearcoat:Rw,clearcoatRoughness:Cw,code:vU,color:WA,colorSpaceToWorking:iC,colorToDirection:e=>kA(e).mul(2).sub(1),compute:yC,cond:VR,context:GR,convert:hw,convertColorSpace:(e,t,n)=>kA(new eC(kA(e),t,n)),convertToTexture:(e,...t)=>e.isTextureNode?e:e.isPassNode?e.getTextureNode():mF(e,...t),cos:WM,cross:yR,cubeTexture:BI,dFdx:tR,dFdy:nR,dashSize:Hw,defaultBuildStages:WE,defaultShaderStages:$E,defined:PA,degrees:NM,deltaTime:FO,densityFog:function(e,t){return IU(e,CU(t))},densityFogFactor:CU,depth:lN,depthPass:(e,t,n)=>kA(new iU(iU.DEPTH,e,t,n)),difference:gR,diffuseColor:Ew,directPointLight:PB,directionToColor:EN,dispersion:Qw,distance:mR,div:aM,dodge:(...e)=>HF(e),dot:vR,drawIndex:fP,dynamicBufferAttribute:pC,element:dw,emissive:Aw,equal:lM,equals:uR,equirectUV:RN,exp:DM,exp2:kM,expression:MC,faceDirection:SI,faceForward:LR,faceforward:OR,float:jA,floor:VM,fog:IU,fract:HM,frameGroup:gw,frameId:UO,frontFacing:xI,fwidth:aR,gain:(e,t)=>e.lessThan(.5)?CO(e.mul(2),t).div(2):iM(1,CO(sM(iM(1,e),2),t).div(2)),gapSize:$w,getConstNodeType:NA,getCurrentStack:GA,getDirection:ek,getDistanceAttenuation:SB,getGeometryRoughness:KN,getNormalFromDepth:yF,getParallaxCorrectNormal:NV,getRoughness:QN,getScreenPosition:vF,getShIrradianceAt:DV,getTextureIndex:AO,getViewPosition:gF,glsl:(e,t)=>vU(e,t,"glsl"),glslFn:(e,t)=>bU(e,t,"glsl"),grayscale:qF,greaterThan:dM,greaterThanEqual:fM,hash:RO,highpModelNormalViewMatrix:hI,highpModelViewMatrix:dI,hue:KF,instance:mP,instanceIndex:uP,instancedArray:(e,t="float")=>{const n=kE(t),r=DE(t),i=new bF(e,n,r);return EF(i,t,e)},instancedBufferAttribute:mC,instancedDynamicBufferAttribute:gC,instancedMesh:vP,int:qA,inverseSqrt:BM,inversesqrt:FR,invocationLocalIndex:hP,invocationSubgroupIndex:dP,ior:jw,iridescence:Pw,iridescenceIOR:Nw,iridescenceThickness:Dw,ivec2:QA,ivec3:tw,ivec4:sw,js:(e,t)=>vU(e,t,"js"),label:HR,length:ZM,lengthSq:AR,lessThan:cM,lessThanEqual:hM,lightPosition:QU,lightProjectionUV:KU,lightShadowMatrix:YU,lightTargetDirection:eB,lightTargetPosition:ZU,lightViewPosition:JU,lightingContext:DP,lights:(e=[])=>kA(new rB).setLights(e),linearDepth:uN,linearToneMapping:aU,localId:BU,log:OM,log2:FM,logarithmicDepthToViewZ:(e,t,n)=>{const r=e.mul(OM(n.div(t)));return jA(Math.E).pow(r).mul(t).negate()},loop:(...e)=>EP(...e),luminance:QF,mat2:lw,mat3:uw,mat4:cw,matcapUV:Tk,materialAO:iP,materialAlphaTest:SL,materialAnisotropy:zL,materialAnisotropyVector:sP,materialAttenuationColor:YL,materialAttenuationDistance:XL,materialClearcoat:kL,materialClearcoatNormal:FL,materialClearcoatRoughness:OL,materialColor:TL,materialDispersion:nP,materialEmissive:AL,materialIOR:qL,materialIridescence:GL,materialIridescenceIOR:HL,materialIridescenceThickness:$L,materialLightMap:rP,materialLineDashOffset:eP,materialLineDashSize:QL,materialLineGapSize:ZL,materialLineScale:KL,materialLineWidth:JL,materialMetalness:NL,materialNormal:DL,materialOpacity:wL,materialPointWidth:tP,materialReference:KI,materialReflectivity:LL,materialRefractionRatio:NI,materialRotation:UL,materialRoughness:PL,materialSheen:BL,materialSheenRoughness:VL,materialShininess:EL,materialSpecular:ML,materialSpecularColor:CL,materialSpecularIntensity:RL,materialSpecularStrength:IL,materialThickness:jL,materialTransmission:WL,max:dR,maxMipLevel:FC,mediumpModelViewMatrix:cI,metalness:Mw,min:cR,mix:wR,mixElement:NR,mod:hR,modInt:oM,modelDirection:nI,modelNormalMatrix:oI,modelPosition:iI,modelScale:sI,modelViewMatrix:uI,modelViewPosition:aI,modelViewProjection:aP,modelWorldMatrix:rI,modelWorldMatrixInverse:lI,morphReference:IP,mrt:MO,mul:sM,mx_aastep:IV,mx_cell_noise_float:(e=NC())=>cV(e.convert("vec2|vec3")),mx_contrast:(e,t=1,n=.5)=>jA(e).sub(n).mul(t).add(n),mx_fractal_noise_float:(e=NC(),t=3,n=2,r=.5,i=1)=>hV(e,qA(t),n,r).mul(i),mx_fractal_noise_vec2:(e=NC(),t=3,n=2,r=.5,i=1)=>pV(e,qA(t),n,r).mul(i),mx_fractal_noise_vec3:(e=NC(),t=3,n=2,r=.5,i=1)=>fV(e,qA(t),n,r).mul(i),mx_fractal_noise_vec4:(e=NC(),t=3,n=2,r=.5,i=1)=>mV(e,qA(t),n,r).mul(i),mx_hsvtorgb:MV,mx_noise_float:(e=NC(),t=1,n=0)=>aV(e.convert("vec2|vec3")).mul(t).add(n),mx_noise_vec3:(e=NC(),t=1,n=0)=>uV(e.convert("vec2|vec3")).mul(t).add(n),mx_noise_vec4:(e=NC(),t=1,n=0)=>{e=e.convert("vec2|vec3");return iw(uV(e),aV(e.add(KA(19,73)))).mul(t).add(n)},mx_ramplr:(e,t,n=NC())=>LV(e,t,n,"x"),mx_ramptb:(e,t,n=NC())=>LV(e,t,n,"y"),mx_rgbtohsv:RV,mx_safepower:(e,t=1)=>(e=jA(e)).abs().pow(t).mul(e.sign()),mx_splitlr:(e,t,n,r=NC())=>PV(e,t,n,r,"x"),mx_splittb:(e,t,n,r=NC())=>PV(e,t,n,r,"y"),mx_srgb_texture_to_lin_rec709:CV,mx_transform_uv:(e=1,t=0,n=NC())=>n.mul(e).add(t),mx_worley_noise_float:(e=NC(),t=1)=>SV(e.convert("vec2|vec3"),t,qA(1)),mx_worley_noise_vec2:(e=NC(),t=1)=>EV(e.convert("vec2|vec3"),t,qA(1)),mx_worley_noise_vec3:(e=NC(),t=1)=>wV(e.convert("vec2|vec3"),t,qA(1)),negate:JM,neutralToneMapping:mU,nodeArray:FA,nodeImmutable:BA,nodeObject:kA,nodeObjects:OA,nodeProxy:UA,normalFlat:AI,normalGeometry:TI,normalLocal:EI,normalMap:mL,normalView:wI,normalWorld:MI,normalize:GM,not:gM,notEqual:uM,numWorkgroups:FU,objectDirection:KC,objectGroup:yw,objectPosition:ZC,objectScale:JC,objectViewPosition:eI,objectWorldMatrix:QC,oneMinus:eR,or:mM,orthographicDepthToViewZ:(e,t,n)=>t.sub(n).mul(e).sub(t),oscSawtooth:(e=OO)=>e.fract(),oscSine:(e=OO)=>e.add(.75).mul(2*Math.PI).sin().mul(.5).add(.5),oscSquare:(e=OO)=>e.fract().round(),oscTriangle:(e=OO)=>e.add(.5).fract().mul(2).sub(1).abs(),output:Gw,outputStruct:EO,overlay:(...e)=>WF(e),overloadingFn:kO,parabola:CO,parallaxDirection:dL,parallaxUV:(e,t)=>e.sub(dL.mul(t)),parameter:(e,t)=>kA(new _O(e,t)),pass:(e,t,n)=>kA(new iU(iU.COLOR,e,t,n)),passTexture:(e,t)=>kA(new nU(e,t)),pcurve:(e,t,n)=>bR(aM(bR(e,t),rM(bR(e,t),bR(iM(1,e),n))),1/t),perspectiveDepthToViewZ:sN,pmremTexture:uk,pointUV:MF,pointWidth:Ww,positionGeometry:fI,positionLocal:pI,positionPrevious:mI,positionView:yI,positionViewDirection:bI,positionWorld:gI,positionWorldDirection:vI,posterize:eU,pow:bR,pow2:_R,pow3:xR,pow4:SR,property:Sw,radians:PM,rand:PR,range:DU,rangeFog:function(e,t,n){return IU(e,RU(t,n))},rangeFogFactor:RU,reciprocal:iR,reference:qI,referenceBuffer:XI,reflect:pR,reflectVector:OI,reflectView:DI,reflector:e=>kA(new oF(e)),refract:CR,refractVector:FI,refractView:kI,reinhardToneMapping:oU,remainder:EM,remap:EC,remapClamp:AC,renderGroup:vw,renderOutput:IC,rendererReference:lC,rotate:Ck,rotateUV:BO,roughness:ww,round:rR,rtt:mF,sRGBTransferEOTF:KR,sRGBTransferOETF:QR,sampler:e=>(!0===e.isNode?e:BC(e)).convert("sampler"),saturate:RR,saturation:XF,screen:(...e)=>$F(e),screenCoordinate:zP,screenSize:VP,screenUV:BP,scriptable:wU,scriptableValue:xU,select:BR,setCurrentStack:zA,shaderStages:jE,shadow:_B,shadowPositionWorld:sB,sharedUniformGroup:mw,sheen:Iw,sheenRoughness:Lw,shiftLeft:SM,shiftRight:TM,shininess:zw,sign:QM,sin:$M,sinc:(e,t)=>$M(RM.mul(t.mul(e).sub(1))).div(RM.mul(t.mul(e).sub(1))),skinning:e=>kA(new xP(e)),skinningReference:SP,smoothstep:IR,smoothstepElement:DR,specularColor:Bw,specularF90:Vw,spherizeUV:VO,split:(e,t)=>kA(new tA(kA(e),t)),spritesheetUV:$O,sqrt:UM,stack:SO,step:fR,storage:EF,storageBarrier:()=>zU("storage").append(),storageObject:(e,t,n)=>EF(e,t,n).setPBO(!0),storageTexture:kF,string:(e="")=>kA(new sA(e,"string")),sub:iM,subgroupIndex:cP,subgroupSize:VU,tan:jM,tangentGeometry:QI,tangentLocal:ZI,tangentView:JI,tangentWorld:eL,temp:jR,texture:BC,texture3D:Fk,textureBarrier:()=>zU("texture").append(),textureBicubic:ED,textureCubeUV:tk,textureLoad:VC,textureSize:kC,textureStore:(e,t,n)=>{const r=kF(e,t,n);return null!==n&&r.append(),r},thickness:Xw,time:OO,timerDelta:(e=1)=>FO.mul(e),timerGlobal:(e=1)=>OO.mul(e),timerLocal:(e=1)=>OO.mul(e),toOutputColorSpace:tC,toWorkingColorSpace:nC,toneMapping:cC,toneMappingExposure:dC,toonOutlinePass:(e,t,n=new qr(0,0,0),r=.003,i=1)=>kA(new sU(e,t,kA(n),kA(r),kA(i))),transformDirection:TR,transformNormal:LI,transformNormalToView:PI,transformedBentNormalView:hL,transformedBitangentView:lL,transformedBitangentWorld:uL,transformedClearcoatNormalView:II,transformedNormalView:RI,transformedNormalWorld:CI,transformedTangentView:tL,transformedTangentWorld:nL,transmission:qw,transpose:oR,triNoise3D:PO,triplanarTexture:(...e)=>jO(...e),triplanarTextures:jO,trunc:sR,tslFn:(...e)=>VA(...e),uint:XA,uniform:_w,uniformArray:$I,uniformGroup:pw,uniforms:(e,t)=>kA(new HI(e,t)),userData:(e,t,n)=>kA(new OF(e,t,n)),uv:NC,uvec2:ZA,uvec3:nw,uvec4:aw,varying:XR,varyingProperty:Tw,vec2:KA,vec3:ew,vec4:iw,vectorComponents:qE,velocity:zF,vertexColor:e=>kA(new AF(e)),vertexIndex:lP,vertexStage:YR,vibrance:YF,viewZToLogarithmicDepth:aN,viewZToOrthographicDepth:rN,viewZToPerspectiveDepth:iN,viewport:GP,viewportBottomLeft:XP,viewportCoordinate:$P,viewportDepthTexture:tN,viewportLinearDepth:cN,viewportMipTexture:ZP,viewportResolution:jP,viewportSafeUV:GO,viewportSharedTexture:TN,viewportSize:HP,viewportTexture:QP,viewportTopLeft:qP,viewportUV:WP,wgsl:(e,t)=>vU(e,t,"wgsl"),wgslFn:(e,t)=>bU(e,t,"wgsl"),workgroupArray:(e,t)=>kA(new HU("Workgroup",e,t)),workgroupBarrier:()=>zU("workgroup").append(),workgroupId:UU,workingToColorSpace:rC,xor:vM});const OV=new bO;class FV extends $k{constructor(e,t){super(),this.renderer=e,this.nodes=t}update(e,t,n){const r=this.renderer,i=this.nodes.getBackgroundNode(e)||e.background;let s=!1;if(null===i)r._clearColor.getRGB(OV,bt),OV.a=r._clearColor.a;else if(!0===i.isColor)i.getRGB(OV,bt),OV.a=1,s=!0;else if(!0===i.isNode){const n=this.get(e),s=i;OV.copy(r._clearColor);let a=n.backgroundMesh;if(void 0===a){const e=GR(iw(s).mul(PF),{getUV:()=>NF.mul(MI),getTextureLevel:()=>LF});let t=aP;t=t.setZ(t.w);const r=new gN;r.name="Background.material",r.side=1,r.depthTest=!1,r.depthWrite=!1,r.fog=!1,r.lights=!1,r.vertexNode=t,r.colorNode=e,n.backgroundMeshNode=e,n.backgroundMesh=a=new Ci(new tl(1,32,32),r),a.frustumCulled=!1,a.name="Background.mesh",a.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)}}const o=s.getCacheKey();n.backgroundCacheKey!==o&&(n.backgroundMeshNode.node=iw(s).mul(PF),n.backgroundMeshNode.needsUpdate=!0,a.material.needsUpdate=!0,n.backgroundCacheKey=o),t.unshift(a,a.geometry,a.material,0,0,null,null)}if(!0===r.autoClear||!0===s){const e=n.clearColorValue;e.r=OV.r,e.g=OV.g,e.b=OV.b,e.a=OV.a,!0!==r.backend.isWebGLBackend&&!0!==r.alpha||(e.r*=e.a,e.g*=e.a,e.b*=e.a),n.depthClearValue=r._clearDepth,n.stencilClearValue=r._clearStencil,n.clearColor=!0===r.autoClearColor,n.clearDepth=!0===r.autoClearDepth,n.clearStencil=!0===r.autoClearStencil}else n.clearColor=!1,n.clearDepth=!1,n.clearStencil=!1}}let UV=0;class BV{constructor(e="",t=[],n=0,r=[]){this.name=e,this.bindings=t,this.index=n,this.bindingsReference=r,this.id=UV++}}class VV{constructor(e,t,n,r,i,s,a,o,l,u=[]){this.vertexShader=e,this.fragmentShader=t,this.computeShader=n,this.transforms=u,this.nodeAttributes=r,this.bindings=i,this.updateNodes=s,this.updateBeforeNodes=a,this.updateAfterNodes=o,this.monitor=l,this.usedTimes=0}createBindings(){const e=[];for(const t of this.bindings){if(!0!==t.bindings[0].groupNode.shared){const n=new BV(t.name,[],t.index,t);e.push(n);for(const e of t.bindings)n.bindings.push(e.clone())}else e.push(t)}return e}}class zV{constructor(e,t,n=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=n}}class GV{constructor(e,t,n){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=n.getSelf()}get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}}class HV{constructor(e,t){this.isNodeVar=!0,this.name=e,this.type=t}}class $V extends HV{constructor(e,t){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0}}class WV{constructor(e,t,n=""){this.name=e,this.type=t,this.code=n,Object.defineProperty(this,"isNodeCode",{value:!0})}}let jV=0;class qV{constructor(e=null){this.id=jV++,this.nodesData=new WeakMap,this.parent=e}getData(e){let t=this.nodesData.get(e);return void 0===t&&null!==this.parent&&(t=this.parent.getData(e)),t}setData(e,t){this.nodesData.set(e,t)}}class XV extends YE{static get type(){return"StructTypeNode"}constructor(e,t){super(),this.name=e,this.types=t,this.isStructTypeNode=!0}getMemberTypes(){return this.types}}class YV{constructor(e,t){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}}class KV extends YV{constructor(e,t=0){super(e,t),this.isNumberUniform=!0,this.boundary=4,this.itemSize=1}}class QV extends YV{constructor(e,t=new Yt){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}}class ZV extends YV{constructor(e,t=new An){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}}class JV extends YV{constructor(e,t=new bn){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}}class ez extends YV{constructor(e,t=new qr){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}}class tz extends YV{constructor(e,t=new Kt){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}}class nz extends YV{constructor(e,t=new tr){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}}class rz extends KV{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class iz extends QV{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class sz extends ZV{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class az extends JV{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class oz extends ez{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class lz extends tz{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class uz extends nz{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}const cz=[.125,.215,.35,.446,.526,.582],dz=20,hz=new uu(-1,1,1,-1,0,1),fz=new zi(90,1),pz=new qr;let mz=null,gz=0,vz=0;const yz=(1+Math.sqrt(5))/2,bz=1/yz,_z=[new An(-yz,bz,0),new An(yz,bz,0),new An(-bz,0,yz),new An(bz,0,yz),new An(0,yz,-bz),new An(0,yz,bz),new An(-1,1,-1),new An(1,1,-1),new An(-1,1,1),new An(1,1,1)],xz=[3,1,5,0,4,2],Sz=ek(NC(),PC("faceIndex")).normalize(),Tz=ew(Sz.x,Sz.y,Sz.z);class Ez{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}get _hasInitialized(){return this._renderer.hasInitialized()}fromScene(e,t=0,n=.1,r=100,i=null){if(this._setSize(256),!1===this._hasInitialized){const s=i||this._allocateTargets();return this.fromSceneAsync(e,t,n,r,s),s}mz=this._renderer.getRenderTarget(),gz=this._renderer.getActiveCubeFace(),vz=this._renderer.getActiveMipmapLevel();const s=i||this._allocateTargets();return s.depthBuffer=!0,this._sceneToCubeUV(e,n,r,s),t>0&&this._blur(s,0,0,t),this._applyPMREM(s),this._cleanup(s),s}async fromSceneAsync(e,t=0,n=.1,r=100,i=null){return!1===this._hasInitialized&&await this._renderer.init(),this.fromScene(e,t,n,r,i)}fromEquirectangular(e,t=null){if(!1===this._hasInitialized){this._setSizeFromTexture(e);const n=t||this._allocateTargets();return this.fromEquirectangularAsync(e,n),n}return this._fromTexture(e,t)}async fromEquirectangularAsync(e,t=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(e,t)}fromCubemap(e,t=null){if(!1===this._hasInitialized){this._setSizeFromTexture(e);const n=t||this._allocateTargets();return this.fromCubemapAsync(e,t),n}return this._fromTexture(e,t)}async fromCubemapAsync(e,t=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(e,t)}async compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=Rz(),await this._compileMaterial(this._cubemapMaterial))}async compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Cz(),await this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSizeFromTexture(e){e.mapping===q||e.mapping===X?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4)}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(mz,gz,vz),e.scissorTest=!1,wz(e,0,0,e.width,e.height)}_fromTexture(e,t){this._setSizeFromTexture(e),mz=this._renderer.getRenderTarget(),gz=this._renderer.getActiveCubeFace(),vz=this._renderer.getActiveMipmapLevel();const n=t||this._allocateTargets();return this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,n={magFilter:ie,minFilter:ie,generateMipmaps:!1,type:pe,format:xe,colorSpace:bt},r=Az(e,t,n);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=Az(e,t,n);const{_lodMax:r}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas,lodMeshes:this._lodMeshes}=function(e){const t=[],n=[],r=[],i=[];let s=e;const a=e-4+1+cz.length;for(let o=0;o<a;o++){const a=Math.pow(2,s);n.push(a);let l=1/a;o>e-4?l=cz[o-e+4-1]:0===o&&(l=0),r.push(l);const u=1/(a-2),c=-u,d=1+u,h=[c,c,d,c,d,d,c,c,d,d,c,d],f=6,p=6,m=3,g=2,v=1,y=new Float32Array(m*p*f),b=new Float32Array(g*p*f),_=new Float32Array(v*p*f);for(let e=0;e<f;e++){const t=e%3*2/3-1,n=e>2?0:-1,r=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0],i=xz[e];y.set(r,m*p*i),b.set(h,g*p*i);const s=[i,i,i,i,i,i];_.set(s,v*p*i)}const x=new vi;x.setAttribute("position",new si(y,m)),x.setAttribute("uv",new si(b,g)),x.setAttribute("faceIndex",new si(_,v)),t.push(x),i.push(new Ci(x,null)),s>4&&s--}return{lodPlanes:t,sizeLods:n,sigmas:r,lodMeshes:i}}(r)),this._blurMaterial=function(e,t,n){const r=$I(new Array(dz).fill(0)),i=_w(new An(0,1,0)),s=_w(0),a=jA(dz),o=_w(0),l=_w(1),u=BC(null),c=_w(0),d=jA(1/t),h=jA(1/n),f=jA(e),p={n:a,latitudinal:o,weights:r,poleAxis:i,outputDirection:Tz,dTheta:s,samples:l,envMap:u,mipInt:c,CUBEUV_TEXEL_WIDTH:d,CUBEUV_TEXEL_HEIGHT:h,CUBEUV_MAX_MIP:f},m=Mz("blur");return m.uniforms=p,m.fragmentNode=ik({...p,latitudinal:o.equal(1)}),m}(r,e,t)}return r}async _compileMaterial(e){const t=new Ci(this._lodPlanes[0],e);await this._renderer.compile(t,hz)}_sceneToCubeUV(e,t,n,r){const i=fz;i.near=t,i.far=n;const s=[1,1,1,1,-1,1],a=[1,-1,1,-1,1,-1],o=this._renderer,l=o.autoClear;o.getClearColor(pz),o.autoClear=!1;let u=this._backgroundBox;if(null===u){const e=new Qr({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1});u=new Ci(new Li,e)}let c=!1;const d=e.background;d?d.isColor&&(u.material.color.copy(d),e.background=null,c=!0):(u.material.color.copy(pz),c=!0),o.setRenderTarget(r),o.clear(),c&&o.render(u,i);for(let t=0;t<6;t++){const n=t%3;0===n?(i.up.set(0,s[t],0),i.lookAt(a[t],0,0)):1===n?(i.up.set(0,0,s[t]),i.lookAt(0,a[t],0)):(i.up.set(0,s[t],0),i.lookAt(0,0,a[t]));const l=this._cubeSize;wz(r,n*l,t>2?l:0,l,l),o.render(e,i)}o.autoClear=l,e.background=d}_textureToCubeUV(e,t){const n=this._renderer,r=e.mapping===q||e.mapping===X;r?null===this._cubemapMaterial&&(this._cubemapMaterial=Rz(e)):null===this._equirectMaterial&&(this._equirectMaterial=Cz(e));const i=r?this._cubemapMaterial:this._equirectMaterial;i.fragmentNode.value=e;const s=this._lodMeshes[0];s.material=i;const a=this._cubeSize;wz(t,0,0,3*a,2*a),n.setRenderTarget(t),n.render(s,hz)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;const r=this._lodPlanes.length;for(let t=1;t<r;t++){const n=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),i=_z[(r-t-1)%_z.length];this._blur(e,t-1,t,n,i)}t.autoClear=n}_blur(e,t,n,r,i){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,n,r,"latitudinal",i),this._halfBlur(s,e,n,n,r,"longitudinal",i)}_halfBlur(e,t,n,r,i,s,a){const o=this._renderer,l=this._blurMaterial,u=this._lodMeshes[r];u.material=l;const c=l.uniforms,d=this._sizeLods[n]-1,h=isFinite(i)?Math.PI/(2*d):2*Math.PI/39,f=i/h,p=isFinite(i)?1+Math.floor(3*f):dz,m=[];let g=0;for(let e=0;e<dz;++e){const t=e/f,n=Math.exp(-t*t/2);m.push(n),0===e?g+=n:e<p&&(g+=2*n)}for(let e=0;e<m.length;e++)m[e]=m[e]/g;e.texture.frame=(e.texture.frame||0)+1,c.envMap.value=e.texture,c.samples.value=p,c.weights.array=m,c.latitudinal.value="latitudinal"===s?1:0,a&&(c.poleAxis.value=a);const{_lodMax:v}=this;c.dTheta.value=h,c.mipInt.value=v-n;const y=this._sizeLods[r];wz(t,3*y*(r>v-4?r-v+4:0),4*(this._cubeSize-y),3*y,2*y),o.setRenderTarget(t),o.render(u,hz)}}function Az(e,t,n){const r=new _n(e,t,n);return r.texture.mapping=Q,r.texture.name="PMREM.cubeUv",r.texture.isPMREMTexture=!0,r.scissorTest=!0,r}function wz(e,t,n,r,i){e.viewport.set(t,n,r,i),e.scissor.set(t,n,r,i)}function Mz(e){const t=new gN;return t.depthTest=!1,t.depthWrite=!1,t.blending=0,t.name=`PMREM_${e}`,t}function Rz(e){const t=Mz("cubemap");return t.fragmentNode=BI(e,Tz),t}function Cz(e){const t=Mz("equirect");return t.fragmentNode=BC(e,RN(Tz),0),t}const Iz=new WeakMap,Lz=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),Pz=e=>/e/g.test(e)?String(e).replace(/\+/g,""):(e=Number(e))+(e%1?"":".0");class Nz{constructor(e,t,n){this.object=e,this.material=e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=n,this.scene=null,this.camera=null,this.nodes=[],this.sequentialNodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.updateAfterNodes=[],this.hashNodes={},this.monitor=null,this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.clippingContext=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:""},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:{},fragment:{},compute:{}},this.bindingsIndexes={},this.bindGroups=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.flow={code:""},this.chaining=[],this.stack=SO(),this.stacks=[],this.tab="\t",this.currentFunctionNode=null,this.context={material:this.material},this.cache=new qV,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null,this.useComparisonMethod=!1}getBindGroupsCache(){let e=Iz.get(this.renderer);return void 0===e&&(e=new Bk,Iz.set(this.renderer,e)),e}createRenderTarget(e,t,n){return new _n(e,t,n)}createCubeRenderTarget(e,t){return new CN(e,t)}createPMREMGenerator(){return new Ez(this.renderer)}includes(e){return this.nodes.includes(e)}_getBindGroup(e,t){const n=this.getBindGroupsCache(),r=[];let i,s=!0;for(const e of t)r.push(e),s=s&&!0!==e.groupNode.shared;return s?(i=n.get(r),void 0===i&&(i=new BV(e,r,this.bindingsIndexes[e].group,r),n.set(r,i))):i=new BV(e,r,this.bindingsIndexes[e].group,r),i}getBindGroupArray(e,t){const n=this.bindings[t];let r=n[e];return void 0===r&&(void 0===this.bindingsIndexes[e]&&(this.bindingsIndexes[e]={binding:0,group:Object.keys(this.bindingsIndexes).length}),n[e]=r=[]),r}getBindings(){let e=this.bindGroups;if(null===e){const t={},n=this.bindings;for(const e of jE)for(const r in n[e]){const i=n[e][r];(t[r]||(t[r]=[])).push(...i)}e=[];for(const n in t){const r=t[n],i=this._getBindGroup(n,r);e.push(i)}this.bindGroups=e}return e}sortBindingGroups(){const e=this.getBindings();e.sort((e,t)=>e.bindings[0].groupNode.order-t.bindings[0].groupNode.order);for(let t=0;t<e.length;t++){const n=e[t];this.bindingsIndexes[n.name].group=t,n.index=t}}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){!1===this.nodes.includes(e)&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}addSequentialNode(e){!1===this.sequentialNodes.includes(e)&&this.sequentialNodes.push(e)}buildUpdateNodes(){for(const e of this.nodes){e.getUpdateType()!==GE.NONE&&this.updateNodes.push(e.getSelf())}for(const e of this.sequentialNodes){const t=e.getUpdateBeforeType(),n=e.getUpdateAfterType();t!==GE.NONE&&this.updateBeforeNodes.push(e.getSelf()),n!==GE.NONE&&this.updateAfterNodes.push(e.getSelf())}}get currentNode(){return this.chaining[this.chaining.length-1]}isFilteredTexture(e){return e.magFilter===ie||e.magFilter===se||e.magFilter===re||e.magFilter===ae||e.minFilter===ie||e.minFilter===se||e.minFilter===re||e.minFilter===ae}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw new Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}getSharedContext(){return this.context,this.context}setCache(e){this.cache=e}getCache(){return this.cache}getCacheFromNode(e,t=!0){const n=this.getDataFromNode(e);return void 0===n.cache&&(n.cache=new qV(t?this.getCache():null)),n.cache}isAvailable(){return!1}getVertexIndex(){}getInstanceIndex(){}getDrawIndex(){}getFrontFacing(){}getFragCoord(){}isFlipY(){return!1}increaseUsage(e){const t=this.getDataFromNode(e);return t.usageCount=void 0===t.usageCount?1:t.usageCount+1,t.usageCount}generateTexture(){}generateTextureLod(){}generateConst(e,t=null){if(null===t&&("float"===e||"int"===e||"uint"===e?t=0:"bool"===e?t=!1:"color"===e?t=new qr:"vec2"===e?t=new Yt:"vec3"===e?t=new An:"vec4"===e&&(t=new bn)),"float"===e)return Pz(t);if("int"===e)return`${Math.round(t)}`;if("uint"===e)return t>=0?`${Math.round(t)}u`:"0u";if("bool"===e)return t?"true":"false";if("color"===e)return`${this.getType("vec3")}( ${Pz(t.r)}, ${Pz(t.g)}, ${Pz(t.b)} )`;const n=this.getTypeLength(e),r=this.getComponentType(e),i=e=>this.generateConst(r,e);if(2===n)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)} )`;if(3===n)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)}, ${i(t.z)} )`;if(4===n)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)}, ${i(t.z)}, ${i(t.w)} )`;if(n>4&&t&&(t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(i).join(", ")} )`;if(n>4)return`${this.getType(e)}()`;throw new Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return"color"===e?"vec3":e}hasGeometryAttribute(e){return this.geometry&&void 0!==this.geometry.getAttribute(e)}getAttribute(e,t){const n=this.attributes;for(const t of n)if(t.name===e)return t;const r=new zV(e,t);return n.push(r),r}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return"void"===e||"property"===e||"sampler"===e||"texture"===e||"cubeTexture"===e||"storageTexture"===e||"depthTexture"===e||"texture3D"===e}needsToWorkingColorSpace(){return!1}getComponentTypeFromTexture(e){const t=e.type;if(e.isDataTexture){if(t===de)return"int";if(t===he)return"uint"}return"float"}getElementType(e){return"mat2"===e?"vec2":"mat3"===e?"vec3":"mat4"===e?"vec4":this.getComponentType(e)}getComponentType(e){if("float"===(e=this.getVectorType(e))||"bool"===e||"int"===e||"uint"===e)return e;const t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return null===t?null:"b"===t[1]?"bool":"i"===t[1]?"int":"u"===t[1]?"uint":"float"}getVectorType(e){return"color"===e?"vec3":"texture"===e||"cubeTexture"===e||"storageTexture"===e||"texture3D"===e?"vec4":e}getTypeFromLength(e,t="float"){if(1===e)return t;const n=NE(e);return("float"===t?"":t[0])+n}getTypeFromArray(e){return Lz.get(e.constructor)}getTypeFromAttribute(e){let t=e;e.isInterleavedBufferAttribute&&(t=e.data);const n=t.array,r=e.itemSize,i=e.normalized;let s;return e instanceof li||!0===i||(s=this.getTypeFromArray(n)),this.getTypeFromLength(r,s)}getTypeLength(e){const t=this.getVectorType(e),n=/vec([2-4])/.exec(t);return null!==n?Number(n[1]):"float"===t||"bool"===t||"int"===t||"uint"===t?1:!0===/mat2/.test(e)?4:!0===/mat3/.test(e)?9:!0===/mat4/.test(e)?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){const t=this.getComponentType(e);return"int"===t||"uint"===t?e:this.changeComponentType(e,"int")}addStack(){return this.stack=SO(this.stack),this.stacks.push(GA()||this.stack),zA(this.stack),this.stack}removeStack(){const e=this.stack;return this.stack=e.parent,zA(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage,n=null){let r=(n=null===n?e.isGlobal(this)?this.globalCache:this.cache:n).getData(e);return void 0===r&&(r={},n.setData(e,r)),void 0===r[t]&&(r[t]={}),r[t]}getNodeProperties(e,t="any"){const n=this.getDataFromNode(e,t);return n.properties||(n.properties={outputNode:null})}getBufferAttributeFromNode(e,t){const n=this.getDataFromNode(e);let r=n.bufferAttribute;if(void 0===r){const i=this.uniforms.index++;r=new zV("nodeAttribute"+i,t,e),this.bufferAttributes.push(r),n.bufferAttribute=r}return r}getStructTypeFromNode(e,t,n=this.shaderStage){const r=this.getDataFromNode(e,n);let i=r.structType;if(void 0===i){const e=this.structs.index++;i=new XV("StructType"+e,t),this.structs[n].push(i),r.structType=i}return i}getUniformFromNode(e,t,n=this.shaderStage,r=null){const i=this.getDataFromNode(e,n,this.globalCache);let s=i.uniform;if(void 0===s){const a=this.uniforms.index++;s=new GV(r||"nodeUniform"+a,t,e),this.uniforms[n].push(s),i.uniform=s}return s}getVarFromNode(e,t=null,n=e.getNodeType(this),r=this.shaderStage){const i=this.getDataFromNode(e,r);let s=i.variable;if(void 0===s){const e=this.vars[r]||(this.vars[r]=[]);null===t&&(t="nodeVar"+e.length),s=new HV(t,n),e.push(s),i.variable=s}return s}getVaryingFromNode(e,t=null,n=e.getNodeType(this)){const r=this.getDataFromNode(e,"any");let i=r.varying;if(void 0===i){const e=this.varyings,s=e.length;null===t&&(t="nodeVarying"+s),i=new $V(t,n),e.push(i),r.varying=i}return i}getCodeFromNode(e,t,n=this.shaderStage){const r=this.getDataFromNode(e);let i=r.code;if(void 0===i){const e=this.codes[n]||(this.codes[n]=[]),s=e.length;i=new WV("nodeCode"+s,t),e.push(i),r.code=i}return i}addFlowCodeHierarchy(e,t){const{flowCodes:n,flowCodeBlock:r}=this.getDataFromNode(e);let i=!0,s=t;for(;s;){if(!0===r.get(s)){i=!1;break}s=this.getDataFromNode(s).parentNodeBlock}if(i)for(const e of n)this.addLineFlowCode(e)}addLineFlowCodeBlock(e,t,n){const r=this.getDataFromNode(e),i=r.flowCodes||(r.flowCodes=[]),s=r.flowCodeBlock||(r.flowCodeBlock=new WeakMap);i.push(t),s.set(n,!0)}addLineFlowCode(e,t=null){return""===e||(null!==t&&this.context.nodeBlock&&this.addLineFlowCodeBlock(t,e,this.context.nodeBlock),e=this.tab+e,/;\s*$/.test(e)||(e+=";\n"),this.flow.code+=e),this}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="\t",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){const t=e.getNodeType(this),n=this.flowChildNode(e,t);return this.flowsData.set(e,n),n}buildFunctionNode(e){const t=new yU,n=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=n,t}flowShaderNode(e){const t=e.layout,n={[Symbol.iterator](){let e=0;const t=Object.values(this);return{next:()=>({value:t[e],done:e++>=t.length})}}};for(const e of t.inputs)n[e.name]=new _O(e.type,e.name);e.layout=null;const r=e.call(n),i=this.flowStagesNode(r,t.type);return e.layout=t,i}flowStagesNode(e,t=null){const n=this.flow,r=this.vars,i=this.cache,s=this.buildStage,a=this.stack,o={code:""};this.flow=o,this.vars={},this.cache=new qV,this.stack=SO();for(const n of WE)this.setBuildStage(n),o.result=e.build(this,t);return o.vars=this.getVars(this.shaderStage),this.flow=n,this.vars=r,this.cache=i,this.stack=a,this.setBuildStage(s),o}getFunctionOperator(){return null}flowChildNode(e,t=null){const n=this.flow,r={code:""};return this.flow=r,r.result=e.build(this,t),this.flow=n,r}flowNodeFromShaderStage(e,t,n=null,r=null){const i=this.shaderStage;this.setShaderStage(e);const s=this.flowChildNode(t,n);return null!==r&&(s.code+=`${this.tab+r} = ${s.result};\n`),this.flowCode[e]=this.flowCode[e]+s.code,this.setShaderStage(i),s}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){}getVaryings(){}getVar(e,t){return`${this.getType(e)} ${t}`}getVars(e){let t="";const n=this.vars[e];if(void 0!==n)for(const e of n)t+=`${this.getVar(e.type,e.name)}; `;return t}getUniforms(){}getCodes(e){const t=this.codes[e];let n="";if(void 0!==t)for(const e of t)n+=e.code+"\n";return n}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){}build(){const{object:e,material:t,renderer:n}=this;if(null!==t){let e=n.library.fromMaterial(t);null===e&&(e=new gN),e.build(this)}else this.addFlow("compute",e);for(const e of WE){this.setBuildStage(e),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex);for(const t of jE){this.setShaderStage(t);const n=this.flowNodes[t];for(const t of n)"generate"===e?this.flowNode(t):t.build(this)}}return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if("float"===t||"int"===t||"uint"===t)return new rz(e);if("vec2"===t||"ivec2"===t||"uvec2"===t)return new iz(e);if("vec3"===t||"ivec3"===t||"uvec3"===t)return new sz(e);if("vec4"===t||"ivec4"===t||"uvec4"===t)return new az(e);if("color"===t)return new oz(e);if("mat3"===t)return new lz(e);if("mat4"===t)return new uz(e);throw new Error(`Uniform "${t}" not declared.`)}format(e,t,n){if((t=this.getVectorType(t))===(n=this.getVectorType(n))||null===n||this.isReference(n))return e;const r=this.getTypeLength(t),i=this.getTypeLength(n);return 16===r&&9===i?`${this.getType(n)}(${e}[0].xyz, ${e}[1].xyz, ${e}[2].xyz)`:9===r&&4===i?`${this.getType(n)}(${e}[0].xy, ${e}[1].xy)`:r>4||i>4||0===i?e:r===i?`${this.getType(n)}( ${e} )`:r>i?this.format(`${e}.${"xyz".slice(0,i)}`,this.getTypeFromLength(i,this.getComponentType(t)),n):4===i&&r>1?`${this.getType(n)}( ${this.format(e,t,"vec3")}, 1.0 )`:2===r?`${this.getType(n)}( ${this.format(e,t,"vec2")}, 0.0 )`:(1===r&&i>1&&t!==this.getComponentType(n)&&(e=`${this.getType(this.getComponentType(n))}( ${e} )`),`${this.getType(n)}( ${e} )`)}getSignature(){return`// Three.js r${h} - Node System\n`}createNodeMaterial(e="NodeMaterial"){throw new Error(`THREE.NodeBuilder: createNodeMaterial() was deprecated. Use new ${e}() instead.`)}}class Dz{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.updateAfterMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let n=e.get(t);return void 0===n&&(n={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,n)),n}updateBeforeNode(e){const t=e.getUpdateBeforeType(),n=e.updateReference(this);if(t===GE.FRAME){const{frameMap:t}=this._getMaps(this.updateBeforeMap,n);t.get(n)!==this.frameId&&!1!==e.updateBefore(this)&&t.set(n,this.frameId)}else if(t===GE.RENDER){const{renderMap:t}=this._getMaps(this.updateBeforeMap,n);t.get(n)!==this.renderId&&!1!==e.updateBefore(this)&&t.set(n,this.renderId)}else t===GE.OBJECT&&e.updateBefore(this)}updateAfterNode(e){const t=e.getUpdateAfterType(),n=e.updateReference(this);if(t===GE.FRAME){const{frameMap:t}=this._getMaps(this.updateAfterMap,n);t.get(n)!==this.frameId&&!1!==e.updateAfter(this)&&t.set(n,this.frameId)}else if(t===GE.RENDER){const{renderMap:t}=this._getMaps(this.updateAfterMap,n);t.get(n)!==this.renderId&&!1!==e.updateAfter(this)&&t.set(n,this.renderId)}else t===GE.OBJECT&&e.updateAfter(this)}updateNode(e){const t=e.getUpdateType(),n=e.updateReference(this);if(t===GE.FRAME){const{frameMap:t}=this._getMaps(this.updateMap,n);t.get(n)!==this.frameId&&!1!==e.update(this)&&t.set(n,this.frameId)}else if(t===GE.RENDER){const{renderMap:t}=this._getMaps(this.updateMap,n);t.get(n)!==this.renderId&&!1!==e.update(this)&&t.set(n,this.renderId)}else t===GE.OBJECT&&e.update(this)}update(){this.frameId++,void 0===this.lastTime&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}}class kz{constructor(e,t,n=null,r="",i=!1){this.type=e,this.name=t,this.count=n,this.qualifier=r,this.isConst=i}}kz.isNodeFunctionInput=!0;class Oz extends xB{static get type(){return"DirectionalLightNode"}constructor(e=null){super(e)}setup(e){super.setup(e);const t=e.context.lightingModel,n=this.colorNode,r=eB(this.light),i=e.context.reflectedLight;t.direct({lightDirection:r,lightColor:n,reflectedLight:i},e.stack,e)}}const Fz=new tr,Uz=new tr;let Bz=null;class Vz extends xB{static get type(){return"RectAreaLightNode"}constructor(e=null){super(e),this.halfHeight=_w(new An).setGroup(vw),this.halfWidth=_w(new An).setGroup(vw),this.updateType=GE.RENDER}update(e){super.update(e);const{light:t}=this,n=e.camera.matrixWorldInverse;Uz.identity(),Fz.copy(t.matrixWorld),Fz.premultiply(n),Uz.extractRotation(Fz),this.halfWidth.value.set(.5*t.width,0,0),this.halfHeight.value.set(0,.5*t.height,0),this.halfWidth.value.applyMatrix4(Uz),this.halfHeight.value.applyMatrix4(Uz)}setup(e){let t,n;super.setup(e),e.isAvailable("float32Filterable")?(t=BC(Bz.LTC_FLOAT_1),n=BC(Bz.LTC_FLOAT_2)):(t=BC(Bz.LTC_HALF_1),n=BC(Bz.LTC_HALF_2));const{colorNode:r,light:i}=this,s=e.context.lightingModel,a=JU(i),o=e.context.reflectedLight;s.directRectArea({lightColor:r,lightPosition:a,halfWidth:this.halfWidth,halfHeight:this.halfHeight,reflectedLight:o,ltc_1:t,ltc_2:n},e.stack,e)}static setLTC(e){Bz=e}}class zz extends xB{static get type(){return"SpotLightNode"}constructor(e=null){super(e),this.coneCosNode=_w(0).setGroup(vw),this.penumbraCosNode=_w(0).setGroup(vw),this.cutoffDistanceNode=_w(0).setGroup(vw),this.decayExponentNode=_w(0).setGroup(vw)}update(e){super.update(e);const{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e){const{coneCosNode:t,penumbraCosNode:n}=this;return IR(t,n,e)}setup(e){super.setup(e);const t=e.context.lightingModel,{colorNode:n,cutoffDistanceNode:r,decayExponentNode:i,light:s}=this,a=JU(s).sub(yI),o=a.normalize(),l=o.dot(eB(s)),u=this.getSpotAttenuation(l),c=a.length(),d=SB({lightDistance:c,cutoffDistance:r,decayExponent:i});let h=n.mul(u).mul(d);if(s.map){const e=KU(s),t=BC(s.map,e.xy).onRenderUpdate(()=>s.map);h=e.mul(2).sub(1).abs().lessThan(1).all().select(h.mul(t),h)}const f=e.context.reflectedLight;t.direct({lightDirection:o,lightColor:h,reflectedLight:f},e.stack,e)}}class Gz extends zz{static get type(){return"IESSpotLightNode"}getSpotAttenuation(e){const t=this.light.iesMap;let n=null;if(t&&!0===t.isTexture){const r=e.acos().mul(1/Math.PI);n=BC(t,KA(r,0),0).r}else n=super.getSpotAttenuation(e);return n}}class Hz extends xB{static get type(){return"AmbientLightNode"}constructor(e=null){super(e)}setup({context:e}){e.irradiance.addAssign(this.colorNode)}}class $z extends xB{static get type(){return"HemisphereLightNode"}constructor(e=null){super(e),this.lightPositionNode=QU(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=_w(new qr).setGroup(vw)}update(e){const{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){const{colorNode:t,groundColorNode:n,lightDirectionNode:r}=this,i=wI.dot(r).mul(.5).add(.5),s=wR(n,t,i);e.context.irradiance.addAssign(s)}}class Wz extends xB{static get type(){return"LightProbeNode"}constructor(e=null){super(e);const t=[];for(let e=0;e<9;e++)t.push(new An);this.lightProbe=$I(t)}update(e){const{light:t}=this;super.update(e);for(let e=0;e<9;e++)this.lightProbe.array[e].copy(t.sh.coefficients[e]).multiplyScalar(t.intensity)}setup(e){const t=DV(MI,this.lightProbe);e.context.irradiance.addAssign(t)}}class jz{parseFunction(){}}class qz{constructor(e,t,n="",r=""){this.type=e,this.inputs=t,this.name=n,this.precision=r}getCode(){}}qz.isNodeFunction=!0;const Xz=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,Yz=/[a-z_0-9]+/gi,Kz="#pragma main";class Qz extends qz{constructor(e){const{type:t,inputs:n,name:r,precision:i,inputsCode:s,blockCode:a,headerCode:o}=(e=>{const t=(e=e.trim()).indexOf(Kz),n=-1!==t?e.slice(t+12):e,r=n.match(Xz);if(null!==r&&5===r.length){const i=r[4],s=[];let a=null;for(;null!==(a=Yz.exec(i));)s.push(a);const o=[];let l=0;for(;l<s.length;){const e="const"===s[l][0];!0===e&&l++;let t=s[l][0];"in"===t||"out"===t||"inout"===t?l++:t="";const n=s[l++][0];let r=Number.parseInt(s[l][0]);!1===Number.isNaN(r)?l++:r=null;const i=s[l++][0];o.push(new kz(n,i,r,t,e))}const u=n.substring(r[0].length),c=void 0!==r[3]?r[3]:"";return{type:r[2],inputs:o,name:c,precision:void 0!==r[1]?r[1]:"",inputsCode:i,blockCode:u,headerCode:-1!==t?e.slice(0,t):""}}throw new Error("FunctionNode: Function is not a GLSL code.")})(e);super(t,n,r,i),this.inputsCode=s,this.blockCode=a,this.headerCode=o}getCode(e=this.name){let t;const n=this.blockCode;if(""!==n){const{type:r,inputsCode:i,headerCode:s,precision:a}=this;let o=`${r} ${e} ( ${i.trim()} )`;""!==a&&(o=`${a} ${o}`),t=s+o+n}else t="";return t}}class Zz extends jz{parseFunction(e){return new Qz(e)}}const Jz=new WeakMap;class eG extends $k{constructor(e,t){super(),this.renderer=e,this.backend=t,this.nodeFrame=new Dz,this.nodeBuilderCache=new Map,this.callHashCache=new Bk,this.groupsData=new Bk,this.cacheLib={}}updateGroup(e){const t=e.groupNode,n=t.name;if(n===yw.name)return!0;if(n===vw.name){const t=this.get(e),n=this.nodeFrame.renderId;return t.renderId!==n&&(t.renderId=n,!0)}if(n===gw.name){const t=this.get(e),n=this.nodeFrame.frameId;return t.frameId!==n&&(t.frameId=n,!0)}const r=[t,e];let i=this.groupsData.get(r);return void 0===i&&this.groupsData.set(r,i={}),i.version!==t.version&&(i.version=t.version,!0)}getForRenderCacheKey(e){return e.initialCacheKey}getForRender(e){const t=this.get(e);let n=t.nodeBuilderState;if(void 0===n){const{nodeBuilderCache:r}=this,i=this.getForRenderCacheKey(e);if(n=r.get(i),void 0===n){const t=this.backend.createNodeBuilder(e.object,this.renderer);t.scene=e.scene,t.material=e.material,t.camera=e.camera,t.context.material=e.material,t.lightsNode=e.lightsNode,t.environmentNode=this.getEnvironmentNode(e.scene),t.fogNode=this.getFogNode(e.scene),t.clippingContext=e.clippingContext,t.build(),n=this._createNodeBuilderState(t),r.set(i,n)}n.usedTimes++,t.nodeBuilderState=n}return n}delete(e){if(e.isRenderObject){const t=this.get(e).nodeBuilderState;t.usedTimes--,0===t.usedTimes&&this.nodeBuilderCache.delete(this.getForRenderCacheKey(e))}return super.delete(e)}getForCompute(e){const t=this.get(e);let n=t.nodeBuilderState;if(void 0===n){const r=this.backend.createNodeBuilder(e,this.renderer);r.build(),n=this._createNodeBuilderState(r),t.nodeBuilderState=n}return n}_createNodeBuilderState(e){return new VV(e.vertexShader,e.fragmentShader,e.computeShader,e.getAttributesArray(),e.getBindings(),e.updateNodes,e.updateBeforeNodes,e.updateAfterNodes,e.monitor,e.transforms)}getEnvironmentNode(e){this.updateEnvironment(e);let t=null;if(e.environmentNode&&e.environmentNode.isNode)t=e.environmentNode;else{const n=this.get(e);n.environmentNode&&(t=n.environmentNode)}return t}getBackgroundNode(e){this.updateBackground(e);let t=null;if(e.backgroundNode&&e.backgroundNode.isNode)t=e.backgroundNode;else{const n=this.get(e);n.backgroundNode&&(t=n.backgroundNode)}return t}getFogNode(e){return this.updateFog(e),e.fogNode||this.get(e).fogNode||null}getCacheKey(e,t){const n=[e,t],r=this.renderer.info.calls;let i=this.callHashCache.get(n);if(void 0===i||i.callId!==r){const s=this.getEnvironmentNode(e),a=this.getFogNode(e),o=[];t&&o.push(t.getCacheKey(!0)),s&&o.push(s.getCacheKey()),a&&o.push(a.getCacheKey()),o.push(this.renderer.shadowMap.enabled?1:0),i={callId:r,cacheKey:ME(o)},this.callHashCache.set(n,i)}return i.cacheKey}get isToneMappingState(){return!this.renderer.getRenderTarget()}updateBackground(e){const t=this.get(e),n=e.background;if(n){const r=0===e.backgroundBlurriness&&t.backgroundBlurriness>0||e.backgroundBlurriness>0&&0===t.backgroundBlurriness;if(t.background!==n||r){const i=this.getCacheNode("background",n,()=>{if(!0===n.isCubeTexture||n.mapping===Y||n.mapping===K||n.mapping===Q){if(e.backgroundBlurriness>0||n.mapping===Q)return uk(n);{let e;return e=!0===n.isCubeTexture?BI(n):BC(n),DN(e)}}if(!0===n.isTexture)return BC(n,BP.flipY()).setUpdateMatrix(!0);n.isColor},r);t.backgroundNode=i,t.background=n,t.backgroundBlurriness=e.backgroundBlurriness}}else t.backgroundNode&&(delete t.backgroundNode,delete t.background)}getCacheNode(e,t,n,r=!1){const i=this.cacheLib[e]||(this.cacheLib[e]=new WeakMap);let s=i.get(t);return(void 0===s||r)&&(s=n(),i.set(t,s)),s}updateFog(e){const t=this.get(e),n=e.fog;if(n){if(t.fog!==n){const e=this.getCacheNode("fog",n,()=>{if(n.isFogExp2){const e=qI("color","color",n).setGroup(vw),t=qI("density","float",n).setGroup(vw);return IU(e,CU(t))}if(n.isFog){const e=qI("color","color",n).setGroup(vw),t=qI("near","float",n).setGroup(vw),r=qI("far","float",n).setGroup(vw);return IU(e,RU(t,r))}});t.fogNode=e,t.fog=n}}else delete t.fogNode,delete t.fog}updateEnvironment(e){const t=this.get(e),n=e.environment;if(n){if(t.environment!==n){const e=this.getCacheNode("environment",n,()=>!0===n.isCubeTexture?BI(n):!0===n.isTexture?BC(n):void 0);t.environmentNode=e,t.environment=n}}else t.environmentNode&&(delete t.environmentNode,delete t.environment)}getNodeFrame(e=this.renderer,t=null,n=null,r=null,i=null){const s=this.nodeFrame;return s.renderer=e,s.scene=t,s.object=n,s.camera=r,s.material=i,s}getNodeFrameForRender(e){return this.getNodeFrame(e.renderer,e.scene,e.object,e.camera,e.material)}getOutputCacheKey(){const e=this.renderer;return e.toneMapping+","+e.currentColorSpace}hasOutputChange(e){return Jz.get(e)!==this.getOutputCacheKey()}getOutputNode(e){const t=this.renderer,n=this.getOutputCacheKey(),r=BC(e,BP).renderOutput(t.toneMapping,t.currentColorSpace);return Jz.set(e,n),r}updateBefore(e){const t=e.getNodeBuilderState();for(const n of t.updateBeforeNodes)this.getNodeFrameForRender(e).updateBeforeNode(n)}updateAfter(e){const t=e.getNodeBuilderState();for(const n of t.updateAfterNodes)this.getNodeFrameForRender(e).updateAfterNode(n)}updateForCompute(e){const t=this.getNodeFrame(),n=this.getForCompute(e);for(const e of n.updateNodes)t.updateNode(e)}updateForRender(e){const t=this.getNodeFrameForRender(e),n=e.getNodeBuilderState();for(const e of n.updateNodes)t.updateNode(e)}needsRefresh(e){const t=this.getNodeFrameForRender(e);return e.getMonitor().needsRefresh(e,t)}dispose(){super.dispose(),this.nodeFrame=new Dz,this.nodeBuilderCache=new Map,this.cacheLib={}}}const tG=new $s;class nG{constructor(e=null){this.version=0,this.clipIntersection=null,this.cacheKey="",this.shadowPass=!1,this.viewNormalMatrix=new Kt,this.clippingGroupContexts=new WeakMap,this.intersectionPlanes=[],this.unionPlanes=[],this.parentVersion=null,null!==e&&(this.viewNormalMatrix=e.viewNormalMatrix,this.clippingGroupContexts=e.clippingGroupContexts,this.shadowPass=e.shadowPass,this.viewMatrix=e.viewMatrix)}projectPlanes(e,t,n){const r=e.length;for(let i=0;i<r;i++){tG.copy(e[i]).applyMatrix4(this.viewMatrix,this.viewNormalMatrix);const r=t[n+i],s=tG.normal;r.x=-s.x,r.y=-s.y,r.z=-s.z,r.w=tG.constant}}updateGlobal(e,t){this.shadowPass=null!==e.overrideMaterial&&e.overrideMaterial.isShadowNodeMaterial,this.viewMatrix=t.matrixWorldInverse,this.viewNormalMatrix.getNormalMatrix(this.viewMatrix)}update(e,t){let n=!1;e.version!==this.parentVersion&&(this.intersectionPlanes=Array.from(e.intersectionPlanes),this.unionPlanes=Array.from(e.unionPlanes),this.parentVersion=e.version),this.clipIntersection!==t.clipIntersection&&(this.clipIntersection=t.clipIntersection,this.clipIntersection?this.unionPlanes.length=e.unionPlanes.length:this.intersectionPlanes.length=e.intersectionPlanes.length);const r=t.clippingPlanes,i=r.length;let s,a;if(this.clipIntersection?(s=this.intersectionPlanes,a=e.intersectionPlanes.length):(s=this.unionPlanes,a=e.unionPlanes.length),s.length!==a+i){s.length=a+i;for(let e=0;e<i;e++)s[a+e]=new bn;n=!0}this.projectPlanes(r,s,a),n&&(this.version++,this.cacheKey=`${this.intersectionPlanes.length}:${this.unionPlanes.length}`)}getGroupContext(e){if(this.shadowPass&&!e.clipShadows)return this;let t=this.clippingGroupContexts.get(e);return void 0===t&&(t=new nG(this),this.clippingGroupContexts.set(e,t)),t.update(this,e),t}get unionClippingCount(){return this.unionPlanes.length}}class rG{constructor(e,t){this.bundleGroup=e,this.camera=t}}class iG{constructor(){this.bundles=new Bk}get(e,t){const n=this.bundles,r=[e,t];let i=n.get(r);return void 0===i&&(i=new rG(e,t),n.set(r,i)),i}dispose(){this.bundles=new Bk}}class sG{constructor(){this.lightNodes=new WeakMap,this.materialNodes=new Map,this.toneMappingNodes=new Map}fromMaterial(e){if(e.isNodeMaterial)return e;let t=null;const n=this.getMaterialNodeClass(e.type);if(null!==n){t=new n;for(const n in e)t[n]=e[n]}return t}addToneMapping(e,t){this.addType(e,t,this.toneMappingNodes)}getToneMappingFunction(e){return this.toneMappingNodes.get(e)||null}getMaterialNodeClass(e){return this.materialNodes.get(e)||null}addMaterial(e,t){this.addType(e,t,this.materialNodes)}getLightNodeClass(e){return this.lightNodes.get(e)||null}addLight(e,t){this.addClass(e,t,this.lightNodes)}addType(e,t,n){if(!n.has(t)){if("function"!=typeof e)throw new Error(`Node class ${e.name} is not a class.`);if("function"==typeof t||"object"==typeof t)throw new Error(`Base class ${t} is not a class.`);n.set(t,e)}}addClass(e,t,n){if(!n.has(t)){if("function"!=typeof e)throw new Error(`Node class ${e.name} is not a class.`);if("function"!=typeof t)throw new Error(`Base class ${t.name} is not a class.`);n.set(t,e)}}}const aG=new rB;class oG extends Bk{constructor(){super()}createNode(e=[]){return(new rB).setLights(e)}getNode(e,t){if(e.isQuadMesh)return aG;const n=[e,t];let r=this.get(n);return void 0===r&&(r=this.createNode(),this.set(n,r)),r}}const lG=new Xi,uG=new Yt,cG=new bn,dG=new qs,hG=new tr,fG=new bn;class pG{constructor(e,t={}){this.isRenderer=!0;const{logarithmicDepthBuffer:n=!1,alpha:r=!0,depth:i=!0,stencil:s=!1,antialias:a=!1,samples:o=0,getFallback:l=null}=t;this.domElement=e.getDomElement(),this.backend=e,this.samples=o||!0===a?4:0,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.alpha=r,this.logarithmicDepthBuffer=n,this.outputColorSpace=yt,this.toneMapping=0,this.toneMappingExposure=1,this.sortObjects=!0,this.depth=i,this.stencil=s,this.info=new eO,this.nodes={modelViewMatrix:null,modelNormalViewMatrix:null},this.library=new sG,this.lighting=new oG,this._getFallback=l,this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=new bn(0,0,this._width,this._height),this._scissor=new bn(0,0,this._width,this._height),this._scissorTest=!1,this._attributes=null,this._geometries=null,this._nodes=null,this._animation=null,this._bindings=null,this._objects=null,this._pipelines=null,this._bundles=null,this._renderLists=null,this._renderContexts=null,this._textures=null,this._background=null,this._quad=new hF(new gN),this._quad.material.name="Renderer_output",this._currentRenderContext=null,this._opaqueSort=null,this._transparentSort=null,this._frameBufferTarget=null;const u=!0===this.alpha?0:1;this._clearColor=new bO(0,0,0,u),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._activeCubeFace=0,this._activeMipmapLevel=0,this._mrt=null,this._renderObjectFunction=null,this._currentRenderObjectFunction=null,this._currentRenderBundle=null,this._handleObjectFunction=this._renderObjectDirect,this._isDeviceLost=!1,this.onDeviceLost=this._onDeviceLost,this._initialized=!1,this._initPromise=null,this._compilationPromises=null,this.transparent=!0,this.opaque=!0,this.shadowMap={enabled:!1,type:1},this.xr={enabled:!1},this.debug={checkShaderErrors:!0,onShaderError:null,getShaderAsync:async(e,t,n)=>{await this.compileAsync(e,t);const r=this._renderLists.get(e,t),i=this._renderContexts.get(e,t,this._renderTarget),s=e.overrideMaterial||n.material,a=this._objects.get(n,s,e,t,r.lightsNode,i,i.clippingContext),{fragmentShader:o,vertexShader:l}=a.getNodeBuilderState();return{fragmentShader:o,vertexShader:l}}}}async init(){if(this._initialized)throw new Error("Renderer: Backend has already been initialized.");return null!==this._initPromise||(this._initPromise=new Promise(async(e,t)=>{let n=this.backend;try{await n.init(this)}catch(e){if(null===this._getFallback)return void t(e);try{this.backend=n=this._getFallback(e),await n.init(this)}catch(e){return void t(e)}}this._nodes=new eG(this,n),this._animation=new Uk(this._nodes,this.info),this._attributes=new Kk(n),this._background=new FV(this,this._nodes),this._geometries=new Jk(this._attributes,this.info),this._textures=new yO(this,n,this.info),this._pipelines=new aO(n,this._nodes),this._bindings=new oO(n,this._nodes,this._textures,this._attributes,this._pipelines,this.info),this._objects=new Hk(this,this._nodes,this._geometries,this._pipelines,this._bindings,this.info),this._renderLists=new hO(this.lighting),this._bundles=new iG,this._renderContexts=new gO,this._animation.start(),this._initialized=!0,e()})),this._initPromise}get coordinateSystem(){return this.backend.coordinateSystem}async compileAsync(e,t,n=null){if(!0===this._isDeviceLost)return;!1===this._initialized&&await this.init();const r=this._nodes.nodeFrame,i=r.renderId,s=this._currentRenderContext,a=this._currentRenderObjectFunction,o=this._compilationPromises,l=!0===e.isScene?e:lG;null===n&&(n=e);const u=this._renderTarget,c=this._renderContexts.get(n,t,u),d=this._activeMipmapLevel,h=[];this._currentRenderContext=c,this._currentRenderObjectFunction=this.renderObject,this._handleObjectFunction=this._createObjectPipeline,this._compilationPromises=h,r.renderId++,r.update(),c.depth=this.depth,c.stencil=this.stencil,c.clippingContext||(c.clippingContext=new nG),c.clippingContext.updateGlobal(l,t),l.onBeforeRender(this,e,t,u);const f=this._renderLists.get(e,t);if(f.begin(),this._projectObject(e,t,0,f,c.clippingContext),n!==e&&n.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&f.pushLight(e)}),f.finish(),null!==u){this._textures.updateRenderTarget(u,d);const e=this._textures.get(u);c.textures=e.textures,c.depthTexture=e.depthTexture}else c.textures=null,c.depthTexture=null;this._background.update(l,f,c);const p=f.opaque,m=f.transparent,g=f.transparentDoublePass,v=f.lightsNode;!0===this.opaque&&p.length>0&&this._renderObjects(p,t,l,v),!0===this.transparent&&m.length>0&&this._renderTransparents(m,g,t,l,v),r.renderId=i,this._currentRenderContext=s,this._currentRenderObjectFunction=a,this._compilationPromises=o,this._handleObjectFunction=this._renderObjectDirect,await Promise.all(h)}async renderAsync(e,t){!1===this._initialized&&await this.init();const n=this._renderScene(e,t);await this.backend.resolveTimestampAsync(n,"render")}async waitForGPU(){await this.backend.waitForGPU()}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}_onDeviceLost(e){let t=`THREE.WebGPURenderer: ${e.api} Device Lost:\n\nMessage: ${e.message}`;e.reason&&(t+=`\nReason: ${e.reason}`),this._isDeviceLost=!0}_renderBundle(e,t,n){const{bundleGroup:r,camera:i,renderList:s}=e,a=this._currentRenderContext,o=this._bundles.get(r,i),l=this.backend.get(o);void 0===l.renderContexts&&(l.renderContexts=new Set);const u=r.version!==l.version,c=!1===l.renderContexts.has(a)||u;if(l.renderContexts.add(a),c){this.backend.beginBundle(a),(void 0===l.renderObjects||u)&&(l.renderObjects=[]),this._currentRenderBundle=o;const e=s.opaque;!0===this.opaque&&e.length>0&&this._renderObjects(e,i,t,n),this._currentRenderBundle=null,this.backend.finishBundle(a,o),l.version=r.version}else{const{renderObjects:e}=l;for(let t=0,n=e.length;t<n;t++){const n=e[t];this._nodes.needsRefresh(n)&&(this._nodes.updateBefore(n),this._nodes.updateForRender(n),this._bindings.updateForRender(n),this._nodes.updateAfter(n))}}this.backend.addBundle(a,o)}render(e,t){if(!1===this._initialized)return this.renderAsync(e,t);this._renderScene(e,t)}_getFrameBufferTarget(){const{currentToneMapping:e,currentColorSpace:t}=this;if(!1===(0!==e)&&!1===(t!==bt))return null;const{width:n,height:r}=this.getDrawingBufferSize(uG),{depth:i,stencil:s}=this;let a=this._frameBufferTarget;return null===a&&(a=new _n(n,r,{depthBuffer:i,stencilBuffer:s,type:pe,format:xe,colorSpace:bt,generateMipmaps:!1,minFilter:ie,magFilter:ie,samples:this.samples}),a.isPostProcessingRenderTarget=!0,this._frameBufferTarget=a),a.depthBuffer=i,a.stencilBuffer=s,a.setSize(n,r),a.viewport.copy(this._viewport),a.scissor.copy(this._scissor),a.viewport.multiplyScalar(this._pixelRatio),a.scissor.multiplyScalar(this._pixelRatio),a.scissorTest=this._scissorTest,a}_renderScene(e,t,n=!0){if(!0===this._isDeviceLost)return;const r=n?this._getFrameBufferTarget():null,i=this._nodes.nodeFrame,s=i.renderId,a=this._currentRenderContext,o=this._currentRenderObjectFunction,l=!0===e.isScene?e:lG,u=this._renderTarget,c=this._activeCubeFace,d=this._activeMipmapLevel;let h;null!==r?(h=r,this.setRenderTarget(h)):h=u;const f=this._renderContexts.get(e,t,h);this._currentRenderContext=f,this._currentRenderObjectFunction=this._renderObjectFunction||this.renderObject,this.info.calls++,this.info.render.calls++,this.info.render.frameCalls++,i.renderId=this.info.calls;const p=this.coordinateSystem;t.coordinateSystem!==p&&(t.coordinateSystem=p,t.updateProjectionMatrix()),!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld();let m=this._viewport,g=this._scissor,v=this._pixelRatio;null!==h&&(m=h.viewport,g=h.scissor,v=1),this.getDrawingBufferSize(uG),cG.set(0,0,uG.width,uG.height);const y=void 0===m.minDepth?0:m.minDepth,b=void 0===m.maxDepth?1:m.maxDepth;f.viewportValue.copy(m).multiplyScalar(v).floor(),f.viewportValue.width>>=d,f.viewportValue.height>>=d,f.viewportValue.minDepth=y,f.viewportValue.maxDepth=b,f.viewport=!1===f.viewportValue.equals(cG),f.scissorValue.copy(g).multiplyScalar(v).floor(),f.scissor=this._scissorTest&&!1===f.scissorValue.equals(cG),f.scissorValue.width>>=d,f.scissorValue.height>>=d,f.clippingContext||(f.clippingContext=new nG),f.clippingContext.updateGlobal(l,t),l.onBeforeRender(this,e,t,h),hG.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),dG.setFromProjectionMatrix(hG,p);const _=this._renderLists.get(e,t);if(_.begin(),this._projectObject(e,t,0,_,f.clippingContext),_.finish(),!0===this.sortObjects&&_.sort(this._opaqueSort,this._transparentSort),null!==h){this._textures.updateRenderTarget(h,d);const e=this._textures.get(h);f.textures=e.textures,f.depthTexture=e.depthTexture,f.width=e.width,f.height=e.height,f.renderTarget=h,f.depth=h.depthBuffer,f.stencil=h.stencilBuffer}else f.textures=null,f.depthTexture=null,f.width=this.domElement.width,f.height=this.domElement.height,f.depth=this.depth,f.stencil=this.stencil;f.width>>=d,f.height>>=d,f.activeCubeFace=c,f.activeMipmapLevel=d,f.occlusionQueryCount=_.occlusionQueryCount,this._background.update(l,_,f),this.backend.beginRender(f);const{bundles:x,lightsNode:S,transparentDoublePass:T,transparent:E,opaque:A}=_;if(x.length>0&&this._renderBundles(x,l,S),!0===this.opaque&&A.length>0&&this._renderObjects(A,t,l,S),!0===this.transparent&&E.length>0&&this._renderTransparents(E,T,t,l,S),this.backend.finishRender(f),i.renderId=s,this._currentRenderContext=a,this._currentRenderObjectFunction=o,null!==r){this.setRenderTarget(u,c,d);const e=this._quad;this._nodes.hasOutputChange(h.texture)&&(e.material.fragmentNode=this._nodes.getOutputNode(h.texture),e.material.needsUpdate=!0),this._renderScene(e,e.camera,!1)}return l.onAfterRender(this,e,t,h),f}getMaxAnisotropy(){return this.backend.getMaxAnisotropy()}getActiveCubeFace(){return this._activeCubeFace}getActiveMipmapLevel(){return this._activeMipmapLevel}async setAnimationLoop(e){!1===this._initialized&&await this.init(),this._animation.setAnimationLoop(e)}async getArrayBufferAsync(e){return await this.backend.getArrayBufferAsync(e)}getContext(){return this.backend.getContext()}getPixelRatio(){return this._pixelRatio}getDrawingBufferSize(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()}getSize(e){return e.set(this._width,this._height)}setPixelRatio(e=1){this._pixelRatio!==e&&(this._pixelRatio=e,this.setSize(this._width,this._height,!1))}setDrawingBufferSize(e,t,n){this._width=e,this._height=t,this._pixelRatio=n,this.domElement.width=Math.floor(e*n),this.domElement.height=Math.floor(t*n),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize()}setSize(e,t,n=!0){this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),!0===n&&(this.domElement.style.width=e+"px",this.domElement.style.height=t+"px"),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize()}setOpaqueSort(e){this._opaqueSort=e}setTransparentSort(e){this._transparentSort=e}getScissor(e){const t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}setScissor(e,t,n,r){const i=this._scissor;e.isVector4?i.copy(e):i.set(e,t,n,r)}getScissorTest(){return this._scissorTest}setScissorTest(e){this._scissorTest=e,this.backend.setScissorTest(e)}getViewport(e){return e.copy(this._viewport)}setViewport(e,t,n,r,i=0,s=1){const a=this._viewport;e.isVector4?a.copy(e):a.set(e,t,n,r),a.minDepth=i,a.maxDepth=s}getClearColor(e){return e.copy(this._clearColor)}setClearColor(e,t=1){this._clearColor.set(e),this._clearColor.a=t}getClearAlpha(){return this._clearColor.a}setClearAlpha(e){this._clearColor.a=e}getClearDepth(){return this._clearDepth}setClearDepth(e){this._clearDepth=e}getClearStencil(){return this._clearStencil}setClearStencil(e){this._clearStencil=e}isOccluded(e){const t=this._currentRenderContext;return t&&this.backend.isOccluded(t,e)}clear(e=!0,t=!0,n=!0){if(!1===this._initialized)return this.clearAsync(e,t,n);const r=this._renderTarget||this._getFrameBufferTarget();let i=null;if(null!==r){this._textures.updateRenderTarget(r);const e=this._textures.get(r);i=this._renderContexts.get(null,null,r),i.textures=e.textures,i.depthTexture=e.depthTexture,i.width=e.width,i.height=e.height,i.renderTarget=r,i.depth=r.depthBuffer,i.stencil=r.stencilBuffer}if(this.backend.clear(e,t,n,i),null!==r&&null===this._renderTarget){const e=this._quad;this._nodes.hasOutputChange(r.texture)&&(e.material.fragmentNode=this._nodes.getOutputNode(r.texture),e.material.needsUpdate=!0),this._renderScene(e,e.camera,!1)}}clearColor(){return this.clear(!0,!1,!1)}clearDepth(){return this.clear(!1,!0,!1)}clearStencil(){return this.clear(!1,!1,!0)}async clearAsync(e=!0,t=!0,n=!0){!1===this._initialized&&await this.init(),this.clear(e,t,n)}async clearColorAsync(){this.clearAsync(!0,!1,!1)}async clearDepthAsync(){this.clearAsync(!1,!0,!1)}async clearStencilAsync(){this.clearAsync(!1,!1,!0)}get currentToneMapping(){return null!==this._renderTarget?0:this.toneMapping}get currentColorSpace(){return null!==this._renderTarget?bt:this.outputColorSpace}dispose(){this.info.dispose(),this.backend.dispose(),this._animation.dispose(),this._objects.dispose(),this._pipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._renderLists.dispose(),this._renderContexts.dispose(),this._textures.dispose(),this.setRenderTarget(null),this.setAnimationLoop(null)}setRenderTarget(e,t=0,n=0){this._renderTarget=e,this._activeCubeFace=t,this._activeMipmapLevel=n}getRenderTarget(){return this._renderTarget}setRenderObjectFunction(e){this._renderObjectFunction=e}getRenderObjectFunction(){return this._renderObjectFunction}compute(e){if(!0===this.isDeviceLost)return;if(!1===this._initialized)return this.computeAsync(e);const t=this._nodes.nodeFrame,n=t.renderId;this.info.calls++,this.info.compute.calls++,this.info.compute.frameCalls++,t.renderId=this.info.calls;const r=this.backend,i=this._pipelines,s=this._bindings,a=this._nodes,o=Array.isArray(e)?e:[e];if(void 0===o[0]||!0!==o[0].isComputeNode)throw new Error("THREE.Renderer: .compute() expects a ComputeNode.");r.beginCompute(e);for(const t of o){if(!1===i.has(t)){const e=()=>{t.removeEventListener("dispose",e),i.delete(t),s.delete(t),a.delete(t)};t.addEventListener("dispose",e);const n=t.onInitFunction;null!==n&&n.call(t,{renderer:this})}a.updateForCompute(t),s.updateForCompute(t);const n=s.getForCompute(t),o=i.getForCompute(t,n);r.compute(e,t,n,o)}r.finishCompute(e),t.renderId=n}async computeAsync(e){!1===this._initialized&&await this.init(),this.compute(e),await this.backend.resolveTimestampAsync(e,"compute")}async hasFeatureAsync(e){return!1===this._initialized&&await this.init(),this.backend.hasFeature(e)}hasFeature(e){return!1!==this._initialized&&this.backend.hasFeature(e)}hasInitialized(){return this._initialized}async initTextureAsync(e){!1===this._initialized&&await this.init(),this._textures.updateTexture(e)}initTexture(e){this._initialized,this._textures.updateTexture(e)}copyFramebufferToTexture(e,t=null){if(null!==t)if(t.isVector2)t=fG.set(t.x,t.y,e.image.width,e.image.height).floor();else{if(!t.isVector4)return;t=fG.copy(t).floor()}else t=fG.set(0,0,e.image.width,e.image.height);let n,r=this._currentRenderContext;null!==r?n=r.renderTarget:(n=this._renderTarget||this._getFrameBufferTarget(),null!==n&&(this._textures.updateRenderTarget(n),r=this._textures.get(n))),this._textures.updateTexture(e,{renderTarget:n}),this.backend.copyFramebufferToTexture(e,r,t)}copyTextureToTexture(e,t,n=null,r=null,i=0){this._textures.updateTexture(e),this._textures.updateTexture(t),this.backend.copyTextureToTexture(e,t,n,r,i)}async readRenderTargetPixelsAsync(e,t,n,r,i,s=0,a=0){return this.backend.copyTextureToBuffer(e.textures[s],t,n,r,i,a)}_projectObject(e,t,n,r,i){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)n=e.renderOrder,e.isClippingGroup&&e.enabled&&(i=i.getGroupContext(e));else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)r.pushLight(e);else if(e.isSprite){if(!e.frustumCulled||dG.intersectsSprite(e)){!0===this.sortObjects&&fG.setFromMatrixPosition(e.matrixWorld).applyMatrix4(hG);const{geometry:t,material:s}=e;s.visible&&r.push(e,t,s,n,fG.z,null,i)}}else if(e.isLineLoop);else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||dG.intersectsObject(e))){const{geometry:t,material:s}=e;if(!0===this.sortObjects&&(null===t.boundingSphere&&t.computeBoundingSphere(),fG.copy(t.boundingSphere.center).applyMatrix4(e.matrixWorld).applyMatrix4(hG)),Array.isArray(s)){const a=t.groups;for(let o=0,l=a.length;o<l;o++){const l=a[o],u=s[l.materialIndex];u&&u.visible&&r.push(e,t,u,n,fG.z,l,i)}}else s.visible&&r.push(e,t,s,n,fG.z,null,i)}if(!0===e.isBundleGroup&&void 0!==this.backend.beginBundle){const n=r;(r=this._renderLists.get(e,t)).begin(),n.pushBundle({bundleGroup:e,camera:t,renderList:r}),r.finish()}const s=e.children;for(let e=0,a=s.length;e<a;e++)this._projectObject(s[e],t,n,r,i)}_renderBundles(e,t,n){for(const r of e)this._renderBundle(r,t,n)}_renderTransparents(e,t,n,r,i){if(t.length>0){for(const{material:e}of t)e.side=1;this._renderObjects(t,n,r,i,"backSide");for(const{material:e}of t)e.side=0;this._renderObjects(e,n,r,i);for(const{material:e}of t)e.side=2}else this._renderObjects(e,n,r,i)}_renderObjects(e,t,n,r,i=null){for(let s=0,a=e.length;s<a;s++){const a=e[s],{object:o,geometry:l,material:u,group:c,clippingContext:d}=a;if(t.isArrayCamera){const e=t.cameras;for(let t=0,s=e.length;t<s;t++){const s=e[t];if(o.layers.test(s.layers)){const e=s.viewport,t=void 0===e.minDepth?0:e.minDepth,a=void 0===e.maxDepth?1:e.maxDepth,h=this._currentRenderContext.viewportValue;h.copy(e).multiplyScalar(this._pixelRatio).floor(),h.minDepth=t,h.maxDepth=a,this.backend.updateViewport(this._currentRenderContext),this._currentRenderObjectFunction(o,n,s,l,u,c,r,d,i)}}}else this._currentRenderObjectFunction(o,n,t,l,u,c,r,d,i)}}renderObject(e,t,n,r,i,s,a,o=null,l=null){let u,c,d;if(e.onBeforeRender(this,t,n,r,i,s),null!==t.overrideMaterial){const e=t.overrideMaterial;i.positionNode&&i.positionNode.isNode&&(u=e.positionNode,e.positionNode=i.positionNode),e.alphaTest=i.alphaTest,e.alphaMap=i.alphaMap,e.transparent=i.transparent||i.transmission>0,e.isShadowNodeMaterial&&(e.side=null===i.shadowSide?i.side:i.shadowSide,i.depthNode&&i.depthNode.isNode&&(d=e.depthNode,e.depthNode=i.depthNode),i.castShadowNode&&i.castShadowNode.isNode&&(c=e.colorNode,e.colorNode=i.castShadowNode)),i=e}!0===i.transparent&&2===i.side&&!1===i.forceSinglePass?(i.side=1,this._handleObjectFunction(e,i,t,n,a,s,o,"backSide"),i.side=0,this._handleObjectFunction(e,i,t,n,a,s,o,l),i.side=2):this._handleObjectFunction(e,i,t,n,a,s,o,l),void 0!==u&&(t.overrideMaterial.positionNode=u),void 0!==d&&(t.overrideMaterial.depthNode=d),void 0!==c&&(t.overrideMaterial.colorNode=c),e.onAfterRender(this,t,n,r,i,s)}_renderObjectDirect(e,t,n,r,i,s,a,o){const l=this._objects.get(e,t,n,r,i,this._currentRenderContext,a,o);l.drawRange=e.geometry.drawRange,l.group=s;const u=this._nodes.needsRefresh(l);if(u&&(this._nodes.updateBefore(l),this._geometries.updateForRender(l),this._nodes.updateForRender(l),this._bindings.updateForRender(l)),this._pipelines.updateForRender(l),null!==this._currentRenderBundle){this.backend.get(this._currentRenderBundle).renderObjects.push(l),l.bundle=this._currentRenderBundle.bundleGroup}this.backend.draw(l,this.info),u&&this._nodes.updateAfter(l)}_createObjectPipeline(e,t,n,r,i,s,a,o){const l=this._objects.get(e,t,n,r,i,this._currentRenderContext,a,o);l.drawRange=e.geometry.drawRange,l.group=s,this._nodes.updateBefore(l),this._geometries.updateForRender(l),this._nodes.updateForRender(l),this._bindings.updateForRender(l),this._pipelines.getForRender(l,this._compilationPromises),this._nodes.updateAfter(l)}get compile(){return this.compileAsync}}class mG{constructor(e=""){this.name=e,this.visibility=0}setVisibility(e){this.visibility|=e}clone(){return Object.assign(new this.constructor,this)}}class gG extends mG{constructor(e,t=null){super(e),this.isBuffer=!0,this.bytesPerElement=Float32Array.BYTES_PER_ELEMENT,this._buffer=t}get byteLength(){return(e=this._buffer.byteLength)+(Yk-e%Yk)%Yk;var e}get buffer(){return this._buffer}update(){return!0}}class vG extends gG{constructor(e,t=null){super(e,t),this.isUniformBuffer=!0}}let yG=0;class bG extends vG{constructor(e,t){super("UniformBuffer_"+yG++,e?e.value:null),this.nodeUniform=e,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class _G extends vG{constructor(e){super(e),this.isUniformsGroup=!0,this._values=null,this.uniforms=[]}addUniform(e){return this.uniforms.push(e),this}removeUniform(e){const t=this.uniforms.indexOf(e);return-1!==t&&this.uniforms.splice(t,1),this}get values(){return null===this._values&&(this._values=Array.from(this.buffer)),this._values}get buffer(){let e=this._buffer;if(null===e){const t=this.byteLength;e=new Float32Array(new ArrayBuffer(t)),this._buffer=e}return e}get byteLength(){let e=0;for(let t=0,n=this.uniforms.length;t<n;t++){const n=this.uniforms[t],{boundary:r,itemSize:i}=n,s=e%Yk;0!==s&&Yk-s-r<0?e+=Yk-s:s%r!==0&&(e+=s%r),n.offset=e/this.bytesPerElement,e+=i*this.bytesPerElement}return Math.ceil(e/Yk)*Yk}update(){let e=!1;for(const t of this.uniforms)!0===this.updateByType(t)&&(e=!0);return e}updateByType(e){return e.isNumberUniform?this.updateNumber(e):e.isVector2Uniform?this.updateVector2(e):e.isVector3Uniform?this.updateVector3(e):e.isVector4Uniform?this.updateVector4(e):e.isColorUniform?this.updateColor(e):e.isMatrix3Uniform?this.updateMatrix3(e):e.isMatrix4Uniform?this.updateMatrix4(e):void 0}updateNumber(e){let t=!1;const n=this.values,r=e.getValue(),i=e.offset,s=e.getType();if(n[i]!==r){this._getBufferForType(s)[i]=n[i]=r,t=!0}return t}updateVector2(e){let t=!1;const n=this.values,r=e.getValue(),i=e.offset,s=e.getType();if(n[i+0]!==r.x||n[i+1]!==r.y){const e=this._getBufferForType(s);e[i+0]=n[i+0]=r.x,e[i+1]=n[i+1]=r.y,t=!0}return t}updateVector3(e){let t=!1;const n=this.values,r=e.getValue(),i=e.offset,s=e.getType();if(n[i+0]!==r.x||n[i+1]!==r.y||n[i+2]!==r.z){const e=this._getBufferForType(s);e[i+0]=n[i+0]=r.x,e[i+1]=n[i+1]=r.y,e[i+2]=n[i+2]=r.z,t=!0}return t}updateVector4(e){let t=!1;const n=this.values,r=e.getValue(),i=e.offset,s=e.getType();if(n[i+0]!==r.x||n[i+1]!==r.y||n[i+2]!==r.z||n[i+4]!==r.w){const e=this._getBufferForType(s);e[i+0]=n[i+0]=r.x,e[i+1]=n[i+1]=r.y,e[i+2]=n[i+2]=r.z,e[i+3]=n[i+3]=r.w,t=!0}return t}updateColor(e){let t=!1;const n=this.values,r=e.getValue(),i=e.offset;if(n[i+0]!==r.r||n[i+1]!==r.g||n[i+2]!==r.b){const e=this.buffer;e[i+0]=n[i+0]=r.r,e[i+1]=n[i+1]=r.g,e[i+2]=n[i+2]=r.b,t=!0}return t}updateMatrix3(e){let t=!1;const n=this.values,r=e.getValue().elements,i=e.offset;if(n[i+0]!==r[0]||n[i+1]!==r[1]||n[i+2]!==r[2]||n[i+4]!==r[3]||n[i+5]!==r[4]||n[i+6]!==r[5]||n[i+8]!==r[6]||n[i+9]!==r[7]||n[i+10]!==r[8]){const e=this.buffer;e[i+0]=n[i+0]=r[0],e[i+1]=n[i+1]=r[1],e[i+2]=n[i+2]=r[2],e[i+4]=n[i+4]=r[3],e[i+5]=n[i+5]=r[4],e[i+6]=n[i+6]=r[5],e[i+8]=n[i+8]=r[6],e[i+9]=n[i+9]=r[7],e[i+10]=n[i+10]=r[8],t=!0}return t}updateMatrix4(e){let t=!1;const n=this.values,r=e.getValue().elements,i=e.offset;if(!1===function(e,t,n){for(let r=0,i=t.length;r<i;r++)if(e[n+r]!==t[r])return!1;return!0}(n,r,i)){this.buffer.set(r,i),function(e,t,n){for(let r=0,i=t.length;r<i;r++)e[n+r]=t[r]}(n,r,i),t=!0}return t}_getBufferForType(e){return"int"===e||"ivec2"===e||"ivec3"===e||"ivec4"===e?new Int32Array(this.buffer.buffer):"uint"===e||"uvec2"===e||"uvec3"===e||"uvec4"===e?new Uint32Array(this.buffer.buffer):this.buffer}}let xG=0;class SG extends _G{constructor(e,t){super(e),this.id=xG++,this.groupNode=t,this.isNodeUniformsGroup=!0}}let TG=0;class EG extends mG{constructor(e,t){super(e),this.id=TG++,this.texture=t,this.version=t?t.version:0,this.store=!1,this.generation=null,this.isSampledTexture=!0}needsBindingsUpdate(e){const{texture:t}=this;return e!==this.generation?(this.generation=e,!0):t.isVideoTexture}update(){const{texture:e,version:t}=this;return t!==e.version&&(this.version=e.version,!0)}}class AG extends EG{constructor(e,t,n,r=null){super(e,t?t.value:null),this.textureNode=t,this.groupNode=n,this.access=r}needsBindingsUpdate(e){return this.textureNode.value!==this.texture||super.needsBindingsUpdate(e)}update(){const{textureNode:e}=this;return this.texture!==e.value?(this.texture=e.value,!0):super.update()}}class wG extends AG{constructor(e,t,n,r=null){super(e,t,n,r),this.isSampledCubeTexture=!0}}class MG extends AG{constructor(e,t,n,r=null){super(e,t,n,r),this.isSampledTexture3D=!0}}const RG={textureDimensions:"textureSize",equals:"equal"},CG={low:"lowp",medium:"mediump",high:"highp"},IG={swizzleAssign:!0,storageBuffer:!1},LG="\nprecision highp float;\nprecision highp int;\nprecision highp sampler2D;\nprecision highp sampler3D;\nprecision highp samplerCube;\nprecision highp sampler2DArray;\n\nprecision highp usampler2D;\nprecision highp usampler3D;\nprecision highp usamplerCube;\nprecision highp usampler2DArray;\n\nprecision highp isampler2D;\nprecision highp isampler3D;\nprecision highp isamplerCube;\nprecision highp isampler2DArray;\n\nprecision lowp sampler2DShadow;\n";class PG extends Nz{constructor(e,t){super(e,t,new Zz),this.uniformGroups={},this.transforms=[],this.extensions={},this.builtins={vertex:[],fragment:[],compute:[]},this.useComparisonMethod=!0}needsToWorkingColorSpace(e){return!0===e.isVideoTexture&&e.colorSpace!==vt}getMethod(e){return RG[e]||e}getOutputStructName(){return""}buildFunctionCode(e){const t=e.layout,n=this.flowShaderNode(e),r=[];for(const e of t.inputs)r.push(this.getType(e.type)+" "+e.name);return`${this.getType(t.type)} ${t.name}( ${r.join(", ")} ) {\n\n\t${n.vars}\n\n${n.code}\n\treturn ${n.result};\n\n}`}setupPBO(e){const t=e.value;if(void 0===t.pbo){const e=t.array,n=t.count*t.itemSize,{itemSize:r}=t,i=t.array.constructor.name.toLowerCase().includes("int");let s=i?Me:we;2===r?s=i?Ce:Re:3===r?s=i?1032:_e:4===r&&(s=i?Ie:xe);const a={Float32Array:fe,Uint8Array:oe,Uint16Array:ce,Uint32Array:he,Int8Array:le,Int16Array:ue,Int32Array:de,Uint8ClampedArray:oe},o=Math.pow(2,Math.ceil(Math.log2(Math.sqrt(n/r))));let l=Math.ceil(n/r/o);o*l*r<n&&l++;const u=o*l*r,c=new e.constructor(u);c.set(e,0),t.array=c;const d=new Rs(t.array,o,l,s,a[t.array.constructor.name]||fe);d.needsUpdate=!0,d.isPBOTexture=!0;const h=new UC(d,null,null);h.setPrecision("high"),t.pboNode=h,t.pbo=h.value,this.getUniformFromNode(t.pboNode,"texture",this.shaderStage,this.context.label)}}getPropertyName(e,t=this.shaderStage){return e.isNodeUniform&&!0!==e.node.isTextureNode&&!0!==e.node.isBufferNode?t.charAt(0)+"_"+e.name:super.getPropertyName(e,t)}generatePBO(e){const{node:t,indexNode:n}=e,r=t.value;if(this.renderer.backend.has(r)){this.renderer.backend.get(r).pbo=r.pbo}const i=this.getUniformFromNode(r.pboNode,"texture",this.shaderStage,this.context.label),s=this.getPropertyName(i);this.increaseUsage(n);const a=n.build(this,"uint"),o=this.getDataFromNode(e);let l=o.propertyName;if(void 0===l){const n=this.getVarFromNode(e);l=this.getPropertyName(n);const i=this.getDataFromNode(t);let u=i.propertySizeName;void 0===u&&(u=l+"Size",this.getVarFromNode(t,u,"uint"),this.addLineFlowCode(`${u} = uint( textureSize( ${s}, 0 ).x )`,e),i.propertySizeName=u);const{itemSize:c}=r,d="."+qE.join("").slice(0,c),h=`ivec2(${a} % ${u}, ${a} / ${u})`,f=this.generateTextureLoad(null,s,h,null,"0");let p="vec4";r.pbo.type===he?p="uvec4":r.pbo.type===de&&(p="ivec4"),this.addLineFlowCode(`${l} = ${p}(${f})${d}`,e),o.propertyName=l}return l}generateTextureLoad(e,t,n,r,i="0"){return r?`texelFetch( ${t}, ivec3( ${n}, ${r} ), ${i} )`:`texelFetch( ${t}, ${n}, ${i} )`}generateTexture(e,t,n,r){return e.isDepthTexture?`texture( ${t}, ${n} ).x`:(r&&(n=`vec3( ${n}, ${r} )`),`texture( ${t}, ${n} )`)}generateTextureLevel(e,t,n,r){return`textureLod( ${t}, ${n}, ${r} )`}generateTextureBias(e,t,n,r){return`texture( ${t}, ${n}, ${r} )`}generateTextureGrad(e,t,n,r){return`textureGrad( ${t}, ${n}, ${r[0]}, ${r[1]} )`}generateTextureCompare(e,t,n,r,i,s=this.shaderStage){if("fragment"===s)return`texture( ${t}, vec3( ${n}, ${r} ) )`}getVars(e){const t=[],n=this.vars[e];if(void 0!==n)for(const e of n)t.push(`${this.getVar(e.type,e.name)};`);return t.join("\n\t")}getUniforms(e){const t=this.uniforms[e],n=[],r={};for(const i of t){let t=null,s=!1;if("texture"===i.type){const e=i.node.value;let n="";!0===e.isDataTexture&&(e.type===he?n="u":e.type===de&&(n="i")),t=e.compareFunction?`sampler2DShadow ${i.name};`:!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?`${n}sampler2DArray ${i.name};`:`${n}sampler2D ${i.name};`}else if("cubeTexture"===i.type)t=`samplerCube ${i.name};`;else if("texture3D"===i.type)t=`sampler3D ${i.name};`;else if("buffer"===i.type){const e=i.node,n=this.getType(e.bufferType),r=e.bufferCount,s=r>0?r:"";t=`${e.name} {\n\t${n} ${i.name}[${s}];\n};\n`}else{t=`${this.getVectorType(i.type)} ${this.getPropertyName(i,e)};`,s=!0}const a=i.node.precision;if(null!==a&&(t=CG[a]+" "+t),s){t="\t"+t;const e=i.groupNode.name;(r[e]||(r[e]=[])).push(t)}else t="uniform "+t,n.push(t)}let i="";for(const t in r){const n=r[t];i+=this._getGLSLUniformStruct(e+"_"+t,n.join("\n"))+"\n"}return i+=n.join("\n"),i}getTypeFromAttribute(e){let t=super.getTypeFromAttribute(e);if(/^[iu]/.test(t)&&e.gpuType!==de){let n=e;e.isInterleavedBufferAttribute&&(n=e.data);const r=n.array;!1==(r instanceof Uint32Array||r instanceof Int32Array)&&(t=t.slice(1))}return t}getAttributes(e){let t="";if("vertex"===e||"compute"===e){const e=this.getAttributesArray();let n=0;for(const r of e)t+=`layout( location = ${n++} ) in ${r.type} ${r.name};\n`}return t}getStructMembers(e){const t=[],n=e.getMemberTypes();for(let e=0;e<n.length;e++){const r=n[e];t.push(`layout( location = ${e} ) out ${r} m${e};`)}return t.join("\n")}getStructs(e){const t=[],n=this.structs[e];if(0===n.length)return"layout( location = 0 ) out vec4 fragColor;\n";for(let e=0,r=n.length;e<r;e++){const r=n[e];let i="\n";i+=this.getStructMembers(r),i+="\n",t.push(i)}return t.join("\n\n")}getVaryings(e){let t="";const n=this.varyings;if("vertex"===e||"compute"===e)for(const r of n){"compute"===e&&(r.needsInterpolation=!0);const n=this.getType(r.type);t+=`${n.includes("int")||n.includes("uv")||n.includes("iv")?"flat ":""}${r.needsInterpolation?"out":"/*out*/"} ${n} ${r.name};\n`}else if("fragment"===e)for(const e of n)if(e.needsInterpolation){const n=this.getType(e.type);t+=`${n.includes("int")||n.includes("uv")||n.includes("iv")?"flat ":""}in ${n} ${e.name};\n`}for(const n of this.builtins[e])t+=`${n};\n`;return t}getVertexIndex(){return"uint( gl_VertexID )"}getInstanceIndex(){return"uint( gl_InstanceID )"}getInvocationLocalIndex(){return`uint( gl_InstanceID ) % ${this.object.workgroupSize.reduce((e,t)=>e*t,1)}u`}getDrawIndex(){return this.renderer.backend.extensions.has("WEBGL_multi_draw")?"uint( gl_DrawID )":null}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord.xy"}getFragDepth(){return"gl_FragDepth"}enableExtension(e,t,n=this.shaderStage){const r=this.extensions[n]||(this.extensions[n]=new Map);!1===r.has(e)&&r.set(e,{name:e,behavior:t})}getExtensions(e){const t=[];if("vertex"===e){const t=this.renderer.backend.extensions;this.object.isBatchedMesh&&t.has("WEBGL_multi_draw")&&this.enableExtension("GL_ANGLE_multi_draw","require",e)}const n=this.extensions[e];if(void 0!==n)for(const{name:e,behavior:r}of n.values())t.push(`#extension ${e} : ${r}`);return t.join("\n")}getClipDistance(){return"gl_ClipDistance"}isAvailable(e){let t=IG[e];if(void 0===t){let n;switch(t=!1,e){case"float32Filterable":n="OES_texture_float_linear";break;case"clipDistance":n="WEBGL_clip_cull_distance"}if(void 0!==n){const e=this.renderer.backend.extensions;e.has(n)&&(e.get(n),t=!0)}IG[e]=t}return t}isFlipY(){return!0}enableHardwareClipping(e){this.enableExtension("GL_ANGLE_clip_cull_distance","require"),this.builtins.vertex.push(`out float gl_ClipDistance[ ${e} ]`)}registerTransform(e,t){this.transforms.push({varyingName:e,attributeNode:t})}getTransforms(){const e=this.transforms;let t="";for(let n=0;n<e.length;n++){const r=e[n],i=this.getPropertyName(r.attributeNode);t+=`${r.varyingName} = ${i};\n\t`}return t}_getGLSLUniformStruct(e,t){return`\nlayout( std140 ) uniform ${e} {\n${t}\n};`}_getGLSLVertexCode(e){return`#version 300 es\n\n${this.getSignature()}\n\n// extensions \n${e.extensions}\n\n// precision\n${LG}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\n\n// attributes\n${e.attributes}\n\n// codes\n${e.codes}\n\nvoid main() {\n\n\t// vars\n\t${e.vars}\n\n\t// transforms\n\t${e.transforms}\n\n\t// flow\n\t${e.flow}\n\n\tgl_PointSize = 1.0;\n\n}\n`}_getGLSLFragmentCode(e){return`#version 300 es\n\n${this.getSignature()}\n\n// precision\n${LG}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\n\n// codes\n${e.codes}\n\n${e.structs}\n\nvoid main() {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}buildCode(){const e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){let n="// code\n\n";n+=this.flowCode[t];const r=this.flowNodes[t],i=r[r.length-1];for(const e of r){const r=this.getFlowData(e),s=e.name;s&&(n.length>0&&(n+="\n"),n+=`\t// flow -> ${s}\n\t`),n+=`${r.code}\n\t`,e===i&&"compute"!==t&&(n+="// result\n\t","vertex"===t?(n+="gl_Position = ",n+=`${r.result};`):"fragment"===t&&(e.outputNode.isOutputStructNode||(n+="fragColor = ",n+=`${r.result};`)))}const s=e[t];s.extensions=this.getExtensions(t),s.uniforms=this.getUniforms(t),s.attributes=this.getAttributes(t),s.varyings=this.getVaryings(t),s.vars=this.getVars(t),s.structs=this.getStructs(t),s.codes=this.getCodes(t),s.transforms=this.getTransforms(t),s.flow=n}null!==this.material?(this.vertexShader=this._getGLSLVertexCode(e.vertex),this.fragmentShader=this._getGLSLFragmentCode(e.fragment)):this.computeShader=this._getGLSLVertexCode(e.compute)}getUniformFromNode(e,t,n,r=null){const i=super.getUniformFromNode(e,t,n,r),s=this.getDataFromNode(e,n,this.globalCache);let a=s.uniformGPU;if(void 0===a){const r=e.groupNode,o=r.name,l=this.getBindGroupArray(o,n);if("texture"===t)a=new AG(i.name,i.node,r),l.push(a);else if("cubeTexture"===t)a=new wG(i.name,i.node,r),l.push(a);else if("texture3D"===t)a=new MG(i.name,i.node,r),l.push(a);else if("buffer"===t){e.name=`NodeBuffer_${e.id}`,i.name=`buffer${e.id}`;const t=new bG(e,r);t.name=e.name,l.push(t),a=t}else{const e=this.uniformGroups[n]||(this.uniformGroups[n]={});let s=e[o];void 0===s&&(s=new SG(n+"_"+o,r),e[o]=s,l.push(s)),a=this.getNodeUniform(i,t),s.addUniform(a)}s.uniformGPU=a}return i}}let NG=null,DG=null;class kG{constructor(e={}){this.parameters=Object.assign({},e),this.data=new WeakMap,this.renderer=null,this.domElement=null}async init(e){this.renderer=e}get coordinateSystem(){}beginRender(){}finishRender(){}beginCompute(){}finishCompute(){}draw(){}compute(){}createProgram(){}destroyProgram(){}createBindings(){}updateBindings(){}updateBinding(){}createRenderPipeline(){}createComputePipeline(){}needsRenderUpdate(){}getRenderCacheKey(){}createNodeBuilder(){}createSampler(){}destroySampler(){}createDefaultTexture(){}createTexture(){}updateTexture(){}generateMipmaps(){}destroyTexture(){}copyTextureToBuffer(){}copyTextureToTexture(){}copyFramebufferToTexture(){}createAttribute(){}createIndexAttribute(){}createStorageAttribute(){}updateAttribute(){}destroyAttribute(){}getContext(){}updateSize(){}updateViewport(){}isOccluded(){}async resolveTimestampAsync(){}async waitForGPU(){}async hasFeatureAsync(){}hasFeature(){}getMaxAnisotropy(){}getDrawingBufferSize(){return NG=NG||new Yt,this.renderer.getDrawingBufferSize(NG)}setScissorTest(){}getClearColor(){const e=this.renderer;return DG=DG||new bO,e.getClearColor(DG),DG.getRGB(DG,this.renderer.currentColorSpace),DG}getDomElement(){let e=this.domElement;return null===e&&(e=void 0!==this.parameters.canvas?this.parameters.canvas:nn(),"setAttribute"in e&&e.setAttribute("data-engine",`three.js r${h} webgpu`),this.domElement=e),e}set(e,t){this.data.set(e,t)}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}has(e){return this.data.has(e)}delete(e){this.data.delete(e)}dispose(){}}let OG=0;class FG{constructor(e,t){this.buffers=[e.bufferGPU,t],this.type=e.type,this.bufferType=e.bufferType,this.pbo=e.pbo,this.byteLength=e.byteLength,this.bytesPerElement=e.BYTES_PER_ELEMENT,this.version=e.version,this.isInteger=e.isInteger,this.activeBufferIndex=0,this.baseId=e.id}get id(){return`${this.baseId}|${this.activeBufferIndex}`}get bufferGPU(){return this.buffers[this.activeBufferIndex]}get transformBuffer(){return this.buffers[1^this.activeBufferIndex]}switchBuffers(){this.activeBufferIndex^=1}}class UG{constructor(e){this.backend=e}createAttribute(e,t){const n=this.backend,{gl:r}=n,i=e.array,s=e.usage||r.STATIC_DRAW,a=e.isInterleavedBufferAttribute?e.data:e,o=n.get(a);let l,u=o.bufferGPU;if(void 0===u&&(u=this._createBuffer(r,t,i,s),o.bufferGPU=u,o.bufferType=t,o.version=a.version),i instanceof Float32Array)l=r.FLOAT;else if(i instanceof Uint16Array)l=e.isFloat16BufferAttribute?r.HALF_FLOAT:r.UNSIGNED_SHORT;else if(i instanceof Int16Array)l=r.SHORT;else if(i instanceof Uint32Array)l=r.UNSIGNED_INT;else if(i instanceof Int32Array)l=r.INT;else if(i instanceof Int8Array)l=r.BYTE;else if(i instanceof Uint8Array)l=r.UNSIGNED_BYTE;else{if(!(i instanceof Uint8ClampedArray))throw new Error("THREE.WebGLBackend: Unsupported buffer data format: "+i);l=r.UNSIGNED_BYTE}let c={bufferGPU:u,bufferType:t,type:l,byteLength:i.byteLength,bytesPerElement:i.BYTES_PER_ELEMENT,version:e.version,pbo:e.pbo,isInteger:l===r.INT||l===r.UNSIGNED_INT||e.gpuType===de,id:OG++};if(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute){const e=this._createBuffer(r,t,i,s);c=new FG(c,e)}n.set(e,c)}updateAttribute(e){const t=this.backend,{gl:n}=t,r=e.array,i=e.isInterleavedBufferAttribute?e.data:e,s=t.get(i),a=s.bufferType,o=e.isInterleavedBufferAttribute?e.data.updateRanges:e.updateRanges;if(n.bindBuffer(a,s.bufferGPU),0===o.length)n.bufferSubData(a,0,r);else{for(let e=0,t=o.length;e<t;e++){const t=o[e];n.bufferSubData(a,t.start*r.BYTES_PER_ELEMENT,r,t.start,t.count)}i.clearUpdateRanges()}n.bindBuffer(a,null),s.version=i.version}destroyAttribute(e){const t=this.backend,{gl:n}=t;e.isInterleavedBufferAttribute&&t.delete(e.data);const r=t.get(e);n.deleteBuffer(r.bufferGPU),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,{gl:n}=t,r=e.isInterleavedBufferAttribute?e.data:e,{bufferGPU:i}=t.get(r),s=e.array,a=s.byteLength;n.bindBuffer(n.COPY_READ_BUFFER,i);const o=n.createBuffer();n.bindBuffer(n.COPY_WRITE_BUFFER,o),n.bufferData(n.COPY_WRITE_BUFFER,a,n.STREAM_READ),n.copyBufferSubData(n.COPY_READ_BUFFER,n.COPY_WRITE_BUFFER,0,0,a),await t.utils._clientWaitAsync();const l=new e.array.constructor(s.length);return n.bindBuffer(n.COPY_WRITE_BUFFER,o),n.getBufferSubData(n.COPY_WRITE_BUFFER,0,l),n.deleteBuffer(o),n.bindBuffer(n.COPY_READ_BUFFER,null),n.bindBuffer(n.COPY_WRITE_BUFFER,null),l.buffer}_createBuffer(e,t,n,r){const i=e.createBuffer();return e.bindBuffer(t,i),e.bufferData(t,n,r),e.bindBuffer(t,null),i}}let BG,VG,zG=!1;class GG{constructor(e){this.backend=e,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,this.currentLineWidth=null,this.currentClippingPlanes=0,this.currentBoundFramebuffers={},this.currentDrawbuffers=new WeakMap,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBufferBases={},!1===zG&&(this._init(this.gl),zG=!0)}_init(e){BG={[y]:e.FUNC_ADD,[b]:e.FUNC_SUBTRACT,[_]:e.FUNC_REVERSE_SUBTRACT},VG={[x]:e.ZERO,[S]:e.ONE,[T]:e.SRC_COLOR,[A]:e.SRC_ALPHA,[L]:e.SRC_ALPHA_SATURATE,[C]:e.DST_COLOR,[M]:e.DST_ALPHA,[E]:e.ONE_MINUS_SRC_COLOR,[w]:e.ONE_MINUS_SRC_ALPHA,[I]:e.ONE_MINUS_DST_COLOR,[R]:e.ONE_MINUS_DST_ALPHA}}enable(e){const{enabled:t}=this;!0!==t[e]&&(this.gl.enable(e),t[e]=!0)}disable(e){const{enabled:t}=this;!1!==t[e]&&(this.gl.disable(e),t[e]=!1)}setFlipSided(e){if(this.currentFlipSided!==e){const{gl:t}=this;e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e}}setCullFace(e){const{gl:t}=this;0!==e?(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(1===e?t.cullFace(t.BACK):2===e?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):this.disable(t.CULL_FACE),this.currentCullFace=e}setLineWidth(e){const{currentLineWidth:t,gl:n}=this;e!==t&&(n.lineWidth(e),this.currentLineWidth=e)}setBlending(e,t,n,r,i,s,a,o){const{gl:l}=this;if(0!==e){if(!1===this.currentBlendingEnabled&&(this.enable(l.BLEND),this.currentBlendingEnabled=!0),5===e)i=i||t,s=s||n,a=a||r,t===this.currentBlendEquation&&i===this.currentBlendEquationAlpha||(l.blendEquationSeparate(BG[t],BG[i]),this.currentBlendEquation=t,this.currentBlendEquationAlpha=i),n===this.currentBlendSrc&&r===this.currentBlendDst&&s===this.currentBlendSrcAlpha&&a===this.currentBlendDstAlpha||(l.blendFuncSeparate(VG[n],VG[r],VG[s],VG[a]),this.currentBlendSrc=n,this.currentBlendDst=r,this.currentBlendSrcAlpha=s,this.currentBlendDstAlpha=a),this.currentBlending=e,this.currentPremultipledAlpha=!1;else if(e!==this.currentBlending||o!==this.currentPremultipledAlpha){if(this.currentBlendEquation===y&&this.currentBlendEquationAlpha===y||(l.blendEquation(l.FUNC_ADD),this.currentBlendEquation=y,this.currentBlendEquationAlpha=y),o)switch(e){case 1:l.blendFuncSeparate(l.ONE,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case 2:l.blendFunc(l.ONE,l.ONE);break;case 3:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case 4:l.blendFuncSeparate(l.ZERO,l.SRC_COLOR,l.ZERO,l.SRC_ALPHA)}else switch(e){case 1:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case 2:l.blendFunc(l.SRC_ALPHA,l.ONE);break;case 3:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case 4:l.blendFunc(l.ZERO,l.SRC_COLOR)}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=e,this.currentPremultipledAlpha=o}}else!0===this.currentBlendingEnabled&&(this.disable(l.BLEND),this.currentBlendingEnabled=!1)}setColorMask(e){this.currentColorMask!==e&&(this.gl.colorMask(e,e,e,e),this.currentColorMask=e)}setDepthTest(e){const{gl:t}=this;e?this.enable(t.DEPTH_TEST):this.disable(t.DEPTH_TEST)}setDepthMask(e){this.currentDepthMask!==e&&(this.gl.depthMask(e),this.currentDepthMask=e)}setDepthFunc(e){if(this.currentDepthFunc!==e){const{gl:t}=this;switch(e){case 0:t.depthFunc(t.NEVER);break;case 1:t.depthFunc(t.ALWAYS);break;case 2:t.depthFunc(t.LESS);break;case 3:default:t.depthFunc(t.LEQUAL);break;case 4:t.depthFunc(t.EQUAL);break;case 5:t.depthFunc(t.GEQUAL);break;case 6:t.depthFunc(t.GREATER);break;case 7:t.depthFunc(t.NOTEQUAL)}this.currentDepthFunc=e}}setStencilTest(e){const{gl:t}=this;e?this.enable(t.STENCIL_TEST):this.disable(t.STENCIL_TEST)}setStencilMask(e){this.currentStencilMask!==e&&(this.gl.stencilMask(e),this.currentStencilMask=e)}setStencilFunc(e,t,n){this.currentStencilFunc===e&&this.currentStencilRef===t&&this.currentStencilFuncMask===n||(this.gl.stencilFunc(e,t,n),this.currentStencilFunc=e,this.currentStencilRef=t,this.currentStencilFuncMask=n)}setStencilOp(e,t,n){this.currentStencilFail===e&&this.currentStencilZFail===t&&this.currentStencilZPass===n||(this.gl.stencilOp(e,t,n),this.currentStencilFail=e,this.currentStencilZFail=t,this.currentStencilZPass=n)}setMaterial(e,t,n){const{gl:r}=this;2===e.side?this.disable(r.CULL_FACE):this.enable(r.CULL_FACE);let i=1===e.side;t&&(i=!i),this.setFlipSided(i),1===e.blending&&!1===e.transparent?this.setBlending(0):this.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),this.setDepthFunc(e.depthFunc),this.setDepthTest(e.depthTest),this.setDepthMask(e.depthWrite),this.setColorMask(e.colorWrite);const s=e.stencilWrite;if(this.setStencilTest(s),s&&(this.setStencilMask(e.stencilWriteMask),this.setStencilFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),this.setStencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),this.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage&&this.backend.renderer.samples>1?this.enable(r.SAMPLE_ALPHA_TO_COVERAGE):this.disable(r.SAMPLE_ALPHA_TO_COVERAGE),n>0&&this.currentClippingPlanes!==n){const e=12288;for(let t=0;t<8;t++)t<n?this.enable(e+t):this.disable(e+t)}}setPolygonOffset(e,t,n){const{gl:r}=this;e?(this.enable(r.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===t&&this.currentPolygonOffsetUnits===n||(r.polygonOffset(t,n),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=n)):this.disable(r.POLYGON_OFFSET_FILL)}useProgram(e){return this.currentProgram!==e&&(this.gl.useProgram(e),this.currentProgram=e,!0)}bindFramebuffer(e,t){const{gl:n,currentBoundFramebuffers:r}=this;return r[e]!==t&&(n.bindFramebuffer(e,t),r[e]=t,e===n.DRAW_FRAMEBUFFER&&(r[n.FRAMEBUFFER]=t),e===n.FRAMEBUFFER&&(r[n.DRAW_FRAMEBUFFER]=t),!0)}drawBuffers(e,t){const{gl:n}=this;let r=[],i=!1;if(null!==e.textures){r=this.currentDrawbuffers.get(t),void 0===r&&(r=[],this.currentDrawbuffers.set(t,r));const s=e.textures;if(r.length!==s.length||r[0]!==n.COLOR_ATTACHMENT0){for(let e=0,t=s.length;e<t;e++)r[e]=n.COLOR_ATTACHMENT0+e;r.length=s.length,i=!0}}else r[0]!==n.BACK&&(r[0]=n.BACK,i=!0);i&&n.drawBuffers(r)}activeTexture(e){const{gl:t,currentTextureSlot:n,maxTextures:r}=this;void 0===e&&(e=t.TEXTURE0+r-1),n!==e&&(t.activeTexture(e),this.currentTextureSlot=e)}bindTexture(e,t,n){const{gl:r,currentTextureSlot:i,currentBoundTextures:s,maxTextures:a}=this;void 0===n&&(n=null===i?r.TEXTURE0+a-1:i);let o=s[n];void 0===o&&(o={type:void 0,texture:void 0},s[n]=o),o.type===e&&o.texture===t||(i!==n&&(r.activeTexture(n),this.currentTextureSlot=n),r.bindTexture(e,t),o.type=e,o.texture=t)}bindBufferBase(e,t,n){const{gl:r}=this,i=`${e}-${t}`;return this.currentBoundBufferBases[i]!==n&&(r.bindBufferBase(e,t,n),this.currentBoundBufferBases[i]=n,!0)}unbindTexture(){const{gl:e,currentTextureSlot:t,currentBoundTextures:n}=this,r=n[t];void 0!==r&&void 0!==r.type&&(e.bindTexture(r.type,null),r.type=void 0,r.texture=void 0)}}class HG{constructor(e){this.backend=e,this.gl=this.backend.gl,this.extensions=e.extensions}convert(e,t=""){const{gl:n,extensions:r}=this;let i;if(e===oe)return n.UNSIGNED_BYTE;if(e===me)return n.UNSIGNED_SHORT_4_4_4_4;if(e===ge)return n.UNSIGNED_SHORT_5_5_5_1;if(e===ye)return n.UNSIGNED_INT_5_9_9_9_REV;if(e===le)return n.BYTE;if(e===ue)return n.SHORT;if(e===ce)return n.UNSIGNED_SHORT;if(e===de)return n.INT;if(e===he)return n.UNSIGNED_INT;if(e===fe)return n.FLOAT;if(e===pe)return n.HALF_FLOAT;if(e===be)return n.ALPHA;if(e===_e)return n.RGB;if(e===xe)return n.RGBA;if(e===Se)return n.LUMINANCE;if(e===Te)return n.LUMINANCE_ALPHA;if(e===Ee)return n.DEPTH_COMPONENT;if(e===Ae)return n.DEPTH_STENCIL;if(e===we)return n.RED;if(e===Me)return n.RED_INTEGER;if(e===Re)return n.RG;if(e===Ce)return n.RG_INTEGER;if(e===Ie)return n.RGBA_INTEGER;if(e===Le||e===Pe||e===Ne||e===De)if(t===yt){if(i=r.get("WEBGL_compressed_texture_s3tc_srgb"),null===i)return null;if(e===Le)return i.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(e===Pe)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(e===Ne)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(e===De)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(i=r.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(e===Le)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===Pe)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===Ne)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===De)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(e===ke||e===Oe||e===Fe||e===Ue){if(i=r.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(e===ke)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===Oe)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===Fe)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Ue)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Be||e===Ve||e===ze){if(i=r.get("WEBGL_compressed_texture_etc"),null===i)return null;if(e===Be||e===Ve)return t===yt?i.COMPRESSED_SRGB8_ETC2:i.COMPRESSED_RGB8_ETC2;if(e===ze)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC}if(e===Ge||e===He||e===$e||e===We||e===je||e===qe||e===Xe||e===Ye||e===Ke||e===Qe||e===Ze||e===Je||e===et||e===tt){if(i=r.get("WEBGL_compressed_texture_astc"),null===i)return null;if(e===Ge)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:i.COMPRESSED_RGBA_ASTC_4x4_KHR;if(e===He)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:i.COMPRESSED_RGBA_ASTC_5x4_KHR;if(e===$e)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:i.COMPRESSED_RGBA_ASTC_5x5_KHR;if(e===We)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:i.COMPRESSED_RGBA_ASTC_6x5_KHR;if(e===je)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:i.COMPRESSED_RGBA_ASTC_6x6_KHR;if(e===qe)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:i.COMPRESSED_RGBA_ASTC_8x5_KHR;if(e===Xe)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:i.COMPRESSED_RGBA_ASTC_8x6_KHR;if(e===Ye)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:i.COMPRESSED_RGBA_ASTC_8x8_KHR;if(e===Ke)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:i.COMPRESSED_RGBA_ASTC_10x5_KHR;if(e===Qe)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:i.COMPRESSED_RGBA_ASTC_10x6_KHR;if(e===Ze)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:i.COMPRESSED_RGBA_ASTC_10x8_KHR;if(e===Je)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:i.COMPRESSED_RGBA_ASTC_10x10_KHR;if(e===et)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:i.COMPRESSED_RGBA_ASTC_12x10_KHR;if(e===tt)return t===yt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:i.COMPRESSED_RGBA_ASTC_12x12_KHR}if(e===nt){if(i=r.get("EXT_texture_compression_bptc"),null===i)return null;if(e===nt)return t===yt?i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:i.COMPRESSED_RGBA_BPTC_UNORM_EXT}if(e===st||e===at||e===ot||e===lt){if(i=r.get("EXT_texture_compression_rgtc"),null===i)return null;if(e===nt)return i.COMPRESSED_RED_RGTC1_EXT;if(e===at)return i.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(e===ot)return i.COMPRESSED_RED_GREEN_RGTC2_EXT;if(e===lt)return i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return e===ve?n.UNSIGNED_INT_24_8:void 0!==n[e]?n[e]:null}_clientWaitAsync(){const{gl:e}=this,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),new Promise((n,r)=>{!function i(){const s=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0);if(s===e.WAIT_FAILED)return e.deleteSync(t),void r();s!==e.TIMEOUT_EXPIRED?(e.deleteSync(t),n()):requestAnimationFrame(i)}()})}}let $G,WG,jG,qG=!1;class XG{constructor(e){this.backend=e,this.gl=e.gl,this.extensions=e.extensions,this.defaultTextures={},!1===qG&&(this._init(this.gl),qG=!0)}_init(e){$G={[Z]:e.REPEAT,[J]:e.CLAMP_TO_EDGE,[ee]:e.MIRRORED_REPEAT},WG={[te]:e.NEAREST,[ne]:e.NEAREST_MIPMAP_NEAREST,[re]:e.NEAREST_MIPMAP_LINEAR,[ie]:e.LINEAR,[se]:e.LINEAR_MIPMAP_NEAREST,[ae]:e.LINEAR_MIPMAP_LINEAR},jG={[Et]:e.NEVER,[Lt]:e.ALWAYS,[At]:e.LESS,[Mt]:e.LEQUAL,[wt]:e.EQUAL,[It]:e.GEQUAL,[Rt]:e.GREATER,[Ct]:e.NOTEQUAL}}filterFallback(e){const{gl:t}=this;return e===te||e===ne||e===re?t.NEAREST:t.LINEAR}getGLTextureType(e){const{gl:t}=this;let n;return n=!0===e.isCubeTexture?t.TEXTURE_CUBE_MAP:!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?t.TEXTURE_2D_ARRAY:!0===e.isData3DTexture?t.TEXTURE_3D:t.TEXTURE_2D,n}getInternalFormat(e,t,n,r,i=!1){const{gl:s,extensions:a}=this;if(null!==e&&void 0!==s[e])return s[e];let o=t;return t===s.RED&&(n===s.FLOAT&&(o=s.R32F),n===s.HALF_FLOAT&&(o=s.R16F),n===s.UNSIGNED_BYTE&&(o=s.R8),n===s.UNSIGNED_SHORT&&(o=s.R16),n===s.UNSIGNED_INT&&(o=s.R32UI),n===s.BYTE&&(o=s.R8I),n===s.SHORT&&(o=s.R16I),n===s.INT&&(o=s.R32I)),t===s.RED_INTEGER&&(n===s.UNSIGNED_BYTE&&(o=s.R8UI),n===s.UNSIGNED_SHORT&&(o=s.R16UI),n===s.UNSIGNED_INT&&(o=s.R32UI),n===s.BYTE&&(o=s.R8I),n===s.SHORT&&(o=s.R16I),n===s.INT&&(o=s.R32I)),t===s.RG&&(n===s.FLOAT&&(o=s.RG32F),n===s.HALF_FLOAT&&(o=s.RG16F),n===s.UNSIGNED_BYTE&&(o=s.RG8),n===s.UNSIGNED_SHORT&&(o=s.RG16),n===s.UNSIGNED_INT&&(o=s.RG32UI),n===s.BYTE&&(o=s.RG8I),n===s.SHORT&&(o=s.RG16I),n===s.INT&&(o=s.RG32I)),t===s.RG_INTEGER&&(n===s.UNSIGNED_BYTE&&(o=s.RG8UI),n===s.UNSIGNED_SHORT&&(o=s.RG16UI),n===s.UNSIGNED_INT&&(o=s.RG32UI),n===s.BYTE&&(o=s.RG8I),n===s.SHORT&&(o=s.RG16I),n===s.INT&&(o=s.RG32I)),t===s.RGB&&(n===s.FLOAT&&(o=s.RGB32F),n===s.HALF_FLOAT&&(o=s.RGB16F),n===s.UNSIGNED_BYTE&&(o=s.RGB8),n===s.UNSIGNED_SHORT&&(o=s.RGB16),n===s.UNSIGNED_INT&&(o=s.RGB32UI),n===s.BYTE&&(o=s.RGB8I),n===s.SHORT&&(o=s.RGB16I),n===s.INT&&(o=s.RGB32I),n===s.UNSIGNED_BYTE&&(o=r===yt&&!1===i?s.SRGB8:s.RGB8),n===s.UNSIGNED_SHORT_5_6_5&&(o=s.RGB565),n===s.UNSIGNED_SHORT_5_5_5_1&&(o=s.RGB5_A1),n===s.UNSIGNED_SHORT_4_4_4_4&&(o=s.RGB4),n===s.UNSIGNED_INT_5_9_9_9_REV&&(o=s.RGB9_E5)),t===s.RGB_INTEGER&&(n===s.UNSIGNED_BYTE&&(o=s.RGB8UI),n===s.UNSIGNED_SHORT&&(o=s.RGB16UI),n===s.UNSIGNED_INT&&(o=s.RGB32UI),n===s.BYTE&&(o=s.RGB8I),n===s.SHORT&&(o=s.RGB16I),n===s.INT&&(o=s.RGB32I)),t===s.RGBA&&(n===s.FLOAT&&(o=s.RGBA32F),n===s.HALF_FLOAT&&(o=s.RGBA16F),n===s.UNSIGNED_BYTE&&(o=s.RGBA8),n===s.UNSIGNED_SHORT&&(o=s.RGBA16),n===s.UNSIGNED_INT&&(o=s.RGBA32UI),n===s.BYTE&&(o=s.RGBA8I),n===s.SHORT&&(o=s.RGBA16I),n===s.INT&&(o=s.RGBA32I),n===s.UNSIGNED_BYTE&&(o=r===yt&&!1===i?s.SRGB8_ALPHA8:s.RGBA8),n===s.UNSIGNED_SHORT_4_4_4_4&&(o=s.RGBA4),n===s.UNSIGNED_SHORT_5_5_5_1&&(o=s.RGB5_A1)),t===s.RGBA_INTEGER&&(n===s.UNSIGNED_BYTE&&(o=s.RGBA8UI),n===s.UNSIGNED_SHORT&&(o=s.RGBA16UI),n===s.UNSIGNED_INT&&(o=s.RGBA32UI),n===s.BYTE&&(o=s.RGBA8I),n===s.SHORT&&(o=s.RGBA16I),n===s.INT&&(o=s.RGBA32I)),t===s.DEPTH_COMPONENT&&(n===s.UNSIGNED_INT&&(o=s.DEPTH24_STENCIL8),n===s.FLOAT&&(o=s.DEPTH_COMPONENT32F)),t===s.DEPTH_STENCIL&&n===s.UNSIGNED_INT_24_8&&(o=s.DEPTH24_STENCIL8),o!==s.R16F&&o!==s.R32F&&o!==s.RG16F&&o!==s.RG32F&&o!==s.RGBA16F&&o!==s.RGBA32F||a.get("EXT_color_buffer_float"),o}setTextureParameters(e,t){const{gl:n,extensions:r,backend:i}=this;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,t.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,n.NONE),n.texParameteri(e,n.TEXTURE_WRAP_S,$G[t.wrapS]),n.texParameteri(e,n.TEXTURE_WRAP_T,$G[t.wrapT]),e!==n.TEXTURE_3D&&e!==n.TEXTURE_2D_ARRAY||n.texParameteri(e,n.TEXTURE_WRAP_R,$G[t.wrapR]),n.texParameteri(e,n.TEXTURE_MAG_FILTER,WG[t.magFilter]);const s=void 0!==t.mipmaps&&t.mipmaps.length>0,a=t.minFilter===ie&&s?ae:t.minFilter;if(n.texParameteri(e,n.TEXTURE_MIN_FILTER,WG[a]),t.compareFunction&&(n.texParameteri(e,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE),n.texParameteri(e,n.TEXTURE_COMPARE_FUNC,jG[t.compareFunction])),!0===r.has("EXT_texture_filter_anisotropic")){if(t.magFilter===te)return;if(t.minFilter!==re&&t.minFilter!==ae)return;if(t.type===fe&&!1===r.has("OES_texture_float_linear"))return;if(t.anisotropy>1){const s=r.get("EXT_texture_filter_anisotropic");n.texParameterf(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,i.getMaxAnisotropy()))}}}createDefaultTexture(e){const{gl:t,backend:n,defaultTextures:r}=this,i=this.getGLTextureType(e);let s=r[i];void 0===s&&(s=t.createTexture(),n.state.bindTexture(i,s),t.texParameteri(i,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(i,t.TEXTURE_MAG_FILTER,t.NEAREST),r[i]=s),n.set(e,{textureGPU:s,glTextureType:i,isDefault:!0})}createTexture(e,t){const{gl:n,backend:r}=this,{levels:i,width:s,height:a,depth:o}=t,l=r.utils.convert(e.format,e.colorSpace),u=r.utils.convert(e.type),c=this.getInternalFormat(e.internalFormat,l,u,e.colorSpace,e.isVideoTexture),d=n.createTexture(),h=this.getGLTextureType(e);r.state.bindTexture(h,d),this.setTextureParameters(h,e),e.isDataArrayTexture||e.isCompressedArrayTexture?n.texStorage3D(n.TEXTURE_2D_ARRAY,i,c,s,a,o):e.isData3DTexture?n.texStorage3D(n.TEXTURE_3D,i,c,s,a,o):e.isVideoTexture||n.texStorage2D(h,i,c,s,a),r.set(e,{textureGPU:d,glTextureType:h,glFormat:l,glType:u,glInternalFormat:c})}copyBufferToTexture(e,t){const{gl:n,backend:r}=this,{textureGPU:i,glTextureType:s,glFormat:a,glType:o}=r.get(t),{width:l,height:u}=t.source.data;n.bindBuffer(n.PIXEL_UNPACK_BUFFER,e),r.state.bindTexture(s,i),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n.texSubImage2D(s,0,0,0,l,u,a,o,0),n.bindBuffer(n.PIXEL_UNPACK_BUFFER,null),r.state.unbindTexture()}updateTexture(e,t){const{gl:n}=this,{width:r,height:i}=t,{textureGPU:s,glTextureType:a,glFormat:o,glType:l,glInternalFormat:u}=this.backend.get(e);if(e.isRenderTargetTexture||void 0===s)return;const c=e=>e.isDataTexture?e.image.data:"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||e instanceof OffscreenCanvas?e:e.data;if(this.backend.state.bindTexture(a,s),this.setTextureParameters(a,e),e.isCompressedTexture){const r=e.mipmaps,i=t.image;for(let t=0;t<r.length;t++){const s=r[t];e.isCompressedArrayTexture?e.format!==n.RGBA?null!==o&&n.compressedTexSubImage3D(n.TEXTURE_2D_ARRAY,t,0,0,0,s.width,s.height,i.depth,o,s.data):n.texSubImage3D(n.TEXTURE_2D_ARRAY,t,0,0,0,s.width,s.height,i.depth,o,l,s.data):null!==o&&n.compressedTexSubImage2D(n.TEXTURE_2D,t,0,0,s.width,s.height,o,s.data)}}else if(e.isCubeTexture){const e=t.images;for(let t=0;t<6;t++){const s=c(e[t]);n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,r,i,o,l,s)}}else if(e.isDataArrayTexture){const e=t.image;n.texSubImage3D(n.TEXTURE_2D_ARRAY,0,0,0,0,e.width,e.height,e.depth,o,l,e.data)}else if(e.isData3DTexture){const e=t.image;n.texSubImage3D(n.TEXTURE_3D,0,0,0,0,e.width,e.height,e.depth,o,l,e.data)}else if(e.isVideoTexture)e.update(),n.texImage2D(a,0,u,o,l,t.image);else{const e=c(t.image);n.texSubImage2D(a,0,0,0,r,i,o,l,e)}}generateMipmaps(e){const{gl:t,backend:n}=this,{textureGPU:r,glTextureType:i}=n.get(e);n.state.bindTexture(i,r),t.generateMipmap(i)}deallocateRenderBuffers(e){const{gl:t,backend:n}=this;if(e){const r=n.get(e);if(r.renderBufferStorageSetup=void 0,r.framebuffers){for(const e in r.framebuffers)t.deleteFramebuffer(r.framebuffers[e]);delete r.framebuffers}if(r.depthRenderbuffer&&(t.deleteRenderbuffer(r.depthRenderbuffer),delete r.depthRenderbuffer),r.stencilRenderbuffer&&(t.deleteRenderbuffer(r.stencilRenderbuffer),delete r.stencilRenderbuffer),r.msaaFrameBuffer&&(t.deleteFramebuffer(r.msaaFrameBuffer),delete r.msaaFrameBuffer),r.msaaRenderbuffers){for(let e=0;e<r.msaaRenderbuffers.length;e++)t.deleteRenderbuffer(r.msaaRenderbuffers[e]);delete r.msaaRenderbuffers}}}destroyTexture(e){const{gl:t,backend:n}=this,{textureGPU:r,renderTarget:i}=n.get(e);this.deallocateRenderBuffers(i),t.deleteTexture(r),n.delete(e)}copyTextureToTexture(e,t,n=null,r=null,i=0){const{gl:s,backend:a}=this,{state:o}=this.backend,{textureGPU:l,glTextureType:u,glType:c,glFormat:d}=a.get(t);let h,f,p,m,g,v;null!==n?(h=n.max.x-n.min.x,f=n.max.y-n.min.y,p=n.min.x,m=n.min.y):(h=e.image.width,f=e.image.height,p=0,m=0),null!==r?(g=r.x,v=r.y):(g=0,v=0),o.bindTexture(u,l),s.pixelStorei(s.UNPACK_ALIGNMENT,t.unpackAlignment),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,t.flipY),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),s.pixelStorei(s.UNPACK_ALIGNMENT,t.unpackAlignment);const y=s.getParameter(s.UNPACK_ROW_LENGTH),b=s.getParameter(s.UNPACK_IMAGE_HEIGHT),_=s.getParameter(s.UNPACK_SKIP_PIXELS),x=s.getParameter(s.UNPACK_SKIP_ROWS),S=s.getParameter(s.UNPACK_SKIP_IMAGES),T=e.isCompressedTexture?e.mipmaps[i]:e.image;if(s.pixelStorei(s.UNPACK_ROW_LENGTH,T.width),s.pixelStorei(s.UNPACK_IMAGE_HEIGHT,T.height),s.pixelStorei(s.UNPACK_SKIP_PIXELS,p),s.pixelStorei(s.UNPACK_SKIP_ROWS,m),e.isRenderTargetTexture||e.isDepthTexture){const n=a.get(e),r=a.get(t),i=a.get(n.renderTarget),l=a.get(r.renderTarget),u=i.framebuffers[n.cacheKey],c=l.framebuffers[r.cacheKey];o.bindFramebuffer(s.READ_FRAMEBUFFER,u),o.bindFramebuffer(s.DRAW_FRAMEBUFFER,c);let d=s.COLOR_BUFFER_BIT;e.isDepthTexture&&(d=s.DEPTH_BUFFER_BIT),s.blitFramebuffer(p,m,h,f,g,v,h,f,d,s.NEAREST),o.bindFramebuffer(s.READ_FRAMEBUFFER,null),o.bindFramebuffer(s.DRAW_FRAMEBUFFER,null)}else e.isDataTexture?s.texSubImage2D(s.TEXTURE_2D,i,g,v,h,f,d,c,T.data):e.isCompressedTexture?s.compressedTexSubImage2D(s.TEXTURE_2D,i,g,v,T.width,T.height,d,T.data):s.texSubImage2D(s.TEXTURE_2D,i,g,v,h,f,d,c,T);s.pixelStorei(s.UNPACK_ROW_LENGTH,y),s.pixelStorei(s.UNPACK_IMAGE_HEIGHT,b),s.pixelStorei(s.UNPACK_SKIP_PIXELS,_),s.pixelStorei(s.UNPACK_SKIP_ROWS,x),s.pixelStorei(s.UNPACK_SKIP_IMAGES,S),0===i&&t.generateMipmaps&&s.generateMipmap(s.TEXTURE_2D),o.unbindTexture()}copyFramebufferToTexture(e,t,n){const{gl:r}=this,{state:i}=this.backend,{textureGPU:s}=this.backend.get(e),{x:a,y:o,z:l,w:u}=n,c=!0===e.isDepthTexture||t.renderTarget&&t.renderTarget.samples>0,d=t.renderTarget?t.renderTarget.height:this.backend.getDrawingBufferSize().y;if(c){const n=0!==a||0!==o;let c,h;if(!0===e.isDepthTexture?(c=r.DEPTH_BUFFER_BIT,h=r.DEPTH_ATTACHMENT,t.stencil&&(c|=r.STENCIL_BUFFER_BIT)):(c=r.COLOR_BUFFER_BIT,h=r.COLOR_ATTACHMENT0),n){const e=this.backend.get(t.renderTarget),n=e.framebuffers[t.getCacheKey()],h=e.msaaFrameBuffer;i.bindFramebuffer(r.DRAW_FRAMEBUFFER,n),i.bindFramebuffer(r.READ_FRAMEBUFFER,h);const f=d-o-u;r.blitFramebuffer(a,f,a+l,f+u,a,f,a+l,f+u,c,r.NEAREST),i.bindFramebuffer(r.READ_FRAMEBUFFER,n),i.bindTexture(r.TEXTURE_2D,s),r.copyTexSubImage2D(r.TEXTURE_2D,0,0,0,a,f,l,u),i.unbindTexture()}else{const e=r.createFramebuffer();i.bindFramebuffer(r.DRAW_FRAMEBUFFER,e),r.framebufferTexture2D(r.DRAW_FRAMEBUFFER,h,r.TEXTURE_2D,s,0),r.blitFramebuffer(0,0,l,u,0,0,l,u,c,r.NEAREST),r.deleteFramebuffer(e)}}else i.bindTexture(r.TEXTURE_2D,s),r.copyTexSubImage2D(r.TEXTURE_2D,0,0,0,a,d-u-o,l,u),i.unbindTexture();e.generateMipmaps&&this.generateMipmaps(e),this.backend._setFramebuffer(t)}setupRenderBufferStorage(e,t){const{gl:n}=this,r=t.renderTarget,{samples:i,depthTexture:s,depthBuffer:a,stencilBuffer:o,width:l,height:u}=r;if(n.bindRenderbuffer(n.RENDERBUFFER,e),a&&!o){let t=n.DEPTH_COMPONENT24;i>0?(s&&s.isDepthTexture&&s.type===n.FLOAT&&(t=n.DEPTH_COMPONENT32F),n.renderbufferStorageMultisample(n.RENDERBUFFER,i,t,l,u)):n.renderbufferStorage(n.RENDERBUFFER,t,l,u),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,e)}else a&&o&&(i>0?n.renderbufferStorageMultisample(n.RENDERBUFFER,i,n.DEPTH24_STENCIL8,l,u):n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,l,u),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,e))}async copyTextureToBuffer(e,t,n,r,i,s){const{backend:a,gl:o}=this,{textureGPU:l,glFormat:u,glType:c}=this.backend.get(e),d=o.createFramebuffer();o.bindFramebuffer(o.READ_FRAMEBUFFER,d);const h=e.isCubeTexture?o.TEXTURE_CUBE_MAP_POSITIVE_X+s:o.TEXTURE_2D;o.framebufferTexture2D(o.READ_FRAMEBUFFER,o.COLOR_ATTACHMENT0,h,l,0);const f=this._getTypedArrayType(c),p=r*i*this._getBytesPerTexel(c,u),m=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,m),o.bufferData(o.PIXEL_PACK_BUFFER,p,o.STREAM_READ),o.readPixels(t,n,r,i,u,c,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),await a.utils._clientWaitAsync();const g=new f(p/f.BYTES_PER_ELEMENT);return o.bindBuffer(o.PIXEL_PACK_BUFFER,m),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,g),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteFramebuffer(d),g}_getTypedArrayType(e){const{gl:t}=this;if(e===t.UNSIGNED_BYTE)return Uint8Array;if(e===t.UNSIGNED_SHORT_4_4_4_4)return Uint16Array;if(e===t.UNSIGNED_SHORT_5_5_5_1)return Uint16Array;if(e===t.UNSIGNED_SHORT_5_6_5)return Uint16Array;if(e===t.UNSIGNED_SHORT)return Uint16Array;if(e===t.UNSIGNED_INT)return Uint32Array;if(e===t.HALF_FLOAT)return Uint16Array;if(e===t.FLOAT)return Float32Array;throw new Error(`Unsupported WebGL type: ${e}`)}_getBytesPerTexel(e,t){const{gl:n}=this;let r=0;return e===n.UNSIGNED_BYTE&&(r=1),e!==n.UNSIGNED_SHORT_4_4_4_4&&e!==n.UNSIGNED_SHORT_5_5_5_1&&e!==n.UNSIGNED_SHORT_5_6_5&&e!==n.UNSIGNED_SHORT&&e!==n.HALF_FLOAT||(r=2),e!==n.UNSIGNED_INT&&e!==n.FLOAT||(r=4),t===n.RGBA?4*r:t===n.RGB?3*r:t===n.ALPHA?r:void 0}}class YG{constructor(e){this.backend=e,this.gl=this.backend.gl,this.availableExtensions=this.gl.getSupportedExtensions(),this.extensions={}}get(e){let t=this.extensions[e];return void 0===t&&(t=this.gl.getExtension(e),this.extensions[e]=t),t}has(e){return this.availableExtensions.includes(e)}}class KG{constructor(e){this.backend=e,this.maxAnisotropy=null}getMaxAnisotropy(){if(null!==this.maxAnisotropy)return this.maxAnisotropy;const e=this.backend.gl,t=this.backend.extensions;if(!0===t.has("EXT_texture_filter_anisotropic")){const n=t.get("EXT_texture_filter_anisotropic");this.maxAnisotropy=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else this.maxAnisotropy=0;return this.maxAnisotropy}}const QG={WEBGL_multi_draw:"WEBGL_multi_draw",WEBGL_compressed_texture_astc:"texture-compression-astc",WEBGL_compressed_texture_etc:"texture-compression-etc2",WEBGL_compressed_texture_etc1:"texture-compression-etc1",WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBKIT_WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBGL_compressed_texture_s3tc:"texture-compression-bc",EXT_texture_compression_bptc:"texture-compression-bptc",EXT_disjoint_timer_query_webgl2:"timestamp-query"};class ZG{constructor(e){this.gl=e.gl,this.extensions=e.extensions,this.info=e.renderer.info,this.mode=null,this.index=0,this.type=null,this.object=null}render(e,t){const{gl:n,mode:r,object:i,type:s,info:a,index:o}=this;0!==o?n.drawElements(r,t,s,e):n.drawArrays(r,e,t),a.update(i,t,r,1)}renderInstances(e,t,n){const{gl:r,mode:i,type:s,index:a,object:o,info:l}=this;0!==n&&(0!==a?r.drawElementsInstanced(i,t,s,e,n):r.drawArraysInstanced(i,e,t,n),l.update(o,t,i,n))}renderMultiDraw(e,t,n){const{extensions:r,mode:i,object:s,info:a}=this;if(0===n)return;const o=r.get("WEBGL_multi_draw");if(null===o)for(let r=0;r<n;r++)this.render(e[r],t[r]);else{0!==this.index?o.multiDrawElementsWEBGL(i,t,0,this.type,e,0,n):o.multiDrawArraysWEBGL(i,e,0,t,0,n);let r=0;for(let e=0;e<n;e++)r+=t[e];a.update(s,r,i,1)}}renderMultiDrawInstances(e,t,n,r){const{extensions:i,mode:s,object:a,info:o}=this;if(0===n)return;const l=i.get("WEBGL_multi_draw");if(null===l)for(let i=0;i<n;i++)this.renderInstances(e[i],t[i],r[i]);else{0!==this.index?l.multiDrawElementsInstancedWEBGL(s,t,0,this.type,e,0,r,0,n):l.multiDrawArraysInstancedWEBGL(s,e,0,t,0,r,0,n);let i=0;for(let e=0;e<n;e++)i+=t[e]*r[e];o.update(a,i,s,1)}}}class JG extends kG{constructor(e={}){super(e),this.isWebGLBackend=!0,this.attributeUtils=null,this.extensions=null,this.capabilities=null,this.textureUtils=null,this.bufferRenderer=null,this.gl=null,this.state=null,this.utils=null,this.vaoCache={},this.transformFeedbackCache={},this.discard=!1,this.disjoint=null,this.parallel=null,this.trackTimestamp=!0===e.trackTimestamp,this._currentContext=null,this._knownBindings=new WeakSet}init(e){super.init(e);const t=this.parameters,n=void 0!==t.context?t.context:e.domElement.getContext("webgl2");function r(t){t.preventDefault();const n={api:"WebGL",message:t.statusMessage||"Unknown reason",reason:null,originalEvent:t};e.onDeviceLost(n)}this._onContextLost=r,e.domElement.addEventListener("webglcontextlost",r,!1),this.gl=n,this.extensions=new YG(this),this.capabilities=new KG(this),this.attributeUtils=new UG(this),this.textureUtils=new XG(this),this.bufferRenderer=new ZG(this),this.state=new GG(this),this.utils=new HG(this),this.extensions.get("EXT_color_buffer_float"),this.extensions.get("WEBGL_clip_cull_distance"),this.extensions.get("OES_texture_float_linear"),this.extensions.get("EXT_color_buffer_half_float"),this.extensions.get("WEBGL_multisampled_render_to_texture"),this.extensions.get("WEBGL_render_shared_exponent"),this.extensions.get("WEBGL_multi_draw"),this.disjoint=this.extensions.get("EXT_disjoint_timer_query_webgl2"),this.parallel=this.extensions.get("KHR_parallel_shader_compile")}get coordinateSystem(){return kt}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}async waitForGPU(){await this.utils._clientWaitAsync()}initTimestampQuery(e){if(!this.disjoint||!this.trackTimestamp)return;const t=this.get(e);if(this.queryRunning)return t.queryQueue||(t.queryQueue=[]),void t.queryQueue.push(e);t.activeQuery&&(this.gl.endQuery(this.disjoint.TIME_ELAPSED_EXT),t.activeQuery=null),t.activeQuery=this.gl.createQuery(),null!==t.activeQuery&&(this.gl.beginQuery(this.disjoint.TIME_ELAPSED_EXT,t.activeQuery),this.queryRunning=!0)}prepareTimestampBuffer(e){if(!this.disjoint||!this.trackTimestamp)return;const t=this.get(e);if(t.activeQuery&&(this.gl.endQuery(this.disjoint.TIME_ELAPSED_EXT),t.gpuQueries||(t.gpuQueries=[]),t.gpuQueries.push({query:t.activeQuery}),t.activeQuery=null,this.queryRunning=!1,t.queryQueue&&t.queryQueue.length>0)){const e=t.queryQueue.shift();this.initTimestampQuery(e)}}async resolveTimestampAsync(e,t="render"){if(!this.disjoint||!this.trackTimestamp)return;const n=this.get(e);n.gpuQueries||(n.gpuQueries=[]);for(let e=0;e<n.gpuQueries.length;e++){const r=n.gpuQueries[e],i=this.gl.getQueryParameter(r.query,this.gl.QUERY_RESULT_AVAILABLE),s=this.gl.getParameter(this.disjoint.GPU_DISJOINT_EXT);if(i&&!s){const i=this.gl.getQueryParameter(r.query,this.gl.QUERY_RESULT),s=Number(i)/1e6;this.gl.deleteQuery(r.query),n.gpuQueries.splice(e,1),e--,this.renderer.info.updateTimestamp(t,s)}}}getContext(){return this.gl}beginRender(e){const{gl:t}=this,n=this.get(e);if(this.initTimestampQuery(e),n.previousContext=this._currentContext,this._currentContext=e,this._setFramebuffer(e),this.clear(e.clearColor,e.clearDepth,e.clearStencil,e,!1),e.viewport?this.updateViewport(e):t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),e.scissor){const{x:n,y:r,width:i,height:s}=e.scissorValue;t.scissor(n,e.height-s-r,i,s)}const r=e.occlusionQueryCount;r>0&&(n.currentOcclusionQueries=n.occlusionQueries,n.currentOcclusionQueryObjects=n.occlusionQueryObjects,n.lastOcclusionObject=null,n.occlusionQueries=new Array(r),n.occlusionQueryObjects=new Array(r),n.occlusionQueryIndex=0)}finishRender(e){const{gl:t,state:n}=this,r=this.get(e),i=r.previousContext,s=e.occlusionQueryCount;s>0&&(s>r.occlusionQueryIndex&&t.endQuery(t.ANY_SAMPLES_PASSED),this.resolveOccludedAsync(e));const a=e.textures;if(null!==a)for(let e=0;e<a.length;e++){const t=a[e];t.generateMipmaps&&this.generateMipmaps(t)}if(this._currentContext=i,null!==e.textures&&e.renderTarget){const r=this.get(e.renderTarget),{samples:i}=e.renderTarget;if(i>0){const i=r.framebuffers[e.getCacheKey()],s=t.COLOR_BUFFER_BIT,a=r.msaaFrameBuffer,o=e.textures;n.bindFramebuffer(t.READ_FRAMEBUFFER,a),n.bindFramebuffer(t.DRAW_FRAMEBUFFER,i);for(let n=0;n<o.length;n++)if(e.scissor){const{x:n,y:i,width:a,height:o}=e.scissorValue,l=e.height-o-i;t.blitFramebuffer(n,l,n+a,l+o,n,l,n+a,l+o,s,t.NEAREST),t.invalidateSubFramebuffer(t.READ_FRAMEBUFFER,r.invalidationArray,n,l,a,o)}else t.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s,t.NEAREST),t.invalidateFramebuffer(t.READ_FRAMEBUFFER,r.invalidationArray)}}null!==i&&(this._setFramebuffer(i),i.viewport?this.updateViewport(i):t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight)),this.prepareTimestampBuffer(e)}resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueries:n,currentOcclusionQueryObjects:r}=t;if(n&&r){const e=new WeakSet,{gl:i}=this;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueries=null;const s=()=>{let a=0;for(let t=0;t<n.length;t++){const s=n[t];null!==s&&(i.getQueryParameter(s,i.QUERY_RESULT_AVAILABLE)&&(i.getQueryParameter(s,i.QUERY_RESULT)>0&&e.add(r[t]),n[t]=null,i.deleteQuery(s),a++))}a<n.length?requestAnimationFrame(s):t.occluded=e};s()}}isOccluded(e,t){const n=this.get(e);return n.occluded&&n.occluded.has(t)}updateViewport(e){const t=this.gl,{x:n,y:r,width:i,height:s}=e.viewportValue;t.viewport(n,e.height-s-r,i,s)}setScissorTest(e){const t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST)}clear(e,t,n,r=null,i=!0){const{gl:s}=this;if(null===r){const e=this.getClearColor();e.r*=e.a,e.g*=e.a,e.b*=e.a,r={textures:null,clearColorValue:e}}let a=0;if(e&&(a|=s.COLOR_BUFFER_BIT),t&&(a|=s.DEPTH_BUFFER_BIT),n&&(a|=s.STENCIL_BUFFER_BIT),0!==a){let o;if(r.clearColorValue?o=r.clearColorValue:(o=this.getClearColor(),o.r*=o.a,o.g*=o.a,o.b*=o.a),t&&this.state.setDepthMask(!0),null===r.textures)s.clearColor(o.r,o.g,o.b,o.a),s.clear(a);else{if(i&&this._setFramebuffer(r),e)for(let e=0;e<r.textures.length;e++)s.clearBufferfv(s.COLOR,e,[o.r,o.g,o.b,o.a]);t&&n?s.clearBufferfi(s.DEPTH_STENCIL,0,1,0):t?s.clearBufferfv(s.DEPTH,0,[1]):n&&s.clearBufferiv(s.STENCIL,0,[0])}}}beginCompute(e){const{state:t,gl:n}=this;t.bindFramebuffer(n.FRAMEBUFFER,null),this.initTimestampQuery(e)}compute(e,t,n,r){const{state:i,gl:s}=this;!1===this.discard&&(s.enable(s.RASTERIZER_DISCARD),this.discard=!0);const{programGPU:a,transformBuffers:o,attributes:l}=this.get(r),u=this._getVaoKey(null,l),c=this.vaoCache[u];void 0===c?this._createVao(null,l):s.bindVertexArray(c),i.useProgram(a),this._bindUniforms(n);const d=this._getTransformFeedback(o);s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,d),s.beginTransformFeedback(s.POINTS),l[0].isStorageInstancedBufferAttribute?s.drawArraysInstanced(s.POINTS,0,1,t.count):s.drawArrays(s.POINTS,0,t.count),s.endTransformFeedback(),s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,null);for(let e=0;e<o.length;e++){const t=o[e];t.pbo&&this.textureUtils.copyBufferToTexture(t.transformBuffer,t.pbo),t.switchBuffers()}}finishCompute(e){const t=this.gl;this.discard=!1,t.disable(t.RASTERIZER_DISCARD),this.prepareTimestampBuffer(e),this._currentContext&&this._setFramebuffer(this._currentContext)}draw(e){const{object:t,pipeline:n,material:r,context:i,hardwareClippingPlanes:s}=e,{programGPU:a}=this.get(n),{gl:o,state:l}=this,u=this.get(i),c=e.getDrawParameters();if(null===c)return;this._bindUniforms(e.getBindings());const d=t.isMesh&&t.matrixWorld.determinant()<0;l.setMaterial(r,d,s),l.useProgram(a);const h=this.get(e);let f=h.staticVao;if(void 0===f||h.geometryId!==e.geometry.id){const t=this._getVaoKey(e.getIndex(),e.getAttributes());if(f=this.vaoCache[t],void 0===f){let t;({vaoGPU:f,staticVao:t}=this._createVao(e.getIndex(),e.getAttributes())),t&&(h.staticVao=f,h.geometryId=e.geometry.id)}}o.bindVertexArray(f);const p=e.getIndex(),m=u.lastOcclusionObject;if(m!==t&&void 0!==m){if(null!==m&&!0===m.occlusionTest&&(o.endQuery(o.ANY_SAMPLES_PASSED),u.occlusionQueryIndex++),!0===t.occlusionTest){const e=o.createQuery();o.beginQuery(o.ANY_SAMPLES_PASSED,e),u.occlusionQueries[u.occlusionQueryIndex]=e,u.occlusionQueryObjects[u.occlusionQueryIndex]=t}u.lastOcclusionObject=t}const g=this.bufferRenderer;t.isPoints?g.mode=o.POINTS:t.isLineSegments?g.mode=o.LINES:t.isLine?g.mode=o.LINE_STRIP:t.isLineLoop?g.mode=o.LINE_LOOP:!0===r.wireframe?(l.setLineWidth(r.wireframeLinewidth*this.renderer.getPixelRatio()),g.mode=o.LINES):g.mode=o.TRIANGLES;const{vertexCount:v,instanceCount:y}=c;let{firstVertex:b}=c;if(g.object=t,null!==p){b*=p.array.BYTES_PER_ELEMENT;const e=this.get(p);g.index=p.count,g.type=e.type}else g.index=0;t.isBatchedMesh?null!==t._multiDrawInstances?g.renderMultiDrawInstances(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount,t._multiDrawInstances):this.hasFeature("WEBGL_multi_draw")?g.renderMultiDraw(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount):sn("THREE.WebGLRenderer: WEBGL_multi_draw not supported."):y>1?g.renderInstances(b,v,y):g.render(b,v),o.bindVertexArray(null)}needsRenderUpdate(){return!1}getRenderCacheKey(){return""}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}copyTextureToBuffer(e,t,n,r,i,s){return this.textureUtils.copyTextureToBuffer(e,t,n,r,i,s)}createSampler(){}destroySampler(){}createNodeBuilder(e,t){return new PG(e,t)}createProgram(e){const t=this.gl,{stage:n,code:r}=e,i="fragment"===n?t.createShader(t.FRAGMENT_SHADER):t.createShader(t.VERTEX_SHADER);t.shaderSource(i,r),t.compileShader(i),this.set(e,{shaderGPU:i})}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){const n=this.gl,r=e.pipeline,{fragmentProgram:i,vertexProgram:s}=r,a=n.createProgram(),o=this.get(i).shaderGPU,l=this.get(s).shaderGPU;if(n.attachShader(a,o),n.attachShader(a,l),n.linkProgram(a),this.set(r,{programGPU:a,fragmentShader:o,vertexShader:l}),null!==t&&this.parallel){const i=new Promise(t=>{const i=this.parallel,s=()=>{n.getProgramParameter(a,i.COMPLETION_STATUS_KHR)?(this._completeCompile(e,r),t()):requestAnimationFrame(s)};s()});return void t.push(i)}this._completeCompile(e,r)}_handleSource(e,t){const n=e.split("\n"),r=[],i=Math.max(t-6,0),s=Math.min(t+6,n.length);for(let e=i;e<s;e++){const i=e+1;r.push(`${i===t?">":" "} ${i}: ${n[e]}`)}return r.join("\n")}_getShaderErrors(e,t,n){const r=e.getShaderParameter(t,e.COMPILE_STATUS),i=e.getShaderInfoLog(t).trim();if(r&&""===i)return"";const s=/ERROR: 0:(\d+)/.exec(i);if(s){const r=parseInt(s[1]);return n.toUpperCase()+"\n\n"+i+"\n\n"+this._handleSource(e.getShaderSource(t),r)}return i}_logProgramError(e,t,n){if(this.renderer.debug.checkShaderErrors){const r=this.gl;r.getProgramInfoLog(e).trim();if(!1===r.getProgramParameter(e,r.LINK_STATUS))if("function"==typeof this.renderer.debug.onShaderError)this.renderer.debug.onShaderError(r,e,n,t);else{this._getShaderErrors(r,n,"vertex"),this._getShaderErrors(r,t,"fragment")}}}_completeCompile(e,t){const{state:n,gl:r}=this,i=this.get(t),{programGPU:s,fragmentShader:a,vertexShader:o}=i;!1===r.getProgramParameter(s,r.LINK_STATUS)&&this._logProgramError(s,a,o),n.useProgram(s);const l=e.getBindings();this._setupBindings(l,s),this.set(t,{programGPU:s})}createComputePipeline(e,t){const{state:n,gl:r}=this,i={stage:"fragment",code:"#version 300 es\nprecision highp float;\nvoid main() {}"};this.createProgram(i);const{computeProgram:s}=e,a=r.createProgram(),o=this.get(i).shaderGPU,l=this.get(s).shaderGPU,u=s.transforms,c=[],d=[];for(let e=0;e<u.length;e++){const t=u[e];c.push(t.varyingName),d.push(t.attributeNode)}r.attachShader(a,o),r.attachShader(a,l),r.transformFeedbackVaryings(a,c,r.SEPARATE_ATTRIBS),r.linkProgram(a),!1===r.getProgramParameter(a,r.LINK_STATUS)&&this._logProgramError(a,o,l),n.useProgram(a),this._setupBindings(t,a);const h=s.attributes,f=[],p=[];for(let e=0;e<h.length;e++){const t=h[e].node.attribute;f.push(t),this.has(t)||this.attributeUtils.createAttribute(t,r.ARRAY_BUFFER)}for(let e=0;e<d.length;e++){const t=d[e].attribute;this.has(t)||this.attributeUtils.createAttribute(t,r.ARRAY_BUFFER);const n=this.get(t);p.push(n)}this.set(e,{programGPU:a,transformBuffers:p,attributes:f})}createBindings(e,t){if(!1===this._knownBindings.has(t)){this._knownBindings.add(t);let e=0,n=0;for(const r of t){this.set(r,{textures:n,uniformBuffers:e});for(const t of r.bindings)t.isUniformBuffer&&e++,t.isSampledTexture&&n++}}this.updateBindings(e,t)}updateBindings(e){const{gl:t}=this,n=this.get(e);let r=n.uniformBuffers,i=n.textures;for(const n of e.bindings)if(n.isUniformsGroup||n.isUniformBuffer){const e=n.buffer,i=t.createBuffer();t.bindBuffer(t.UNIFORM_BUFFER,i),t.bufferData(t.UNIFORM_BUFFER,e,t.DYNAMIC_DRAW),this.set(n,{index:r++,bufferGPU:i})}else if(n.isSampledTexture){const{textureGPU:e,glTextureType:t}=this.get(n.texture);this.set(n,{index:i++,textureGPU:e,glTextureType:t})}}updateBinding(e){const t=this.gl;if(e.isUniformsGroup||e.isUniformBuffer){const n=this.get(e).bufferGPU,r=e.buffer;t.bindBuffer(t.UNIFORM_BUFFER,n),t.bufferData(t.UNIFORM_BUFFER,r,t.DYNAMIC_DRAW)}}createIndexAttribute(e){const t=this.gl;this.attributeUtils.createAttribute(e,t.ELEMENT_ARRAY_BUFFER)}createAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}createStorageAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}hasFeature(e){const t=Object.keys(QG).filter(t=>QG[t]===e),n=this.extensions;for(let e=0;e<t.length;e++)if(n.has(t[e]))return!0;return!1}getMaxAnisotropy(){return this.capabilities.getMaxAnisotropy()}copyTextureToTexture(e,t,n=null,r=null,i=0){this.textureUtils.copyTextureToTexture(e,t,n,r,i)}copyFramebufferToTexture(e,t,n){this.textureUtils.copyFramebufferToTexture(e,t,n)}_setFramebuffer(e){const{gl:t,state:n}=this;let r=null;if(null!==e.textures){const i=e.renderTarget,s=this.get(i),{samples:a,depthBuffer:o,stencilBuffer:l}=i,u=!0===i.isWebGLCubeRenderTarget,c=!0===i.isRenderTarget3D,d=!0===i.isRenderTargetArray;let h=s.msaaFrameBuffer,f=s.depthRenderbuffer;const p=mO(e);let m;if(u?(s.cubeFramebuffers||(s.cubeFramebuffers={}),m=s.cubeFramebuffers[p]):(s.framebuffers||(s.framebuffers={}),m=s.framebuffers[p]),void 0===m){m=t.createFramebuffer(),n.bindFramebuffer(t.FRAMEBUFFER,m);const r=e.textures;if(u){s.cubeFramebuffers[p]=m;const{textureGPU:e}=this.get(r[0]),n=this.renderer._activeCubeFace;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+n,e,0)}else{s.framebuffers[p]=m;for(let n=0;n<r.length;n++){const i=r[n],s=this.get(i);s.renderTarget=e.renderTarget,s.cacheKey=p;const a=t.COLOR_ATTACHMENT0+n;if(c||d){const e=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,a,s.textureGPU,0,e)}else t.framebufferTexture2D(t.FRAMEBUFFER,a,t.TEXTURE_2D,s.textureGPU,0)}n.drawBuffers(e,m)}if(null!==e.depthTexture){const n=this.get(e.depthTexture),r=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;n.renderTarget=e.renderTarget,n.cacheKey=p,t.framebufferTexture2D(t.FRAMEBUFFER,r,t.TEXTURE_2D,n.textureGPU,0)}}if(a>0){if(void 0===h){const r=[];h=t.createFramebuffer(),n.bindFramebuffer(t.FRAMEBUFFER,h);const i=[],u=e.textures;for(let n=0;n<u.length;n++){if(i[n]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,i[n]),r.push(t.COLOR_ATTACHMENT0+n),o){const e=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;r.push(e)}const s=e.textures[n],u=this.get(s);t.renderbufferStorageMultisample(t.RENDERBUFFER,a,u.glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+n,t.RENDERBUFFER,i[n])}if(s.msaaFrameBuffer=h,s.msaaRenderbuffers=i,void 0===f){f=t.createRenderbuffer(),this.textureUtils.setupRenderBufferStorage(f,e),s.depthRenderbuffer=f;const n=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;r.push(n)}s.invalidationArray=r}r=s.msaaFrameBuffer}else r=m}n.bindFramebuffer(t.FRAMEBUFFER,r)}_getVaoKey(e,t){let n="";if(null!==e){n+=":"+this.get(e).id}for(let e=0;e<t.length;e++){n+=":"+this.get(t[e]).id}return n}_createVao(e,t){const{gl:n}=this,r=n.createVertexArray();let i="",s=!0;if(n.bindVertexArray(r),null!==e){const t=this.get(e);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.bufferGPU),i+=":"+t.id}for(let e=0;e<t.length;e++){const r=t[e],a=this.get(r);let o,l;i+=":"+a.id,n.bindBuffer(n.ARRAY_BUFFER,a.bufferGPU),n.enableVertexAttribArray(e),(r.isStorageBufferAttribute||r.isStorageInstancedBufferAttribute)&&(s=!1),!0===r.isInterleavedBufferAttribute?(o=r.data.stride*a.bytesPerElement,l=r.offset*a.bytesPerElement):(o=0,l=0),a.isInteger?n.vertexAttribIPointer(e,r.itemSize,a.type,o,l):n.vertexAttribPointer(e,r.itemSize,a.type,r.normalized,o,l),r.isInstancedBufferAttribute&&!r.isInterleavedBufferAttribute?n.vertexAttribDivisor(e,r.meshPerAttribute):r.isInterleavedBufferAttribute&&r.data.isInstancedInterleavedBuffer&&n.vertexAttribDivisor(e,r.data.meshPerAttribute)}return n.bindBuffer(n.ARRAY_BUFFER,null),this.vaoCache[i]=r,{vaoGPU:r,staticVao:s}}_getTransformFeedback(e){let t="";for(let n=0;n<e.length;n++)t+=":"+e[n].id;let n=this.transformFeedbackCache[t];if(void 0!==n)return n;const{gl:r}=this;n=r.createTransformFeedback(),r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,n);for(let t=0;t<e.length;t++){const n=e[t];r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,t,n.transformBuffer)}return r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,null),this.transformFeedbackCache[t]=n,n}_setupBindings(e,t){const n=this.gl;for(const r of e)for(const e of r.bindings){const r=this.get(e).index;if(e.isUniformsGroup||e.isUniformBuffer){const i=n.getUniformBlockIndex(t,e.name);n.uniformBlockBinding(t,i,r)}else if(e.isSampledTexture){const i=n.getUniformLocation(t,e.name);n.uniform1i(i,r)}}}_bindUniforms(e){const{gl:t,state:n}=this;for(const r of e)for(const e of r.bindings){const r=this.get(e),i=r.index;e.isUniformsGroup||e.isUniformBuffer?n.bindBufferBase(t.UNIFORM_BUFFER,i,r.bufferGPU):e.isSampledTexture&&n.bindTexture(r.glTextureType,r.textureGPU,t.TEXTURE0+i)}}dispose(){this.renderer.domElement.removeEventListener("webglcontextlost",this._onContextLost)}}const eH="point-list",tH="line-list",nH="line-strip",rH="triangle-list",iH="triangle-strip",sH="never",aH="less",oH="equal",lH="less-equal",uH="greater",cH="not-equal",dH="greater-equal",hH="always",fH="store",pH="load",mH="clear",gH="ccw",vH="none",yH="front",bH="back",_H="uint16",xH="uint32",SH={R8Unorm:"r8unorm",R8Snorm:"r8snorm",R8Uint:"r8uint",R8Sint:"r8sint",R16Uint:"r16uint",R16Sint:"r16sint",R16Float:"r16float",RG8Unorm:"rg8unorm",RG8Snorm:"rg8snorm",RG8Uint:"rg8uint",RG8Sint:"rg8sint",R32Uint:"r32uint",R32Sint:"r32sint",R32Float:"r32float",RG16Uint:"rg16uint",RG16Sint:"rg16sint",RG16Float:"rg16float",RGBA8Unorm:"rgba8unorm",RGBA8UnormSRGB:"rgba8unorm-srgb",RGBA8Snorm:"rgba8snorm",RGBA8Uint:"rgba8uint",RGBA8Sint:"rgba8sint",BGRA8Unorm:"bgra8unorm",BGRA8UnormSRGB:"bgra8unorm-srgb",RGB9E5UFloat:"rgb9e5ufloat",RGB10A2Unorm:"rgb10a2unorm",RG11B10uFloat:"rgb10a2unorm",RG32Uint:"rg32uint",RG32Sint:"rg32sint",RG32Float:"rg32float",RGBA16Uint:"rgba16uint",RGBA16Sint:"rgba16sint",RGBA16Float:"rgba16float",RGBA32Uint:"rgba32uint",RGBA32Sint:"rgba32sint",RGBA32Float:"rgba32float",Stencil8:"stencil8",Depth16Unorm:"depth16unorm",Depth24Plus:"depth24plus",Depth24PlusStencil8:"depth24plus-stencil8",Depth32Float:"depth32float",Depth32FloatStencil8:"depth32float-stencil8",BC1RGBAUnorm:"bc1-rgba-unorm",BC1RGBAUnormSRGB:"bc1-rgba-unorm-srgb",BC2RGBAUnorm:"bc2-rgba-unorm",BC2RGBAUnormSRGB:"bc2-rgba-unorm-srgb",BC3RGBAUnorm:"bc3-rgba-unorm",BC3RGBAUnormSRGB:"bc3-rgba-unorm-srgb",BC4RUnorm:"bc4-r-unorm",BC4RSnorm:"bc4-r-snorm",BC5RGUnorm:"bc5-rg-unorm",BC5RGSnorm:"bc5-rg-snorm",BC6HRGBUFloat:"bc6h-rgb-ufloat",BC6HRGBFloat:"bc6h-rgb-float",BC7RGBAUnorm:"bc7-rgba-unorm",BC7RGBAUnormSRGB:"bc7-rgba-srgb",ETC2RGB8Unorm:"etc2-rgb8unorm",ETC2RGB8UnormSRGB:"etc2-rgb8unorm-srgb",ETC2RGB8A1Unorm:"etc2-rgb8a1unorm",ETC2RGB8A1UnormSRGB:"etc2-rgb8a1unorm-srgb",ETC2RGBA8Unorm:"etc2-rgba8unorm",ETC2RGBA8UnormSRGB:"etc2-rgba8unorm-srgb",EACR11Unorm:"eac-r11unorm",EACR11Snorm:"eac-r11snorm",EACRG11Unorm:"eac-rg11unorm",EACRG11Snorm:"eac-rg11snorm",ASTC4x4Unorm:"astc-4x4-unorm",ASTC4x4UnormSRGB:"astc-4x4-unorm-srgb",ASTC5x4Unorm:"astc-5x4-unorm",ASTC5x4UnormSRGB:"astc-5x4-unorm-srgb",ASTC5x5Unorm:"astc-5x5-unorm",ASTC5x5UnormSRGB:"astc-5x5-unorm-srgb",ASTC6x5Unorm:"astc-6x5-unorm",ASTC6x5UnormSRGB:"astc-6x5-unorm-srgb",ASTC6x6Unorm:"astc-6x6-unorm",ASTC6x6UnormSRGB:"astc-6x6-unorm-srgb",ASTC8x5Unorm:"astc-8x5-unorm",ASTC8x5UnormSRGB:"astc-8x5-unorm-srgb",ASTC8x6Unorm:"astc-8x6-unorm",ASTC8x6UnormSRGB:"astc-8x6-unorm-srgb",ASTC8x8Unorm:"astc-8x8-unorm",ASTC8x8UnormSRGB:"astc-8x8-unorm-srgb",ASTC10x5Unorm:"astc-10x5-unorm",ASTC10x5UnormSRGB:"astc-10x5-unorm-srgb",ASTC10x6Unorm:"astc-10x6-unorm",ASTC10x6UnormSRGB:"astc-10x6-unorm-srgb",ASTC10x8Unorm:"astc-10x8-unorm",ASTC10x8UnormSRGB:"astc-10x8-unorm-srgb",ASTC10x10Unorm:"astc-10x10-unorm",ASTC10x10UnormSRGB:"astc-10x10-unorm-srgb",ASTC12x10Unorm:"astc-12x10-unorm",ASTC12x10UnormSRGB:"astc-12x10-unorm-srgb",ASTC12x12Unorm:"astc-12x12-unorm",ASTC12x12UnormSRGB:"astc-12x12-unorm-srgb"},TH="clamp-to-edge",EH="repeat",AH="mirror-repeat",wH="linear",MH="nearest",RH="zero",CH="one",IH="src",LH="one-minus-src",PH="src-alpha",NH="one-minus-src-alpha",DH="dst",kH="one-minus-dst",OH="dst-alpha",FH="one-minus-dst-alpha",UH="src-alpha-saturated",BH="constant",VH="one-minus-constant",zH="add",GH="subtract",HH="reverse-subtract",$H="min",WH="max",jH=0,qH=15,XH="keep",YH="zero",KH="replace",QH="invert",ZH="increment-clamp",JH="decrement-clamp",e$="increment-wrap",t$="decrement-wrap",n$="storage",r$="read-only-storage",i$="write-only",s$="read-only",a$="read-write",o$="float",l$="unfilterable-float",u$="depth",c$="sint",d$="uint",h$="2d",f$="3d",p$="2d",m$="2d-array",g$="cube",v$="3d",y$="all",b$="vertex",_$="instance",x$={DepthClipControl:"depth-clip-control",Depth32FloatStencil8:"depth32float-stencil8",TextureCompressionBC:"texture-compression-bc",TextureCompressionETC2:"texture-compression-etc2",TextureCompressionASTC:"texture-compression-astc",TimestampQuery:"timestamp-query",IndirectFirstInstance:"indirect-first-instance",ShaderF16:"shader-f16",RG11B10UFloat:"rg11b10ufloat-renderable",BGRA8UNormStorage:"bgra8unorm-storage",Float32Filterable:"float32-filterable",ClipDistances:"clip-distances",DualSourceBlending:"dual-source-blending",Subgroups:"subgroups"};class S$ extends mG{constructor(e,t){super(e),this.texture=t,this.version=t?t.version:0,this.isSampler=!0}}class T$ extends S${constructor(e,t,n){super(e,t?t.value:null),this.textureNode=t,this.groupNode=n}update(){this.texture=this.textureNode.value}}class E$ extends gG{constructor(e,t){super(e,t?t.array:null),this.attribute=t,this.isStorageBuffer=!0}}let A$=0;class w$ extends E${constructor(e,t){super("StorageBuffer_"+A$++,e?e.value:null),this.nodeUniform=e,this.access=e?e.access:HE.READ_WRITE,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class M$ extends $k{constructor(e){super(),this.device=e;this.mipmapSampler=e.createSampler({minFilter:wH}),this.flipYSampler=e.createSampler({minFilter:MH}),this.transferPipelines={},this.flipYPipelines={},this.mipmapVertexShaderModule=e.createShaderModule({label:"mipmapVertex",code:"\nstruct VarysStruct {\n\t@builtin( position ) Position: vec4<f32>,\n\t@location( 0 ) vTex : vec2<f32>\n};\n\n@vertex\nfn main( @builtin( vertex_index ) vertexIndex : u32 ) -> VarysStruct {\n\n\tvar Varys : VarysStruct;\n\n\tvar pos = array< vec2<f32>, 4 >(\n\t\tvec2<f32>( -1.0,  1.0 ),\n\t\tvec2<f32>(  1.0,  1.0 ),\n\t\tvec2<f32>( -1.0, -1.0 ),\n\t\tvec2<f32>(  1.0, -1.0 )\n\t);\n\n\tvar tex = array< vec2<f32>, 4 >(\n\t\tvec2<f32>( 0.0, 0.0 ),\n\t\tvec2<f32>( 1.0, 0.0 ),\n\t\tvec2<f32>( 0.0, 1.0 ),\n\t\tvec2<f32>( 1.0, 1.0 )\n\t);\n\n\tVarys.vTex = tex[ vertexIndex ];\n\tVarys.Position = vec4<f32>( pos[ vertexIndex ], 0.0, 1.0 );\n\n\treturn Varys;\n\n}\n"}),this.mipmapFragmentShaderModule=e.createShaderModule({label:"mipmapFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n\treturn textureSample( img, imgSampler, vTex );\n\n}\n"}),this.flipYFragmentShaderModule=e.createShaderModule({label:"flipYFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n\treturn textureSample( img, imgSampler, vec2( vTex.x, 1.0 - vTex.y ) );\n\n}\n"})}getTransferPipeline(e){let t=this.transferPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`mipmap-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.mipmapFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:iH,stripIndexFormat:xH},layout:"auto"}),this.transferPipelines[e]=t),t}getFlipYPipeline(e){let t=this.flipYPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`flipY-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.flipYFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:iH,stripIndexFormat:xH},layout:"auto"}),this.flipYPipelines[e]=t),t}flipY(e,t,n=0){const r=t.format,{width:i,height:s}=t.size,a=this.getTransferPipeline(r),o=this.getFlipYPipeline(r),l=this.device.createTexture({size:{width:i,height:s,depthOrArrayLayers:1},format:r,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),u=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:p$,baseArrayLayer:n}),c=l.createView({baseMipLevel:0,mipLevelCount:1,dimension:p$,baseArrayLayer:0}),d=this.device.createCommandEncoder({}),h=(e,t,n)=>{const r=e.getBindGroupLayout(0),i=this.device.createBindGroup({layout:r,entries:[{binding:0,resource:this.flipYSampler},{binding:1,resource:t}]}),s=d.beginRenderPass({colorAttachments:[{view:n,loadOp:mH,storeOp:fH,clearValue:[0,0,0,0]}]});s.setPipeline(e),s.setBindGroup(0,i),s.draw(4,1,0,0),s.end()};h(a,u,c),h(o,c,u),this.device.queue.submit([d.finish()]),l.destroy()}generateMipmaps(e,t,n=0){const r=this.get(e);void 0===r.useCount&&(r.useCount=0,r.layers=[]);const i=r.layers[n]||this._mipmapCreateBundles(e,t,n),s=this.device.createCommandEncoder({});this._mipmapRunBundles(s,i),this.device.queue.submit([s.finish()]),0!==r.useCount&&(r.layers[n]=i),r.useCount++}_mipmapCreateBundles(e,t,n){const r=this.getTransferPipeline(t.format),i=r.getBindGroupLayout(0);let s=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:p$,baseArrayLayer:n});const a=[];for(let o=1;o<t.mipLevelCount;o++){const l=this.device.createBindGroup({layout:i,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:s}]}),u=e.createView({baseMipLevel:o,mipLevelCount:1,dimension:p$,baseArrayLayer:n}),c={colorAttachments:[{view:u,loadOp:mH,storeOp:fH,clearValue:[0,0,0,0]}]},d=this.device.createRenderBundleEncoder({colorFormats:[t.format]});d.setPipeline(r),d.setBindGroup(0,l),d.draw(4,1,0,0),a.push({renderBundles:[d.finish()],passDescriptor:c}),s=u}return a}_mipmapRunBundles(e,t){const n=t.length;for(let r=0;r<n;r++){const n=t[r],i=e.beginRenderPass(n.passDescriptor);i.executeBundles(n.renderBundles),i.end()}}}const R$={[Et]:"never",[At]:"less",[wt]:"equal",[Mt]:"less-equal",[Rt]:"greater",[It]:"greater-equal",[Lt]:"always",[Ct]:"not-equal"},C$=[0,1,3,2,4,5];class I${constructor(e){this.backend=e,this._passUtils=null,this.defaultTexture={},this.defaultCubeTexture={},this.defaultVideoFrame=null,this.colorBuffer=null,this.depthTexture=new Fa,this.depthTexture.name="depthBuffer"}createSampler(e){const t=this.backend,n=t.device,r=t.get(e),i={addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:1};i.magFilter===wH&&i.minFilter===wH&&i.mipmapFilter===wH&&(i.maxAnisotropy=e.anisotropy),e.isDepthTexture&&null!==e.compareFunction&&(i.compare=R$[e.compareFunction]),r.sampler=n.createSampler(i)}createDefaultTexture(e){let t;const n=L$(e);e.isCubeTexture?t=this._getDefaultCubeTextureGPU(n):e.isVideoTexture?this.backend.get(e).externalTexture=this._getDefaultVideoFrame():t=this._getDefaultTextureGPU(n),this.backend.get(e).texture=t}createTexture(e,t={}){const n=this.backend,r=n.get(e);if(r.initialized)throw new Error("WebGPUTextureUtils: Texture already initialized.");void 0===t.needsMipmaps&&(t.needsMipmaps=!1),void 0===t.levels&&(t.levels=1),void 0===t.depth&&(t.depth=1);const{width:i,height:s,depth:a,levels:o}=t;e.isFramebufferTexture&&(t.renderTarget?t.format=this.backend.utils.getCurrentColorFormat(t.renderTarget):t.format=this.backend.utils.getPreferredCanvasFormat());const l=this._getDimension(e),u=e.internalFormat||t.format||L$(e,n.device);r.format=u;const{samples:c,primarySamples:d,isMSAA:h}=n.utils.getTextureSampleData(e);let f=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC;!0===e.isStorageTexture&&(f|=GPUTextureUsage.STORAGE_BINDING),!0!==e.isCompressedTexture&&!0!==e.isCompressedArrayTexture&&(f|=GPUTextureUsage.RENDER_ATTACHMENT);const p={label:e.name,size:{width:i,height:s,depthOrArrayLayers:a},mipLevelCount:o,sampleCount:d,dimension:l,format:u,usage:f};if(e.isVideoTexture){const t=e.source.data,n=new VideoFrame(t);p.size.width=n.displayWidth,p.size.height=n.displayHeight,n.close(),r.externalTexture=t}else{if(void 0===u)return this.createDefaultTexture(e);r.texture=n.device.createTexture(p)}if(h){const e=Object.assign({},p);e.label=e.label+"-msaa",e.sampleCount=c,r.msaaTexture=n.device.createTexture(e)}r.initialized=!0,r.textureDescriptorGPU=p}destroyTexture(e){const t=this.backend,n=t.get(e);void 0!==n.texture&&n.texture.destroy(),void 0!==n.msaaTexture&&n.msaaTexture.destroy(),t.delete(e)}destroySampler(e){delete this.backend.get(e).sampler}generateMipmaps(e){const t=this.backend.get(e);if(e.isCubeTexture)for(let e=0;e<6;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e);else{const n=e.image.depth||1;for(let e=0;e<n;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e)}}getColorBuffer(){this.colorBuffer&&this.colorBuffer.destroy();const e=this.backend,{width:t,height:n}=e.getDrawingBufferSize();return this.colorBuffer=e.device.createTexture({label:"colorBuffer",size:{width:t,height:n,depthOrArrayLayers:1},sampleCount:e.utils.getSampleCount(e.renderer.samples),format:e.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.colorBuffer}getDepthBuffer(e=!0,t=!1){const n=this.backend,{width:r,height:i}=n.getDrawingBufferSize(),s=this.depthTexture,a=n.get(s).texture;let o,l;if(t?(o=Ae,l=ve):e&&(o=Ee,l=he),void 0!==a){if(s.image.width===r&&s.image.height===i&&s.format===o&&s.type===l)return a;this.destroyTexture(s)}return s.name="depthBuffer",s.format=o,s.type=l,s.image.width=r,s.image.height=i,this.createTexture(s,{width:r,height:i}),n.get(s).texture}updateTexture(e,t){const n=this.backend.get(e),{textureDescriptorGPU:r}=n;if(!e.isRenderTargetTexture&&void 0!==r){if(e.isDataTexture)this._copyBufferToTexture(t.image,n.texture,r,0,e.flipY);else if(e.isDataArrayTexture||e.isData3DTexture)for(let i=0;i<t.image.depth;i++)this._copyBufferToTexture(t.image,n.texture,r,i,e.flipY,i);else if(e.isCompressedTexture||e.isCompressedArrayTexture)this._copyCompressedBufferToTexture(e.mipmaps,n.texture,r);else if(e.isCubeTexture)this._copyCubeMapToTexture(t.images,n.texture,r,e.flipY);else if(e.isVideoTexture){const t=e.source.data;n.externalTexture=t}else this._copyImageToTexture(t.image,n.texture,r,0,e.flipY);n.version=e.version,e.onUpdate&&e.onUpdate(e)}}async copyTextureToBuffer(e,t,n,r,i,s){const a=this.backend.device,o=this.backend.get(e),l=o.texture,u=o.textureDescriptorGPU.format,c=this._getBytesPerTexel(u);let d=r*c;d=256*Math.ceil(d/256);const h=a.createBuffer({size:r*i*c,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),f=a.createCommandEncoder();f.copyTextureToBuffer({texture:l,origin:{x:t,y:n,z:s}},{buffer:h,bytesPerRow:d},{width:r,height:i});const p=this._getTypedArrayType(u);a.queue.submit([f.finish()]),await h.mapAsync(GPUMapMode.READ);return new p(h.getMappedRange())}_isEnvironmentTexture(e){const t=e.mapping;return t===Y||t===K||t===q||t===X}_getDefaultTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){const n=new yn;n.minFilter=te,n.magFilter=te,this.createTexture(n,{width:1,height:1,format:e}),this.defaultTexture[e]=t=n}return this.backend.get(t).texture}_getDefaultCubeTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){const n=new $i;n.minFilter=te,n.magFilter=te,this.createTexture(n,{width:1,height:1,depth:6}),this.defaultCubeTexture[e]=t=n}return this.backend.get(t).texture}_getDefaultVideoFrame(){let e=this.defaultVideoFrame;if(null===e){const t={timestamp:0,codedWidth:1,codedHeight:1,format:"RGBA"};this.defaultVideoFrame=e=new VideoFrame(new Uint8Array([0,0,0,255]),t)}return e}_copyCubeMapToTexture(e,t,n,r){for(let i=0;i<6;i++){const s=e[i],a=!0===r?C$[i]:i;s.isDataTexture?this._copyBufferToTexture(s.image,t,n,a,r):this._copyImageToTexture(s,t,n,a,r)}}_copyImageToTexture(e,t,n,r,i){this.backend.device.queue.copyExternalImageToTexture({source:e},{texture:t,mipLevel:0,origin:{x:0,y:0,z:r}},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===i&&this._flipY(t,n,r)}_getPassUtils(){let e=this._passUtils;return null===e&&(this._passUtils=e=new M$(this.backend.device)),e}_generateMipmaps(e,t,n=0){this._getPassUtils().generateMipmaps(e,t,n)}_flipY(e,t,n=0){this._getPassUtils().flipY(e,t,n)}_copyBufferToTexture(e,t,n,r,i,s=0){const a=this.backend.device,o=e.data,l=this._getBytesPerTexel(n.format),u=e.width*l;a.queue.writeTexture({texture:t,mipLevel:0,origin:{x:0,y:0,z:r}},o,{offset:e.width*e.height*l*s,bytesPerRow:u},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===i&&this._flipY(t,n,r)}_copyCompressedBufferToTexture(e,t,n){const r=this.backend.device,i=this._getBlockData(n.format),s=n.size.depthOrArrayLayers>1;for(let a=0;a<e.length;a++){const o=e[a],l=o.width,u=o.height,c=s?n.size.depthOrArrayLayers:1,d=Math.ceil(l/i.width)*i.byteLength,h=d*Math.ceil(u/i.height);for(let e=0;e<c;e++)r.queue.writeTexture({texture:t,mipLevel:a,origin:{x:0,y:0,z:e}},o.data,{offset:e*h,bytesPerRow:d,rowsPerImage:Math.ceil(u/i.height)},{width:Math.ceil(l/i.width)*i.width,height:Math.ceil(u/i.height)*i.height,depthOrArrayLayers:1})}}_getBlockData(e){return e===SH.BC1RGBAUnorm||e===SH.BC1RGBAUnormSRGB?{byteLength:8,width:4,height:4}:e===SH.BC2RGBAUnorm||e===SH.BC2RGBAUnormSRGB||e===SH.BC3RGBAUnorm||e===SH.BC3RGBAUnormSRGB?{byteLength:16,width:4,height:4}:e===SH.BC4RUnorm||e===SH.BC4RSNorm?{byteLength:8,width:4,height:4}:e===SH.BC5RGUnorm||e===SH.BC5RGSnorm||e===SH.BC6HRGBUFloat||e===SH.BC6HRGBFloat||e===SH.BC7RGBAUnorm||e===SH.BC7RGBAUnormSRGB?{byteLength:16,width:4,height:4}:e===SH.ETC2RGB8Unorm||e===SH.ETC2RGB8UnormSRGB||e===SH.ETC2RGB8A1Unorm||e===SH.ETC2RGB8A1UnormSRGB?{byteLength:8,width:4,height:4}:e===SH.ETC2RGBA8Unorm||e===SH.ETC2RGBA8UnormSRGB?{byteLength:16,width:4,height:4}:e===SH.EACR11Unorm||e===SH.EACR11Snorm?{byteLength:8,width:4,height:4}:e===SH.EACRG11Unorm||e===SH.EACRG11Snorm||e===SH.ASTC4x4Unorm||e===SH.ASTC4x4UnormSRGB?{byteLength:16,width:4,height:4}:e===SH.ASTC5x4Unorm||e===SH.ASTC5x4UnormSRGB?{byteLength:16,width:5,height:4}:e===SH.ASTC5x5Unorm||e===SH.ASTC5x5UnormSRGB?{byteLength:16,width:5,height:5}:e===SH.ASTC6x5Unorm||e===SH.ASTC6x5UnormSRGB?{byteLength:16,width:6,height:5}:e===SH.ASTC6x6Unorm||e===SH.ASTC6x6UnormSRGB?{byteLength:16,width:6,height:6}:e===SH.ASTC8x5Unorm||e===SH.ASTC8x5UnormSRGB?{byteLength:16,width:8,height:5}:e===SH.ASTC8x6Unorm||e===SH.ASTC8x6UnormSRGB?{byteLength:16,width:8,height:6}:e===SH.ASTC8x8Unorm||e===SH.ASTC8x8UnormSRGB?{byteLength:16,width:8,height:8}:e===SH.ASTC10x5Unorm||e===SH.ASTC10x5UnormSRGB?{byteLength:16,width:10,height:5}:e===SH.ASTC10x6Unorm||e===SH.ASTC10x6UnormSRGB?{byteLength:16,width:10,height:6}:e===SH.ASTC10x8Unorm||e===SH.ASTC10x8UnormSRGB?{byteLength:16,width:10,height:8}:e===SH.ASTC10x10Unorm||e===SH.ASTC10x10UnormSRGB?{byteLength:16,width:10,height:10}:e===SH.ASTC12x10Unorm||e===SH.ASTC12x10UnormSRGB?{byteLength:16,width:12,height:10}:e===SH.ASTC12x12Unorm||e===SH.ASTC12x12UnormSRGB?{byteLength:16,width:12,height:12}:void 0}_convertAddressMode(e){let t=TH;return e===Z?t=EH:e===ee&&(t=AH),t}_convertFilterMode(e){let t=wH;return e!==te&&e!==ne&&e!==re||(t=MH),t}_getBytesPerTexel(e){return e===SH.R8Unorm||e===SH.R8Snorm||e===SH.R8Uint||e===SH.R8Sint?1:e===SH.R16Uint||e===SH.R16Sint||e===SH.R16Float||e===SH.RG8Unorm||e===SH.RG8Snorm||e===SH.RG8Uint||e===SH.RG8Sint?2:e===SH.R32Uint||e===SH.R32Sint||e===SH.R32Float||e===SH.RG16Uint||e===SH.RG16Sint||e===SH.RG16Float||e===SH.RGBA8Unorm||e===SH.RGBA8UnormSRGB||e===SH.RGBA8Snorm||e===SH.RGBA8Uint||e===SH.RGBA8Sint||e===SH.BGRA8Unorm||e===SH.BGRA8UnormSRGB||e===SH.RGB9E5UFloat||e===SH.RGB10A2Unorm||e===SH.RG11B10UFloat||e===SH.Depth32Float||e===SH.Depth24Plus||e===SH.Depth24PlusStencil8||e===SH.Depth32FloatStencil8?4:e===SH.RG32Uint||e===SH.RG32Sint||e===SH.RG32Float||e===SH.RGBA16Uint||e===SH.RGBA16Sint||e===SH.RGBA16Float?8:e===SH.RGBA32Uint||e===SH.RGBA32Sint||e===SH.RGBA32Float?16:void 0}_getTypedArrayType(e){return e===SH.R8Uint?Uint8Array:e===SH.R8Sint?Int8Array:e===SH.R8Unorm?Uint8Array:e===SH.R8Snorm?Int8Array:e===SH.RG8Uint?Uint8Array:e===SH.RG8Sint?Int8Array:e===SH.RG8Unorm?Uint8Array:e===SH.RG8Snorm?Int8Array:e===SH.RGBA8Uint?Uint8Array:e===SH.RGBA8Sint?Int8Array:e===SH.RGBA8Unorm?Uint8Array:e===SH.RGBA8Snorm?Int8Array:e===SH.R16Uint?Uint16Array:e===SH.R16Sint?Int16Array:e===SH.RG16Uint?Uint16Array:e===SH.RG16Sint?Int16Array:e===SH.RGBA16Uint?Uint16Array:e===SH.RGBA16Sint?Int16Array:e===SH.R16Float||e===SH.RG16Float||e===SH.RGBA16Float?Uint16Array:e===SH.R32Uint?Uint32Array:e===SH.R32Sint?Int32Array:e===SH.R32Float?Float32Array:e===SH.RG32Uint?Uint32Array:e===SH.RG32Sint?Int32Array:e===SH.RG32Float?Float32Array:e===SH.RGBA32Uint?Uint32Array:e===SH.RGBA32Sint?Int32Array:e===SH.RGBA32Float?Float32Array:e===SH.BGRA8Unorm||e===SH.BGRA8UnormSRGB?Uint8Array:e===SH.RGB10A2Unorm||e===SH.RGB9E5UFloat||e===SH.RG11B10UFloat?Uint32Array:e===SH.Depth32Float?Float32Array:e===SH.Depth24Plus||e===SH.Depth24PlusStencil8?Uint32Array:e===SH.Depth32FloatStencil8?Float32Array:void 0}_getDimension(e){let t;return t=e.isData3DTexture?f$:h$,t}}function L$(e,t=null){const n=e.format,r=e.type,i=e.colorSpace;let s;if(!0===e.isCompressedTexture||!0===e.isCompressedArrayTexture)switch(n){case Pe:s=i===yt?SH.BC1RGBAUnormSRGB:SH.BC1RGBAUnorm;break;case Ne:s=i===yt?SH.BC2RGBAUnormSRGB:SH.BC2RGBAUnorm;break;case De:s=i===yt?SH.BC3RGBAUnormSRGB:SH.BC3RGBAUnorm;break;case Ve:s=i===yt?SH.ETC2RGB8UnormSRGB:SH.ETC2RGB8Unorm;break;case ze:s=i===yt?SH.ETC2RGBA8UnormSRGB:SH.ETC2RGBA8Unorm;break;case Ge:s=i===yt?SH.ASTC4x4UnormSRGB:SH.ASTC4x4Unorm;break;case He:s=i===yt?SH.ASTC5x4UnormSRGB:SH.ASTC5x4Unorm;break;case $e:s=i===yt?SH.ASTC5x5UnormSRGB:SH.ASTC5x5Unorm;break;case We:s=i===yt?SH.ASTC6x5UnormSRGB:SH.ASTC6x5Unorm;break;case je:s=i===yt?SH.ASTC6x6UnormSRGB:SH.ASTC6x6Unorm;break;case qe:s=i===yt?SH.ASTC8x5UnormSRGB:SH.ASTC8x5Unorm;break;case Xe:s=i===yt?SH.ASTC8x6UnormSRGB:SH.ASTC8x6Unorm;break;case Ye:s=i===yt?SH.ASTC8x8UnormSRGB:SH.ASTC8x8Unorm;break;case Ke:s=i===yt?SH.ASTC10x5UnormSRGB:SH.ASTC10x5Unorm;break;case Qe:s=i===yt?SH.ASTC10x6UnormSRGB:SH.ASTC10x6Unorm;break;case Ze:s=i===yt?SH.ASTC10x8UnormSRGB:SH.ASTC10x8Unorm;break;case Je:s=i===yt?SH.ASTC10x10UnormSRGB:SH.ASTC10x10Unorm;break;case et:s=i===yt?SH.ASTC12x10UnormSRGB:SH.ASTC12x10Unorm;break;case tt:s=i===yt?SH.ASTC12x12UnormSRGB:SH.ASTC12x12Unorm;break;case xe:s=i===yt?SH.RGBA8UnormSRGB:SH.RGBA8Unorm}else switch(n){case xe:switch(r){case le:s=SH.RGBA8Snorm;break;case ue:s=SH.RGBA16Sint;break;case ce:s=SH.RGBA16Uint;break;case he:s=SH.RGBA32Uint;break;case de:s=SH.RGBA32Sint;break;case oe:s=i===yt?SH.RGBA8UnormSRGB:SH.RGBA8Unorm;break;case pe:s=SH.RGBA16Float;break;case fe:s=SH.RGBA32Float}break;case _e:if(r===ye)s=SH.RGB9E5UFloat;break;case we:switch(r){case le:s=SH.R8Snorm;break;case ue:s=SH.R16Sint;break;case ce:s=SH.R16Uint;break;case he:s=SH.R32Uint;break;case de:s=SH.R32Sint;break;case oe:s=SH.R8Unorm;break;case pe:s=SH.R16Float;break;case fe:s=SH.R32Float}break;case Re:switch(r){case le:s=SH.RG8Snorm;break;case ue:s=SH.RG16Sint;break;case ce:s=SH.RG16Uint;break;case he:s=SH.RG32Uint;break;case de:s=SH.RG32Sint;break;case oe:s=SH.RG8Unorm;break;case pe:s=SH.RG16Float;break;case fe:s=SH.RG32Float}break;case Ee:switch(r){case ce:s=SH.Depth16Unorm;break;case he:s=SH.Depth24Plus;break;case fe:s=SH.Depth32Float}break;case Ae:switch(r){case ve:s=SH.Depth24PlusStencil8;break;case fe:t&&t.features.has(x$.Depth32FloatStencil8),s=SH.Depth32FloatStencil8}break;case Me:switch(r){case de:s=SH.R32Sint;break;case he:s=SH.R32Uint}break;case Ce:switch(r){case de:s=SH.RG32Sint;break;case he:s=SH.RG32Uint}break;case Ie:switch(r){case de:s=SH.RGBA32Sint;break;case he:s=SH.RGBA32Uint}}return s}const P$=/^[fn]*\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)\s*[\-\>]*\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/i,N$=/([a-z_0-9]+)\s*:\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/gi,D$={f32:"float",i32:"int",u32:"uint",bool:"bool","vec2<f32>":"vec2","vec2<i32>":"ivec2","vec2<u32>":"uvec2","vec2<bool>":"bvec2",vec2f:"vec2",vec2i:"ivec2",vec2u:"uvec2",vec2b:"bvec2","vec3<f32>":"vec3","vec3<i32>":"ivec3","vec3<u32>":"uvec3","vec3<bool>":"bvec3",vec3f:"vec3",vec3i:"ivec3",vec3u:"uvec3",vec3b:"bvec3","vec4<f32>":"vec4","vec4<i32>":"ivec4","vec4<u32>":"uvec4","vec4<bool>":"bvec4",vec4f:"vec4",vec4i:"ivec4",vec4u:"uvec4",vec4b:"bvec4","mat2x2<f32>":"mat2",mat2x2f:"mat2","mat3x3<f32>":"mat3",mat3x3f:"mat3","mat4x4<f32>":"mat4",mat4x4f:"mat4",sampler:"sampler",texture_1d:"texture",texture_2d:"texture",texture_2d_array:"texture",texture_multisampled_2d:"cubeTexture",texture_depth_2d:"depthTexture",texture_depth_multisampled_2d:"depthTexture",texture_3d:"texture3D",texture_cube:"cubeTexture",texture_cube_array:"cubeTexture",texture_storage_1d:"storageTexture",texture_storage_2d:"storageTexture",texture_storage_2d_array:"storageTexture",texture_storage_3d:"storageTexture"};class k$ extends qz{constructor(e){const{type:t,inputs:n,name:r,inputsCode:i,blockCode:s,outputType:a}=(e=>{const t=(e=e.trim()).match(P$);if(null!==t&&4===t.length){const n=t[2],r=[];let i=null;for(;null!==(i=N$.exec(n));)r.push({name:i[1],type:i[2]});const s=[];for(let e=0;e<r.length;e++){const{name:t,type:n}=r[e];let i=n;i.startsWith("ptr")?i="pointer":(i.startsWith("texture")&&(i=n.split("<")[0]),i=D$[i]),s.push(new kz(i,t))}const a=e.substring(t[0].length),o=t[3]||"void",l=void 0!==t[1]?t[1]:"";return{type:D$[o]||o,inputs:s,name:l,inputsCode:n,blockCode:a,outputType:o}}throw new Error("FunctionNode: Function is not a WGSL code.")})(e);super(t,n,r),this.inputsCode=i,this.blockCode=s,this.outputType=a}getCode(e=this.name){const t="void"!==this.outputType?"-> "+this.outputType:"";return`fn ${e} ( ${this.inputsCode.trim()} ) ${t}`+this.blockCode}}class O$ extends jz{parseFunction(e){return new k$(e)}}const F$="undefined"!=typeof self?self.GPUShaderStage:{VERTEX:1,FRAGMENT:2,COMPUTE:4},U$={[HE.READ_ONLY]:"read",[HE.WRITE_ONLY]:"write",[HE.READ_WRITE]:"read_write"},B$={[Z]:"repeat",[J]:"clamp",[ee]:"mirror"},V$={vertex:F$?F$.VERTEX:1,fragment:F$?F$.FRAGMENT:2,compute:F$?F$.COMPUTE:4},z$={instance:!0,swizzleAssign:!1,storageBuffer:!0},G$={"^^":"tsl_xor"},H$={float:"f32",int:"i32",uint:"u32",bool:"bool",color:"vec3<f32>",vec2:"vec2<f32>",ivec2:"vec2<i32>",uvec2:"vec2<u32>",bvec2:"vec2<bool>",vec3:"vec3<f32>",ivec3:"vec3<i32>",uvec3:"vec3<u32>",bvec3:"vec3<bool>",vec4:"vec4<f32>",ivec4:"vec4<i32>",uvec4:"vec4<u32>",bvec4:"vec4<bool>",mat2:"mat2x2<f32>",mat3:"mat3x3<f32>",mat4:"mat4x4<f32>"},$$={},W$={tsl_xor:new gU("fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }"),mod_float:new gU("fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }"),mod_vec2:new gU("fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }"),mod_vec3:new gU("fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }"),mod_vec4:new gU("fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }"),equals_bool:new gU("fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }"),equals_bvec2:new gU("fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }"),equals_bvec3:new gU("fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }"),equals_bvec4:new gU("fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }"),repeatWrapping_float:new gU("fn tsl_repeatWrapping_float( coord: f32 ) -> f32 { return fract( coord ); }"),mirrorWrapping_float:new gU("fn tsl_mirrorWrapping_float( coord: f32 ) -> f32 { let mirrored = fract( coord * 0.5 ) * 2.0; return 1.0 - abs( 1.0 - mirrored ); }"),clampWrapping_float:new gU("fn tsl_clampWrapping_float( coord: f32 ) -> f32 { return clamp( coord, 0.0, 1.0 ); }"),biquadraticTexture:new gU("\nfn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, iRes : vec2u, level : u32 ) -> vec4f {\n\n\tlet res = vec2f( iRes );\n\n\tlet uvScaled = coord * res;\n\tlet uvWrapping = ( ( uvScaled % res ) + res ) % res;\n\n\t// https://www.shadertoy.com/view/WtyXRy\n\n\tlet uv = uvWrapping - 0.5;\n\tlet iuv = floor( uv );\n\tlet f = fract( uv );\n\n\tlet rg1 = textureLoad( map, vec2u( iuv + vec2( 0.5, 0.5 ) ) % iRes, level );\n\tlet rg2 = textureLoad( map, vec2u( iuv + vec2( 1.5, 0.5 ) ) % iRes, level );\n\tlet rg3 = textureLoad( map, vec2u( iuv + vec2( 0.5, 1.5 ) ) % iRes, level );\n\tlet rg4 = textureLoad( map, vec2u( iuv + vec2( 1.5, 1.5 ) ) % iRes, level );\n\n\treturn mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );\n\n}\n")},j$={dFdx:"dpdx",dFdy:"- dpdy",mod_float:"tsl_mod_float",mod_vec2:"tsl_mod_vec2",mod_vec3:"tsl_mod_vec3",mod_vec4:"tsl_mod_vec4",equals_bool:"tsl_equals_bool",equals_bvec2:"tsl_equals_bvec2",equals_bvec3:"tsl_equals_bvec3",equals_bvec4:"tsl_equals_bvec4",inversesqrt:"inverseSqrt",bitcast:"bitcast<f32>"};"undefined"!=typeof navigator&&/Windows/g.test(navigator.userAgent)&&(W$.pow_float=new gU("fn tsl_pow_float( a : f32, b : f32 ) -> f32 { return select( -pow( -a, b ), pow( a, b ), a > 0.0 ); }"),W$.pow_vec2=new gU("fn tsl_pow_vec2( a : vec2f, b : vec2f ) -> vec2f { return vec2f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ) ); }",[W$.pow_float]),W$.pow_vec3=new gU("fn tsl_pow_vec3( a : vec3f, b : vec3f ) -> vec3f { return vec3f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ) ); }",[W$.pow_float]),W$.pow_vec4=new gU("fn tsl_pow_vec4( a : vec4f, b : vec4f ) -> vec4f { return vec4f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ), tsl_pow_float( a.w, b.w ) ); }",[W$.pow_float]),j$.pow_float="tsl_pow_float",j$.pow_vec2="tsl_pow_vec2",j$.pow_vec3="tsl_pow_vec3",j$.pow_vec4="tsl_pow_vec4");let q$="";!0!==("undefined"!=typeof navigator&&/Firefox|Deno/g.test(navigator.userAgent))&&(q$+="diagnostic( off, derivative_uniformity );\n");class X$ extends Nz{constructor(e,t){super(e,t,new O$),this.uniformGroups={},this.builtins={},this.directives={},this.scopedArrays=new Map}needsToWorkingColorSpace(e){return!0===e.isVideoTexture&&e.colorSpace!==vt}_generateTextureSample(e,t,n,r,i=this.shaderStage){return"fragment"===i?r?`textureSample( ${t}, ${t}_sampler, ${n}, ${r} )`:`textureSample( ${t}, ${t}_sampler, ${n} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,n):this.generateTextureLod(e,t,n,r,"0")}_generateVideoSample(e,t,n=this.shaderStage){if("fragment"===n)return`textureSampleBaseClampToEdge( ${e}, ${e}_sampler, vec2<f32>( ${t}.x, 1.0 - ${t}.y ) )`}_generateTextureSampleLevel(e,t,n,r,i,s=this.shaderStage){return"fragment"!==s&&"compute"!==s||!1!==this.isUnfilterable(e)?this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,n,r):this.generateTextureLod(e,t,n,i,r):`textureSampleLevel( ${t}, ${t}_sampler, ${n}, ${r} )`}generateWrapFunction(e){const t=`tsl_coord_${B$[e.wrapS]}S_${B$[e.wrapT]}_${e.isData3DTexture?"3d":"2d"}T`;let n=$$[t];if(void 0===n){const r=[],i=e.isData3DTexture?"vec3f":"vec2f";let s=`fn ${t}( coord : ${i} ) -> ${i} {\n\n\treturn ${i}(\n`;const a=(e,t)=>{e===Z?(r.push(W$.repeatWrapping_float),s+=`\t\ttsl_repeatWrapping_float( coord.${t} )`):e===J?(r.push(W$.clampWrapping_float),s+=`\t\ttsl_clampWrapping_float( coord.${t} )`):e===ee?(r.push(W$.mirrorWrapping_float),s+=`\t\ttsl_mirrorWrapping_float( coord.${t} )`):s+=`\t\tcoord.${t}`};a(e.wrapS,"x"),s+=",\n",a(e.wrapT,"y"),e.isData3DTexture&&(s+=",\n",a(e.wrapR,"z")),s+="\n\t);\n\n}\n",$$[t]=n=new gU(s,r)}return n.build(this),t}generateTextureDimension(e,t,n){const r=this.getDataFromNode(e,this.shaderStage,this.globalCache);void 0===r.dimensionsSnippet&&(r.dimensionsSnippet={});let i=r.dimensionsSnippet[n];if(void 0===r.dimensionsSnippet[n]){let s,a;const{primarySamples:o}=this.renderer.backend.utils.getTextureSampleData(e),l=o>1;a=e.isData3DTexture?"vec3<u32>":"vec2<u32>",s=l||e.isVideoTexture||e.isStorageTexture?t:`${t}${n?`, u32( ${n} )`:""}`,i=new $R(new wC(`textureDimensions( ${s} )`,a)),r.dimensionsSnippet[n]=i,(e.isDataArrayTexture||e.isData3DTexture)&&(r.arrayLayerCount=new $R(new wC(`textureNumLayers(${t})`,"u32"))),e.isTextureCube&&(r.cubeFaceCount=new $R(new wC("6u","u32")))}return i.build(this)}generateFilteredTexture(e,t,n,r="0u"){this._include("biquadraticTexture");return`tsl_biquadraticTexture( ${t}, ${this.generateWrapFunction(e)}( ${n} ), ${this.generateTextureDimension(e,t,r)}, u32( ${r} ) )`}generateTextureLod(e,t,n,r,i="0u"){const s=this.generateWrapFunction(e),a=this.generateTextureDimension(e,t,i),o=e.isData3DTexture?"vec3":"vec2",l=`${o}<u32>(${s}(${n}) * ${o}<f32>(${a}))`;return this.generateTextureLoad(e,t,l,r,i)}generateTextureLoad(e,t,n,r,i="0u"){return!0===e.isVideoTexture||!0===e.isStorageTexture?`textureLoad( ${t}, ${n} )`:r?`textureLoad( ${t}, ${n}, ${r}, u32( ${i} ) )`:`textureLoad( ${t}, ${n}, u32( ${i} ) )`}generateTextureStore(e,t,n,r){return`textureStore( ${t}, ${n}, ${r} )`}isSampleCompare(e){return!0===e.isDepthTexture&&null!==e.compareFunction}isUnfilterable(e){return"float"!==this.getComponentTypeFromTexture(e)||!this.isAvailable("float32Filterable")&&!0===e.isDataTexture&&e.type===fe||!1===this.isSampleCompare(e)&&e.minFilter===te&&e.magFilter===te||this.renderer.backend.utils.getTextureSampleData(e).primarySamples>1}generateTexture(e,t,n,r,i=this.shaderStage){let s=null;return s=!0===e.isVideoTexture?this._generateVideoSample(t,n,i):this.isUnfilterable(e)?this.generateTextureLod(e,t,n,r,"0",i):this._generateTextureSample(e,t,n,r,i),s}generateTextureGrad(e,t,n,r,i,s=this.shaderStage){if("fragment"===s)return`textureSampleGrad( ${t}, ${t}_sampler, ${n},  ${r[0]}, ${r[1]} )`}generateTextureCompare(e,t,n,r,i,s=this.shaderStage){if("fragment"===s)return`textureSampleCompare( ${t}, ${t}_sampler, ${n}, ${r} )`}generateTextureLevel(e,t,n,r,i,s=this.shaderStage){let a=null;return a=!0===e.isVideoTexture?this._generateVideoSample(t,n,s):this._generateTextureSampleLevel(e,t,n,r,i,s),a}generateTextureBias(e,t,n,r,i,s=this.shaderStage){if("fragment"===s)return`textureSampleBias( ${t}, ${t}_sampler, ${n}, ${r} )`}getPropertyName(e,t=this.shaderStage){if(!0===e.isNodeVarying&&!0===e.needsInterpolation){if("vertex"===t)return`varyings.${e.name}`}else if(!0===e.isNodeUniform){const t=e.name,n=e.type;return"texture"===n||"cubeTexture"===n||"storageTexture"===n||"texture3D"===n?t:"buffer"===n||"storageBuffer"===n||"indirectStorageBuffer"===n?`NodeBuffer_${e.id}.${t}`:e.groupNode.name+"."+t}return super.getPropertyName(e)}getOutputStructName(){return"output"}_getUniformGroupCount(e){return Object.keys(this.uniforms[e]).length}getFunctionOperator(e){const t=G$[e];return void 0!==t?(this._include(t),t):null}getNodeAccess(e,t){return"compute"!==t?HE.READ_ONLY:e.access}getStorageAccess(e,t){return U$[this.getNodeAccess(e,t)]}getUniformFromNode(e,t,n,r=null){const i=super.getUniformFromNode(e,t,n,r),s=this.getDataFromNode(e,n,this.globalCache);if(void 0===s.uniformGPU){let r;const a=e.groupNode,o=a.name,l=this.getBindGroupArray(o,n);if("texture"===t||"cubeTexture"===t||"storageTexture"===t||"texture3D"===t){let s=null;const o=this.getNodeAccess(e,n);if("texture"===t||"storageTexture"===t?s=new AG(i.name,i.node,a,o):"cubeTexture"===t?s=new wG(i.name,i.node,a,o):"texture3D"===t&&(s=new MG(i.name,i.node,a,o)),s.store=!0===e.isStorageTextureNode,s.setVisibility(V$[n]),"fragment"!==n&&"compute"!==n||!1!==this.isUnfilterable(e.value)||!1!==s.store)l.push(s),r=[s];else{const e=new T$(`${i.name}_sampler`,i.node,a);e.setVisibility(V$[n]),l.push(e,s),r=[e,s]}}else if("buffer"===t||"storageBuffer"===t||"indirectStorageBuffer"===t){const i=new("buffer"===t?bG:w$)(e,a);i.setVisibility(V$[n]),l.push(i),r=i}else{const e=this.uniformGroups[n]||(this.uniformGroups[n]={});let s=e[o];void 0===s&&(s=new SG(o,a),s.setVisibility(V$[n]),e[o]=s,l.push(s)),r=this.getNodeUniform(i,t),s.addUniform(r)}s.uniformGPU=r}return i}getBuiltin(e,t,n,r=this.shaderStage){const i=this.builtins[r]||(this.builtins[r]=new Map);return!1===i.has(e)&&i.set(e,{name:e,property:t,type:n}),t}hasBuiltin(e,t=this.shaderStage){return void 0!==this.builtins[t]&&this.builtins[t].has(e)}getVertexIndex(){return"vertex"===this.shaderStage?this.getBuiltin("vertex_index","vertexIndex","u32","attribute"):"vertexIndex"}buildFunctionCode(e){const t=e.layout,n=this.flowShaderNode(e),r=[];for(const e of t.inputs)r.push(e.name+" : "+this.getType(e.type));let i=`fn ${t.name}( ${r.join(", ")} ) -> ${this.getType(t.type)} {\n${n.vars}\n${n.code}\n`;return n.result&&(i+=`\treturn ${n.result};\n`),i+="\n}\n",i}getInstanceIndex(){return"vertex"===this.shaderStage?this.getBuiltin("instance_index","instanceIndex","u32","attribute"):"instanceIndex"}getInvocationLocalIndex(){return this.getBuiltin("local_invocation_index","invocationLocalIndex","u32","attribute")}getSubgroupSize(){return this.enableSubGroups(),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute")}getInvocationSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_invocation_id","invocationSubgroupIndex","u32","attribute")}getSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_id","subgroupIndex","u32","attribute")}getDrawIndex(){return null}getFrontFacing(){return this.getBuiltin("front_facing","isFront","bool")}getFragCoord(){return this.getBuiltin("position","fragCoord","vec4<f32>")+".xy"}getFragDepth(){return"output."+this.getBuiltin("frag_depth","depth","f32","output")}getClipDistance(){return"varyings.hw_clip_distances"}isFlipY(){return!1}enableDirective(e,t=this.shaderStage){(this.directives[t]||(this.directives[t]=new Set)).add(e)}getDirectives(e){const t=[],n=this.directives[e];if(void 0!==n)for(const e of n)t.push(`enable ${e};`);return t.join("\n")}enableSubGroups(){this.enableDirective("subgroups")}enableSubgroupsF16(){this.enableDirective("subgroups-f16")}enableClipDistances(){this.enableDirective("clip_distances")}enableShaderF16(){this.enableDirective("f16")}enableDualSourceBlending(){this.enableDirective("dual_source_blending")}enableHardwareClipping(e){this.enableClipDistances(),this.getBuiltin("clip_distances","hw_clip_distances",`array<f32, ${e} >`,"vertex")}getBuiltins(e){const t=[],n=this.builtins[e];if(void 0!==n)for(const{name:e,property:r,type:i}of n.values())t.push(`@builtin( ${e} ) ${r} : ${i}`);return t.join(",\n\t")}getScopedArray(e,t,n,r){return!1===this.scopedArrays.has(e)&&this.scopedArrays.set(e,{name:e,scope:t,bufferType:n,bufferCount:r}),e}getScopedArrays(e){if("compute"!==e)return;const t=[];for(const{name:e,scope:n,bufferType:r,bufferCount:i}of this.scopedArrays.values()){const s=this.getType(r);t.push(`var<${n}> ${e}: array< ${s}, ${i} >;`)}return t.join("\n")}getAttributes(e){const t=[];if("compute"===e&&(this.getBuiltin("global_invocation_id","id","vec3<u32>","attribute"),this.getBuiltin("workgroup_id","workgroupId","vec3<u32>","attribute"),this.getBuiltin("local_invocation_id","localId","vec3<u32>","attribute"),this.getBuiltin("num_workgroups","numWorkgroups","vec3<u32>","attribute"),this.renderer.hasFeature("subgroups")&&(this.enableDirective("subgroups",e),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute"))),"vertex"===e||"compute"===e){const e=this.getBuiltins("attribute");e&&t.push(e);const n=this.getAttributesArray();for(let e=0,r=n.length;e<r;e++){const r=n[e],i=r.name,s=this.getType(r.type);t.push(`@location( ${e} ) ${i} : ${s}`)}}return t.join(",\n\t")}getStructMembers(e){const t=[],n=e.getMemberTypes();for(let e=0;e<n.length;e++){const r=n[e];t.push(`\t@location( ${e} ) m${e} : ${r}<f32>`)}const r=this.getBuiltins("output");return r&&t.push("\t"+r),t.join(",\n")}getStructs(e){const t=[],n=this.structs[e];for(let e=0,r=n.length;e<r;e++){const r=n[e],i=r.name;let s=`struct ${i} {\n`;s+=this.getStructMembers(r),s+="\n}",t.push(s),t.push(`\nvar<private> output : ${i};\n\n`)}return t.join("\n\n")}getVar(e,t){return`var ${t} : ${this.getType(e)}`}getVars(e){const t=[],n=this.vars[e];if(void 0!==n)for(const e of n)t.push(`\t${this.getVar(e.type,e.name)};`);return`\n${t.join("\n")}\n`}getVaryings(e){const t=[];if("vertex"===e&&this.getBuiltin("position","Vertex","vec4<f32>","vertex"),"vertex"===e||"fragment"===e){const n=this.varyings,r=this.vars[e];for(let i=0;i<n.length;i++){const s=n[i];if(s.needsInterpolation){let e=`@location( ${i} )`;/^(int|uint|ivec|uvec)/.test(s.type)&&(e+=" @interpolate( flat )"),t.push(`${e} ${s.name} : ${this.getType(s.type)}`)}else"vertex"===e&&!1===r.includes(s)&&r.push(s)}}const n=this.getBuiltins(e);n&&t.push(n);const r=t.join(",\n\t");return"vertex"===e?this._getWGSLStruct("VaryingsStruct","\t"+r):r}getUniforms(e){const t=this.uniforms[e],n=[],r=[],i=[],s={};for(const i of t){const t=i.groupNode.name,a=this.bindingsIndexes[t];if("texture"===i.type||"cubeTexture"===i.type||"storageTexture"===i.type||"texture3D"===i.type){const t=i.node.value;let r;"fragment"!==e&&"compute"!==e||!1!==this.isUnfilterable(t)||!0===i.node.isStorageTextureNode||(this.isSampleCompare(t)?n.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${i.name}_sampler : sampler_comparison;`):n.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${i.name}_sampler : sampler;`));let s="";const{primarySamples:o}=this.renderer.backend.utils.getTextureSampleData(t);if(o>1&&(s="_multisampled"),!0===t.isCubeTexture)r="texture_cube<f32>";else if(!0===t.isDataArrayTexture||!0===t.isCompressedArrayTexture)r="texture_2d_array<f32>";else if(!0===t.isDepthTexture)r=`texture_depth${s}_2d`;else if(!0===t.isVideoTexture)r="texture_external";else if(!0===t.isData3DTexture)r="texture_3d<f32>";else if(!0===i.node.isStorageTextureNode){r=`texture_storage_2d<${L$(t)}, ${this.getStorageAccess(i.node,e)}>`}else{r=`texture${s}_2d<${this.getComponentTypeFromTexture(t).charAt(0)}32>`}n.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${i.name} : ${r};`)}else if("buffer"===i.type||"storageBuffer"===i.type||"indirectStorageBuffer"===i.type){const t=i.node,n=this.getType(t.bufferType),s=t.bufferCount,o=s>0&&"buffer"===i.type?", "+s:"",l=t.isAtomic?`atomic<${n}>`:`${n}`,u=`\t${i.name} : array< ${l}${o} >\n`,c=t.isStorageBufferNode?`storage, ${this.getStorageAccess(t,e)}`:"uniform";r.push(this._getWGSLStructBinding("NodeBuffer_"+t.id,u,c,a.binding++,a.group))}else{const e=this.getType(this.getVectorType(i.type)),t=i.groupNode.name;(s[t]||(s[t]={index:a.binding++,id:a.group,snippets:[]})).snippets.push(`\t${i.name} : ${e}`)}}for(const e in s){const t=s[e];i.push(this._getWGSLStructBinding(e,t.snippets.join(",\n"),"uniform",t.index,t.id))}let a=n.join("\n");return a+=r.join("\n"),a+=i.join("\n"),a}buildCode(){const e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){const n=e[t];n.uniforms=this.getUniforms(t),n.attributes=this.getAttributes(t),n.varyings=this.getVaryings(t),n.structs=this.getStructs(t),n.vars=this.getVars(t),n.codes=this.getCodes(t),n.directives=this.getDirectives(t),n.scopedArrays=this.getScopedArrays(t);let r="// code\n\n";r+=this.flowCode[t];const i=this.flowNodes[t],s=i[i.length-1],a=s.outputNode,o=void 0!==a&&!0===a.isOutputStructNode;for(const e of i){const i=this.getFlowData(e),l=e.name;if(l&&(r.length>0&&(r+="\n"),r+=`\t// flow -> ${l}\n\t`),r+=`${i.code}\n\t`,e===s&&"compute"!==t)if(r+="// result\n\n\t","vertex"===t)r+=`varyings.Vertex = ${i.result};`;else if("fragment"===t)if(o)n.returnType=a.nodeType,r+=`return ${i.result};`;else{let e="\t@location(0) color: vec4<f32>";const t=this.getBuiltins("output");t&&(e+=",\n\t"+t),n.returnType="OutputStruct",n.structs+=this._getWGSLStruct("OutputStruct",e),n.structs+="\nvar<private> output : OutputStruct;\n\n",r+=`output.color = ${i.result};\n\n\treturn output;`}}n.flow=r}null!==this.material?(this.vertexShader=this._getWGSLVertexCode(e.vertex),this.fragmentShader=this._getWGSLFragmentCode(e.fragment)):this.computeShader=this._getWGSLComputeCode(e.compute,(this.object.workgroupSize||[64]).join(", "))}getMethod(e,t=null){let n;return null!==t&&(n=this._getWGSLMethod(e+"_"+t)),void 0===n&&(n=this._getWGSLMethod(e)),n||e}getType(e){return H$[e]||e}isAvailable(e){let t=z$[e];return void 0===t&&("float32Filterable"===e?t=this.renderer.hasFeature("float32-filterable"):"clipDistance"===e&&(t=this.renderer.hasFeature("clip-distances")),z$[e]=t),t}_getWGSLMethod(e){return void 0!==W$[e]&&this._include(e),j$[e]}_include(e){const t=W$[e];return t.build(this),null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(t),t}_getWGSLVertexCode(e){return`${this.getSignature()}\n// directives\n${e.directives}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\nvar<private> varyings : VaryingsStruct;\n\n// codes\n${e.codes}\n\n@vertex\nfn main( ${e.attributes} ) -> VaryingsStruct {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n\treturn varyings;\n\n}\n`}_getWGSLFragmentCode(e){return`${this.getSignature()}\n// global\n${q$}\n\n// uniforms\n${e.uniforms}\n\n// structs\n${e.structs}\n\n// codes\n${e.codes}\n\n@fragment\nfn main( ${e.varyings} ) -> ${e.returnType} {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}_getWGSLComputeCode(e,t){return`${this.getSignature()}\n// directives\n${e.directives}\n\n// system\nvar<private> instanceIndex : u32;\n\n// locals\n${e.scopedArrays}\n\n// uniforms\n${e.uniforms}\n\n// codes\n${e.codes}\n\n@compute @workgroup_size( ${t} )\nfn main( ${e.attributes} ) {\n\n\t// system\n\tinstanceIndex = id.x + id.y * numWorkgroups.x * u32(${t}) + id.z * numWorkgroups.x * numWorkgroups.y * u32(${t});\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}_getWGSLStruct(e,t){return`\nstruct ${e} {\n${t}\n};`}_getWGSLStructBinding(e,t,n,r=0,i=0){const s=e+"Struct";return`${this._getWGSLStruct(s,t)}\n@binding( ${r} ) @group( ${i} )\nvar<${n}> ${e} : ${s};`}}class Y${constructor(e){this.backend=e}getCurrentDepthStencilFormat(e){let t;return null!==e.depthTexture?t=this.getTextureFormatGPU(e.depthTexture):e.depth&&e.stencil?t=SH.Depth24PlusStencil8:e.depth&&(t=SH.Depth24Plus),t}getTextureFormatGPU(e){return this.backend.get(e).format}getTextureSampleData(e){let t;if(e.isFramebufferTexture)t=1;else if(e.isDepthTexture&&!e.renderTarget){const e=this.backend.renderer,n=e.getRenderTarget();t=n?n.samples:e.samples}else e.renderTarget&&(t=e.renderTarget.samples);t=t||1;const n=t>1&&null!==e.renderTarget&&!0!==e.isDepthTexture&&!0!==e.isFramebufferTexture;return{samples:t,primarySamples:n?1:t,isMSAA:n}}getCurrentColorFormat(e){let t;return t=null!==e.textures?this.getTextureFormatGPU(e.textures[0]):this.getPreferredCanvasFormat(),t}getCurrentColorSpace(e){return null!==e.textures?e.textures[0].colorSpace:this.backend.renderer.outputColorSpace}getPrimitiveTopology(e,t){return e.isPoints?eH:e.isLineSegments||e.isMesh&&!0===t.wireframe?tH:e.isLine?nH:e.isMesh?rH:void 0}getSampleCount(e){let t=1;return e>1&&(t=Math.pow(2,Math.floor(Math.log2(e))),2===t&&(t=4)),t}getSampleCountRenderContext(e){return null!==e.textures?this.getSampleCount(e.sampleCount):this.getSampleCount(this.backend.renderer.samples)}getPreferredCanvasFormat(){return navigator.userAgent.includes("Quest")?SH.BGRA8Unorm:navigator.gpu.getPreferredCanvasFormat()}}const K$=new Map([[Int8Array,["sint8","snorm8"]],[Uint8Array,["uint8","unorm8"]],[Int16Array,["sint16","snorm16"]],[Uint16Array,["uint16","unorm16"]],[Int32Array,["sint32","snorm32"]],[Uint32Array,["uint32","unorm32"]],[Float32Array,["float32"]]]),Q$=new Map([[li,["float16"]]]),Z$=new Map([[Int32Array,"sint32"],[Int16Array,"sint32"],[Uint32Array,"uint32"],[Uint16Array,"uint32"],[Float32Array,"float32"]]);class J${constructor(e){this.backend=e}createAttribute(e,t){const n=this._getBufferAttribute(e),r=this.backend,i=r.get(n);let s=i.buffer;if(void 0===s){const a=r.device;let o=n.array;if(!1===e.normalized&&(o.constructor===Int16Array||o.constructor===Uint16Array)){const e=new Uint32Array(o.length);for(let t=0;t<o.length;t++)e[t]=o[t];o=e}if(n.array=o,(n.isStorageBufferAttribute||n.isStorageInstancedBufferAttribute)&&3===n.itemSize){o=new o.constructor(4*n.count);for(let e=0;e<n.count;e++)o.set(n.array.subarray(3*e,3*e+3),4*e);n.itemSize=4,n.array=o}const l=o.byteLength+(4-o.byteLength%4)%4;s=a.createBuffer({label:n.name,size:l,usage:t,mappedAtCreation:!0}),new o.constructor(s.getMappedRange()).set(o),s.unmap(),i.buffer=s}}updateAttribute(e){const t=this._getBufferAttribute(e),n=this.backend,r=n.device,i=n.get(t).buffer,s=t.array,a=this._isTypedArray(s),o=t.updateRanges;if(0===o.length)r.queue.writeBuffer(i,0,s,0);else{const e=a?1:s.BYTES_PER_ELEMENT;for(let t=0,n=o.length;t<n;t++){const n=o[t],a=n.start*e,l=n.count*e;r.queue.writeBuffer(i,0,s,a,l)}t.clearUpdateRanges()}}createShaderVertexBuffers(e){const t=e.getAttributes(),n=new Map;for(let e=0;e<t.length;e++){const r=t[e],i=r.array.BYTES_PER_ELEMENT,s=this._getBufferAttribute(r);let a=n.get(s);if(void 0===a){let e,t;!0===r.isInterleavedBufferAttribute?(e=r.data.stride*i,t=r.data.isInstancedInterleavedBuffer?_$:b$):(e=r.itemSize*i,t=r.isInstancedBufferAttribute?_$:b$),!1!==r.normalized||r.array.constructor!==Int16Array&&r.array.constructor!==Uint16Array||(e=4),a={arrayStride:e,attributes:[],stepMode:t},n.set(s,a)}const o=this._getVertexFormat(r),l=!0===r.isInterleavedBufferAttribute?r.offset*i:0;a.attributes.push({shaderLocation:e,offset:l,format:o})}return Array.from(n.values())}destroyAttribute(e){const t=this.backend;t.get(this._getBufferAttribute(e)).buffer.destroy(),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,n=t.device,r=t.get(this._getBufferAttribute(e)).buffer,i=r.size,s=n.createBuffer({label:`${e.name}_readback`,size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),a=n.createCommandEncoder({label:`readback_encoder_${e.name}`});a.copyBufferToBuffer(r,0,s,0,i);const o=a.finish();n.queue.submit([o]),await s.mapAsync(GPUMapMode.READ);const l=s.getMappedRange(),u=new e.array.constructor(l.slice(0));return s.unmap(),u.buffer}_getVertexFormat(e){const{itemSize:t,normalized:n}=e,r=e.array.constructor,i=e.constructor;let s;if(1===t)s=Z$.get(r);else{const e=(Q$.get(i)||K$.get(r))[n?1:0];if(e){const n=r.BYTES_PER_ELEMENT*t,i=4*Math.floor((n+3)/4)/r.BYTES_PER_ELEMENT;if(i%1)throw new Error("THREE.WebGPUAttributeUtils: Bad vertex format item size.");s=`${e}x${i}`}}return s}_isTypedArray(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}class eW{constructor(e){this.backend=e,this.bindGroupLayoutCache=new WeakMap}createBindingsLayout(e){const t=this.backend,n=t.device,r=[];let i=0;for(const n of e.bindings){const e={binding:i++,visibility:n.visibility};if(n.isUniformBuffer||n.isStorageBuffer){const t={};n.isStorageBuffer&&(4&n.visibility&&(n.access===HE.READ_WRITE||n.access===HE.WRITE_ONLY)?t.type=n$:t.type=r$),e.buffer=t}else if(n.isSampler){const t={};n.texture.isDepthTexture&&null!==n.texture.compareFunction&&(t.type="comparison"),e.sampler=t}else if(n.isSampledTexture&&n.texture.isVideoTexture)e.externalTexture={};else if(n.isSampledTexture&&n.store){const t={};t.format=this.backend.get(n.texture).texture.format;const r=n.access;t.access=r===HE.READ_WRITE?a$:r===HE.WRITE_ONLY?i$:s$,e.storageTexture=t}else if(n.isSampledTexture){const r={},{primarySamples:i}=t.utils.getTextureSampleData(n.texture);if(i>1&&(r.multisampled=!0,n.texture.isDepthTexture||(r.sampleType=l$)),n.texture.isDepthTexture)r.sampleType=u$;else if(n.texture.isDataTexture||n.texture.isDataArrayTexture||n.texture.isData3DTexture){const e=n.texture.type;e===de?r.sampleType=c$:e===he?r.sampleType=d$:e===fe&&(this.backend.hasFeature("float32-filterable")?r.sampleType=o$:r.sampleType=l$)}n.isSampledCubeTexture?r.viewDimension=g$:n.texture.isDataArrayTexture||n.texture.isCompressedArrayTexture?r.viewDimension=m$:n.isSampledTexture3D&&(r.viewDimension=v$),e.texture=r}r.push(e)}return n.createBindGroupLayout({entries:r})}createBindings(e,t,n,r=0){const{backend:i,bindGroupLayoutCache:s}=this,a=i.get(e);let o,l=s.get(e.bindingsReference);void 0===l&&(l=this.createBindingsLayout(e),s.set(e.bindingsReference,l)),n>0&&(void 0===a.groups&&(a.groups=[],a.versions=[]),a.versions[n]===r&&(o=a.groups[n])),void 0===o&&(o=this.createBindGroup(e,l),n>0&&(a.groups[n]=o,a.versions[n]=r)),a.group=o,a.layout=l}updateBinding(e){const t=this.backend,n=t.device,r=e.buffer,i=t.get(e).buffer;n.queue.writeBuffer(i,0,r,0)}createBindGroup(e,t){const n=this.backend,r=n.device;let i=0;const s=[];for(const t of e.bindings){if(t.isUniformBuffer){const e=n.get(t);if(void 0===e.buffer){const n=t.byteLength,i=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,s=r.createBuffer({label:"bindingBuffer_"+t.name,size:n,usage:i});e.buffer=s}s.push({binding:i,resource:{buffer:e.buffer}})}else if(t.isStorageBuffer){const e=n.get(t);if(void 0===e.buffer){const r=t.attribute;e.buffer=n.get(r).buffer}s.push({binding:i,resource:{buffer:e.buffer}})}else if(t.isSampler){const e=n.get(t.texture);s.push({binding:i,resource:e.sampler})}else if(t.isSampledTexture){const e=n.get(t.texture);let a;if(void 0!==e.externalTexture)a=r.importExternalTexture({source:e.externalTexture});else{const n=t.store?1:e.texture.mipLevelCount,r=`view-${e.texture.width}-${e.texture.height}-${n}`;if(a=e[r],void 0===a){const i=y$;let s;s=t.isSampledCubeTexture?g$:t.isSampledTexture3D?v$:t.texture.isDataArrayTexture||t.texture.isCompressedArrayTexture?m$:p$,a=e[r]=e.texture.createView({aspect:i,dimension:s,mipLevelCount:n})}}s.push({binding:i,resource:a})}i++}return r.createBindGroup({label:"bindGroup_"+e.name,layout:t,entries:s})}}class tW{constructor(e){this.backend=e}_getSampleCount(e){return this.backend.utils.getSampleCountRenderContext(e)}createRenderPipeline(e,t){const{object:n,material:r,geometry:i,pipeline:s}=e,{vertexProgram:a,fragmentProgram:o}=s,l=this.backend,u=l.device,c=l.utils,d=l.get(s),h=[];for(const t of e.getBindings()){const e=l.get(t);h.push(e.layout)}const f=l.attributeUtils.createShaderVertexBuffers(e);let p;!0===r.transparent&&0!==r.blending&&(p=this._getBlending(r));let m={};!0===r.stencilWrite&&(m={compare:this._getStencilCompare(r),failOp:this._getStencilOperation(r.stencilFail),depthFailOp:this._getStencilOperation(r.stencilZFail),passOp:this._getStencilOperation(r.stencilZPass)});const g=this._getColorWriteMask(r),v=[];if(null!==e.context.textures){const t=e.context.textures;for(let e=0;e<t.length;e++){const n=c.getTextureFormatGPU(t[e]);v.push({format:n,blend:p,writeMask:g})}}else{const t=c.getCurrentColorFormat(e.context);v.push({format:t,blend:p,writeMask:g})}const y=l.get(a).module,b=l.get(o).module,_=this._getPrimitiveState(n,i,r),x=this._getDepthCompare(r),S=c.getCurrentDepthStencilFormat(e.context),T=this._getSampleCount(e.context),E={label:`renderPipeline_${r.name||r.type}_${r.id}`,vertex:Object.assign({},y,{buffers:f}),fragment:Object.assign({},b,{targets:v}),primitive:_,multisample:{count:T,alphaToCoverageEnabled:r.alphaToCoverage&&T>1},layout:u.createPipelineLayout({bindGroupLayouts:h})},A={},w=e.context.depth,M=e.context.stencil;if(!0!==w&&!0!==M||(!0===w&&(A.format=S,A.depthWriteEnabled=r.depthWrite,A.depthCompare=x),!0===M&&(A.stencilFront=m,A.stencilBack={},A.stencilReadMask=r.stencilFuncMask,A.stencilWriteMask=r.stencilWriteMask),E.depthStencil=A),null===t)d.pipeline=u.createRenderPipeline(E);else{const e=new Promise(e=>{u.createRenderPipelineAsync(E).then(t=>{d.pipeline=t,e()})});t.push(e)}}createBundleEncoder(e){const t=this.backend,{utils:n,device:r}=t,i=n.getCurrentDepthStencilFormat(e),s={label:"renderBundleEncoder",colorFormats:[n.getCurrentColorFormat(e)],depthStencilFormat:i,sampleCount:this._getSampleCount(e)};return r.createRenderBundleEncoder(s)}createComputePipeline(e,t){const n=this.backend,r=n.device,i=n.get(e.computeProgram).module,s=n.get(e),a=[];for(const e of t){const t=n.get(e);a.push(t.layout)}s.pipeline=r.createComputePipeline({compute:i,layout:r.createPipelineLayout({bindGroupLayouts:a})})}_getBlending(e){let t,n;const r=e.blending,i=e.blendSrc,s=e.blendDst,a=e.blendEquation;if(5===r){const r=null!==e.blendSrcAlpha?e.blendSrcAlpha:i,o=null!==e.blendDstAlpha?e.blendDstAlpha:s,l=null!==e.blendEquationAlpha?e.blendEquationAlpha:a;t={srcFactor:this._getBlendFactor(i),dstFactor:this._getBlendFactor(s),operation:this._getBlendOperation(a)},n={srcFactor:this._getBlendFactor(r),dstFactor:this._getBlendFactor(o),operation:this._getBlendOperation(l)}}else{const i=(e,r,i,s)=>{t={srcFactor:e,dstFactor:r,operation:zH},n={srcFactor:i,dstFactor:s,operation:zH}};if(e.premultipliedAlpha)switch(r){case 1:i(CH,NH,CH,NH);break;case 2:i(CH,CH,CH,CH);break;case 3:i(RH,LH,RH,CH);break;case 4:i(RH,IH,RH,PH)}else switch(r){case 1:i(PH,NH,CH,NH);break;case 2:i(PH,CH,PH,CH);break;case 3:i(RH,LH,RH,CH);break;case 4:i(RH,IH,RH,IH)}}if(void 0!==t&&void 0!==n)return{color:t,alpha:n}}_getBlendFactor(e){let t;switch(e){case x:t=RH;break;case S:t=CH;break;case T:t=IH;break;case E:t=LH;break;case A:t=PH;break;case w:t=NH;break;case C:t=DH;break;case I:t=kH;break;case M:t=OH;break;case R:t=FH;break;case L:t=UH;break;case 211:t=BH;break;case 212:t=VH}return t}_getStencilCompare(e){let t;switch(e.stencilFunc){case 512:t=sH;break;case Tt:t=hH;break;case 513:t=aH;break;case 515:t=lH;break;case 514:t=oH;break;case 518:t=dH;break;case 516:t=uH;break;case 517:t=cH}return t}_getStencilOperation(e){let t;switch(e){case St:t=XH;break;case 0:t=YH;break;case 7681:t=KH;break;case 5386:t=QH;break;case 7682:t=ZH;break;case 7683:t=JH;break;case 34055:t=e$;break;case 34056:t=t$}return t}_getBlendOperation(e){let t;switch(e){case y:t=zH;break;case b:t=GH;break;case _:t=HH;break;case 103:t=$H;break;case 104:t=WH}return t}_getPrimitiveState(e,t,n){const r={},i=this.backend.utils;switch(r.topology=i.getPrimitiveTopology(e,n),null!==t.index&&!0===e.isLine&&!0!==e.isLineSegments&&(r.stripIndexFormat=t.index.array instanceof Uint16Array?_H:xH),n.side){case 0:r.frontFace=gH,r.cullMode=bH;break;case 1:r.frontFace=gH,r.cullMode=yH;break;case 2:r.frontFace=gH,r.cullMode=vH}return r}_getColorWriteMask(e){return!0===e.colorWrite?qH:jH}_getDepthCompare(e){let t;if(!1===e.depthTest)t=hH;else{switch(e.depthFunc){case 0:t=sH;break;case 1:t=hH;break;case 2:t=aH;break;case 3:t=lH;break;case 4:t=oH;break;case 5:t=dH;break;case 6:t=uH;break;case 7:t=cH}}return t}}class nW extends kG{constructor(e={}){super(e),this.isWebGPUBackend=!0,this.parameters.alpha=void 0===e.alpha||e.alpha,this.parameters.requiredLimits=void 0===e.requiredLimits?{}:e.requiredLimits,this.trackTimestamp=!0===e.trackTimestamp,this.device=null,this.context=null,this.colorBuffer=null,this.defaultRenderPassdescriptor=null,this.utils=new Y$(this),this.attributeUtils=new J$(this),this.bindingUtils=new eW(this),this.pipelineUtils=new tW(this),this.textureUtils=new I$(this),this.occludedResolveCache=new Map}async init(e){await super.init(e);const t=this.parameters;let n;if(void 0===t.device){const e={powerPreference:t.powerPreference},r="undefined"!=typeof navigator?await navigator.gpu.requestAdapter(e):null;if(null===r)throw new Error("WebGPUBackend: Unable to create WebGPU adapter.");const i=Object.values(x$),s=[];for(const e of i)r.features.has(e)&&s.push(e);const a={requiredFeatures:s,requiredLimits:t.requiredLimits};n=await r.requestDevice(a)}else n=t.device;n.lost.then(t=>{const n={api:"WebGPU",message:t.message||"Unknown reason",reason:t.reason||null,originalEvent:t};e.onDeviceLost(n)});const r=void 0!==t.context?t.context:e.domElement.getContext("webgpu");this.device=n,this.context=r;const i=t.alpha?"premultiplied":"opaque";this.trackTimestamp=this.trackTimestamp&&this.hasFeature(x$.TimestampQuery),this.context.configure({device:this.device,format:this.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:i}),this.updateSize()}get coordinateSystem(){return Ot}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}getContext(){return this.context}_getDefaultRenderPassDescriptor(){let e=this.defaultRenderPassdescriptor;if(null===e){const t=this.renderer;e={colorAttachments:[{view:null}]},!0!==this.renderer.depth&&!0!==this.renderer.stencil||(e.depthStencilAttachment={view:this.textureUtils.getDepthBuffer(t.depth,t.stencil).createView()});const n=e.colorAttachments[0];this.renderer.samples>0?n.view=this.colorBuffer.createView():n.resolveTarget=void 0,this.defaultRenderPassdescriptor=e}const t=e.colorAttachments[0];return this.renderer.samples>0?t.resolveTarget=this.context.getCurrentTexture().createView():t.view=this.context.getCurrentTexture().createView(),e}_getRenderPassDescriptor(e,t={}){const n=e.renderTarget,r=this.get(n);let i=r.descriptors;if(void 0===i||r.width!==n.width||r.height!==n.height||r.dimensions!==n.dimensions||r.activeMipmapLevel!==n.activeMipmapLevel||r.activeCubeFace!==e.activeCubeFace||r.samples!==n.samples||r.loadOp!==t.loadOp){i={},r.descriptors=i;const e=()=>{n.removeEventListener("dispose",e),this.delete(n)};n.addEventListener("dispose",e)}const s=e.getCacheKey();let a=i[s];if(void 0===a){const o=e.textures,l=[];let u;for(let r=0;r<o.length;r++){const i=this.get(o[r]),s={label:`colorAttachment_${r}`,baseMipLevel:e.activeMipmapLevel,mipLevelCount:1,baseArrayLayer:e.activeCubeFace,arrayLayerCount:1,dimension:p$};n.isRenderTarget3D?(u=e.activeCubeFace,s.baseArrayLayer=0,s.dimension=v$,s.depthOrArrayLayers=o[r].image.depth):n.isRenderTargetArray&&(s.dimension=m$,s.depthOrArrayLayers=o[r].image.depth);const a=i.texture.createView(s);let c,d;void 0!==i.msaaTexture?(c=i.msaaTexture.createView(),d=a):(c=a,d=void 0),l.push({view:c,depthSlice:u,resolveTarget:d,loadOp:pH,storeOp:fH,...t})}if(a={colorAttachments:l},e.depth){const t={view:this.get(e.depthTexture).texture.createView()};a.depthStencilAttachment=t}i[s]=a,r.width=n.width,r.height=n.height,r.samples=n.samples,r.activeMipmapLevel=e.activeMipmapLevel,r.activeCubeFace=e.activeCubeFace,r.dimensions=n.dimensions,r.depthSlice=u,r.loadOp=l[0].loadOp}return a}beginRender(e){const t=this.get(e),n=this.device,r=e.occlusionQueryCount;let i,s;r>0&&(t.currentOcclusionQuerySet&&t.currentOcclusionQuerySet.destroy(),t.currentOcclusionQueryBuffer&&t.currentOcclusionQueryBuffer.destroy(),t.currentOcclusionQuerySet=t.occlusionQuerySet,t.currentOcclusionQueryBuffer=t.occlusionQueryBuffer,t.currentOcclusionQueryObjects=t.occlusionQueryObjects,i=n.createQuerySet({type:"occlusion",count:r,label:`occlusionQuerySet_${e.id}`}),t.occlusionQuerySet=i,t.occlusionQueryIndex=0,t.occlusionQueryObjects=new Array(r),t.lastOcclusionObject=null),s=null===e.textures?this._getDefaultRenderPassDescriptor():this._getRenderPassDescriptor(e,{loadOp:pH}),this.initTimestampQuery(e,s),s.occlusionQuerySet=i;const a=s.depthStencilAttachment;if(null!==e.textures){const t=s.colorAttachments;for(let n=0;n<t.length;n++){const r=t[n];e.clearColor?(r.clearValue=0===n?e.clearColorValue:{r:0,g:0,b:0,a:1},r.loadOp=mH,r.storeOp=fH):(r.loadOp=pH,r.storeOp=fH)}}else{const t=s.colorAttachments[0];e.clearColor?(t.clearValue=e.clearColorValue,t.loadOp=mH,t.storeOp=fH):(t.loadOp=pH,t.storeOp=fH)}e.depth&&(e.clearDepth?(a.depthClearValue=e.clearDepthValue,a.depthLoadOp=mH,a.depthStoreOp=fH):(a.depthLoadOp=pH,a.depthStoreOp=fH)),e.stencil&&(e.clearStencil?(a.stencilClearValue=e.clearStencilValue,a.stencilLoadOp=mH,a.stencilStoreOp=fH):(a.stencilLoadOp=pH,a.stencilStoreOp=fH));const o=n.createCommandEncoder({label:"renderContext_"+e.id}),l=o.beginRenderPass(s);if(t.descriptor=s,t.encoder=o,t.currentPass=l,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.renderBundles=[],e.viewport&&this.updateViewport(e),e.scissor){const{x:t,y:n,width:r,height:i}=e.scissorValue;l.setScissorRect(t,n,r,i)}}finishRender(e){const t=this.get(e),n=e.occlusionQueryCount;if(t.renderBundles.length>0&&t.currentPass.executeBundles(t.renderBundles),n>t.occlusionQueryIndex&&t.currentPass.endOcclusionQuery(),t.currentPass.end(),n>0){const r=8*n;let i=this.occludedResolveCache.get(r);void 0===i&&(i=this.device.createBuffer({size:r,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.occludedResolveCache.set(r,i));const s=this.device.createBuffer({size:r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});t.encoder.resolveQuerySet(t.occlusionQuerySet,0,n,i,0),t.encoder.copyBufferToBuffer(i,0,s,0,r),t.occlusionQueryBuffer=s,this.resolveOccludedAsync(e)}if(this.prepareTimestampBuffer(e,t.encoder),this.device.queue.submit([t.encoder.finish()]),null!==e.textures){const t=e.textures;for(let e=0;e<t.length;e++){const n=t[e];!0===n.generateMipmaps&&this.textureUtils.generateMipmaps(n)}}}isOccluded(e,t){const n=this.get(e);return n.occluded&&n.occluded.has(t)}async resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueryBuffer:n,currentOcclusionQueryObjects:r}=t;if(n&&r){const e=new WeakSet;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueryBuffer=null,await n.mapAsync(GPUMapMode.READ);const i=n.getMappedRange(),s=new BigUint64Array(i);for(let t=0;t<r.length;t++)s[t]!==BigInt(0)&&e.add(r[t]);n.destroy(),t.occluded=e}}updateViewport(e){const{currentPass:t}=this.get(e),{x:n,y:r,width:i,height:s,minDepth:a,maxDepth:o}=e.viewportValue;t.setViewport(n,r,i,s,a,o)}clear(e,t,n,r=null){const i=this.device,s=this.renderer;let a,o,l,u,c=[];if(e){const e=this.getClearColor();if(!0===this.renderer.alpha){const t=e.a;o={r:e.r*t,g:e.g*t,b:e.b*t,a:t}}else o={r:e.r,g:e.g,b:e.b,a:e.a}}if(null===r){l=s.depth,u=s.stencil;const t=this._getDefaultRenderPassDescriptor();if(e){c=t.colorAttachments;const e=c[0];e.clearValue=o,e.loadOp=mH,e.storeOp=fH}(l||u)&&(a=t.depthStencilAttachment)}else{if(l=r.depth,u=r.stencil,e){c=this._getRenderPassDescriptor(r,{loadOp:mH}).colorAttachments}if(l||u){a={view:this.get(r.depthTexture).texture.createView()}}}l&&(t?(a.depthLoadOp=mH,a.depthClearValue=s.getClearDepth(),a.depthStoreOp=fH):(a.depthLoadOp=pH,a.depthStoreOp=fH)),u&&(n?(a.stencilLoadOp=mH,a.stencilClearValue=s.getClearStencil(),a.stencilStoreOp=fH):(a.stencilLoadOp=pH,a.stencilStoreOp=fH));const d=i.createCommandEncoder({});d.beginRenderPass({colorAttachments:c,depthStencilAttachment:a}).end(),i.queue.submit([d.finish()])}beginCompute(e){const t=this.get(e),n={};this.initTimestampQuery(e,n),t.cmdEncoderGPU=this.device.createCommandEncoder(),t.passEncoderGPU=t.cmdEncoderGPU.beginComputePass(n)}compute(e,t,n,r){const{passEncoderGPU:i}=this.get(e),s=this.get(r).pipeline;i.setPipeline(s);for(let e=0,t=n.length;e<t;e++){const t=n[e],r=this.get(t);i.setBindGroup(e,r.group)}const a=this.device.limits.maxComputeWorkgroupsPerDimension,o=this.get(t);void 0===o.dispatchSize&&(o.dispatchSize={x:0,y:1,z:1});const{dispatchSize:l}=o;t.dispatchCount>a?(l.x=Math.min(t.dispatchCount,a),l.y=Math.ceil(t.dispatchCount/a)):l.x=t.dispatchCount,i.dispatchWorkgroups(l.x,l.y,l.z)}finishCompute(e){const t=this.get(e);t.passEncoderGPU.end(),this.prepareTimestampBuffer(e,t.cmdEncoderGPU),this.device.queue.submit([t.cmdEncoderGPU.finish()])}async waitForGPU(){await this.device.queue.onSubmittedWorkDone()}draw(e,t){const{object:n,context:r,pipeline:i}=e,s=e.getBindings(),a=this.get(r),o=this.get(i).pipeline,l=a.currentSets,u=a.currentPass,c=e.getDrawParameters();if(null===c)return;l.pipeline!==o&&(u.setPipeline(o),l.pipeline=o);const d=l.bindingGroups;for(let e=0,t=s.length;e<t;e++){const t=s[e],n=this.get(t);d[t.index]!==t.id&&(u.setBindGroup(t.index,n.group),d[t.index]=t.id)}const h=e.getIndex(),f=null!==h;if(!0===f&&l.index!==h){const e=this.get(h).buffer,t=h.array instanceof Uint16Array?_H:xH;u.setIndexBuffer(e,t),l.index=h}const p=e.getVertexBuffers();for(let e=0,t=p.length;e<t;e++){const t=p[e];if(l.attributes[e]!==t){const n=this.get(t).buffer;u.setVertexBuffer(e,n),l.attributes[e]=t}}if(void 0!==a.occlusionQuerySet){const e=a.lastOcclusionObject;e!==n&&(null!==e&&!0===e.occlusionTest&&(u.endOcclusionQuery(),a.occlusionQueryIndex++),!0===n.occlusionTest&&(u.beginOcclusionQuery(a.occlusionQueryIndex),a.occlusionQueryObjects[a.occlusionQueryIndex]=n),a.lastOcclusionObject=n)}if(!0===n.isBatchedMesh){const e=n._multiDrawStarts,t=n._multiDrawCounts,r=n._multiDrawCount,i=n._multiDrawInstances;for(let n=0;n<r;n++){const r=i?i[n]:1,s=r>1?0:n;!0===f?u.drawIndexed(t[n],r,e[n]/h.array.BYTES_PER_ELEMENT,0,s):u.draw(t[n],r,e[n],s)}}else if(!0===f){const{vertexCount:r,instanceCount:i,firstVertex:s}=c,a=e.getIndirect();if(null!==a){const e=this.get(a).buffer;u.drawIndexedIndirect(e,0)}else u.drawIndexed(r,i,s,0,0);t.update(n,r,i)}else{const{vertexCount:r,instanceCount:i,firstVertex:s}=c,a=e.getIndirect();if(null!==a){const e=this.get(a).buffer;u.drawIndirect(e,0)}else u.draw(r,i,s,0);t.update(n,r,i)}}needsRenderUpdate(e){const t=this.get(e),{object:n,material:r}=e,i=this.utils,s=i.getSampleCountRenderContext(e.context),a=i.getCurrentColorSpace(e.context),o=i.getCurrentColorFormat(e.context),l=i.getCurrentDepthStencilFormat(e.context),u=i.getPrimitiveTopology(n,r);let c=!1;return t.material===r&&t.materialVersion===r.version&&t.transparent===r.transparent&&t.blending===r.blending&&t.premultipliedAlpha===r.premultipliedAlpha&&t.blendSrc===r.blendSrc&&t.blendDst===r.blendDst&&t.blendEquation===r.blendEquation&&t.blendSrcAlpha===r.blendSrcAlpha&&t.blendDstAlpha===r.blendDstAlpha&&t.blendEquationAlpha===r.blendEquationAlpha&&t.colorWrite===r.colorWrite&&t.depthWrite===r.depthWrite&&t.depthTest===r.depthTest&&t.depthFunc===r.depthFunc&&t.stencilWrite===r.stencilWrite&&t.stencilFunc===r.stencilFunc&&t.stencilFail===r.stencilFail&&t.stencilZFail===r.stencilZFail&&t.stencilZPass===r.stencilZPass&&t.stencilFuncMask===r.stencilFuncMask&&t.stencilWriteMask===r.stencilWriteMask&&t.side===r.side&&t.alphaToCoverage===r.alphaToCoverage&&t.sampleCount===s&&t.colorSpace===a&&t.colorFormat===o&&t.depthStencilFormat===l&&t.primitiveTopology===u&&t.clippingContextCacheKey===e.clippingContextCacheKey||(t.material=r,t.materialVersion=r.version,t.transparent=r.transparent,t.blending=r.blending,t.premultipliedAlpha=r.premultipliedAlpha,t.blendSrc=r.blendSrc,t.blendDst=r.blendDst,t.blendEquation=r.blendEquation,t.blendSrcAlpha=r.blendSrcAlpha,t.blendDstAlpha=r.blendDstAlpha,t.blendEquationAlpha=r.blendEquationAlpha,t.colorWrite=r.colorWrite,t.depthWrite=r.depthWrite,t.depthTest=r.depthTest,t.depthFunc=r.depthFunc,t.stencilWrite=r.stencilWrite,t.stencilFunc=r.stencilFunc,t.stencilFail=r.stencilFail,t.stencilZFail=r.stencilZFail,t.stencilZPass=r.stencilZPass,t.stencilFuncMask=r.stencilFuncMask,t.stencilWriteMask=r.stencilWriteMask,t.side=r.side,t.alphaToCoverage=r.alphaToCoverage,t.sampleCount=s,t.colorSpace=a,t.colorFormat=o,t.depthStencilFormat=l,t.primitiveTopology=u,t.clippingContextCacheKey=e.clippingContextCacheKey,c=!0),c}getRenderCacheKey(e){const{object:t,material:n}=e,r=this.utils,i=e.context;return[n.transparent,n.blending,n.premultipliedAlpha,n.blendSrc,n.blendDst,n.blendEquation,n.blendSrcAlpha,n.blendDstAlpha,n.blendEquationAlpha,n.colorWrite,n.depthWrite,n.depthTest,n.depthFunc,n.stencilWrite,n.stencilFunc,n.stencilFail,n.stencilZFail,n.stencilZPass,n.stencilFuncMask,n.stencilWriteMask,n.side,r.getSampleCountRenderContext(i),r.getCurrentColorSpace(i),r.getCurrentColorFormat(i),r.getCurrentDepthStencilFormat(i),r.getPrimitiveTopology(t,n),e.getGeometryCacheKey(),e.clippingContextCacheKey].join()}createSampler(e){this.textureUtils.createSampler(e)}destroySampler(e){this.textureUtils.destroySampler(e)}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}copyTextureToBuffer(e,t,n,r,i,s){return this.textureUtils.copyTextureToBuffer(e,t,n,r,i,s)}initTimestampQuery(e,t){if(!this.trackTimestamp)return;const n=this.get(e);if(!n.timeStampQuerySet){const r=e.isComputeNode?"compute":"render",i=this.device.createQuerySet({type:"timestamp",count:2,label:`timestamp_${r}_${e.id}`}),s={querySet:i,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1};Object.assign(t,{timestampWrites:s}),n.timeStampQuerySet=i}}prepareTimestampBuffer(e,t){if(!this.trackTimestamp)return;const n=this.get(e),r=2*BigInt64Array.BYTES_PER_ELEMENT;void 0===n.currentTimestampQueryBuffers&&(n.currentTimestampQueryBuffers={resolveBuffer:this.device.createBuffer({label:"timestamp resolve buffer",size:r,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),resultBuffer:this.device.createBuffer({label:"timestamp result buffer",size:r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})});const{resolveBuffer:i,resultBuffer:s}=n.currentTimestampQueryBuffers;t.resolveQuerySet(n.timeStampQuerySet,0,2,i,0),"unmapped"===s.mapState&&t.copyBufferToBuffer(i,0,s,0,r)}async resolveTimestampAsync(e,t="render"){if(!this.trackTimestamp)return;const n=this.get(e);if(void 0===n.currentTimestampQueryBuffers)return;const{resultBuffer:r}=n.currentTimestampQueryBuffers;"unmapped"===r.mapState&&r.mapAsync(GPUMapMode.READ).then(()=>{const e=new BigUint64Array(r.getMappedRange()),n=Number(e[1]-e[0])/1e6;this.renderer.info.updateTimestamp(t,n),r.unmap()})}createNodeBuilder(e,t){return new X$(e,t)}createProgram(e){this.get(e).module={module:this.device.createShaderModule({code:e.code,label:e.stage+(""!==e.name?`_${e.name}`:"")}),entryPoint:"main"}}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){this.pipelineUtils.createRenderPipeline(e,t)}createComputePipeline(e,t){this.pipelineUtils.createComputePipeline(e,t)}beginBundle(e){const t=this.get(e);t._currentPass=t.currentPass,t._currentSets=t.currentSets,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.currentPass=this.pipelineUtils.createBundleEncoder(e)}finishBundle(e,t){const n=this.get(e),r=n.currentPass.finish();this.get(t).bundleGPU=r,n.currentSets=n._currentSets,n.currentPass=n._currentPass}addBundle(e,t){this.get(e).renderBundles.push(this.get(t).bundleGPU)}createBindings(e,t,n,r){this.bindingUtils.createBindings(e,t,n,r)}updateBindings(e,t,n,r){this.bindingUtils.createBindings(e,t,n,r)}updateBinding(e){this.bindingUtils.updateBinding(e)}createIndexAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.INDEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createIndirectStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){this.colorBuffer=this.textureUtils.getColorBuffer(),this.defaultRenderPassdescriptor=null}getMaxAnisotropy(){return 16}hasFeature(e){return this.device.features.has(e)}copyTextureToTexture(e,t,n=null,r=null,i=0){let s=0,a=0,o=0,l=0,u=0,c=0,d=e.image.width,h=e.image.height;null!==n&&(l=n.x,u=n.y,c=n.z||0,d=n.width,h=n.height),null!==r&&(s=r.x,a=r.y,o=r.z||0);const f=this.device.createCommandEncoder({label:"copyTextureToTexture_"+e.id+"_"+t.id}),p=this.get(e).texture,m=this.get(t).texture;f.copyTextureToTexture({texture:p,mipLevel:i,origin:{x:l,y:u,z:c}},{texture:m,mipLevel:i,origin:{x:s,y:a,z:o}},[d,h,1]),this.device.queue.submit([f.finish()])}copyFramebufferToTexture(e,t,n){const r=this.get(t);let i=null;i=t.renderTarget?e.isDepthTexture?this.get(t.depthTexture).texture:this.get(t.textures[0]).texture:e.isDepthTexture?this.textureUtils.getDepthBuffer(t.depth,t.stencil):this.context.getCurrentTexture();const s=this.get(e).texture;if(i.format!==s.format)return;let a;if(r.currentPass?(r.currentPass.end(),a=r.encoder):a=this.device.createCommandEncoder({label:"copyFramebufferToTexture_"+e.id}),a.copyTextureToTexture({texture:i,origin:[n.x,n.y,0]},{texture:s},[n.z,n.w]),e.generateMipmaps&&this.textureUtils.generateMipmaps(e),r.currentPass){const{descriptor:e}=r;for(let t=0;t<e.colorAttachments.length;t++)e.colorAttachments[t].loadOp=pH;if(t.depth&&(e.depthStencilAttachment.depthLoadOp=pH),t.stencil&&(e.depthStencilAttachment.stencilLoadOp=pH),r.currentPass=a.beginRenderPass(e),r.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.viewport&&this.updateViewport(t),t.scissor){const{x:e,y:n,width:i,height:s}=t.scissorValue;r.currentPass.setScissorRect(e,n,i,s)}}else this.device.queue.submit([a.finish()])}}class rW extends ru{constructor(e,t,n,r,i,s){super(e,t,n,r,i,s),this.iesMap=null}copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}}class iW extends sG{constructor(){super(),this.addMaterial(YN,"MeshPhongMaterial"),this.addMaterial(mk,"MeshStandardMaterial"),this.addMaterial(vk,"MeshPhysicalMaterial"),this.addMaterial(xk,"MeshToonMaterial"),this.addMaterial(VN,"MeshBasicMaterial"),this.addMaterial(qN,"MeshLambertMaterial"),this.addMaterial(wN,"MeshNormalMaterial"),this.addMaterial(Ak,"MeshMatcapMaterial"),this.addMaterial(yN,"LineBasicMaterial"),this.addMaterial(_N,"LineDashedMaterial"),this.addMaterial(Mk,"PointsMaterial"),this.addMaterial(Lk,"SpriteMaterial"),this.addMaterial(Dk,"ShadowMaterial"),this.addLight(NB,lu),this.addLight(Oz,du),this.addLight(Vz,fu),this.addLight(zz,ru),this.addLight(Hz,hu),this.addLight($z,Ql),this.addLight(Wz,mu),this.addLight(Gz,rW),this.addToneMapping(aU,1),this.addToneMapping(oU,2),this.addToneMapping(lU,3),this.addToneMapping(cU,4),this.addToneMapping(pU,6),this.addToneMapping(mU,7)}}class sW extends pG{constructor(e={}){let t;e.forceWebGL?t=JG:(t=nW,e.getFallback=()=>new JG(e));super(new t(e),e),this.library=new iW,this.isWebGPURenderer=!0}}kV.BRDF_GGX,kV.BRDF_Lambert,kV.BasicShadowFilter,kV.Break,kV.Continue,kV.DFGApprox,kV.D_GGX,kV.Discard,kV.EPSILON,kV.F_Schlick,kV.Fn,kV.INFINITY,kV.If,kV.Loop,kV.NodeShaderStage,kV.NodeType,kV.NodeUpdateType,kV.NodeAccess,kV.PCFShadowFilter,kV.PCFSoftShadowFilter,kV.PI,kV.PI2,kV.Return,kV.Schlick_to_F0,kV.ScriptableNodeResources,kV.ShaderNode,kV.TBNViewMatrix,kV.VSMShadowFilter,kV.V_GGX_SmithCorrelated,kV.abs,kV.acesFilmicToneMapping,kV.acos,kV.add,kV.addNodeElement,kV.agxToneMapping,kV.all,kV.alphaT,kV.and,kV.anisotropy,kV.anisotropyB,kV.anisotropyT,kV.any,kV.append,kV.arrayBuffer,kV.asin,kV.assign,kV.atan,kV.atan2,kV.atomicAdd,kV.atomicAnd,kV.atomicFunc,kV.atomicMax,kV.atomicMin,kV.atomicOr,kV.atomicStore,kV.atomicSub,kV.atomicXor,kV.attenuationColor,kV.attenuationDistance,kV.attribute,kV.attributeArray,kV.backgroundBlurriness,kV.backgroundIntensity,kV.backgroundRotation,kV.batch,kV.billboarding,kV.bitAnd,kV.bitNot,kV.bitOr,kV.bitXor,kV.bitangentGeometry,kV.bitangentLocal,kV.bitangentView,kV.bitangentWorld,kV.bitcast,kV.blendBurn,kV.blendColor,kV.blendDodge,kV.blendOverlay,kV.blendScreen,kV.blur,kV.bool,kV.buffer,kV.bufferAttribute,kV.bumpMap,kV.burn,kV.bvec2,kV.bvec3,kV.bvec4,kV.bypass,kV.cache,kV.call,kV.cameraFar,kV.cameraNear,kV.cameraNormalMatrix,kV.cameraPosition,kV.cameraProjectionMatrix,kV.cameraProjectionMatrixInverse,kV.cameraViewMatrix,kV.cameraWorldMatrix,kV.cbrt,kV.cdl,kV.ceil,kV.checker,kV.cineonToneMapping,kV.clamp,kV.clearcoat,kV.clearcoatRoughness,kV.code,kV.color,kV.colorSpaceToWorking,kV.colorToDirection,kV.compute,kV.cond,kV.context,kV.convert,kV.convertColorSpace,kV.convertToTexture,kV.cos,kV.cross,kV.cubeTexture,kV.dFdx,kV.dFdy,kV.dashSize,kV.defaultBuildStages,kV.defaultShaderStages,kV.defined,kV.degrees,kV.deltaTime,kV.densityFog,kV.densityFogFactor,kV.depth,kV.depthPass,kV.difference,kV.diffuseColor,kV.directPointLight,kV.directionToColor,kV.dispersion,kV.distance,kV.div,kV.dodge,kV.dot,kV.drawIndex,kV.dynamicBufferAttribute,kV.element,kV.emissive,kV.equal,kV.equals,kV.equirectUV,kV.exp,kV.exp2,kV.expression,kV.faceDirection,kV.faceForward,kV.faceforward,kV.float,kV.floor,kV.fog,kV.fract,kV.frameGroup,kV.frameId,kV.frontFacing,kV.fwidth,kV.gain,kV.gapSize,kV.getConstNodeType,kV.getCurrentStack,kV.getDirection,kV.getDistanceAttenuation,kV.getGeometryRoughness,kV.getNormalFromDepth,kV.getParallaxCorrectNormal,kV.getRoughness,kV.getScreenPosition,kV.getShIrradianceAt,kV.getTextureIndex,kV.getViewPosition,kV.glsl,kV.glslFn,kV.grayscale,kV.greaterThan,kV.greaterThanEqual,kV.hash,kV.highpModelNormalViewMatrix,kV.highpModelViewMatrix,kV.hue,kV.instance,kV.instanceIndex,kV.instancedArray,kV.instancedBufferAttribute,kV.instancedDynamicBufferAttribute,kV.instancedMesh,kV.int,kV.inverseSqrt,kV.inversesqrt,kV.invocationLocalIndex,kV.invocationSubgroupIndex,kV.ior,kV.iridescence,kV.iridescenceIOR,kV.iridescenceThickness,kV.ivec2,kV.ivec3,kV.ivec4,kV.js,kV.label,kV.length,kV.lengthSq,kV.lessThan,kV.lessThanEqual,kV.lightPosition,kV.lightTargetDirection,kV.lightTargetPosition,kV.lightViewPosition,kV.lightingContext,kV.lights,kV.linearDepth,kV.linearToneMapping,kV.localId,kV.log,kV.log2,kV.logarithmicDepthToViewZ,kV.loop,kV.luminance,kV.mediumpModelViewMatrix,kV.mat2,kV.mat3,kV.mat4,kV.matcapUV,kV.materialAO,kV.materialAlphaTest,kV.materialAnisotropy,kV.materialAnisotropyVector,kV.materialAttenuationColor,kV.materialAttenuationDistance,kV.materialClearcoat,kV.materialClearcoatNormal,kV.materialClearcoatRoughness,kV.materialColor,kV.materialDispersion,kV.materialEmissive,kV.materialIOR,kV.materialIridescence,kV.materialIridescenceIOR,kV.materialIridescenceThickness,kV.materialLightMap,kV.materialLineDashOffset,kV.materialLineDashSize,kV.materialLineGapSize,kV.materialLineScale,kV.materialLineWidth,kV.materialMetalness,kV.materialNormal,kV.materialOpacity,kV.materialPointWidth,kV.materialReference,kV.materialReflectivity,kV.materialRefractionRatio,kV.materialRotation,kV.materialRoughness,kV.materialSheen,kV.materialSheenRoughness,kV.materialShininess,kV.materialSpecular,kV.materialSpecularColor,kV.materialSpecularIntensity,kV.materialSpecularStrength,kV.materialThickness,kV.materialTransmission,kV.max,kV.maxMipLevel,kV.metalness,kV.min;const aW=kV.mix;kV.mixElement,kV.mod,kV.modInt,kV.modelDirection,kV.modelNormalMatrix,kV.modelPosition,kV.modelScale,kV.modelViewMatrix,kV.modelViewPosition,kV.modelViewProjection,kV.modelWorldMatrix,kV.modelWorldMatrixInverse,kV.morphReference,kV.mrt,kV.mul,kV.mx_aastep,kV.mx_cell_noise_float,kV.mx_contrast,kV.mx_fractal_noise_float,kV.mx_fractal_noise_vec2,kV.mx_fractal_noise_vec3,kV.mx_fractal_noise_vec4,kV.mx_hsvtorgb,kV.mx_noise_float,kV.mx_noise_vec3,kV.mx_noise_vec4,kV.mx_ramplr,kV.mx_ramptb,kV.mx_rgbtohsv,kV.mx_safepower,kV.mx_splitlr,kV.mx_splittb,kV.mx_srgb_texture_to_lin_rec709,kV.mx_transform_uv,kV.mx_worley_noise_float,kV.mx_worley_noise_vec2,kV.mx_worley_noise_vec3,kV.negate,kV.neutralToneMapping,kV.nodeArray,kV.nodeImmutable,kV.nodeObject,kV.nodeObjects,kV.nodeProxy,kV.normalFlat,kV.normalGeometry,kV.normalLocal,kV.normalMap,kV.normalView,kV.normalWorld,kV.normalize,kV.not,kV.notEqual,kV.numWorkgroups,kV.objectDirection,kV.objectGroup,kV.objectPosition,kV.objectScale,kV.objectViewPosition,kV.objectWorldMatrix,kV.oneMinus,kV.or,kV.orthographicDepthToViewZ,kV.oscSawtooth,kV.oscSine,kV.oscSquare,kV.oscTriangle,kV.output,kV.outputStruct,kV.overlay,kV.overloadingFn,kV.parabola,kV.parallaxDirection,kV.parallaxUV,kV.parameter,kV.pass,kV.passTexture,kV.pcurve,kV.perspectiveDepthToViewZ,kV.pmremTexture,kV.pointUV,kV.pointWidth,kV.positionGeometry;const oW=kV.positionLocal;kV.positionPrevious,kV.positionView,kV.positionViewDirection,kV.positionWorld,kV.positionWorldDirection,kV.posterize,kV.pow,kV.pow2,kV.pow3,kV.pow4,kV.property,kV.radians,kV.rand,kV.range,kV.rangeFog,kV.rangeFogFactor,kV.reciprocal,kV.reference,kV.referenceBuffer,kV.reflect,kV.reflectVector,kV.reflectView,kV.reflector,kV.refract,kV.refractVector,kV.refractView,kV.reinhardToneMapping,kV.remainder,kV.remap,kV.remapClamp,kV.renderGroup,kV.renderOutput,kV.rendererReference,kV.rotate,kV.rotateUV,kV.roughness,kV.round,kV.rtt,kV.sRGBTransferEOTF,kV.sRGBTransferOETF,kV.sampler,kV.saturate,kV.saturation,kV.screen,kV.screenCoordinate,kV.screenSize,kV.screenUV,kV.scriptable,kV.scriptableValue,kV.select,kV.setCurrentStack,kV.shaderStages,kV.shadow,kV.shadowPositionWorld,kV.sharedUniformGroup,kV.sheen,kV.sheenRoughness,kV.shiftLeft,kV.shiftRight,kV.shininess,kV.sign,kV.sin,kV.sinc,kV.skinning,kV.skinningReference,kV.smoothstep,kV.smoothstepElement,kV.specularColor,kV.specularF90,kV.spherizeUV,kV.split,kV.spritesheetUV,kV.sqrt,kV.stack;const lW=kV.step;kV.storage,kV.storageBarrier,kV.storageObject,kV.storageTexture,kV.string,kV.sub,kV.subgroupIndex,kV.subgroupSize,kV.tan,kV.tangentGeometry,kV.tangentLocal,kV.tangentView,kV.tangentWorld,kV.temp;const uW=kV.texture;kV.texture3D,kV.textureBarrier,kV.textureBicubic,kV.textureCubeUV,kV.textureLoad,kV.textureSize,kV.textureStore,kV.thickness,kV.threshold,kV.time,kV.timerDelta,kV.timerGlobal,kV.timerLocal,kV.toOutputColorSpace,kV.toWorkingColorSpace,kV.toneMapping,kV.toneMappingExposure,kV.toonOutlinePass,kV.transformDirection,kV.transformNormal,kV.transformNormalToView,kV.transformedBentNormalView,kV.transformedBitangentView,kV.transformedBitangentWorld,kV.transformedClearcoatNormalView,kV.transformedNormalView,kV.transformedNormalWorld,kV.transformedTangentView,kV.transformedTangentWorld,kV.transmission,kV.transpose,kV.tri,kV.tri3,kV.triNoise3D,kV.triplanarTexture,kV.triplanarTextures,kV.trunc,kV.tslFn,kV.uint;const cW=kV.uniform;kV.uniformArray,kV.uniformGroup,kV.uniforms,kV.userData;const dW=kV.uv;kV.uvec2,kV.uvec3,kV.uvec4,kV.varying,kV.varyingProperty,kV.vec2;const hW=kV.vec3;kV.vec4,kV.vectorComponents,kV.velocity,kV.vertexColor,kV.vertexIndex,kV.vibrance,kV.viewZToLogarithmicDepth,kV.viewZToOrthographicDepth,kV.viewZToPerspectiveDepth,kV.viewport,kV.viewportBottomLeft,kV.viewportCoordinate,kV.viewportDepthTexture,kV.viewportLinearDepth,kV.viewportMipTexture,kV.viewportResolution,kV.viewportSafeUV,kV.viewportSharedTexture,kV.viewportSize,kV.viewportTexture,kV.viewportTopLeft,kV.viewportUV,kV.wgsl,kV.wgslFn,kV.workgroupArray,kV.workgroupBarrier,kV.workgroupId,kV.workingToColorSpace,kV.xor;export{Rm as Canvas,mk as MeshStandardNodeMaterial,zm as OrbitControls,sW as WebGPURenderer,ep as extend,aW as mix,oW as positionLocal,lW as step,uW as texture,cW as uniform,Vm as useTexture,xE as useVideoTexture,dW as uv,hW as vec3};
